<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>zen&#39;s blog</title>
  
  
  <link href="/atom.xml" rel="self"/>
  
  <link href="http://ymlog.cn/"/>
  <updated>2020-06-19T02:05:10.632Z</updated>
  <id>http://ymlog.cn/</id>
  
  <author>
    <name>ZEN</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>VsCode远程开发</title>
    <link href="http://ymlog.cn/2020/06/18/VsCode%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91/"/>
    <id>http://ymlog.cn/2020/06/18/VsCode%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91/</id>
    <published>2020-06-18T02:50:36.000Z</published>
    <updated>2020-06-19T02:05:10.632Z</updated>
    
    <content type="html"><![CDATA[<p>使用Remote-Development连接远程目录</p><a id="more"></a><p>Powershell下安装OpenSSH，安装失败也不要紧</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Get-WindowsCapability -Online | ? Name -like <span class="string">'OpenSSH*'</span></span><br><span class="line">Add-WindowsCapability -Online -Name OpenSSH.Client~~~~0.0.1.0</span><br><span class="line">Add-WindowsCapability -Online -Name OpenSSH.Server~~~~0.0.1.0</span><br></pre></td></tr></table></figure><p>1、下载插件：Remote Development</p><p>2、Ctrl+Shift+P打开设置Remote SSH Settings，设置Remote.SSH:Show Login Terminal为true</p><p><a href="https://imgchr.com/i/NeFgxO" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/06/18/NeFgxO.png" alt="NeFgxO.png"></a></p><p>3、左下角会多出来一个远程连接的图标，点击图标会弹出选择框，选择Connect to Host</p><p>4、选择一个Host，或者采用如下形式登录</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ssh root@x.x.x.x -A</span><br></pre></td></tr></table></figure><p>5、输入登录密码</p><p>6、添加远程文件夹</p><p>7、选择终端解释器，这里我选择了/bin/bash，Ctrl+Shift+` 新建终端</p><p><a href="https://imgchr.com/i/NeFcRK" target="_blank" rel="noopener"><img src="https://s1.ax1x.com/2020/06/18/NeFcRK.png" alt="NeFcRK.png"></a></p><p>相关链接：</p><blockquote><p><a href="https://blog.csdn.net/yh0503/article/details/89851899" target="_blank" rel="noopener">https://blog.csdn.net/yh0503/article/details/89851899</a></p></blockquote><blockquote><p><a href="https://docs.microsoft.com/zh-cn/windows-server/administration/openssh/openssh_install_firstuse" target="_blank" rel="noopener">https://docs.microsoft.com/zh-cn/windows-server/administration/openssh/openssh_install_firstuse</a></p></blockquote><hr>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;使用Remote-Development连接远程目录&lt;/p&gt;
    
    </summary>
    
    
      <category term="运维" scheme="http://ymlog.cn/categories/%E8%BF%90%E7%BB%B4/"/>
    
    
  </entry>
  
  <entry>
    <title>Win快捷键</title>
    <link href="http://ymlog.cn/2020/06/18/Win%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <id>http://ymlog.cn/2020/06/18/Win%E5%BF%AB%E6%8D%B7%E9%94%AE/</id>
    <published>2020-06-18T00:37:32.000Z</published>
    <updated>2020-06-25T09:14:34.616Z</updated>
    
    <content type="html"><![CDATA[<a id="more"></a><p>Win+P 投影<br>Win+K 蓝牙<br>Win+D 桌面<br>Win+E 此电脑<br>Win+R 调出”运行”</p><hr><p>Win+Q 搜索<br>Win+W 截图<br>Win+i 设置<br>Win+A 通知<br>Win+F 反馈<br>Win+L 锁屏<br>Win+X 左下功能界面<br>Win+V 历史剪贴板<br>Win+M 最小化当前界面<br>Win+&gt; 表情符号😊🤦‍♂️</p><hr><p>Ctrl+Win+⬅ 切换到左边的桌面<br>Ctrl+Win+➡ 切换到右边的桌面</p><p>分屏功能键<br>Win+up<br>Win+left<br>Win+right<br>Win+down</p><hr><p>Alt+F4+[Fn] 关机<br>Win+Nbr[1,2,3] 打开任务栏第Nbr位的软件<br>Win+Space 切换输入法<br>F2  重命名<br>F11 全屏</p><hr>]]></content>
    
    <summary type="html">
    
      
      
        &lt;a id=&quot;more&quot;&gt;&lt;/a&gt;

&lt;p&gt;Win+P 投影&lt;br&gt;Win+K 蓝牙&lt;br&gt;Win+D 桌面&lt;br&gt;Win+E 此电脑&lt;br&gt;Win+R 调出”运行”&lt;/p&gt;
&lt;hr&gt;
&lt;p&gt;Win+Q 搜索&lt;br&gt;Win+W 截图&lt;br&gt;Win+i 设置&lt;br&gt;Win+A 通知
      
    
    </summary>
    
    
    
      <category term="快捷键" scheme="http://ymlog.cn/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>ls根目录卡死</title>
    <link href="http://ymlog.cn/2020/06/17/ls_roor_broken/"/>
    <id>http://ymlog.cn/2020/06/17/ls_roor_broken/</id>
    <published>2020-06-17T14:46:04.000Z</published>
    <updated>2020-06-25T09:03:59.645Z</updated>
    
    <content type="html"><![CDATA[<p>[应该是某个NFSBug，明明O上的NFS Down了，这个M服务器还是在一直等待响应]，于是看上去就像是me服务器卡死了，其实它是在等待NFS的响应。</p><a id="more"></a><h1 id="问题"><a href="#问题" class="headerlink" title="问题"></a>问题</h1><p>只要涉及到根目录，使用ls和df命令就会出现卡死情况。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@zen] <span class="built_in">pwd</span></span><br><span class="line">/root</span><br><span class="line">[root@zen] ls /</span><br><span class="line">^C</span><br><span class="line">[root@zen] df h</span><br><span class="line">^C</span><br><span class="line">[root@zen] ls /opt</span><br><span class="line">containerd  google  jumpserver  mysql  prometheus</span><br></pre></td></tr></table></figure><h1 id="踩坑"><a href="#踩坑" class="headerlink" title="踩坑"></a>踩坑</h1><p>1、起初在网上找了一些方法，大多是目录挂载的问题；里面叫你用strace定位问题，然后在lstate的时候会发现是目录没挂载上去，但是我用strace的时候，是正常退出的，因为流程过长，strace的log放在结尾了。</p><p>类似于这样： </p><blockquote><p><a href="https://blog.51cto.com/chaichuan/2104093" target="_blank" rel="noopener">https://blog.51cto.com/chaichuan/2104093</a><br><a href="https://blog.csdn.net/u010801696/article/details/78490103" target="_blank" rel="noopener">https://blog.csdn.net/u010801696/article/details/78490103</a></p></blockquote><p>2、后来发现可能是日志文件过大，或者是文件细碎导致ls太慢，通常是/var/spool/postfix/这个目录下的maildrop太大，但是我看了一下我的，并没有太大。maildrop 爆满的问题一般是 crontab 未屏蔽错误造成的,可以将crontab里的条目指定到&amp;&gt;/dev/null</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@zen]<span class="comment"># ll /var/spool/postfix/</span></span><br><span class="line">total 56</span><br><span class="line">drwx------. 2 postfix root     4096 Oct 31  2018 active</span><br><span class="line">drwx------. 2 postfix root     4096 Oct 31  2018 bounce</span><br><span class="line">drwx------. 2 postfix root     4096 Oct 31  2018 flush</span><br><span class="line">drwx------. 2 postfix root     4096 Oct 31  2018 hold</span><br><span class="line">drwx------. 2 postfix root     4096 Oct 31  2018 incoming</span><br><span class="line">drwx-wx---. 2 postfix postdrop 4096 Oct 31  2018 maildrop</span><br></pre></td></tr></table></figure><p>3、第三种可能是磁盘挂载的问题，根目录丢失之类的。</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat /etc/fstab</span><br><span class="line">cat /etc/mtab</span><br><span class="line">grep -v rootfs /proc/mounts <span class="comment"># 修复</span></span><br></pre></td></tr></table></figure><p>/etc/fstab 中的挂载点是开机加载的<br>/etc/mtab  中的挂载点是内核动态实时更新的<br>简单来说就是一次修复挂载的问题，但是我做完这几部操作，依旧没有用</p><blockquote><p><a href="https://zhang.ge/5107.html" target="_blank" rel="noopener">https://zhang.ge/5107.html</a></p></blockquote><h1 id="解决"><a href="#解决" class="headerlink" title="解决"></a>解决</h1><p>其实和另一台服务器有关，我们暂时把它称之为O[other]，我们这台服务器为M[me],O上开启了NFS服务，Me服务器挂载了O上的磁盘。过了段时间，O服务器进行了重装，但是M服务器还在挂载O上的磁盘，此时other服务器没有开启NFS服务，但是Me服务器依旧挂载着O的磁盘。</p><p>于是执行ls / 命令的时候，me服务器加载目录，加载前几个好好的，在strace中可以看到，但加载到/mount_point的时候，就会向O服务器发送请求，[应该是某个NFSBug，明明O上的NFS Down了，这个M服务器还是在一直等待响应]，于是看上去就像是me服务器卡死了，其实它是在等待NFS的响应。</p><p>采取的解决措施：重启，有尝试过umount卸载挂载点，但会卡住。</p><hr><p>2020/6/22 看鸟哥Linux私房菜发现也有这方面的情况：</p><p>只要有用到文件系统， 那么整个目录树系统就会主动的去查询全部的挂载点。如果你的 NFS 服务器与客户端之间的联机因为网络问题， 或者是服务器端先关机了，却没有通知客户端，那么客户端只要动到文件系统的指令 (例如 df, ls, cp 等等) ，整个系统就会慢到爆！因为你必须要等到文件系统搜寻等待逾时后，系统才会饶了你！(鸟哥等过 df 指令 30 分钟过…)</p><table><thead><tr><th>参数</th><th>参数功能</th><th>预设参数</th></tr></thead><tbody><tr><td>fg，bg</td><td>当执行挂载时，该挂载的行为会在前景 (fg) 还是在背景 (bg) 执行？ 若在前景执行时，则 mount 会持续尝试挂载，直到成功或 time out 为止，若为背景执行， 则 mount 会在背景持续多次进行 mount ，而不会影响到前景的程序操作。 如果你的网络联机有点不稳定，或是服务器常常需要开关机，那建议使用 bg 比较妥当。</td><td>fg</td></tr><tr><td>soft，hard</td><td>如果是 hard 的情况，则当两者之间有任何一部主机脱机，则 RPC 会持续的呼叫，直到对方恢复联机为止。如果是 soft 的话，那 RPC 会在 time out 后『重复』呼叫，而非『持续』呼叫， 因此系统的延迟会比较不这么明显。同上，如果你的服务器可能开开关关，建议用 soft 喔！</td><td>hard</td></tr><tr><td>intr</td><td>当你使用上头提到的 hard 方式挂载时，若加上 intr 这个参数， 则当 RPC 持续呼叫中，该次的呼叫是可以被中断的 (interrupted)。</td><td>没有</td></tr><tr><td>rsize，wsize</td><td>读出(rsize)与写入(wsize)的区块大小 (block size)。 这个设定值可以影响客户端与服务器端传输数据的缓冲记忆容量。一般来说， 如果在局域网络内 (LAN) ，并且客户端与服务器端都具有足够的内存，那这个值可以设定大一点， 比如说 32768 (bytes) 等，提升缓冲记忆区块将可提升 NFS 文件系统的传输能力！ 但要注意设定的值也不要太大，最好是达到网络能够传输的最大值为限。</td><td>rsize=1024 wsize=1024</td></tr></tbody></table><p>for example:</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">$ mount -t nfs -o nosuid,noexec,nodev,rw  192.168.1.1:/data /tmp</span><br></pre></td></tr></table></figure><p>最后补充下NFS无法挂载的原因分析：</p><ol><li>客户端主机和IP网段不被允许使用, ‘mount to NFS x.x.x.x failed:system error connection refused’</li><li>服务器或客户端服务未启动,’mount to NFS x.x.x.x failed:RPC Error : programe not registered’</li><li>被防火墙拦截</li></ol><h1 id="附录"><a href="#附录" class="headerlink" title="附录"></a>附录</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@zen]<span class="comment"># strace  ls / </span></span><br><span class="line">execve(<span class="string">"/usr/bin/ls"</span>, [<span class="string">"ls"</span>, <span class="string">"/"</span>], [/* 23 vars */]) = 0</span><br><span class="line">brk(NULL)                               = 0x169f000</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d51a1000</span><br><span class="line">access(<span class="string">"/etc/ld.so.preload"</span>, R_OK)      = -1 ENOENT (No such file or directory)</span><br><span class="line">open(<span class="string">"/etc/ld.so.cache"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=52409, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 52409, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fd6d5194000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libselinux.so.1"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\220j\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=155744, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2255216, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d4d5a000</span><br><span class="line">mprotect(0x7fd6d4d7e000, 2093056, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d4f7d000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x23000) = 0x7fd6d4f7d000</span><br><span class="line">mmap(0x7fd6d4f7f000, 6512, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fd6d4f7f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libcap.so.2"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\20\26\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=20048, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2114112, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d4b55000</span><br><span class="line">mprotect(0x7fd6d4b59000, 2093056, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d4d58000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x3000) = 0x7fd6d4d58000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libacl.so.1"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0p\37\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=37064, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d5193000</span><br><span class="line">mmap(NULL, 2130560, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d494c000</span><br><span class="line">mprotect(0x7fd6d4953000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d4b53000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x7000) = 0x7fd6d4b53000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libc.so.6"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\3\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0`&amp;\2\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=2156240, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 3985920, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d457e000</span><br><span class="line">mprotect(0x7fd6d4741000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d4941000, 24576, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x1c3000) = 0x7fd6d4941000</span><br><span class="line">mmap(0x7fd6d4947000, 16896, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fd6d4947000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libpcre.so.1"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\360\25\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=402384, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2494984, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d431c000</span><br><span class="line">mprotect(0x7fd6d437c000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d457c000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x60000) = 0x7fd6d457c000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libdl.so.2"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0P\16\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=19248, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d5192000</span><br><span class="line">mmap(NULL, 2109744, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d4118000</span><br><span class="line">mprotect(0x7fd6d411a000, 2097152, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d431a000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x2000) = 0x7fd6d431a000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libattr.so.1"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\320\23\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=19896, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2113904, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d3f13000</span><br><span class="line">mprotect(0x7fd6d3f17000, 2093056, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d4116000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x3000) = 0x7fd6d4116000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">open(<span class="string">"/lib64/libpthread.so.0"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"\177ELF\2\1\1\0\0\0\0\0\0\0\0\0\3\0&gt;\0\1\0\0\0\200m\0\0\0\0\0\0"</span>..., 832) = 832</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0755, st_size=142144, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 2208904, PROT_READ|PROT_EXEC, MAP_PRIVATE|MAP_DENYWRITE, 3, 0) = 0x7fd6d3cf7000</span><br><span class="line">mprotect(0x7fd6d3d0e000, 2093056, PROT_NONE) = 0</span><br><span class="line">mmap(0x7fd6d3f0d000, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_DENYWRITE, 3, 0x16000) = 0x7fd6d3f0d000</span><br><span class="line">mmap(0x7fd6d3f0f000, 13448, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_FIXED|MAP_ANONYMOUS, -1, 0) = 0x7fd6d3f0f000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d5191000</span><br><span class="line">mmap(NULL, 8192, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d518f000</span><br><span class="line">arch_prctl(ARCH_SET_FS, 0x7fd6d518f840) = 0</span><br><span class="line">mprotect(0x7fd6d4941000, 16384, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d3f0d000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d4116000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d431a000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d457c000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d4b53000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d4d58000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x7fd6d4f7d000, 4096, PROT_READ) = 0</span><br><span class="line">mprotect(0x61a000, 4096, PROT_READ)     = 0</span><br><span class="line">mprotect(0x7fd6d51a2000, 4096, PROT_READ) = 0</span><br><span class="line">munmap(0x7fd6d5194000, 52409)           = 0</span><br><span class="line">set_tid_address(0x7fd6d518fb10)         = 23051</span><br><span class="line">set_robust_list(0x7fd6d518fb20, 24)     = 0</span><br><span class="line">rt_sigaction(SIGRTMIN, &#123;0x7fd6d3cfd860, [], SA_RESTORER|SA_SIGINFO, 0x7fd6d3d06630&#125;, NULL, 8) = 0</span><br><span class="line">rt_sigaction(SIGRT_1, &#123;0x7fd6d3cfd8f0, [], SA_RESTORER|SA_RESTART|SA_SIGINFO, 0x7fd6d3d06630&#125;, NULL, 8) = 0</span><br><span class="line">rt_sigprocmask(SIG_UNBLOCK, [RTMIN RT_1], NULL, 8) = 0</span><br><span class="line">getrlimit(RLIMIT_STACK, &#123;rlim_cur=8192*1024, rlim_max=RLIM64_INFINITY&#125;) = 0</span><br><span class="line">statfs(<span class="string">"/sys/fs/selinux"</span>, 0x7ffca215e650) = -1 ENOENT (No such file or directory)</span><br><span class="line">statfs(<span class="string">"/selinux"</span>, 0x7ffca215e650)      = -1 ENOENT (No such file or directory)</span><br><span class="line">brk(NULL)                               = 0x169f000</span><br><span class="line">brk(0x16c0000)                          = 0x16c0000</span><br><span class="line">open(<span class="string">"/proc/filesystems"</span>, O_RDONLY)     = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0444, st_size=0, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d51a0000</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">"nodev\tsysfs\nnodev\trootfs\nnodev\tr"</span>..., 1024) = 371</span><br><span class="line"><span class="built_in">stat</span>(<span class="string">"/etc/sysconfig/64bit_strstr_via_64bit_strstr_sse2_unaligned"</span>, 0x7ffca215dbb0) = -1 ENOENT (No such file or directory)</span><br><span class="line"><span class="built_in">read</span>(3, <span class="string">""</span>, 1024)                       = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">munmap(0x7fd6d51a0000, 4096)            = 0</span><br><span class="line">access(<span class="string">"/etc/selinux/config"</span>, F_OK)     = 0</span><br><span class="line">open(<span class="string">"/usr/lib/locale/locale-archive"</span>, O_RDONLY|O_CLOEXEC) = 3</span><br><span class="line">fstat(3, &#123;st_mode=S_IFREG|0644, st_size=106172832, ...&#125;) = 0</span><br><span class="line">mmap(NULL, 106172832, PROT_READ, MAP_PRIVATE, 3, 0) = 0x7fd6cd7b5000</span><br><span class="line">close(3)                                = 0</span><br><span class="line">ioctl(1, TCGETS, &#123;B38400 opost isig icanon <span class="built_in">echo</span> ...&#125;) = 0</span><br><span class="line">ioctl(1, TIOCGWINSZ, &#123;ws_row=39, ws_col=105, ws_xpixel=0, ws_ypixel=0&#125;) = 0</span><br><span class="line"><span class="built_in">stat</span>(<span class="string">"/"</span>, &#123;st_mode=S_IFDIR|0555, st_size=4096, ...&#125;) = 0</span><br><span class="line">openat(AT_FDCWD, <span class="string">"/"</span>, O_RDONLY|O_NONBLOCK|O_DIRECTORY|O_CLOEXEC) = 3</span><br><span class="line">getdents(3, /* 29 entries */, 32768)    = 800</span><br><span class="line">getdents(3, /* 0 entries */, 32768)     = 0</span><br><span class="line">close(3)                                = 0</span><br><span class="line">fstat(1, &#123;st_mode=S_IFCHR|0620, st_rdev=makedev(136, 0), ...&#125;) = 0</span><br><span class="line">mmap(NULL, 4096, PROT_READ|PROT_WRITE, MAP_PRIVATE|MAP_ANONYMOUS, -1, 0) = 0x7fd6d51a0000</span><br><span class="line">write(1, <span class="string">"baiduds  CloudResetPwdAgentNew\t "</span>..., 76baiduds  CloudResetPwdAgentNew   data  homelost+found  opt   runsys  usr</span><br><span class="line">) = 76</span><br><span class="line">write(1, <span class="string">"bin\t CloudResetPwdUpdateAgent  d"</span>..., 70bin CloudResetPwdUpdateAgent  dev libmedia    proc  sbintmp  var</span><br><span class="line">) = 70</span><br><span class="line">write(1, <span class="string">"boot\t CloudrResetPwdAgent\t   etc"</span>..., 62boot CloudrResetPwdAgent   etc lib64mnt    root  srvtms</span><br><span class="line">) = 62</span><br><span class="line">close(1)                                = 0</span><br><span class="line">munmap(0x7fd6d51a0000, 4096)            = 0</span><br><span class="line">close(2)                                = 0</span><br><span class="line">exit_group(0)                           = ?</span><br><span class="line">+++ exited with 0 +++</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;[应该是某个NFSBug，明明O上的NFS Down了，这个M服务器还是在一直等待响应]，于是看上去就像是me服务器卡死了，其实它是在等待NFS的响应。&lt;/p&gt;
    
    </summary>
    
    
      <category term="故障" scheme="http://ymlog.cn/categories/%E6%95%85%E9%9A%9C/"/>
    
    
  </entry>
  
  <entry>
    <title>Vimium快捷键</title>
    <link href="http://ymlog.cn/2020/06/16/Vimium%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <id>http://ymlog.cn/2020/06/16/Vimium%E5%BF%AB%E6%8D%B7%E9%94%AE/</id>
    <published>2020-06-16T10:02:13.000Z</published>
    <updated>2020-06-17T08:45:49.496Z</updated>
    
    <content type="html"><![CDATA[<p>转自： <a href="https://sspai.com/post/27723" target="_blank" rel="noopener">https://sspai.com/post/27723</a></p><p><img src="https://s1.ax1x.com/2020/06/16/NkPFhQ.png" alt="NkPFhQ.png"></p><h1 id="1、常用快捷键"><a href="#1、常用快捷键" class="headerlink" title="1、常用快捷键"></a>1、常用快捷键</h1><ul><li>j：向下滚动一点</li><li>k：向上滚动一点</li><li>gg：到页面最底部</li><li>G：到页面最底部</li><li>d：向下翻一屏</li><li>u：向上翻一屏</li><li>gs: 查看网页源代码</li><li>yy：拷贝当前页面的URL到剪贴板</li><li>gu：跳转到父页面</li><li>K：跳转到右边标签页</li><li>J：跳转到左边标签页</li><li>x：关闭当前标签页</li><li>X：恢复刚刚关闭的标签页</li><li>H：在历史记录中后退</li><li>L：在历史记录中前进</li><li>？：查看帮助页面</li></ul><h1 id="2、打开新页面"><a href="#2、打开新页面" class="headerlink" title="2、打开新页面"></a>2、打开新页面</h1><ul><li><p>复制一段链接：经常在网页上看到一段链接文字，但却是不可点的。原来你需要先复制，然后新建标签页，再粘贴，敲回车后才能打开。现在呢？你只需要把要打开的链接复制一下，直接按「p」或「P」就可以打开了，小写的 p 是在当前标签页打开，大写的 P 则新建标签页打开。 </p></li><li><p>从收藏夹、历史记录打开：是不是之前看过什么网页，现在又想看了，还需要再打开历史记录找？或者想打开收藏夹里的某个链接？现在，直接按下「o」，输入对应的关键字后，会一起搜索你的历史记录和收藏夹，如果你输的是一个网址，回车还能直接打开。</p></li></ul><p><img src="https://s1.ax1x.com/2020/06/16/NkPbD0.png" alt="NkPbD0.png"></p><h1 id="3、只用敲三下，打开当前页面上任意一个链接"><a href="#3、只用敲三下，打开当前页面上任意一个链接" class="headerlink" title="3、只用敲三下，打开当前页面上任意一个链接"></a>3、只用敲三下，打开当前页面上任意一个链接</h1><p>如果说，任意一个页面上，哪所有再多链接，你也不用鼠标，最多只需要敲三个键，你就可以迅速打开任意一个链接，你信不信？Vimium 就可以办到。</p><p>你只需要按一下「f」，然后当前页面上所有可点击的元素，都会生成一个对应的快捷键分派给这些链接。比如我现在想点击导航栏上的「专题」，只需要再输入「GJ」，OK！完成了，你只敲了三个键，就打开了「专题」页面。</p><p><img src="https://s1.ax1x.com/2020/06/16/NkiE5D.png" alt="NkiE5D.png"></p><h1 id="4、显示当前所有的标签页，并快速切换"><a href="#4、显示当前所有的标签页，并快速切换" class="headerlink" title="4、显示当前所有的标签页，并快速切换"></a>4、显示当前所有的标签页，并快速切换</h1><p>有时候在查找信息、翻阅资料时，经常会一口气打开几十个网站，东西一多，Chrome 会自动将每个标签页的宽度缩小，几乎就看不到它们的标题了。用了 Vimium，你可以按一下大写的「T」，就可以显示当前打开的所有标签页，并支持快捷搜索和跳转。</p><p><img src="https://s1.ax1x.com/2020/06/16/Nkie8H.png" alt="Nkie8H.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;转自： &lt;a href=&quot;https://sspai.com/post/27723&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://sspai.com/post/27723&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;&lt;img src=&quot;https://s1.ax
      
    
    </summary>
    
    
    
      <category term="快捷键" scheme="http://ymlog.cn/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>Jetbrains快捷键</title>
    <link href="http://ymlog.cn/2020/06/16/Jetbrains%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <id>http://ymlog.cn/2020/06/16/Jetbrains%E5%BF%AB%E6%8D%B7%E9%94%AE/</id>
    <published>2020-06-16T03:23:57.000Z</published>
    <updated>2020-06-16T10:47:10.611Z</updated>
    
    <content type="html"><![CDATA[<p>转自： <a href="https://segmentfault.com/a/1190000007206543" target="_blank" rel="noopener">https://segmentfault.com/a/1190000007206543</a></p><h2 id="编辑"><a href="#编辑" class="headerlink" title="编辑"></a>编辑</h2><hr><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>Ctrl + Space</td><td>代码自动完成提示（选择）</td></tr><tr><td>Alt + Enter</td><td>显示意图动作和快速修复</td></tr><tr><td>Ctrl + P</td><td>参数信息（在调用方法参数忘记的时候，提示）</td></tr><tr><td>Ctrl + Q</td><td>快速查找文件，可以查找当前类定义的文件等</td></tr><tr><td>Ctrl + 鼠标滑过</td><td>基本信息</td></tr><tr><td>Alt + Insert</td><td>生成代码…(细节需要多次操作会发现很有意思)</td></tr><tr><td>Ctrl + O</td><td>重写方法（在PHPStorm中是重写父类方法，会有选择框）</td></tr><tr><td>Ctrl + I</td><td>实现方法（一般是指实现接口类或抽象类方法）</td></tr><tr><td>Ctrl + Alt + T</td><td>环绕代码块 (if..else, try..catch, for, 等)</td></tr><tr><td>Ctrl + /</td><td>单行注释(//)</td></tr><tr><td>Ctrl + Shift + /</td><td>块注释 (/**/)</td></tr><tr><td>Ctrl + W</td><td>选择依次递增的代码块，具体使用目前来看比较少</td></tr><tr><td>Ctrl + Shift + W</td><td>去掉当前选择返回上一个选择，类似于撤销选择，与上面的相反</td></tr><tr><td>Ctrl + Alt + L</td><td>格式化代码，一般来说，写的代码格式不整齐统一，这个很有用</td></tr><tr><td>Ctrl + Alt + I</td><td>自啮合线，这个解释不太好解释，测试结果就是会自动根据代码来进行对齐</td></tr><tr><td>Ctrl + D</td><td>复制当前行或选定的块</td></tr><tr><td>Ctrl + Y</td><td>删除插入符号所在行</td></tr><tr><td>Ctrl + Shift + J</td><td>智能线连接（HTML和JavaScript才有用）</td></tr><tr><td>Ctrl + Enter</td><td>智能分割线 (HTML 和 JavaScript 才有用)</td></tr><tr><td>Shift + Enter</td><td>开始新行，比如光标在当前行，不需要切换到行尾按Enter，直接按这个组合键即可</td></tr><tr><td>Ctrl + Shift + U</td><td>切换选中的英文文字的大小写，此处其实用到挺多的</td></tr><tr><td>Ctrl + Shift + ] 或 [</td><td>选择直到代码块的开始或结束，我之前不知道这个，其实很有用</td></tr><tr><td>Ctrl + Delete</td><td>删除从当前光标到当前单词结尾</td></tr><tr><td>Ctrl + Backspace</td><td>从光标位置删除到当前单词的开始</td></tr><tr><td>Ctrl + + 或 -</td><td>这里是ctrl和加号或者减号产生的组合，可以折叠或展开当前代码块</td></tr><tr><td>Ctrl + F4</td><td>关闭活动中的tab</td></tr><tr><td>Ctrl + Shift + V</td><td>从历史粘贴</td></tr></tbody></table><h2 id="调试"><a href="#调试" class="headerlink" title="调试"></a>调试</h2><hr><p><em>此处我是用得很少</em></p><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>F8</td><td>跳过</td></tr><tr><td>F7</td><td>步进</td></tr><tr><td>Shift + F8</td><td>跳出</td></tr><tr><td>Alt + F8</td><td>表达式求值</td></tr><tr><td>F9</td><td>恢复程序</td></tr><tr><td>Ctrl + F8</td><td>切断断点</td></tr><tr><td>Ctrl+Shift+F8</td><td>查看断点</td></tr></tbody></table><h2 id="运行"><a href="#运行" class="headerlink" title="运行"></a>运行</h2><hr><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>Shift + F10</td><td>运行</td></tr><tr><td>Shift + F9</td><td>调试</td></tr><tr><td>Ctrl + Shift + F10</td><td>从编辑器运行上下文配置（Run context configuration from editor），此处可能翻译不够准确</td></tr><tr><td>Ctrl + Shift + X</td><td>在命令行运行</td></tr></tbody></table><h2 id="搜索-替换"><a href="#搜索-替换" class="headerlink" title="搜索/替换"></a>搜索/替换</h2><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>Ctrl + F/R</td><td>查找/替换</td></tr><tr><td>F3/Shift + F3</td><td>查找下一个/上一个</td></tr><tr><td>Ctrl + Shift + F/R</td><td>在目录中查找/替换</td></tr></tbody></table><h2 id="查找哪些地方使用"><a href="#查找哪些地方使用" class="headerlink" title="查找哪些地方使用"></a>查找哪些地方使用</h2><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>Alt + F7 / Ctrl + F7</td><td>当前文件查找被使用/在文件中查找哪些地方使用</td></tr><tr><td>Ctrl + Shift + F7</td><td>文件中搜索并在使用的地方高亮显示</td></tr><tr><td>Ctrl + Alt + F7</td><td>显示哪些地方被使用</td></tr></tbody></table><h2 id="导航"><a href="#导航" class="headerlink" title="导航"></a>导航</h2><hr><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>Ctrl + N</td><td>跳转到指定类</td></tr><tr><td>Ctrl + Shift + N</td><td>跳转到文件</td></tr><tr><td>Ctrl + Alt + Shift + N</td><td>跳转到符号</td></tr><tr><td>Ctrl + G</td><td>跳转到第几行</td></tr><tr><td>Alt + Right/Left</td><td>切换编辑器活动窗</td></tr><tr><td>Esc</td><td>Go to editor (from tool window)</td></tr><tr><td>Ctrl + E</td><td>弹出最近编辑文件，我也是在写这文档才知道，太方便了</td></tr><tr><td>Ctrl + Alt + Left/Right</td><td>导航前进/后退</td></tr><tr><td>Ctrl + Shift + Backspace</td><td>跳转到最近编辑的代码位置</td></tr><tr><td>Alt + F1</td><td>在任何视图中选择当前文件或符号</td></tr><tr><td>Ctrl + B 或 Ctrl + Click</td><td>跳到申明（如跳转到当前函数声明的地方，这个很常用，可以实操一下）</td></tr><tr><td>Ctrl + Alt + B</td><td>与上面相反，跳到执行位置</td></tr><tr><td>Ctrl + Shift + I</td><td>打开快速定义查找</td></tr><tr><td>Ctrl + Shift + B</td><td>跳转到类型声明</td></tr><tr><td>Ctrl + U</td><td>跳到超级方法(super-method)/超类 (super-class)</td></tr><tr><td>Alt + Up/Down</td><td>跳转到上一个或者下一个方法，在编辑一个类的时候，方便一个一个的方法进行查看</td></tr><tr><td>Ctrl + ] / [</td><td>跳转到代码块的开始或结束</td></tr><tr><td>F2 / Shift + F2</td><td>跳转到上一个或下一个高亮错误地方，这个检查代码语法错误很有用</td></tr><tr><td>F4 / Ctrl + Enter</td><td>编辑源代码/查看源代码</td></tr></tbody></table><h2 id="常用操作"><a href="#常用操作" class="headerlink" title="常用操作"></a>常用操作</h2><hr><table><thead><tr><th>快捷键组合</th><th>说明</th></tr></thead><tbody><tr><td>快速按两次 Shift</td><td>搜索任何一个地方</td></tr><tr><td>Ctrl + Shift + A</td><td>查找方法(Action)</td></tr><tr><td>Alt + #[0-9]</td><td>打开相应的工具窗口（这个我也没搞明白）</td></tr><tr><td>Ctrl + Alt + F11</td><td>开启或关闭全屏模式</td></tr><tr><td>Ctrl + Shift + F12</td><td>开启或关闭最大化编辑</td></tr><tr><td>Alt + Shift + F</td><td>添加到收藏列表（我觉得这个功能很神奇，不知道为啥要这么做）</td></tr><tr><td>Alt + Shift + I</td><td>检查当前文件以及当前配置文件</td></tr><tr><td>Ctrl + Alt + S</td><td>打开设置对话框（表示会与QQ默认快捷键冲突）</td></tr><tr><td>Ctrl + Tab</td><td>在 tabs 和工具窗口间切换</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;转自： &lt;a href=&quot;https://segmentfault.com/a/1190000007206543&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://segmentfault.com/a/1190000007206543&lt;/a&gt;&lt;
      
    
    </summary>
    
    
    
      <category term="快捷键" scheme="http://ymlog.cn/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>Chrome快捷键</title>
    <link href="http://ymlog.cn/2020/06/16/Chrome%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <id>http://ymlog.cn/2020/06/16/Chrome%E5%BF%AB%E6%8D%B7%E9%94%AE/</id>
    <published>2020-06-16T03:23:27.000Z</published>
    <updated>2020-06-25T09:17:14.392Z</updated>
    
    <content type="html"><![CDATA[<p>转自：<a href="https://www.runoob.com/w3cnote/google-chrome-shortcuts.html" target="_blank" rel="noopener">https://www.runoob.com/w3cnote/google-chrome-shortcuts.html</a></p><h2 id="Windows-和-Linux版本的chrome"><a href="#Windows-和-Linux版本的chrome" class="headerlink" title="Windows 和 Linux版本的chrome"></a>Windows 和 Linux版本的chrome</h2><h3 id="标签页和窗口快捷键"><a href="#标签页和窗口快捷键" class="headerlink" title="标签页和窗口快捷键"></a>标签页和窗口快捷键</h3><table><thead><tr><th align="left">操作</th><th align="left">快捷键</th></tr></thead><tbody><tr><td align="left">打开新窗口</td><td align="left">Ctrl + n</td></tr><tr><td align="left">在隐身模式下打开新窗口</td><td align="left">Ctrl + Shift + n</td></tr><tr><td align="left">打开新的标签页，并跳转到该标签页</td><td align="left">Ctrl + t</td></tr><tr><td align="left">重新打开最后关闭的标签页，并跳转到该标签页</td><td align="left">Ctrl + Shift + t</td></tr><tr><td align="left">跳转到下一个打开的标签页</td><td align="left">Ctrl + Tab 或 Ctrl + PgDn</td></tr><tr><td align="left">跳转到上一个打开的标签页</td><td align="left">Ctrl + Shift + Tab 或 Ctrl + PgUp</td></tr><tr><td align="left">跳转到特定标签页</td><td align="left">Ctrl + 1 到 Ctrl + 8</td></tr><tr><td align="left">跳转到最后一个标签页</td><td align="left">Ctrl + 9</td></tr><tr><td align="left">在当前标签页中打开主页</td><td align="left">Alt + Home</td></tr><tr><td align="left">关闭当前标签页</td><td align="left">Ctrl + w 或 Ctrl + F4</td></tr><tr><td align="left">关闭所有打开的标签页和浏览器</td><td align="left">Ctrl + Shift + w</td></tr><tr><td align="left">最小化当前窗口</td><td align="left">Alt + 空格键 + n</td></tr><tr><td align="left">最大化当前窗口</td><td align="left">Alt + 空格键 + x</td></tr><tr><td align="left">退出 Google Chrome</td><td align="left">Ctrl + Shift + q 或 Alt + F4</td></tr></tbody></table><h3 id="chrome-功能快捷键"><a href="#chrome-功能快捷键" class="headerlink" title="chrome 功能快捷键"></a>chrome 功能快捷键</h3><table><thead><tr><th align="left">操作</th><th align="left">快捷键</th></tr></thead><tbody><tr><td align="left">打开”菜单”</td><td align="left">Alt + f、Alt + e 或 F10</td></tr><tr><td align="left">显示或隐藏书签栏</td><td align="left">Ctrl + Shift + b</td></tr><tr><td align="left">打开书签管理器</td><td align="left">Ctrl + Shift + o</td></tr><tr><td align="left">在新标签页中打开”历史记录”页</td><td align="left">Ctrl + h</td></tr><tr><td align="left">在新标签页中打开”下载内容”页</td><td align="left">Ctrl + j</td></tr><tr><td align="left">打开 Chrome 任务管理器</td><td align="left">Shift + Esc</td></tr><tr><td align="left">将焦点放置在 Chrome 工具栏中的第一项上</td><td align="left">Shift + Alt + t</td></tr><tr><td align="left">在地址栏、书签栏（若显示）和页面内容之间向前切换焦点</td><td align="left">F6</td></tr><tr><td align="left">在地址栏、书签栏（若显示）和页面内容之间向后切换焦点</td><td align="left">Shift + F6</td></tr><tr><td align="left">打开查找栏搜索当前网页</td><td align="left">Ctrl + f 或 F3</td></tr><tr><td align="left">跳转到与查找栏中搜索字词相匹配的下一条内容</td><td align="left">Ctrl + g</td></tr><tr><td align="left">跳转到与查找栏中搜索字词相匹配的上一条内容</td><td align="left">Ctrl + Shift + g</td></tr><tr><td align="left">打开”开发者工具”</td><td align="left">Ctrl + Shift + j 或 F12</td></tr><tr><td align="left">打开”清除浏览数据”选项</td><td align="left">Ctrl + Shift + Delete</td></tr><tr><td align="left">在新标签页中打开 Chrome 帮助中心</td><td align="left">F1</td></tr><tr><td align="left">使用其他帐户登录或进入隐身模式</td><td align="left">Ctrl + Shift + m</td></tr><tr><td align="left">打开反馈表单</td><td align="left">Ctrl + Shift + i</td></tr></tbody></table><h3 id="地址栏快捷键"><a href="#地址栏快捷键" class="headerlink" title="地址栏快捷键"></a>地址栏快捷键</h3><table><thead><tr><th align="left">操作</th><th align="left">快捷键</th></tr></thead><tbody><tr><td align="left">使用默认搜索引擎进行搜索</td><td align="left">输入搜索字词并按 Enter 键</td></tr><tr><td align="left">使用其他搜索引擎进行搜索</td><td align="left">输入搜索引擎名称并按 Tab 键</td></tr><tr><td align="left">为网站名称添加 www. 和 .com，并在当前标签页中打开该网站</td><td align="left">输入网站名称并按 Ctrl + Enter 键</td></tr><tr><td align="left">为网站名称添加 www. 和 .com，并在新标签页中打开该网站</td><td align="left">输入网站名称并按 Alt + Enter 键</td></tr><tr><td align="left">跳转到地址栏</td><td align="left">Ctrl + l、Alt + d 或 F6</td></tr><tr><td align="left">从页面中的任意位置搜索</td><td align="left">Ctrl + k 或 Ctrl + e</td></tr></tbody></table><h3 id="网页快捷键"><a href="#网页快捷键" class="headerlink" title="网页快捷键"></a>网页快捷键</h3><table><thead><tr><th align="left">操作</th><th align="left">快捷键</th></tr></thead><tbody><tr><td align="left">打开选项以打印当前网页</td><td align="left">Ctrl + p</td></tr><tr><td align="left">打开选项以保存当前网页</td><td align="left">Ctrl + s</td></tr><tr><td align="left">重新加载当前网页</td><td align="left">F5 或 Ctrl + r</td></tr><tr><td align="left">重新加载当前网页（忽略缓存的内容）</td><td align="left">Shift + F5 或 Ctrl + Shift + r</td></tr><tr><td align="left">停止加载网页</td><td align="left">Esc</td></tr><tr><td align="left">浏览下一个可点击项</td><td align="left">Tab</td></tr><tr><td align="left">浏览上一个可点击项</td><td align="left">Shift + Tab</td></tr><tr><td align="left">使用 Chrome 打开计算机中的文件</td><td align="left">按住 Ctrl + o 键并选择文件</td></tr><tr><td align="left">显示当前网页的 HTML 源代码（不可修改）</td><td align="left">Ctrl + u</td></tr><tr><td align="left">将当前网页保存为书签</td><td align="left">Ctrl + d</td></tr><tr><td align="left">将所有打开的标签页以书签的形式保存在新文件夹中</td><td align="left">Ctrl + Shift + d</td></tr><tr><td align="left">开启或关闭全屏模式</td><td align="left">F11</td></tr><tr><td align="left">放大网页上的所有内容</td><td align="left">Ctrl 和 +</td></tr><tr><td align="left">缩小网页上的所有内容</td><td align="left">Ctrl 和 -</td></tr><tr><td align="left">将网页上的所有内容恢复到默认大小</td><td align="left">Ctrl + 0</td></tr><tr><td align="left">向下滚动网页，一次一个屏幕</td><td align="left">空格键或 PgDn</td></tr><tr><td align="left">向上滚动网页，一次一个屏幕</td><td align="left">Shift + 空格键或 PgUp</td></tr><tr><td align="left">转到网页顶部</td><td align="left">首页</td></tr><tr><td align="left">转到网页底部</td><td align="left">末尾</td></tr><tr><td align="left">在网页上水平滚动</td><td align="left">按住 Shift 键并滚动鼠标滚轮</td></tr><tr><td align="left">将光标移到文本字段中的上一个字词前面</td><td align="left">Ctrl + 向左箭头键</td></tr><tr><td align="left">将光标移到文本字段中的上一个字词后面</td><td align="left">Ctrl + 向右箭头键</td></tr><tr><td align="left">删除文本字段中的上一个字词</td><td align="left">Ctrl + Backspace</td></tr><tr><td align="left">将焦点移到通知上</td><td align="left">Alt + n</td></tr><tr><td align="left">在通知中允许</td><td align="left">Alt + Shift + a</td></tr><tr><td align="left">在通知中拒绝</td><td align="left">Alt + Shift + d</td></tr><tr><td align="left">在当前标签页中打开主页</td><td align="left">Alt + Home</td></tr></tbody></table><h3 id="网页快捷键-1"><a href="#网页快捷键-1" class="headerlink" title="网页快捷键"></a>网页快捷键</h3><table><thead><tr><th align="left">操作</th><th align="left">快捷键</th></tr></thead><tbody><tr><td align="left">在当前标签页中打开链接（仅限鼠标）</td><td align="left">将链接拖到标签页中</td></tr><tr><td align="left">在新的后台标签页中打开链接</td><td align="left">按住 Ctrl 键的同时点击链接</td></tr><tr><td align="left">打开链接，并跳转到该链接</td><td align="left">按住 Ctrl + Shift 键的同时点击链接</td></tr><tr><td align="left">打开链接，并跳转到该链接（仅使用鼠标）</td><td align="left">将链接拖到标签栏的空白区域</td></tr><tr><td align="left">在新窗口中打开链接</td><td align="left">按住 Shift 键的同时点击链接</td></tr><tr><td align="left">在新窗口中打开标签页（仅使用鼠标）</td><td align="left">将标签页拖出标签栏</td></tr><tr><td align="left">将标签页移至当前窗口（仅限鼠标）</td><td align="left">将标签页拖到现有窗口中</td></tr><tr><td align="left">将标签页移回其原始位置</td><td align="left">拖动标签页的同时按 Esc</td></tr><tr><td align="left">将当前网页保存为书签</td><td align="left">将相应网址拖动到书签栏中</td></tr><tr><td align="left">下载链接目标</td><td align="left">按住 Alt 键的同时点击链接</td></tr><tr><td align="left">显示浏览记录</td><td align="left">右键点击”后退”箭头 返回 或”前进”箭头 下一个，或者点击并按住”后退”箭头 返回 或”前进”箭头 下一个</td></tr><tr><td align="left">最大化或最小化窗口</td><td align="left">双击标签栏的空白区域</td></tr><tr><td align="left">放大网页上的所有内容</td><td align="left">按住 Ctrl 键的同时向上滚动鼠标滚轮</td></tr><tr><td align="left">缩小网页上的所有内容</td><td align="left">按住 Ctrl 键的同时向下滚动鼠标滚轮</td></tr></tbody></table><h2 id="Mac-系统"><a href="#Mac-系统" class="headerlink" title="Mac 系统"></a>Mac 系统</h2><h3 id="标签页和窗口快捷键-1"><a href="#标签页和窗口快捷键-1" class="headerlink" title="标签页和窗口快捷键"></a>标签页和窗口快捷键</h3><table><thead><tr><th><strong>操作</strong></th><th><strong>快捷键</strong></th></tr></thead><tbody><tr><td>打开新窗口</td><td><strong>⌘ + n</strong></td></tr><tr><td>在无痕模式下打开新窗口</td><td><strong>⌘ + Shift + n</strong></td></tr><tr><td>打开新的标签页，并跳转到该标签页</td><td><strong>⌘ + t</strong></td></tr><tr><td>重新打开最后关闭的标签页，并跳转到该标签页</td><td><strong>⌘ + Shift + t</strong></td></tr><tr><td>跳转到下一个打开的标签页</td><td><strong>⌘ + Option + 向右箭头键</strong></td></tr><tr><td>跳转到上一个打开的标签页</td><td><strong>⌘ + Option + 向左箭头键</strong></td></tr><tr><td>跳转到特定标签页</td><td><strong>⌘ + 1</strong> 到 <strong>⌘ + 8</strong></td></tr><tr><td>跳转到最后一个标签页</td><td><strong>⌘ + 9</strong></td></tr><tr><td>打开当前标签页浏览记录中记录的上一个页面</td><td><strong>⌘ + [</strong> 或 <strong>⌘ + 向左箭头键</strong></td></tr><tr><td>打开当前标签页浏览记录中记录的下一个页面</td><td><strong>⌘ + ]</strong> 或 <strong>⌘ + 向右箭头键</strong></td></tr><tr><td>关闭当前标签页或弹出式窗口</td><td><strong>⌘ + w</strong></td></tr><tr><td>关闭当前窗口</td><td><strong>⌘ + Shift + w</strong></td></tr><tr><td>最小化窗口</td><td><strong>⌘ + m</strong></td></tr><tr><td>隐藏 Google Chrome</td><td><strong>⌘ + h</strong></td></tr><tr><td>退出 Google Chrome</td><td><strong>⌘ + q</strong></td></tr></tbody></table><h3 id="Google-Chrome-功能快捷键"><a href="#Google-Chrome-功能快捷键" class="headerlink" title="Google Chrome 功能快捷键"></a>Google Chrome 功能快捷键</h3><table><thead><tr><th><strong>操作</strong></th><th><strong>快捷键</strong></th></tr></thead><tbody><tr><td>显示或隐藏书签栏</td><td><strong>⌘ + Shift + b</strong></td></tr><tr><td>打开书签管理器</td><td><strong>⌘ + Option + b</strong></td></tr><tr><td>在新标签页中打开”设置”页</td><td><strong>⌘ + ,</strong></td></tr><tr><td>在新标签页中打开”历史记录”页</td><td><strong>⌘ + y</strong></td></tr><tr><td>在新标签页中打开”下载内容”页</td><td><strong>⌘ + Shift + j</strong></td></tr><tr><td>打开查找栏搜索当前网页</td><td><strong>⌘ + f</strong></td></tr><tr><td>跳转到与查找栏中搜索字词相匹配的下一条内容</td><td><strong>⌘ + g</strong></td></tr><tr><td>跳转到与查找栏中搜索字词相匹配的上一条内容</td><td><strong>⌘ + Shift + g</strong></td></tr><tr><td>打开查找栏后，搜索选定文本</td><td><strong>⌘ + e</strong></td></tr><tr><td>打开”开发者工具”</td><td><strong>⌘ + Option + i</strong></td></tr><tr><td>打开”清除浏览数据”选项</td><td><strong>⌘ + Shift + Delete</strong></td></tr><tr><td>使用其他帐号登录或以访客身份浏览</td><td><strong>⌘ + Shift + m</strong></td></tr></tbody></table><h3 id="地址栏快捷键-1"><a href="#地址栏快捷键-1" class="headerlink" title="地址栏快捷键"></a>地址栏快捷键</h3><table><thead><tr><th><strong>操作</strong></th><th><strong>快捷键</strong></th></tr></thead><tbody><tr><td>使用默认搜索引擎进行搜索</td><td>输入搜索字词并按 <strong>Enter</strong> 键</td></tr><tr><td>使用其他搜索引擎进行搜索</td><td>输入搜索引擎名称并按 <strong>Tab</strong> 键</td></tr><tr><td>为网站名称添加 <code>www.</code> 和 <code>.com</code>，并在当前标签页中打开该网站</td><td>输入网站名称并按 <strong>Control + Enter</strong> 键</td></tr><tr><td>为网站名称添加 <code>www.</code> 和 <code>.com</code>，并在新标签页中打开该网站</td><td>输入网站名称并按 <strong>Control + Shift + Enter</strong> 键</td></tr><tr><td>在新的后台标签页中打开网站</td><td>输入网址并按 <strong>⌘ + Enter</strong> 键</td></tr><tr><td>跳转到地址栏</td><td><strong>⌘ + l</strong></td></tr><tr><td>从地址栏中移除联想查询内容</td><td>按<strong>向下箭头键</strong>以突出显示相应内容，然后按 <strong>Shift + fn + Delete</strong></td></tr></tbody></table><h3 id="网页快捷键-2"><a href="#网页快捷键-2" class="headerlink" title="网页快捷键"></a>网页快捷键</h3><table><thead><tr><th><strong>操作</strong></th><th><strong>快捷键</strong></th></tr></thead><tbody><tr><td>打开选项以打印当前网页</td><td><strong>⌘ + p</strong></td></tr><tr><td>打开选项以保存当前网页</td><td><strong>⌘ + s</strong></td></tr><tr><td>打开”页面设置”对话框</td><td><strong>⌘ + Option + p</strong></td></tr><tr><td>通过电子邮件发送当前网页</td><td><strong>⌘ + Shift + i</strong></td></tr><tr><td>重新加载当前网页</td><td><strong>⌘ + r</strong></td></tr><tr><td>重新加载当前网页（忽略缓存的内容）</td><td><strong>⌘ + Shift + r</strong></td></tr><tr><td>停止加载网页</td><td><strong>Esc</strong></td></tr><tr><td>浏览下一个可点击项</td><td><strong>Tab</strong></td></tr><tr><td>浏览上一个可点击项</td><td><strong>Shift + Tab</strong></td></tr><tr><td>使用 Google Chrome 打开计算机中的文件</td><td>按住 <strong>⌘ + o</strong> 键并选择文件</td></tr><tr><td>显示当前网页的 HTML 源代码（不可修改）</td><td><strong>⌘ + Option + u</strong></td></tr><tr><td>打开 JavaScript 控制台</td><td><strong>⌘ + Option + j</strong></td></tr><tr><td>将当前网页保存为书签</td><td><strong>⌘ + d</strong></td></tr><tr><td>将所有打开的标签页以书签的形式保存在新文件夹中</td><td><strong>⌘ + Shift + d</strong></td></tr><tr><td>开启或关闭全屏模式</td><td><strong>⌘ + Ctrl + f</strong></td></tr><tr><td>放大网页上的所有内容</td><td><strong>⌘ 和 +</strong></td></tr><tr><td>缩小网页上的所有内容</td><td><strong>⌘ 和 -</strong></td></tr><tr><td>将网页上的所有内容恢复到默认大小</td><td><strong>⌘ + 0</strong></td></tr><tr><td>向下滚动网页，一次一个屏幕</td><td><strong>空格键</strong></td></tr><tr><td>向上滚动网页，一次一个屏幕</td><td><strong>Shift + 空格键</strong></td></tr><tr><td>搜索网络</td><td><strong>⌘ + Option + f</strong></td></tr><tr><td>将光标移到文本字段中的上一个字词前面</td><td><strong>Option + 向左箭头键</strong></td></tr><tr><td>将光标移到文本字段中的上一个字词后面</td><td><strong>Option + 向右箭头键</strong></td></tr><tr><td>删除文本字段中的上一个字词</td><td><strong>Option + Delete</strong></td></tr><tr><td>在当前标签页中打开主页</td><td><strong>⌘ + Shift + h</strong></td></tr></tbody></table><h3 id="鼠标快捷键"><a href="#鼠标快捷键" class="headerlink" title="鼠标快捷键"></a>鼠标快捷键</h3><table><thead><tr><th><strong>操作</strong></th><th><strong>快捷键</strong></th></tr></thead><tbody><tr><td>在当前标签页中打开链接（仅限鼠标）</td><td>将链接拖到标签页中</td></tr><tr><td>在新的后台标签页中打开链接</td><td>按住 <strong>⌘</strong> 键的同时点击链接</td></tr><tr><td>打开链接，并跳转到该链接</td><td>按住 <strong>⌘ + Shift</strong> 键的同时点击链接</td></tr><tr><td>打开链接，并跳转到该链接（仅使用鼠标）</td><td>将链接拖到标签栏的空白区域</td></tr><tr><td>在新窗口中打开链接</td><td>按住 <strong>Shift</strong> 键的同时点击链接</td></tr><tr><td>在新窗口中打开标签页（仅使用鼠标）</td><td>将标签页拖出标签栏</td></tr><tr><td>将标签页移至当前窗口（仅限鼠标）</td><td>将标签页拖到现有窗口中</td></tr><tr><td>将标签页移回其原始位置</td><td>拖动标签页的同时按 <strong>Esc</strong></td></tr><tr><td>将当前网页保存为书签</td><td>将相应网址拖动到书签栏中</td></tr><tr><td>下载链接目标</td><td>按住 <strong>Option</strong> 键的同时点击链接</td></tr><tr><td>显示浏览记录</td><td>右键点击”后退”箭头 <img src="https://static.runoob.com/images/mix/left.png" alt="返回"> 或”前进”箭头 <img src="https://static.runoob.com/images/mix/right.png" alt="下一个"> ，或者左键点击（并按住鼠标左键不放）”后退”箭头 <img src="https://static.runoob.com/images/mix/left.png" alt="返回"> 或”前进”箭头 <img src="https://static.runoob.com/images/mix/right.png" alt="下一个"></td></tr><tr><td>将窗口高度最大化</td><td>双击标签栏的空白区域</td></tr></tbody></table>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;转自：&lt;a href=&quot;https://www.runoob.com/w3cnote/google-chrome-shortcuts.html&quot; target=&quot;_blank&quot; rel=&quot;noopener&quot;&gt;https://www.runoob.com/w3cnote/go
      
    
    </summary>
    
    
    
      <category term="快捷键" scheme="http://ymlog.cn/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>VSCode快捷键</title>
    <link href="http://ymlog.cn/2020/06/16/VsCode%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    <id>http://ymlog.cn/2020/06/16/VsCode%E5%BF%AB%E6%8D%B7%E9%94%AE/</id>
    <published>2020-06-16T02:51:59.000Z</published>
    <updated>2020-06-19T02:05:05.107Z</updated>
    
    <content type="html"><![CDATA[<p>常用的几个</p><table><thead><tr><th>shortcut</th><th>info</th></tr></thead><tbody><tr><td>Ctrl+Shift+K</td><td>删除当前行</td></tr><tr><td>Ctrl+L</td><td>选中当前行</td></tr><tr><td>Ctrl+letf, Ctrl+Right</td><td>逐个单词跳转</td></tr><tr><td>Ctrl+B</td><td>打开左侧页面</td></tr><tr><td>Ctrl+J</td><td>打开终端</td></tr><tr><td>Ctrl+F</td><td>搜索</td></tr><tr><td>Ctrl+D</td><td>查找当下字符，可以跳转</td></tr><tr><td>Fn+Up , Fn+Down</td><td>翻半页</td></tr><tr><td>Ctrl+Backspace</td><td>删除一个单词</td></tr><tr><td>Shift + Alt +Down</td><td>复制一行</td></tr><tr><td>Ctrl+],Ctrl+[</td><td>缩进tab和退缩进</td></tr><tr><td>Ctrl+Shift+W</td><td>关闭编辑器</td></tr><tr><td>Ctrl+W</td><td>关闭当前编辑文本</td></tr><tr><td>Ctrl + Enter</td><td>在当前行下插入新的一行</td></tr><tr><td>Ctrl+Shift+|</td><td>匹配括号跳转</td></tr><tr><td>Ctrl + up/down</td><td>行视图上下偏移</td></tr><tr><td>Ctrl + P</td><td>跳转文件</td></tr><tr><td>Alt + Click</td><td>插入光标-支持多个</td></tr><tr><td>Ctrl + =/-</td><td>放大 / 缩小</td></tr><tr><td>Ctrl + Shift + V</td><td>复制到当前激活的终端</td></tr><tr><td>Ctrl + `</td><td>打开集成终端</td></tr><tr><td>Ctrl + Shift + `</td><td>创建一个新的终端</td></tr></tbody></table><p>为tab设置颜色</p><ul><li>安装Material Theme插件</li><li>Ctrl+Shift+P，选择Material Theme：set accent color</li><li>选择喜欢颜色</li></ul><p>查看运行插件</p><p>Ctrl+Shift+P ； 输入<code>show running extensions</code>查看所有运行插件</p><p>更多快捷键：<a href="https://blog.csdn.net/crper/article/details/54099319" target="_blank" rel="noopener">https://blog.csdn.net/crper/article/details/54099319</a></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;常用的几个&lt;/p&gt;
&lt;table&gt;
&lt;thead&gt;
&lt;tr&gt;
&lt;th&gt;shortcut&lt;/th&gt;
&lt;th&gt;info&lt;/th&gt;
&lt;/tr&gt;
&lt;/thead&gt;
&lt;tbody&gt;&lt;tr&gt;
&lt;td&gt;Ctrl+Shift+K&lt;/td&gt;
&lt;td&gt;删除当前行&lt;/td&gt;
&lt;/tr&gt;
&lt;tr&gt;
      
    
    </summary>
    
    
    
      <category term="快捷键" scheme="http://ymlog.cn/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/"/>
    
  </entry>
  
  <entry>
    <title>KVM实例总结</title>
    <link href="http://ymlog.cn/2020/06/04/KVM%E5%AE%9E%E4%BE%8B/"/>
    <id>http://ymlog.cn/2020/06/04/KVM%E5%AE%9E%E4%BE%8B/</id>
    <published>2020-06-04T09:19:51.000Z</published>
    <updated>2020-06-15T13:13:51.232Z</updated>
    
    <content type="html"><![CDATA[<p>自动化脚本提升运维效率</p><h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p>kvm创建虚拟机的根本在于这样一条命令，<code>virsh define vm-template.xml</code>，这条命令的核心就是创建一个虚拟机，之后或者之前的内容都是围绕着这条命令和这个虚拟机的。</p><p>- 更新vm-templatem模板是为了进行子机资源配置</p><p>- 在更新模板之前检查时主机是为了防止给子机过量的资源导致母机不稳定</p><p>- 桥接网卡是为了让子机连接局域网</p><p>所以，virsh define vm-template.xml 其本质是在安全可靠的前提下，将母机的资源通过kvm虚拟化的形式分配给子机。</p><p>所以主要考虑方向有两个</p><p>1、保障母机和子机的安全可靠，包括系统安全和网络安全</p><p>2、进行资源分配，包括网络资源、存储资源、计算资源等</p><p>该脚本考虑了母机分配资源不会超过母机承受范围的资源安全，其他系统层面和网络层面的安全问题还需考虑</p><h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">- 1、sed   </span><br><span class="line">- 替换注释 sed -i <span class="string">"s/^IPADDR/#&amp;/"</span> file</span><br><span class="line">- 字段追加 sed -i <span class="string">"/DEVICE/a\BRIDGE='br0'"</span> file</span><br><span class="line">- 指定行插入 sed -i <span class="string">"4iContent"</span> file</span><br><span class="line">- 注意<span class="string">""</span> 和<span class="string">''</span>的区别，在使用变量时可以加\转义字符</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 2、cat </span><br><span class="line">- cat &lt;&lt; EOF &gt; file ，这里的变量需要转义字符\,且EOF不能使用双引号<span class="string">"EOF"</span>,否则变量会消失</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 3、expect</span><br><span class="line">- expect执行顺序容易错乱</span><br><span class="line">- expect <span class="string">"~"</span> &#123; send <span class="string">"umount /share \r"</span> &#125; ：常用expect方法</span><br><span class="line">- 如果执行expect需要等待很长时间，可以把timeout设置为-1</span><br><span class="line">- expect脚本执行时，不能使用sh script.sh 这样相当于用shell的解释器执行，可以采用./script <span class="variable">$args</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 4、<span class="keyword">while</span></span><br><span class="line">- <span class="keyword">while</span> <span class="built_in">read</span> a b c d e;<span class="keyword">do</span> ....; <span class="keyword">done</span> &lt; file，用于读取类似格式为 192.168.1.1 255.255.255.0 C 之类的文本，读取之后 a b c d e 均为file中对应的变量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 5、<span class="built_in">echo</span></span><br><span class="line">- 注意<span class="built_in">echo</span>颜色的使用，红色闪烁和绿色健康：-e <span class="string">"\033[31m\033[01m\033[05m[ err ]\033[0m"</span>  <span class="string">"\033[32m [ OK ] \033[0m"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 6、bc</span><br><span class="line">- shell中浮点数和整数、浮点数和浮点数不能直接比较大小，可以使用bc工具</span><br><span class="line">- <span class="built_in">echo</span> <span class="string">"1.1 &gt; 1"</span> | bc  正确为1 错误为0</span><br></pre></td></tr></table></figure><h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br></pre></td><td class="code"><pre><span class="line">完成过程</span><br><span class="line">   - 1|主机检查-（磁盘、CPU、内存） 写了自动检查&amp;手动检查[0]</span><br><span class="line">   - 2|网卡桥接，创建一个br0作为网桥，连接eth1和kvm虚拟机</span><br><span class="line">   - 3|安装软件，执行tlinux*.run</span><br><span class="line">   - 4|重启母机</span><br><span class="line">   - 5|主机通信[1]</span><br><span class="line">   - 6|创建子机磁盘，包括系统盘、数据盘、共享盘</span><br><span class="line">   - 6|配置模板，包括调整CPU个数、内存大小、vlanid、网卡、uuid、mac地址、子机名称</span><br><span class="line">   - 7|使用6中的模板创建子机[2]</span><br><span class="line">   - 8|登录子机[3]</span><br><span class="line">   - 9|执行脚本，只要expect程序不错，这里基本不会错[4]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[0]</span><br><span class="line">刚开始考虑当母机资源超过一定比例则程序退出，比如磁盘使用超过2/3，后来觉得这样不够灵活，改用百分比，默认50%</span><br><span class="line">在设置百分比的时候有几点小问题</span><br><span class="line">1、浮点数运算保留小数</span><br><span class="line">    使用scale可以准确保留小数，<span class="built_in">echo</span> <span class="string">"scale=2;62/3"</span> | bc 结果 20.66</span><br><span class="line">    使用<span class="built_in">printf</span>可以保留小数位，补零填充  <span class="built_in">printf</span> %.2f 结果20.00</span><br><span class="line">2、浮点数运算不保留小数</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"123.123"</span>|sed <span class="string">"s/\..*//g"</span></span><br><span class="line">    *代表0到多个，所以第一个命令中\.*只能替换掉小数点变成空</span><br><span class="line">    \..*代表了小数点之后的1到多个</span><br><span class="line">3、除法</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"2 / 3"</span> | bc                          这个结果会显示为0</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"scale=2 ;2 / 3"</span> | bc                 这个结果会显示为.66</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">"%.2f"</span> `<span class="built_in">echo</span> <span class="string">"scale=2;2/3"</span> | bc`    这个结果会显示为0.66</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[1]</span><br><span class="line">刚开始的时候选择将subvm_configuration.sh这个脚本cat进内存，然后用expect登录到子机的时候<span class="built_in">echo</span>到文件，然后执行。后来发现expect输出的时候会把subvm_configuration.sh脚本里的内容先执行一遍，而且还存在其他一些问题，比如说<span class="built_in">echo</span>到文件的时候残缺不全、不换行、文件为空等。</span><br><span class="line">后来采用磁盘共享的方式，在宿主机上创建一块磁盘，然后挂载到/tmp/share/这个目录，再将subvm_configuration.sh脚本和ipinfo配置文件复制到该目录，之后在子机的XML文件中添加一块disk(vdc)，登录进子机后，挂载vdc，此时就可以看到母机上/tmp/share/下的内容了。直接执行脚本即可。</span><br><span class="line">磁盘共享也有一个缺点，就是文件内容不能实时刷新，比如在母机上改了ipinfo，只有子机重启后，子机上的ipinfo才可以刷新，鉴于/tmp/share/这个目录每个子机一生只有一次用到，所以这个问题暂时不需要解决。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[2]</span><br><span class="line">创建子机</span><br><span class="line">1、<span class="keyword">if</span> ( vlanid != 0  &amp;&amp; xenbrx not <span class="keyword">in</span> `brctl show` ) 会报错网卡未找到导致虚拟机启动失败</span><br><span class="line">2、vm-template模板不正确，包括&lt;emulator&gt;/usr/<span class="built_in">local</span>/bin/qemu-system-x86_64&lt;/emulator&gt;路径不正确，会导致虚拟机无法启动</span><br><span class="line">3、disk的slot卡槽相同会导致虚拟机无法启动</span><br><span class="line">4、需要注意的是，virsh define vm-template 这条命令的执行路径是/usr/<span class="built_in">local</span>/etc/libvirt/qemu/vm-template，最后会在/usr/<span class="built_in">local</span>/etc/libvirt/qemu/下生成vm<span class="variable">$ipfmt</span>.xml的配置文件。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[3]</span><br><span class="line">expect会有很多问题</span><br><span class="line">1、命令不按顺序执行</span><br><span class="line">2、传入的变量为空，且传入的变量下标是从0开始的；shell传入变量下标从1开始，0代表自身文件</span><br><span class="line">3、<span class="built_in">set</span> timeout <span class="variable">$time</span> 设置的时间不一定准确，设置了300秒延时，但未到300s，程序还是退出了，可以考虑直接设置 timeout 为-1</span><br><span class="line">4、expect有多种写法，有expect &lt;&lt; EOF ; expect eof ; 最正常的是上面用的</span><br><span class="line">5、expect文件用的解释器是/usr/bin/expect，这里将login.sh使用cat写在了单独的文件中</span><br><span class="line"></span><br><span class="line">[4]</span><br><span class="line">1、subvm_configuration.sh配置了两张网卡，格式化vdb数据盘，配置ssh</span><br><span class="line">2、eth0为连接外网的网卡，使用tunnel，eth1为内网网卡，使用vlan</span><br><span class="line"></span><br><span class="line">xenbrX为隧道入口，母机收到从xenbr361口收到的报文，就发给另一端隧道，从而实现连接外网</span><br><span class="line">tunnel network ---- host(default router: subhost -&gt; netowrk , throught interface &amp; sh vlan.sh ) ---- subhost</span><br><span class="line"></span><br><span class="line">母机收到vlan的报文，就在指定vlan的广播域内进行路由（不一定是母机进行路由）</span><br><span class="line">vlan network ---- host(broadcast router: subhost ---&gt; broadcast/vlanid throught 802.1Q )  ---- subhost</span><br></pre></td></tr></table></figure><h1 id=""><a href="#" class="headerlink" title="[*]"></a>[*]</h1><p>expect合理用法</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">cat  &lt;&lt; EOF &gt;  <span class="variable">$&#123;workdir&#125;</span>/login.sh</span><br><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"><span class="keyword">if</span> &#123; \<span class="variable">$argc</span> &lt; 1&#125; &#123;</span><br><span class="line">puts <span class="string">"Usage:cmd &lt;host&gt;"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">set</span> timeout -1</span><br><span class="line"><span class="built_in">set</span> host [lindex \<span class="variable">$argv</span> 0]</span><br><span class="line">spawn virsh console \<span class="variable">$host</span></span><br><span class="line">expect <span class="string">"*Escape*"</span> &#123; send <span class="string">"\r"</span> &#125;</span><br><span class="line">expect <span class="string">"*login*"</span> &#123; send <span class="string">"root\r"</span> &#125;</span><br><span class="line">expect <span class="string">"*Password*"</span> &#123; send <span class="string">"xxxx\r"</span> &#125;</span><br><span class="line">interact</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure><p>高效的while</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> equipmentName ip netmask;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"=====================<span class="variable">$&#123;equipmentName&#125;</span>=================="</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"inner_ip:<span class="variable">$&#123;ip&#125;</span>"</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"inner_netmask:<span class="variable">$&#123;netmask&#125;</span>"</span></span><br><span class="line"><span class="keyword">done</span> &lt; file</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;自动化脚本提升运维效率&lt;/p&gt;
&lt;h1 id=&quot;大纲&quot;&gt;&lt;a href=&quot;#大纲&quot; class=&quot;headerlink&quot; title=&quot;大纲&quot;&gt;&lt;/a&gt;大纲&lt;/h1&gt;&lt;p&gt;kvm创建虚拟机的根本在于这样一条命令，&lt;code&gt;virsh define vm-template.
      
    
    </summary>
    
    
      <category term="Linux" scheme="http://ymlog.cn/categories/Linux/"/>
    
    
  </entry>
  
  <entry>
    <title>WebSocket</title>
    <link href="http://ymlog.cn/2020/05/03/WebSocket/"/>
    <id>http://ymlog.cn/2020/05/03/WebSocket/</id>
    <published>2020-05-03T11:28:35.000Z</published>
    <updated>2020-06-16T10:16:05.886Z</updated>
    
    <content type="html"><![CDATA[<h1 id="WS介绍"><a href="#WS介绍" class="headerlink" title="WS介绍"></a>WS介绍</h1><p>HTTP</p><p>超文本传输协议(HTTP,HypertextTransferProtocol)是互联网上应用最为广泛的一种网络协议。是用于从WWW服务器传输超文本到本地浏览器的传送协议。</p><p>Web通讯</p><p><img src="https://i.loli.net/2020/05/03/ToOBRW7IeUilqa9.png" alt="image-20200503143751258.png"></p><p>WebSocket</p><p>WebSocket Protocal是HTML5一种新的协议，它实现了浏览器与服务器全双工通信（full-duple），一开始握手需要借助http请求完成。</p><p>HTTP请求是无状态的，每一次收发数据都需要建立连接。WebSocket不需要建立连接就可以收发数据。</p><p><img src="https://i.loli.net/2020/05/03/2e13BGHfSyCtAqs.png" alt="image-20200503143949598.png"></p><p>WebSocket对象提供一组API，用于创建和管理WebSocket连接，以及通过连接发送和接受数据。</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">创建WebSocket对象</span><br><span class="line">var ws = new WebSocket(url,[protocals]);</span><br><span class="line"></span><br><span class="line">url: 表示要连接的URL，这个URL应该为响应WebSocket的地址</span><br><span class="line">protocals:可以是单个的协议名字字符串或者包含多个协议名字字符串的数组</span><br></pre></td></tr></table></figure><p>方法</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">close([code][,reason]) 关闭websocket连接或停止正在进行的连接请求</span><br><span class="line">code: 一个数字表示关闭连接的状态号，表示连接关闭的原因</span><br><span class="line">reason: 一个可读字符串，表示连接被关闭的原因</span><br><span class="line"></span><br><span class="line">send(data) 通过websocket连接，向服务器发送数据</span><br><span class="line">data: 一个数字值表示关闭连接的状态号，表示连接被关闭的原因</span><br></pre></td></tr></table></figure><p>属性</p><table><thead><tr><th>名词</th><th>解释</th></tr></thead><tbody><tr><td>onclose</td><td>用于监听连接关闭事件监听器。当WebSocket对象的ReadyState状态变为CLOSED时，会触发该事件。会接受一个close event对象</td></tr><tr><td>onerror</td><td>当错误发生时，用于监听error事件的事件监听器，会接受一个error event对象</td></tr><tr><td>onmessage</td><td>一个用于消息事件的事件监听器，这一事件当有消息到达的时候该事件会触发。会接受一个message event对象</td></tr><tr><td>onopen</td><td>一个用于连接打开事件的事件监听器，当readyState的值变为OPEN的时候会触发该事件，会接受一个open event对象</td></tr><tr><td>readyState</td><td>连接的当前状态 0 连接还没开启 1 连接已经开启并准备好进行通信 2 连接正在关闭的过程中 3 连接已经关闭，或者连接无法建立</td></tr></tbody></table><h1 id="简易的WS"><a href="#简易的WS" class="headerlink" title="简易的WS"></a>简易的WS</h1><p>npm安装websocket</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">npm install websocket</span><br></pre></td></tr></table></figure><p>后端页面</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">var</span> WebSocketServer = <span class="built_in">require</span>(<span class="string">'websocket'</span>).server;</span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">'http'</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">//创建服务器</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">request, response</span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log((<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">' Received request for '</span> + request.url);</span><br><span class="line">    response.writeHead(<span class="number">404</span>);</span><br><span class="line">    response.end();</span><br><span class="line">&#125;);</span><br><span class="line"><span class="comment">// 监听8080端口</span></span><br><span class="line">server.listen(<span class="number">3000</span>, <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log((<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">' Server is listening on port 8080'</span>);</span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"><span class="comment">// 创建websocket服务器</span></span><br><span class="line">wsServer = <span class="keyword">new</span> WebSocketServer(&#123;</span><br><span class="line">    httpServer: server,</span><br><span class="line">    autoAcceptConnections: <span class="literal">false</span></span><br><span class="line">&#125;);</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line"><span class="comment">//websocket建立连接</span></span><br><span class="line">wsServer.on(<span class="string">'request'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">request</span>) </span>&#123;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//当前的连接</span></span><br><span class="line">    <span class="keyword">var</span> connection = request.accept(<span class="literal">null</span>, request.origin);</span><br><span class="line">    <span class="built_in">console</span>.log((<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">' Connection accepted.'</span>);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">//定时向客户端发送消息</span></span><br><span class="line">    setInterval(<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">        connection.sendUTF(<span class="string">"服务端发送新消息"</span>+(<span class="keyword">new</span> <span class="built_in">Date</span>()))</span><br><span class="line">    &#125;,<span class="number">1000</span>)</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 监听当前连接，发送message的时候</span></span><br><span class="line">    connection.on(<span class="string">'message'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">message</span>) </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (message.type === <span class="string">'utf8'</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Received Message: '</span> + message.utf8Data);</span><br><span class="line">            connection.sendUTF(message.utf8Data);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="keyword">else</span> <span class="keyword">if</span> (message.type === <span class="string">'binary'</span>) &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">'Received Binary Message of '</span> + message.binaryData.length + <span class="string">' bytes'</span>);</span><br><span class="line">            connection.sendBytes(message.binaryData);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;);</span><br><span class="line">    <span class="comment">// 监听当前连接，当close的时候出发事件</span></span><br><span class="line">    connection.on(<span class="string">'close'</span>, <span class="function"><span class="keyword">function</span>(<span class="params">reasonCode, description</span>) </span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log((<span class="keyword">new</span> <span class="built_in">Date</span>()) + <span class="string">' Peer '</span> + connection.remoteAddress + <span class="string">' disconnected.'</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><p>前端页面</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Websocket前端页面<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="comment">// 创建websocket对象</span></span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:3000"</span>);</span></span><br><span class="line">        </span><br><span class="line"><span class="actionscript">        <span class="comment">// 监听建立连接</span></span></span><br><span class="line"><span class="actionscript">        ws.onopen = <span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"连接成功！"</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(res);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="comment">//监听有新消息</span></span></span><br><span class="line"><span class="actionscript">        ws.onmessage = <span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"有新消息！"</span>);</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(res);</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>页面效果</p><p><img src="https://i.loli.net/2020/05/03/4jEb27kvDXBKF8H.png" alt="image-20200503150850275.png"></p><h1 id="多人通讯"><a href="#多人通讯" class="headerlink" title="多人通讯"></a>多人通讯</h1><p>后端</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>)</span><br><span class="line"><span class="comment">// 引入websocket模块</span></span><br><span class="line"><span class="keyword">var</span> WebSocketServer = <span class="built_in">require</span>(<span class="string">'websocket'</span>).server</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//存储所有终端连接</span></span><br><span class="line"><span class="keyword">var</span> clients  = [];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 引入http模块，搭建http服务器</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer()</span><br><span class="line"><span class="comment">// server.listen(3000, ()=&gt; &#123;</span></span><br><span class="line"><span class="comment">//     console.log("服务器搭建成功！,监听localhost:3000")</span></span><br><span class="line"><span class="comment">// &#125;)</span></span><br><span class="line">server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>,<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"服务器创建成功"</span>)</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建websocket服务对象</span></span><br><span class="line"><span class="keyword">var</span> wsServer = <span class="keyword">new</span> WebSocketServer(&#123;<span class="attr">httpServer</span>:server&#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 监听连接请求，建立连接</span></span><br><span class="line"><span class="comment">// webSocketRequest 当前连接建立的请求</span></span><br><span class="line">wsServer.on(<span class="string">'request'</span>,<span class="function"><span class="keyword">function</span>(<span class="params">webSocketRequest</span>)</span>&#123;</span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"建立连接"</span>)</span><br><span class="line">    <span class="comment">// 当前连接 会话</span></span><br><span class="line">    <span class="keyword">var</span> connection = webSocketRequest.accept(<span class="literal">null</span>, <span class="string">'accepted-origin'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//把连接添加到终端</span></span><br><span class="line">    clients.push(connection)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当客户端发来信息的时候 ,判断信息的两种类型</span></span><br><span class="line">    <span class="comment">// For Text Frames:</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     type: "utf8",</span></span><br><span class="line">    <span class="comment">//     utf8Data: "A string containing the received message."</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    <span class="comment">// // For Binary Frames:</span></span><br><span class="line">    <span class="comment">// &#123;</span></span><br><span class="line">    <span class="comment">//     type: "binary",</span></span><br><span class="line">    <span class="comment">//     binaryData: binaryDataBuffer // a Buffer object containing the binary message payload</span></span><br><span class="line">    <span class="comment">// &#125;</span></span><br><span class="line">    connection.on(<span class="string">"message"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">msg</span>)</span>&#123;</span><br><span class="line">        <span class="comment">// 如果是文本类型，则给每一个当前的连接都发送一遍</span></span><br><span class="line">        <span class="keyword">if</span>(msg.type == <span class="string">"utf8"</span>)&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(<span class="string">"遍历用户，发送数据...."</span>+msg.utf8Data)</span><br><span class="line">            <span class="comment">// 遍历连接数组，给每一个连接发送数据</span></span><br><span class="line">            clients.forEach(<span class="function"><span class="keyword">function</span>(<span class="params">item</span>)</span>&#123;</span><br><span class="line">                <span class="comment">//发送数据</span></span><br><span class="line">                item.sendUTF(msg.utf8Data)</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">console</span>.log(msg)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当连接断开的时候 , 触发事件</span></span><br><span class="line">    connection.on(<span class="string">"close"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">reasonCode,description</span>)</span>&#123;</span><br><span class="line">        <span class="built_in">console</span>.log(<span class="string">"断开连接"</span>)</span><br><span class="line">        <span class="comment">// 获取当前索引，根据索引删除连接</span></span><br><span class="line">        <span class="keyword">var</span> index = clients.indexOf(connection)</span><br><span class="line">        <span class="comment">// 删除</span></span><br><span class="line">        clients.splice(index,<span class="number">1</span>)</span><br><span class="line">        </span><br><span class="line">    &#125;)</span><br><span class="line">    </span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>前端</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>多终端通信<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span> <span class="attr">id</span>=<span class="string">"content"</span>&gt;</span></span><br><span class="line">        </span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">id</span>=<span class="string">"msg"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> <span class="attr">onclick</span>=<span class="string">"send()"</span>&gt;</span>SEND<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="actionscript">        <span class="keyword">var</span> ws = <span class="keyword">new</span> WebSocket(<span class="string">"ws://localhost:3000"</span>);</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> inputNode = <span class="built_in">document</span>.getElementById(<span class="string">"msg"</span>)</span></span><br><span class="line"><span class="javascript">        <span class="keyword">var</span> ulCon = <span class="built_in">document</span>.getElementById(<span class="string">"content"</span>)</span></span><br><span class="line"></span><br><span class="line"><span class="actionscript">        <span class="function"><span class="keyword">function</span> <span class="title">send</span><span class="params">()</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 将用户输入发送给服务端</span></span></span><br><span class="line">            ws.send(inputNode.value)</span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="actionscript">        ws.onopen = <span class="function"><span class="keyword">function</span><span class="params">(res)</span></span>&#123;</span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"连接成功！"</span>);</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line"><span class="actionscript">        ws.onmessage=<span class="function"><span class="keyword">function</span><span class="params">(msg)</span></span>&#123;</span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 接受服务端传来的数据</span></span></span><br><span class="line"><span class="actionscript">            <span class="comment">// 这里不是msg.value，因为这里的msg是websocket的msg，不是id=msg的意思</span></span></span><br><span class="line"><span class="javascript">            <span class="built_in">console</span>.log(<span class="string">"MSG.value:"</span>+msg.data)</span></span><br><span class="line"><span class="actionscript">            content.innerHTML+=<span class="string">'&lt;li&gt;'</span>+msg.data+<span class="string">'&lt;/li&gt;'</span></span></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;WS介绍&quot;&gt;&lt;a href=&quot;#WS介绍&quot; class=&quot;headerlink&quot; title=&quot;WS介绍&quot;&gt;&lt;/a&gt;WS介绍&lt;/h1&gt;&lt;p&gt;HTTP&lt;/p&gt;
&lt;p&gt;超文本传输协议(HTTP,HypertextTransferProtocol)是互联网上应用最为广泛
      
    
    </summary>
    
    
      <category term="编程" scheme="http://ymlog.cn/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
  </entry>
  
  <entry>
    <title>NodeJS（一） 静态路由</title>
    <link href="http://ymlog.cn/2020/04/29/NodeJS_1/"/>
    <id>http://ymlog.cn/2020/04/29/NodeJS_1/</id>
    <published>2020-04-29T11:57:22.000Z</published>
    <updated>2020-06-16T10:15:37.263Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Nodejs简介"><a href="#Nodejs简介" class="headerlink" title="Nodejs简介"></a>Nodejs简介</h1><p>​    V8引擎本身是用于Chrome浏览器的JS解释部分，但是Ryan Dahl将其搬到了服务器上，用于做服务器。</p><p>​    浏览器和服务器类似，浏览器是发送HTTP请求，接受HTTP响应，服务器也是接受HTTP请求，发送HTTP响应。都已HTML的方式实现。</p><p>​    Nodejs是一个让Javascript运行在服务器端的开发平台，它让Javascript的触角伸到了服务器端，可以和PHP、JSP、Python、Ruby平起平坐。</p><p>不同之处：</p><ol><li>Nodejs不是一种独立的语言，与PHP、JSP、Python的“既是语言，也是平台不同，Nodejs的使用Javascript进行编程，运行在Javascript引擎上（V8）</li><li>与PHP、JSP相比，Nodejs跳过了Apache、Nginx、IIS等HTTP服务器，自己不用建设在任何服务器软件之上。</li></ol><p>Nodejs特点</p><ol><li>单线程</li><li>非阻塞IO</li><li>事件驱动</li></ol><p>1、单线程</p><p>在java、php等服务器端语言中，会为每个客户连接创建一个新的线程，每个线程耗费大约2MB的内存，理论上，一个8G内存的服务器可以同时连接的最大用户数为4000个。</p><p>Nodejs不为每个客户连接创建一个新的线程，而仅仅使用一个线程。当有用户连接了，就触发一个内部时间，通过非阻塞I/O、事件驱动机制，让Node.js程序宏观上也是并行的。使用Nodejs，一个8G的服务器可以同时处理超过4万用户的连接</p><p>另外，单线程带来的好处，还有操作系统完全不再有创建线程，销毁线程带来的时间开销。</p><p>但是，一个用户造成的线程崩溃，其他服务也就崩溃了。</p><p><img src="https://i.loli.net/2020/04/29/GgYacbvhxfnMFPp.png" alt="image-20200427100929280.png"></p><p>2、非阻塞I/O（non-blocking IO）</p><p>例如，当在访问数据库取得数据的时候，需要一段时间。在传统的单线程处理机制中，在执行了访问数据库代码之后，整个线程都将暂停下来，等待数据库返回结果，才能执行后面的代码。也就是说，I/O阻塞了代码的执行，极大的降低了程序的执行效率。</p><p>由于Nodejs采用了非阻塞I/O机制，因此在执行访问数据库代码之后，将立即转而执行后面的代码，把数据库返回结果的处理代码放在回调函数中，从而提高了程序执行效率。</p><p>当某个I/O执行完毕时，将以事件的形式同之I/O操作的线程，线程执行这个事件的回调函数，为了处理异步I/O，线程必须有事件循环，不断的检查有没有未处理的事件。</p><p>阻塞模式下，一个线程只能处理一项任务，想要提高吞吐量必须通过多线程，而非阻塞模式下，一个线程永远在执行计算操作，这个线程的CPU核心利用率永远是100%。</p><p>3、事件驱动（event-driven）</p><p>在Node中，客户端请求建立连接，提交数据等行为，会触发相应的事件，在Node中，一个时刻只能执行一个事件回调函数，但是在执行一个事件回调函数的中途，可以转而处理其他事件（比如又有新用户连接），然后返回据徐执行原事件的回调函数，这种处理机制，称为”时间环“</p><p>Nodejs底层时C++，底层代码中，近半数都是用于事件队列、回调函数队列的构建。</p><h1 id="Nodejs适合做什么？"><a href="#Nodejs适合做什么？" class="headerlink" title="Nodejs适合做什么？"></a>Nodejs适合做什么？</h1><p>​    善于I/O，不善于计算。因为Nodejs最擅长的就是任务调度，如果你的业务有很多CPU计算，实际上也相当于计算阻塞了这个单线程。</p><p>​    当应用程序需要处理大量并发I/O，而向客户端发出响应之前，应用程序内部不需要进行复杂处理的时候，Nodejs非常合适。Nodejs也非常合适与web socket配合，开发长连接（长连接实际上是通过大量请求模拟长连接）的实时交互应用程序。</p><p>比如</p><ul><li>用户表单收集</li><li>考试系统</li><li>聊天室</li><li>图文直播</li><li>提供JSON的API</li></ul><p>Nodejs本身就是极客追求性能极致的产物，缺少了服务器的健壮考量。所以Node不可能应用在极高可靠性的业务中。</p><h1 id="Hello-Node"><a href="#Hello-Node" class="headerlink" title="Hello Node"></a>Hello Node</h1><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//require表示导包</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="comment">//创建服务器，参数是一个回调函数，表示如果有什么请求进来，要做什么</span></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123; </span><br><span class="line">    <span class="comment">// req表示请求，request；res表示响应，response</span></span><br><span class="line">    <span class="comment">// 设置HTTP头部，状态码200，文件类型html，字符集utf8</span></span><br><span class="line">    res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF-8"</span>&#125;);</span><br><span class="line">    res.end(<span class="string">"Hello NodeJS"</span>);</span><br><span class="line"></span><br><span class="line"> &#125;)</span><br><span class="line"><span class="comment">//运行服务器，监听3000端口，任何地址都可以访问</span></span><br><span class="line"> server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/29/iVcvReodCyXm7t6.png" alt="image-20200427105856751.png"></p><p>NodeJS是服务器语句，写的js语句都将运行在服务器上，返回给客户的，都是已经处理好的纯HTML。如果想修改程序，必须中断当前程序，然后重新启动node，不支持热部署。</p><h1 id="Nodejs路由"><a href="#Nodejs路由" class="headerlink" title="Nodejs路由"></a>Nodejs路由</h1><p>Node.JS没有根目录，因为它没有web容器的概念。</p><p>先写一个静态的H5页面：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">style</span>&gt;</span></span><br><span class="line"><span class="css">        <span class="selector-class">.app</span>&#123;</span></span><br><span class="line">            background-color: red;</span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>Nodejs读取文件<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">div</span> <span class="attr">class</span>=<span class="string">"app"</span>&gt;</span>这是一个测试文件<span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>效果大概是这样：</p><img src="https://i.loli.net/2020/04/29/U5NCRwMdscT1KVn.png" alt="image-20200427210543157" style="zoom:33%;" /><ol><li>使用req.url判断输入的路径</li><li>使用fs.readFile()读取网页页面</li><li>使用res.end()返回数据</li></ol><p>然后写staticRender.js文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123; </span><br><span class="line">    <span class="keyword">if</span>(req.url == <span class="string">"/red"</span>)&#123;</span><br><span class="line">        <span class="comment">// 输入路由和源文件没有关系</span></span><br><span class="line">        fs.readFile(<span class="string">"./red.html"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line">            res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF-8"</span>&#125;);</span><br><span class="line">            res.end(data);</span><br><span class="line">    </span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span> <span class="keyword">if</span>(req.url == <span class="string">"/blue"</span>)&#123;</span><br><span class="line">        fs.readFile(<span class="string">"./blue.html"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line">            res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF-8"</span>&#125;);</span><br><span class="line">            res.end(data);</span><br><span class="line">    </span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        res.writeHead(<span class="number">404</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF-8"</span>&#125;);</span><br><span class="line">        res.end(<span class="string">"没有这个页面"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"> &#125;);</span><br><span class="line"> server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2020/04/29/U5NCRwMdscT1KVn.png" alt="image-20200427210543157" style="zoom:33%;" /><img src="https://i.loli.net/2020/04/29/CjBTplzuqLcP5x8.png" alt="image-20200428123714399" style="zoom:33%;" /><p>NodeJS任何静态页面都需要路由，比如在HTML中插入一个image或者css样式，也需要设置一条路由。Nodejs擅长做顶层路由设计。</p><h1 id="模块"><a href="#模块" class="headerlink" title="模块"></a>模块</h1><p>Nodejs中，讲很多的功能划分为了一个个module。</p><h2 id="HTTP模块"><a href="#HTTP模块" class="headerlink" title="HTTP模块"></a>HTTP模块</h2><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//引用模块</span></span><br><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123; </span><br><span class="line">    <span class="comment">//req参数表示请求，res表示响应</span></span><br><span class="line">    <span class="built_in">console</span>.log(<span class="string">"服务器接收到了请求"</span>+req.url);</span><br><span class="line">    <span class="comment">//告诉浏览器连接终止</span></span><br><span class="line">    res.end(); <span class="comment">//end中必须是字符串或者缓冲区</span></span><br><span class="line"> &#125;);</span><br><span class="line"> server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><p>向请求发送响应头，此方法只能在消息上调用一次，并且必须在调用 response.end() 之前调用。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF-8"</span>&#125;);</span><br></pre></td></tr></table></figure><p>req的属性，最关键的就是req.url属性，表示用户请求的URL地址，所有路由设计，都是通过req.url来实现的，我们比较关心的不是拿到URL，而是识别这个URL。</p><p>识别URL用到两个模块，一个是url模块，另一个是querystring模块。</p><h2 id="url"><a href="#url" class="headerlink" title="url"></a>url</h2><p>用于解析url，这样就可以不用正则表达式了</p><p><a href="http://nodejs.cn/api/url.html#url_url_strings_and_url_objects" target="_blank" rel="noopener">http://nodejs.cn/api/url.html#url_url_strings_and_url_objects</a></p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</span><br><span class="line"><span class="comment">//url.parse()可以将一个完整的URL地址分为很多部分</span></span><br><span class="line">myURL=url.parse(<span class="string">'https://user:pass@sub.host.com:8080/p/a/t/h?query=string#hash'</span>);</span><br><span class="line"><span class="built_in">console</span>.log(myURL.host);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// url.host 获取及设置 URL 的主机部分。</span></span><br><span class="line">    <span class="comment">// url.hostname 获取及设置 URL 的主机名部分。 url.host 和 url.hostname 之间的区别是 url.hostname 不包含端口。</span></span><br><span class="line">    <span class="comment">// url.password 获取及设置 URL 的密码部分。</span></span><br><span class="line">    <span class="comment">// url.pathname 获取及设置 URL 的路径部分。</span></span><br><span class="line">    <span class="comment">// url.port 获取及设置 URL 的端口部分。</span></span><br><span class="line">    <span class="comment">// url.protocol 获取及设置 URL 的协议部分。</span></span><br><span class="line">    <span class="comment">// url.username 获取及设置 URL 的用户名部分。</span></span><br><span class="line">    <span class="comment">// url.query 获取及设置URL的查询部分 &amp;name=jack&amp;age=18</span></span><br><span class="line">    <span class="comment">// url.parse(req.url,true).query = &gt; </span></span><br><span class="line">    <span class="comment">// [Object: null prototype] &#123; name: 'jack', age: '18' &#125;</span></span><br><span class="line">    <span class="comment">// [Object: null prototype] &#123; name: 'jack', age: '18' &#125;</span></span><br><span class="line"></span><br><span class="line">url.parse(<span class="string">'url'</span>,<span class="literal">true</span>); <span class="comment">//如果第二个参数是true，那么就可以把所有的查询变为对象 ， 就可以直接打点得到这个参数。</span></span><br></pre></td></tr></table></figure><p>表单提交案例：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;!DOCTYPE html&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">html</span> <span class="attr">lang</span>=<span class="string">"en"</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">head</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">charset</span>=<span class="string">"UTF-8"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">meta</span> <span class="attr">name</span>=<span class="string">"viewport"</span> <span class="attr">content</span>=<span class="string">"width=device-width, initial-scale=1.0"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">title</span>&gt;</span>表单提交<span class="tag">&lt;/<span class="name">title</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">head</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">body</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">form</span> <span class="attr">action</span>=<span class="string">"http://127.0.0.1:3000"</span> <span class="attr">method</span>=<span class="string">"GET"</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"name"</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">name</span>=<span class="string">"age"</span>/&gt;</span> <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"sex"</span> <span class="attr">value</span>=<span class="string">"男"</span>/&gt;</span>男</span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"radio"</span> <span class="attr">name</span>=<span class="string">"sex"</span> <span class="attr">value</span>=<span class="string">"女"</span>/&gt;</span>女<span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"submit"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">form</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">body</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">html</span>&gt;</span></span><br></pre></td></tr></table></figure><p>提交到浏览器的结果为：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1:3000/?name=杜振铨&amp;age=21&amp;sex=男</span><br></pre></td></tr></table></figure><p>然后在Nodejs服务端用url解析出来</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span> (<span class="params">req,res</span>) </span>&#123;</span><br><span class="line">    myURL=url.parse(req.url,<span class="literal">true</span>);</span><br><span class="line">    <span class="keyword">var</span> info = <span class="string">"服务器收到了 - 姓名："</span>+myURL.query.name + <span class="string">"性别："</span>+myURL.query.sex + <span class="string">"年龄："</span>+myURL.query.age;</span><br><span class="line">    <span class="comment">// 这里要用UTF8不然中文乱码</span></span><br><span class="line">    res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF8"</span>&#125;);</span><br><span class="line">    res.end(info);</span><br><span class="line"> &#125;).listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><p>最后在网页上呈现这样的效果：</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">服务器收到了 - 姓名：杜振铨 性别：男 年龄：21</span><br></pre></td></tr></table></figure><p>简单的路由演示：</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">    <span class="comment">// http://127.0.0.1:3000/teacher/122456</span></span><br><span class="line">    <span class="comment">//提取出url,为/teacher/123456</span></span><br><span class="line">    <span class="keyword">var</span> myurl = req.url;</span><br><span class="line">    <span class="built_in">console</span>.log(myurl);</span><br><span class="line"></span><br><span class="line">    res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF8"</span>&#125;);</span><br><span class="line">    <span class="comment">//比较前9位 [0,9)</span></span><br><span class="line">    <span class="keyword">if</span>(myurl.substr(<span class="number">0</span>,<span class="number">9</span>) == <span class="string">"/teacher/"</span>)&#123;</span><br><span class="line">        <span class="comment">//取出从第九位开始往后的,这里就是123456</span></span><br><span class="line">        tearcherid = myurl.substr(<span class="number">9</span>);</span><br><span class="line">        <span class="comment">//看取出来的id是否满足6位数字,不满足则返回不存在,学生栏也一样</span></span><br><span class="line">        <span class="keyword">if</span>(<span class="regexp">/^\d&#123;6&#125;$/</span>.test(tearcherid))&#123;</span><br><span class="line">            res.end(<span class="string">"您要查询的老师信息为 id:"</span>+tearcherid);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res.end(<span class="string">"您访问的老师不存在!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">     <span class="keyword">else</span> <span class="keyword">if</span>(myurl.substr(<span class="number">0</span>,<span class="number">9</span>) == <span class="string">"/student/"</span>)&#123;</span><br><span class="line">        </span><br><span class="line">        <span class="keyword">var</span> studentid = myurl.substr(<span class="number">9</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="regexp">/^\d&#123;10&#125;$/</span>.test(studentid))&#123;</span><br><span class="line">            res.end(<span class="string">"您要查询的学生信息为 id:"</span>+studentid);</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            res.end(<span class="string">"您访问的学生不存在!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        res.end(<span class="string">"您访问的人员不存在!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><h2 id="fs"><a href="#fs" class="headerlink" title="fs"></a>fs</h2><ol><li>readFile读取文件</li><li>mkdir 新建文件夹</li><li>rmdir 移除文件夹</li><li>fs.Stats 查看文件属性<ol><li>stats.isBlockDevice()</li><li>stats.isCharacterDevice()</li><li>stats.isDirectory()</li><li>stats.isFIFO()</li><li>stats.isFile()</li><li>stats.isSocket()</li><li>….</li></ol></li><li></li></ol><p>读取文件</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 三个参数,第一个是完整的路径,当前目录写./</span></span><br><span class="line">   <span class="comment">// 第二个参数是字符集,也可以不设置</span></span><br><span class="line">   <span class="comment">// 第三个参数是回调函数,表示文件读取成功后,做的事</span></span><br><span class="line">   fs.readFile(<span class="string">"./demo.txt"</span>,&#123;<span class="string">"charset"</span>:<span class="string">"utf-8"</span>&#125;,<span class="function"><span class="keyword">function</span> (<span class="params">err,data</span>) </span>&#123; </span><br><span class="line">       <span class="comment">// 抛异常</span></span><br><span class="line">       <span class="keyword">if</span>(err)&#123;</span><br><span class="line">           <span class="keyword">throw</span> err;</span><br><span class="line">       &#125;</span><br><span class="line">       <span class="built_in">console</span>.log(userid+<span class="string">"文件读取完毕!"</span>);</span><br><span class="line">       res.end(data);</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><p>利用读取文件，验证事件环，即NodeJS的单进程异步非阻塞事件驱动模型。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">var</span> userid = <span class="built_in">parseInt</span>(<span class="built_in">Math</span>.random() * <span class="number">10000</span>);</span><br><span class="line">    <span class="built_in">console</span>.log(userid);</span><br><span class="line">    res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF8"</span>&#125;);</span><br><span class="line">    fs.readFile(<span class="string">"./demo.txt"</span>,&#123;<span class="string">"charset"</span>:<span class="string">"utf-8"</span>&#125;,<span class="function"><span class="keyword">function</span> (<span class="params">err,data</span>) </span>&#123; </span><br><span class="line">        <span class="built_in">console</span>.log(userid+<span class="string">"文件读取完毕!"</span>);</span><br><span class="line">        res.end(data);</span><br><span class="line">     &#125;);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><p>通过访问 <a href="http://127.0.0.1:3000" target="_blank" rel="noopener">http://127.0.0.1:3000</a></p><p>我们可以看到如下</p><p>5435<br>5435文件读取完毕!</p><p>现在我们模拟1000并发</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">from</span> threading <span class="keyword">import</span> Thread</span><br><span class="line">url = <span class="string">"http://127.0.0.1:3000"</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">req</span><span class="params">()</span>:</span></span><br><span class="line">    response = requests.get(url)</span><br><span class="line">    print(response.status_code)</span><br><span class="line">l = []</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">10000</span>):</span><br><span class="line">    t = Thread(target=req,)</span><br><span class="line">    t.start()</span><br><span class="line">    l.append(t)</span><br><span class="line">[ i.join() <span class="keyword">for</span> i <span class="keyword">in</span> l]</span><br><span class="line">print(<span class="string">"完成!"</span>)</span><br></pre></td></tr></table></figure><p>然后就可以看到</p><p>6182<br>9997<br>6182文件读取完毕!<br>9997文件读取完毕!<br>3450<br>3450文件读取完毕!</p><p>可以发现，NodeJS在处理当前用户的时候，还会切换到另外的事件调度。</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">   <span class="comment">//recursive 多级目录需要递归创建 </span></span><br><span class="line">fs.mkdir(<span class="string">"./ablum/niki"</span>,&#123; <span class="attr">recursive</span>: <span class="literal">true</span> &#125;,(err) =&gt;&#123;</span><br><span class="line">        <span class="keyword">if</span>(err) <span class="keyword">throw</span> err;</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure><h2 id="fs处理异步问题"><a href="#fs处理异步问题" class="headerlink" title="fs处理异步问题"></a>fs处理异步问题</h2><ol><li>由于异步性，下面的语句会在回调函数之前执行</li><li>所以console.log()已经把文件夹输出了，但事实上for循环并没有开始遍历</li><li>三层回调涉及到的方法<ol><li>http.createServer()创建一个服务器</li><li>fs.readdir() 读取目录下文件和文件夹</li><li>fs.stat() 读取文件或者文件夹的状态</li></ol></li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.url == <span class="string">"/favicon.ico"</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF8"</span>&#125;);</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 定义一个变量，用来存放目录</span></span><br><span class="line">    <span class="keyword">var</span> dirs = []</span><br><span class="line">    <span class="comment">// 读取./ablum下的所有文件,包括文件和文件夹</span></span><br><span class="line">    fs.readdir(<span class="string">"./ablum"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">err,files</span>) </span>&#123; </span><br><span class="line">        <span class="built_in">console</span>.log(files.length);</span><br><span class="line">        <span class="comment">// 便利这些文件和文件夹,找到其中是文件夹的,将其放入dirs</span></span><br><span class="line">        <span class="keyword">for</span>(<span class="keyword">var</span> i=<span class="number">0</span>;i&lt;files.length;i++)&#123;</span><br><span class="line">            <span class="keyword">var</span> path = <span class="string">"./ablum/"</span>+files[i];</span><br><span class="line">            fs.stat( path,<span class="function"><span class="keyword">function</span>(<span class="params">err,stats</span>)</span>&#123;</span><br><span class="line">                <span class="keyword">if</span>(stats.isDirectory())&#123;</span><br><span class="line">                    dirs.push(path);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 由于异步,上面的函数执行完了会立刻执行下面的函数,也就是说,上面还没开始遍历,下面已经执行了.所以这里的dirs是[]空的</span></span><br><span class="line">        <span class="built_in">console</span>.log(dirs);</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line">    res.end(<span class="string">"Success"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><p>解决办法：迭代器——循环强制同步</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> server = http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(req.url == <span class="string">"/favicon.ico"</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF8"</span>&#125;);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 定义一个变量，用来存放目录</span></span><br><span class="line">    <span class="keyword">var</span> dirs = []</span><br><span class="line">    <span class="comment">// 读取./ablum下的所有文件,包括文件和文件夹</span></span><br><span class="line">    fs.readdir(<span class="string">"./ablum"</span>,<span class="function"><span class="keyword">function</span> (<span class="params">err,files</span>) </span>&#123; </span><br><span class="line">        <span class="comment">//定义一个递归函数</span></span><br><span class="line">        <span class="function"><span class="keyword">function</span> <span class="title">iterator</span>(<span class="params">i</span>)</span>&#123;</span><br><span class="line">            <span class="comment">// 一旦下标到达数组长度,则返回</span></span><br><span class="line">            <span class="keyword">if</span>(i == files.length)&#123;</span><br><span class="line">                <span class="built_in">console</span>.log(dirs);</span><br><span class="line">                <span class="keyword">return</span> ;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">var</span> path = <span class="string">"./ablum/"</span>+files[i];</span><br><span class="line">            <span class="comment">// 判断是否为文件夹,如果是,则加入dirs</span></span><br><span class="line">            fs.stat(path,<span class="function"><span class="keyword">function</span> (<span class="params">err,stats</span>) </span>&#123; </span><br><span class="line">                <span class="keyword">if</span>(stats.isDirectory())&#123;</span><br><span class="line">                    dirs.push(path);</span><br><span class="line">                &#125;</span><br><span class="line">                iterator(i+<span class="number">1</span>);</span><br><span class="line">             &#125;);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// 强制当前下标迭代完再迭代下一个下标</span></span><br><span class="line">        iterator(<span class="number">0</span>);</span><br><span class="line">    &#125;);</span><br><span class="line">    res.end(<span class="string">"Success"</span>);</span><br><span class="line">&#125;);</span><br><span class="line">server.listen(<span class="number">3000</span>,<span class="string">"0.0.0.0"</span>);</span><br></pre></td></tr></table></figure><h1 id="静态目录"><a href="#静态目录" class="headerlink" title="静态目录"></a>静态目录</h1><ol><li>通过路径访问文件</li><li>浏览器的Content-type能读取文件正确的格式以便渲染</li><li>事先在同级目录下准备static文件，用于存放html、css、jpg等静态资源</li></ol><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> http = <span class="built_in">require</span>(<span class="string">"http"</span>);</span><br><span class="line"><span class="keyword">var</span> url = <span class="built_in">require</span>(<span class="string">"url"</span>);</span><br><span class="line"><span class="keyword">var</span> fs = <span class="built_in">require</span>(<span class="string">"fs"</span>);</span><br><span class="line"><span class="keyword">var</span> path = <span class="built_in">require</span>(<span class="string">"path"</span>);</span><br><span class="line"></span><br><span class="line">http.createServer(<span class="function"><span class="keyword">function</span>(<span class="params">req,res</span>)</span>&#123;</span><br><span class="line"><span class="comment">//得到用户的路径</span></span><br><span class="line"><span class="keyword">var</span> pathname = url.parse(req.url).pathname;</span><br><span class="line"><span class="comment">//默认首页</span></span><br><span class="line"><span class="keyword">if</span>(pathname == <span class="string">"/"</span>)&#123;</span><br><span class="line">pathname = <span class="string">"index.html"</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//拓展名</span></span><br><span class="line"><span class="keyword">var</span> extname = path.extname(pathname);</span><br><span class="line"></span><br><span class="line"><span class="comment">//真的读取这个文件</span></span><br><span class="line">fs.readFile(<span class="string">"./static/"</span> + pathname,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line"><span class="keyword">if</span>(err)&#123;</span><br><span class="line"><span class="comment">//如果此文件不存在，就应该用404返回</span></span><br><span class="line">fs.readFile(<span class="string">"./static/404.html"</span>,<span class="function"><span class="keyword">function</span>(<span class="params">err,data</span>)</span>&#123;</span><br><span class="line">res.writeHead(<span class="number">404</span>,&#123;<span class="string">"Content-type"</span>:<span class="string">"text/html;charset=UTF8"</span>&#125;);</span><br><span class="line">res.end(data);</span><br><span class="line">&#125;);</span><br><span class="line"><span class="keyword">return</span>;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//MIME类型，就是</span></span><br><span class="line"><span class="comment">//网页文件：  text/html</span></span><br><span class="line"><span class="comment">//jpg文件 :   image/jpg</span></span><br><span class="line"><span class="keyword">var</span> mime = getMime(extname);</span><br><span class="line">res.writeHead(<span class="number">200</span>,&#123;<span class="string">"Content-type"</span>:mime&#125;);</span><br><span class="line">res.end(data);</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">&#125;).listen(<span class="number">3000</span>,<span class="string">"127.0.0.1"</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getMime</span>(<span class="params">extname</span>)</span>&#123;</span><br><span class="line"><span class="keyword">switch</span>(extname)&#123;</span><br><span class="line"><span class="keyword">case</span> <span class="string">".html"</span> :</span><br><span class="line"><span class="keyword">return</span> <span class="string">"text/html"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">".jpg"</span> : </span><br><span class="line"><span class="keyword">return</span> <span class="string">"image/jpg"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line"><span class="keyword">case</span> <span class="string">".css"</span>:</span><br><span class="line"><span class="keyword">return</span> <span class="string">"text/css"</span>;</span><br><span class="line"><span class="keyword">break</span>;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Nodejs简介&quot;&gt;&lt;a href=&quot;#Nodejs简介&quot; class=&quot;headerlink&quot; title=&quot;Nodejs简介&quot;&gt;&lt;/a&gt;Nodejs简介&lt;/h1&gt;&lt;p&gt;​    V8引擎本身是用于Chrome浏览器的JS解释部分，但是Ryan Dahl将其搬到
      
    
    </summary>
    
    
      <category term="编程" scheme="http://ymlog.cn/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
  </entry>
  
  <entry>
    <title>VueJS 浅知</title>
    <link href="http://ymlog.cn/2020/04/26/VueJS/"/>
    <id>http://ymlog.cn/2020/04/26/VueJS/</id>
    <published>2020-04-26T05:43:51.000Z</published>
    <updated>2020-06-16T10:16:03.845Z</updated>
    
    <content type="html"><![CDATA[<p>Vue 是Javascript的框架，用于简化DOM（domain obeject m）操作，响应式数据驱动。</p><p>Vue两种导入方式：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 开发环境版本，包含了有帮助的命令行警告 --&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 生产环境版本，优化了尺寸和速度 --&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&quot;&gt;&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><h1 id="初试Vue"><a href="#初试Vue" class="headerlink" title="初试Vue"></a>初试Vue</h1><p>1、 Hello World</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line"></span><br><span class="line">&lt;head&gt;</span><br><span class="line">&lt;title&gt;Vue基础&lt;&#x2F;title&gt;</span><br><span class="line">&lt;&#x2F;head&gt;</span><br><span class="line"></span><br><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">        &#123;&#123; message &#125;&#125;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;!-- 开发环境版本，包含了有帮助的命令行警告 --&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var app &#x3D; new Vue(&#123;</span><br><span class="line">        el:&quot;#app&quot;,</span><br><span class="line">        data:&#123;</span><br><span class="line">            message:&quot; Hello Vue !&quot;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br><span class="line"></span><br><span class="line">&lt;&#x2F;html&gt;</span><br></pre></td></tr></table></figure><p>2、介绍</p><ul><li>el是用来设置Vue实例挂载的元素</li><li>Vue会管理el选项命中的元素机器内部的后代</li><li>可以使用其他选择器，但是建议使用ID选择器</li><li>可以使用其他的双标签，不能使用HTML和Body标签</li></ul><p>3、data：数据对象</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &#123;&#123; message &#125;&#125;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var app &#x3D; new Vue(&#123;</span><br><span class="line">    el:&quot;#app&quot;,</span><br><span class="line">    data:&#123;</span><br><span class="line">        message:&quot; Hello Vue !&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>4、字符、字典、数组的表示</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    字符：&#123;&#123; message &#125;&#125; &lt;br&gt;</span><br><span class="line">    字典：&#123;&#123; contact.phone &#125;&#125; &lt;br&gt;</span><br><span class="line">    数组：&#123;&#123; hobby[0] &#125;&#125; &lt;br&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">var app &#x3D; new Vue(&#123;</span><br><span class="line">    el:&quot;#app&quot;,</span><br><span class="line">    data:&#123;</span><br><span class="line">        message:&quot; Hello Vue !&quot;,</span><br><span class="line">        contact:&#123;</span><br><span class="line">            phone:&quot;18151908744&quot;,</span><br><span class="line">            email:&quot;2212585023@qq.com&quot;,</span><br><span class="line">        &#125;,</span><br><span class="line">        hobby:[&quot;Reading&quot;,&quot;Sleeping&quot;,&quot;JS&quot;,&quot;Watching&quot;],</span><br><span class="line">   &#125;,</span><br><span class="line"></span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h1 id="Vue指令"><a href="#Vue指令" class="headerlink" title="Vue指令"></a>Vue指令</h1><p>vue指令指的是以v-开头的一组特殊语法</p><ul><li><p>内容绑定，事件绑定</p><blockquote><p> v-text</p><p>v-html</p><p>v-on</p></blockquote></li><li><p>显示切换，属性绑定</p><blockquote><p>v-show</p><p>v-if</p><p>v-bind</p></blockquote></li><li><p>列表循环，表单元素绑定</p><blockquote><p>v-for</p><p>v-on补充</p><p>v-model</p></blockquote></li></ul><h2 id="内容绑定"><a href="#内容绑定" class="headerlink" title="内容绑定"></a>内容绑定</h2><h3 id="v-text"><a href="#v-text" class="headerlink" title="v-text"></a>v-text</h3><p>设置标签的文本值</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;h2 v-text&#x3D;&quot;message&quot;&gt;&lt;&#x2F;h2&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">var app &#x3D; new Vue(&#123;</span><br><span class="line">    el:&quot;#app&quot;,</span><br><span class="line">    data:&#123;</span><br><span class="line">        message:&quot;Hello Vue!&quot;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><h3 id="v-html"><a href="#v-html" class="headerlink" title="v-html"></a>v-html</h3><p>设置html标签</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;!-- 如果是普通文本，这里的显示结果和v-text没有任何不同</span><br><span class="line">    如果是HTML文本，则会渲染 --&gt;</span><br><span class="line">    &lt;div v-html&#x3D;&quot;message&quot;&gt;&lt;&#x2F;div&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">var app &#x3D; new Vue(&#123;</span><br><span class="line">   el:&quot;#app&quot;,</span><br><span class="line">   data:&#123;</span><br><span class="line">   message:&quot;&lt;a href&#x3D;&#39;http:&#x2F;&#x2F;www.baidu.com&#39;&gt;Hello Vue!&lt;&#x2F;a&gt;&quot;,</span><br><span class="line">   &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><ol><li>v-html指令的作用是：设置元素的innerHTML</li><li>内容中有HTML结构会被解析为标签</li><li>v-text指令无论内容是什么，只会解析成文本</li></ol><h3 id="v-on"><a href="#v-on" class="headerlink" title="v-on"></a>v-on</h3><ol><li>为元素绑定事件</li><li>事件名不需要写on</li><li>指令可以简写为@</li><li>绑定的方法定义在methods属性中</li></ol><p>基本结构</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">   &lt;div&gt;</span><br><span class="line">       &lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;事件绑定&quot; v-on:事件名&#x3D;&quot;方法&quot;&gt;</span><br><span class="line">   &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line">&lt;script&gt;</span><br><span class="line">var app &#x3D; new Vue(&#123;</span><br><span class="line">           el:&quot;#app&quot;,</span><br><span class="line">           methods:&#123;</span><br><span class="line">               方法名:function()&#123;</span><br><span class="line">                   &#x2F;&#x2F;逻辑</span><br><span class="line">               &#125;</span><br><span class="line">           &#125; </span><br><span class="line">       &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><p>v-on 可以直接替换为 @ </p><p>事件名有以下几种类型</p><ul><li>点击事件 click</li><li>鼠标移入 monseenter (这两个好像不太行)</li><li>双击dbclick</li></ul><p>示例：</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;事件绑定&quot; v-on:click&#x3D;&quot;doit&quot;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">var app &#x3D; new Vue(&#123;</span><br><span class="line">    el:&quot;#app&quot;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        doit:function()&#123;</span><br><span class="line">            alert(&quot;GGGGo!&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p>Vue中不考虑更改DOM元素，只需要更改数据，数据更改之后，DOM元素会同步更新。</p><p>this关键字，拿到定义的数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">    &lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;h2 type&#x3D;&quot;text&quot; v-text&#x3D;&quot;food&quot; @click&#x3D;changeFood&gt; &lt;&#x2F;h2&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var app &#x3D; new Vue(&#123;</span><br><span class="line">        el:&quot;#app&quot;,</span><br><span class="line">        data:&#123;</span><br><span class="line">            food:&quot;抹茶味冰淇淋&quot;</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            changeFood:function()&#123;</span><br><span class="line">                &#x2F;&#x2F; console.log(this.food);</span><br><span class="line">                this.food +&#x3D;&quot;卖完了！&quot;;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h2 id="1、计数器"><a href="#1、计数器" class="headerlink" title="1、计数器"></a>1、计数器</h2><ul><li><p>创建Vue示例时：el（挂载点）；data（数据），methods（方法）</p></li><li><p>v-on指令的作用就是绑定事件，简写为@</p></li><li><p>方法中通过this关键字获取data中的数据</p></li><li><p>v-text指令的作用是：设置元素的文本值，简写为</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;&#123; &#125;&#125;</span><br></pre></td></tr></table></figure></li></ul><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">&lt;body&gt;</span><br><span class="line">    &lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;-&quot; @click&#x3D;sub&gt;</span><br><span class="line">        &lt;span&gt;&#123;&#123; Nbr &#125;&#125;&lt;&#x2F;span&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;+&quot; @click&#x3D;add&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">    &lt;!-- 开发环境版本，包含了有帮助的命令行警告 --&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var app &#x3D; new Vue(&#123;</span><br><span class="line">        el:&quot;#app&quot;,</span><br><span class="line">        data:&#123;</span><br><span class="line">            Nbr:1,</span><br><span class="line">        &#125;,</span><br><span class="line">        methods: &#123;</span><br><span class="line">            add:function()&#123;</span><br><span class="line">                this.Nbr+&#x3D;1;</span><br><span class="line">            &#125;,</span><br><span class="line">            sub:function()&#123;</span><br><span class="line">                this.Nbr-&#x3D;1;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br><span class="line">&lt;&#x2F;script&gt;</span><br><span class="line">&lt;&#x2F;body&gt;</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2020/04/26/M1s8mWFTKIH9CDB.png" alt="image-20200424220438863" style="zoom:33%;" /><h2 id="显示切换"><a href="#显示切换" class="headerlink" title="显示切换"></a>显示切换</h2><h3 id="v-show"><a href="#v-show" class="headerlink" title="v-show"></a>v-show</h3><ol><li>根据表达式真假，切换元素的显示或隐藏。</li><li>原理是修改元素的display属性，实现显示隐藏</li><li>指令后面的内容，最后都会解析成布尔值</li><li>如果为true显示元素，如果为false则隐藏</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">        &lt;img src&#x3D;&quot;.&#x2F;img&#x2F;orange.jpg&quot; alt&#x3D;&quot;ORANGEIMG&quot; v-show&#x3D;&quot;isShow&quot; height&#x3D;&quot;400px&quot;&gt;</span><br><span class="line">        &lt;!-- 当年龄大于18岁的时候，图片才会显示 --&gt;</span><br><span class="line">        &lt;img src&#x3D;&quot;.&#x2F;img&#x2F;orange.jpg&quot; alt&#x3D;&quot;ORANGEIMG&quot; v-show&#x3D;&quot;age&gt;18&quot; height&#x3D;&quot;400px&quot;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var app &#x3D; new Vue(&#123;</span><br><span class="line">        el:&quot;#app&quot;,</span><br><span class="line">        data:&#123;</span><br><span class="line">            isShow:true,</span><br><span class="line">            age:15,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h3 id="v-if"><a href="#v-if" class="headerlink" title="v-if"></a>v-if</h3><ol><li>v-if指令的作用是：根据表达式的真假切换元素的显示状态</li><li>本质是通过操纵DOM元素来实现显示状态</li><li>表达式的值为true，元素存在于dom树中，为false，从dom树中移除。</li><li>频繁的切换v-show，反之使用v-if，前者切换消耗小</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> &lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">        &lt;img src&#x3D;&quot;.&#x2F;img&#x2F;orange.jpg&quot; alt&#x3D;&quot;ORANGEIMG&quot; v-if&#x3D;&quot;age&lt;11&quot; height&#x3D;&quot;400px&quot;&gt;</span><br><span class="line">    &lt;&#x2F;div&gt;</span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var app &#x3D; new Vue(&#123;</span><br><span class="line">        el:&quot;#app&quot;,</span><br><span class="line">        data:&#123;</span><br><span class="line">            isShow:true,</span><br><span class="line">            age:12,</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;)</span><br></pre></td></tr></table></figure><h3 id="v-bind"><a href="#v-bind" class="headerlink" title="v-bind"></a>v-bind</h3><ol><li>v-bind指令的作用是：为元素绑定属性</li><li>完整写法是：v-bind:属性名</li><li>简写的话可以直接省略v-bind，只保留：属性名</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- </span><br><span class="line">    1、记得想要操纵的属性前面一定要加冒号，比如:src , :class </span><br><span class="line">    2、functional中想要取变量需要加this</span><br><span class="line">    3、显示隐藏class的语法是:class&#x3D;&#123;className,isActive&#125;</span><br><span class="line">     --&gt;</span><br><span class="line"></span><br><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">        &lt;img v-bind:src&#x3D;&quot;imgSrc&quot; v-bind:alt&#x3D;&quot;imgAlt&quot; v-bind:title&#x3D;&quot;imgTitle&quot; height&#x3D;&quot;400px&quot; @click&#x3D;&quot;ToRed&quot; :class&#x3D;&quot;&#123;active:isActive&#125;&quot; &gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">    </span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">        var app &#x3D; new Vue(&#123;</span><br><span class="line">            el: &#39;#app&#39;,</span><br><span class="line">            data: &#123;</span><br><span class="line">                isActive: false,</span><br><span class="line">                imgSrc: &quot;&#x2F;img&#x2F;orange.jpg&quot;,</span><br><span class="line">                imgAlt: &#39;vue-logo&#39;,</span><br><span class="line">                imgTitle: &#39;这是你指定的title&#39;</span><br><span class="line">            &#125;,</span><br><span class="line">            methods: &#123;</span><br><span class="line">                ToRed:function()&#123;</span><br><span class="line">                    this.isActive&#x3D;!this.isActive;   </span><br><span class="line">                &#125;</span><br><span class="line">            &#125;,</span><br><span class="line">        &#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2020/04/26/bEMpBuDc4Szkv29.png" alt="image-20200425202402366" style="zoom:33%;" /><h2 id="2、图片切换"><a href="#2、图片切换" class="headerlink" title="2、图片切换"></a>2、图片切换</h2><ol><li>图片列表使用数组保存</li><li>v-bind指令可以设置元素的属性</li><li>v-show和v-if都可以设置元素的显示状态，频繁切换使用v-show</li></ol><p><img src="https://i.loli.net/2020/04/26/SotjdsGHMUaWhrz.png" alt="image-20200425203317172"></p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">        &lt;a href&#x3D;&quot;javascript:void(0)&quot; @click&#x3D;&quot;prev&quot; v-show&#x3D;&quot;index!&#x3D;0&quot;&gt;上一张&lt;&#x2F;a&gt;</span><br><span class="line">        &lt;img :src&#x3D;&quot;arrayImg[index]&quot; alt&#x3D;&quot;凉了&quot; height&#x3D;&quot;360px&quot; style&#x3D;&quot;align-items: center;&quot;&gt;</span><br><span class="line">        &lt;a href&#x3D;&quot;javascript:void(0)&quot; @click&#x3D;&quot;next&quot; v-show&#x3D;&quot;index&lt;arrayImg.length-1&quot;&gt;下一张&lt;&#x2F;a&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br><span class="line">    </span><br><span class="line">&lt;script src&#x3D;&quot;https:&#x2F;&#x2F;cdn.jsdelivr.net&#x2F;npm&#x2F;vue&#x2F;dist&#x2F;vue.js&quot;&gt;&lt;&#x2F;script&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">    var app &#x3D; new Vue(&#123;</span><br><span class="line">        el: &#39;#app&#39;,</span><br><span class="line">        data: &#123;</span><br><span class="line">        arrayImg:[</span><br><span class="line">            &quot;.&#x2F;img&#x2F;1.jpg&quot;,</span><br><span class="line">            &quot;.&#x2F;img&#x2F;2.jpg&quot;,</span><br><span class="line">            &quot;.&#x2F;img&#x2F;4.jpg&quot;,</span><br><span class="line">            &quot;.&#x2F;img&#x2F;5.jpg&quot;,</span><br><span class="line">       ],</span><br><span class="line">        index:0,</span><br><span class="line">      &#125;,</span><br><span class="line">      methods: &#123;</span><br><span class="line">           prev:function()&#123;</span><br><span class="line">               this.index--;   </span><br><span class="line">           &#125;,</span><br><span class="line">          next:function()&#123;</span><br><span class="line">                this.index++;</span><br><span class="line">          &#125;,</span><br><span class="line">      &#125;,</span><br><span class="line">&#125;);</span><br><span class="line">&lt;&#x2F;script&gt;</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2020/04/26/3mlBWwS2jeYLO7D.png" alt="image-20200425204825246" style="zoom:67%;" /><h2 id="列表循环"><a href="#列表循环" class="headerlink" title="列表循环"></a>列表循环</h2><h3 id="v-for"><a href="#v-for" class="headerlink" title="v-for"></a>v-for</h3><ol><li>根据数据生成列表结构</li><li>数组经常和v-for结合使用</li><li>语法是（item，index） in 数据</li><li>item 和 index 可以结合其他指令一起使用</li><li>数组长度的更新会同步到页面上，是响应式的</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;ul&gt;</span><br><span class="line">&lt;li v-for&#x3D;&quot;(item,index) in arr&quot; :title&#x3D;&quot;item&quot;&gt;</span><br><span class="line">&#123;&#123; index &#125;&#125; . &#123;&#123; item &#125;&#125;</span><br><span class="line">&lt;&#x2F;li&gt;</span><br><span class="line">&lt;&#x2F;ul&gt;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el: <span class="string">'#app'</span>,</span><br><span class="line">    data:&#123;</span><br><span class="line">        arr:[<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>],</span><br><span class="line">        dict:&#123;</span><br><span class="line">                name:<span class="string">"ZEN"</span>,</span><br><span class="line">                school:<span class="string">"UJS"</span> </span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="v-on补充"><a href="#v-on补充" class="headerlink" title="v-on补充"></a>v-on补充</h3><ol><li>事件绑定的方法写成函数调用的形式，可以传入自定义参数</li><li>定义方法时需要定义形参来接受传入的实参</li><li>事件的后面跟上<code>.修饰符</code>可有对事件进行限制</li><li><code>.enter</code>可以限制出发的按键为回车</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 点击Button在控制台打印参数</span><br><span class="line">在输入栏敲回车alert字符 --&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;button&quot; value&#x3D;&quot;Button&quot; @click&#x3D;&quot;doit(18151908742,&#39;ZEN&#39;)&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; @keyup.enter&#x3D;&quot;sayHi&quot;&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">el: <span class="string">'#app'</span>,</span><br><span class="line">data:&#123;</span><br><span class="line">    arr:[<span class="string">'a'</span>,<span class="string">'b'</span>,<span class="string">'c'</span>,<span class="string">'d'</span>,<span class="string">'e'</span>],</span><br><span class="line">&#125;,</span><br><span class="line">methods: &#123;</span><br><span class="line">        doit:<span class="function"><span class="keyword">function</span>(<span class="params">p1,p2</span>)</span>&#123;</span><br><span class="line">            <span class="built_in">console</span>.log(p1,p2);</span><br><span class="line">        &#125;,</span><br><span class="line">        sayHi:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            alert(<span class="string">"Hi Vue!"</span>);</span><br><span class="line">        &#125;,</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h3 id="v-model"><a href="#v-model" class="headerlink" title="v-model"></a>v-model</h3><p>获取设置表单元素的值，双向绑定，修改任意一方，另外一个也会被修改</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- h2标签的值会随着输入框输入的而改变，由此可以得出，v-model的改变是双向的 --&gt;</span><br><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; v-model&#x3D;&quot;message&quot;&gt;</span><br><span class="line">    &lt;h2&gt;&#123;&#123; message &#125;&#125; &lt;&#x2F;h2&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">el: <span class="string">'#app'</span>,</span><br><span class="line">data:&#123;</span><br><span class="line">    message:<span class="string">"Vue"</span>,</span><br><span class="line">&#125;,</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><h2 id="3、记事本"><a href="#3、记事本" class="headerlink" title="3、记事本"></a>3、记事本</h2><ol><li>列表结构可以通过v-for生成</li><li>v-on结合事件修饰符可以对事件进行限制，比如.enter</li><li>v-on在绑定事件的时候可以传入自定义参数</li><li>通过v-model可以快速设置和获取表单元素的值</li><li>VUE是基于数据的开发方式，JS是基于DOM的开发方式</li></ol><p>新增、删除、统计、清空、隐藏</p><p>增加list条目</p><ol><li>v-mode把需要增加的信息双向绑定</li><li>添加键盘敲击事件响应，回车调用add方法</li><li>v-for遍历todo列表</li><li>push把元素添加到数组</li></ol><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;div id&#x3D;&quot;app&quot;&gt;</span><br><span class="line">    &lt;input type&#x3D;&quot;text&quot; v-model&#x3D;&quot;message&quot; @keyup.enter&#x3D;&quot;add&quot;&gt;</span><br><span class="line">    &lt;ul&gt;</span><br><span class="line">        &lt;li v-for&#x3D;&quot;(item,index) in todoList&quot;&gt;</span><br><span class="line">            &#123;&#123; index+1 &#125;&#125;.&#123;&#123; item &#125;&#125;</span><br><span class="line">        &lt;&#x2F;li&gt;</span><br><span class="line">    &lt;&#x2F;ul&gt;</span><br><span class="line">&lt;&#x2F;div&gt;</span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el:<span class="string">"#app"</span>,</span><br><span class="line">    data:&#123;</span><br><span class="line">        todoList:[<span class="string">'起床'</span>,<span class="string">'吃饭'</span>,<span class="string">'睡觉'</span>],</span><br><span class="line">        message:<span class="string">'写代码'</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        add:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">this</span>.todoList.push(<span class="keyword">this</span>.message);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line"></span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure><img src="https://i.loli.net/2020/04/26/PKOHCLvVtYqyelF.png" alt="image-20200426103003221" style="zoom:50%;" /><p>删除</p><ol><li>删除时传入下标</li><li>splice参数</li><li>v-for的即时响应</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"text"</span> <span class="attr">v-model</span>=<span class="string">"message"</span> @<span class="attr">keyup.enter</span>=<span class="string">"add"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item,index) in todoList"</span>&gt;</span></span><br><span class="line">            &#123;&#123; index+1 &#125;&#125;.&#123;&#123; item &#125;&#125;</span><br><span class="line">            <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"del(index)"</span>&gt;</span>x<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">del:<span class="function"><span class="keyword">function</span>(<span class="params">INDEX</span>)</span>&#123;</span><br><span class="line">    <span class="comment">//第一个参数是从哪删</span></span><br><span class="line">    <span class="comment">///第二个参数是删除几个元素</span></span><br><span class="line">    <span class="keyword">this</span>.todoList.splice(INDEX,<span class="number">1</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>统计</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">h3</span> <span class="attr">v-text</span>=<span class="string">"'当前待执行的事件有 '+todoList.length+' 个'"</span>&gt;</span><span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前待执行的事件有 &#123;&#123; todoList.length &#125;&#125; 个<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br></pre></td></tr></table></figure><p>清空</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span>&gt;</span>当前待执行的事件有 &#123;&#123; todoList.length &#125;&#125; 个<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"clear"</span>&gt;</span>Clear<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">clear:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">    <span class="keyword">this</span>.todoList=[];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>隐藏</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">    <span class="comment">&lt;!-- 数组为空的时候隐藏计数和Clear按钮 --&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">div</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">h3</span> <span class="attr">v-show</span>=<span class="string">"todoList.length!=0"</span>&gt;</span>当前待执行的事件有 &#123;&#123; todoList.length &#125;&#125; 个<span class="tag">&lt;/<span class="name">h3</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">button</span> @<span class="attr">click</span>=<span class="string">"clear"</span> <span class="attr">v-show</span>=<span class="string">"todoList.length!=0"</span>&gt;</span>Clear<span class="tag">&lt;/<span class="name">button</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><p>我就不写CSS</p><img src="https://i.loli.net/2020/04/26/c9atRywnBOrAu6N.png" alt="image-20200426105839079" style="zoom:50%;" /><h1 id="网络应用"><a href="#网络应用" class="headerlink" title="网络应用"></a>网络应用</h1><p>Vue结合网络数据开发应用</p><ol><li>axios必须先导入才可以使用</li><li>使用get或post方法可以发送对应的请求</li><li>then方法中的回调函数可以在请求成功或失败时触发</li><li>通过回调函数的形参可以获取响应内容，或错误信息</li></ol><h2 id="axios"><a href="#axios" class="headerlink" title="axios"></a>axios</h2><p>网络请求库</p><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;script src=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;<span class="xml"><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span></span><br><span class="line"></span><br><span class="line">axios.get(地址?key=value,key=value).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;&#125;)</span><br><span class="line">axios.post(地址,(key=value,key=value)).then(<span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;&#125;,<span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;&#125;)</span><br></pre></td></tr></table></figure><p>axios的两种请求</p><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 官网提供的axios在线地址 --&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span> <span class="attr">src</span>=<span class="string">"https://unpkg.com/axios/dist/axios.min.js"</span>&gt;</span><span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br><span class="line">    </span><br><span class="line">    <span class="tag">&lt;<span class="name">script</span>&gt;</span></span><br><span class="line">        /*</span><br><span class="line">            接口1：随机笑话</span><br><span class="line"><span class="actionscript">            请求地址：https:<span class="comment">//autumnfish.cn/api/joke/list</span></span></span><br><span class="line"><span class="vbscript">            请求方法：<span class="keyword">Get</span></span></span><br><span class="line">            请求参数：num（笑话条数，数字）</span><br><span class="line">            相应内容：随机笑话</span><br><span class="line">        */</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.querySelector(<span class="string">".get"</span>).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="vbscript">            axios.<span class="keyword">get</span>(<span class="string">"https://autumnfish.cn/api/joke/list?num=3"</span>).<span class="keyword">then</span>(<span class="keyword">function</span> (<span class="built_in">response</span>)&#123;</span></span><br><span class="line"><span class="vbscript">                console.<span class="built_in">log</span>(<span class="built_in">response</span>);</span></span><br><span class="line"><span class="actionscript">            &#125;,<span class="function"><span class="keyword">function</span><span class="params">(err)</span></span>&#123;</span></span><br><span class="line"><span class="vbscript">                console.<span class="built_in">log</span>(<span class="built_in">err</span>);</span></span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        /*</span><br><span class="line">            接口2：用户注册</span><br><span class="line"><span class="actionscript">            请求地址：https:<span class="comment">//autumnfish.cn/api/user/reg</span></span></span><br><span class="line">            请求方法：post</span><br><span class="line">            请求参数：username(用户名，字符串)</span><br><span class="line">            响应内容：注册成功或失败</span><br><span class="line">        */</span><br><span class="line"><span class="javascript">        <span class="built_in">document</span>.querySelector(<span class="string">".post"</span>).onclick = <span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span></span><br><span class="line"><span class="actionscript">            axios.post(<span class="string">"https://autumnfish.cn/api/user/reg"</span>,&#123;username:<span class="string">"ZEN"</span>&#125;).then(<span class="function"><span class="keyword">function</span><span class="params">(response)</span></span>&#123;</span></span><br><span class="line"><span class="vbscript">                console.<span class="built_in">log</span>(<span class="built_in">response</span>);</span></span><br><span class="line"><span class="actionscript">            &#125;,<span class="function"><span class="keyword">function</span><span class="params">(err)</span></span>&#123;</span></span><br><span class="line"><span class="vbscript">                console.<span class="built_in">log</span>(<span class="built_in">err</span>);</span></span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">        &#125;</span><br><span class="line">    <span class="tag">&lt;/<span class="name">script</span>&gt;</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/26/bcCtkLqJVaMUKnG.png" alt="image-20200426112053877"></p><p>vue+axios</p><ol><li>使用axios获取API返回的数据</li><li>this传递数据，交给界面显示</li><li>axios回调函数中的this已经改变，无法访问data中的数据，可以先定义一个变量把this保存起来</li></ol><figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">div</span> <span class="attr">id</span>=<span class="string">"app"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">input</span> <span class="attr">type</span>=<span class="string">"button"</span> <span class="attr">value</span>=<span class="string">"Get请求"</span> <span class="attr">class</span>=<span class="string">"get"</span> @<span class="attr">click</span>=<span class="string">"getJoke"</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ul</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">li</span> <span class="attr">v-for</span>=<span class="string">"(item,index) in joke"</span>&gt;</span></span><br><span class="line">            &#123;&#123;item&#125;&#125; <span class="tag">&lt;<span class="name">br</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">li</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">ul</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">div</span>&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">var</span> app = <span class="keyword">new</span> Vue(&#123;</span><br><span class="line">    el:<span class="string">"#app"</span>,</span><br><span class="line">    data:&#123;</span><br><span class="line">        joke:<span class="string">"一个笑话"</span>,</span><br><span class="line">    &#125;,</span><br><span class="line">    methods: &#123;</span><br><span class="line">        getJoke:<span class="function"><span class="keyword">function</span>(<span class="params"></span>)</span>&#123;</span><br><span class="line">            <span class="keyword">var</span> that = <span class="keyword">this</span> </span><br><span class="line">            axios.get(<span class="string">"https://autumnfish.cn/api/joke/list?num=3"</span>).then(</span><br><span class="line">                <span class="function"><span class="keyword">function</span>(<span class="params">response</span>)</span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(response.data);</span><br><span class="line">                    that.joke = response.datajokes;</span><br><span class="line">                &#125;,</span><br><span class="line">                <span class="function"><span class="keyword">function</span>(<span class="params">err</span>)</span>&#123;</span><br><span class="line">                    <span class="built_in">console</span>.log(err);</span><br><span class="line">                &#125;</span><br><span class="line">            )</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/26/ijwkU7topQcvsI2.png" alt="image-20200426124533624"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;Vue 是Javascript的框架，用于简化DOM（domain obeject m）操作，响应式数据驱动。&lt;/p&gt;
&lt;p&gt;Vue两种导入方式：&lt;/p&gt;
&lt;figure class=&quot;highlight plain&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutte
      
    
    </summary>
    
    
      <category term="编程" scheme="http://ymlog.cn/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
  </entry>
  
  <entry>
    <title>Redis</title>
    <link href="http://ymlog.cn/2020/04/01/Redis/"/>
    <id>http://ymlog.cn/2020/04/01/Redis/</id>
    <published>2020-04-01T07:03:22.000Z</published>
    <updated>2020-06-16T10:15:48.860Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Redis简介"><a href="#Redis简介" class="headerlink" title="Redis简介"></a>Redis简介</h1><h2 id="Redis特点"><a href="#Redis特点" class="headerlink" title="Redis特点"></a>Redis特点</h2><ul><li>K-V 数据库</li><li>支持丰富的数据类型：String、Hash、List、Set、Zset（5大基础类型）</li><li>和Memcache对比：数据都是存储在内存中的，但是Redis可以做持久化存储（数据可以存储在磁盘上）</li><li>工作模型：单线程 | IO多路复用 | 内存 </li><li>集群方案</li><li>速度快</li></ul><h2 id="Redis为什么快？"><a href="#Redis为什么快？" class="headerlink" title="Redis为什么快？"></a>Redis为什么快？</h2><ul><li>数据库存储在内存中</li><li>一般采用单线程IO多路复用<ul><li>单线程可以避免CPU竞争带来的开销（Redis属于CPU密集型，单独部署，避免和其他业务产生CPU竞争问题）</li><li>单线程数据结构等开销较小</li></ul></li></ul><h2 id="常用场景"><a href="#常用场景" class="headerlink" title="常用场景"></a>常用场景</h2><p>1、<strong>缓存</strong></p><p><img src="https://i.loli.net/2020/04/10/XZC6Hm2v4fSuGTy.png" alt="image-20200406090310175.png"></p><p>2、<strong>计数</strong>，许多应用都会使用Redis作为计数的基础工具，它可以实现快速计数、查询缓存的功能，同时数据可以异步落地到其他数据源。例如笔者所在团队 的视频播放数系统就是使用Redis作为视频播放数计数的基础组件，用户每 播放一次视频，相应的视频播放数就会自增1：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">long incrVideoCounter(long id) &#123; </span><br><span class="line">key = <span class="string">"video:playCount:"</span> + id; <span class="built_in">return</span> redis.incr(key);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>3、<strong>共享Session</strong></p><p><img src="https://i.loli.net/2020/04/10/VbijvhSEKU3xA6l.png" alt="image-20200406090504714.png"></p><p>4、<strong>限速</strong></p><p>很多应用出于安全的考虑，会在每次进行登录时，让用户输入手机验证码，从而确定是否是用户本人。但是为了短信接口不被频繁访问，会限制用 户每分钟获取验证码的频率</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">phoneNum = <span class="string">"138xxxxxxxx"</span>; key = <span class="string">"shortMsg:limit:"</span> + phoneNum;</span><br><span class="line">// SET key value EX 60 NX </span><br><span class="line">isExists = redis.set(key,1,<span class="string">"EX 60"</span>,<span class="string">"NX"</span>); </span><br><span class="line"><span class="keyword">if</span>(isExists != null || redis.incr(key) &lt;=5)&#123;</span><br><span class="line">// 通过</span><br><span class="line">&#125;<span class="keyword">else</span>&#123; </span><br><span class="line">// 限速</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="初入Redis"><a href="#初入Redis" class="headerlink" title="初入Redis"></a>初入Redis</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># yum -y install redis</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@server yum.repos.d]<span class="comment"># rpm -ql redis</span></span><br><span class="line">/etc/logrotate.d/redis<span class="comment"># 日志配置</span></span><br><span class="line">/etc/redis-sentinel.conf <span class="comment"># 哨兵配置</span></span><br><span class="line">/etc/redis.conf <span class="comment"># 主配置文件</span></span><br><span class="line">/usr/bin/redis-cli <span class="comment"># 客户端工具</span></span><br><span class="line">/usr/bin/redis-sentinel <span class="comment"># 哨兵配置工具</span></span><br><span class="line">/usr/bin/redis-server <span class="comment"># redis服务工具</span></span><br><span class="line">/usr/bin/redis-check-aof <span class="comment"># aof文件修复工具</span></span><br><span class="line">/usr/bin/redis-check-rdb <span class="comment"># rdb文件修复工具</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># Redis服务的启动</span></span><br><span class="line">redis-server</span><br><span class="line"></span><br><span class="line"><span class="comment"># 连接Redis服务</span></span><br><span class="line">redis-cli</span><br></pre></td></tr></table></figure><h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># cat /etc/redis.conf | grep -Ev '^$|^#'</span></span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1 <span class="comment"># 监听服务地址</span></span><br><span class="line">protected-mode yes </span><br><span class="line">port 6379 <span class="comment"># 端口</span></span><br><span class="line">tcp-backlog 511 <span class="comment"># tcp全连接数量</span></span><br><span class="line">timeout 0 <span class="comment"># 超时时间</span></span><br><span class="line">tcp-keepalive 300 <span class="comment"># tcp长连接数量</span></span><br><span class="line">daemonize no <span class="comment"># 是否在后台运行</span></span><br><span class="line">supervised no <span class="comment"># supervised管理是否打开</span></span><br><span class="line">pidfile /var/run/redis_6379.pid <span class="comment"># redis服务的pid文件位置</span></span><br><span class="line">loglevel notice <span class="comment"># 日志等级记录</span></span><br><span class="line">logfile /var/<span class="built_in">log</span>/redis/redis.log <span class="comment"># 日志存放位置</span></span><br><span class="line">databases 16 <span class="comment"># redis数据库实例的设置数量</span></span><br><span class="line">save 900 1 <span class="comment"># 出发rdb持久化存储的策略900s -&gt; 1条写入 ； </span></span><br><span class="line">save 300 10 <span class="comment"># 同上</span></span><br><span class="line">save 60 10000</span><br><span class="line">stop-writes-on-bgsave-error yes <span class="comment"># bgsave手动触发rdb持久化存储，命令失败停止写入</span></span><br><span class="line">rdbcompression yes  <span class="comment"># rdb文件压缩</span></span><br><span class="line">rdbchecksum yes <span class="comment"># rdb文件校验</span></span><br><span class="line">dbfilename dump.rdb <span class="comment"># rdb文件名称</span></span><br><span class="line">dir /var/lib/redis <span class="comment"># redis服务目录</span></span><br><span class="line">slave-serve-stale-data yes </span><br><span class="line">slave-read-only yes <span class="comment"># 当此结点作为slaver的时候，开启只读模式</span></span><br><span class="line"><span class="comment"># master-slaver之间的复制策略</span></span><br><span class="line">repl-diskless-sync no </span><br><span class="line">repl-diskless-sync-delay 5</span><br><span class="line">repl-disable-tcp-nodelay no</span><br><span class="line">slave-priority 100 <span class="comment"># slave优先级</span></span><br><span class="line">appendonly no <span class="comment"># 持久化aof存储</span></span><br><span class="line">appendfilename <span class="string">"appendonly.aof"</span> <span class="comment"># aof文件名称</span></span><br><span class="line">appendfsync everysec </span><br><span class="line">no-appendfsync-on-rewrite no</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br><span class="line">aof-load-truncated yes</span><br><span class="line">lua-time-limit 5000</span><br><span class="line">slowlog-log-slower-than 10000 <span class="comment"># 慢日志设定时间，单位微秒</span></span><br><span class="line">slowlog-max-len 128 <span class="comment"># 慢日志长度，当慢查询日志处于其最大长度时，将最早插入的命令移出</span></span><br><span class="line">latency-monitor-threshold 0</span><br><span class="line">notify-keyspace-events <span class="string">""</span></span><br><span class="line"><span class="comment"># 数据类型底层编码的策略：相同的数据类型，底层的数据结构编码方式可能不同</span></span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-entries 512</span><br><span class="line"><span class="built_in">hash</span>-max-ziplist-value 64</span><br><span class="line">list-max-ziplist-size -2</span><br><span class="line">list-compress-depth 0</span><br><span class="line"><span class="built_in">set</span>-max-intset-entries 512</span><br><span class="line">zset-max-ziplist-entries 128</span><br><span class="line">zset-max-ziplist-value 64</span><br><span class="line">hll-sparse-max-bytes 3000</span><br><span class="line">activerehashing yes</span><br><span class="line"><span class="comment"># 客户端输出缓冲区显示策略</span></span><br><span class="line">client-output-buffer-limit normal 0 0 0</span><br><span class="line">client-output-buffer-limit slave 256mb 64mb 60</span><br><span class="line">client-output-buffer-limit pubsub 32mb 8mb 60</span><br><span class="line">hz 10 <span class="comment"># 内存回收策略，定期删除过期任务每s运行次数</span></span><br><span class="line">aof-rewrite-incremental-fsync yes</span><br></pre></td></tr></table></figure><p>慢查询</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">slowlog get <span class="comment"># 获取慢查询日志</span></span><br><span class="line">slowlog len <span class="comment"># 获取慢查询日志长度</span></span><br><span class="line">slowlog reset <span class="comment"># 重置慢查询日志</span></span><br></pre></td></tr></table></figure><p>Redis小工具</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -r 100 -i 1 info | grep used_memory_human</span><br><span class="line"><span class="comment"># -r repeat</span></span><br><span class="line"><span class="comment"># -i interval</span></span><br><span class="line"><span class="comment"># -a auth</span></span><br><span class="line"><span class="comment"># -c Cluster</span></span><br><span class="line"><span class="comment"># -x 从标准输入(stdin)读取数据</span></span><br><span class="line"><span class="comment"># --slave 把客户端模拟成当前Redis节点的从节点</span></span><br><span class="line"><span class="comment"># --latency 测试客户端到目标Redis的延迟</span></span><br><span class="line"><span class="comment"># --stat 实时获取Redis统计信息</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis-server</span><br><span class="line"><span class="comment"># --test-memory 1024 检测操作系统能否稳定分配1G内存给Reids</span></span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">redis-benchmark 基准性能测试</span><br><span class="line"><span class="comment"># -c clients 客户端并发数，默认50</span></span><br><span class="line"><span class="comment"># -n&lt;requests&gt; 客户端请求总量，默认100000</span></span><br><span class="line"><span class="comment"># -p pipeline 每个请求的pipeline数量，默认为1</span></span><br><span class="line"><span class="comment"># -k&lt;boolean&gt; 是否启用keepalive，1为使用</span></span><br><span class="line"><span class="comment"># -t&lt;get,set&gt; 使用指定命令进行基准测试</span></span><br><span class="line"><span class="comment"># --csv 结果以csv格式输出</span></span><br><span class="line"></span><br><span class="line">[root@hw ~]<span class="comment"># redis-benchmark -c 100 -n 2000</span></span><br><span class="line">.........</span><br><span class="line">24.50% &lt;= 1 milliseconds</span><br><span class="line">60.05% &lt;= 2 milliseconds</span><br><span class="line">66.15% &lt;= 3 milliseconds</span><br><span class="line">76.60% &lt;= 4 milliseconds</span><br><span class="line">87.05% &lt;= 5 milliseconds</span><br><span class="line">93.60% &lt;= 6 milliseconds</span><br><span class="line">95.90% &lt;= 7 milliseconds</span><br><span class="line">97.70% &lt;= 8 milliseconds</span><br><span class="line">98.65% &lt;= 13 milliseconds</span><br><span class="line">99.65% &lt;= 14 milliseconds</span><br><span class="line">100.00% &lt;= 14 milliseconds</span><br><span class="line">29850.75 requests per second</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 监视Redis正在执行的命令，可能会占用大量的内存</span></span><br><span class="line">127.0.0.1:6379&gt; monitor</span><br><span class="line">OK</span><br><span class="line">1586155547.048775 [0 121.36.70.55:34886] <span class="string">"auth"</span> <span class="string">"abc"</span></span><br><span class="line">1586155555.897676 [0 121.36.70.55:34886] <span class="string">"keys"</span> <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 客户端统计片段</span></span><br><span class="line">121.36.70.55:6379&gt; info clients</span><br><span class="line">connected_clients:2</span><br><span class="line">client_longest_output_list:0 <span class="comment"># 客户端缓冲区可能会造成内存陡增，尤其是对于主节点；内存陡增还可能是存在大量写入；或者是客户端在执行monitor命令</span></span><br><span class="line">解决办法：1、<span class="built_in">kill</span>这个连接 2、禁止monitor命令 3、限制输出缓冲区的大小</span><br><span class="line">client_biggest_input_buf:0</span><br><span class="line">blocked_clients:0</span><br></pre></td></tr></table></figure><h1 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h1><p><a href="http://redisdoc.com/index.html" target="_blank" rel="noopener">http://redisdoc.com/index.html</a></p><h2 id="String"><a href="#String" class="headerlink" title="String"></a>String</h2><p>1、设置获取键值</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">SET key value [EX seconds] [PX milliseconds] [NX|XX]</span><br></pre></td></tr></table></figure><ul><li><p>EX seconds ： 将键的过期时间设置为 seconds 秒。</p></li><li><p>PX milliseconds ： 将键的过期时间设置为 milliseconds 毫秒。 </p></li><li><p>NX ： 只在键不存在时， 才对键进行设置操作。</p></li><li><p>XX ： 只在键已经存在时， 才对键进行设置操作。</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@server ~]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get k1</span><br><span class="line"><span class="string">"v1"</span></span><br><span class="line">127.0.0.1:6379&gt; </span><br><span class="line"></span><br><span class="line">ttl  获取键值的生存时间</span><br><span class="line">incr 为键值进行加操作</span><br><span class="line">incrby</span><br><span class="line">decr 为键值进行减操作</span><br><span class="line">decrby</span><br></pre></td></tr></table></figure><p>不想写了，都在这：</p><p><a href="http://redisdoc.com/index.html" target="_blank" rel="noopener">http://redisdoc.com/index.html</a></p><h2 id="list"><a href="#list" class="headerlink" title="list"></a>list</h2><p>lpush</p><p>rpush</p><p>lpop</p><p>rpop</p><p>lrange</p><p>lset</p><p>lindex</p><h2 id="Hash"><a href="#Hash" class="headerlink" title="Hash"></a>Hash</h2><h2 id="Set"><a href="#Set" class="headerlink" title="Set"></a>Set</h2><p>sadd </p><p>scard</p><p>sdiff</p><p>sinter</p><p>sunion</p><p>smembers</p><p>spop</p><p>scre</p><h2 id="zset"><a href="#zset" class="headerlink" title="zset"></a>zset</h2><p>zadd</p><p>zcard</p><p>zcount</p><p>zrange</p><h2 id="键"><a href="#键" class="headerlink" title="键"></a>键</h2><table><thead><tr><th>操作</th><th>含义</th></tr></thead><tbody><tr><td>rename key newkey</td><td>重命名key</td></tr><tr><td>renamenx key newkey</td><td>确保只有newKey不存在时候才被覆盖</td></tr><tr><td>randomkey</td><td>随机返回一个键</td></tr><tr><td>expire key seconds</td><td>键在seconds秒后过期</td></tr><tr><td>ttl key</td><td>观察它的过期剩余时间（单位：秒）</td></tr><tr><td>pexpire key milliseconds</td><td>键在milliseconds毫秒后过期</td></tr><tr><td>persist key</td><td>将键的过期时间清除</td></tr><tr><td>keys pattern</td><td>获取所有的键(key *)</td></tr><tr><td>scan cursor [match pattern] [count number]</td><td>扫描字典键，对其他数据类型，则是hscan、sscan、zscan。渐进式地遍历</td></tr></tbody></table><p>键迁移</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">dump key restore key ttl value</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/04/10/9BR5TZ7LMKqthEu.png" alt="image-20200406092031687.png"></p><h2 id="数据库管理"><a href="#数据库管理" class="headerlink" title="数据库管理"></a>数据库管理</h2><table><thead><tr><th>命令</th><th>含义</th></tr></thead><tbody><tr><td>select dbIndex</td><td>切换数据库</td></tr><tr><td>databases 16</td><td></td></tr><tr><td>flushdb</td><td>只清除当前数据库</td></tr><tr><td>flushall</td><td>清除所有数据库</td></tr><tr><td>auth “youpassword”</td><td>输入redis密码，即配置文件中requirepass</td></tr><tr><td></td><td></td></tr><tr><td></td><td></td></tr></tbody></table><p><img src="https://i.loli.net/2020/04/10/VCEAbMqFojQu5JZ.png" alt="image-20200406093745003.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; <span class="built_in">set</span> hello world OK</span><br><span class="line">127.0.0.1:6379&gt; get hello <span class="string">"world"</span> </span><br><span class="line">127.0.0.1:6379&gt; select 15</span><br><span class="line">OK 127.0.0.1:6379[15]&gt; get hello</span><br><span class="line">(nil)</span><br></pre></td></tr></table></figure><h1 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h1><ul><li>RDB持久化存储</li><li>AOF持久化存储</li></ul><h2 id="RDB"><a href="#RDB" class="headerlink" title="RDB"></a>RDB</h2><p>RDB持久化存储：将内存中的数据存储快照写到磁盘中（快照方式）</p><p>优点：</p><ol><li>应用场景：做全量备份；快照代表的一个时间的数据集状态</li><li>RDB文件：a. 二进制文件 b. 压缩机制；所以对于AOF文件来说，体积更小</li><li>生成RDB文件：redis主进程去fork()一个子进程去负责RDB文件生成工作，fork()这个操作肯定会有阻塞</li></ol><p>缺点：</p><ol><li>没办法做到实时持久化</li><li>RDB二进制格式随着Redis版本的得带，可能存在兼容性问题</li><li>周期性执行一次性备份操作，如果Redis在此期间down掉，会存在数据丢失</li><li>RDB压缩会消耗CPU资源</li></ol><p>触发方式：</p><ol><li>自动触发：主配置文件中的save字段</li><li>手动触发：bgsave</li></ol><p>config get dir可以查看RDB文件的备份路径，</p><p>服务启动时，热更新配置:</p><blockquote><p>config set dir /path </p><p>config set dbfilename value</p></blockquote><p>redis服务启动时，会去dir下读取dbfilename文件</p><p>停止RDB持久化：注释配置文件中的save关键字</p><p>RDB工作流程：</p><p><img src="https://i.loli.net/2020/04/10/XBoSTlAwpNzxYI8.png" alt="image-20200406164400714.png"></p><p><img src="https://i.loli.net/2020/04/10/4IsF2NRdwtTbau7.png" alt="Clip_20200410_151059.png"></p><ol><li>bgsave命令发送给主进程</li><li>redis父进程接收到bgsave命令之后，fork()创建一个子进程</li><li>当子进程完成之后，继续去响应客户端请求</li><li>子进程负责将内存中的数据打上快照并生成RDB文件存储在本地指定位置上</li><li>子进程完成工作后发信号通知父进程</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">获取最近一个fork操作的耗 时，单位为微秒</span><br><span class="line">info stats</span><br><span class="line">...</span><br><span class="line">latest_fork_usec:133</span><br><span class="line"></span><br><span class="line">执行lastsave命令可以获取最后一次生成RDB的时间</span><br></pre></td></tr></table></figure><p>Redis默认采用LZF算法对生成的RDB文件做压缩处理，压缩后的文件远远小于内存大小，默认开启</p><h2 id="AOF"><a href="#AOF" class="headerlink" title="AOF"></a>AOF</h2><p>Redis的持久化方式之一，RDB是通过保存数据库中的键值对来记录数据库的状态，而另一种持久化方式AOF则是通过保存Redis服务所执行的命令来记录数据库的状态</p><p>优点：</p><ol><li>AOF持久化的方法提供了多种同步频率，即使使用默认同步频率每秒同步一次，redis最多也就丢失一秒的数据</li><li>AOF文件使用Redis命令追加的形式来构造，因此，即使Redis只能向AOF文件写入命令的片段，使用redis-check-aof工具也很容易修正AOF文件</li><li>AOF文件可读性较强，这也为使用者提供了更灵活的处理方式。如果我们不小心错用了FLUSHALL命令，在重写还没进行时，我们可以手工将最后FLUSHALL命令去掉，然后再使用AOF文件来恢复数据</li></ol><p>缺点：</p><ol><li>对于具有相同数据的Redis，AOF文件通常会比RDB文件体积更大</li><li>虽然AOF提供了多种同步频率，默认情况下，每秒同步一次的频率也具有较高的性能。但是在Redis的负载较高时，RDB比AOF具有更好的性能保证</li><li>RDB使用快照的形式来持久化整个Redis数据，而AOF只是将每次执行的命令追加到AOF文件中，因此从理论上来说RDB比AOF方式更健壮，官方文档也指出，AOF的确存在一些BUG。</li></ol><p>开启AOF</p><ul><li>将redis.conf的appendonly改为yes</li><li>客户端内：config set appendonly yes，查看是否开启 config get appendonly</li><li>手动备份：bgrewriteaof</li></ul><p>AOF工作流程</p><p><img src="https://i.loli.net/2020/04/10/Oc6PBKsegD4IhAF.png" alt="20200316211130205.png"></p><ol><li>用户操作命令追加写入到AOF Buf</li><li>AOF缓冲区会将操作命令根据指定的同步策略写入到AOF文件中</li><li>进行重写操作（新的AOF文件替换就的AOF文件）</li><li>服务启动时，可以去加载AOF文件达到的数据恢复的状态</li></ol><p>AOF同步策略：调用两个系统接口：write &amp; fsync</p><ul><li>always：保证文件存储到磁盘中才返回（write -&gt; buf -&gt; fsync -&gt; disk) 可靠性高阻塞长</li><li>no ：只能保证文件存储到缓冲区（write -&gt; buf ；直接返回）缓冲区中的数据同步到磁盘上是由系统调度机制去完成的）阻塞相对较短，但是可靠性不高</li><li>everysec：调用write操作将内存中的数据写入到缓冲区中，然后后天会有一个专门的fsync线程每s执行一次将缓冲区的内容写入到磁盘中。相对于always和no来说，可靠性和效率都有所保证。</li></ul><p>write操作：会触发延迟写机制，因为Linux在内核提供页缓冲区来提供磁盘IO性能，write操作在写入系统缓冲区后直接返回，同步到硬盘依赖于系统的调度机制。</p><p>fsync操作：针对单个文件操作，做强制硬盘同步，fsync将阻塞直到写入硬盘完成后返回，保证了数据的持久化。</p><p>AOF重写工作流程：</p><p><img src="https://i.loli.net/2020/04/10/y4x7TgiWBVadqpQ.png" alt="20200316211148929.png"></p><ol><li>执行bgrewriteaof操作交由redis父进程</li><li>父进程fork()创建一个子进程（完成AOF生成替换工作）</li><li>父进程继续响应用户请求操作<ol><li>写入到AOF_BUF中，追加到old aof文件中</li><li>写入到AOF_rewrite_buf</li></ol></li><li>子进程根据内存数据集完成AOF文件的工作</li><li>还需要将AOF_rewrite_buf中的数据追加生成到AOF文件中（从而保证子进程创建AOF文件时，父进程继续相应用户请求数据</li><li>新的AOF文件替换旧的AOF文件</li></ol><p>为什么要重写?</p><p>比如操作：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">set</span> k1 v1 </span><br><span class="line">del k1</span><br></pre></td></tr></table></figure><p>这个操作最后没有任何数据产生，是没有意义的，所以AOF不需要写入。</p><p>AOF和RDB文件同时存在的时候，优先加载AOF文件。</p><h1 id="主从复制"><a href="#主从复制" class="headerlink" title="主从复制"></a>主从复制</h1><p>缺点：</p><ol><li>如果master服务器出现问题，则不能提供服务，需要人工修改配置，将slave提升为master</li><li>主从复制，master服务器成为写操作瓶颈</li><li>单机节点存储能力有限</li></ol><h2 id="复制原理"><a href="#复制原理" class="headerlink" title="复制原理"></a>复制原理</h2><p>从节点复制主结点数据，从节点只能响应读操作。</p><ul><li>全量复制：将主结点的所有数据复制到本地</li><li>部分复制：主结点持续响应用户请求操作，然后同步到本地执行</li></ul><p><img src="https://i.loli.net/2020/04/10/BegVqnrPCiHXacU.png" alt="Clip_20200410_151307.png"></p><ol><li>从节点执行 slaveof 命令</li><li>从节点只是保存了 slaveof 命令中主节点的信息，并没有立即发起复制</li><li>从节点内部的定时任务发现有主节点的信息，开始使用 socket 连接主节点</li><li>连接建立成功后，发送 ping 命令，希望得到 pong 命令响应，否则会进行重连</li><li>如果主节点设置了权限，那么就需要进行权限验证；如果验证失败，复制终止。</li><li>权限验证通过后，进行数据同步，这是耗时最长的操作，主节点将把所有的数据全部发送给从节点。</li><li>当主节点把当前的数据同步给从节点后，便完成了复制的建立流程。接下来，主节点就会持续的把写命令发送给从节点，保证主从数据一致性。</li></ol><h2 id="全量复制"><a href="#全量复制" class="headerlink" title="全量复制"></a>全量复制</h2><p><img src="https://i.loli.net/2020/04/10/vexGapsdKLBjPyO.png" alt="1473308-20190627192702427-1600655856.png"></p><h2 id="部分复制"><a href="#部分复制" class="headerlink" title="部分复制"></a>部分复制</h2><p><img src="https://i.loli.net/2020/04/10/CaWTuUyAD3jQLN5.png" alt="1473308-20190627193858733-1483050713.png"></p><ul><li>优点：备份；读写分离</li><li>缺点：<ol><li>如果主结点down了，我们需要人工切换slave节点的新主节信息（slaveof）</li><li>单机存储容量受限（数据只会存储在master节点上），master节点读操作负载容易变高</li></ol></li></ul><h2 id="实验"><a href="#实验" class="headerlink" title="实验"></a>实验</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">mkdir /tmp/redis/&#123;data,conf,<span class="built_in">log</span>&#125; -pv</span><br><span class="line"><span class="comment"># 主服务器</span></span><br><span class="line">cat &lt;&lt; EOF &gt;/tmp/redis/conf/redis_6380.conf</span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">port 6380</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /tmp/redis/redis_6380.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /tmp/redis/<span class="built_in">log</span>/redis_6380.log</span><br><span class="line">dir /tmp/redis/data/</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt;/tmp/redis/conf/redis_6381.conf</span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">port 6381</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /tmp/redis/redis_6381.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /tmp/redis/<span class="built_in">log</span>/redis_6381.log</span><br><span class="line">dir /tmp/redis/data/</span><br><span class="line">slaveof 127.0.0.1 6380</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &lt;&lt; EOF &gt;/tmp/redis/conf/redis_6382.conf</span><br><span class="line"><span class="built_in">bind</span> 127.0.0.1</span><br><span class="line">port 6382</span><br><span class="line">daemonize yes</span><br><span class="line">pidfile /tmp/redis/redis_6382.pid</span><br><span class="line">loglevel notice</span><br><span class="line">logfile /tmp/redis/<span class="built_in">log</span>/redis_6382.log</span><br><span class="line">dir /tmp/redis/data/</span><br><span class="line">slaveof 127.0.0.1 6380</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">redis-server /tmp/redis/conf/redis_6380.conf</span><br><span class="line">redis-server /tmp/redis/conf/redis_6381.conf</span><br><span class="line">redis-server /tmp/redis/conf/redis_6382.conf</span><br></pre></td></tr></table></figure><p>测试</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># redis-cli -p 6380</span></span><br><span class="line">127.0.0.1:6380&gt; info Replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=127.0.0.1,port=6381,state=online,offset=99,lag=0</span><br><span class="line">slave1:ip=127.0.0.1,port=6382,state=online,offset=99,lag=0</span><br><span class="line">master_repl_offset:99</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:98</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入一定的值</span></span><br><span class="line">127.0.0.1:6380&gt; <span class="built_in">set</span> k1 v1 </span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6380&gt; get k1</span><br><span class="line"><span class="string">"v1"</span></span><br><span class="line">127.0.0.1:6380&gt; </span><br><span class="line">[root@node01 ~]<span class="comment"># redis-cli -p 6381</span></span><br><span class="line">127.0.0.1:6381&gt; keys *</span><br><span class="line">1) <span class="string">"k1"</span></span><br></pre></td></tr></table></figure><p>master日志分析</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">10974:M 05 Apr 15:08:11.474 * Starting BGSAVE <span class="keyword">for</span> SYNC with target: disk</span><br><span class="line"><span class="comment"># bgsave执行过程</span></span><br><span class="line">10974:M 05 Apr 15:08:11.474 * Background saving started by pid 10982</span><br><span class="line"><span class="comment"># master接收到来自slave2的全量复制请求</span></span><br><span class="line">10974:M 05 Apr 15:08:11.483 * Slave 127.0.0.1:6382 asks <span class="keyword">for</span> synchronization</span><br><span class="line">10974:M 05 Apr 15:08:11.483 * Full resync requested by slave 127.0.0.1:6382</span><br><span class="line">10974:M 05 Apr 15:08:11.483 * Waiting <span class="keyword">for</span> end of BGSAVE <span class="keyword">for</span> SYNC</span><br><span class="line">10982:C 05 Apr 15:08:11.485 * DB saved on disk</span><br><span class="line">10982:C 05 Apr 15:08:11.485 * RDB: 0 MB of memory used by copy-on-write</span><br><span class="line"></span><br><span class="line">10974:M 05 Apr 15:08:11.567 * Background saving terminated with success</span><br><span class="line"><span class="comment"># 数据同步给slave1和2，增量复制</span></span><br><span class="line">10974:M 05 Apr 15:08:11.568 * Synchronization with slave 127.0.0.1:6381 succeeded</span><br><span class="line">10974:M 05 Apr 15:08:11.568 * Synchronization with slave 127.0.0.1:6382 succeeded</span><br></pre></td></tr></table></figure><p>slaver日志分析</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 与master节点建立连接通信</span></span><br><span class="line">10978:S 05 Apr 15:08:11.473 * Connecting to MASTER 127.0.0.1:6380</span><br><span class="line"><span class="comment"># 全量复制同步开始前的准备阶段</span></span><br><span class="line">10978:S 05 Apr 15:08:11.473 * MASTER &lt;-&gt; SLAVE sync started</span><br><span class="line">10978:S 05 Apr 15:08:11.473 * Non blocking connect <span class="keyword">for</span> SYNC fired the event.</span><br><span class="line">10978:S 05 Apr 15:08:11.473 * Master replied to PING, replication can <span class="built_in">continue</span>...</span><br><span class="line">10978:S 05 Apr 15:08:11.474 * Partial resynchronization not possible (no cached master)</span><br><span class="line"><span class="comment"># 开始全量复制</span></span><br><span class="line">10978:S 05 Apr 15:08:11.474 * Full resync from master: 0ae1eafaf5a6804f35d3a3a5a5934a0f62d4f390:1</span><br><span class="line">10978:S 05 Apr 15:08:11.568 * MASTER &lt;-&gt; SLAVE sync: receiving 77 bytes from master</span><br><span class="line">10978:S 05 Apr 15:08:11.568 * MASTER &lt;-&gt; SLAVE sync: Flushing old data</span><br><span class="line">10978:S 05 Apr 15:08:11.568 * MASTER &lt;-&gt; SLAVE sync: Loading DB <span class="keyword">in</span> memory</span><br><span class="line">10978:S 05 Apr 15:08:11.568 * MASTER &lt;-&gt; SLAVE sync: Finished with success</span><br></pre></td></tr></table></figure><h1 id="哨兵架构"><a href="#哨兵架构" class="headerlink" title="哨兵架构"></a>哨兵架构</h1><p>Sentinel Mode</p><ul><li>优点：备份 ； 读写分离 ； 可以自动切换主节点</li><li>缺点：<ol><li>单机存储容量受限</li><li>主结点写负载会很高</li><li>扩展性较差</li></ol></li></ul><p>哨兵原理：</p><ol><li>每个哨兵会向其他哨兵、主服务器、从服务器定时发送消息，以确认对方是否活着。</li><li>当主节点挂掉的时候，某个哨兵1通过检测机制发现了这样一个情况，主观的认为这个主节点挂掉了（暂时还不能确认），会将这个信息发送给其他的哨兵，其他哨兵如果都赞同哨兵1的确认信息，则主观认为这个节点挂掉了（主结点真正的被分为挂掉了）。</li><li>发现master挂掉之后，从剩下的slave中重新选择新的master节点；每个哨兵都会监控slaver节点的状态信息，通过slave节点的状态信息进行投票选择，票数高的成为新的主结点，并且哨兵回去向其他节点告知新主节点的信息（IP_PORT) ，其他节点得到哨兵的通知消息后，自动执行slaveof去同步新的主节点信息。</li></ol><h2 id="哨兵实验"><a href="#哨兵实验" class="headerlink" title="哨兵实验"></a>哨兵实验</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#配置哨兵1，监听26378端口</span></span><br><span class="line">cat &lt;&lt; EOF &gt; /tmp/redis/conf/redis-sentinel-26378.conf</span><br><span class="line">port 26378</span><br><span class="line">daemonize yes</span><br><span class="line">dir <span class="string">'/tmp'</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6380 1</span><br><span class="line">sentinel down-after-milliseconds mymaster 6000</span><br><span class="line">sentinel failover-timeout mymaster 18000</span><br><span class="line">logfile <span class="string">"/tmp/redis/log/sentine1.log"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置哨兵2，监听26379端口</span></span><br><span class="line">cat &lt;&lt; EOF &gt; /tmp/redis/conf/redis-sentinel-26379.conf</span><br><span class="line">port 26379</span><br><span class="line">daemonize yes</span><br><span class="line">dir <span class="string">'/tmp'</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6380 1</span><br><span class="line">sentinel down-after-milliseconds mymaster 6000</span><br><span class="line">sentinel failover-timeout mymaster 18000</span><br><span class="line">logfile <span class="string">"/tmp/redis/log/sentine2.log"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置哨兵3，监听26380端口</span></span><br><span class="line">cat &lt;&lt; EOF &gt; /tmp/redis/conf/redis-sentinel-26380.conf</span><br><span class="line">port 26380</span><br><span class="line">daemonize yes</span><br><span class="line">dir <span class="string">'/tmp'</span></span><br><span class="line">sentinel monitor mymaster 127.0.0.1 6380 1</span><br><span class="line">sentinel down-after-milliseconds mymaster 6000</span><br><span class="line">sentinel failover-timeout mymaster 18000</span><br><span class="line">logfile <span class="string">"/tmp/redis/log/sentine3.log"</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment"># 启动哨兵</span></span><br><span class="line">redis-sentinel /tmp/redis/conf/redis-sentinel-26379.conf</span><br><span class="line">redis-sentinel /tmp/redis/conf/redis-sentinel-26378.conf</span><br><span class="line">redis-sentinel /tmp/redis/conf/redis-sentinel-26380.conf</span><br></pre></td></tr></table></figure><p>测试：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># redis-cli -p 26379</span></span><br><span class="line">127.0.0.1:26379&gt; sentinel master mymaster</span><br><span class="line"> 1) <span class="string">"name"</span></span><br><span class="line"> 2) <span class="string">"mymaster"</span></span><br><span class="line"> 3) <span class="string">"ip"</span></span><br><span class="line"> 4) <span class="string">"127.0.0.1"</span></span><br><span class="line"> 5) <span class="string">"port"</span></span><br><span class="line"> 6) <span class="string">"6380"</span></span><br><span class="line">....</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">sentinel master &lt;master-name&gt; ： 显示所有被监控主节点状态及统计信息</span><br><span class="line">sentinel slaves &lt;master-name&gt; ： 显示指定&lt;master-name&gt;的从节点状态及统计信息</span><br><span class="line">sentinel sentinels &lt;master-name&gt; ： 显示指定&lt;master-name&gt;的sentinel节点集合</span><br><span class="line">sentinel failover &lt;master-name&gt; ： 强制故障转移</span><br><span class="line">sentinel ckquorum &lt;master-name&gt; ： 检查当前可达Sentinel节点总数是否到&lt;quoro&gt;个数</span><br><span class="line">sentinel flushconfig ：将节点的配置强制刷到磁盘上</span><br><span class="line">sentinel remove &lt;master-name&gt; ： 取消当前Sentinel对指定&lt;master&gt;节点的监控</span><br><span class="line">sentinel <span class="built_in">set</span> &lt;master-name&gt;：动态修改Sentinel节点配置</span><br><span class="line">sentinel is-master-down-by-addr ：Sentinel节点之间用来交换对主节点是否下线的判断</span><br></pre></td></tr></table></figure><p>模拟master挂掉</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># ps -ef | grep redis</span></span><br><span class="line">root      10974      1  0 15:08 ?        00:00:08 redis-server 127.0.0.1:6380</span><br><span class="line">root      10978      1  0 15:08 ?        00:00:07 redis-server 127.0.0.1:6381</span><br><span class="line">root      10983      1  0 15:08 ?        00:00:08 redis-server 127.0.0.1:6382</span><br><span class="line">root      11060      1  0 17:10 ?        00:00:01 redis-sentinel *:26379 [sentinel]</span><br><span class="line">root      11064      1  0 17:10 ?        00:00:01 redis-sentinel *:26378 [sentinel]</span><br><span class="line">root      11068      1  0 17:10 ?        00:00:01 redis-sentinel *:26380 [sentinel]</span><br><span class="line">root      11123  10907  0 17:19 pts/0    00:00:00 grep --color=auto redis</span><br><span class="line">[root@node01 ~]<span class="comment"># kill -9 10974</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 分析哨兵日志</span></span><br><span class="line">[root@node01 ~]<span class="comment"># tailf /tmp/redis/log/sentine1.log </span></span><br><span class="line">11068:X 05 Apr 17:10:26.924 <span class="comment"># Sentinel ID is 58bdbb66f27e1e87dea74caed765090bdcef84f2</span></span><br><span class="line">11068:X 05 Apr 17:10:26.924 <span class="comment"># +monitor master mymaster 127.0.0.1 6380 quorum 1</span></span><br><span class="line">11068:X 05 Apr 17:10:26.925 * +slave slave 127.0.0.1:6381 127.0.0.1 6381 @ mymaster 127.0.0.1 6380</span><br><span class="line">11068:X 05 Apr 17:10:26.927 * +slave slave 127.0.0.1:6382 127.0.0.1 6382 @ mymaster 127.0.0.1 6380</span><br><span class="line">11068:X 05 Apr 17:10:28.906 * +sentinel sentinel 3756a9cd418f17b20e29b51a71a100c221a37379 127.0.0.1 26379 @ mymaster 127.0.0.1 6380</span><br><span class="line">11068:X 05 Apr 17:10:28.932 * +sentinel sentinel 125c85846d42c32b15f364db43afab85c4858888 127.0.0.1 26378 @ mymaster 127.0.0.1 6380</span><br><span class="line">11068:X 05 Apr 17:20:17.292 <span class="comment"># +new-epoch 1</span></span><br><span class="line">11068:X 05 Apr 17:20:17.294 <span class="comment"># +vote-for-leader 125c85846d42c32b15f364db43afab85c4858888 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 主观下线</span></span><br><span class="line">11068:X 05 Apr 17:20:17.371 <span class="comment"># +sdown master mymaster 127.0.0.1 6380</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 客观下线</span></span><br><span class="line">11068:X 05 Apr 17:20:17.371 <span class="comment"># +odown master mymaster 127.0.0.1 6380 #quorum 1/1</span></span><br><span class="line">11068:X 05 Apr 17:20:17.371 <span class="comment"># Next failover delay: I will not start a failover before Sun Apr  5 17:20:54 2020</span></span><br><span class="line">11068:X 05 Apr 17:20:18.415 <span class="comment"># +config-update-from sentinel 125c85846d42c32b15f364db43afab85c4858888 127.0.0.1 26378 @ mymaster 127.0.0.1 6380</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># master切换</span></span><br><span class="line">11068:X 05 Apr 17:20:18.415 <span class="comment"># +switch-master mymaster 127.0.0.1 6380 127.0.0.1 6381</span></span><br><span class="line">11068:X 05 Apr 17:20:18.416 * +slave slave 127.0.0.1:6382 127.0.0.1 6382 @ mymaster 127.0.0.1 6381</span><br><span class="line">11068:X 05 Apr 17:20:18.416 * +slave slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381</span><br><span class="line">11068:X 05 Apr 17:20:24.461 <span class="comment"># +sdown slave 127.0.0.1:6380 127.0.0.1 6380 @ mymaster 127.0.0.1 6381</span></span><br></pre></td></tr></table></figure><p>重新启动6380后，6380将变成6381的slave节点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># redis-server /tmp/redis/conf/redis_6380.conf</span></span><br><span class="line">127.0.0.1:6380&gt; info replication</span><br><span class="line"><span class="comment"># Replication</span></span><br><span class="line">role:slave</span><br><span class="line">master_host:127.0.0.1</span><br><span class="line">master_port:6381</span><br></pre></td></tr></table></figure><h1 id="集群架构"><a href="#集群架构" class="headerlink" title="集群架构"></a>集群架构</h1><p>是一种分布式解决方案</p><ul><li><p>优点 ：</p><ol><li>每个节点都可以存储数据，每个节点都可以响应读写操作</li><li>更容易扩容</li></ol></li><li><p>缺点：</p><ol><li>部署复杂</li><li>redis部分cli命令受限，比如批量操作等</li></ol><p>每个节点如何存储数据？（虚拟槽）</p></li></ul><ol><li>对象保存到Redis之前先经过CRC16哈希到一个Node上</li><li>每个Node被平均分配到一个Slot段，对应着0-16384，Slot不能重复也不能缺失，否则会导致对象重复存储或无法存储</li><li>Node之间相互监听，一旦有Node退出或者加入，会按照Slot为单位做数据迁移。例如Node1掉线了，0-5640这些Slot将会平均分摊到Node2和Node3上，由于Node2和Node3本身维护的Slot还会再自己身上不会被重新分配，所以执行过程中不会影响到5641-16384Slot段的使用。</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">计算CRC的过程，就是用一个特殊的“除法”，来得到余数，这个余数就是CRC。 它不是真正的算术上的除法！过程和算术除法过程一样，只是加减运算变成了XOR（异或）运算！</span><br></pre></td></tr></table></figure><h2 id="集群实验"><a href="#集群实验" class="headerlink" title="集群实验"></a>集群实验</h2><p>Redis5.0之后部署会简单一点</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">wget http://download.redis.io/releases/redis-5.0.8.tar.gz</span><br><span class="line">yum install -y wget gcc make tcl</span><br><span class="line">tar -xzf redis-5.0.8.tar.gz</span><br><span class="line"><span class="built_in">cd</span> redis-5.0.8/</span><br><span class="line">make <span class="comment"># 这里需要注意一下， 如果之前没有装gcc直接make，然后装了gcc再次make，会提示有个文件没有</span></span><br><span class="line"><span class="comment"># PATH=$PATH:/usr/local/redis/bin,如果安装的时候prefix指定了路径，可以修改环境变量</span></span><br><span class="line">mv redis-5.0.8/ redis</span><br><span class="line">mkdir -p /tmp/redis-cluster</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#=====================================================================</span></span><br><span class="line"><span class="comment">#搭建一个Redis集群</span></span><br><span class="line"><span class="comment">#=====================================================================</span></span><br><span class="line">mkdir /tmp/redis-cluster/redis&#123;7000..7005&#125; -pv</span><br><span class="line">touch /tmp/redis-cluster/redis&#123;7000..7005&#125;/redis.conf</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;7000..7005&#125;;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">cat &lt;&lt; EOF &gt; /tmp/redis-cluster/redis<span class="variable">$i</span>/redis.conf</span><br><span class="line">daemonize yes</span><br><span class="line">port <span class="variable">$i</span></span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file /tmp/redis-cluster/redis<span class="variable">$i</span>/nodes-<span class="variable">$i</span>.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">appendonly yes</span><br><span class="line">EOF</span><br><span class="line">/root/redis/src/redis-server /tmp/redis-cluster/redis<span class="variable">$i</span>/redis.conf</span><br><span class="line"><span class="keyword">done</span></span><br></pre></td></tr></table></figure><p>集群中有6个节点，设置3个master3个slaver</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># /root/redis/src/redis-cli --cluster create 127.0.0.1:7000 127.0.0.1:7001 127.0.0.1:7002 127.0.0.1:7003 127.0.0.1:7004 127.0.0.1:7005 --cluster-replicas 1</span></span><br><span class="line">&gt;&gt;&gt; Performing <span class="built_in">hash</span> slots allocation on 6 nodes...</span><br><span class="line"><span class="comment"># 分配Slot槽</span></span><br><span class="line">Master[0] -&gt; Slots 0 - 5460</span><br><span class="line">Master[1] -&gt; Slots 5461 - 10922</span><br><span class="line">Master[2] -&gt; Slots 10923 - 16383</span><br><span class="line">Adding replica 127.0.0.1:7004 to 127.0.0.1:7000</span><br><span class="line">Adding replica 127.0.0.1:7005 to 127.0.0.1:7001</span><br><span class="line">Adding replica 127.0.0.1:7003 to 127.0.0.1:7002</span><br><span class="line">&gt;&gt;&gt; Trying to optimize slaves allocation <span class="keyword">for</span> anti-affinity</span><br><span class="line">[WARNING] Some slaves are <span class="keyword">in</span> the same host as their master</span><br><span class="line">M: 2518beb0563857adb5c1497fffb4c5eb3d682103 127.0.0.1:7000</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">M: 1d39c766c5275ec08ae47f90b69d5e9c6c88eb8b 127.0.0.1:7001</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">M: 141382f53c59164a232329efcc9530daffc43a25 127.0.0.1:7002</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">S: 9269115a3ef21c7f378dcc68855a72059e943605 127.0.0.1:7003</span><br><span class="line">   replicates 2518beb0563857adb5c1497fffb4c5eb3d682103</span><br><span class="line">S: 6c33423da686f301f756dd624174bfd9f0487a67 127.0.0.1:7004</span><br><span class="line">   replicates 1d39c766c5275ec08ae47f90b69d5e9c6c88eb8b</span><br><span class="line">S: f8c74822b558a2e11ae36cf144b8a9388783bf95 127.0.0.1:7005</span><br><span class="line">   replicates 141382f53c59164a232329efcc9530daffc43a25</span><br><span class="line">Can I <span class="built_in">set</span> the above configuration? (<span class="built_in">type</span> <span class="string">'yes'</span> to accept): yes</span><br><span class="line">&gt;&gt;&gt; Nodes configuration updated</span><br><span class="line">&gt;&gt;&gt; Assign a different config epoch to each node</span><br><span class="line">&gt;&gt;&gt; Sending CLUSTER MEET messages to join the cluster</span><br><span class="line">Waiting <span class="keyword">for</span> the cluster to join</span><br><span class="line">...</span><br><span class="line">&gt;&gt;&gt; Performing Cluster Check (using node 127.0.0.1:7000)</span><br><span class="line">M: 2518beb0563857adb5c1497fffb4c5eb3d682103 127.0.0.1:7000</span><br><span class="line">   slots:[0-5460] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: 9269115a3ef21c7f378dcc68855a72059e943605 127.0.0.1:7003</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 2518beb0563857adb5c1497fffb4c5eb3d682103</span><br><span class="line">M: 1d39c766c5275ec08ae47f90b69d5e9c6c88eb8b 127.0.0.1:7001</span><br><span class="line">   slots:[5461-10922] (5462 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">S: f8c74822b558a2e11ae36cf144b8a9388783bf95 127.0.0.1:7005</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 141382f53c59164a232329efcc9530daffc43a25</span><br><span class="line">S: 6c33423da686f301f756dd624174bfd9f0487a67 127.0.0.1:7004</span><br><span class="line">   slots: (0 slots) slave</span><br><span class="line">   replicates 1d39c766c5275ec08ae47f90b69d5e9c6c88eb8b</span><br><span class="line">M: 141382f53c59164a232329efcc9530daffc43a25 127.0.0.1:7002</span><br><span class="line">   slots:[10923-16383] (5461 slots) master</span><br><span class="line">   1 additional replica(s)</span><br><span class="line">[OK] All nodes agree about slots configuration.</span><br><span class="line">&gt;&gt;&gt; Check <span class="keyword">for</span> open slots...</span><br><span class="line">&gt;&gt;&gt; Check slots coverage...</span><br><span class="line">[OK] All 16384 slots covered.</span><br></pre></td></tr></table></figure><p>验证1：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># ps -ef | grep redis</span></span><br><span class="line">root      12733      1  0 21:02 ?        00:00:00 /root/redis/src/redis-server *:7000 [cluster]</span><br><span class="line">root      12736      1  0 21:02 ?        00:00:00 /root/redis/src/redis-server *:7001 [cluster]</span><br><span class="line">root      12742      1  0 21:02 ?        00:00:00 /root/redis/src/redis-server *:7002 [cluster]</span><br><span class="line">root      12751      1  0 21:02 ?        00:00:00 /root/redis/src/redis-server *:7003 [cluster]</span><br><span class="line">root      12757      1  0 21:02 ?        00:00:00 /root/redis/src/redis-server *:7004 [cluster]</span><br><span class="line">root      12764      1  0 21:02 ?        00:00:00 /root/redis/src/redis-server *:7005 [cluster]</span><br></pre></td></tr></table></figure><p>验证2：登录集群查看信息</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># redis/src/redis-cli -c -p 7000</span></span><br><span class="line">127.0.0.1:7000&gt; info cluster</span><br><span class="line"><span class="comment"># Cluster</span></span><br><span class="line">cluster_enabled:1</span><br><span class="line">127.0.0.1:7000&gt; cluster info</span><br><span class="line">cluster_state:ok</span><br><span class="line">cluster_slots_assigned:16384</span><br><span class="line">cluster_slots_ok:16384</span><br><span class="line">cluster_slots_pfail:0</span><br><span class="line">cluster_slots_fail:0</span><br><span class="line">cluster_known_nodes:6</span><br><span class="line">cluster_size:3</span><br><span class="line">cluster_current_epoch:6</span><br><span class="line">cluster_my_epoch:1</span><br><span class="line">cluster_stats_messages_ping_sent:259</span><br><span class="line">cluster_stats_messages_pong_sent:267</span><br><span class="line">cluster_stats_messages_sent:526</span><br><span class="line">cluster_stats_messages_ping_received:262</span><br><span class="line">cluster_stats_messages_pong_received:259</span><br><span class="line">cluster_stats_messages_meet_received:5</span><br><span class="line">cluster_stats_messages_received:526</span><br><span class="line"></span><br><span class="line"><span class="comment"># slave节点后缀ID和Master的ID号对应</span></span><br><span class="line">2518beb0563857adb5c1497fffb4c5eb3d682103 127.0.0.1:7000@17000 myself,master - 0 1586092155000 1 connected 0-5460</span><br><span class="line">9269115a3ef21c7f378dcc68855a72059e943605 127.0.0.1:7003@17003 slave 2518beb0563857adb5c1497fffb4c5eb3d682103 0 1586092157502 4 connected</span><br><span class="line">1d39c766c5275ec08ae47f90b69d5e9c6c88eb8b 127.0.0.1:7001@17001 master - 0 1586092156896 2 connected 5461-10922</span><br><span class="line">f8c74822b558a2e11ae36cf144b8a9388783bf95 127.0.0.1:7005@17005 slave 141382f53c59164a232329efcc9530daffc43a25 0 1586092157502 6 connected</span><br><span class="line">6c33423da686f301f756dd624174bfd9f0487a67 127.0.0.1:7004@17004 slave 1d39c766c5275ec08ae47f90b69d5e9c6c88eb8b 0 1586092156391 5 connected</span><br><span class="line">141382f53c59164a232329efcc9530daffc43a25 127.0.0.1:7002@17002 master - 0 1586092157401 3 connected 10923-16383</span><br><span class="line"></span><br><span class="line"><span class="comment"># 写入值，重定向k1 v1 CRC16计算，--&gt; slot_12706，给7002号master</span></span><br><span class="line">127.0.0.1:7000&gt; <span class="built_in">set</span> k1 v1</span><br><span class="line">-&gt; Redirected to slot [12706] located at 127.0.0.1:7002</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Redis简介&quot;&gt;&lt;a href=&quot;#Redis简介&quot; class=&quot;headerlink&quot; title=&quot;Redis简介&quot;&gt;&lt;/a&gt;Redis简介&lt;/h1&gt;&lt;h2 id=&quot;Redis特点&quot;&gt;&lt;a href=&quot;#Redis特点&quot; class=&quot;headerlink
      
    
    </summary>
    
    
      <category term="数据库" scheme="http://ymlog.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
  </entry>
  
  <entry>
    <title>Django——Models</title>
    <link href="http://ymlog.cn/2020/03/28/Django(%E4%BA%8C)%E4%B9%8BModels/"/>
    <id>http://ymlog.cn/2020/03/28/Django(%E4%BA%8C)%E4%B9%8BModels/</id>
    <published>2020-03-28T06:42:14.000Z</published>
    <updated>2020-06-16T10:15:07.113Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://i.loli.net/2020/03/28/KCgP1Rbf6qei5Lp.png" alt="django(二) - Models.png"></p><h1 id="前期准备"><a href="#前期准备" class="headerlink" title="前期准备"></a>前期准备</h1><p>0、首先创建一个Django项目：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">django-admin startproject DoModel</span><br><span class="line">cd DoModel</span><br><span class="line">django-admin startapp App</span><br><span class="line"></span><br><span class="line">项目框架：</span><br><span class="line">-------------------------------</span><br><span class="line">G:\Django\django1.11\DoModel&gt;tree /F</span><br><span class="line">Folder PATH listing for volume tmp</span><br><span class="line">Volume serial number is 1030-3F09</span><br><span class="line">G:.</span><br><span class="line">│   manage.py</span><br><span class="line">│</span><br><span class="line">├───App# 我们主要写代码的地方</span><br><span class="line">│   │   admin.py</span><br><span class="line">│   │   apps.py</span><br><span class="line">│   │   models.py # 和数据库交互的地方</span><br><span class="line">│   │   tests.py</span><br><span class="line">│   │   views.py # 写业务逻辑的地方</span><br><span class="line">│   │   __init__.py</span><br><span class="line">│   │</span><br><span class="line">│   └───migrations</span><br><span class="line">│           __init__.py</span><br><span class="line">│</span><br><span class="line">└───DoModel</span><br><span class="line">        settings.py</span><br><span class="line">        urls.py</span><br><span class="line">        wsgi.py</span><br><span class="line">        __init__.py</span><br></pre></td></tr></table></figure><p>1、在<code>DoModel/DoModel/settings.py</code>中加入应用</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">MIDDLEWARE = [</span><br><span class="line"> <span class="string">'django.middleware.security.SecurityMiddleware'</span>,</span><br><span class="line"> <span class="string">'django.contrib.sessions.middleware.SessionMiddleware'</span>,</span><br><span class="line"> <span class="string">'django.middleware.common.CommonMiddleware'</span>,</span><br><span class="line"> <span class="string">'django.middleware.csrf.CsrfViewMiddleware'</span>,</span><br><span class="line"> <span class="string">'django.contrib.auth.middleware.AuthenticationMiddleware'</span>,</span><br><span class="line"> <span class="string">'django.contrib.messages.middleware.MessageMiddleware'</span>,</span><br><span class="line"> <span class="string">'django.middleware.clickjacking.XFrameOptionsMiddleware'</span>,</span><br><span class="line"> <span class="string">'App'</span>,</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>2、更改<code>DoModel/DoModel/settings.py</code>中的数据库为MySQL，下面会详细讲解如何更换数据库</p><p>3、在DoModel/urls.py中注册App的路由</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^app/'</span>,include(<span class="string">"App.urls"</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure><h1 id="更换数据库详解"><a href="#更换数据库详解" class="headerlink" title="更换数据库详解"></a>更换数据库详解</h1><p>在DoModel/setting.py*中修改DATABASES设置</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">DATABASES = &#123;</span><br><span class="line">    <span class="string">'default'</span>: &#123;</span><br><span class="line">        <span class="string">'ENGINE'</span>: <span class="string">'django.db.backends.mysql'</span>,</span><br><span class="line">        <span class="string">'NAME'</span>: <span class="string">'model3'</span>,</span><br><span class="line">        <span class="string">'USER'</span>: <span class="string">'niki'</span>,</span><br><span class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'123456'</span>,</span><br><span class="line">        <span class="string">'HOST'</span>: <span class="string">'121.36.70.55'</span>,</span><br><span class="line">        <span class="string">'PORT'</span>: <span class="string">'3306'</span>,</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>1、在MySQL上创建数据库model3, <code>create database model3;</code></p><p>2、添加数据库</p><img src="https://i.loli.net/2020/03/28/kFOEglnX6qjv752.png" alt="django(2) - 1" style="zoom:33%;" /><p>3、下载驱动</p><img src="https://i.loli.net/2020/03/28/ZNeuG9t8Xd6WSCJ.png" alt="django(2) - 1.1" style="zoom:33%;" /><p>4、 安装数据库驱动</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python -m pip install --upgrade pip -i https://pypi.tuna.tsinghua.edu.cn/simple </span><br><span class="line">pip install pymysql -i https://pypi.tuna.tsinghua.edu.cn/simple</span><br></pre></td></tr></table></figure><p>5、伪装驱动</p><p>因为Django是不认pymysql的，所以需要伪装成MySQL_db</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># HelloDjango/__init__.py</span></span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb()</span><br></pre></td></tr></table></figure><p>6、执行迁移</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><p>可以看到Student表迁移成功：</p><img src="https://i.loli.net/2020/03/28/bPALwCZhTeOV8j3.png" alt="django(2) - 1.2" style="zoom:33%;" /><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul><li>开发环境 Windows10</li><li>Python==3.5.2</li><li>django=1.11.7</li></ul><h2 id="MTV-MVC"><a href="#MTV-MVC" class="headerlink" title="MTV/MVC"></a>MTV/MVC</h2><p>MVC：（Model 、View、Controller）</p><ul><li><p>Model：用于封装与应用程序的业务逻辑相关的数据及对数据的处理方法，是web应用程序中用于处理应用程序的数据逻辑部分，Model通常只提供功能性的接口，通过这些接口可以获取Model的所有功能</p></li><li><p>View：负责数据的呈现，View对用户直接输出</p></li><li><p>Controller：负责从用户端收集用户输入，主要处理用户的交互</p></li></ul><p>MTV是从MVC演化而来，本质上和MVC一样，只是名字改了：</p><p>MTV：（Model、Template、View）</p><ul><li><p>Model：负责业务对象和数据库对象</p></li><li><p>View：负责业务逻辑，并在适当的时候调用Module 和 Template</p></li><li><p>Template：负责把页面展示给用户</p></li></ul><p>在Django中，还有url，主要用来将一个个URL页面请求分发给不同的view进行处理，View再调用相应的Model和Template。</p><p><img src="https://i.loli.net/2020/03/28/F9TZ12SaP6jlCYM.png" alt="django(二) - 3.png"></p><h2 id="ORM"><a href="#ORM" class="headerlink" title="ORM"></a>ORM</h2><p>ORM（Object Relation Mapping） 对象关系映射，就是把数据库也看作是一个对象，将数据库的属性映射到对象的属性和方法，目的是为了将业务逻辑和SQL语句进行解耦合：</p><ul><li>数据库的表（table） –&gt; 类（class）</li><li>记录（record，行数据）–&gt; 对象（object）</li><li>字段（field）–&gt; 对象的属性（attribute）</li></ul><p>ORM 使用对象，封装了数据库操作，因此可以不碰 SQL 语言。开发者只使用面向对象编程，与数据对象直接交互，不用关心底层数据库。</p><p>下面一段代码就是创建了两张表，Grade表的字段是g_grade、Student表的字段是s_name、s_password和s_grade。</p><p>可以看到，数据库的表对应了面向对象的类，且必须继承自models.Model这个类；字段则是对应了面向对象的属性。</p><p><em>/DoModel/App/models.py</em></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grade</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    g_grade = models.CharField(max_length=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    s_name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_password = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_grade = models.ForeignKey(Grade)</span><br></pre></td></tr></table></figure><p>连接数据库</p><p><img src="https://i.loli.net/2020/03/28/mQ3aNuTwKHdA5IJ.png" alt="django(二）- 3.5.png"></p><p>映射到库中：</p><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations # 生成迁移文件</span><br><span class="line">python manage.py migrate   # 执行迁移</span><br></pre></td></tr></table></figure><p>刷新数据库就可以看到App_Student和App_Grade两张表了。查看表的定义：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- auto-generated definition</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> App_student</span><br><span class="line">(</span><br><span class="line">  <span class="keyword">id</span>         <span class="built_in">int</span> auto_increment</span><br><span class="line">    primary <span class="keyword">key</span>,</span><br><span class="line">  s_name     <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  s_password <span class="built_in">varchar</span>(<span class="number">32</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  s_grade_id <span class="built_in">int</span>         <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">  <span class="keyword">constraint</span> App_student_s_grade_id_797e4cc7_fk_App_grade_id</span><br><span class="line">    <span class="keyword">foreign</span> <span class="keyword">key</span> (s_grade_id) <span class="keyword">references</span> App_grade (<span class="keyword">id</span>)</span><br><span class="line">);</span><br></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">-- auto-generated definition</span></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> App_grade</span><br><span class="line">(</span><br><span class="line">    <span class="keyword">id</span>      <span class="built_in">int</span> auto_increment</span><br><span class="line">    primary <span class="keyword">key</span>,</span><br><span class="line">  g_grade <span class="built_in">varchar</span>(<span class="number">16</span>) <span class="keyword">not</span> <span class="literal">null</span></span><br><span class="line">);</span><br></pre></td></tr></table></figure><h2 id="定义字段"><a href="#定义字段" class="headerlink" title="定义字段"></a>定义字段</h2><p>字段名不允许使用下划线，因为查询条件需要用到下划线</p><h3 id="字段类型"><a href="#字段类型" class="headerlink" title="字段类型"></a>字段类型</h3><table><thead><tr><th>字段类型</th><th>含义</th></tr></thead><tbody><tr><td>AutoField</td><td>一个根据实际ID自动增长的IntegerField，通常不指定如果不指定，一个主键字段将自动添加到模型中</td></tr><tr><td>CharField</td><td>字符串，默认的表单样式是 TextInput</td></tr><tr><td>TextField</td><td>大文本字段，一般超过4000使用，默认的表单控件是Textarea</td></tr><tr><td>IntegerField</td><td>整数</td></tr><tr><td>DecimalField</td><td>使用python的Decimal实例表示的十进制浮点数</td></tr><tr><td>FloatField</td><td>用Python的float实例来表示的浮点数</td></tr><tr><td>BooleanField</td><td>true/false 字段，此字段的默认表单控制是CheckboxInput，MySQL不支持Bool值，所以ORM会把布尔值转换为tinyint(1)类型</td></tr><tr><td>NullBooleanField</td><td>支持null、true、false三种值</td></tr><tr><td>DateField(auto_now=False, auto_now_add=False)</td><td>使用Python的datetime.date实例表示的日期</td></tr><tr><td>TimeField</td><td>使用Python的datetime.time实例表示的时间，参数同DateField</td></tr><tr><td>DateTimeField</td><td>使用Python的datetime.datetime实例表示的日期和时间，参数同DateField，示例：.o_time = modes.DataTimeField(auto_now_add=True)</td></tr><tr><td>FileField</td><td>一个上传文件的字段</td></tr><tr><td>ImageField</td><td>继承了FileField的所有属性和方法，但对上传的对象进行校验，确保它是个有效的image</td></tr></tbody></table><pre><code>DateField参数说明    DateField.auto_now每次保存对象时，自动设置该字段为当前时间，用于&quot;最后一次修改&quot;的时间戳，它总是使用当前日期，默认为false    DateField.auto_now_add    1、当对象第一次被创建时自动设置当前时间，用于创建的时间戳，它总是使用当前日期，默认为false    2、说明      该字段默认对应的表单控件是一个TextInput. 在管理员站点添加了一个JavaScript写的日历控件，和一个“Today&quot;的快捷按钮，包含了一个额外的invalid_date错误消息键    3、注意      auto_now_add, auto_now, and default 这些设置是相互排斥的，他们之间的任何组合将会发生错误的结果</code></pre><h3 id="字段约束"><a href="#字段约束" class="headerlink" title="字段约束"></a>字段约束</h3><table><thead><tr><th>字段约束</th><th>含义</th></tr></thead><tbody><tr><td>null</td><td>如果为True，Django 将空值以NULL 存储到数据库中，默认值是 False</td></tr><tr><td>blank</td><td>如果为True，则该字段允许为空白，默认值是 False，null是数据库范畴的概念，blank是表单验证证范畴的</td></tr><tr><td>db_column</td><td>字段的名称，如果未指定，则使用属性的名称</td></tr><tr><td>db_index</td><td>若值为 True, 则在表中会为此字段创建索引</td></tr><tr><td>default</td><td>默认值</td></tr><tr><td>primary_key</td><td>若为 True, 则该字段会成为模型的主键字段</td></tr><tr><td>unique</td><td>如果为 True, 这个字段在表中必须有唯一值</td></tr></tbody></table><p>示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="comment"># Create your models here.</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    <span class="comment"># max_length: 最大长度</span></span><br><span class="line">    <span class="comment"># unqiue: 唯一性</span></span><br><span class="line">    <span class="comment"># db_column: 自定义字段名，如果不定义，就直接使用s_name</span></span><br><span class="line">    s_name = models.CharField(max_length=<span class="number">16</span>,unique=<span class="literal">True</span>,db_column=<span class="string">'name'</span>)</span><br><span class="line">    s_age = models.IntegerField(default=<span class="number">18</span>,db_column=<span class="string">'age'</span>)</span><br><span class="line">    <span class="comment"># False表示男，True表示女</span></span><br><span class="line">    s_sex = models.BooleanField(default=<span class="literal">False</span>,db_column=<span class="string">'sex'</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment"># 自定义表名</span></span><br><span class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></span><br><span class="line">        db_table = <span class="string">'People'</span></span><br></pre></td></tr></table></figure><h2 id="属性"><a href="#属性" class="headerlink" title="属性"></a>属性</h2><p>显性属性（开发者手动声明的属性），隐性属性（没有声明，父类中也不存在，动态产生出来的；如果开发者主动声明这些属性，隐性属性自己就不再产生了）</p><h1 id="增删改查"><a href="#增删改查" class="headerlink" title="增删改查"></a>增删改查</h1><h2 id="增"><a href="#增" class="headerlink" title="增"></a>增</h2><p>事前准备：</p><p>1、在总的urls中注册App的urls</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^admin/'</span>, admin.site.urls),</span><br><span class="line">    url(<span class="string">r'^app/'</span>,include(<span class="string">"App.urls"</span>))</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>2、创建并且编写App的urls.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> url</span><br><span class="line"></span><br><span class="line"><span class="keyword">from</span> App <span class="keyword">import</span> views</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    url(<span class="string">r'^addStudent/'</span>, views.addStudent),</span><br><span class="line">]</span><br></pre></td></tr></table></figure><p>3、创建views中的函数，用于添加学生数据</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># Create your views here.</span><br><span class="line">def addStudent(request):</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    return HttpResponse(&quot;学生数据添加成功&quot;)</span><br></pre></td></tr></table></figure><p>4、手动创建几个Grade字段</p><p><img src="https://i.loli.net/2020/03/28/RH1NuUcz2hsofJa.png" alt="django(二)-4"></p><p>创建数据的几种方式</p><p>1、直接实例化对象设置属性</p><p>2、创建对象传入属性</p><p>3、使用Model.objects.create()</p><p>4、自己封装类方法创建</p><p>5、使用Manager()中封装方法创建</p><p>6、直接调用类方法添加数据</p><h3 id="1、直接实例化对象设置属性"><a href="#1、直接实例化对象设置属性" class="headerlink" title="1、直接实例化对象设置属性"></a>1、直接实例化对象设置属性</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student()</span><br><span class="line">    student.s_name = <span class="string">"Jack"</span></span><br><span class="line">    grade  = Grade.objects.get(pk=<span class="number">1</span>)</span><br><span class="line">    print(<span class="string">"What is The Grade Type:"</span>,type(grade))  <span class="comment"># &lt;class 'App.models.Grade'&gt;</span></span><br><span class="line">    student.s_grade = grade <span class="comment"># 因为Student和Grade进行了外键关联，这里需要传入的是一个Grade的示例，不然会报错</span></span><br><span class="line">    student.s_password = <span class="string">"123456789"</span></span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"学生数据添加成功1"</span>)</span><br></pre></td></tr></table></figure><p>之后在Student表中就会多出一行数据了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [model3]&gt; select * <span class="keyword">from</span> App_student;</span><br><span class="line">+----+--------+------------+------------+</span><br><span class="line">| id | s_name | s_password | s_grade_id |</span><br><span class="line">+----+--------+------------+------------+</span><br><span class="line">|  <span class="number">1</span> | Jack   | <span class="number">123456789</span>  |          <span class="number">1</span> |</span><br><span class="line">+----+--------+------------+------------+</span><br></pre></td></tr></table></figure><h3 id="2、创建对象传入属性"><a href="#2、创建对象传入属性" class="headerlink" title="2、创建对象传入属性"></a>2、创建对象传入属性</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    grade = Grade.objects.get(pk=<span class="number">3</span>)</span><br><span class="line">    student = Student(s_name=<span class="string">'Rose'</span>,s_password=<span class="string">'abcdefg'</span>,s_grade=grade)</span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"学生数据添加成功2"</span>)</span><br></pre></td></tr></table></figure><h3 id="3、使用Model-objects-create"><a href="#3、使用Model-objects-create" class="headerlink" title="3、使用Model.objects.create()"></a>3、使用Model.objects.create()</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    grade = Grade.objects.get(pk=<span class="number">2</span>)</span><br><span class="line">    student = Student.objects.create(s_name=<span class="string">'Niki'</span>,s_password=<span class="string">'987654321'</span>,s_grade=grade)</span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"学生数据添加成功3"</span>)</span><br></pre></td></tr></table></figure><h3 id="4、自己封装类方法创建"><a href="#4、自己封装类方法创建" class="headerlink" title="4、自己封装类方法创建"></a>4、自己封装类方法创建</h3><p>封装自己的类方法，可以添加默认值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    s_name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_password = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_grade = models.ForeignKey(Grade)</span><br><span class="line"></span><br><span class="line"><span class="meta">    @classmethod</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">create</span><span class="params">(cls,s_name,s_grade,s_password=<span class="string">'PASWD'</span>)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> cls(s_name=s_name,s_password=s_password,s_grade=s_grade)</span><br></pre></td></tr></table></figure><p>调用自己封装的类方法</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    grade = Grade.objects.get(pk=<span class="number">2</span>)</span><br><span class="line">    student = Student.objects.create(s_name=<span class="string">'Bool'</span>,s_password=<span class="string">'poiuytq'</span>,s_grade=grade)</span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"学生数据添加成功4"</span>)</span><br></pre></td></tr></table></figure><h3 id="5、使用Manager-中封装方法创建"><a href="#5、使用Manager-中封装方法创建" class="headerlink" title="5、使用Manager()中封装方法创建"></a>5、使用Manager()中封装方法创建</h3><p>在Models中定义Manager()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    s_name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_password = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_grade = models.ForeignKey(Grade)</span><br><span class="line"><span class="comment"># 多出来这1行，之后调用的时候可以写Student.s_m ，而不是Student.object </span></span><br><span class="line">    s_m = models.Manager()</span><br></pre></td></tr></table></figure><p>在views中调用Manager()</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">addStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    grade = Grade.objects.get(pk=<span class="number">2</span>)</span><br><span class="line">    student = Student.s_m.create(s_name=<span class="string">'ZJ'</span>,s_password=<span class="string">'ILKEY'</span>,s_grade=grade)</span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"学生数据添加成功5"</span>)</span><br></pre></td></tr></table></figure><h3 id="6、直接调用类方法添加数据"><a href="#6、直接调用类方法添加数据" class="headerlink" title="6、直接调用类方法添加数据"></a>6、直接调用类方法添加数据</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">person = Person.create(<span class="string">'Neo'</span>,<span class="number">18</span>)</span><br><span class="line">person.save()</span><br></pre></td></tr></table></figure><h2 id="删"><a href="#删" class="headerlink" title="删"></a>删</h2><p>删除是基于查询的，把查询到的结果进行删除，这里删除的是主键为2的，因为刚刚jack插入了两次，重复了，所以删了。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">delStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.get(pk=<span class="number">2</span>)</span><br><span class="line">    student.delete()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"删除成功！"</span>)</span><br></pre></td></tr></table></figure><h2 id="改"><a href="#改" class="headerlink" title="改"></a>改</h2><p>修改是基于查询的，修改后保存。</p><p>此时的数据库表：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [model3]&gt; select * <span class="keyword">from</span> App_student;</span><br><span class="line">+----+--------+------------+------------+</span><br><span class="line">| id | s_name | s_password | s_grade_id |</span><br><span class="line">+----+--------+------------+------------+</span><br><span class="line">|  <span class="number">1</span> | Jack   | <span class="number">123456789</span>  |          <span class="number">1</span> |</span><br><span class="line">|  <span class="number">3</span> | Niki   | <span class="number">987654321</span>  |          <span class="number">1</span> |</span><br><span class="line">|  <span class="number">4</span> | Rose   | abcdefg    |          <span class="number">3</span> |</span><br><span class="line">|  <span class="number">5</span> | Bool   | poiuytq    |          <span class="number">2</span> |</span><br><span class="line">|  <span class="number">6</span> | ZJ     | ILKEY      |          <span class="number">2</span> |</span><br><span class="line">+----+--------+------------+------------+</span><br><span class="line"><span class="number">5</span> rows <span class="keyword">in</span> set (<span class="number">0.00</span> sec)</span><br></pre></td></tr></table></figure><p>我们把Bool用户的ZJ用户的Password修改为：oiuytre</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.get(s_name=<span class="string">'ZJ'</span>)</span><br><span class="line">    student.s_password = <span class="string">"oiuytre"</span></span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"修改成功！"</span>)</span><br></pre></td></tr></table></figure><h2 id="查"><a href="#查" class="headerlink" title="查"></a>查</h2><p>查询句柄objects，objects是Manager()的实例，操作都封装在了objects里面，如<code>Person.objects.all()</code>，如果不想使用object对象，可以重写Manager()方法，详情见<strong>增</strong>的第5点。    </p><p>object ——&gt; Manager ——&gt; BaseManager ——&gt; get_queryset</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Manager</span><span class="params">(BaseManager.from_queryset<span class="params">(QuerySet)</span>)</span>:</span></span><br><span class="line">    <span class="keyword">pass</span></span><br></pre></td></tr></table></figure><p>BaseManager是个类，类下面有get_queryset方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Returns a new QuerySet object.  Subclasses can override this method to</span></span><br><span class="line"><span class="string">    easily customize the behavior of the Manager.</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    <span class="keyword">return</span> self._queryset_class(model=self.model, using=self._db, hints=self._hints)</span><br></pre></td></tr></table></figure><p>Student.objects.all()方法是调用的get_queryset方法：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">all</span><span class="params">(self)</span>:</span></span><br><span class="line">    <span class="comment"># We can't proxy this method through the `QuerySet` like we do for the</span></span><br><span class="line">    <span class="comment"># rest of the `QuerySet` methods. This is because `QuerySet.all()`</span></span><br><span class="line">    <span class="comment"># works by creating a "copy" of the current queryset and in making said</span></span><br><span class="line">    <span class="comment"># copy, all the cached `prefetch_related` lookups are lost. See the</span></span><br><span class="line">    <span class="comment"># implementation of `RelatedManager.get_queryset()` for a better</span></span><br><span class="line">    <span class="comment"># understanding of how this comes into play.</span></span><br><span class="line">    <span class="keyword">return</span> self.get_queryset()</span><br></pre></td></tr></table></figure><p>查询方法最后都会归结到get_queryset方法，所以只要对这个方法做封装，就可以实现定制化查询，比如逻辑删除后的查询。</p><h3 id="获取查询结果集"><a href="#获取查询结果集" class="headerlink" title="获取查询结果集"></a>获取查询结果集</h3><p>all、filter、exclude、order_by、values、切片</p><p>链式调用：person.objects.filter().filter()…..exclude()…</p><h4 id="all"><a href="#all" class="headerlink" title="all"></a>all</h4><p>返回所有数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.all()</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    print("数据:",students,"类型:",type(students))</span></span><br><span class="line"><span class="string">    数据: &lt;QuerySet [&lt;Student: Student object&gt;, 。。。。&gt;</span></span><br><span class="line"><span class="string">    类型: &lt;class 'django.db.models.query.QuerySet'&gt;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(<span class="string">"姓名：&#123;0&#125; 密码：&#123;1&#125; "</span>.format(student.s_name,student.s_password))</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    姓名：Jack 密码：123456789</span></span><br><span class="line"><span class="string">    姓名：Niki 密码：987654321</span></span><br><span class="line"><span class="string">    姓名：Rose 密码：abcdefg</span></span><br><span class="line"><span class="string">    姓名：Bool 密码：poiuytq</span></span><br><span class="line"><span class="string">    姓名：ZJ 密码：oiuytre</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="filter"><a href="#filter" class="headerlink" title="filter"></a>filter</h4><p>过滤操作，将符合条件的对象过滤出来，exclude和filter相反，exclude是过滤出不符合条件的数据</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.filter(pk__gt=<span class="number">3</span>) <span class="comment"># 主键 &gt;3</span></span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(<span class="string">"姓名：&#123;0&#125; 密码：&#123;1&#125; "</span>.format(student.s_name,student.s_password))</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    姓名：Rose 密码：abcdefg</span></span><br><span class="line"><span class="string">    姓名：Bool 密码：poiuytq</span></span><br><span class="line"><span class="string">    姓名：ZJ 密码：oiuytre</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="order-by"><a href="#order-by" class="headerlink" title="order_by"></a>order_by</h4><p>依照指定的字段名进行排序输出</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.order_by(<span class="string">'-s_name'</span>) <span class="comment"># 负号表示反序</span></span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(<span class="string">"姓名：&#123;0&#125; 密码：&#123;1&#125; "</span>.format(student.s_name,student.s_password))</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    姓名：ZJ 密码：oiuytre</span></span><br><span class="line"><span class="string">    姓名：Rose 密码：abcdefg</span></span><br><span class="line"><span class="string">    姓名：Niki 密码：987654321</span></span><br><span class="line"><span class="string">    姓名：Jack 密码：123456789</span></span><br><span class="line"><span class="string">    姓名：Bool 密码：poiuytq</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="values"><a href="#values" class="headerlink" title="values"></a>values</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students_all = Student.objects.values()  <span class="comment"># 以字典的形式返回</span></span><br><span class="line">    <span class="keyword">for</span> students <span class="keyword">in</span> students_all: <span class="comment"># 把每个用户字典集中取出来</span></span><br><span class="line">        print(<span class="string">"-------------------------------------"</span>)</span><br><span class="line">        <span class="keyword">for</span> student <span class="keyword">in</span> students.items(): <span class="comment"># 把用户的每个元素从字典中取出来</span></span><br><span class="line">            print(student)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="slice"><a href="#slice" class="headerlink" title="slice"></a>slice</h4><ul><li><p>和Python中的切片不太一样</p></li><li><p>QuerySet[5:15] 获取第5到15条数据，相当于SQL中的Limit和Offset</p></li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.all()[<span class="number">0</span>:<span class="number">2</span>]</span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(<span class="string">"姓名：&#123;0&#125; 密码：&#123;1&#125; "</span>.format(student.s_name,student.s_password))</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    姓名：Jack 密码：123456789</span></span><br><span class="line"><span class="string">    姓名：Niki 密码：987654321</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h3 id="获取查询条件的单个对象"><a href="#获取查询条件的单个对象" class="headerlink" title="获取查询条件的单个对象"></a>获取查询条件的单个对象</h3><p>first、last、get、exist</p><h4 id="first"><a href="#first" class="headerlink" title="first"></a>first</h4><p>返回查询集中的第一个对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.last()  <span class="comment"># 返回查询的最后个对象</span></span><br><span class="line">    print(student.s_name)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="last"><a href="#last" class="headerlink" title="last"></a>last</h4><p>返回查询集中的最后一个对象</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.last()  <span class="comment"># 返回查询的第一个对象</span></span><br><span class="line">    print(student.s_name)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="get"><a href="#get" class="headerlink" title="get"></a>get</h4><p>返回一个满足条件的对象，如果没有找到符合条件的对象， 会引发DoesNotExist异常，如果找到多个，会引发模型MultiObjectsReturned异常，可以使用<code>try ... except 模型类.异常...</code>的方式捕获异常。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        student = Student.objects.get(pk=<span class="number">11</span>)</span><br><span class="line">        print(student.s_name)</span><br><span class="line">    <span class="keyword">except</span> Student.DoesNotExist:</span><br><span class="line">        print(<span class="string">"用户不存在"</span>)</span><br><span class="line">    <span class="keyword">except</span> Student.MultipleObjectsReturned:</span><br><span class="line">        print(<span class="string">"存在多个用户"</span>)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h4 id="exist"><a href="#exist" class="headerlink" title="exist"></a>exist</h4><p>判断查询结果是否存在</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    result = Student.objects.filter(s_name=<span class="string">'ZJ'</span>).exists()</span><br><span class="line">    print(result)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h3 id="查询条件"><a href="#查询条件" class="headerlink" title="查询条件"></a>查询条件</h3><p>表达式：属性__操作符=临界值</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">- gt  大于</span><br><span class="line">- lt  小于</span><br><span class="line">- gte 大于等于</span><br><span class="line">- lte 小于等于</span><br><span class="line">- <span class="keyword">in</span> 在某一集合中</span><br><span class="line">- contains  类似于模糊查询like</span><br><span class="line">- startswith  以xx开始，本质也是like</span><br><span class="line">- endswith 以xx结束，也是like</span><br><span class="line">- exact  精确等于,相当于 == </span><br><span class="line"></span><br><span class="line">- 前面同时添加i , ignore 忽略</span><br><span class="line">  - iexact  忽略大小写的匹配</span><br><span class="line">  - icontains</span><br><span class="line">  - istartswith</span><br><span class="line">  - iendswith</span><br><span class="line">- isnull 、isnotnull</span><br><span class="line"></span><br><span class="line">- django中查询条件有时区问题</span><br><span class="line">  - 关闭django中自定义的时区</span><br><span class="line">  - 在数据库中创建对应的时区表</span><br></pre></td></tr></table></figure><p>示例：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.filter(pk__gt = <span class="number">2</span>)</span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(student.s_name)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h3 id="FQ对象"><a href="#FQ对象" class="headerlink" title="FQ对象"></a>FQ对象</h3><p>F对象和Q对象</p><p>F对象</p><ul><li>可以获取我们属性的值</li><li>可以实现一个模型不同属性的运算操作</li><li>还可以支持算术运算</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 可以使用模型的A属性与B属性进行比较</span></span><br><span class="line"></span><br><span class="line">grades = Grade.objects.filter(ggirlnum__gt=F(<span class="string">'gboynum'</span>) )</span><br><span class="line"></span><br><span class="line"><span class="comment"># F对象支持算数运算</span></span><br><span class="line"></span><br><span class="line">grades = Grade.objects.filter(ggirlnum__gt=F(<span class="string">'gboynum'</span>) +<span class="number">10</span> )</span><br></pre></td></tr></table></figure><p>Q对象</p><p>过滤器的方法中的关键参数，常用于组合条件</p><p>对查询条件进行封装， 封装之后支持逻辑运算</p><ul><li>与 &amp; and</li><li>或  |  or</li><li>非  ~  not</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    <span class="comment"># 查询主键值在[2,4]之间的用户</span></span><br><span class="line">    students = Student.objects.filter(Q(pk__gte = <span class="number">2</span>) &amp; Q(pk__lte =<span class="number">4</span>))</span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(student.s_name)</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h3 id="聚合函数"><a href="#聚合函数" class="headerlink" title="聚合函数"></a>聚合函数</h3><p>使用aggregate()函数返回聚合函数的值</p><p>Avg：平均值</p><p>Count：数量</p><p>Max：最大</p><p>Min：最小</p><p>Sum：求和</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    result = Student.objects.aggregate(Count(<span class="string">'s_name'</span>))</span><br><span class="line">    print(result)</span><br><span class="line">    <span class="string">'''</span></span><br><span class="line"><span class="string">    &#123;'s_name__count': 5&#125;</span></span><br><span class="line"><span class="string">    '''</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h3 id="逻辑删除"><a href="#逻辑删除" class="headerlink" title="逻辑删除"></a>逻辑删除</h3><p>对于重要数据都做逻辑删除，不做物理删除，实现方法是定义isDelete属性，类型为BooleanField，默认值为False。</p><p>修改数据库表单</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    s_name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_password = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_grade = models.ForeignKey(Grade)</span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>)</span><br></pre></td></tr></table></figure><p>进行文件迁移</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">python manage.py makemigrations</span><br><span class="line">python manage.py migrate</span><br></pre></td></tr></table></figure><p>先查询所有项</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查询函数</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.filter(is_delete=<span class="literal">False</span>)</span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(<span class="string">"姓名：&#123;0&#125; 密码：&#123;1&#125; "</span>.format(student.s_name, student.s_password))</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><p>结果</p><blockquote><p>姓名：Jack 密码：123456789<br>姓名：Niki 密码：987654321<br>姓名：Rose 密码：abcdefg<br>姓名：Bool 密码：poiuytq<br>姓名：ZJ 密码：oiuytre</p></blockquote><p>删除其中某项</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 实际上是把is_delete字段修改为True，并不是真的删除</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">modStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.get(s_name=<span class="string">'ZJ'</span>)</span><br><span class="line">    student.is_delete = <span class="literal">True</span></span><br><span class="line">    student.save()</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"修改成功！"</span>)</span><br></pre></td></tr></table></figure><p>再次查询结果：</p><blockquote><p>姓名：Jack 密码：123456789<br>姓名：Niki 密码：987654321<br>姓名：Rose 密码：abcdefg<br>姓名：Bool 密码：poiuytq</p></blockquote><p>这样做可以实现对重要数据不是真的删除，但是有一个缺点，我们每次查询的时候，都需要加上<code>is_delete=False</code>这样一个选项，能不能有什么改进的措施呢？</p><p>可以通过自定义Manager实现统一封装，重写get_queryset方法，这样就不需要在查询的时候写<code>filter(is_delete=False)</code></p><p>1、修改models.py</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> django.db <span class="keyword">import</span> models</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Grade</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    g_grade = models.CharField(max_length=<span class="number">16</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">StudentManager</span><span class="params">(models.Manager)</span>:</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">get_queryset</span><span class="params">(self)</span>:</span></span><br><span class="line">        <span class="keyword">return</span> super(StudentManager,self).get_queryset().filter(is_delete=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Student</span><span class="params">(models.Model)</span>:</span></span><br><span class="line">    s_name = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_password = models.CharField(max_length=<span class="number">32</span>)</span><br><span class="line">    s_grade = models.ForeignKey(Grade)</span><br><span class="line">    is_delete = models.BooleanField(default=<span class="literal">False</span>)</span><br><span class="line"></span><br><span class="line">    objects = StudentManager() <span class="comment"># 对Manager的实例Objects的get_qeuryset方法在进行一层封装</span></span><br></pre></td></tr></table></figure><p>2、这样查询语句中的is_delete字段就可以去掉了</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    students = Student.objects.filter()</span><br><span class="line">    <span class="keyword">for</span> student <span class="keyword">in</span> students:</span><br><span class="line">        print(<span class="string">"姓名：&#123;0&#125; 密码：&#123;1&#125; "</span>.format(student.s_name, student.s_password))</span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h3 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">·分类</span><br><span class="line">·ForeignKey：一对多，将字段定义在多的端中</span><br><span class="line">·ManyToManyField：多对多，将字段定义在两端中</span><br><span class="line">·OneToOneField：一对一，将字段定义在任意一端中</span><br><span class="line"></span><br><span class="line">·用一访问多</span><br><span class="line">·格式</span><br><span class="line">·对象.模型类小写_set</span><br><span class="line">·示例</span><br><span class="line">grade.students_set</span><br><span class="line"></span><br><span class="line">·用一访问一</span><br><span class="line">·格式</span><br><span class="line">·对象.模型类小写</span><br><span class="line">·示例</span><br><span class="line">·grade.students</span><br><span class="line"></span><br><span class="line">·访问id</span><br><span class="line">·格式</span><br><span class="line">·对象.属性_id</span><br><span class="line">·示例</span><br><span class="line">·student.s_grade_id</span><br></pre></td></tr></table></figure><p>1、通过学生的姓名查询学生所在的班级，使用外键作为连接：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    student = Student.objects.get(s_name=<span class="string">'Rose'</span>)</span><br><span class="line">    print(student.s_grade.g_grade) <span class="comment"># Science</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><p>2、直接查询</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">queStudent</span><span class="params">(request)</span>:</span></span><br><span class="line">    grade = Grade.objects.get(student__s_name=<span class="string">'Rose'</span>)</span><br><span class="line">    print(grade.g_grade) <span class="comment"># Science</span></span><br><span class="line">    <span class="keyword">return</span> HttpResponse(<span class="string">"查询成功"</span>)</span><br></pre></td></tr></table></figure><h2 id="缓存集"><a href="#缓存集" class="headerlink" title="缓存集"></a>缓存集</h2><ul><li>filter、exclude、all 都不会真正的去查询数据库</li><li>只有我们在迭代结果集，或者获取单个对象属性的时候，它才会去查询数据库</li><li>懒查询：为了优化我们结构和查询</li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://i.loli.net/2020/03/28/KCgP1Rbf6qei5Lp.png&quot; alt=&quot;django(二) - Models.png&quot;&gt;&lt;/p&gt;
&lt;h1 id=&quot;前期准备&quot;&gt;&lt;a href=&quot;#前期准备&quot; class=&quot;heade
      
    
    </summary>
    
    
      <category term="编程" scheme="http://ymlog.cn/categories/%E7%BC%96%E7%A8%8B/"/>
    
    
  </entry>
  
  <entry>
    <title>Mysql常用语句</title>
    <link href="http://ymlog.cn/2020/03/02/Mysql%E5%B8%B8%E7%94%A8%E8%AF%AD%E5%8F%A5/"/>
    <id>http://ymlog.cn/2020/03/02/Mysql%E5%B8%B8%E7%94%A8%E8%AF%AD%E5%8F%A5/</id>
    <published>2020-03-02T04:55:14.000Z</published>
    <updated>2020-06-16T10:15:34.972Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Init初始"><a href="#Init初始" class="headerlink" title="Init初始"></a>Init初始</h1><p>安装和创建授权用户</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看是否已经安装</span></span><br><span class="line">rpm -qa mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装mysql和服务端</span></span><br><span class="line">yum -y install mariadb-server mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 开启mysql进程</span></span><br><span class="line">systemctl start mariadb</span><br><span class="line"></span><br><span class="line"><span class="comment"># 初始化mysql，主要是创建root用户的密码，如果没有这步，root密码为空</span></span><br><span class="line">mysql_secure_installation</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户</span></span><br><span class="line">create user <span class="string">'username'</span>@<span class="string">'localhost'</span> IDENTIFIED BY <span class="string">'userpasswd'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 授权用户</span></span><br><span class="line">grant all privileges on *.* to <span class="string">'username'</span>@<span class="string">'localhost'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建用户并授权,并授权指定数据库下所有表,而非所有数据库</span></span><br><span class="line">grant all on dbname.* to <span class="string">'username'</span>@<span class="string">'localhost'</span> identified by <span class="string">'userpasswd'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除用户</span></span><br><span class="line">drop user <span class="string">'username'</span>@<span class="string">'localhost'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 刷新mysql系统权限相关表</span></span><br><span class="line">flush privileges;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示当前用户</span></span><br><span class="line">select user();</span><br><span class="line"></span><br><span class="line"><span class="comment"># 显示所有用户</span></span><br><span class="line">select User, Host, Password FROM mysql.user;</span><br></pre></td></tr></table></figure><h1 id="DB-SQL"><a href="#DB-SQL" class="headerlink" title="DB_SQL"></a>DB_SQL</h1><p>数据库的库语句，包括数据库的创建，删除，字符集等。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看当前MySQL中有哪些数据库</span></span><br><span class="line">show databases;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看选中数据库详情</span></span><br><span class="line">show create database &lt;db_name&gt;\G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建数据库</span></span><br><span class="line">create databases &lt;db_name&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用数据库</span></span><br><span class="line">use &lt;db_name&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除数据库</span></span><br><span class="line">drop database &lt;db_name&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 设置字符集</span></span><br><span class="line">create database &lt;db_name&gt; default charset <span class="string">'utf8'</span>;</span><br></pre></td></tr></table></figure><h1 id="TB-SQL"><a href="#TB-SQL" class="headerlink" title="TB_SQL"></a>TB_SQL</h1><p>表语句包括创建表、删除表、查看表以及定义表中字段的属性。其中定义表中字段属性往往比创建表更值得研究。</p><p>表语句</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先还是解决一下创建表时常见的字符集问题</span></span><br><span class="line">create  table  tableName</span><br><span class="line">(...)DEFAULT CHARSET=utf8mb4;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建表 </span></span><br><span class="line">create table tb_name(...);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看表</span></span><br><span class="line">show tables;</span><br><span class="line">show table status like <span class="string">'&lt;tb_name&gt;'</span>\G</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除表</span></span><br><span class="line">drop tables &lt;tb_name&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改表</span></span><br><span class="line">alter table &lt;old_name&gt; rename &lt;new_name&gt;</span><br></pre></td></tr></table></figure><p>实例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [demo]&gt; DESC myt7;</span><br><span class="line">+<span class="comment">-------+----------+------+-----+---------+----------------+</span></span><br><span class="line">| Field | Type     | Null | Key | Default | Extra          |</span><br><span class="line">+<span class="comment">-------+----------+------+-----+---------+----------------+</span></span><br><span class="line">| id    | int(11)  | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| sex   | char(10) | YES  |     | man     |                |</span><br><span class="line">+<span class="comment">-------+----------+------+-----+---------+----------------+</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    NULL：是否可以存储NULL值</span></span><br><span class="line"><span class="comment">    Key：是否已经编制索引，PRI表示该列是主键的一部分；UNI表示该列是UNIQUE索引的一部分，NULL表示在列中某个给定值允许出现多次</span></span><br><span class="line"><span class="comment">    Default：表示该列是否有默认值</span></span><br><span class="line"><span class="comment">    Extra：获取该列的附加信息</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure><p>实例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//查询后删除表</span><br><span class="line">MariaDB [demo]&gt; select group_concat(table_name) from information_schema.tables where table_schema='demo';</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| group_concat(table_name)   |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line">| fruits,sping,suppliers,x,y |</span><br><span class="line">+<span class="comment">----------------------------+</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">tables</span> fruits,sping,suppliers,x,y;</span><br></pre></td></tr></table></figure><p>字段</p><p>1、SQL主键的六种约束</p><table><thead><tr><th>名称</th><th align="left">含义</th></tr></thead><tbody><tr><td>PRIMARY KEY</td><td align="left">主键约束，记录唯一标识，主键自动拥有not null及 unique约束</td></tr><tr><td>NOT NULL</td><td align="left">非空约束，强制字段有值</td></tr><tr><td>UNIQUE</td><td align="left">唯一约束，该字段值必须唯一</td></tr><tr><td>FOREIGN KEY</td><td align="left">外键，预防破坏表之间的连接行为，防止非法数据插入外键列</td></tr><tr><td>CHECK</td><td align="left">限制列的取值范围</td></tr><tr><td>DEFAULT</td><td align="left">设置默认值</td></tr><tr><td>AUTO_INCREMENT</td><td align="left">自动增加字段，且字段类型必须为整型主键一部分</td></tr></tbody></table><p>实例：</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">1</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> my1( </span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">INT</span> PRIMARY <span class="keyword">KEY</span> <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">20</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">UNIQUE</span> ,</span><br><span class="line">    sex <span class="built_in">char</span>(<span class="number">2</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> <span class="keyword">DEFAULT</span> <span class="string">'m'</span> </span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">2</span><br><span class="line">//主键约束</span><br><span class="line"><span class="keyword">create</span>  <span class="keyword">table</span> myt3( </span><br><span class="line">    <span class="keyword">name</span> <span class="built_in">VARCHAR</span>(<span class="number">50</span>),</span><br><span class="line">    salary <span class="built_in">FLOAT</span>,</span><br><span class="line">    PRIMARY <span class="keyword">KEY</span>(<span class="keyword">name</span>,salary)</span><br><span class="line">);</span><br><span class="line"></span><br><span class="line">3</span><br><span class="line">//外键约束</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">外键表：即当前这张表</span></span><br><span class="line"><span class="comment">主键表：mainTable</span></span><br><span class="line"><span class="comment">绑定的主键：main_key_name</span></span><br><span class="line"><span class="comment">绑定的外键：foreign_key_name</span></span><br><span class="line"><span class="comment">绑定名称：foreign_name</span></span><br><span class="line"><span class="comment">constraint ： 约束</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">constraint (foreign_name) foreign key(foreign_key_name) references mainTable(main_key_name)</span><br></pre></td></tr></table></figure><p>修改字段语句</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 修改字段类型和字段名</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">change</span> &lt;old_field&gt; &lt;new_field&gt; <span class="built_in">INT</span>(<span class="number">15</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字段的类型和字段名</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">add</span> &lt;new_field&gt; <span class="built_in">INT</span>(<span class="number">15</span>) <span class="keyword">AFTER</span>|<span class="keyword">FIRST</span> &lt;<span class="keyword">field</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除字段</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">drop</span> &lt;<span class="keyword">field</span>&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字段的排列位置</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">modify</span> &lt;f1&gt; <span class="keyword">type</span> <span class="keyword">FIRST</span>|<span class="keyword">AFTER</span> &lt;f2&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 修改字段的数据类型</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">modify</span> &lt;<span class="keyword">field</span>&gt; <span class="built_in">INT</span>(<span class="number">20</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 更改存储引擎</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">engine</span>=&lt;en_name&gt;;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除外键约束</span></span><br><span class="line"><span class="keyword">alter</span> <span class="keyword">table</span> &lt;tb_name&gt; <span class="keyword">drop</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> 外键约束名;</span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除没有关联的表</span></span><br><span class="line"><span class="keyword">drop</span> <span class="keyword">table</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> &lt;tb1&gt;,&lt;tb2&gt;;</span><br></pre></td></tr></table></figure><p>总结：</p><blockquote><p>change用来修改KEY本身</p><p>modify则修改KEY的属性</p><p>后面直接和定义语法一样，千万别忘了后面的类型，如…INT(11)，不然会报错</p><p>FIRST：将字段设置为表的第一个字段</p><p>AFTER：将新添加的字段添加到指定字段的后面</p></blockquote><p>实例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">删除两个有关联的表</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> pt(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) PRIMARY <span class="keyword">KEY</span>,<span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">30</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> subt(</span><br><span class="line">    <span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">11</span>) PRIMARY <span class="keyword">KEY</span>,</span><br><span class="line">    depId <span class="built_in">int</span>(<span class="number">11</span>),</span><br><span class="line">    <span class="keyword">CONSTRAINT</span> fk_name <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> (depId) <span class="keyword">REFERENCES</span> pt(<span class="keyword">id</span>)</span><br><span class="line">);</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">    不能直接 drop pt，但可以直接删除subt</span></span><br><span class="line"><span class="comment">    先解除关联，再删除主表</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"> <span class="keyword">alter</span> <span class="keyword">table</span> subt <span class="keyword">drop</span> <span class="keyword">FOREIGN</span> <span class="keyword">KEY</span> fk_name;</span><br><span class="line"> <span class="keyword">drop</span>  <span class="keyword">table</span> pt;</span><br></pre></td></tr></table></figure><h1 id="SQL"><a href="#SQL" class="headerlink" title="SQL"></a>SQL</h1><p>insert</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 两种数值插入的方式</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> &lt;tb_name&gt; (coloumn_list) <span class="keyword">VALUES</span> (value_list);</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> &lt;tb_name&gt; <span class="keyword">VALUES</span> (value_list);</span><br><span class="line"></span><br><span class="line"><span class="comment"># 将查询到的结果插入</span></span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span>  table1 (coloumn_list) <span class="keyword">select</span> (coloumn_list) <span class="keyword">from</span>  table2 <span class="keyword">WHERE</span> (condition);</span><br><span class="line"></span><br><span class="line">for example</span><br><span class="line">MariaDB [demo]&gt; insert into my1</span><br><span class="line">    -&gt; select id,name,age from my2 WHERE id&gt;2;</span><br></pre></td></tr></table></figure><p>update</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">update</span> &lt;tb_name&gt; <span class="keyword">SET</span> column_name1=value1,column_name2=value2,.... <span class="keyword">WHERE</span> condition;</span><br></pre></td></tr></table></figure><p>delete</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">DELETE</span> <span class="keyword">from</span> &lt;tb_name&gt; [<span class="keyword">WHERE</span> condition];</span><br><span class="line">/如果没有WHERE，则删除表中所有记录。</span><br></pre></td></tr></table></figure><h1 id="NB-select"><a href="#NB-select" class="headerlink" title="NB.select"></a>NB.select</h1><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span>  字段<span class="number">1</span>，字段<span class="number">2</span>，字段<span class="number">3.</span>..</span><br><span class="line">-&gt; <span class="keyword">from</span> [表<span class="number">1</span>],[表<span class="number">2</span>]...    //数据来源</span><br><span class="line">-&gt; <span class="keyword">WHERE</span> 表达式   //查询的条件</span><br><span class="line">-&gt; <span class="keyword">GROUP</span> <span class="keyword">BY</span> (<span class="keyword">group</span> <span class="keyword">by</span> definition) //如何显示查询数据，按照指定字段分组</span><br><span class="line">-&gt; <span class="keyword">HAVING</span> (expression) [(<span class="keyword">operator</span>) (expression)] </span><br><span class="line">-&gt; <span class="keyword">ORDER</span> <span class="keyword">BY</span> (<span class="keyword">order</span> <span class="keyword">by</span> definition) //用什么样的顺序显示查询的数据，<span class="keyword">ASC</span>(升序)、<span class="keyword">DESC</span>(降序)</span><br><span class="line">-&gt; <span class="keyword">LIMIT</span> [(<span class="keyword">offset</span>),] (<span class="keyword">row</span> <span class="keyword">count</span>) //限制显示条数</span><br><span class="line"></span><br><span class="line"><span class="keyword">select</span> &#123;字段<span class="number">1</span>，字段<span class="number">2</span>，字段<span class="number">3</span>，...&#125;</span><br><span class="line"><span class="keyword">from</span> &#123;表或视图&#125;</span><br><span class="line"><span class="keyword">WHERE</span> &#123;查询条件&#125;;</span><br><span class="line">    </span><br><span class="line">过滤,排序,分组。</span><br><span class="line">排序要在过滤之后，不然报错</span><br></pre></td></tr></table></figure><p>数据源</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 创建库</span></span><br><span class="line">create database db_test default charset <span class="string">'utf8'</span>;</span><br><span class="line"><span class="comment"># 创建表</span></span><br><span class="line">create table person</span><br><span class="line">    (</span><br><span class="line">    id INT NOT NULL AUTO_INCREMENT,</span><br><span class="line">    name CHAR(20) NOT NULL,</span><br><span class="line">    book VARCHAR(50) NOT NULL,</span><br><span class="line">    dynasty VARCHAR(10) DEFAULT <span class="string">'China'</span>,</span><br><span class="line">    PRIMARY KEY(id)</span><br><span class="line">    )DEFAULT CHARSET=utf8mb4;</span><br><span class="line"><span class="comment"># 插入值    </span></span><br><span class="line">insert into person (name,book,dynasty) VALUES (<span class="string">'王阳明'</span>,<span class="string">'传习录'</span>,<span class="string">'ming'</span>);</span><br><span class="line">insert into person (name,book) VALUES (<span class="string">'林清玄'</span>,<span class="string">'白雪少年'</span>);</span><br><span class="line">insert into person (name,book,dynasty) VALUES (<span class="string">'孔子'</span>,<span class="string">'论语'</span>,<span class="string">'chunqiu'</span>);</span><br><span class="line">insert into person (name,book,dynasty) VALUES (<span class="string">'老子'</span>,<span class="string">'道德经'</span>,<span class="string">'chunqiu'</span>);</span><br><span class="line">insert into person (name,book,dynasty) VALUES (<span class="string">'李白'</span>,<span class="string">'蜀道难'</span>,<span class="string">'tang'</span>);</span><br><span class="line">insert into person (name,book,dynasty) VALUES (<span class="string">'陈子昂'</span>,<span class="string">'登幽州台歌'</span>,<span class="string">'tang'</span>);</span><br><span class="line"><span class="comment"># 查看插入的值</span></span><br><span class="line">select * from person;</span><br></pre></td></tr></table></figure><img src="http://q5q3e2ctx.bkt.clouddn.com/mysql_1_data.png" alt="image-20200302153805396" style="zoom:67%;" /><p>简单查询</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [nikitest]&gt; select id,name,book,dynasty from person where id in (01,02,06) AND dynasty='tang';</span><br><span class="line">+<span class="comment">----+-----------+-----------------+---------+</span></span><br><span class="line">| id | name      | book            | dynasty |</span><br><span class="line">+<span class="comment">----+-----------+-----------------+---------+</span></span><br><span class="line">|  6 | 陈子昂    | 登幽州台歌      | tang    |</span><br><span class="line">+<span class="comment">----+-----------+-----------------+---------+</span></span><br></pre></td></tr></table></figure><p>别名查询</p><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [nikitest]&gt; select id as ID,name as NAME,book as BOOK,dynasty as DYNASTY  from person as f where f.id &lt; 5;</span><br><span class="line">+<span class="comment">----+-----------+--------------+---------+</span></span><br><span class="line">| ID | NAME      | BOOK         | DYNASTY |</span><br><span class="line">+<span class="comment">----+-----------+--------------+---------+</span></span><br><span class="line">|  1 | 王阳明    | 传习录       | ming    |</span><br><span class="line">|  2 | 林清玄    | 白雪少年     | China   |</span><br><span class="line">|  3 | 孔子      | 论语         | chunqiu |</span><br><span class="line">|  4 | 老子      | 道德经       | chunqiu |</span><br><span class="line">+<span class="comment">----+-----------+--------------+---------+</span></span><br><span class="line"></span><br><span class="line">//即将字段以别名显示，同时将表也以表明显示（这里用的是f-&gt;person，所以条件查询f下的字段就可以写成f.id)</span><br></pre></td></tr></table></figure><p>排序</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//单列排序，DESC反序</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">DISTINCT</span> <span class="keyword">id</span>,<span class="keyword">name</span>,book, dynasty <span class="keyword">from</span> person <span class="keyword">order</span> <span class="keyword">by</span> <span class="keyword">id</span> <span class="keyword">DESC</span>;</span><br><span class="line"></span><br><span class="line">//多列排序，先按照朝代排序，相同朝代的再按照名称排序</span><br><span class="line"><span class="keyword">select</span> <span class="keyword">DISTINCT</span> <span class="keyword">id</span>,<span class="keyword">name</span>,book, dynasty <span class="keyword">from</span> person <span class="keyword">order</span> <span class="keyword">by</span> dynasty <span class="keyword">DESC</span>,<span class="keyword">name</span>;</span><br></pre></td></tr></table></figure><p>分组</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">//同类分为一组，通过GROUP_CONCAT(field)显示详细信息</span><br><span class="line">&gt; select group_concat(name),dynasty from person group by dynasty;</span><br><span class="line">+<span class="comment">--------------------+---------+</span></span><br><span class="line">| GROUP_CONCAT(name) | dynasty |</span><br><span class="line">+<span class="comment">--------------------+---------+</span></span><br><span class="line">| 林清玄             | China   |</span><br><span class="line">| 孔子,老子          | chunqiu |</span><br><span class="line">| 王阳明             | ming    |</span><br><span class="line">| 李白,陈子昂        | tang    |</span><br><span class="line">+<span class="comment">--------------------+---------+</span></span><br></pre></td></tr></table></figure><p>过滤</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//查看同一时代的人，过滤出人数&gt;1的</span><br><span class="line">&gt; select group_concat(name), dynasty from person group by dynasty having count(dynasty)&gt;1;</span><br><span class="line">+<span class="comment">--------------------+---------+</span></span><br><span class="line">| group_concat(name) | dynasty |</span><br><span class="line">+<span class="comment">--------------------+---------+</span></span><br><span class="line">| 孔子,老子          | chunqiu |</span><br><span class="line">| 李白,陈子昂        | tang    |</span><br><span class="line">+<span class="comment">--------------------+---------+</span></span><br></pre></td></tr></table></figure><p>限制</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">//限制显示结果为 offset &amp; count</span><br><span class="line">&gt; select * from person limit 2;</span><br><span class="line">+<span class="comment">----+-----------+--------------+---------+</span></span><br><span class="line">| id | name      | book         | dynasty |</span><br><span class="line">+<span class="comment">----+-----------+--------------+---------+</span></span><br><span class="line">|  1 | 王阳明    | 传习录       | ming    |</span><br><span class="line">|  2 | 林清玄    | 白雪少年     | China   |</span><br><span class="line">+<span class="comment">----+-----------+--------------+---------+</span></span><br><span class="line">2 rows in <span class="keyword">set</span> (<span class="number">0.00</span> sec)</span><br><span class="line"></span><br><span class="line">//限制显示<span class="number">2</span>个结果，并从第<span class="number">4</span>个开始显示，这里设置了偏移位=<span class="number">4</span></span><br><span class="line">&gt; <span class="keyword">select</span> * <span class="keyword">from</span> person <span class="keyword">limit</span> <span class="number">3</span>,<span class="number">2</span>;</span><br><span class="line">+<span class="comment">----+--------+-----------+---------+</span></span><br><span class="line">| id | name   | book      | dynasty |</span><br><span class="line">+<span class="comment">----+--------+-----------+---------+</span></span><br><span class="line">|  4 | 老子   | 道德经    | chunqiu |</span><br><span class="line">|  5 | 李白   | 蜀道难    | tang    |</span><br><span class="line">+<span class="comment">----+--------+-----------+---------+</span></span><br></pre></td></tr></table></figure><h1 id="AF函数"><a href="#AF函数" class="headerlink" title="AF函数"></a>AF函数</h1><p>aggregate function，mysql内置聚合函数</p><table><thead><tr><th>函数</th><th>作用</th></tr></thead><tbody><tr><td>AVG()</td><td>列数值均值</td></tr><tr><td>COUNT()</td><td>个数，忽略空行,COUNT(*)计算表中总行数，不忽略空行</td></tr><tr><td>MAX()</td><td>列数值最大</td></tr><tr><td>MIN()</td><td>列数值最小</td></tr><tr><td>SUM()</td><td>列数值和</td></tr></tbody></table><p>实例</p><figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">select</span> <span class="keyword">id</span>,<span class="keyword">name</span>,book,<span class="keyword">MAX</span>(dynasty) <span class="keyword">from</span> person;</span><br><span class="line"></span><br><span class="line">| 0111 0100 | 0164 | 116 | 0x74 | t |</span><br><span class="line">| 0110 0011 | 0143 | 99  | 0x63 | c |</span><br><span class="line">| 0110 1101 | 0155 | 109 | 0x6D | m |</span><br><span class="line">//这里t最大，所以选出来tang</span><br></pre></td></tr></table></figure><p>这里只介绍了基础的SQL语句，后面还有连接查询、子查询、合并查询等……..</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Init初始&quot;&gt;&lt;a href=&quot;#Init初始&quot; class=&quot;headerlink&quot; title=&quot;Init初始&quot;&gt;&lt;/a&gt;Init初始&lt;/h1&gt;&lt;p&gt;安装和创建授权用户&lt;/p&gt;
&lt;figure class=&quot;highlight bash&quot;&gt;&lt;table&gt;&lt;t
      
    
    </summary>
    
    
      <category term="数据库" scheme="http://ymlog.cn/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
  </entry>
  
  <entry>
    <title>Switch交换机</title>
    <link href="http://ymlog.cn/2020/02/27/Switch%E4%BA%A4%E6%8D%A2%E6%9C%BA/"/>
    <id>http://ymlog.cn/2020/02/27/Switch%E4%BA%A4%E6%8D%A2%E6%9C%BA/</id>
    <published>2020-02-27T12:34:14.000Z</published>
    <updated>2020-06-16T11:31:42.435Z</updated>
    
    <content type="html"><![CDATA[<div style="color:red">淦，实在不知道用什么封面了，网上关于Lay2 Lay3 Switch都巨丑，用自己正在打字的电脑做封面吧^_^??</div><br><p>交换技术主要用于构建局域网，主要实现的局域网内的通信和隔离。交换机即插即用，因为所有的接口默认分配在vlan 1 中，且vlan 1为native vlan，不需要进行封装。为了实现局域网的隔离，可以将不同的接口或者MAC地址划分到不同的vlan，同一个vlan下的地址可以相互通信。</p><p>交换机主要存在的问题和解决方法：</p><ol><li>广播风暴，链路防环：使用Spanning-Tree或者快速生成树(MSTP、RSTP等)以及一系列生成树补丁来解决</li><li>Vlan同步：交换机不能转发自己没有的vlan信息，比如一个只有vlan 10,20,30的交换机不能转发和接受vlan40的报文，有两种解决方式：（1）手动配置使之相同   （2）VTP vlan同步协议</li><li>带宽受限：因为spanning-tree的缘故，两个交换机之间只能存在一条链路，因此带宽受限。可以使用二层或三层链路捆绑，提高网络带宽</li><li>网关单点故障：因为只有一个默认网关，所以当down了之后，终端就无法与外界通信。可以使用网关冗余协议，如(FHRP,VRRP,GLBP)做高可用。</li></ol><p>讲到交换机不得不讲MAC地址，MAC地址和交换机同属于OSI七层的第二层——数据链路层。MAC地址一共有48位，前24位厂家分配，类似于手机的前几位网络识别号。MAC地址有如下字段：</p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/switch_1.png"></p><p>其中：</p><ul><li>类型：用于标识上一层使用的协议</li><li>IP数据报长度：46 = 64 - 6 - 6 - 2 - 4</li><li>FCS：帧检验序列，使用CRC循环冗余校验</li></ul><h1 id="配置VLAN"><a href="#配置VLAN" class="headerlink" title="配置VLAN"></a>配置VLAN</h1><p>ps：vlan的隔离包括广播，即使是发ARP，也只会发在自己的vlan。</p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/switch_2.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SW7 创建vlan</span></span><br><span class="line">vlan 10,20</span><br><span class="line"></span><br><span class="line"><span class="comment"># SW7 将接口加入到vlan，e0/1,2 e1/0,1 都是这样配</span></span><br><span class="line">int e0/1</span><br><span class="line">switchport mode access<span class="comment"># 将接口模式改为access</span></span><br><span class="line">switchport access vlan 10<span class="comment"># 将接口加入到vlan 10 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SW7 串口配置，即和SW8连接的e0/3接口</span></span><br><span class="line">int e0/3</span><br><span class="line">switchport trunk encapsulation dot1q<span class="comment"># 一律使用802.1Q封装</span></span><br><span class="line">switchport mode trunk<span class="comment"># 改变接口的模式为trunk</span></span><br></pre></td></tr></table></figure><p>交换机接口的三种模式：Vlan的链路类型可以分为接入链路和干道链路。</p><p>Access：只能属于1个VLAN，且该端口不打tag，一般用于连接计算机端口；　</p><p>Trunk：可以允许多个VLAN通过，且该端口都是打tag的，一般用于交换机之间的连接；　　</p><p>Hybrid：可以允许多个VLAN通过，至于该端口在vlan中是否打tag由用户根据具体情况而定，可以用于交换机之间的连接也可以用于交换机和用户计算机之间的连接。　　</p><p>Trunk和Hybrid的区别主要是，hybrid端口可以允许多个vlan的报文不打标签，而 trunk端口只允许缺省vlan的报文不打标签，同一个交换机上不能hybrid和trunk并存。</p><p>Trunk也可以由交换机自行协商，但一般都是网络管理员手动配置。</p><h1 id="VTP"><a href="#VTP" class="headerlink" title="VTP"></a>VTP</h1><p>VTP用于Vlan同步，分为三种模式：服务端(server)、客户端(client)、透传端(transparent)，客户端只可以查看不可以修改，服务端和透传端既可以查看又可以修改。</p><p>VTP只会同步vlan和vlan的名字，vlan的接口信息不会被同步走。</p><p>配置VTP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置服务端</span></span><br><span class="line">vlan 10-20<span class="comment"># 创建vlan</span></span><br><span class="line">vtp domain cisco<span class="comment"># 更改域名， 可以改可以不改，用于让一个局域网有许多vtp</span></span><br><span class="line">vtp mode server <span class="comment"># 将本机vtp的模式改为server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置透传端</span></span><br><span class="line">vtp domain cisco</span><br><span class="line">vtp mode transparent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置客户端</span></span><br><span class="line">vtp domain cisco</span><br><span class="line">vtp mode client</span><br></pre></td></tr></table></figure><p>其他命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Switch<span class="comment">#sh vlan brief # 查看本机vlan摘要</span></span><br><span class="line">Switch<span class="comment">#sh vtp ? # 查看vtp相关</span></span><br></pre></td></tr></table></figure><p>VTP修剪：一种优化vlan的方法</p><center style="font-weight:bold;">A ----> B -----> C -----D(I'm a PC)</center><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vtp pruning<span class="comment"># 开启vtp修剪</span></span><br></pre></td></tr></table></figure><p>比如：A、B、C是交换机，D是PC。</p><p>A的vlan：10，20，30，40</p><p>B的vlan：10，20</p><p>C的vlan：10，20</p><p>一旦开启vtp修剪，则C会告诉B：”我这没有vlan30，40，以后不要给我发vlan30，40的广播或者其他消息了”，B收到后会告诉A：”我这没有vlan30 ，40，以后不要发这个vlan的消息了”。A就会把这接口上的这两个vlan剪掉。</p><h1 id="生成树"><a href="#生成树" class="headerlink" title="生成树"></a>生成树</h1><p>生成树（Spanning-tree）是一种工作在OSI网络模型中的第二层（数据链路层）的通信协议，基本应用是防止交换机冗余链路产生的环路.用于确保以太网中无环路的逻辑拓扑结构.从而避免了广播风暴,大量占用交换机的资源。</p><p>生成树使用封锁接口的方式避免环路，被封锁的接口有如下判定方式：</p><ol><li>每个广播域选择一个根桥（注意是广播域，不是局域网）Root Bridge</li><li>每个非根桥选择一个根端口  Root Port</li><li>每个段选择一个指定端口 Designated Port</li><li>选择一个非指定端口，以上所有选择策略，都是以越小越优为准则</li></ol><p>根桥的制定：谁的MAC地址最小，谁就是根桥</p><p>根端口的指定：谁离根桥进，谁就是根端口</p><p>指定端口的指定：</p><ol><li>离根桥近</li><li>COST值小</li><li>发送者的端口ID小，端口ID即交换机的接口</li></ol><p>非指定端口将被封锁。</p><p>全网一开始是如何知道谁是根桥？</p><p>全网交换机开机，一开始，每台交换机都认为自己是根桥ID向外发送BPDU报文，如果在收到的BPDU报文中，发现了比自己还小的MAC地址，就把根桥ID改为那一台交换机的ID。经过一段时间，就可以确定全网的唯一的根桥ID。（可以抢占）</p><p>BPDU报文格式：</p><table><thead><tr><th>字节</th><th>字段</th><th>描述</th></tr></thead><tbody><tr><td>2</td><td>协议</td><td>代表上层协议(BPDU)，该值总为0</td></tr><tr><td>1</td><td>版本</td><td>（802.1D的总为0）</td></tr><tr><td>1</td><td>TYPE</td><td>“配置BPDU” 为0，“TCN BPDU”为80，TCN，topology change notification，拓扑改变时发送的报文，自下而上。</td></tr><tr><td>1</td><td>标志</td><td>LSB最低有效位表示TC标志，MSB最高的有效位表示TCA标志</td></tr><tr><td>8</td><td>根桥ID</td><td>根网桥的桥ID</td></tr><tr><td>4</td><td>路径开销</td><td>到达根桥的STP cost，如果是根桥则写0，带宽越大，开销越低</td></tr><tr><td>8</td><td>网桥ID</td><td>BPDU发送桥的ID</td></tr><tr><td>2</td><td>端口ID</td><td>BPDU发送网桥的端口ID（优先级+端口号），优先级默认128</td></tr><tr><td>2</td><td>消息寿命Message age</td><td>从根网桥发出BPDU之后的秒数，每经过一个网桥都减1，本质上是到达根桥的跳数</td></tr><tr><td>2</td><td>最大寿命Max age</td><td>当一段时间未收到任何BPDU，生存期达到MAX age，网桥认为该端口连接链路发生故障，默认20S</td></tr><tr><td>2</td><td>HELLO时间</td><td>根网桥连续发送BPDU之间的时间间隔，默认2S</td></tr><tr><td>2</td><td>转发延迟</td><td>在监听和学习状态停留的时间间隔，默认15S</td></tr></tbody></table><p>关于生成树，要配置的内容很少，都是现象，因为一切默认都已经配置好了，除非是改变生成树的种类。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">show spanning-tree<span class="comment">#查看生成树的状态</span></span><br><span class="line">spanning-tree vlan 1 priority 4096<span class="comment">#修改VLAN中spanning-tree的优先级。必须是4096的倍数</span></span><br><span class="line">VLAN0001<span class="comment">#VLAN 1</span></span><br><span class="line">  Spanning tree enabled protocol ieee</span><br><span class="line">  Root ID    Priority    32769<span class="comment">#32769=32768+VLAN.Nbr</span></span><br><span class="line">             Address     aabb.cc00.0100<span class="comment">#MAC地址</span></span><br><span class="line">             Cost        100<span class="comment">#这个VLAN的COST值</span></span><br><span class="line">             Port        2 (Ethernet0/1)<span class="comment">#RootID所用的端口</span></span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             <span class="comment">#Hello报文2s，最大寿命20s，转发延迟15s</span></span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)<span class="comment">#系统扩展ID就是VLAN 的序号</span></span><br><span class="line">             Address     aabb.cc00.0300</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec<span class="comment">#网络拓扑变化时，会变成15s，快速刷新mac表</span></span><br><span class="line"></span><br><span class="line">Interface           Role  Sts     Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg  FWD     100       128.1    Shr</span><br><span class="line">Et0/1               Root  FWD     100       128.2    Shr</span><br><span class="line">Et0/2               Altn  BLK     2         128.3    Shr</span><br><span class="line">Et0/3               Desg  FWD     100       128.4    Shr</span><br><span class="line">接口   角色 端口状态  Cost值   优先级.序号 类型</span><br></pre></td></tr></table></figure><p>生成树中的端口状态</p><table><thead><tr><th>状态</th><th>说明</th></tr></thead><tbody><tr><td>Disabled</td><td>不收发任何报文</td></tr><tr><td>Blocking</td><td>不接受也不转发帧，接受但不发送BPDU，不学习MAC地址</td></tr><tr><td>Listening</td><td>不接受也不转发帧，接受并且发送BPDU，不学习MAC地址</td></tr><tr><td>Learning</td><td>不接受也不转发帧，接受并且发送BPDU，学习MAC地址</td></tr><tr><td>Forwarding</td><td>接收并转发帧，接受并且发送BPDU，学习MAC地址</td></tr></tbody></table><p>状态转换：</p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_3.png" alt="image-20200227161444047" style="zoom:50%;" /><h2 id="实验现象"><a href="#实验现象" class="headerlink" title="实验现象"></a>实验现象</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_4.png" alt="image-20200209154918120"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R6 ping R7</span><br><span class="line"></span><br><span class="line">原本sw4的e0/3没有连接sw1的e0/3，现在将他们连接起来。此时，链路会有30s的不通，这是spanning-tree协议工作：</span><br><span class="line">原本的路由是R6 -- SW4 -- SW3 -- SW2 --SW1 --R7</span><br><span class="line">现在SW4和SW1连通，造成了SW3的e0/2接口发生了阻断BLK。</span><br><span class="line">路由路线变为：R6 -- SW4 -- SW1 -- R7</span><br><span class="line">SW4的e0/3接口从LIS -- LRN -- FWD需要30s的时间，所以30sping不通。</span><br><span class="line"></span><br><span class="line">然后将sw4的e0/3 shutdown ,SW3发现没有BPDU出现了，进入Lost BPDU Max age=20s，20sBPDU不出现，然后进入Listening（15s）和Learning（15s），一共恢复需要30s。</span><br></pre></td></tr></table></figure><h2 id="生成树拓扑变化"><a href="#生成树拓扑变化" class="headerlink" title="生成树拓扑变化"></a>生成树拓扑变化</h2><p>也叫STP 拓扑变化。</p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_5.png" alt="image-20200209091346870" style="zoom:50%;" /><p>Topology Change Notification Bridge Protocol Data Unit = TCN BPDU</p><p>网络拓扑变更报文  网桥协议单元，即当下层交换机拓扑发生变化时，次级交换机向Root Bridge传递TCN BPDU报文，即BPDU字段中的Type改为80。沿着根端口就可以最终把报文传送给Root，Root接收到后，发送TC标志设置，内容为空，目的是为了泛洪。</p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_6.png" alt="image-20200209091358909" style="zoom:50%;" /><p>35s = age老化时间（20s） +  Learning（15s）[生成树的计算时间]</p><h2 id="Portfast：快速端口"><a href="#Portfast：快速端口" class="headerlink" title="Portfast：快速端口"></a>Portfast：快速端口</h2><p>一个接口从开启到能正常运行会经历三个阶段，需要一定的时间。这是为了防止环路。如果不需要防环，可以使用Portfast来快速启动，这样已启动就变成FWD。</p><p>配置命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree portfast</span><br></pre></td></tr></table></figure><h2 id="PVST-：Peer-Vlan-Spanning-Tree-Plus"><a href="#PVST-：Peer-Vlan-Spanning-Tree-Plus" class="headerlink" title="PVST+：Peer Vlan Spanning-Tree Plus"></a>PVST+：Peer Vlan Spanning-Tree Plus</h2><p>每个VLAN都有一个生成树，Cisco私有。</p><p>Cisco Catalyst交换机的MAC地址池最多可以容纳1024个地址，交换机的型号决定了可用MAC的数目，并不是所有catalyst交换机都能支持到这么多个MAC</p><p>这些MAC地址作为VLAN生成树中的网桥ID的MAC地址部分，不同交换机型号支持不同的可用MAC地址数目，交换机依照次序分配MAC地址</p><p><code>show run int | include bia</code>可以看到所有的MAC，其中第一个MAC将被生成树使用，也就是CPU的MAC，接下去就是每个以太网接口的MAC</p><p>我们知道交换机能够支持的VLAN数据是很庞大的，如果开启PVST+，每个VLAN一棵生成树，而每棵生成树都要有一个独立的标识，都需要耗费MAC的话，那么MAC地址池肯定是无法承受的</p><p>因此需要用到MAC地址缩减方案，这也是为什么优先级必须是4096倍数的原因。</p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_7.png" alt="image-20200227162938052" style="zoom:33%;" /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show spanning-tree</span><br><span class="line"></span><br><span class="line">Priority 4097 (priority 4096 sys-id-ext 1)</span><br><span class="line"><span class="comment">#因为系统扩展ID是1，所以优先级要+1</span></span><br><span class="line"><span class="comment">#系统扩展ID=1是因为VLAN是1</span></span><br></pre></td></tr></table></figure><p>实验：</p><ul><li>VLAN 10,20 SW1为Root</li><li>VLAN 30,40 SW2为Root</li></ul><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_8.png" alt="image-20200209092821283"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show spanning-tree<span class="comment">#查看生成树的状态</span></span><br><span class="line">spanning-tree vlan 1 priority 4096<span class="comment">#修改PVST+的优先级</span></span><br><span class="line">spanning-tree vlan 10,20 root primary <span class="comment">#将vlan10,20的优先级比当前环境下最小的优先级低两个档次</span></span><br><span class="line">spanning-tree vlan 10,20 root primary <span class="comment">#将vlan10,20的优先级比当前环境下最小的优先级低一个档次</span></span><br></pre></td></tr></table></figure><h1 id="快速生成树"><a href="#快速生成树" class="headerlink" title="快速生成树"></a>快速生成树</h1><p>由于生成树的速度过慢，一般会采用快速生成树。数据中心不会使用生成树，而是大二层的结构，但园区网还是会用到生成树。下面介绍两种快速生成树，一种是Cisco私有的RSTP，一种是公开的MSTP。</p><h2 id="RSTP：Rapid-Spanning-Tree-Protocol"><a href="#RSTP：Rapid-Spanning-Tree-Protocol" class="headerlink" title="RSTP：Rapid Spanning Tree Protocol"></a>RSTP：Rapid Spanning Tree Protocol</h2><p>特点：</p><ul><li>802.1W</li><li>端口角色：根端口、指定端口、替代端口、备份端口</li><li>端口状态：转发、丢弃、学习</li><li>在Cisco Catalyst交换机上，PVST+是基于RSTP实现的perVLAN版本</li></ul><p>配置：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree mode rapid-pvst<span class="comment">#BPDU的速度又多了快这个生成树就有多快</span></span><br></pre></td></tr></table></figure><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_9.png" alt="image-20200209162727580"  /><h2 id="MSTP：Multiple-Spanning-Tree-Protocol"><a href="#MSTP：Multiple-Spanning-Tree-Protocol" class="headerlink" title="MSTP：Multiple Spanning Tree Protocol"></a>MSTP：Multiple Spanning Tree Protocol</h2><p>集成了RSTP的优点，每实例一个生成树，PVSTP是每个vlan一颗生成树。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree mst configuration</span><br><span class="line">instance 1 vlan 10,20<span class="comment"># 创建实例，并把vlan10，20归入实例1</span></span><br><span class="line">instance 2 vlan 30,40</span><br><span class="line">show pending</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置优先级，系统扩展id变为实力号Instance.Nbr</span></span><br><span class="line">SW1</span><br><span class="line">spanning-tree mst 1 root primary</span><br><span class="line">spanning-tree mst 2 root secondary</span><br><span class="line"></span><br><span class="line">SW2</span><br><span class="line">spanning-tree mst 1 root secondary</span><br><span class="line">spanning-tree mst 2 root primary</span><br></pre></td></tr></table></figure><h1 id="生成树补丁"><a href="#生成树补丁" class="headerlink" title="生成树补丁"></a>生成树补丁</h1><p>Spanning-tree Patch，主要有六种生成树补丁，针对解决生成树反应慢、出差错、及故障检测。</p><h2 id="1、BPDUGuard"><a href="#1、BPDUGuard" class="headerlink" title="1、BPDUGuard"></a>1、BPDUGuard</h2><p>该接口在手都BPDU报文后，会立即切换到err-disable状态,把接口down了，常搭配portfast特性在接口上一起使用，用于连接主机，可在接口模式上激活，也可在全局模式上配置，两者有所不同。</p> <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree bpduguard <span class="built_in">enable</span> <span class="comment"># 接口</span></span><br><span class="line">spanning-tree portfast bpduguard default<span class="comment"># 全局</span></span><br><span class="line">show err recov<span class="comment"># 查看状态</span></span><br></pre></td></tr></table></figure><h2 id="2、BPDUFilter"><a href="#2、BPDUFilter" class="headerlink" title="2、BPDUFilter"></a>2、BPDUFilter</h2><p>一旦收到BPDU，就把接口上的Portfast删除。相当于可以智能判断是PC还是Switch。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree portfast bpdufilter default <span class="comment"># 全局</span></span><br><span class="line">spanning-tree bpdufilter <span class="built_in">enable</span><span class="comment"># 接口</span></span><br></pre></td></tr></table></figure><h2 id="3、UplinkFast"><a href="#3、UplinkFast" class="headerlink" title="3、UplinkFast"></a>3、UplinkFast</h2><p>当唯一的根端口Down，立刻切换到转发状态 ，跳过了LIS和LER的30s延时,但还有20s的max age 。所有配置了Uplink的交换机，都会把自己的优先级升高、COST值增加3000，防止自己成为ROOT。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree  uplinkfast</span><br></pre></td></tr></table></figure><h2 id="4、BackboneFast"><a href="#4、BackboneFast" class="headerlink" title="4、BackboneFast"></a>4、BackboneFast</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_10.png" alt="image-20200209185752441"></p><p>在部署了Backbone Fast后，SW3一旦收到SW2发送来的次优BPDU，会立即进行一系列的步骤以重新计算根端口，SW3会从跟端向根桥发送RLQ请求</p><p>Root SW1收到RLQ请求，立刻以RLQ响应进行恢复，以告知自己仍然存活</p><p>SW3立刻老化掉存储在Fae0/3上的BPDU，端口Fa0/3进入Listening状态开始发送BPDU</p><p>SW2从SW3收到BPDU，经过计算得出自己的Fa0/2为根端口</p><p>相当于去掉了20s BLK状态</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree backbonefast</span><br></pre></td></tr></table></figure><h2 id="5、RootGuard"><a href="#5、RootGuard" class="headerlink" title="5、RootGuard"></a>5、RootGuard</h2><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_11.png" alt="image-20200209185915776" style="zoom:67%;" /><p>只要Service-Provider Network端收到其他地方发来的更优质的BPDU，就将那个区域置为inconsistent。注意inconsistent跟err-disable的区别是，err-disable会disable整个接口，而inconsistentport是针对特定的vlan的。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">只会屏蔽当前VLAN(发给我更优的BPDU)</span><br><span class="line">spanning-tree guard root<span class="comment"># 接口上配置root防护，这个端口就不可以成为根段偶</span></span><br><span class="line">show span inconsistentport <span class="comment"># 查看接口</span></span><br></pre></td></tr></table></figure><h2 id="6、LoopGuard"><a href="#6、LoopGuard" class="headerlink" title="6、LoopGuard"></a>6、LoopGuard</h2><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_12.png" alt="image-20200209191229933" style="zoom: 67%;" /><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree guard loop <span class="comment">#接口上配置loop防护，这个端口就可以检测单向通行故障</span></span><br></pre></td></tr></table></figure><h1 id="单臂路由"><a href="#单臂路由" class="headerlink" title="单臂路由"></a>单臂路由</h1><p>单臂路由，路由器只有一条线连接，是三层交换机的替代品。其主要缺点就是三层交换机的优点：</p><ol><li>故障多，路由器的故障， 交换机的故障，路由器到交换机只有一条链路，单点故障</li><li>带宽有限，如果是三层交换机，则三层交换机中的路由器和交换机传输速率几乎无限</li></ol><p>`</p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_13.png" alt="image-20200209192447894"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">R1</span><br><span class="line">int e0/0</span><br><span class="line">no sh</span><br><span class="line">int e0/0.10</span><br><span class="line">encapsulation dot1Q 10</span><br><span class="line">ip add 192.168.10.254 255.255.255.0</span><br><span class="line">int e0/0.20</span><br><span class="line">encapsulation dot1Q 20</span><br><span class="line">ip add 192.168.20.254 255.255.255.0</span><br><span class="line">end</span><br><span class="line">sh int e0/0.10</span><br><span class="line"></span><br><span class="line"><span class="comment">#sw</span></span><br><span class="line">int e0/1</span><br><span class="line">sw tr en <span class="keyword">do</span> </span><br><span class="line">sw mo tr</span><br><span class="line">end</span><br><span class="line"><span class="comment">#交换机还要反应一会，从LIS-LRN-FWD</span></span><br><span class="line"></span><br><span class="line">此时，R2 Ping R3</span><br></pre></td></tr></table></figure><h1 id="三层交换"><a href="#三层交换" class="headerlink" title="三层交换"></a>三层交换</h1><p>三层交换就相当于二层交换加了一台路由器在上面，可以实现更加灵活的网络流量路由管控。</p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_14.png" alt="image-20200209194011387"></p><p>现在R2处于vlan10，R3处于vlan20，想要R2 ping通R3 ，在SW上进行配置：</p><p>1、 配置接口 vlan 10，添加属于R2网段额IP地址</p><p>2、配置接口 vlan 20， 添加属于R3网段的IP地址</p><p>3、在R2和R3上配置默认路由</p><p>4、 然后就会发现，R2可以直接ping通R3了</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#SW</span></span><br><span class="line">int vlan 10<span class="comment">#启用SVI接口，Lay3SW的交换机接口是虚拟的</span></span><br><span class="line">ip add 192.168.10.254 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">end</span><br><span class="line">sh ip int bri</span><br><span class="line"></span><br><span class="line">int vlan 20</span><br><span class="line">ip add 192.168.20.254 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">end</span><br><span class="line">sh ip int bri</span><br><span class="line"></span><br><span class="line"><span class="comment">#R，一定要记得配默认路由</span></span><br><span class="line">ip route 0.0.0.0 255.255.255.255 Ethernet0/0</span><br></pre></td></tr></table></figure><p>SVI(switch virtual interface) 交换虚拟接口的Line-State在以下条件满足的情况下，才会是UP</p><ul><li>SVI对应的VLAN必须在<code>vlan database</code>中存在并且是激活的——vlan存在且激活</li><li><code>vlan interface</code>存在并且不能是<code>down</code>状态——路由器接口up</li><li>必须至少有一个二层接口是UP的，而且必须是Spanning-tree的FWD状态——二层交换机接口up</li></ul><h1 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h1><ul><li>Dynamic Host Configuration Protocal</li><li>基于UDP协议端口67及68</li><li>bootPC：67（客户端端口号）；bootPS：68（服务端端口号）</li></ul><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_15.png" alt="image-20200210154539047"></p><p>这四条消息全部都是广播。</p><p>配置DHCP</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(config-if)<span class="comment"># ip dhcp pool cisico</span></span><br><span class="line">(dhcp-config)<span class="comment"># network 192.168.1.0/24</span></span><br><span class="line">(dhcp-config)<span class="comment"># default-router 192.168.1.1# 默认路由器</span></span><br><span class="line">(dhcp-config)<span class="comment"># dns-server 114.114.114.114 114.114.115.115# DNS</span></span><br><span class="line">(dhcp-config)<span class="comment"># lease 1-租约时间1天</span></span><br><span class="line">(config)<span class="comment"># ip dhcp excluded-address 192.168.1.1    # 排除掉我们用的地址</span></span><br><span class="line"></span><br><span class="line">还有一种写法：1~99不分配</span><br><span class="line">ip dhcp excluded-address 192.168.1.1 192.168.1.99</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#局域网的其他设备</span></span><br><span class="line">(config)<span class="comment"># ip add dhcp</span></span><br><span class="line">  </span><br><span class="line">sh ip dhcp bingding<span class="comment">#查看DHCP的IP地址的绑定</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#绑定IP地址</span></span><br><span class="line">ip dhcp pool R1</span><br><span class="line">host 192.168.1.10</span><br><span class="line">client-identifier [client-id]</span><br><span class="line"><span class="comment">#如果client_id已被使用，则清楚</span></span><br><span class="line">clear ip dhcp <span class="built_in">bind</span> *</span><br></pre></td></tr></table></figure><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_16.png" alt="image-20200210160941108"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#跨越路由器的广播DHCP请求</span></span><br><span class="line">R4是DHCP服务器，R1想要请求DHCP的广播不能跨越R3，这是可以在R3上进行配置，如果收到请求DHCP的报文，则用单播的形式将消息发送给R4</span><br><span class="line">R3</span><br><span class="line">int e0/1</span><br><span class="line">ip helper-address 192.168.34.4</span><br></pre></td></tr></table></figure><h1 id="链路捆绑"><a href="#链路捆绑" class="headerlink" title="链路捆绑"></a>链路捆绑</h1><p>如果直接连接两个交换机，则会因为有spanning-tree，造成无论链接多少线，都只会有一根通，从而带宽得不到提高。链路捆绑最大支持8根线绑在一起，这里只介绍二层捆绑，三层捆绑要在接口上<code>no switchport</code>，然后再配置IP地址</p><p>EC：需要对端交换机都配</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int range e0/1 -2</span><br><span class="line">channel-group 1 mode on</span><br><span class="line"></span><br><span class="line">此时再看生成树，就会发现e0/1和e0/2都消失了，只留下了Po1，查看带宽，也变大了。</span><br><span class="line"></span><br><span class="line">配置Trunk</span><br><span class="line">int port-channel 1 </span><br><span class="line">sw tr en <span class="keyword">do</span> </span><br><span class="line">sw mo tr</span><br><span class="line"></span><br><span class="line">查看channel</span><br><span class="line">sh etherchannel [summary]</span><br></pre></td></tr></table></figure><p>修改负载均衡的方式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">port-channel load-balance [] <span class="comment"># src-dst-mac</span></span><br><span class="line"><span class="comment">#二层不能用IP地址</span></span><br><span class="line">show etherchannel loadbalance</span><br></pre></td></tr></table></figure><h1 id="首跳冗余协议"><a href="#首跳冗余协议" class="headerlink" title="首跳冗余协议"></a>首跳冗余协议</h1><p>FHRP：first hop redundancy protocal，用于配置多个网关，配在多个朝内的接口上。常用的FHRP协议有：</p><ol><li>HSRP</li><li>VRRP</li><li>GLBP</li></ol><h2 id="HSRP"><a href="#HSRP" class="headerlink" title="HSRP"></a>HSRP</h2><p>其中以VRRP最常见，HSRP是Cisco私有的，GLBP有Bug。</p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_17.png" alt="image-20200210170625634"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@不让R2和R3建立邻居</span><br><span class="line">R2<span class="comment"># passive-interface e0/1</span></span><br><span class="line">R3<span class="comment"># passive-interface e0/1 </span></span><br><span class="line"></span><br><span class="line">@配置网关,R4网关指向的地址不存在</span><br><span class="line">R4<span class="comment"># ip route 0.0.0.0 0.0.0.0 192.168.1.254</span></span><br><span class="line"></span><br><span class="line">@在R2,R3上配置standby ip 监听一个虚拟的IP</span><br><span class="line">int e0/1</span><br><span class="line">standby 1 ip 192.168.1.254</span><br><span class="line"></span><br><span class="line">sh standby brief <span class="comment">#查看standby的缩略信息</span></span><br><span class="line"></span><br><span class="line">- standby 会向组播地址发送信息</span><br><span class="line">- R2、R3会发现彼此，通过IP地址选出一个人来做网关</span><br><span class="line"></span><br><span class="line"><span class="comment">#上图是交换机，实际上交换机不行，需要换成集线器</span></span><br></pre></td></tr></table></figure><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_18.png" alt="image-20200210171831381"></p><p>这个IP地址是规定死的，最后一位表示standby 1 </p><p>HSRP状态机</p><table><thead><tr><th>State</th><th>说明</th></tr></thead><tbody><tr><td>Initial</td><td>初始化接口状态，当接口UP时，或者某些配置变更时会有的状态</td></tr><tr><td>Learn</td><td>接口未设定虚拟IP（但激活了HSRP，用standby ip），等待从Active路由器学习到该组的虚拟IP</td></tr><tr><td>Listen</td><td>路由器已经获知虚拟IP，开始侦听其他同组HSRP路由器的HELLO消息</td></tr><tr><td>Speak</td><td>发送周期性的Hello消息同时参与Active/Standby选举</td></tr><tr><td>Standby</td><td>成为Standby路由器，同时周期性的发送Hello，持续侦听Active路由器的Hello消息，以便在其失效后接替位置</td></tr><tr><td>Active</td><td>成为Active路由器，响应PC对于虚拟IP的ARP请求，同时周期性发送Hello消息，宣告自己的存货状态。</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(config-if)<span class="comment"># standby 1 preempt#打开抢占</span></span><br><span class="line">(config-if)<span class="comment"># standby 1 priority 110#调高优先级</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@有一种情形</span><br><span class="line">@R2的上游支路shutdown了，但是因为R2的优先级比R3大，R4发包还是选择R2，但是却不能ping通R4</span><br><span class="line">---</span><br><span class="line">@如果R2上面的接口shutdown，则把R2的优先级降低20，这样Standby就被R3抢走</span><br><span class="line">(config)<span class="comment"># track 1 interface e0/0 line-protocol#在接口的协议上设置一个追踪 </span></span><br><span class="line">(config)<span class="comment"># int e0/1</span></span><br><span class="line">(config-if)<span class="comment"># standby 1 track 1 decrement 20#如果接口shutdown，则将优先级-20，会在show standby上显示详细条目</span></span><br></pre></td></tr></table></figure><h2 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h2><p>VRRP和HSRP不一样的地方</p><ul><li>在Cisco上抢占模式不一样，VRRP默认开启</li><li>MAC地址不一样，就是开头的固定格式不一样</li><li>Hello包发送的周期不一样，HSRP是3s-10s，而VRRP 1s一个Hello包，3s收不到就挂了</li><li>激活的状态不一样，一个是backup，一个是active，其他地方一样</li></ul><h2 id="GLBP"><a href="#GLBP" class="headerlink" title="GLBP"></a>GLBP</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_19.png" alt="image-20200210175204079"></p><p>AVG生成一堆虚拟的mac地址分发给局域网里面的路由器（假设有路由器A、B、C），此时有PC1来请求mac地址上网(这个mac地址是默认网关的mac，不是pc自己的mac)，AVG会挑选一台路由器B给它，又有PC2来请求上网，AVG挑选路由器C给它，又有PC3，路由器把A给它。如果路由器B坏了，则重新分配给其他路由器，如果AVG坏了，则路由器重新选举新的AVG。IP地址大则为AVG</p><p>所以GLBP抢占的是AVG，而其他的则是抢占干活的机会。</p><p>GLBP、VRRP、HSRP配置命令都差不多。</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;div style=&quot;color:red&quot;&gt;淦，实在不知道用什么封面了，网上关于Lay2 Lay3 Switch都巨丑，用自己正在打字的电脑做封面吧^_^??&lt;/div&gt;
&lt;br&gt;

&lt;p&gt;交换技术主要用于构建局域网，主要实现的局域网内的通信和隔离。交换机即插即用，因为所有的接
      
    
    </summary>
    
    
      <category term="路由技术" scheme="http://ymlog.cn/categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>Ansible</title>
    <link href="http://ymlog.cn/2020/02/24/Ansible/"/>
    <id>http://ymlog.cn/2020/02/24/Ansible/</id>
    <published>2020-02-24T06:00:36.000Z</published>
    <updated>2020-06-25T09:17:00.143Z</updated>
    
    <content type="html"><![CDATA[<p>休言万事转头空。未转头时皆梦。</p><a id="more"></a><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>运维自动化发展历程：</p><p><img src="https://i.loli.net/2020/03/22/hcW185nwFNRlPGg.png" alt="ansible_1.png"></p><p>内容</p><ul><li>运维自动化发展历程及技术</li><li>Ansible命令使用</li><li>Ansible常用模块详解</li><li>YAML语法简介</li><li>Ansible playbook基础</li><li>Playbook变量、tags、handlers使用</li><li>Playbook模板templates</li><li>Playbook条件判断when</li><li>Playbook字段with_items</li><li>Ansible Roles</li></ul><p>自动化运维应用场景：</p><ul><li>文件传输</li><li>命令执行：<ul><li>应用部署</li><li>配置管理</li><li>任务流编排</li></ul></li></ul><p>ansible特性：</p><ul><li>模块化，有Paramiko、PyYAML、Jinja2(模板语言)三个关键模块</li><li>支持自定义模块</li><li>基于Python语言实现</li><li>部署简单，基于python和SSH，agentless</li><li>安全，基于OpenSSH</li><li>支持playbook编排任务</li><li>幂等性：一个任务执行1遍和执行n遍的效果是一样的</li><li>无需代理，不依赖PKI(无需SSL)</li><li>支持其他语言写模块</li><li>YMAL格式，编排任务，支持丰富的数据结构</li><li>较强大的多层解决方案</li></ul><p>常用的自动化运维工具：</p><ul><li>Ansible：python，Agentless，中小型应用环境</li><li>Saltstack：python，一般需要部署agent，执行效率更高</li><li>Puppent：ruby，功能强大，配置复杂，重型适合大型环境</li><li>Fabric：python，agentless</li><li>Chef：ruby，国内少</li></ul><p>ansible架构</p><p><img src="https://i.loli.net/2020/03/22/TGimzcIVUPE9KsN.png" alt="ansible_2.png"></p><ul><li>Ansible Playbooks：任务剧本，编排定义Ansible任务集的配置文件，由ANSI不了顺序依次执行，通常是JSON格式的YML文件</li><li>Inventory：ANSI不了u案例主机清单/etc/anaible/hosts</li><li>Modules：Ansible执行命令的功能模块，多数为内置核心模块，可以自定义</li><li>Plugins：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li><li>API：供第三方程序调用的应用程序编程接口</li><li>Ansible：组合Inventory、API、Modules</li><li>Plugins的绿框，可以理解为是ansible命令工具</li></ul><h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ol><li><p>yum安装</p> <figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure></li><li><p>git安装</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ansible/ansible.git</span><br><span class="line"><span class="built_in">cd</span> ./ansible</span><br><span class="line"><span class="built_in">source</span> ./hacking/env-setup</span><br></pre></td></tr></table></figure></li><li><p>pip安装</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install python-pip python-devel</span><br><span class="line">yum -y install gcc glibc-devel zibl-devel rpm-bulid openssl-devel</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ansible --upgrade</span><br></pre></td></tr></table></figure></li><li><p>确认安装</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible --version</span><br></pre></td></tr></table></figure></li></ol><h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p><strong>相关文件</strong></p><p>配置文件</p><ul><li>/etc/ansible/ansible.cfg：主配置文件，配置ansible工作特性</li><li>/etc/ansible/hosts：主机清单</li><li>/etc/ansible/roles：存放角色目录</li></ul><p>程序</p><ul><li>/usr/bin/ansible： 主程序，临时命令执行工具</li><li>/usr/bin/ansible-doc：查看配置文档，模块功能查看工具</li><li>/usr/bin/ansible-galaxy：下载/上传优秀代码或Role模块的官网平台</li><li>/usr/bin/ansible-playbook：定制自动化任务，编排剧本工具/usr/bin/ansible-pull：远程执行命令工具</li><li>/usr/bin/ansible-value：文件加密工具</li><li>/usr/bin/ansible-console：基于Console界面于用户交互的执行工具</li></ul><p>ansible命令</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible </span><br><span class="line">ansible-doc</span><br><span class="line">ansible-playbook</span><br><span class="line">ansible-valut</span><br><span class="line">ansible-console</span><br><span class="line">ansible-galaxy</span><br><span class="line">ansile-pull</span><br></pre></td></tr></table></figure><p>配置文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># vim /etc/ansible/ansible.cfg</span></span><br><span class="line">[defaults]</span><br><span class="line"><span class="comment">#inventory      = /etc/ansible/hosts#主机列表配置文件</span></span><br><span class="line"><span class="comment">#library        = /usr/share/my_modules/#库文件存放目录</span></span><br><span class="line"><span class="comment">#remote_tmp     = ~/.ansible/tmp#临时py命令文件存放在远程主机目录</span></span><br><span class="line"><span class="comment">#local_tmp      = ~/.ansible/tmp#本机的临时命令执行目录</span></span><br><span class="line"><span class="comment">#forks          = 5#默认并发数</span></span><br><span class="line"><span class="comment">#poll_interval  = 15</span></span><br><span class="line"><span class="comment">#sudo_user      = root#默认sudo用户</span></span><br><span class="line"><span class="comment">#ask_sudo_pass = True#每次执行ansible命令是否询问ssh密码</span></span><br><span class="line"><span class="comment">#ask_pass      = True</span></span><br><span class="line"><span class="comment">#remote_port    = 22</span></span><br><span class="line"><span class="comment">#log_path = /var/log/ansible.log#日志文件，默认不记录。如果想打开日志记录，可以取消注释</span></span><br><span class="line"><span class="comment">#host_key_checking = False#检查对应服务器的host_key，建议取消注释，取消完ssh可以不敲yes</span></span><br></pre></td></tr></table></figure><p>其中<code>remote_tmp</code>和<code>local_tmp</code>用于执行ansible脚本，当用户在ansible主机上发送命令时，ansible会把命令记录在本地的<code>~/.ansible/tmp/</code>目录，然后发送到受控主机的<code>~/.ansible/tmp</code>目录进行执行，并把执行结果返回给ansible主机。</p><p>ansible配置文件改动不需要用systemctl重启，因为ansible不是以服务的形式长驻内存的，它是用的时候临时调出。</p><h1 id="Ad-Hoc"><a href="#Ad-Hoc" class="headerlink" title="Ad-Hoc"></a>Ad-Hoc</h1><p>ansible命令执行过程</p><ol><li>加载自己的配置文件，默认/etc/ansible/ansible.cfg</li><li>加载自己对应的模块文件，如command</li><li>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-Nbr/XXX.py文件</li><li>给文件+x执行</li><li>执行并返回结果</li><li>删除py文件，sleep 0 退出</li></ol><p>可以使用<code>ansible all -m ping -vvv</code>来展示详细过程</p><p>颜色说明</p><ul><li>红色：执行失败</li><li>绿色：成功，对目标系统没有做任何修改</li><li>黄色：成功，对目标系统做出变更</li><li>在/etc/ansible/ansible.cfg中的[colors]有说明</li></ul><p>ansible用法</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># ansible --help</span></span><br><span class="line">usage: ansible &lt;host-pattern&gt; [-m module_name] [-a args]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  --ask-vault-pass      ask <span class="keyword">for</span> vault password</span><br><span class="line">  --list-hosts          列出主机列表，如：ansible webserver --list-all</span><br><span class="line">  -a MODULE_ARGS, --args 追加模块参数</span><br><span class="line">  -f FORKS连接并发数，默认是5</span><br><span class="line">  -t TREE, --tree TREE  <span class="built_in">log</span> output to this directory</span><br><span class="line">  -v, --verbose         显示详细过程，-vv，-vvv更详细</span><br><span class="line">  -K, --ask-become-pass 提示输入sudo密码</span><br><span class="line">  -b, --become          代替sudo切换</span><br><span class="line">  -T TIMEOUT, --timeout 执行命令的超时时间，默认10s</span><br><span class="line">  -k, --ask-pass        提示输入ssh连接密码，默认key验证</span><br><span class="line">  -u REMOTE_USER, --user 指定连接用户</span><br></pre></td></tr></table></figure><p>测试能否ping通另一台主机，这里的Ping不是用ICMP协议，而是用SSH协议</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先在主机列表里加入我们的主机</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192.168.70.20"</span> &gt;&gt; /etc/ansible/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192.168.70.30"</span> &gt;&gt; /etc/ansible/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192.168.70.40"</span> &gt;&gt; /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后再使用ping命令，如果能通，对方主机会回复一个pong</span></span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/03/22/AhLUw9Q7nbEaCZ6.png" alt="ansible_3.png"></p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 这里因为我在`192.168.70.30`上配置了key，所以立刻就能通。下面通过加参数k，来输入密码：</span></span><br><span class="line">ansible 121.36.70.55 -m ping -k</span><br><span class="line"></span><br><span class="line"><span class="comment">#多台主机，用逗号隔开</span></span><br><span class="line">ansible 192.168.70.20,192.168.70.30 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行所有主机</span></span><br><span class="line">ansible all -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过清单分类ping，清单分类见下文</span></span><br><span class="line">ansible dbserver -m ping</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/03/22/XYG6nQNSrlCcJ5m.png" alt="ansible_4.png"></p><p>主机清单分组</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[dbserver]</span><br><span class="line">192.168.70.30</span><br><span class="line">192.168.70.20</span><br><span class="line"></span><br><span class="line">[webserver]</span><br><span class="line">192.168.70.10</span><br><span class="line">192.168.70.40</span><br><span class="line"></span><br><span class="line">[appserver]</span><br><span class="line">192.168.70.[1:3]</span><br><span class="line"><span class="comment">#等价于192.168.70.1, 192.168.70.2, 192.168.70.3</span></span><br></pre></td></tr></table></figure><h1 id="doc"><a href="#doc" class="headerlink" title="doc"></a>doc</h1><p>ansible-doc用法</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># ansible-doc：显示模块帮助</span></span><br><span class="line">ansible-doc [option] [module...]</span><br><span class="line">-a显示所有模块的文档</span><br><span class="line">-l,--list列出可用模块</span><br><span class="line">-s,--<span class="variable">$nippet</span>显示指定模块的playbook片段</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：</span></span><br><span class="line"> </span><br><span class="line">ansible-doc -l <span class="comment">#列出所有模块</span></span><br><span class="line">ansible-doc ping<span class="comment">#查看ping模块的帮助文档</span></span><br><span class="line">ansible-doc -s ping<span class="comment">#查看ping模块的简略信息</span></span><br></pre></td></tr></table></figure><p>用ansible执行命</p><ul><li>ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理的节点</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 查看dbserver组里的用户家目录</span></span><br><span class="line">[root@node01 ~]<span class="comment"># ansible dbserver -u root -m command -a 'ls /root'</span></span><br><span class="line">192.168.70.30 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line">192.168.70.20 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br></pre></td></tr></table></figure><p>普通用户在ansible执行自己主机root权限</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#首先在node02上添加普通用户dzq，密码000000，然后追加扩展组到wheel便于执行sudo权限</span></span><br><span class="line">[root@node02 ~]<span class="comment"># useradd dzq</span></span><br><span class="line">[root@node02 ~]<span class="comment"># passwd dzq</span></span><br><span class="line">更改用户 dzq 的密码 </span><br><span class="line">新的 密码：000000</span><br><span class="line">无效的密码： 密码是一个回文</span><br><span class="line">重新输入新的 密码：000000</span><br><span class="line">passwd：所有的身份验证令牌已经成功更新。</span><br><span class="line">[root@node02 ~]<span class="comment"># visudo</span></span><br><span class="line">[root@node02 ~]<span class="comment"># usermod -aG wheel dzq</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#然后到node01上执行</span></span><br><span class="line">[root@node01 ~]<span class="comment"># ansible 192.168.70.20 -u dzq -m command -a 'ls /root' -k -K -b</span></span><br><span class="line">SSH password: 000000</span><br><span class="line">BECOME password[defaults to SSH password]: 000000</span><br><span class="line">192.168.70.20 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># visudo带颜色</span></span><br><span class="line">[root@node02 ~]<span class="comment"># echo export EDITOR=vim &gt;&gt; /etc/profile.d/env.sh</span></span><br><span class="line">[root@node02 ~]<span class="comment"># source /etc/profile.d/env.sh</span></span><br></pre></td></tr></table></figure><h1 id="hosts"><a href="#hosts" class="headerlink" title="hosts"></a>hosts</h1><p>主机清单</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 匹配主机的列表</span></span><br><span class="line">1、All：表示有Inventory中的所有主机</span><br><span class="line">2、通配符 *</span><br><span class="line">3、或关系 :</span><br><span class="line">4、与关系</span><br><span class="line">5、逻辑非</span><br><span class="line">6、综合逻辑</span><br><span class="line">7、正则表达式</span><br><span class="line"></span><br><span class="line">演示：</span><br><span class="line">1、ansible all -m ping</span><br><span class="line">2、ansible 192.168.70.* -m ping</span><br><span class="line">3、ansible <span class="string">"webserver:appserver"</span> -m ping</span><br><span class="line">4、ansible <span class="string">'webserver:&amp;appserver'</span> -m ping</span><br><span class="line">5、ansible <span class="string">'webserver:!appserver'</span> -m ping</span><br><span class="line">6、ansible <span class="string">'webserver:appserver:&amp;dbserver:!ftpserver'</span> -m ping</span><br><span class="line">7、ansible <span class="string">'~(web|db).*\.server'</span> -m ping</span><br></pre></td></tr></table></figure><h1 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h1><ul><li><p>Command：在远程主机上执行命令，默认模块，可忽略-m选项</p><blockquote><p>ansible node24 -m command -a ‘systemctl restart sshd’</p><p>ansible node24 -m command -a ‘echo 000 | passwd –stdin dzq’  【不成功】</p><p>此模块不支持 $VARNAME &lt;  &gt; | ; $ $ 等，应该用shell模块实现</p></blockquote></li><li><p>Shell：和command相似，用shell执行命令</p><blockquote><p>ansible node24 -m shell -a ‘echo 000 | passwd –stdin dzq’</p><p>调用bash执行命令，类似`cat /etc/passwd | awk -F ‘:’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt这些复杂的命令，即使使用shell也可能会失败，解决办法：写到脚本里，copy到远程执行，再把所需要的结果拉回执行命令的机器</p></blockquote></li><li><p>Script：运行脚本呢</p><blockquote><p>-a “/PATH/TO/SCRIPT_FILE”</p><p>ansible node24 -m script -a f1.sh</p></blockquote></li><li><p>Copy：把服务器上的文件复制到受控端</p><blockquote><p>如果目标存在，默认覆盖，此处指定先备份</p><p>ansible all -m copy -a ‘src=/etc/selinux/config dest=/etc/selinux/config backup=yes owner=dzq mode=000’</p><p>利用内容直接生成目标文件</p><p>ansible all -m copy -a ‘content=’hello world’ dest/tmp/1.txt’</p></blockquote></li><li><p>Fetch：从客户端取文件至服务器端</p><blockquote><p>ansible node23 -m file -a ‘src=/root/a.sh dest=/tmp/‘</p></blockquote></li><li><p>File：设置文件属性</p><blockquote><p>ansible node23 -m file -a ‘path=/root/a.sh owner=dzq mode=755’</p><p>ansible node23 -m file -a ‘src=/app/testfile dest=/app/testfile-link state=link’</p><p>创建文件</p><p>ansible node23 -m file -a ‘path=’/root/f1.txt’ state=touch’</p><p>删除文件</p><p>ansible node23 -m file -a ‘path=’/root/f1.txt’ state=absent’</p><p>创建软连接</p><p>ansible node23 -m file -a ‘src=/etc/ssh/sshd_config dest=/root/ssh_link state=link’</p></blockquote></li><li><p>Hostname：管理主机名</p><blockquote><p>更改主机名</p><p>ansible 192.168.70.20 -m hostname -a ‘name=node02’</p></blockquote></li><li><p>Cron：计划任务</p><blockquote><p>支持时间：minute、hour、day、month、weekday</p><p>创建任务：</p><p>ansible node24 -m cron -a ‘minute=* weekday=1,3,5 job=”/usr/bin/wall FBI warning” name=warnning’</p><p>禁用任务：</p><p>ansible node24 -m cron -a ‘disabled=trued job=”/usr/bin/wall FBI warning” name=warnning’</p><p>删除任务：</p><p>ansible node24 -m cron -a ‘job=”/usr/bin/wall FBI warning” name=warnning state=absent’</p></blockquote></li><li><p>Yum：管理包</p><blockquote><p>安装</p><p>ansible node24 -m yum -a ‘name=httpd state=latest’</p><p>删除</p><p>ansible node24 -m yum -a ‘name=httpd state=absent’</p></blockquote></li><li><p>Service：管理服务</p><blockquote><p>安装FTP服务启动，并设置开启自启</p><p>ansible node24 -m service -a ‘name=vsftpd state=started enabled=yes’</p><p>ansible srv -m service -a ‘name=httpd state=stoped’</p><p>ansible srv -m service -a ‘name=httpd state=started’</p><p>ansible srv -m service -a ‘name=httpd state=reloaded’</p><p>ansible srv -m service -a ‘name=httpd state=restart’</p></blockquote></li><li><p>User：管理用户</p><blockquote><ol><li>ansible srv -m user -a ‘name=user1 commment=”test user” uid=2048 home=/app/user1” group=root’</li><li>ansible srv -m user -a ‘name=sysuser1 system=yes home=/app/sysuser1’</li><li>ansible srv -m user -a ‘name=user1 state=absent remove=yes’    #删除用户家目录</li></ol></blockquote></li><li><p>Group：管理组</p><blockquote><p>ansible srv -m group -a ‘name=testgroup system=yes’</p><p>ansible srv -m group -a ‘name=testgroup state=absent’</p></blockquote></li></ul><h1 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a>ansible-galaxy</h1><ul><li>连接<a href="https://galaxy.ansible.com下载相应的roles" target="_blank" rel="noopener">https://galaxy.ansible.com下载相应的roles</a></li><li>列出已安装的galaxy：ansible-galaxy list</li><li>安装galaxy：ansible-galaxy install username.rolename</li><li>删除galaxy：ansible-galaxy remove username.rolename</li></ul><h1 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a>ansible-vault</h1><p>加密解密playbook</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#解密</span></span><br><span class="line">ansible-vault encrypt hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密</span></span><br><span class="line">ansible-vault decrypt hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密后查看文件</span></span><br><span class="line">ansible-vault view hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密后编辑文件</span></span><br><span class="line">ansible-vault eidtor hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新设置口令</span></span><br><span class="line">ansible-vault rekey hello.yml</span><br></pre></td></tr></table></figure><h1 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h1><p>ansible交互式控制台</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-console</span><br><span class="line">root@node24 (2)[f:5]$ forks 3</span><br><span class="line">root@node24 (2)[f:3]$ <span class="built_in">cd</span> node23</span><br><span class="line">root@node23 (2)[f:3]$ ?<span class="comment">#查看有哪些命令</span></span><br><span class="line">root@node23 (2)[f:3]$ <span class="built_in">command</span> hostname<span class="comment">#执行命令：模块名/命令</span></span><br><span class="line">192.168.70.20 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">node02</span><br><span class="line"></span><br><span class="line">192.168.70.30 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">node03</span><br><span class="line"></span><br><span class="line">root@node23 (2)[f:3]$ service name=httpd state=start</span><br></pre></td></tr></table></figure><h1 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h1><ul><li>playbook是由多个play组成的列表</li><li>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让他们联通起来按实现编排的机制同唱一台大戏</li><li>playbook采用yaml语言编写</li></ul><p><img src="https://i.loli.net/2020/03/22/xUsH46CJcwtF9MI.png" alt="ansible_5.png"></p><h2 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h2><ul><li>Hosts：执行的远程主机列表</li><li>Tasks：任务集</li><li>Varniables：内置变量或自定义变量在playbook中调用</li><li>Templates：模板，可替换模板文件的变量并实现一些简单逻辑文件</li><li>Handlers和Notity结合使用，由特定条件出发的操作，满足条件方才执行，否则不执行</li><li>tags：标签，指定某条任务执行，用于选择运行playbook中的部分代码，ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有变化的时间依然会非常长，此时如果确信没有其他变化，可以就通过tags跳过此代码片段</li></ul><p>playbook常见选项</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">ansible-playbook file.yml --list-hosts<span class="comment">#列出playbook中的主机</span></span><br><span class="line">ansible-playbook file.yml --list-tasks<span class="comment">#列出playbook中的任务</span></span><br><span class="line">ansible-playbook file.yml --<span class="built_in">limit</span> node23<span class="comment">#限制任务执行的主机</span></span><br><span class="line">ansible-playbook -C file.yml<span class="comment">#检查yaml语法</span></span><br></pre></td></tr></table></figure><h2 id="hosts-1"><a href="#hosts-1" class="headerlink" title="hosts"></a>hosts</h2><p>playbook中每个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务，hosts用于指定要执行任务的主机，须事先定义在主机清单中。</p><p>可以是如下形式</p><blockquote><p>one.example.com</p><p>one.example.com:two.example.com</p><p>192.168.1.2</p><p>192.168.1.*</p><p>webserver:dbserver:&amp;appserver</p><p>示例：</p><ul><li>host: webserver</li></ul></blockquote><p>检查playbook语法：ansbile-playbook -C file.yml</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">- hosts:</span> <span class="string">websrvs</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">new</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/data/newfile</span> <span class="string">state=touch</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">new</span> <span class="string">user</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">name=test3</span> <span class="string">state=present</span> <span class="string">system=yes</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=installed</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">html</span></span><br><span class="line"><span class="attr">      copy:</span> <span class="string">src=/var/www/html/index.html</span> <span class="string">dest=/var/www/html/</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><h2 id="tasks"><a href="#tasks" class="headerlink" title="tasks"></a>tasks</h2><p>task列表和action</p><ul><li>play的主体部分是task list。task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后再开始第二个。在运行自上而下某playbook，如果中途发生错误，所有已执行任务都将回滚，因此，在更正playbook后重新执行一次即可</li><li>task的目的是使用指定参数执行模块，而在模块参数中可以使用变量，模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</li><li>每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤，如果未提供name，则action的结果将用于输出</li></ul><p>action格式：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(1) action: module arguments</span><br><span class="line">(2) module: arguments</span><br></pre></td></tr></table></figure><p>脚本错误继续执行</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">(1)</span><br><span class="line">task:</span><br><span class="line">-name: run this <span class="built_in">command</span> and ignore the result</span><br><span class="line"> shell: /usr/bin/comnands || /bin/<span class="literal">true</span></span><br><span class="line"> </span><br><span class="line">(2)</span><br><span class="line">tasks</span><br><span class="line">-name: run this <span class="built_in">command</span> and ignore the result</span><br><span class="line"> shell: /usr/bin/commands</span><br><span class="line"> ignore_errors: True</span><br></pre></td></tr></table></figure><h2 id="handlers-amp-notify"><a href="#handlers-amp-notify" class="headerlink" title="handlers &amp; notify"></a>handlers &amp; notify</h2><ul><li>Handlers：是task列表，这些task与前述的task没有本质上的不同，用于当关注资源发生变化时，才会采取一定的操作</li><li>Notify此Action可用于在每个play的最后被触发，这样可以避免多次有改变发生时，每次都执行指定操作，仅在所有的变化发生完后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作。</li></ul><p>一旦配置文件发生变化，服务重启</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#httpd服务</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- host:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/etc/httpd/conf/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span> <span class="string">backup=yes</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果copy config file改动，则触发handlers中的restart httpd service</span></span><br></pre></td></tr></table></figure><p>notify &amp; handler 多个的写法,用列表的形式呈现</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">- name:</span> <span class="string">config</span></span><br><span class="line"><span class="attr">  copy:</span> <span class="string">src=file/nginx.conf</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">  notify:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">handlers:</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">  <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enable=yes</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">  <span class="attr">shell:</span> <span class="string">killall</span> <span class="bullet">-0</span> <span class="string">nginx</span> <span class="string">&gt; /tmp/nginx.log</span></span><br></pre></td></tr></table></figure><h2 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h2><p>只执行标签内容，或者不执行标签内容</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment">#以下是不同的动作不同的标签，也可以多个动作公用一个标签</span></span><br><span class="line"><span class="attr">- host:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">install_httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">    <span class="attr">copy:</span> <span class="string">src=/etc/httpd/conf/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span> <span class="string">backup=yes</span></span><br><span class="line">    <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">    <span class="attr">tags:</span> <span class="string">restart_httpd</span></span><br><span class="line">    </span><br><span class="line"><span class="attr">  handlers:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ansible-playbook调用</span></span><br><span class="line"><span class="comment"># ansible-playbook -t install_httpd,restart_httpd httpd.yml</span></span><br></pre></td></tr></table></figure><h2 id="Varniables"><a href="#Varniables" class="headerlink" title="Varniables"></a>Varniables</h2><p>变量名：仅能由字母、下划线、数字组成，且只能以字母开头</p><p>变量来源：</p><ol><li><p>ansible setup facts    远程主机的所有变量都可以直接调用</p></li><li><p>在/etc/ansible/hosts中定义</p><blockquote><p>普通变量：主机组中主机单独定义，优先级高于公共变量</p><p>公共变量：针对主机中所有主机定义的统一变量</p></blockquote></li><li><p>通过命令行指定变量，优先级最高</p><blockquote><p>ansible-playbook -e ‘varname=value’ file.yml</p></blockquote></li><li><p>在playbook中定义</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">var1:</span> <span class="string">value1</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">var2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure></li><li><p>在role中定义</p></li></ol><p>优先级：命令行&gt;Playbook&gt;主机清单</p><p>命令行的变量赋值</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="attr">- host:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line"><span class="comment"># ansible-playbook -e 'pkgname=vsftpd' app.yml</span></span><br></pre></td></tr></table></figure><p>定义playbook中的变量</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- host:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pkgname1:</span> <span class="string">httpd</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">pkgname2:</span> <span class="string">vsftpd</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname1</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">    <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname2</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><p>在主机清单中定义变量</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 定义主机清单中的变量</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">[node23]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.30</span> <span class="string">Nbr=300</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.20</span> <span class="string">Nbr=200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在playbook中调用</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">node23</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">hostanem</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">name=www.&#123;&#123;</span> <span class="string">Nbr</span> <span class="string">&#125;&#125;ymlog.cn</span></span><br></pre></td></tr></table></figure><p>清单统一变量</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">[node23]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.30</span> <span class="string">Nbr=300</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.20</span> <span class="string">Nbr=200</span></span><br><span class="line"></span><br><span class="line"><span class="string">[node23:vars]</span></span><br><span class="line"><span class="string">nodename=www</span></span><br><span class="line"><span class="string">domainname=ymlog.cn</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">node23</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">hostanem</span></span><br><span class="line">    <span class="attr">hostname:</span> <span class="string">name=&#123;&#123;</span> <span class="string">nodename</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">Nbr</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">domainname</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h2 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h2><p>模板</p><ul><li><p>文本文件，嵌套有脚本</p></li><li><p>Jinja2语言，使用字面量，有下面形式：</p><blockquote><p>字符串：使用单引号或双引号</p><p>数字：整数、浮点数</p><p>列表：[item1,item2,…]</p><p>元组：{item1,item2,…}</p><p>字典：{key1:value1,key2:value2,….}</p><p>布尔型：true/false</p></blockquote></li><li><p>算术运算：+ ,- , * ,/ ,// , % ,**</p></li><li><p>比较操作：==, != ,&lt; , &lt;= ,&gt; ,&gt;=</p></li><li><p>逻辑运算：and、or、not</p></li><li><p>流表达式：For  If  When</p></li></ul><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=/root/.ansible/templates/nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><p>1、将Nginx的工作进程改为CPU核心数的二次方倍：修改templates的文件，原来templates/nginx.conf.j2的文件就是nginx.conf的配置文件。</p><p>先查看setup中的cpu变量用什么标识：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># ansible node24 -m setup | grep cpu</span></span><br><span class="line">        <span class="string">"ansible_processor_vcpus"</span>: 1, </span><br><span class="line">        <span class="string">"ansible_processor_vcpus"</span>: 1,</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;</span><br></pre></td></tr></table></figure><p>2、将node2的端口改为200，node3的端口改为300</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">192.168.70.30 Nbr=300</span><br><span class="line">192.168.70.20 Nbr=200</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       &#123;&#123; Nbr &#125;&#125; default_server;</span><br><span class="line">    listen       [::]:&#123;&#123; Nbr &#125;&#125; default_server;</span><br></pre></td></tr></table></figure><p>3、 when</p><ul><li><p>条件测试：如果需要根据变量、facts或此前任务执行结果来作为某task执行与否的前提时要用到条件测试，通过when语句实现，在task中使用，jinja2的语法格式</p></li><li><p>when语句</p></li><li><p>在task后添加when子句即可使用条件测试；when语句支持jinja2表达语法</p></li><li><p>示例：</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line">tasks:</span><br><span class="line">- name: &quot;shutdown RedHat Flavored Systems&quot;</span><br><span class="line">  command: &#x2F;sbin&#x2F;shutdown -h now</span><br><span class="line">  when: ansible_os_family &#x3D;&#x3D; &quot;Redhat&quot;</span><br></pre></td></tr></table></figure></li></ul><p>  当为7版的时候才复制文件</p>  <figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span></span><br><span class="line"><span class="attr">      template:</span> <span class="string">src=/root/.ansible/templates/nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line"><span class="attr">      when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line"><span class="attr">    - name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line"><span class="attr">      service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure><h2 id="with-item"><a href="#with-item" class="headerlink" title="with_item"></a>with_item</h2><p>迭代</p><p>1、新建多个文件</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">some</span> <span class="string">files</span></span><br><span class="line">    <span class="attr">file:</span> <span class="string">name=/data/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">file1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">file2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">file3</span></span><br></pre></td></tr></table></figure><p>2、迭代嵌套子变量</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line">    <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">group1</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">group2</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">group3</span></span><br><span class="line">    </span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">    <span class="attr">with_items:</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:'user1',group:</span> <span class="string">'group1'</span><span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:'user2',group:</span> <span class="string">'group2'</span><span class="string">&#125;</span></span><br><span class="line">    <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">name:'user',group:</span> <span class="string">'group3'</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure><p>for循环</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">templates.yml</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">81</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">82</span></span><br><span class="line">  <span class="bullet">-</span> <span class="number">83</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">conf</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=for1.conf.j2</span> <span class="string">dest/data/for1.conf</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">for1.conf.j2</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">port</span> <span class="string">in</span> <span class="string">ports</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">server&#123;</span></span><br><span class="line"><span class="string">listen</span> <span class="string">&#123;&#123;</span> <span class="string">port</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endfor</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">执行</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">all</span> <span class="string">templates.yml</span></span><br></pre></td></tr></table></figure><p>把列表换成字典</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">templates.yml</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars:</span></span><br><span class="line">  <span class="attr">ports:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">web1:</span> </span><br><span class="line">  <span class="attr">port:</span> <span class="number">81</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">www.web1.com</span></span><br><span class="line">  <span class="attr">rootdir:</span> <span class="string">/root/website1</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">82</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">www.web2.com</span></span><br><span class="line">  <span class="attr">rootdir:</span> <span class="string">/root/website2</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">web3:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">83</span></span><br><span class="line">  <span class="attr">name:</span> <span class="string">www.web3.com</span></span><br><span class="line">  <span class="attr">rootdir:</span> <span class="string">/root/website3</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">conf</span></span><br><span class="line">    <span class="attr">template:</span> <span class="string">src=for1.conf.j2</span> <span class="string">dest/data/for1.conf</span></span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">for1.conf.j2</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">p</span> <span class="string">in</span> <span class="string">ports</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">server&#123;</span></span><br><span class="line"><span class="string">listen</span> <span class="string">&#123;&#123;</span> <span class="string">p.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">servername</span> <span class="string">&#123;&#123;</span> <span class="string">p.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">documentroot</span> <span class="string">&#123;&#123;</span> <span class="string">p.rootdir&#125;&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endfor</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">执行</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">all</span> <span class="string">templates.yml</span></span><br></pre></td></tr></table></figure><p>if条件判断</p><figure class="highlight plain"><table><tr><td class="code"><pre><span class="line"># 如果p.name被定义了</span><br><span class="line">&#123;% if p.name is defined %&#125;</span><br><span class="line">do...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">do...</span><br></pre></td></tr></table></figure><h1 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h1><ul><li><p>YAML是一个可读性高的用来表达资料序列的格式，YAML参考了其他多种语言，包括XML、C、Python、Perl以及电子邮件格式RFC2822等，Clark Evans在2001年首次发表了这种语言。</p></li><li><p>YAML特性</p><ul><li>可读性好</li><li>和脚本语言的交互性好</li><li>使用实现语言的数据类型</li><li>有一个一致的信息模型</li><li>易于实现</li><li>可以基于流来处理</li><li>表达能力强，扩展性好</li></ul><p><a href="http://www.yaml.org" target="_blank" rel="noopener">http://www.yaml.org</a></p></li></ul><p>YAML语法简介</p><ol><li>在单一文件中，可以连续用三个连字号<code>-</code>区分多个档案，另外，还有选择性的连续三个点号(…)用来表示档案结尾</li><li>次行开始正常写playbook的内容，一般建议写明该Playbook的功能</li><li>使用#注释代码</li><li>缩进必须是统一的，不能空格和tab混用</li><li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别就是通过缩进 结合换行来实现的</li><li>YAML文件内容和Linux系统大小写判断方式保持一致，区分大小写，key/value值均需大小写敏感</li><li>key/value值可同行写也可以换行写，同行使用<code>:</code>分隔</li><li>value可以是字符串，也可以是另一个列表</li><li>一个完整的代码块功能需要最少元素包括name:task</li><li>一个name只能包含一个task</li><li>YAML文件扩展名通常为yml或yaml</li></ol><ul><li><p>LIST：列表</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># A List</span></span><br><span class="line">- blue</span><br><span class="line">- grenn</span><br><span class="line">- black</span><br><span class="line">- white</span><br><span class="line">- yellow</span><br></pre></td></tr></table></figure></li><li><p>DICTIONARY：字典</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># A Dictionay</span></span><br><span class="line">name: A</span><br><span class="line"><span class="built_in">jobs</span>: B</span><br><span class="line">skil: C</span><br><span class="line"></span><br><span class="line">&#123;name: A,Job: B,Skil: C&#125;</span><br></pre></td></tr></table></figure></li></ul><p>基础写法：在node24上创建文件</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: node24<span class="comment">#指定受控端</span></span><br><span class="line">  remote_user: root<span class="comment">#以什么身份登录受控端</span></span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello<span class="comment">#任务名，没什么意思</span></span><br><span class="line">      <span class="built_in">command</span>: touch /root/pl.test<span class="comment">#使用command模块执行命令</span></span><br></pre></td></tr></table></figure><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 把变量定义到一个文件中</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="attr">var1:</span> <span class="string">vsftpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用变量</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">webserver</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  vars_files:</span> </span><br><span class="line">  <span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">  tasks:</span></span><br><span class="line">  <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">    <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure><h1 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h1><ul><li><p>roles</p><blockquote><p>ansible自1.2版本引入的新特性，用于层次性、结构化组织playbook。roles能够根据层次型结构自动装载变量、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可，简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并且可以便捷的inlcude它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以用于构建 守护进程等场景中。</p></blockquote></li><li><p>复杂场景建议使用roles，代码复用性高</p><blockquote><p>某些功能需要多个playbook，通过includes即可实现</p></blockquote></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">roles目录结构</span><br><span class="line">----------------------------------------------</span><br><span class="line"><span class="comment"># 每个角色，以特定的层级目录结构进行组织</span></span><br><span class="line">playbook.yml</span><br><span class="line">roles/</span><br><span class="line">project/</span><br><span class="line">tasks/</span><br><span class="line">files/</span><br><span class="line">vars/</span><br><span class="line">default/</span><br><span class="line">templates/</span><br><span class="line">handlers/</span><br><span class="line">meta/</span><br></pre></td></tr></table></figure><p>各目录的作用：</p><ul><li>files/ ：存放由copy或script模块等调用的文件</li><li>templates/：template模块查找所需模板文件目录</li><li>tasks/：定义task，role的基本元素，至少应该包含一个名为main.yml的文件，其他的文件需要在此文件中通过include进行包含</li><li>handlers/：至少应该包含一个main.yml的文件；其他文件需要再次文件中通过include进行包含</li><li>vars/：定义变量，至少应该包含一个main.yml的文件；其他文件需要再次文件中通过include进行包含</li><li>meta/：定义当前角色的特殊设定及其依赖关系，至少应该包含一个名为main.yml的文件，其他文件需再此文件中通过include进行包含</li><li>default/：设定默认变量时，使用此目录中的mian.yml文件</li></ul><h1 id="Ansible搭建httpd"><a href="#Ansible搭建httpd" class="headerlink" title="Ansible搭建httpd"></a>Ansible搭建httpd</h1><p>安装httpd</p><p>1、目录结构</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">├── httpd_role.yml</span><br><span class="line">├──*roles</span><br><span class="line">│   └──*httpd</span><br><span class="line">│       ├──*tasks</span><br><span class="line">│       │   ├── group.yml</span><br><span class="line">│       │   ├── install.yml</span><br><span class="line">│       │   ├── main.yml</span><br><span class="line">│       │   ├── restart.yml</span><br><span class="line">│       │   ├── start.yml</span><br><span class="line">│       │   ├── templ.yml</span><br><span class="line">│       │   └── user.yml</span><br><span class="line">│       └──*templates</span><br><span class="line">│           └── httpd.conf.j2</span><br><span class="line"></span><br><span class="line">dir:roles,httpd,task,templates</span><br></pre></td></tr></table></figure><p>2、文件内容</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@node01 .ansible]<span class="comment"># cat httpd_role.yml </span></span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">        - role: httpd</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat group.yml </span></span><br><span class="line">- name: add group</span><br><span class="line">  group: name=httpd gid=110 system=yes</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat user.yml </span></span><br><span class="line">- name: add user</span><br><span class="line">  user: name=httpd uid=110 system=yes</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat install.yml </span></span><br><span class="line">- name: install httpd</span><br><span class="line">  yum: name=httpd</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat templ.yml </span></span><br><span class="line">- name: copy config</span><br><span class="line">  template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat start.yml </span></span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">templates下的文件就是复制的/etc/httpd/conf/httpd.conf，并改名为httpd.conf.j2</span><br></pre></td></tr></table></figure><p>调用别的角色的任务</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="attr">- include:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line"><span class="attr">- include:</span> <span class="string">roles/httpd/tasks/copyfile.yml</span></span><br></pre></td></tr></table></figure><p>调用多个角色、启用标签、判断语句</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">[root@node01</span> <span class="string">.ansible]#</span> <span class="string">cat</span> <span class="string">some.yml</span> </span><br><span class="line"><span class="attr">- hosts:</span> <span class="string">all</span></span><br><span class="line"><span class="attr">  remote_user:</span> <span class="string">root</span></span><br><span class="line"><span class="attr">  roles:</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">httpd,tags:['web','httpd'],when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span><span class="string">&#125;</span><span class="comment">#加判断</span></span><br><span class="line"><span class="attr">        - role:</span> <span class="string">nginx</span><span class="comment">#这里可以调用多个角色</span></span><br><span class="line"><span class="bullet">        -</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">vsftpd,tags:</span> <span class="string">['web','vsftpd'</span> <span class="string">]&#125;</span><span class="comment">#加标签</span></span><br></pre></td></tr></table></figure><p>标签执行</p><figure class="highlight yml"><table><tr><td class="code"><pre><span class="line"><span class="string">ansible-play</span> <span class="bullet">-t</span> <span class="string">vsftpd</span> <span class="string">some.yml</span></span><br></pre></td></tr></table></figure><h1 id="Ansible搭建Haproxy"><a href="#Ansible搭建Haproxy" class="headerlink" title="Ansible搭建Haproxy"></a>Ansible搭建Haproxy</h1><table><thead><tr><th>主机</th><th>IP</th><th>功能</th></tr></thead><tbody><tr><td>node01</td><td>192.168.70.10</td><td>ansible</td></tr><tr><td>node02</td><td>192.168.70.20</td><td>haproxy</td></tr><tr><td>node03</td><td>192.168.70.30</td><td>httpd</td></tr><tr><td>node04</td><td>192.168.70.40</td><td>httpd</td></tr></tbody></table><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">yum -y install ansible</span><br><span class="line">IP2="192.168.70.20"</span><br><span class="line">IP3="192.168.70.30"</span><br><span class="line">IP4="192.168.70.40"</span><br><span class="line"></span><br><span class="line">rm -rf /etc/ansible/hosts </span><br><span class="line">echo "[webs]" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "$IP3 SITE=web1" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "$IP4 SITE=web2" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "[lb]" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "$IP2" &gt;&gt; /etc/ansible/hosts </span><br><span class="line"></span><br><span class="line">rm -rf /root/.ansible/*</span><br><span class="line">mkdir -p /root/.ansible/roles/&#123;httpd,haproxy&#125;/&#123;tasks,templates&#125;</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/install.yml</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/templa.yml</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/start.yml</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/main.yml</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/install.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: install httpd</span><br><span class="line">  yum: name=httpd</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">echo "this is &#123;&#123; SITE &#125;&#125;" &gt;&gt; /root/.ansible/roles/httpd/templates/index.html.j2 </span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/templa.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: copy index.html</span><br><span class="line">  template: src=/root/.ansible/roles/httpd/templates/index.html.j2 dest=/var/www/html/index.html</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/start.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/main.yml &lt;&lt; 'EOF'</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: templa.yml</span><br><span class="line">- include: start.yml</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/install.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: install haproxy</span><br><span class="line">  yum: name=haproxy</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/templates/haproxy.cfg.j2 &lt;&lt; 'EOF'</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend  main *:8080</span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          if url_static</span><br><span class="line">    default_backend             app</span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">EOF</span><br><span class="line">echo -e "    server web1 $IP3:80 check" &gt;&gt; /root/.ansible/roles/haproxy/templates/haproxy.cfg.j2</span><br><span class="line">echo -e "    server web2 $IP4:80 check" &gt;&gt; /root/.ansible/roles/haproxy/templates/haproxy.cfg.j2   </span><br><span class="line">  </span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/templa.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: copy index.html</span><br><span class="line">  template: src=/root/.ansible/roles/haproxy/templates/haproxy.cfg.j2 dest=/var/www/html/index.html dest=/etc/haproxy/haproxy.cfg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/start.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: start service</span><br><span class="line">  service: name=haproxy state=started</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/main.yml &lt;&lt; 'EOF'</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: templa.yml</span><br><span class="line">- include: start.yml</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/lb_role.yml &lt;&lt; 'EOF'</span><br><span class="line">---</span><br><span class="line">- hosts: webs</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: httpd</span><br><span class="line"></span><br><span class="line">- hosts: lb</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: haproxy</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cd /root/.ansible/</span><br><span class="line">ansible-playbook -$1 lb_role.yml</span><br><span class="line">echo "Please Curl $IP2:8080"</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;p&gt;休言万事转头空。未转头时皆梦。&lt;/p&gt;
    
    </summary>
    
    
      <category term="中间件" scheme="http://ymlog.cn/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>OSPF协议</title>
    <link href="http://ymlog.cn/2020/02/23/OSPF%E5%8D%8F%E8%AE%AE/"/>
    <id>http://ymlog.cn/2020/02/23/OSPF%E5%8D%8F%E8%AE%AE/</id>
    <published>2020-02-23T07:00:39.000Z</published>
    <updated>2020-06-16T10:15:42.183Z</updated>
    
    <content type="html"><![CDATA[<h1 id="OSPF"><a href="#OSPF" class="headerlink" title="OSPF"></a>OSPF</h1><p><strong>距离矢量路由协议</strong></p><p>​    路由器相互之间只更新路由表信息，并且逐条更新，依照传闻的更新，任何一台路由器对路由表的更改，都将直接影响到下游。</p><p><strong>链路状态路由协议</strong></p><p>​    每台路由器都选择一个IP地址作为自己的名字，（Router-ID）</p><p>​    将自己的每个接口的网络信息，带宽信息进行描述，做成链路状态信息</p><p>​    将Router-ID和链路状态一起发送给自己的邻居，并且也帮助其他设备转发</p><p>​    最终会得到全网所有路由器的链路状态信息，通过分析可以得到全网拓扑图</p><p>​    使用最短路径算法（SPF），得到去往每个目的地的最短路线，得到路由表</p><h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul><li>ospf在Cisco设备中的管理距离为120</li><li>不使用传输层的TCP/UDP进行数据封装，更新消息直接放在网络层后，协议号为89</li><li>OSPF使用触发更新的机制，和邻居共享链路状态信息，而不是共享路由信息</li><li>OSPF有邻居的概念，使用Hello消息来建立和维护邻居，在以太网中，10s更新一次，40s没收到就判定邻居失效。</li><li>OSPF建立邻居有7个状态</li><li>OSPF使用<code>224.0.0.5</code>和<code>224.0.0.6</code>来更新LSA(链路状态通告)</li><li>ospf宣告的环回口不管子网掩码是多少，传播的时候都时32位</li></ul><p>名词介绍</p><ol><li><p>Router-ID：相当于路由器的名字，因为需要靠Router-ID去辨识每个节点，所以在一个网络中不允许出现Router-ID一样。Router-ID会以稳定性作为第一要素。</p><blockquote><p>1、Router-ID会优先选择路由器LoopBack接口的IP地址，如果有多个选择数值，选择最大的。</p><p>2、Router-ID在没有LoopBack的情况下，会选择物理接口IP数值最大的，注意：这个接口必须要是UP状态</p><p>3、Router-ID允许手动指定，但往往不能即使生效，除非重启，不然还是稳定保持不变</p></blockquote></li><li><p>区域：Area，由于每台路由器都有全网的拓扑，如果这个网络比较庞大，那么任何一个网段的变化，都会导致OSPF路由器中链路状态数据库的数据发生变化，从而触发路由器对所有的目的地最佳路线进行重算。为了节约资源和加快路由器运行速度，所以OSPF可以进行区域划分，每台路由器只需要计算本区域的拓扑。对于其他区域的网段，只需要知道怎么离开本区域就行了。</p></li><li><p>OSPF有两种区域，一种是骨干区域，区域号为0，这个是固定的，只要是骨干区域，区域号必须是0，还有一种是非骨干区域，非骨干区域的区域号除了0都可以。非骨干区域必须和骨干区域相连，在正常情况下，所有的区域都可以学习到全网所有的路由条目，在人为优化的情况下，可以让非骨干区域只学习到本区域的路由，去其他区域从默认路由走，从而精简路由表。</p></li></ol><h1 id="邻居建立过程"><a href="#邻居建立过程" class="headerlink" title="邻居建立过程"></a>邻居建立过程</h1><ol><li>down</li></ol><blockquote><p>表示OSPF启动了，由于某些原因，还没开始发送Hello</p></blockquote><ol start="2"><li>init</li></ol><blockquote><p>表示收到了对方发给我的Hello消息，但是没有在对方的Hello消息中，看的自己的Router-ID</p></blockquote><ol start="3"><li>2-way</li></ol><blockquote><p>在收到对方发给我的Router-ID中发现了自己的Router-ID</p><p>开始选举谁做指定路由器DR</p></blockquote><ol start="4"><li>exstart（预开始）</li></ol><blockquote><p>开始选举谁来主导这个链路状态信息交换的过程，选举（Slave，Master） </p><p>注意，此阶段互相传递的消息格式是链路状态数据库摘要（但是内容为空）。 </p></blockquote><ol start="5"><li>exchange（预交换）</li></ol><blockquote><p>由Slave发送自己的链路状态数据的摘要给Master，由Master确认之后再将Slave需要的链路状态信息发回去</p></blockquote><ol start="6"><li>loading</li></ol><blockquote><p>开始发送链路状态请求，然后接收对方发送的完整链路状态信息</p></blockquote><ol start="7"><li>Full</li></ol><blockquote><p>完成当前阶段的链路状态数据库同步，之后只需要维持邻居关系和触发更新 </p></blockquote><p><img src="https://i.loli.net/2020/03/22/heNsJbzAd9TFCSZ.png" alt="1.png"></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">3.3.3.3           1   FULL/DR         00:00:37    192.168.23.3    Ethernet0/0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Neighbor_ID:  邻居表里记录了邻居的Router-ID</span><br><span class="line">Pri: 选举DR和BDR的用的优先级，默认是1</span><br><span class="line">State:邻居建立过程中的状态和角色 [down,init,2-way,exstart,exchange,loading,full | DR,BDR,DRother]</span><br><span class="line">Dead_Time: 邻居的死亡计时40s，每当收到邻居hello包的时候，就重置，计时到0，就删除邻居</span><br><span class="line">Address:  建立邻居的IP</span><br><span class="line">Interface: 建立邻居的接口</span><br></pre></td></tr></table></figure><h1 id="DR和BDR"><a href="#DR和BDR" class="headerlink" title="DR和BDR"></a>DR和BDR</h1><p><code>show ip ospf interface e0/0</code></p><p>查看OSPF接口信息，这个信息是和OSPF有关的</p><ol><li>在多路访问的网络（交换机所在网络）里，OSPF建立邻居关系，导致最终邻居关系较复杂，更新消息重复而多于，所以在MA网络中，选举一个路由器作为指定路由器（DR），在非DR中，再选一个BDR作为备份。当任何的更新来临时，会先发送给DB和BDR，再由DR发送给所有的DRother路由器</li><li>选取DR和BDR的时候，先看优先级，越大越优，如果是0，就不参与DR和BDR选举。如果优先级一样，就看Router-ID谁大，谁大谁就是DR，不过必须在第一台设备启动后的40s内选举，超出这个时间，就不可以抢占DR和BDR。</li><li>DR和BDR在监听224.0.0.5和224.0.0.6这个地址，DRother只监听224.0.0.5这个地址，当需要更新的时候，DRother会向224.0.0.6去更新，DR会向224.0.0.5去更新消息</li><li>为了让ospf网络快速收敛，可以考虑在合适的接口上配置p2p网络类型，让ospf邻居不进行40s等待</li></ol><h1 id="信息查看"><a href="#信息查看" class="headerlink" title="信息查看"></a>信息查看</h1><p><img src="https://i.loli.net/2020/03/22/iYBgL917R6kHUzy.png" alt="2.png"></p><h2 id="路由器配置"><a href="#路由器配置" class="headerlink" title="路由器配置"></a>路由器配置</h2><ul><li>R1</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R1</span><br><span class="line">int lo0</span><br><span class="line">ip add 1.1.1.1 255.255.255.255</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.13.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li>R2</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R2</span><br><span class="line">int lo0</span><br><span class="line">ip add 2.2.2.2 255.255.255.255</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.23.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li>R3</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R3</span><br><span class="line">int lo0</span><br><span class="line">ip add 3.3.3.3 255.255.255.255</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.13.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.23.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.34.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/1 -2</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li>R4</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R4</span><br><span class="line">int lo0</span><br><span class="line">ip add 4.4.4.4 255.255.255.255</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.34.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.45.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 -1 , lo0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li>R5</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R5</span><br><span class="line">int lo0</span><br><span class="line">ip add 5.5.5.5 255.255.255.255</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.45.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.56.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/1 , lo0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int range e0/0 </span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">end</span><br></pre></td></tr></table></figure><ul><li>R6</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R6</span><br><span class="line">int lo0 </span><br><span class="line">ip add 6.6.6.6 255.255.255.255 </span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.56.6 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">end</span><br></pre></td></tr></table></figure><h2 id="当前路由器角色"><a href="#当前路由器角色" class="headerlink" title="当前路由器角色"></a>当前路由器角色</h2><ul><li>查看当前路由器的角色，此时R3是ABR(Area Border Router)</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ show ip protocals</span><br><span class="line">Routing Protocol is <span class="string">"ospf 1"</span></span><br><span class="line">  Router ID 3.3.3.3<span class="comment">#Router_ID</span></span><br><span class="line">  It is an area border router<span class="comment">#ABR</span></span><br><span class="line">  Number of areas <span class="keyword">in</span> this router is 2. 2 normal 0 stub 0 nssa</span><br><span class="line">  Maximum path: 4<span class="comment">#最大负载均衡路径</span></span><br></pre></td></tr></table></figure><h2 id="DR-BDR"><a href="#DR-BDR" class="headerlink" title="DR/BDR"></a>DR/BDR</h2><ul><li>查看当前网络信息，包括DR，BDR，R1的e0/0接口信息</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip ospf int e0/0</span></span><br><span class="line">Ethernet0/0 is up, line protocol is up </span><br><span class="line">  Internet Address 192.168.13.1/24, Area 1, Attached via Interface Enable</span><br><span class="line">  [区域为aera 1]</span><br><span class="line">  Process ID 1, Router ID 1.1.1.1, Network Type BROADCAST, Cost: 10</span><br><span class="line">  [网络类型：Broadcast]</span><br><span class="line">  [传输延迟1s]                [状态BDR]   [优先级1]</span><br><span class="line">  $ Transmit Delay is 1 sec, State BDR, Priority 1</span><br><span class="line">  [DR路由器的RouterID]                [接口地址]</span><br><span class="line">  $ Designated Router (ID) 3.3.3.3, Interface address 192.168.13.3</span><br><span class="line">  [BDR路由器的RouterID]            [接口地址]</span><br><span class="line">  $ Backup Designated router (ID) 1.1.1.1, Interface address 192.168.13.1</span><br><span class="line">  [时间间隔]                     $$$$</span><br><span class="line">  Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5</span><br><span class="line">    oob-resync timeout 40</span><br><span class="line">    Hello due <span class="keyword">in</span> 00:00:05<span class="comment">#下一次发送Hello包是什么时候</span></span><br><span class="line">  Neighbor Count is 1, Adjacent neighbor count is 1 </span><br><span class="line">    Adjacent with neighbor 3.3.3.3  (Designated Router)</span><br></pre></td></tr></table></figure><h2 id="P2P网络"><a href="#P2P网络" class="headerlink" title="P2P网络"></a>P2P网络</h2><ul><li>使用point-to-point网络连接R5和R6，在P2P网络内，不选DR和BDR。默认网络为Broadcast。P2P网络可以不用发组播，就能建立邻居。</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R5(R6同理):</span><br><span class="line">int e0/0</span><br><span class="line">ip ospf network point-to-point</span><br></pre></td></tr></table></figure><p>但是，只有没有多路访问的网络(网络不存在交换机)方便使用p2p连接，不然就会出现三个路由器两两交替抢占邻居的现象，即一会收到A的Hello包，和A建立邻居，一会收到B的Hello包，和B建立邻居，等到A的Hello包再来，因为P2P网络只能点对点，所以又只好断掉B的邻居和A建立邻居，循环往复。</p><h1 id="链路数据"><a href="#链路数据" class="headerlink" title="链路数据"></a>链路数据</h1><h2 id="数据库字段"><a href="#数据库字段" class="headerlink" title="数据库字段"></a>数据库字段</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">show ip ospf database</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/03/22/2qpPs4ZbSCwVu59.png" alt="3.png"></p><p>字段解释：</p><ul><li>Link ID：(link state id),链路ID </li><li>ADV Router：(advertising router)发送LSA的路由器</li><li>Age ：正计时，寿命1h，OSPF有周期性更新的行为，周期为30min，每到30min，数据库进行泛洪，将所有数据全部发出，刷新Age</li><li>Seq：序列号 ，十六进制，序列号有新的就用新的，OSPF认为0x80000000是错误的，会先更新，然后删除。类似RIP中的16跳。</li><li>Checksum ：校验，MTU分组发送的时候需要校验</li><li>Link count：链路条数</li></ul><h2 id="LSA和多区域"><a href="#LSA和多区域" class="headerlink" title="LSA和多区域"></a>LSA和多区域</h2><ul><li>LSA（Link-State Advertisement ） ，链路状态通告：链路状态通告，里面包含了路由器的ID和链路状态相关的IP地址，带宽等信息。目前在OSPF内，一共有11中LSA</li><li>LSU（Link-State Advertisement）， 链路状态更新：链路状态更新，更新里面含有LSA</li><li>LSDB（Link-State Database）， 链路状态数据库：数据库中会记录每个LSA更新的路由器ID，会记录序列号，序列号用16进制表示。数据库每个LSA一个计时器，这个计时器是LSA老化时间，正常情况下1h就会然这条LSA失效，但OSPF每隔30min泛洪会更新一次LSA。</li></ul><h3 id="stub"><a href="#stub" class="headerlink" title="stub"></a>stub</h3><ul><li>Stub（末梢区域）：OSPF如果不想让非骨干区域学习到OSPF_AS外的条目，达到精简路由表的目的，可以在ABR上对末梢区域进行 <em>area 1  stub</em> 配置，这样ABR就不会向那个区域发送AS外的条目，还会产生一条 <em>0.0.0.0/0</em> 的路由，保障没有路由的情况下，这个区域也可以访问外界。本区域的所有路由器你都别忘了配置Stub，不然邻居关系无法建立。该区域不存在4、5类LSA。</li></ul><h3 id="stub-no-summary"><a href="#stub-no-summary" class="headerlink" title="stub no-summary"></a>stub no-summary</h3><ul><li>Stub no-summary：如果做到极致精简，可以让末梢区域连OSPF其他区域路由也不学习，可以在ABR上对末梢区域进行 <em>area 1 stub no-summary<em>。</em>no-summary</em> 只需要在ABR上加。<em>Stub no-summary</em> 也被称为完全末梢区域。该区域不存在4、5类LSA，以及除了ABR默认路由三类LSA以外的3类</li></ul><h3 id="nssa"><a href="#nssa" class="headerlink" title="nssa"></a>nssa</h3><ul><li>NSSA<em>（not so stub area）<em>：次末梢区域。由于Stub区域无法存在4、5类LSA，所以stub区域无法引入外部路由，如果使用NSSA区域来做末梢，就看可以引入外部路由条目，不过是以7类LSA的方式进入，并且会在NSSA区域边界路由器上被转为5类。</em>area 1 nssa</em>  默认情况下，NSSA不会像非骨干区域注入一条默认路由，不过可以手动注入一条默认路由的7类LSA：<em>area 1 nssa default-infor orig</em></li></ul><h3 id="T-nssa"><a href="#T-nssa" class="headerlink" title="T-nssa"></a>T-nssa</h3><ul><li>T-NSSA <em>（total-not so stub area）<em>完全次末梢区域，除了可以存在7类LSA引入外部路由以外，其他功能和stub no-summary一致。</em>area 1 nssa no-summary</em></li></ul><p>总结：·</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">`area 1 stub`  area1是末梢区域</span><br><span class="line"></span><br><span class="line">`area 1 stub no-summary` area1是完全末梢区域</span><br><span class="line"></span><br><span class="line">`area 1 nssa` area1是次末梢区域</span><br><span class="line"></span><br><span class="line">`area 1 nssa default-infor-origin` area1是次末梢区域，并且通告默认路由</span><br><span class="line"></span><br><span class="line">`area 1 nssa no-summary` area1完全次末梢区域</span><br></pre></td></tr></table></figure><h2 id="OSPF-Codes"><a href="#OSPF-Codes" class="headerlink" title="OSPF Codes"></a>OSPF Codes</h2><table><thead><tr><th>标识</th><th>含义</th></tr></thead><tbody><tr><td>O</td><td>区域内的路由</td></tr><tr><td>O IA</td><td>不同区域之间的路由</td></tr><tr><td>OE1</td><td>区域外的路由(不是OSPF协议的路由)，会累加METRIC值（默认20）</td></tr><tr><td>OE2</td><td>区域外的路由(不是OSPF协议的路由)，不累加METRIC值（默认20），由外部重分布进来默认使用OE2。</td></tr><tr><td>ON1</td><td>区域外的路由，由NSSA的ASBR重发布进来的，会累加Metric值</td></tr><tr><td>ON2</td><td>区域外路由，由NSSA的ASBR重发布进来的。NSSA区域中的路由器没有LSA-5，用LSA7算出的external路由，就标记为ON1/2</td></tr></tbody></table><h2 id="十一种LSA"><a href="#十一种LSA" class="headerlink" title="十一种LSA"></a>十一种LSA</h2><p>OSPF路由器会发送LSA通告，如果路由器太多，收到的通告就会很多，在进行SPF算法的时候，网络拓扑图太大，计算复杂，而且每当网络状态更新，都需要重复这样一次计算，计算量庞大。</p><ul><li>收到的LSA通告太多了，OSPF路由器的负担很</li><li>内部动荡会引起全网路由器的完全SPF计算</li><li>资源消耗过多，LSDB庞大，设备性能下降，影响数据转发</li><li>每台路由器都需要维护的路由表越来越大，单区域内路由无法汇总</li></ul><table><thead><tr><th>LSA类型代码</th><th><strong>描述</strong></th></tr></thead><tbody><tr><td><strong>1</strong></td><td>路由器LSA，本地路由器产生，用于描述自身的链路信息，如接口、带宽、ip地址</td></tr><tr><td><strong>2</strong></td><td>网络LSA，由DR产生，用于向全网告知自己所在的局域网信息 。</td></tr><tr><td><strong>3</strong></td><td>网络汇总LSA，ABR产生，将其他区域的路由条目转发到本区域，会丢失拓扑信息</td></tr><tr><td><strong>4</strong></td><td>ASBR汇总LSA，ASBR产生，告知本区域路由如何离开自治系统</td></tr><tr><td><strong>5</strong></td><td>AS外部LSA，ASBR产生，告知本区域路由器外面的路由条目</td></tr><tr><td>6</td><td>组成员LSA</td></tr><tr><td><strong>7</strong></td><td>NSSA外部LSA，nssa区域路由器重发布外界路由产生，导入其他区域会被ABR修改为5类LSA</td></tr><tr><td>8</td><td>外部属性LSA</td></tr><tr><td>9</td><td>Opaque LSA （链路本地范围）</td></tr><tr><td>10</td><td>Opaque LSA （本地区域范围）</td></tr><tr><td>11</td><td>Opaque LSA （AS范围）</td></tr></tbody></table><h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p>1类LSA — 路由器LSA，每台路由器都会产生，用于描述自身的接口状态。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sh ip ospf database</span><br><span class="line"></span><br><span class="line">Router Link States (Area 1)</span><br><span class="line">Link ID         ADV Router      Age         Seq<span class="comment">#       Checksum Link count</span></span><br><span class="line">1.1.1.1         1.1.1.1         1678        0x80000006 0x00997D 2</span><br><span class="line">2.2.2.2         2.2.2.2         1621        0x80000007 0x00559F 2</span><br><span class="line">3.3.3.3         3.3.3.3         1724        0x80000009 0x009362 2</span><br><span class="line"></span><br><span class="line">路由链路状态表（区域1）</span><br><span class="line">连接的ID，从哪个路由器学到的，寿命，序列号，校验位，链路数</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细信息</span></span><br><span class="line">$ sh ip ospf database router 1.1.1.1</span><br></pre></td></tr></table></figure><h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>2类LSA  ：网络LSA，由DR产生，用于向全网告知自己所在的局域网信息 。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip ospf database network 192.168.13.3</span></span><br><span class="line">            OSPF Router with ID (1.1.1.1) (Process ID 1)</span><br><span class="line">Net Link States (Area 1)</span><br><span class="line"><span class="comment">#头部信息</span></span><br><span class="line">  Routing Bit Set on this LSA <span class="keyword">in</span> topology Base with MTID 0</span><br><span class="line">  LS age: 56</span><br><span class="line">  Options: (No TOS-capability, DC)</span><br><span class="line">  LS Type: Network Links</span><br><span class="line">  Link State ID: 192.168.13.3 (address of Designated Router)</span><br><span class="line">  Advertising Router: 3.3.3.3</span><br><span class="line">  LS Seq Number: 80000001</span><br><span class="line">  Checksum: 0x7E26</span><br><span class="line">  Length: 32</span><br><span class="line">  Network Mask: /24</span><br><span class="line"><span class="comment">#当前区域内的路由器  </span></span><br><span class="line">Attached Router: 3.3.3.3</span><br><span class="line">Attached Router: 1.1.1.1</span><br></pre></td></tr></table></figure><h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>3类LSA  —路由器汇总LSA，由ABR（区域边界路由器）产生，用来将其他区域的路由进行汇总，然后转发到本区域。ARB传递的是路由表类似的LSA，会丢失掉拓扑信息，所以区域之间是无法得知拓扑。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R6<span class="comment">#sh ip ospf database summary 3.3.3.3</span></span><br></pre></td></tr></table></figure><h2 id="4"><a href="#4" class="headerlink" title="4"></a>4</h2><p>4类LSA，ASBR汇总LSA，Link state ASBR，由ABR产生，用来告知本区域的路由器如何离开本OSPF自治系统</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注入外部路由，并形成一条默认路由</span></span><br><span class="line">int e0/2</span><br><span class="line">ip add dhcp</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">router ospf 1</span><br><span class="line">default-information originate always</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">四类LSA：Summary ASB Link States (Area 1)</span><br><span class="line">R1<span class="comment">#sh ip ospf database asbr-summary 4.4.4.4</span></span><br></pre></td></tr></table></figure><h2 id="5"><a href="#5" class="headerlink" title="5"></a>5</h2><p>5类LSA，由ASBR产生，用来告知本区域的路由器外面的条目</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">5类LSA：Type-5 AS External Link States</span><br><span class="line"></span><br><span class="line">R1<span class="comment">#sh ip ospf database external </span></span><br><span class="line">            OSPF Router with ID (1.1.1.1) (Process ID 1)</span><br><span class="line">Type-5 AS External Link States</span><br><span class="line">  Routing Bit Set on this LSA <span class="keyword">in</span> topology Base with MTID 0</span><br><span class="line">  LS age: 212</span><br><span class="line">  Options: (No TOS-capability, DC, Upward)</span><br><span class="line">  LS Type: AS External Link</span><br><span class="line">  Link State ID: 0.0.0.0 (External Network Number )</span><br><span class="line">  Advertising Router: 4.4.4.4</span><br><span class="line">  LS Seq Number: 80000001</span><br><span class="line">  Checksum: 0xFAEC</span><br><span class="line">  Length: 36</span><br><span class="line">  Network Mask: /0</span><br><span class="line">Metric Type: 2 (Larger than any link state path)</span><br><span class="line">MTID: 0 </span><br><span class="line">Metric: 10 </span><br><span class="line">Forward Address: 192.168.70.2</span><br><span class="line">External Route Tag: 1</span><br></pre></td></tr></table></figure><h2 id="7"><a href="#7" class="headerlink" title="7"></a>7</h2><p>用于在NSSA区域表示外界路由，由NSSA区域的边界路由产生，发布到其他区域时，会被ABR转换为5类的LSA。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要在路由器上都配好</span></span><br><span class="line">router ospf 1</span><br><span class="line">area 1 nssa </span><br><span class="line"></span><br><span class="line"><span class="comment">#在R1上引入外部路由，也就是NSSA区域的路由器上引入外部路由</span></span><br><span class="line">ip route 11.11.11.11 255.255.255.255 null0</span><br><span class="line">router ospf 1 </span><br><span class="line">re st su</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">R2的链路状态数据库中，11.11.11.11是7类LSA</span><br><span class="line">Type-7 AS External Link States (Area 1)</span><br><span class="line"></span><br><span class="line">Link ID         ADV Router      Age         Seq<span class="comment">#       Checksum Tag</span></span><br><span class="line">11.11.11.11     1.1.1.1         123         0x80000001 0x006BF6 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在NSSA边界路由器，11.11.11.11被转换为了5类LSA</span><br><span class="line">R5的链路状态数据库</span><br><span class="line">Type-5 AS External Link States</span><br><span class="line">Link ID         ADV Router      Age         Seq<span class="comment">#       Checksum Tag</span></span><br><span class="line">0.0.0.0         4.4.4.4         343         0x80000002 0x00F8ED 1</span><br><span class="line">11.11.11.11     3.3.3.3         323         0x80000001 0x00C3A0 0</span><br></pre></td></tr></table></figure><p>有五类LSA但没有四类的LSA一定是因为存在NSSA区域导致的。</p><h1 id="路由汇总"><a href="#路由汇总" class="headerlink" title="路由汇总"></a>路由汇总</h1><p>由于OSPF不传递路由表信息，而是直接发送LSA信息，所以在一个区域内，所有路由器都有本区域的拓扑，所以在单个区域内无法完成路由汇总。</p><p>在OSPF中，汇总只能发生在ABR和ASBR上，这两种路由器转发的路由表的LSA信息。而其他路由器是转发拓扑信息</p><p><img src="https://i.loli.net/2020/03/22/iYBgL917R6kHUzy.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在R4添加</span><br><span class="line">int lo10</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo20</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo30</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">router ospf 1</span><br><span class="line">redistribute connected subnets </span><br><span class="line"><span class="comment"># 可以观察到R1、R3、R4等路由器都受到了路由条目明细，现在在ASBR上对路由做汇总</span></span><br><span class="line"><span class="comment"># 这里要注意，不能再ABR(R3)上对OSPF_as以外的路由进行汇总</span></span><br><span class="line">summary-address 172.16.0.0 255.255.0.0</span><br></pre></td></tr></table></figure><h1 id="注入默认路由"><a href="#注入默认路由" class="headerlink" title="注入默认路由"></a>注入默认路由</h1><p>在Stub网络里，注入默认路由无效，但是可以在NSSA网络注入。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">router ospf 1</span><br><span class="line">default-information originate</span><br><span class="line"><span class="comment">#这条命令用来产生一条五类的LSA，包含的是缺省路由信息。其它路由器收到这条LSA后，会计算出缺省路由0.0.0.0/0。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#命令生效的条件是该路由器上存在缺省路由。如果没有，而且仍然想发布这种LSA，要在命令后面加always，即</span></span><br><span class="line">default-information originate always</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/03/22/cZGTFBflSUjxnzp.png" alt="5.png"></p><h1 id="构造虚链路"><a href="#构造虚链路" class="headerlink" title="构造虚链路"></a>构造虚链路</h1><p>OSPF路由器要成为ABR的条件，除了要同时连接多个区域，必须满足有一个接口连接area 0。</p><p>虚链路会导致故障变得复杂，线路变得不稳定，所以一般是个临时解决方案，一个全新设计的网络架构里面虚链路是不合理的。</p><p><code>virtual-link</code>是ospf自带的虚链路解决方式，这种方式存在诸多问题，比如通过虚链路学习的LSA是DNA，含有DNA（do not age）的时间不会改变，这样会导致错误的LSA信息得不到更新，甚至虚链路邻居关系都不需要Hello包来维持。</p><p>R2：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router ospf 1</span><br><span class="line">area 1 virtual-link 3.3.3.3</span><br><span class="line">area 1 virtual-link 4.4.4.4</span><br></pre></td></tr></table></figure><p>R3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router ospf 1</span><br><span class="line">area 1 virtual-link 2.2.2.2</span><br></pre></td></tr></table></figure><p>这时候，R3和R2建立了两个邻居关系，其中一个接口用的是<code>OSPF_VL0</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看虚链路</span></span><br><span class="line">show ip ospf virtual-links</span><br></pre></td></tr></table></figure><h1 id="HAMC"><a href="#HAMC" class="headerlink" title="HAMC"></a>HAMC</h1><p>只提供完整性和可用性，不提供机密性。OSPF分为接口和区域认证，但都是明文加密的</p><p>认证和RIP&amp;EIGRP类似。</p><h1 id="OSPF小练习"><a href="#OSPF小练习" class="headerlink" title="OSPF小练习"></a>OSPF小练习</h1><p><img src="https://i.loli.net/2020/03/22/pI9mKMXFxb8fqyg.png" alt="6.png"></p><p><img src="https://i.loli.net/2020/03/22/w4eh1xZJrXyEDTU.png" alt="7.png"></p><h2 id="区域配置"><a href="#区域配置" class="headerlink" title="区域配置"></a>区域配置</h2><p>R{1~4} ： <code>area 0</code></p><p>R{3-5} , R{4-6} ：<code>area 1</code></p><p>R{3,4}的环回口：<code>area 0</code></p><p>R{5,6}的环回口：<code>area 1</code></p><p>R{5,6,7}：<code>area 2</code></p><p>优化命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo</span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br></pre></td></tr></table></figure><p>R1</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R1</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.12.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.23.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0 </span><br><span class="line">ip add 1.1.1.1 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p>R2</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R2</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.12.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.24.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0 </span><br><span class="line">ip add 2.2.2.2 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p>R3</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R3</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.13.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.35.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0 </span><br><span class="line">ip add 3.3.3.3 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p>R4</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R4</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.24.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.46.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0</span><br><span class="line">ip add 4.4.4.4 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p>R5</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ho R5</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.35.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.57.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int lo0</span><br><span class="line">ip add 5.5.5.5 255.255.255.0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p>R6</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ho R6</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.46.6 255.255.255.0</span><br><span class="line">no sh </span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/1 </span><br><span class="line">ip add 192.168.67.6 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int lo0</span><br><span class="line">ip add 6.6.6.6 255.255.255.0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p>R7</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ho R7</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.57.7 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.67.7 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int lo0</span><br><span class="line">ip add 7.7.7.7 255.255.255.0</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure><p><img src="https://i.loli.net/2020/03/22/cI5aEsBDy9lOWHF.png" alt="8.png"></p><p>目前来说，R1的<code>1.1.1.1</code>是<code>ping</code>不通R7的<code>7.7.7.7</code>的，因为R5和R6构不成边界路由器ABR。所以需要在R3-R5，R4-R6之间构建VPN隧道。</p><h2 id="配置隧道"><a href="#配置隧道" class="headerlink" title="配置隧道"></a>配置隧道</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">R3</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.35.3 </span><br><span class="line">tu de 192.168.35.5</span><br><span class="line">ip add 172.16.35.3 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R5:</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.35.5 </span><br><span class="line">tu de 192.168.35.3</span><br><span class="line">ip add 172.16.35.5 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"></span><br><span class="line">R4</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.46.4 </span><br><span class="line">tu de 192.168.46.6</span><br><span class="line">ip add 172.16.46.4 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"></span><br><span class="line">R6</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.46.6 </span><br><span class="line">tu de 192.168.46.4</span><br><span class="line">ip add 172.16.46.6 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br></pre></td></tr></table></figure><p>当虚通道建立好的时候，就可以用R1<code>ping</code>通R7了。</p><p><strong>R1、R2在R{1~4}的区域中分别为DR和BDR</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R1:</span><br><span class="line">int e0/2</span><br><span class="line">ip ospf priority 100</span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">int e0/2</span><br><span class="line">ip ospf priority 90</span><br><span class="line"></span><br><span class="line">之后使用<span class="keyword">do</span> clear ip ospf process 重置ospf 的进程</span><br></pre></td></tr></table></figure><p><strong>其余的链路使用P2P网络</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">R1:</span><br><span class="line">int range e0/0 -2</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R3:</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line">R4:</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line">R5</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R6</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line">R7</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br></pre></td></tr></table></figure><h2 id="默认路由注入"><a href="#默认路由注入" class="headerlink" title="默认路由注入"></a>默认路由注入</h2><p><strong>4、R1,R2缺省路由</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">R1:</span><br><span class="line">interface Loopback1</span><br><span class="line"> ip address 100.1.1.1 255.255.255.0</span><br><span class="line"> ip ospf 1 area 0</span><br><span class="line">router ospf 1</span><br><span class="line"> default-information originate always</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">R2:</span><br><span class="line">interface Loopback1</span><br><span class="line"> ip address 100.1.1.1 255.255.255.0</span><br><span class="line"> ip ospf 1 area 0</span><br><span class="line">router ospf 1 </span><br><span class="line">default-information originate always metric 10</span><br></pre></td></tr></table></figure><p>metrci - 度量值，越小越优</p><h2 id="特殊区域"><a href="#特殊区域" class="headerlink" title="特殊区域"></a>特殊区域</h2><p><strong>5、area 2为特殊区域</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">R5:</span><br><span class="line">router ospf 1</span><br><span class="line">area 2 nssa no-summary</span><br><span class="line"></span><br><span class="line">R6:</span><br><span class="line">router ospf 1</span><br><span class="line">area 2 nssa no-summary</span><br><span class="line"></span><br><span class="line">R7</span><br><span class="line">router ospf 1</span><br><span class="line">redistribute connected subnets</span><br><span class="line">area 2 nssa</span><br></pre></td></tr></table></figure><div style="text-align:center;color:red"> ! ! ! OSPF 5类LSA比7类LSA更优先</div>没有开启nssa之前的路由表：<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">O*E2  0.0.0.0/0 [110/10] via 172.16.46.4, 00:08:22, Tunnel0</span><br><span class="line">      1.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        1.1.1.1 [110/1011] via 172.16.46.4, 00:01:58, Tunnel0</span><br><span class="line">      2.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        2.2.2.2 [110/1011] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">      3.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        3.3.3.3 [110/1011] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">      4.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        4.4.4.4 [110/1001] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">      5.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O IA     5.5.5.5 [110/1021] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">      6.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        6.6.6.0/24 is directly connected, Loopback0</span><br><span class="line">L        6.6.6.6/32 is directly connected, Loopback0</span><br><span class="line">      7.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        7.7.7.7 [110/11] via 192.168.67.7, 00:42:06, Ethernet0/1</span><br><span class="line">      100.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        100.1.1.1 [110/1011] via 172.16.46.4, 00:01:58, Tunnel0</span><br><span class="line">      172.16.0.0/16 is variably subnetted, 3 subnets, 2 masks</span><br><span class="line">O        172.16.35.0/24 [110/2010] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">C        172.16.46.0/24 is directly connected, Tunnel0</span><br><span class="line">L        172.16.46.6/32 is directly connected, Tunnel0</span><br><span class="line">O     192.168.12.0/24 [110/1020] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">O     192.168.13.0/24 [110/1020] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">O     192.168.23.0/24 [110/1020] via 172.16.46.4, 00:01:58, Tunnel0</span><br><span class="line">O     192.168.24.0/24 [110/1010] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">O IA  192.168.35.0/24 [110/1020] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">      192.168.46.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.46.0/24 is directly connected, Ethernet0/0</span><br><span class="line">L        192.168.46.6/32 is directly connected, Ethernet0/0</span><br><span class="line">O     192.168.57.0/24 [110/20] via 192.168.67.7, 00:42:06, Ethernet0/1</span><br><span class="line">      192.168.67.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.67.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.67.6/32 is directly connected, Ethernet0/1</span><br><span class="line">O     192.168.184.0/24 [110/1010] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">O     192.168.197.0/24 [110/1020] via 172.16.46.4, 00:01:58, Tunnel0</span><br></pre></td></tr></table></figure><p>装完NSSA</p><blockquote><p>屏蔽外部路由，形成一条默认路由0.0.0.0/0，指向R5和R6</p></blockquote><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">O*IA  0.0.0.0/0 [110/11] via 192.168.67.6, 00:00:05, Ethernet0/1</span><br><span class="line">                [110/11] via 192.168.57.5, 00:00:05, Ethernet0/0</span><br><span class="line">      7.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        7.7.7.0/24 is directly connected, Loopback0</span><br><span class="line">L        7.7.7.7/32 is directly connected, Loopback0</span><br><span class="line">      192.168.57.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.57.0/24 is directly connected, Ethernet0/0</span><br><span class="line">L        192.168.57.7/32 is directly connected, Ethernet0/0</span><br><span class="line">      192.168.67.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.67.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.67.7/32 is directly connected, Ethernet0/1</span><br></pre></td></tr></table></figure><h2 id="路由汇总-1"><a href="#路由汇总-1" class="headerlink" title="路由汇总"></a>路由汇总</h2><p><strong>6、R3的路由汇总</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">R3:</span><br><span class="line">======</span><br><span class="line">$这些回环接口配置的ip地址宣告进了area 1，所以在area 1中汇总</span><br><span class="line">int lo1</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo2</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo3</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line"></span><br><span class="line">int range lo1,lo2,lo3</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 172.16.0.0 255.255.0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R5:</span><br><span class="line">======</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 172.16.0.0 255.255.0.0</span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">======</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 172.16.0.0 255.255.0.0</span><br></pre></td></tr></table></figure><p> <font color="red" style="center">Question？：为什么R1读取不到R3的172.16.0.0/16的条目，而R5可以读到，因为R3和R5有一个Tunnel 吗？</font></p><p>在汇总之前，R1的路由表</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      172.16.0.0/16 is variably subnetted, 5 subnets, 2 masks</span><br><span class="line">O IA     172.16.1.1/32 [110/11] via 192.168.184.3, 00:00:05, Ethernet0/2</span><br><span class="line">O IA     172.16.2.1/32 [110/11] via 192.168.184.3, 00:00:05, Ethernet0/2</span><br><span class="line">O IA     172.16.3.1/32 [110/11] via 192.168.184.3, 00:00:05, Ethernet0/2</span><br><span class="line">O        172.16.35.0/24 [110/1010] via 192.168.184.3, 00:37:33, Ethernet0/2</span><br><span class="line">O        172.16.46.0/24 [110/1010] via 192.168.184.4, 00:37:33, Ethernet0/2</span><br></pre></td></tr></table></figure><h2 id="OSPF认证"><a href="#OSPF认证" class="headerlink" title="OSPF认证"></a>OSPF认证</h2><p><strong>7、area 0的明文认证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">R1-R3,先不开启R4的明文认证</span><br><span class="line">router ospf 1</span><br><span class="line">area 0 authentication</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意，下面的所有代码都是R5和R6没有添加明文认证的，这里添加上明文认证</span></span><br><span class="line"><span class="comment">#难关area 0学习不到7.7.7.0的路由</span></span><br><span class="line">router ospf 1</span><br><span class="line">area 0 authentication</span><br></pre></td></tr></table></figure><p>等到40s死亡计时过了之后，就会发现R4失效：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Jan  1 03:13:17.836: %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on Ethernet0/0 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br><span class="line">R4(config)<span class="comment">#router</span></span><br><span class="line">*Jan  1 03:13:19.671: %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on Ethernet0/2 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br><span class="line">R4(config)<span class="comment">#router ospf 1</span></span><br><span class="line">R4(config-router)<span class="comment">#</span></span><br><span class="line">*Jan  1 03:13:21.215: %OSPF-5-ADJCHG: Process 1, Nbr 3.3.3.3 on Ethernet0/2 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br></pre></td></tr></table></figure><p>一旦在R4上开启认证，R4又会重新从<code>Down</code>变成<code>Full</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R4:</span><br><span class="line">router ospf 1</span><br><span class="line">area 0 authentication</span><br></pre></td></tr></table></figure><p><strong>R3-5，R4-6密文认证</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R3:</span><br><span class="line">int e0/1</span><br><span class="line">ip ospf message-digest-key 1 md5 cis_pad</span><br><span class="line">ip ospf authentication message-digest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置完之后，R3路由表中，R5的Dead Time会跌出30，然后直到消失，这是在R5的相应接口上也配置认证,彼此又会建立相应的连接。</span></span><br><span class="line">int e0/0</span><br><span class="line">ip ospf message-digest-key 1 md5 cis_pad</span><br><span class="line">ip ospf authentication message-digest</span><br></pre></td></tr></table></figure><h2 id="抑制路由"><a href="#抑制路由" class="headerlink" title="抑制路由"></a>抑制路由</h2><p><strong>8、禁止area 2内的路由被其他区域学到</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">R5:</span><br><span class="line">=====</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 192.168.57.0 255.255.255.0 not-advertise</span><br><span class="line">area 1 range 192.168.67.0 255.255.255.0 not-advertise</span><br><span class="line">area 2 nssa translate type7 suppress-fa</span><br><span class="line"></span><br><span class="line">R6:</span><br><span class="line">=====</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 192.168.57.0 255.255.255.0 not-advertise</span><br><span class="line">area 1 range 192.168.67.0 255.255.255.0 not-advertise</span><br><span class="line">area 2 nssa translate type7 suppress-fa</span><br></pre></td></tr></table></figure><h1 id="OSPF命令"><a href="#OSPF命令" class="headerlink" title="OSPF命令"></a>OSPF命令</h1><p>配置OSPF协议</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router ospf [Process_ID]<span class="comment">#进程ID本地有效</span></span><br><span class="line">network 1.1.1.0 0.0.0.255 area 0 <span class="comment">#将1.1.1.0网段(包含子网掩码)宣告进OSPF网络</span></span><br><span class="line">router-id 1.1.1.1<span class="comment">#设置Router-ID，注意需要重启生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于链路的配置</span></span><br><span class="line">int range e0/0 -1 <span class="comment">#行入e/0、e0/1接口</span></span><br><span class="line">ip ospf 1 area 0 <span class="comment">#将该接口加入OSPF，并且按照配置的子网掩码宣告其接口上</span></span><br></pre></td></tr></table></figure><p>配置OSPF优先级</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int e0/0</span><br><span class="line">ip ospf priority 10<span class="comment"># 默认为1</span></span><br><span class="line"><span class="comment"># 重置OSPF进程，重新选举</span></span><br><span class="line"><span class="keyword">do</span> clear ip ospf process</span><br></pre></td></tr></table></figure><p>LSA</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看1类LSA</span></span><br><span class="line">show ip ospf database router x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看2类LSA</span></span><br><span class="line">show ip ospf database network x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看3类LSA</span></span><br><span class="line">show ip ospf database summary x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看4类LSA</span></span><br><span class="line">show ip ospf database asbr-summary x.x.x.x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看5类LSA</span></span><br><span class="line">show ip ospf database external x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看7类LSA</span></span><br><span class="line">show ip ospf database router x.x.x.x</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;OSPF&quot;&gt;&lt;a href=&quot;#OSPF&quot; class=&quot;headerlink&quot; title=&quot;OSPF&quot;&gt;&lt;/a&gt;OSPF&lt;/h1&gt;&lt;p&gt;&lt;strong&gt;距离矢量路由协议&lt;/strong&gt;&lt;/p&gt;
&lt;p&gt;​    路由器相互之间只更新路由表信息，并且逐条更新，依
      
    
    </summary>
    
    
      <category term="路由技术" scheme="http://ymlog.cn/categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/"/>
    
    
  </entry>
  
  <entry>
    <title>Linux Virtual Server</title>
    <link href="http://ymlog.cn/2020/02/19/LVS/"/>
    <id>http://ymlog.cn/2020/02/19/LVS/</id>
    <published>2020-02-19T13:33:30.000Z</published>
    <updated>2020-06-16T10:15:30.075Z</updated>
    
    <content type="html"><![CDATA[<h1 id="LVS简介"><a href="#LVS简介" class="headerlink" title="LVS简介"></a>LVS简介</h1><p>在已有的负载均衡技术中，IP负载均衡是效率最高的。它将一组服务器构建成一个高性能、高可用的虚拟服务器。如图，LVS一共有以下两部分组成：</p><p><img src="https://i.loli.net/2020/03/22/4AzfxepYXlTDRGV.jpg" alt="LVS_1.jpg"></p><blockquote><ol><li>Load Balance Machine，提供调度的机器，负责接收用户请求后转发给后端Server集群</li><li>Real Server ，真实的服务器集群，负责提供各种服务</li></ol></blockquote><p>其中，LB机器上运行LVS，LVS有用户空间和内核空间两部分组成：</p><blockquote><ol><li>IPVS（IP Virtual Server）：工作在内核空间中，是真正生效实现调度的代码。</li><li>ipvsadm：工作在用户空间，负责为ipvs内核框架编写规则，定义谁是集群，谁是后端真实服务器。</li></ol></blockquote><p>LB集群原理：当用户的请求过来时，会直接分发到Director Server上，然后它把用户请求根据设置好的调度算法，智能均衡的分配到后端真正的服务器上（Real Server）</p><p>LVS一共有三种模式，分别是：</p><ol><li>Virtual Server via Network Address Translation（VS/NAT）</li><li>Virtual Server via IP Tunneling（VS/TUN）</li><li>Virtual Server via Direct Routing（VS/DR）</li></ol><p>LVS一共有8中调度算法</p><ol><li>轮询（Round Robin）调度器通过”轮叫”调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。</li><li>加权轮询（Weighted Round Robin）调度器通过”加权轮叫”调度算法根据真实服务器的不同处理能力来调度访问请求。这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</li><li>最少链接（Least Connections）调度器通过”最少连接”调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统性能，采用”最小连接”调度算法可以较好地均衡负载。</li><li>加权最少链接（Weighted Least Connections）在集群系统中的服务器性能差异较大的情况下，调度器采用”加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</li><li>基于局部性的最少链接（Locality-Based Least Connections）”基于局部性的最少链接” 调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器 是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用”最少链接”的原则选出一个可用的服务 器，将请求发送到该服务器。</li><li>带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）”带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。它与LBLC算法的不同之处是它要维护从一个 目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务 器组，按”最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按”最小连接”原则从这个集群中选出一 台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的 程度。</li><li>目标地址散列（Destination Hashing）”目标地址散列”调度算法根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</li><li>源地址散列（Source Hashing）”源地址散列”调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</li><li>最短的期望的延迟？</li><li>最少队列调度？</li></ol><h2 id="相关术语"><a href="#相关术语" class="headerlink" title="相关术语"></a>相关术语</h2><ol><li>DS：Director Server。指的是前端负载均衡器节点。</li><li>RS：Real Server。后端真实的工作服务器。</li><li>VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。</li><li>DIP：Director Server IP，主要用于和内部主机通讯的IP地址。</li><li>RIP：Real Server IP，后端服务器的IP地址。</li><li>CIP：Client IP，访问客户端的IP地址。</li></ol><h2 id="VS-NAT工作模型"><a href="#VS-NAT工作模型" class="headerlink" title="VS/NAT工作模型"></a>VS/NAT工作模型</h2><p><img src="https://i.loli.net/2020/03/22/yMxz4afX2OuWYgc.png" alt="LVS_2.png"></p><p>流程：</p><ol><li>当用户访问服务器提供服务时，发往VIP地址的请求包到达LB机器</li><li>LB机器检查数据包的目标IP和目标Port，去匹配LVS中的规则，然后根据负载均衡算法从集群中选择RS响应请求，并将连接添加到记录已连接的Hash表中</li><li>将数据包的目的地址和端口重写–&gt; 选中的RS的IP:Port，然后转发RS。</li><li>RS返回数据报时，SrcIP：RIP.Rport DstIP DIP.Dport。</li><li>LB机器将数据报中的源IP地址和源Port重写为DS的源地址和源Port</li><li>连接终止或超时后，连接记录就会在已连接的Hash表中删除</li></ol><p>特性：</p><ol><li>RS应该使用私有IP地址，RS的网关是DIP地址</li><li>DIP要和RIP属于同一个网段</li><li>请求和响应报文都需要经过DS（性能瓶颈）</li><li>支持端口映射</li><li>RS可以使用任意操作系统</li></ol><h2 id="VS-DR工作模型"><a href="#VS-DR工作模型" class="headerlink" title="VS/DR工作模型"></a>VS/DR工作模型</h2><p><img src="https://i.loli.net/2020/03/22/3eHvpJs9Utkyib6.png" alt="LVS_3.png"></p><p>流程：</p><ol><li>当用户访问服务器提供服务时，发往VIP地址的请求包到达LB机器。</li><li>LB机器根据负载均衡算法，选出合适的RS，将目的Mac修改为RS的Mac，其余不变，并将连接记录添加到Hash表。</li><li>RS处理完报文后，将响应报文直接发送给客户端</li><li>连接终止或超时后，连接记录就会在已连接的Hash表中删除</li></ol><p>数据报流动：</p><p><img src="https://i.loli.net/2020/03/22/unXjMckrdQICYTf.png" alt="LVS_4 DR数据流动.png"></p><p>非ARP接口：</p><blockquote><p>因为DR需要所有设备在同一个局域网内，而arp广播，会发送LAN的所有机器（LB机器和RS机器），我们现在只需要LB机器去响应VIP请求，要求只能是DR进行响应VIP的arp请求，而RS不能够响应。我们需要设置arp参数（RS)，限制其不能响应VIP的arp请求。</p><p>arp_ignore：arp响应</p><p>arp_announce：arp通告</p></blockquote><p>特性：</p><ol><li>保证前端路由将目标地址为VIP报文通通发给DS</li><li>RS可以使用私有IP地址，也可以使用公网IP地址，如果使用公网地址，此时通过Internet对RIP进行直接访问</li><li>RS和DS必须在同一个物理网络当中</li><li>请求报文经过DS到RS，但是响应报文不经过DS（消除nat模式下的性能瓶颈）</li><li>不支持地址转化，也不支持端口映射</li><li>RS的网关决不能指向DS（因为我们允许RS通过DS）</li><li>RS上的lo接口配置VIP地址</li></ol><h2 id="VS-TUN工作模型"><a href="#VS-TUN工作模型" class="headerlink" title="VS/TUN工作模型"></a>VS/TUN工作模型</h2><p><img src="https://i.loli.net/2020/03/22/CgUyVIajr4KkXtd.png" alt="LVS_5_Tun.png"></p><p>流程：</p><ol><li>当用户访问服务器提供服务时，发往VIP地址的请求包到达LB机器。</li><li>调度器根据各个服务器的负载情况，动态地选择一台服务器， 将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器</li><li>服务器收到报文后，先将报文解封获得原来目标地址为VIP的报文，服务器发 现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。</li></ol><p>数据报流动：</p><p><img src="https://i.loli.net/2020/03/22/bhvVoSX3da8KH4P.png" alt="LVS_6.png"><br>特点：</p><ol><li>TUN的建立需要时动态的，类似DMVPN</li><li>因为又添加了IP报头，所以IP隧道会消耗一定的资源</li><li>不需要DS返回响应，和DR类似</li><li>Tun可以做加密，IPSec等</li></ol><h2 id="三种模型的比较"><a href="#三种模型的比较" class="headerlink" title="三种模型的比较"></a>三种模型的比较</h2><p><strong>1. Virtual Server via NAT</strong>：VS/NAT 的优点是服务器可以运行任何支持TCP/IP的操作系统，它只需要一个IP地址配置在调度器上，服务器组可以用私有的IP地址。缺点是它的伸缩能力有限，因为在VS/NAT中请求和响应报文都需要通过负载调度器。可以有三种方法解决这个问题：混合方法、VS/TUN和 VS/DR。在DNS混合集群系统中，有若干个VS/NAT负载调度器，每个负载调度器带自己的服务器集群，同时这些负载调度器又通过RR-DNS组成简 单的域名。但VS/TUN和VS/DR是提高系统吞吐量的更好方法。对于那些将IP地址或者端口号在报文数据中传送的网络服务，需要编写相应的应用模块来转换报文数据中的IP地址或者端口号。这会带来实现的工作量，同时应用模块检查报文的开销会降低系统的吞吐率。</p><p><strong>2. Virtual Server via IP Tunneling：</strong>在VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。这样，负载调度器就可以处理大量的请求，它甚至可以调 度百台以上的服务器（同等规模的服务器），而它不会成为系统的瓶颈。VS/TUN技术对服务器有要求，即所有的服务器必须支持“IP Tunneling”或者“IP Encapsulation”协议。目前，VS/TUN的后端服务器主要运行Linux操作系统，我们没对其他操作系统进行测试。因为“IP Tunneling”正成为各个操作系统的标准协议，所以VS/TUN应该会适用运行其他操作系统的后端服务器。</p><p><strong>3. Virtual Server via Direct Routing</strong>：跟VS/TUN方法一样，VS/DR调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户。这可以极大地提高LVS集群系统的伸缩性。跟VS/TUN相比，这种方法没有IP隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连在同一物理网段上，服务器网络设备（或者设备别名）不作ARP响应，或者能将报文重定向（Redirect）到本地的Socket端口上。</p><h1 id="LVS实验"><a href="#LVS实验" class="headerlink" title="LVS实验"></a>LVS实验</h1><h2 id="1、LVS-NAT"><a href="#1、LVS-NAT" class="headerlink" title="1、LVS/NAT"></a>1、LVS/NAT</h2><p>实验配置：</p><p>DS / LB机器</p><table><thead><tr><th>地址类型</th><th>IP地址</th></tr></thead><tbody><tr><td>VIP</td><td>192.168.1.105</td></tr><tr><td>DIP</td><td>192.168.70.10</td></tr></tbody></table><p>RS / WEB服务器</p><table><thead><tr><th>站点</th><th>IP地址</th><th>默认网关</th></tr></thead><tbody><tr><td>RS1</td><td>RIP：172.10.10.20/16</td><td>GATEWAY： 172.10.10.2</td></tr><tr><td>RS2</td><td>RIP：172.10.10.30/16</td><td>GATEWAY：172.10.10.2</td></tr></tbody></table><p>DS / LB机器的网卡，添加了一块桥接的网卡，之后访问就直接访问那块桥接网卡的IP地址。这样真实的IP地址就不会暴露在公网了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.10.10.1  netmask 255.255.0.0  broadcast 172.10.255.255</span><br><span class="line"></span><br><span class="line">eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.2  netmask 255.255.255.0  broadcast 192.168.1.255</span><br></pre></td></tr></table></figure><p><strong>RS站点部署</strong></p><ol><li>使用httpd服务，这里介绍以下httpd服务，主配置文件：<code>/etc/httpd/conf/httpd.conf</code>，默认站点目录：<code>/var/www/html</code>。</li><li>需要把RS机器的默认网关修改为DS机器的IP地址</li></ol><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node02 node03</span></span><br><span class="line">yum -y install httpd</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS NODE02"</span> &gt; /var/www/html/index.html</span><br><span class="line">sed  -i <span class="string">'/GATEWAY/d'</span> /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"GATEWAY=192.168.70.10"</span> &gt;&gt;  /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure><p><strong>DS站点部署</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ipvsadm，lvs的管理工具</span></span><br><span class="line">yum -y install ipvsadm</span><br><span class="line"><span class="comment"># 打开转发配置NAT，0是关闭</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;   /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="comment"># 清除Ptables NAT表的规则</span></span><br><span class="line">iptables -t nat -F</span><br><span class="line"><span class="comment"># 添加iptables规则，让去往ens35的流量转发给192.168.70.10  公网--&gt;私网</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.70.10/24 -o ens35 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment">#清除ipvsadm的所有规则</span></span><br><span class="line">ipvsadm --clear</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置wrr加权轮询策略并添加主机</span></span><br><span class="line">ipvsadm -A -t 192.168.1.105:80 -s wrr</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加主机，将到达192.168.1.105的流量转到192.168.70.20</span></span><br><span class="line">ipvsadm -a -t 192.168.1.105:80 -r 192.168.70.20:80 -m -w 2</span><br><span class="line"><span class="comment">#添加主机，将到达192.168.1.105的流量转到192.168.70.30</span></span><br><span class="line">ipvsadm -a -t 192.168.1.105:80 -r 192.168.70.30:80 -m -w 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#ipvsadm常用选项</span></span><br><span class="line"><span class="comment">#-A : 添加Virtual Server Address（VIP+Port）</span></span><br><span class="line"><span class="comment">#-s : 定义负载均衡策略</span></span><br><span class="line"><span class="comment">#-e : 修改匹配规则</span></span><br><span class="line"><span class="comment">#-r : 指定RS的地址和端口</span></span><br><span class="line"><span class="comment">#-m : 指定为NAT</span></span><br><span class="line"><span class="comment">#-w : 指定权重</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看策略信息</span></span><br><span class="line">ipvsadm -ln</span><br></pre></td></tr></table></figure><p>之前在docker上做了一遍，到添加虚拟服务地址VSA的时候报错了，大概是LVS是要通过LINUX内核来实现，docker下完成不了对内核的改动，所以用不了。</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@00564133da53 /]<span class="comment"># sudo ipvsadm -A  -t 192.168.1.2:80 -s wrr</span></span><br><span class="line">Can<span class="string">'t initialize ipvs: Protocol not available</span></span><br><span class="line"><span class="string">Are you sure that IP Virtual Server is built in the kernel or as module?</span></span><br></pre></td></tr></table></figure><h2 id="2、LVS-DR"><a href="#2、LVS-DR" class="headerlink" title="2、LVS/DR"></a>2、LVS/DR</h2><p>环境准备：</p><p>DS / LB机器</p><table><thead><tr><th>地址类型</th><th>IP地址</th></tr></thead><tbody><tr><td>VIP</td><td>192.168.70.100</td></tr><tr><td>DIP</td><td>192.168.70.10</td></tr></tbody></table><p>RS / WEB服务器</p><table><thead><tr><th>站点</th><th>IP地址</th><th>VIP地址</th></tr></thead><tbody><tr><td>RS1</td><td>RIP：192.168.70.20</td><td>192.168.70.100 lo</td></tr><tr><td>RS2</td><td>RIP：192.168.70.30</td><td>192.168.70.100 lo</td></tr></tbody></table><p>RS部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#不能让Gateway指向node1</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/GATEWAY/d'</span> /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line">sed -i <span class="string">'/^$/d'</span> /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"GATEWAY=192.168.70.2"</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line">systemctl restart network</span><br><span class="line">systemctl restart httpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum -y install net-tools</span><br><span class="line">vip=192.168.70.100</span><br><span class="line">ifconfig lo:0 <span class="variable">$vip</span> broadcast <span class="variable">$vip</span> netmask 255.255.255.255 up</span><br><span class="line">route add -host <span class="variable">$vip</span> lo:0</span><br><span class="line"><span class="comment">#1是关闭</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="comment">#在所有RS上部署</span></span><br></pre></td></tr></table></figure><p>RS脚本：</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">yum -y install httpd net-tools</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS NODE03"</span> &gt; /var/www/html/index.html</span><br><span class="line">vip=192.168.70.100</span><br><span class="line">ifconfig lo:0 <span class="variable">$vip</span> broadcast <span class="variable">$vip</span> netmask 255.255.255.255 up</span><br><span class="line">route add -host <span class="variable">$vip</span> lo:0</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure><p>DS部署</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifconfig ens32:0 192.168.70.100 broadcast 192.168.70.255 netmask 255.255.255.0 up</span><br><span class="line"><span class="comment">#本地重定向,去往192.168.70.100的流量从本地ens32:0走</span></span><br><span class="line">route add -host 192.168.70.100 dev ens32:0</span><br><span class="line"></span><br><span class="line">ipvsadm -A -t 192.168.70.100:80 -s wrr</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.20:80 -m -w 1</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.30:80 -m -w 2</span><br><span class="line">ipvsadm -ln</span><br></pre></td></tr></table></figure><p>DS脚本</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">yum -y install net-tools ipvsadm </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"0"</span> &gt;  /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifconfig ens32:0 192.168.70.100 broadcast 192.168.70.255 netmask 255.255.255.0 up</span></span><br><span class="line"><span class="comment">#route add -host 192.168.70.100 dev ens32:0</span></span><br><span class="line">ipvsadm -A -t 192.168.70.100:80 -s wrr</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.20:80 -g -w 9</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.30:80 -g -w 1</span><br><span class="line">ipvsadm -ln</span><br><span class="line">ipvsadm -C</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;;<span class="keyword">do</span> curl 192.168.70.100:80; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;LVS简介&quot;&gt;&lt;a href=&quot;#LVS简介&quot; class=&quot;headerlink&quot; title=&quot;LVS简介&quot;&gt;&lt;/a&gt;LVS简介&lt;/h1&gt;&lt;p&gt;在已有的负载均衡技术中，IP负载均衡是效率最高的。它将一组服务器构建成一个高性能、高可用的虚拟服务器。如图，LVS一
      
    
    </summary>
    
    
      <category term="中间件" scheme="http://ymlog.cn/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>Keepalived高可用</title>
    <link href="http://ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <id>http://ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/</id>
    <published>2020-02-19T11:34:05.000Z</published>
    <updated>2020-06-16T10:15:17.354Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Keepalived简介"><a href="#Keepalived简介" class="headerlink" title="Keepalived简介"></a>Keepalived简介</h1><ul><li><p>是Linux一个轻量级的高可用解决方案，Keepalive起初是为了LVS设计的，专门用来监控集群系统中各个服务节点状态，如果某个服务器节点出现故障，keepalive将检测到后自动将节点剔除</p></li><li><p>keepalived后来加入VRRP协议，（虚拟路由冗余协议），目的是解决静态路由出现的单点故障问题，通过VRRP协议可以实现网络不间断稳定运行，因此Keepalived也具有Ha功能</p></li><li><p>两大功能：健康检查和失败切换</p><blockquote><p>健康检查：采用TCP三次握手，ICMP请求，HTTP请求，UDP echo请求等方式对负载均衡后端真实服务器进行保活。</p><p>失败切换：主要应用于配置主备模式负载均衡器，利用VRRP协议维持主备的心跳，当主负载均衡出现问题的时候，由备负载均衡器承载对应的业务，从而在最大限度上减少流量的损失</p></blockquote></li><li><p>IPVS疯转，Keepalived里面所有对LVS的相关操作并不直接使用ipvsadm客户端程序，而是直接使用ipvs提供的函数进程操作。</p></li></ul><h2 id="VRRP协议"><a href="#VRRP协议" class="headerlink" title="VRRP协议"></a>VRRP协议</h2><p>VRRP协议：</p><ol><li>VRRP协议是一种容错的主备协议，保证当主机的下一跳路由出现故障的时候，由另外一台路由来替代出现故障的路由器进行工作，通过VRRP可以在网络发生故障时，透明的进行设备切换而不影响主机之间数据通信</li><li>VRRP虚拟路由器：VRRP虚拟路由器是由多台物理路由器组成，对外共享一个或多个IP地址，这个IP地址是虚拟出来的，不属于任何一台路由器，称之为VIP。</li><li>VRRP路由器：VRRP路由器就是一台路由器，只是上面运行了VRRP协议</li><li>主路由器：虚拟路由内部有多台物理路由器，但通常只有一台物理路由器对外提供服务，主路由器是选举算法选出对外提供各种网络功能</li><li>备份路由器：VRRP组中除了主路由器之外的所有路由器，不对外提供任何服务，只接受主路由器的通告，当主路由器挂掉时，重新进行选举算法，接替master路由器</li></ol><p>三种状态：Initialize、Master、Backup</p><p>选举机制：优先级</p><blockquote><p>抢占模式下，一旦有优先级高的路由器加入，即成为Master；</p><p>非抢占模式下只要Master不挂，优先级高的路由器只能等待。</p><p>只有作为Master的VRRP路由器会一直发送VRRP广播报文。</p></blockquote><h2 id="Keepalived架构"><a href="#Keepalived架构" class="headerlink" title="Keepalived架构"></a>Keepalived架构</h2><p>KeepAlived源码模块：        <strong>check</strong>     <strong>core</strong>     <strong>libipfwc</strong>     <strong>libipvs*</strong>    <strong>vrrp</strong></p><blockquote><p>core：keepalived核心程序，比如全局配置解析，进程启动等</p><p>vrrp：实现vrrp协议的功能</p><p>check：keepalived的healthchecker子进程的目录，包括了所有健康检查方式以及对应的配置解析信息，LVS配置解析也在这里</p><p>libipfwc：iptables(ipchains库)，主要用来配置LVS中的firewall-mark</p><p>libipvs*：LVS用到的文件</p></blockquote><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_%E6%9E%B6%E6%9E%84.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_架构.png"></p><ul><li><p>Schedulerl/OMultiplexer是一个I/O复用分发调度器，它负载安排Keepalived所有内部的任务请求</p></li><li><p>Memory Mngt是一个内存管理机制，这个框架提供了访问内存的一些通用方法</p></li><li><p>Control Plane时keepalived的控制版面，可以实现对配置文件编译和解析</p></li><li><p>Core Componets</p><blockquote><ul><li>Watchdog：是计算机可靠领域简单而又非常有效的检测工具，Keepalived正式通过它监控Checkers和VRRP进程的</li><li>Checkers：这时Keepalived最基础的功能，也是最主要的功能，可以实现对服务器运行状态检测和故障隔离</li><li>VRRP Stack：这时Keepalived后来引用VRRP功能，可以实现HA集群中失败切换功能，负责负载均衡器之间的实拍切换FailOver</li><li>IPVS Wrapper：这个是IPVS功能的一个实现，IPVSwrapper模块可以设置好IPVS规则发送至内核空间并且提供给IPVS模块，最终实现IPVS模块的负载功能</li><li>Netlink Reflector：用来实现高可用集群Failover是虚拟IP（VIP）的设置和切换</li></ul></blockquote></li></ul><p>keepalived进程：</p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png"></p><h1 id="keepalived配置文件"><a href="#keepalived配置文件" class="headerlink" title="keepalived配置文件"></a>keepalived配置文件</h1><p>keepalived配置文件分为三类：</p><ol><li>global：全局配置文件</li><li>vrrpd配置</li><li>lvs配置，如果仅使用keepalived做HA，lvs可以不用配</li></ol><h3 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy /]<span class="comment"># cat /etc/keepalived/keepalived.conf | grep -Ev '^#|^$'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;<span class="comment">#全局定义</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc<span class="comment">#通知email</span></span><br><span class="line">     failover@firewall.loc </span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc<span class="comment">#Email发送者</span></span><br><span class="line">   smtp_server 192.168.200.1  <span class="comment">#SMTP服务器</span></span><br><span class="line">   smtp_connect_timeout 30 <span class="comment">#连接超时</span></span><br><span class="line">   router_id LVS_DEVEL<span class="comment">#Router-id,是路由标识，通常是主机名</span></span><br><span class="line">   vrrp_skip_check_adv_addr<span class="comment">#VRRP协议跳过健康检查通告</span></span><br><span class="line">   vrrp_strict<span class="comment">#VRRP自定义脚本</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;<span class="comment">#VRRP组</span></span><br><span class="line">    state MASTER<span class="comment">#master状态</span></span><br><span class="line">    interface eth0<span class="comment">#接口</span></span><br><span class="line">    virtual_router_id 51<span class="comment">#虚拟路由器ID，同一个局域网内</span></span><br><span class="line">    priority 100<span class="comment">#优先级</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;<span class="comment">#认证</span></span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;<span class="comment">#VIP地址，之后用户访问只需要用vip地址即可</span></span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#后面是LVS相关，这里先不写</span></span><br></pre></td></tr></table></figure><h3 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h3><p>Keepalived的详细配置</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">全局配置</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#静态IP</span></span><br><span class="line">static_ipaddress</span><br><span class="line">&#123;</span><br><span class="line"><span class="comment">#等价于ip命令：ip addr add 192.168.1.1/24 brd + dev eth0 scope global</span></span><br><span class="line">192.168.1.1/24 brd + dev eth0 scope global</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#静态路由</span></span><br><span class="line">static_routes &#123;</span><br><span class="line">src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> dev <span class="variable">$SRC_DEVICE</span> ... </span><br><span class="line">src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> via <span class="variable">$GW</span> dev <span class="variable">$SRC_DEVICE</span></span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h3><p>VRRPD：vrrp同步组和vrrp实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">VRRP Sync Groups</span><br><span class="line">同步组里的任何一个成员产生问题，则进行master和backup切换。比如内网和外网的实例不在一个同步组，其中一个网段异常，则VIP不会漂移。</span><br><span class="line">vrrp_sync_group VG_1 &#123; </span><br><span class="line">group &#123;</span><br><span class="line">inside_network<span class="comment">#这里是实例名，比如VI_1</span></span><br><span class="line">outside_network</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">notify_master /path/to/to_master.sh <span class="comment">#当切换到master时，执行脚本...</span></span><br><span class="line">notify_backup /path_to/to_backup.sh </span><br><span class="line">notify_fault <span class="string">"/path/fault.sh VG_1"</span></span><br><span class="line">notify /path/to/notify.sh  <span class="comment">#切换后发送邮件通知</span></span><br><span class="line">smtp_alert</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp实例</span><br><span class="line">主要定义漂移组的ip地址</span><br><span class="line"></span><br><span class="line">vrrp_instance inside_network &#123; </span><br><span class="line">state MASTER <span class="comment">#定义初始Initial状态，启动后根据优先级马上竞选，state不代表这台一直是master</span></span><br><span class="line">interface eth0  <span class="comment">#实例绑定的网卡</span></span><br><span class="line">track_interface &#123; eth0 eth1&#125;<span class="comment">#设置额外的监控，里面任何一个网卡出现问题，都会进入fault状态</span></span><br><span class="line">virtual_router_id 51 <span class="comment">#VRID 虚拟路由器ID</span></span><br><span class="line">priority 100 </span><br><span class="line">advert_int 1<span class="comment">#检查隔离，默认1s</span></span><br><span class="line">authentication &#123; auth_type PASS autp_pass 1234 &#125; <span class="comment">#认证设置，authe_type可以是pass和ah</span></span><br><span class="line">virtual_ipaddress &#123;192.168.200.17/24 dev eth1 192.168.200.18/24 dev eth2 label eth2:1&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#发生切换时添加/删除路由</span></span><br><span class="line">virtual_routes &#123;src 192.168.100.1 to 192.168.109.0/24 via 192.168.200.254 dev eth1&#125; </span><br><span class="line">nopreempt<span class="comment">#设置为不抢占，只能设置为state=BACKUP，且优先级最高的机器上</span></span><br><span class="line">preemtp_delay 300 </span><br><span class="line">debug<span class="comment">#Debug级别</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 192.168.200.100 443 &#123;<span class="comment">#设置一个Virtual Server：VIP+Port</span></span><br><span class="line">    delay_loop 6<span class="comment">#servce polling的delay时间</span></span><br><span class="line">    lb_algo rr<span class="comment">#LVS调度算法，有rr wrr lc wlc lblc sh dh</span></span><br><span class="line">    lb_kind NAT<span class="comment">#LVS集群模式，有NAT、DR、TUN</span></span><br><span class="line">    persistence_timeout 50<span class="comment">#会话保持时间</span></span><br><span class="line">    protocol TCP<span class="comment">#使用TCP协议，有TCP、UDP</span></span><br><span class="line">    sorry_server 192.168.200.200 1358<span class="comment">#备用机，所有的real server失效后再用</span></span><br><span class="line"></span><br><span class="line">    real_server 192.168.201.100 443 &#123;<span class="comment">#真实物理主机</span></span><br><span class="line">        weight 1<span class="comment">#权重默认为1，0为失效</span></span><br><span class="line">        inhibit_on_failure<span class="comment">#在健康检查失败后，将weight设置为0，而不是从ipvs中删除</span></span><br><span class="line"><span class="comment">#配置任意一种健康检查方式：HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK        </span></span><br><span class="line">        SSL_GET &#123;</span><br><span class="line">        url &#123;</span><br><span class="line">            path /</span><br><span class="line">        digest ff20ad2481f97b1754ef3e12ecd3a9cc<span class="comment">#SSL检查后的摘要信息(genhash工具算出)</span></span><br><span class="line">        &#125;</span><br><span class="line">            connect_timeout 3<span class="comment">#连接超时时间</span></span><br><span class="line">            nb_get_retry 3<span class="comment">#重连次数</span></span><br><span class="line">            delay_before_retry 3<span class="comment">#重连间隔时间</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         HTTP_GET &#123;</span><br><span class="line">         url &#123; </span><br><span class="line">         path /testurl/test.jsp</span><br><span class="line">         digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    TCP_CHECK &#123;<span class="comment">#TCP健康检查</span></span><br><span class="line">connect_port 80 </span><br><span class="line">bindto 192.168.1.1 </span><br><span class="line">connect_timeout 4</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">SMTP_CHECK &#123;</span><br><span class="line">host &#123;</span><br><span class="line">connect_ip &lt;IP ADDRESS&gt; </span><br><span class="line">connect_port &lt;PORT&gt;</span><br><span class="line">bindto &lt;IP ADDRESS&gt;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>lvs实例</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">lvs配置实例</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.1.1 80 &#123; </span><br><span class="line">delay_loop 3</span><br><span class="line">lb_algo wlc</span><br><span class="line">lb_kind DR</span><br><span class="line">persistence_timeout 1200 </span><br><span class="line">protocol TCP ha_suspend</span><br><span class="line">real_server 192.168.1.11 80</span><br><span class="line">&#123; </span><br><span class="line">weight 3 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">connect_timeout 3</span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br><span class="line">real_server 192.168.1.12 80 &#123;</span><br><span class="line">weight 3 </span><br><span class="line">TCP_CHECK &#123;</span><br><span class="line">    connect_timeout 3</span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h1 id="Keepalived-Nginx"><a href="#Keepalived-Nginx" class="headerlink" title="Keepalived + Nginx"></a>Keepalived + Nginx</h1><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png"></p><h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>VIP：192.168.70.199</strong></p><table><thead><tr><th>机器</th><th>IP地址</th><th>服务</th></tr></thead><tbody><tr><td>Node1</td><td>192.168.70.10</td><td>nginx  、 keepalived</td></tr><tr><td>Node2</td><td>192.168.70.20</td><td>nginx  、 keepalived</td></tr><tr><td>Web1</td><td>192.168.70.30</td><td>httpd</td></tr><tr><td>Web2</td><td>192.168.70.40</td><td>httpd</td></tr></tbody></table><h3 id="Web-1-2"><a href="#Web-1-2" class="headerlink" title="Web/1-2"></a>Web/1-2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS <span class="variable">$HOSTNAME</span>.."</span> &gt; /var/www/html/index.html</span><br></pre></td></tr></table></figure><h3 id="Node01"><a href="#Node01" class="headerlink" title="Node01"></a>Node01</h3><p><strong>node01，主节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"><span class="comment">#负载均衡中的后端服务器池</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">server 192.168.70.30;</span><br><span class="line">server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将本地的8080端口请求转发到代理服务器池中</span></span><br><span class="line">server &#123;</span><br><span class="line">listen 8080;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://webserver;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Keepalived高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#注意事项，check_nginx和花括号要有空格，track_script要写在VIP后面</span></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#定义健康检测脚本，执行间隔为1s，如果脚本执行异常，也就是Nginx down了，则优先级-20</span></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">   script <span class="string">"/root/check.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="comment">#node01为Master角色</span></span><br><span class="line">    state MASTER</span><br><span class="line"><span class="comment">#使用的接口为ens32，如果不通系统需要改，Keepalived服务起来时，VIP就挂在ens32接口上</span></span><br><span class="line">    interface ens32</span><br><span class="line"><span class="comment">#VID，同一个局域网需要相同</span></span><br><span class="line">    virtual_router_id 51</span><br><span class="line"><span class="comment">#主节点优先级，定义110，次节点为100    </span></span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line"><span class="comment">#VIP地址，如果时主主备份可以定义多个    </span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#脚本跟踪，记住空格    </span></span><br><span class="line">track_script &#123;</span><br><span class="line">    check_nginx</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment">#这一段不能用cat的形式录入，不然$会丢失</span></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C nginx --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#Num=0意味着Nginx挂了</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">chmod +x /root/check.sh</span><br></pre></td></tr></table></figure><h3 id="Node02"><a href="#Node02" class="headerlink" title="Node02"></a>Node02</h3><p><strong>node02，备份节点</strong></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">server 192.168.70.30;</span><br><span class="line">server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">listen 8080;</span><br><span class="line">server_name 192.168.20.10;</span><br><span class="line">location / &#123;</span><br><span class="line">proxy_pass http://webserver;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置Keepalive高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure><h3 id="实验效果"><a href="#实验效果" class="headerlink" title="实验效果"></a>实验效果</h3><p><strong>测试节点</strong></p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png"></p><p><strong>Down Keepalive</strong></p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png"></p><p><strong>Down Nginx</strong></p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png"></p><h1 id="Keepalived-haproxy"><a href="#Keepalived-haproxy" class="headerlink" title="Keepalived + haproxy"></a>Keepalived + haproxy</h1><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png"></p><h3 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a>实验环境准备</h3><p><strong>VIP：192.168.70.199</strong></p><table><thead><tr><th>机器</th><th>IP地址</th><th>服务</th></tr></thead><tbody><tr><td>Node1</td><td>192.168.70.10</td><td>haproxy 、keepalived</td></tr><tr><td>Node2</td><td>192.168.70.20</td><td>haproxy 、keepalived</td></tr><tr><td>Web1</td><td>192.168.70.30</td><td>mariadb</td></tr><tr><td>Web2</td><td>192.168.70.40</td><td>mariadb</td></tr></tbody></table><h3 id="MySQL双主"><a href="#MySQL双主" class="headerlink" title="MySQL双主"></a>MySQL双主</h3><p>node03</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">cat /etc/my.cnf.d/server.cnf | grep -Ev <span class="string">'#|^$'</span></span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.40' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.40',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=407;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#授权用户，便于测试</span></span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png"></p><p>node04</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment =2 '</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.30' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.30',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=402;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"> </span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png"></p><p><strong>检查MySQL主主同步是否成功：</strong></p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png"></p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png"></p><h3 id="HaProxy代理"><a href="#HaProxy代理" class="headerlink" title="HaProxy代理"></a>HaProxy代理</h3><p>Node01 / 02 的Haproxy配置相同</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/haproxy/haproxy.cfg </span></span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">listen mysql_proxy</span><br><span class="line">    <span class="built_in">bind</span>             0.0.0.0:3306</span><br><span class="line">    mode                    tcp</span><br><span class="line">    balance <span class="built_in">source</span></span><br><span class="line">    server  mysqldb1 192.168.70.30:3306 weight 1 check</span><br><span class="line">    server  mysqldb2 192.168.70.40:3306 weight 2 check</span><br><span class="line">listen stats </span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:8080</span><br><span class="line">    stats <span class="built_in">enable</span> </span><br><span class="line">    stats uri /dbs</span><br><span class="line">    stats realm haproxy\  statistics</span><br><span class="line">    stats auth admin:admin</span><br><span class="line"></span><br><span class="line">systemctl restart haproxy</span><br></pre></td></tr></table></figure><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png"></p><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png"></p><h3 id="Keepalived高可用"><a href="#Keepalived高可用" class="headerlink" title="Keepalived高可用"></a>Keepalived高可用</h3><p>node01</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node01上写触发脚本</span></span><br><span class="line"></span><br><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line"><span class="comment">#脚本所在位置</span></span><br><span class="line">   script <span class="string">"/root/check_proxy_pid.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">    chk_http_port</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check_proxy_pid.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C haproxy --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure><p>node02</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">track_script &#123;</span><br><span class="line">    chk_http_port</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure><p><img src="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png" alt="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png"></p><hr><center>【完】]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Keepalived简介&quot;&gt;&lt;a href=&quot;#Keepalived简介&quot; class=&quot;headerlink&quot; title=&quot;Keepalived简介&quot;&gt;&lt;/a&gt;Keepalived简介&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;是Linux一个轻量级的高可用解决方案，K
      
    
    </summary>
    
    
      <category term="中间件" scheme="http://ymlog.cn/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
  </entry>
  
  <entry>
    <title>Docker环境下构建HaProxy</title>
    <link href="http://ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/"/>
    <id>http://ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/</id>
    <published>2020-02-17T04:27:52.000Z</published>
    <updated>2020-06-16T10:15:09.769Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Haproxy简介说明"><a href="#Haproxy简介说明" class="headerlink" title="Haproxy简介说明"></a>Haproxy简介说明</h1><ul><li>一款高性能+代理负载均衡软件，目前使用广泛，支持实现TCP/HTTP的负载均衡</li><li>免费开源</li><li>最大并发量能达到5w</li><li>支持多种负载均衡算法，同时支持session</li><li>支持虚拟主机</li><li>拥有服务监控页面，可以了解 系统实时运行状态</li><li>通常不做正向代理，有更好的选择(Squid)</li><li>通常不做缓存代理，有更好的选择（Varnish）</li><li>不会改变请求和响应报文</li><li>不用于Web服务器</li><li>不是基于数据报的负载均衡器，看不到IP数据报</li></ul><p>haproxy文档：<a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/</a></p><h1 id="Haproxy配置文件"><a href="#Haproxy配置文件" class="headerlink" title="Haproxy配置文件"></a>Haproxy配置文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql haproxy</span><br><span class="line">/etc/haproxy/haproxy.cfg<span class="comment">#主配置文件</span></span><br><span class="line">/usr/lib/systemd/system/haproxy.service<span class="comment">#守护进程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@16a3b18f2dda /]<span class="comment"># cat /etc/haproxy/haproxy.cfg | grep -Ev '#|^$'</span></span><br><span class="line">global<span class="comment">#全局配置项</span></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2<span class="comment">#syslog服务器位置及类型</span></span><br><span class="line">    chroot      /var/lib/haproxy<span class="comment">#chroot路径：工作目录</span></span><br><span class="line">    pidfile     /var/run/haproxy.pid<span class="comment">#进程文件</span></span><br><span class="line">    maxconn     4000<span class="comment">#最大连接数</span></span><br><span class="line">    user        haproxy<span class="comment">#用户</span></span><br><span class="line">    group       haproxy<span class="comment">#组</span></span><br><span class="line">    daemon<span class="comment">#以守护进程运行</span></span><br><span class="line">    stats socket /var/lib/haproxy/stats<span class="comment">#socket通信状态</span></span><br><span class="line">defaults<span class="comment">#默认配置项</span></span><br><span class="line">    mode                    http<span class="comment">#运行模式或协议</span></span><br><span class="line">    <span class="built_in">log</span>                     global<span class="comment">#定义每个实例启动事件和流量日志</span></span><br><span class="line">    option                  httplog<span class="comment">#http日志</span></span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s<span class="comment">#http-request超时时间</span></span><br><span class="line">    timeout queue           1m<span class="comment">#队列超时时间</span></span><br><span class="line">    timeout connect         10s<span class="comment">#连接超时时间</span></span><br><span class="line">    timeout client          1m<span class="comment">#客户端超时时间</span></span><br><span class="line">    timeout server          1m<span class="comment">#服务端超时时间</span></span><br><span class="line">    timeout http-keep-alive 10s<span class="comment">#保持长连接超时时间</span></span><br><span class="line">    timeout check           10s<span class="comment">#check超时时间</span></span><br><span class="line">    maxconn                 3000<span class="comment">#定义最大并发数</span></span><br><span class="line">frontend  main *:5000<span class="comment">#前端配置，定义了一系列监听套接字，这些套接字可接受客户端请求并建立连接，监听5000端口，（bind *:80)</span></span><br><span class="line"><span class="comment">#ACL规则：(location url)</span></span><br><span class="line"><span class="comment">#测试请求的URL是以指定模式开头 </span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line"><span class="comment">#测试请求&lt;String&gt;是否以指定模式结尾    </span></span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          <span class="keyword">if</span> url_static</span><br><span class="line"><span class="comment">#如果user_backend没能匹配，指定后端的名称为app    </span></span><br><span class="line">    default_backend             app</span><br><span class="line">    </span><br><span class="line"><span class="comment">#定义后端配置：定义一系列“后端”服务器，代理会将请求转发给这些服务器</span></span><br><span class="line"><span class="comment">#static组后端</span></span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin<span class="comment">#负载均衡算法为轮询</span></span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line"></span><br><span class="line"><span class="comment">#app组后端</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br></pre></td></tr></table></figure><p>配置文件结构</p><ul><li>全局配置项</li><li>默认配置项</li><li>前端配置项</li><li>后端配置项</li></ul><p>监听配置：通过关联前端配置想和后端配置项（frontend &amp; backend）定义一个完整代理。通常只对TCP流量有用。</p><h1 id="Docker-amp-Harpoxy"><a href="#Docker-amp-Harpoxy" class="headerlink" title="Docker &amp; Harpoxy"></a>Docker &amp; Harpoxy</h1><p>三台机器：  </p><table><thead><tr><th>角色</th><th>IP地址</th><th>功能</th></tr></thead><tbody><tr><td>WEB1</td><td>172.18.12.10</td><td>httpd – THIS IS WEB1…</td></tr><tr><td>WEB2</td><td>172.18.12.20</td><td>httpd – THIS IS WEB2…</td></tr><tr><td>Proxy</td><td>172.18.12.30</td><td>CentOS7 / Haproxy</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#安装docker环境</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 </span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo </span><br><span class="line">yum install docker-ce -y</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"registry-mirrors"</span>: [<span class="string">"https://ukdws02a.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建docker桥接网络，用于给容器分配IP地址</span></span><br><span class="line">docker network create --driver bridge --subnet=172.18.12.0/16 --gateway 172.18.1.1 mynet</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建后端站点，分别为web1和web2</span></span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web1.com --name web1 --network=mynet --ip 172.18.12.10 httpd</span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web2.com --name web2 --network=mynet --ip 172.18.12.20 httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB1..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web1:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line">sleep 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB2..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web2:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建代理服务器haproxy，镜像为centos7</span></span><br><span class="line"><span class="comment">#参数说明：--privilege + /usr/bin/init 是为了能够让程序以root运行，Container默认的Root只是相当于普通用户</span></span><br><span class="line"><span class="comment">#TZ  ： 指定时区</span></span><br><span class="line"><span class="comment">#-h   ： 指定域名</span></span><br><span class="line"><span class="comment">#--network： 指定网络类型为我创建的网络</span></span><br><span class="line">docker run -e TZ=<span class="string">'Asia/Shanghai'</span> --privileged -itd -h haproxy.com --name myhaproxy --network=mynet --ip 172.18.12.30 centos:7 /usr/sbin/init</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否连同</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.10'</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.20'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装haproxy，并配置后端节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'yum -y install haproxy -q'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.10:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.20:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"等待服务加载...."</span></span><br><span class="line">sleep 3</span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">"echo '-------------负载均衡演示---------------' &amp;&amp; for i in &#123;1..10&#125;; do curl 172.18.12.30:5000; done"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#净化检测命令</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------开始删除配置------------"</span></span><br><span class="line">docker rm myhaproxy --force</span><br><span class="line">docker rm web1 web2 --force</span><br><span class="line">docker network rm mynet</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------检查是否有残留------------"</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">" "</span></span><br><span class="line">docker ps -a</span><br><span class="line">rm /root/index.html* -rf</span><br></pre></td></tr></table></figure><h1 id="负载均衡结果演示"><a href="#负载均衡结果演示" class="headerlink" title="负载均衡结果演示"></a>负载均衡结果演示</h1><p><img src="https://i.loli.net/2020/03/22/nCfvmt7hi8pAEqd.png" alt="docker_haproxy_1.png"></p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h1 id=&quot;Haproxy简介说明&quot;&gt;&lt;a href=&quot;#Haproxy简介说明&quot; class=&quot;headerlink&quot; title=&quot;Haproxy简介说明&quot;&gt;&lt;/a&gt;Haproxy简介说明&lt;/h1&gt;&lt;ul&gt;
&lt;li&gt;一款高性能+代理负载均衡软件，目前使用广泛，支持实现TC
      
    
    </summary>
    
    
      <category term="容器" scheme="http://ymlog.cn/categories/%E5%AE%B9%E5%99%A8/"/>
    
    
  </entry>
  
</feed>
