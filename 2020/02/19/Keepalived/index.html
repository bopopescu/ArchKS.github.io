<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Keepalived高可用 | zen's blog</title><meta name="description" content="Keepalived高可用"><meta name="keywords" content="Keepalived"><meta name="author" content="ZEN"><meta name="copyright" content="ZEN"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="../../../../img/favicon.ico"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="crossorigin"/><link rel="preconnect" href="https://fonts.googleapis.com" crossorigin="crossorigin"/><meta name="twitter:card" content="summary"><meta name="twitter:title" content="Keepalived高可用"><meta name="twitter:description" content="Keepalived高可用"><meta name="twitter:image" content="http://ymlog.cn/img/post.jpg"><meta property="og:type" content="article"><meta property="og:title" content="Keepalived高可用"><meta property="og:url" content="http://ymlog.cn/2020/02/19/Keepalived/"><meta property="og:site_name" content="zen's blog"><meta property="og:description" content="Keepalived高可用"><meta property="og:image" content="http://ymlog.cn/img/post.jpg"><script src="../../../../https:/cdn.jsdelivr.net/npm/js-cookie/dist/js.cookie.min.js"></script><script>var autoChangeMode = '1'
var t = Cookies.get("theme")
if (autoChangeMode == '1'){
  var isDarkMode = window.matchMedia("(prefers-color-scheme: dark)").matches
  var isLightMode = window.matchMedia("(prefers-color-scheme: light)").matches
  var isNotSpecified = window.matchMedia("(prefers-color-scheme: no-preference)").matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined){
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport){
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour < 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
  }
  } else if (t == 'light') activateLightMode()
  else activateDarkMode()

} else if (autoChangeMode == '2'){
  now = new Date();
  hour = now.getHours();
  isNight = hour < 6 || hour >= 18
  if(t === undefined) isNight? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode() 
} else {
  if ( t == 'dark' ) activateDarkMode()
  else if ( t == 'light') activateLightMode()
}

function activateDarkMode(){
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null){
    document.querySelector('meta[name="theme-color"]').setAttribute('content','#000')
  }
}
function activateLightMode(){
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null){
  document.querySelector('meta[name="theme-color"]').setAttribute('content','#fff')
  }
}</script><link rel="stylesheet" href="../../../../css/index.css"><link rel="stylesheet" href="../../../../https:/cdn.jsdelivr.net/npm/font-awesome@latest/css/font-awesome.min.css"><link rel="stylesheet" href="../../../../https:/cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="canonical" href="http://ymlog.cn/2020/02/19/Keepalived/"><link rel="prev" title="Linux Virtual Server" href="../../../../http:/ymlog.cn/2020/02/19/LVS/"><link rel="next" title="Docker环境下构建HaProxy" href="../../../../http:/ymlog.cn/2020/02/17/Docker_Build_HaProxy/"><script async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script><script>(adsbygoogle = window.adsbygoogle || []).push({
  google_ad_client: '',
  enable_page_level_ads: 'true'
});</script><script>(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-171617191-1', 'auto');
ga('send', 'pageview');
</script><link rel="stylesheet" href="../../../../https:/fonts.googleapis.com/css?family=Titillium+Web"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"cookieDomain":"https://ymlog.cn","msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: true,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  highlightShrink: 'false',
  isFontAwesomeV5: false,
  isPhotoFigcaption: false
  
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isSidebar: true  
  }</script><noscript><style>
#page-header {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.0"><link rel="alternate" href="atom.xml" title="zen's blog" type="application/atom+xml">
</head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="../img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="../archives/"><div class="headline">文章</div><div class="length_num">36</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="../tags/"><div class="headline">标签</div><div class="length_num">23</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="../categories/"><div class="headline">分类</div><div class="length_num">8</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="../index.html"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="../archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="../tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="../categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="../link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div></div></div></div><i class="fa fa-arrow-right on" id="toggle-sidebar" aria-hidden="true">     </i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#Keepalived简介"><span class="toc-number">1.</span> <span class="toc-text">Keepalived简介</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#VRRP协议"><span class="toc-number">1.1.</span> <span class="toc-text">VRRP协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Keepalived架构"><span class="toc-number">1.2.</span> <span class="toc-text">Keepalived架构</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#keepalived配置文件"><span class="toc-number">2.</span> <span class="toc-text">keepalived配置文件</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#总体"><span class="toc-number">2.0.1.</span> <span class="toc-text">总体</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#全局"><span class="toc-number">2.0.2.</span> <span class="toc-text">全局</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#VRRP"><span class="toc-number">2.0.3.</span> <span class="toc-text">VRRP</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#LVS"><span class="toc-number">2.0.4.</span> <span class="toc-text">LVS</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Keepalived-Nginx"><span class="toc-number">3.</span> <span class="toc-text">Keepalived + Nginx</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#环境准备"><span class="toc-number">3.0.1.</span> <span class="toc-text">环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Web-1-2"><span class="toc-number">3.0.2.</span> <span class="toc-text">Web&#x2F;1-2</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node01"><span class="toc-number">3.0.3.</span> <span class="toc-text">Node01</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Node02"><span class="toc-number">3.0.4.</span> <span class="toc-text">Node02</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#实验效果"><span class="toc-number">3.0.5.</span> <span class="toc-text">实验效果</span></a></li></ol></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Keepalived-haproxy"><span class="toc-number">4.</span> <span class="toc-text">Keepalived + haproxy</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#实验环境准备"><span class="toc-number">4.0.1.</span> <span class="toc-text">实验环境准备</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MySQL双主"><span class="toc-number">4.0.2.</span> <span class="toc-text">MySQL双主</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#HaProxy代理"><span class="toc-number">4.0.3.</span> <span class="toc-text">HaProxy代理</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#Keepalived高可用"><span class="toc-number">4.0.4.</span> <span class="toc-text">Keepalived高可用</span></a></li></ol></li></ol></li></ol></div></div></div><div id="body-wrap"><div class="post-bg" id="nav" style="background-image: url(/img/post.jpg)"><div id="page-header"><span class="pull_left" id="blog_name"><a class="blog_title" id="site-name" href="../index.html">zen's blog</a></span><span class="pull_right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="../index.html"><i class="fa-fw fa fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="../archives/"><i class="fa-fw fa fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="../tags/"><i class="fa-fw fa fa-tags"></i><span> Tags</span></a></div><div class="menus_item"><a class="site-page" href="../categories/"><i class="fa-fw fa fa-folder-open"></i><span> Categories</span></a></div><div class="menus_item"><a class="site-page" href="../link/"><i class="fa-fw fa fa-link"></i><span> Link</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fa fa-bars fa-fw" aria-hidden="true"></i></a></span></span></div><div id="post-info"><div id="post-title"><div class="posttitle">Keepalived高可用</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-02-19 19:34:05"><i class="fa fa-calendar" aria-hidden="true"></i> 发表于 2020-02-19</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-05 01:19:24"><i class="fa fa-history" aria-hidden="true"></i> 更新于 2020-07-05</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fa fa-inbox post-meta__icon" aria-hidden="true"></i><a class="post-meta__categories" href="../../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"></span><span class="post-meta-commentcount"></span></div></div></div></div><main class="layout_post" id="content-inner"><article id="post"><div id="article-container"><blockquote>
<p>念两句诗<br>夜饮东坡醒复醉，归来仿佛三更。家童鼻息已雷鸣。敲门都不应，倚杖听江声。<br>长恨此身非我有，何时忘却营营？夜阑风静縠纹平。小舟从此逝，江海寄馀生。</p>
</blockquote>
<a id="more"></a>

<h1 id="Keepalived简介"><a href="#Keepalived简介" class="headerlink" title="Keepalived简介"></a>Keepalived简介</h1><ul>
<li><p>是Linux一个轻量级的高可用解决方案，Keepalive起初是为了LVS设计的，专门用来监控集群系统中各个服务节点状态，如果某个服务器节点出现故障，keepalive将检测到后自动将节点剔除</p>
</li>
<li><p>keepalived后来加入VRRP协议，（虚拟路由冗余协议），目的是解决静态路由出现的单点故障问题，通过VRRP协议可以实现网络不间断稳定运行，因此Keepalived也具有Ha功能</p>
</li>
<li><p>两大功能：健康检查和失败切换</p>
<blockquote>
<p>健康检查：采用TCP三次握手，ICMP请求，HTTP请求，UDP echo请求等方式对负载均衡后端真实服务器进行保活。</p>
<p>失败切换：主要应用于配置主备模式负载均衡器，利用VRRP协议维持主备的心跳，当主负载均衡出现问题的时候，由备负载均衡器承载对应的业务，从而在最大限度上减少流量的损失</p>
</blockquote>
</li>
<li><p>IPVS疯转，Keepalived里面所有对LVS的相关操作并不直接使用ipvsadm客户端程序，而是直接使用ipvs提供的函数进程操作。</p>
</li>
</ul>
<h2 id="VRRP协议"><a href="#VRRP协议" class="headerlink" title="VRRP协议"></a>VRRP协议</h2><p>VRRP协议：</p>
<ol>
<li>VRRP协议是一种容错的主备协议，保证当主机的下一跳路由出现故障的时候，由另外一台路由来替代出现故障的路由器进行工作，通过VRRP可以在网络发生故障时，透明的进行设备切换而不影响主机之间数据通信</li>
<li>VRRP虚拟路由器：VRRP虚拟路由器是由多台物理路由器组成，对外共享一个或多个IP地址，这个IP地址是虚拟出来的，不属于任何一台路由器，称之为VIP。</li>
<li>VRRP路由器：VRRP路由器就是一台路由器，只是上面运行了VRRP协议</li>
<li>主路由器：虚拟路由内部有多台物理路由器，但通常只有一台物理路由器对外提供服务，主路由器是选举算法选出对外提供各种网络功能</li>
<li>备份路由器：VRRP组中除了主路由器之外的所有路由器，不对外提供任何服务，只接受主路由器的通告，当主路由器挂掉时，重新进行选举算法，接替master路由器</li>
</ol>
<p>三种状态：Initialize、Master、Backup</p>
<p>选举机制：优先级</p>
<blockquote>
<p>抢占模式下，一旦有优先级高的路由器加入，即成为Master；</p>
<p>非抢占模式下只要Master不挂，优先级高的路由器只能等待。</p>
<p>只有作为Master的VRRP路由器会一直发送VRRP广播报文。</p>
</blockquote>
<h2 id="Keepalived架构"><a href="#Keepalived架构" class="headerlink" title="Keepalived架构"></a>Keepalived架构</h2><p>KeepAlived源码模块：        <strong>check</strong>     <strong>core</strong>     <strong>libipfwc</strong>     <strong>libipvs*</strong>    <strong>vrrp</strong></p>
<blockquote>
<p>core：keepalived核心程序，比如全局配置解析，进程启动等</p>
<p>vrrp：实现vrrp协议的功能</p>
<p>check：keepalived的healthchecker子进程的目录，包括了所有健康检查方式以及对应的配置解析信息，LVS配置解析也在这里</p>
<p>libipfwc：iptables(ipchains库)，主要用来配置LVS中的firewall-mark</p>
<p>libipvs*：LVS用到的文件</p>
</blockquote>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_%E6%9E%B6%E6%9E%84.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_架构.png"></p>
<ul>
<li><p>Schedulerl/OMultiplexer是一个I/O复用分发调度器，它负载安排Keepalived所有内部的任务请求</p>
</li>
<li><p>Memory Mngt是一个内存管理机制，这个框架提供了访问内存的一些通用方法</p>
</li>
<li><p>Control Plane时keepalived的控制版面，可以实现对配置文件编译和解析</p>
</li>
<li><p>Core Componets</p>
<blockquote>
<ul>
<li>Watchdog：是计算机可靠领域简单而又非常有效的检测工具，Keepalived正式通过它监控Checkers和VRRP进程的</li>
<li>Checkers：这时Keepalived最基础的功能，也是最主要的功能，可以实现对服务器运行状态检测和故障隔离</li>
<li>VRRP Stack：这时Keepalived后来引用VRRP功能，可以实现HA集群中失败切换功能，负责负载均衡器之间的实拍切换FailOver</li>
<li>IPVS Wrapper：这个是IPVS功能的一个实现，IPVSwrapper模块可以设置好IPVS规则发送至内核空间并且提供给IPVS模块，最终实现IPVS模块的负载功能</li>
<li>Netlink Reflector：用来实现高可用集群Failover是虚拟IP（VIP）的设置和切换</li>
</ul>
</blockquote>
</li>
</ul>
<p>keepalived进程：</p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png"></p>
<h1 id="keepalived配置文件"><a href="#keepalived配置文件" class="headerlink" title="keepalived配置文件"></a>keepalived配置文件</h1><p>keepalived配置文件分为三类：</p>
<ol>
<li>global：全局配置文件</li>
<li>vrrpd配置</li>
<li>lvs配置，如果仅使用keepalived做HA，lvs可以不用配</li>
</ol>
<h3 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">[root@haproxy /]<span class="comment"># cat /etc/keepalived/keepalived.conf | grep -Ev '^#|^$'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;							<span class="comment">#全局定义</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc				<span class="comment">#通知email</span></span><br><span class="line">     failover@firewall.loc 	</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc	<span class="comment">#Email发送者</span></span><br><span class="line">   smtp_server 192.168.200.1  	<span class="comment">#SMTP服务器</span></span><br><span class="line">   smtp_connect_timeout 30 		<span class="comment">#连接超时</span></span><br><span class="line">   router_id LVS_DEVEL			<span class="comment">#Router-id,是路由标识，通常是主机名</span></span><br><span class="line">   vrrp_skip_check_adv_addr		<span class="comment">#VRRP协议跳过健康检查通告</span></span><br><span class="line">   vrrp_strict					<span class="comment">#VRRP自定义脚本</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;			<span class="comment">#VRRP组</span></span><br><span class="line">    state MASTER				<span class="comment">#master状态</span></span><br><span class="line">    interface eth0				<span class="comment">#接口</span></span><br><span class="line">    virtual_router_id 51		<span class="comment">#虚拟路由器ID，同一个局域网内</span></span><br><span class="line">    priority 100				<span class="comment">#优先级</span></span><br><span class="line">    advert_int 1				</span><br><span class="line">    authentication &#123;			<span class="comment">#认证</span></span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;			<span class="comment">#VIP地址，之后用户访问只需要用vip地址即可</span></span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#后面是LVS相关，这里先不写</span></span><br></pre></td></tr></table></figure>



<h3 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h3><p>Keepalived的详细配置</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">全局配置</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">#静态IP</span></span><br><span class="line">	static_ipaddress</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">#等价于ip命令：ip addr add 192.168.1.1/24 brd + dev eth0 scope global</span></span><br><span class="line">		192.168.1.1/24 brd + dev eth0 scope global</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#静态路由</span></span><br><span class="line">	static_routes &#123;</span><br><span class="line">		src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> dev <span class="variable">$SRC_DEVICE</span> ... </span><br><span class="line">		src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> via <span class="variable">$GW</span> dev <span class="variable">$SRC_DEVICE</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h3><p>VRRPD：vrrp同步组和vrrp实例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">VRRP Sync Groups</span><br><span class="line">同步组里的任何一个成员产生问题，则进行master和backup切换。比如内网和外网的实例不在一个同步组，其中一个网段异常，则VIP不会漂移。</span><br><span class="line">vrrp_sync_group VG_1 &#123; </span><br><span class="line">	group &#123;</span><br><span class="line">	inside_network	<span class="comment">#这里是实例名，比如VI_1</span></span><br><span class="line">	outside_network</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	notify_master /path/to/to_master.sh 	<span class="comment">#当切换到master时，执行脚本...</span></span><br><span class="line">	notify_backup /path_to/to_backup.sh </span><br><span class="line">	notify_fault <span class="string">"/path/fault.sh VG_1"</span></span><br><span class="line">	notify /path/to/notify.sh 			 	<span class="comment">#切换后发送邮件通知</span></span><br><span class="line">	smtp_alert</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp实例</span><br><span class="line">主要定义漂移组的ip地址</span><br><span class="line"></span><br><span class="line">vrrp_instance inside_network &#123; </span><br><span class="line">	state MASTER 	<span class="comment">#定义初始Initial状态，启动后根据优先级马上竞选，state不代表这台一直是master</span></span><br><span class="line">	interface eth0  <span class="comment">#实例绑定的网卡</span></span><br><span class="line">	track_interface &#123; eth0 eth1&#125;	<span class="comment">#设置额外的监控，里面任何一个网卡出现问题，都会进入fault状态</span></span><br><span class="line">	virtual_router_id 51 <span class="comment">#VRID 虚拟路由器ID</span></span><br><span class="line">	priority 100 </span><br><span class="line">	advert_int 1	<span class="comment">#检查隔离，默认1s</span></span><br><span class="line">	authentication &#123; auth_type PASS autp_pass 1234 &#125; <span class="comment">#认证设置，authe_type可以是pass和ah</span></span><br><span class="line">	virtual_ipaddress &#123;192.168.200.17/24 dev eth1 192.168.200.18/24 dev eth2 label eth2:1&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">#发生切换时添加/删除路由</span></span><br><span class="line">	virtual_routes &#123;src 192.168.100.1 to 192.168.109.0/24 via 192.168.200.254 dev eth1&#125; </span><br><span class="line">	nopreempt	<span class="comment">#设置为不抢占，只能设置为state=BACKUP，且优先级最高的机器上</span></span><br><span class="line">	preemtp_delay 300 </span><br><span class="line">	debug			<span class="comment">#Debug级别</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">virtual_server 192.168.200.100 443 &#123;		<span class="comment">#设置一个Virtual Server：VIP+Port</span></span><br><span class="line">    delay_loop 6							<span class="comment">#servce polling的delay时间</span></span><br><span class="line">    lb_algo rr								<span class="comment">#LVS调度算法，有rr wrr lc wlc lblc sh dh</span></span><br><span class="line">    lb_kind NAT								<span class="comment">#LVS集群模式，有NAT、DR、TUN</span></span><br><span class="line">    persistence_timeout 50					<span class="comment">#会话保持时间</span></span><br><span class="line">    protocol TCP							<span class="comment">#使用TCP协议，有TCP、UDP</span></span><br><span class="line">    sorry_server 192.168.200.200 1358		<span class="comment">#备用机，所有的real server失效后再用</span></span><br><span class="line"></span><br><span class="line">    real_server 192.168.201.100 443 &#123;		<span class="comment">#真实物理主机</span></span><br><span class="line">        weight 1							<span class="comment">#权重默认为1，0为失效</span></span><br><span class="line">        inhibit_on_failure					<span class="comment">#在健康检查失败后，将weight设置为0，而不是从ipvs中删除</span></span><br><span class="line"><span class="comment">#配置任意一种健康检查方式：HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK        </span></span><br><span class="line">        SSL_GET &#123;</span><br><span class="line">        	url &#123;</span><br><span class="line">            path /</span><br><span class="line">        	digest ff20ad2481f97b1754ef3e12ecd3a9cc	<span class="comment">#SSL检查后的摘要信息(genhash工具算出)</span></span><br><span class="line">        &#125;</span><br><span class="line">            connect_timeout 3				<span class="comment">#连接超时时间</span></span><br><span class="line">            nb_get_retry 3					<span class="comment">#重连次数</span></span><br><span class="line">            delay_before_retry 3			<span class="comment">#重连间隔时间</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         HTTP_GET &#123;</span><br><span class="line">         url &#123; </span><br><span class="line">         path /testurl/test.jsp</span><br><span class="line">         digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">         &#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    	</span><br><span class="line">    	TCP_CHECK &#123;						<span class="comment">#TCP健康检查</span></span><br><span class="line">		connect_port 80 </span><br><span class="line">		bindto 192.168.1.1 </span><br><span class="line">		connect_timeout 4</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		SMTP_CHECK &#123;</span><br><span class="line">			host &#123;</span><br><span class="line">			connect_ip &lt;IP ADDRESS&gt; </span><br><span class="line">			connect_port &lt;PORT&gt;</span><br><span class="line">			bindto &lt;IP ADDRESS&gt;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>lvs实例</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">lvs配置实例</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.1.1 80 &#123; </span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo wlc</span><br><span class="line">	lb_kind DR</span><br><span class="line">	persistence_timeout 1200 </span><br><span class="line">	protocol TCP ha_suspend</span><br><span class="line">	real_server 192.168.1.11 80</span><br><span class="line">	&#123; </span><br><span class="line">		weight 3 </span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">			connect_timeout 3</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	real_server 192.168.1.12 80 &#123;</span><br><span class="line">		weight 3 </span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">    		connect_timeout 3</span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Keepalived-Nginx"><a href="#Keepalived-Nginx" class="headerlink" title="Keepalived + Nginx"></a>Keepalived + Nginx</h1><p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png"></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>VIP：192.168.70.199</strong></p>
<table>
<thead>
<tr>
<th>机器</th>
<th>IP地址</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>Node1</td>
<td>192.168.70.10</td>
<td>nginx  、 keepalived</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.70.20</td>
<td>nginx  、 keepalived</td>
</tr>
<tr>
<td>Web1</td>
<td>192.168.70.30</td>
<td>httpd</td>
</tr>
<tr>
<td>Web2</td>
<td>192.168.70.40</td>
<td>httpd</td>
</tr>
</tbody></table>
<h3 id="Web-1-2"><a href="#Web-1-2" class="headerlink" title="Web/1-2"></a>Web/1-2</h3><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS <span class="variable">$HOSTNAME</span>.."</span> &gt; /var/www/html/index.html</span><br></pre></td></tr></table></figure>



<h3 id="Node01"><a href="#Node01" class="headerlink" title="Node01"></a>Node01</h3><p><strong>node01，主节点</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"><span class="comment">#负载均衡中的后端服务器池</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">	server 192.168.70.30;</span><br><span class="line">	server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将本地的8080端口请求转发到代理服务器池中</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://webserver;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Keepalived高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#注意事项，check_nginx和花括号要有空格，track_script要写在VIP后面</span></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#定义健康检测脚本，执行间隔为1s，如果脚本执行异常，也就是Nginx down了，则优先级-20</span></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">   script <span class="string">"/root/check.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="comment">#node01为Master角色</span></span><br><span class="line">    state MASTER</span><br><span class="line"><span class="comment">#使用的接口为ens32，如果不通系统需要改，Keepalived服务起来时，VIP就挂在ens32接口上</span></span><br><span class="line">    interface ens32</span><br><span class="line"><span class="comment">#VID，同一个局域网需要相同</span></span><br><span class="line">    virtual_router_id 51</span><br><span class="line"><span class="comment">#主节点优先级，定义110，次节点为100    </span></span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line"><span class="comment">#VIP地址，如果时主主备份可以定义多个    </span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#脚本跟踪，记住空格    </span></span><br><span class="line">track_script &#123;</span><br><span class="line">    check_nginx</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment">#这一段不能用cat的形式录入，不然$会丢失</span></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C nginx --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#Num=0意味着Nginx挂了</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">chmod +x /root/check.sh</span><br></pre></td></tr></table></figure>



<h3 id="Node02"><a href="#Node02" class="headerlink" title="Node02"></a>Node02</h3><p><strong>node02，备份节点</strong></p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">	server 192.168.70.30;</span><br><span class="line">	server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	server_name 192.168.20.10;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://webserver;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置Keepalive高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>



<h3 id="实验效果"><a href="#实验效果" class="headerlink" title="实验效果"></a>实验效果</h3><p><strong>测试节点</strong></p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png"></p>
<p><strong>Down Keepalive</strong></p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png"></p>
<p><strong>Down Nginx</strong></p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png"></p>
<h1 id="Keepalived-haproxy"><a href="#Keepalived-haproxy" class="headerlink" title="Keepalived + haproxy"></a>Keepalived + haproxy</h1><p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png"></p>
<h3 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a>实验环境准备</h3><p><strong>VIP：192.168.70.199</strong></p>
<table>
<thead>
<tr>
<th>机器</th>
<th>IP地址</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>Node1</td>
<td>192.168.70.10</td>
<td>haproxy 、keepalived</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.70.20</td>
<td>haproxy 、keepalived</td>
</tr>
<tr>
<td>Web1</td>
<td>192.168.70.30</td>
<td>mariadb</td>
</tr>
<tr>
<td>Web2</td>
<td>192.168.70.40</td>
<td>mariadb</td>
</tr>
</tbody></table>
<h3 id="MySQL双主"><a href="#MySQL双主" class="headerlink" title="MySQL双主"></a>MySQL双主</h3><p>node03</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">cat /etc/my.cnf.d/server.cnf | grep -Ev <span class="string">'#|^$'</span></span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.40' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.40',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=407;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#授权用户，便于测试</span></span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure>

<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png"></p>
<p>node04</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment =2 '</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.30' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.30',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=402;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"> </span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure>

<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png"></p>
<p><strong>检查MySQL主主同步是否成功：</strong></p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png"></p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png"></p>
<h3 id="HaProxy代理"><a href="#HaProxy代理" class="headerlink" title="HaProxy代理"></a>HaProxy代理</h3><p>Node01 / 02 的Haproxy配置相同</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/haproxy/haproxy.cfg </span></span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">listen mysql_proxy</span><br><span class="line">    <span class="built_in">bind</span>         	    0.0.0.0:3306</span><br><span class="line">    mode                    tcp</span><br><span class="line">    balance <span class="built_in">source</span></span><br><span class="line">    server  mysqldb1 192.168.70.30:3306 weight 1 check</span><br><span class="line">    server  mysqldb2 192.168.70.40:3306 weight 2 check</span><br><span class="line">listen stats </span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:8080</span><br><span class="line">    stats <span class="built_in">enable</span> </span><br><span class="line">    stats uri /dbs</span><br><span class="line">    stats realm haproxy\  statistics</span><br><span class="line">    stats auth admin:admin</span><br><span class="line"></span><br><span class="line">systemctl restart haproxy</span><br></pre></td></tr></table></figure>



<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png"></p>
<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png"></p>
<h3 id="Keepalived高可用"><a href="#Keepalived高可用" class="headerlink" title="Keepalived高可用"></a>Keepalived高可用</h3><p>node01</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment">#node01上写触发脚本</span></span><br><span class="line"></span><br><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line"><span class="comment">#脚本所在位置</span></span><br><span class="line">   script <span class="string">"/root/check_proxy_pid.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">    	chk_http_port</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check_proxy_pid.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C haproxy --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>



<p>node02</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">    	chk_http_port</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>





<p><img src="" class="lazyload" data-src="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png"  alt="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png"></p>
<hr>
<center>【完】

</center></div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">ZEN</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="../../../../http:/ymlog.cn/2020/02/19/Keepalived/">http://ymlog.cn/2020/02/19/Keepalived/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://ymlog.cn" target="_blank">zen's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="../../../../tags/Keepalived/">Keepalived</a></div><div class="post_share"><div class="social-share" data-image="/img/post.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="../../../../https:/cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="../../../../https:/cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination_post" id="pagination"><div class="prev-post pull_left"><a href="../LVS/"><img class="prev_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Linux Virtual Server</div></div></a></div><div class="next-post pull_right"><a href="../../17/Docker_Build_HaProxy/"><img class="next_cover lazyload" data-src="/img/post.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">Docker环境下构建HaProxy</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 By ZEN</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section class="rightside" id="rightside"><div id="rightside-config-hide"><i class="fa fa-book" id="readmode" title="阅读模式"></i><i class="fa fa-plus" id="font_plus" title="放大字体"></i><i class="fa fa-minus" id="font_minus" title="缩小字体"></i><a class="translate_chn_to_cht" id="translateLink" href="javascript:translatePage();" title="简繁转换" target="_self">繁</a><i class="darkmode fa fa-moon-o" id="darkmode" title="夜间模式"></i></div><div id="rightside-config-show"><div id="rightside_config" title="设置"><i class="fa fa-cog" aria-hidden="true"></i></div><i class="fa fa-list-ul close" id="mobile-toc-button" title="目录" aria-hidden="true"></i><i class="fa fa-arrow-up" id="go-up" title="回到顶部" aria-hidden="true"></i></div></section><script src="../../../../https:/cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="../../../../js/utils.js"></script><script src="../../../../js/main.js"></script><script src="../../../../js/tw_cn.js"></script><script src="../../../../https:/cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script src="../../../../https:/cdn.jsdelivr.net/npm/instant.page@latest/instantpage.min.js" type="module"></script><script src="../../../../https:/cdn.jsdelivr.net/npm/lazysizes@latest/lazysizes.min.js" async=""></script><script>if (document.getElementsByClassName('mermaid').length) {
  loadScript('https://cdn.jsdelivr.net/npm/mermaid/dist/mermaid.min.js',function () {
    mermaid.initialize({
      theme: 'default',
  })
})
}</script></body></html>