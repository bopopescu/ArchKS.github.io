<!doctype html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
    
    <title>Docker环境下构建HaProxy | 无心而为</title>
    
    <link rel="alternative" href="/atom.xml" title="无心而为" type="application/atom+xml">
    
    
<link rel="stylesheet" href="/css/style.css">

    
    <link rel="stylesheet" href="/libs/fancybox/jquery.fancybox.css" charset="utf-8">
    
    <!--[if lt IE 9]>
    <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
    <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
<meta name="generator" content="Hexo 4.2.0"></head>
<body class="site">
    <header class="site-header">
        <h1 class="site-title"><a href="/">无心而为</a></h1>
        <nav class="site-nav">
            <ul class="nav">
                
                <li><a href="/archives">Archives</a></li>
                
                
                <li><a href="/atom.xml" title="RSS Feed">rss</a></li>
                
                <li><a class="toggle-search" href="#search">search</a></li>
            </ul>
        </nav>
        <div class="site-search" id="search">
            <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" class="search-form-input" placeholder="Search"><input type="hidden" name="sitesearch" value="http://ymlog.cn"></form>
        </div>
        
            <div class="site-header-background" style="background-image:url(http://reumia.github.io/hexo-theme-zzoman2015/images/background-zzoman2015.jpg)"></div>
        
    </header>
    <div class="site-body">
        <div class="global-width">
    <article class="article" data-layout="post" data-slug="Docker环境下构建HaProxy">
        <div class="article-content">
            
            
            <header class="article-header">
                <div class="article-meta">
                    <a href="/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/" class="article-date">
  <time datetime="2020-02-17T04:27:52.000Z">2020-02-17</time>
</a>
                    
  <div class="article-category categories">
    <a class="category-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a>
  </div>

                    
                </div>
                
    <h1 class="article-title" itemprop="name">
      <a href="/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/">Docker环境下构建HaProxy</a>
    </h1>

            </header>
            
            <div class="article-body">
                <h1 id="Haproxy简介说明"><a href="#Haproxy简介说明" class="headerlink" title="Haproxy简介说明"></a>Haproxy简介说明</h1><ul>
<li>一款高性能+代理负载均衡软件，目前使用广泛，支持实现TCP/HTTP的负载均衡</li>
<li>免费开源</li>
<li>最大并发量能达到5w</li>
<li>支持多种负载均衡算法，同时支持session</li>
<li>支持虚拟主机</li>
<li>拥有服务监控页面，可以了解 系统实时运行状态</li>
<li>通常不做正向代理，有更好的选择(Squid)</li>
<li>通常不做缓存代理，有更好的选择（Varnish）</li>
<li>不会改变请求和响应报文</li>
<li>不用于Web服务器</li>
<li>不是基于数据报的负载均衡器，看不到IP数据报</li>
</ul>
<p>haproxy文档：<a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/</a></p>
<h1 id="Haproxy配置文件"><a href="#Haproxy配置文件" class="headerlink" title="Haproxy配置文件"></a>Haproxy配置文件</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">rpm -ql haproxy</span><br><span class="line">/etc/haproxy/haproxy.cfg	<span class="comment">#主配置文件</span></span><br><span class="line">/usr/lib/systemd/system/haproxy.service	<span class="comment">#守护进程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@16a3b18f2dda /]<span class="comment"># cat /etc/haproxy/haproxy.cfg | grep -Ev '#|^$'</span></span><br><span class="line">global									<span class="comment">#全局配置项</span></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2		<span class="comment">#syslog服务器位置及类型</span></span><br><span class="line">    chroot      /var/lib/haproxy		<span class="comment">#chroot路径：工作目录</span></span><br><span class="line">    pidfile     /var/run/haproxy.pid	<span class="comment">#进程文件</span></span><br><span class="line">    maxconn     4000					<span class="comment">#最大连接数</span></span><br><span class="line">    user        haproxy					<span class="comment">#用户</span></span><br><span class="line">    group       haproxy					<span class="comment">#组</span></span><br><span class="line">    daemon								<span class="comment">#以守护进程运行</span></span><br><span class="line">    stats socket /var/lib/haproxy/stats	<span class="comment">#socket通信状态</span></span><br><span class="line">defaults								<span class="comment">#默认配置项</span></span><br><span class="line">    mode                    http		<span class="comment">#运行模式或协议</span></span><br><span class="line">    <span class="built_in">log</span>                     global		<span class="comment">#定义每个实例启动事件和流量日志</span></span><br><span class="line">    option                  httplog		<span class="comment">#http日志</span></span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s			<span class="comment">#http-request超时时间</span></span><br><span class="line">    timeout queue           1m			<span class="comment">#队列超时时间</span></span><br><span class="line">    timeout connect         10s			<span class="comment">#连接超时时间</span></span><br><span class="line">    timeout client          1m			<span class="comment">#客户端超时时间</span></span><br><span class="line">    timeout server          1m			<span class="comment">#服务端超时时间</span></span><br><span class="line">    timeout http-keep-alive 10s			<span class="comment">#保持长连接超时时间</span></span><br><span class="line">    timeout check           10s			<span class="comment">#check超时时间</span></span><br><span class="line">    maxconn                 3000		<span class="comment">#定义最大并发数</span></span><br><span class="line">frontend  main *:5000					<span class="comment">#前端配置，定义了一系列监听套接字，这些套接字可接受客户端请求并建立连接，监听5000端口，（bind *:80)</span></span><br><span class="line"><span class="comment">#ACL规则：(location url)</span></span><br><span class="line"><span class="comment">#测试请求的URL是以指定模式开头 </span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line"><span class="comment">#测试请求&lt;String&gt;是否以指定模式结尾    </span></span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          <span class="keyword">if</span> url_static</span><br><span class="line"><span class="comment">#如果user_backend没能匹配，指定后端的名称为app    </span></span><br><span class="line">    default_backend             app</span><br><span class="line">    </span><br><span class="line"><span class="comment">#定义后端配置：定义一系列“后端”服务器，代理会将请求转发给这些服务器</span></span><br><span class="line"><span class="comment">#static组后端</span></span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin				<span class="comment">#负载均衡算法为轮询</span></span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line"></span><br><span class="line"><span class="comment">#app组后端</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br></pre></td></tr></table></figure>



<p>配置文件结构</p>
<ul>
<li>全局配置项</li>
<li>默认配置项</li>
<li>前端配置项</li>
<li>后端配置项</li>
</ul>
<p>监听配置：通过关联前端配置想和后端配置项（frontend &amp; backend）定义一个完整代理。通常只对TCP流量有用。</p>
<h1 id="Docker-amp-Harpoxy"><a href="#Docker-amp-Harpoxy" class="headerlink" title="Docker &amp; Harpoxy"></a>Docker &amp; Harpoxy</h1><p>三台机器：  </p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP地址</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>WEB1</td>
<td>172.18.12.10</td>
<td>httpd – THIS IS WEB1…</td>
</tr>
<tr>
<td>WEB2</td>
<td>172.18.12.20</td>
<td>httpd – THIS IS WEB2…</td>
</tr>
<tr>
<td>Proxy</td>
<td>172.18.12.30</td>
<td>CentOS7 / Haproxy</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#安装docker环境</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 </span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo </span><br><span class="line">yum install docker-ce -y</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"registry-mirrors"</span>: [<span class="string">"https://ukdws02a.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建docker桥接网络，用于给容器分配IP地址</span></span><br><span class="line">docker network create --driver bridge --subnet=172.18.12.0/16 --gateway 172.18.1.1 mynet</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建后端站点，分别为web1和web2</span></span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web1.com --name web1 --network=mynet --ip 172.18.12.10 httpd</span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web2.com --name web2 --network=mynet --ip 172.18.12.20 httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB1..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web1:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line">sleep 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB2..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web2:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建代理服务器haproxy，镜像为centos7</span></span><br><span class="line"><span class="comment">#参数说明：--privilege + /usr/bin/init 是为了能够让程序以root运行，Container默认的Root只是相当于普通用户</span></span><br><span class="line"><span class="comment">#TZ		  ： 指定时区</span></span><br><span class="line"><span class="comment">#-h 	  ： 指定域名</span></span><br><span class="line"><span class="comment">#--network： 指定网络类型为我创建的网络</span></span><br><span class="line">docker run -e TZ=<span class="string">'Asia/Shanghai'</span> --privileged -itd -h haproxy.com --name myhaproxy --network=mynet --ip 172.18.12.30 centos:7 /usr/sbin/init</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否连同</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.10'</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.20'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装haproxy，并配置后端节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'yum -y install haproxy -q'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.10:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.20:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"等待服务加载...."</span></span><br><span class="line">sleep 3</span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">"echo '-------------负载均衡演示---------------' &amp;&amp; for i in &#123;1..10&#125;; do curl 172.18.12.30:5000; done"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#净化检测命令</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------开始删除配置------------"</span></span><br><span class="line">docker rm myhaproxy --force</span><br><span class="line">docker rm web1 web2 --force</span><br><span class="line">docker network rm mynet</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------检查是否有残留------------"</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">" "</span></span><br><span class="line">docker ps -a</span><br><span class="line">rm /root/index.html* -rf</span><br></pre></td></tr></table></figure>



<h1 id="负载均衡结果演示"><a href="#负载均衡结果演示" class="headerlink" title="负载均衡结果演示"></a>负载均衡结果演示</h1><p><img src="https://i.loli.net/2020/03/22/nCfvmt7hi8pAEqd.png" alt="docker_haproxy_1.png"></p>

            </div>
        </div>
    </article>

    
    
<nav class="article-nav">
  
    <a href="/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/" id="article-nav-newer" class="article-nav-link-wrap prev">
      <strong class="article-nav-caption">Newer</strong>
      <div class="article-nav-title">
        
          Keepalived高可用
        
      </div>
    </a>
  
  
    <a href="/2020/02/12/RIP%20&%20EIGRP%20&%20ISIS/" id="article-nav-older" class="article-nav-link-wrap next">
      <strong class="article-nav-caption">Older</strong>
      <div class="article-nav-title">RIP &amp; EIGRP &amp; ISIS</div>
    </a>
  
</nav>

    

    
</div>
    </div>
    <footer class="site-footer">
        <div class="global-width">
            <ul class="site-widget">
                
                <li class="widget widget-tag">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget-body">
      <ul class="tag-list" itemprop="keywords"><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" rel="tag">快捷键</a><span class="tag-list-count">4</span></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/%E9%9A%8F%E7%AC%94/" rel="tag">随笔</a><span class="tag-list-count">2</span></li></ul>
    </div>
  </div>

                </li>
                
                <li class="widget widget-category">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget-body">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Linux/">Linux</a><span class="category-list-count">8</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E5%AE%B9%E5%99%A8/">容器</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a><span class="category-list-count">2</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E7%BC%96%E7%A8%8B/">编程</a><span class="category-list-count">7</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a><span class="category-list-count">3</span></li></ul>
    </div>
  </div>

                </li>
                
                <li class="widget widget-recent_posts">
                    
  <div class="widget-wrap">
    <h3 class="widget-title">Recents</h3>
    <div class="widget-body">
      <ul>
        
          <li>
            <a href="/2020/12/30/%E6%84%BF%E6%9C%89%E6%B6%93%E6%B6%93%E8%AF%97%E6%84%8F%E6%B8%85%E6%96%B0%E5%85%A5%E8%84%BE%EF%BC%8C%E4%BB%A5%E9%A3%A8%E5%BF%99%E7%A2%8C%E7%9A%84%E6%97%A5%E5%B8%B8/">愿有涓涓诗意清新入脾，以飨忙碌的日常</a>
          </li>
        
          <li>
            <a href="/2020/06/16/Jetbrains%E5%BF%AB%E6%8D%B7%E9%94%AE/">Jetbrains快捷键</a>
          </li>
        
          <li>
            <a href="/2020/06/16/Chrome%E5%BF%AB%E6%8D%B7%E9%94%AE/">Chrome快捷键</a>
          </li>
        
          <li>
            <a href="/2020/06/16/VsCode%E5%BF%AB%E6%8D%B7%E9%94%AE/">VSCode快捷键</a>
          </li>
        
          <li>
            <a href="/2020/06/04/KVM%E5%AE%9E%E4%BE%8B/">KVM实例总结</a>
          </li>
        
      </ul>
    </div>
  </div>

                </li>
                
            </ul>
        </div>
        <div class="site-info">
            <address>
                &copy; 2014 <a href="http://ymlog.cn">无心而为</a> All Right Reserved. <br/>
                Powered by <a href="http://hexo.io" target="_blank" rel="noopener">Hexo</a>. Theme by <a href="http://zzoman.com" target="_blank" rel="noopener">ZZOMAN</a>
            </address>
        </div>
    </footer>
    
    <script src="/libs/jquery-1.11.3.min.js" type="text/javascript"></script>
    
    <script src="/libs/fancybox/jquery.fancybox.js" type="text/javascript"></script>
    
    <script src="/js/site_init.js" type="text/javascript"></script>
    
</body>
</html>