<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Ansible | zen's blog</title><meta name="description" content="念两句诗三过平山堂下，半生弹指声中。十年不见老仙翁。壁上龙蛇飞动。欲吊文章太守，仍歌杨柳春风。休言万事转头空。未转头时皆梦。    简介运维自动化发展历程：  内容  运维自动化发展历程及技术 Ansible命令使用 Ansible常用模块详解 YAML语法简介 Ansible playbook基础 Playbook变量、tags、handlers使用 Playbook模板templates P"><meta name="keywords" content="Ansible"><meta name="author" content="杜振铨"><meta name="copyright" content="杜振铨"><meta name="format-detection" content="telephone=no"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://archks.github.io/2020/02/24/Ansible/"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin="crossorigin"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="Ansible"><meta property="og:url" content="http://archks.github.io/2020/02/24/Ansible/"><meta property="og:site_name" content="zen's blog"><meta property="og:description" content="念两句诗三过平山堂下，半生弹指声中。十年不见老仙翁。壁上龙蛇飞动。欲吊文章太守，仍歌杨柳春风。休言万事转头空。未转头时皆梦。    简介运维自动化发展历程：  内容  运维自动化发展历程及技术 Ansible命令使用 Ansible常用模块详解 YAML语法简介 Ansible playbook基础 Playbook变量、tags、handlers使用 Playbook模板templates P"><meta property="og:image" content="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg"><meta property="article:published_time" content="2020-02-24T06:00:36.000Z"><meta property="article:modified_time" content="2020-07-04T02:16:08.000Z"><meta name="twitter:card" content="summary"><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#000')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#fff')
  }
}

var getCookies = function (name) {
  const value = `; ${document.cookie}`
  const parts = value.split(`; ${name}=`)
  if (parts.length === 2) return parts.pop().split(';').shift()
}

var autoChangeMode = 'false'
var t = getCookies('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      console.log('You specified no preference for a color scheme or your browser does not support it. I Schedule dark mode during night time.')
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (Cookies.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><link rel="prev" title="Switch交换机" href="http://archks.github.io/2020/02/27/Switch/"><link rel="next" title="OSPF协议" href="http://archks.github.io/2020/02/23/OSPF/"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap"><script>var GLOBAL_CONFIG = { 
  root: '/',
  algolia: undefined,
  localSearch: undefined,
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  bookmark: {
    message_prev: '按',
    message_next: '键将本页加入书签'
  },
  runtime_unit: '天',
  runtime: false,
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  highlightCopy: true,
  highlightLang: true,
  isPhotoFigcaption: true,
  islazyload: true,
  isanchor: false    
}</script><script>var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2020-07-04 10:16:08'
}</script><noscript><style>
#nav {
  opacity: 1
}
.justified-gallery img{
  opacity: 1
}
</style></noscript><meta name="generator" content="Hexo 4.2.1"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/img/avatar.png" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">文章</div><div class="length_num">47</div></a></div></div><div class="mobile_data_item is-center">      <div class="mobile_data_link"><a href="/tags/"><div class="headline">标签</div><div class="length_num">23</div></a></div></div><div class="mobile_data_item is-center">     <div class="mobile_data_link"><a href="/categories/"><div class="headline">分类</div><div class="length_num">9</div></a></div></div></div><hr/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div></div></div><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div id="sidebar"><div class="sidebar-toc"><div class="sidebar-toc__title">目录</div><div class="sidebar-toc__progress"><span class="progress-notice">你已经读了</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#简介"><span class="toc-number">1.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#安装"><span class="toc-number">2.</span> <span class="toc-text">安装</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#配置文件"><span class="toc-number">3.</span> <span class="toc-text">配置文件</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ad-Hoc"><span class="toc-number">4.</span> <span class="toc-text">Ad-Hoc</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#doc"><span class="toc-number">5.</span> <span class="toc-text">doc</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#hosts"><span class="toc-number">6.</span> <span class="toc-text">hosts</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible常用模块"><span class="toc-number">7.</span> <span class="toc-text">ansible常用模块</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-galaxy"><span class="toc-number">8.</span> <span class="toc-text">ansible-galaxy</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-vault"><span class="toc-number">9.</span> <span class="toc-text">ansible-vault</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-console"><span class="toc-number">10.</span> <span class="toc-text">ansible-console</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#ansible-playbook"><span class="toc-number">11.</span> <span class="toc-text">ansible-playbook</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#Playbook核心元素"><span class="toc-number">11.1.</span> <span class="toc-text">Playbook核心元素</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#hosts-1"><span class="toc-number">11.2.</span> <span class="toc-text">hosts</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tasks"><span class="toc-number">11.3.</span> <span class="toc-text">tasks</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#handlers-amp-notify"><span class="toc-number">11.4.</span> <span class="toc-text">handlers &amp; notify</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#tags"><span class="toc-number">11.5.</span> <span class="toc-text">tags</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Varniables"><span class="toc-number">11.6.</span> <span class="toc-text">Varniables</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#templates"><span class="toc-number">11.7.</span> <span class="toc-text">templates</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#with-item"><span class="toc-number">11.8.</span> <span class="toc-text">with_item</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#YAML介绍"><span class="toc-number">12.</span> <span class="toc-text">YAML介绍</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#roles"><span class="toc-number">13.</span> <span class="toc-text">roles</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible搭建httpd"><span class="toc-number">14.</span> <span class="toc-text">Ansible搭建httpd</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#Ansible搭建Haproxy"><span class="toc-number">15.</span> <span class="toc-text">Ansible搭建Haproxy</span></a></li></ol></div></div></div><div id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url(https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg)"><nav id="nav"><span class="pull-left" id="blog_name"><a class="blog_title" id="site-name" href="/">zen's blog</a></span><span class="pull-right menus"><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> Home</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> Archives</span></a></div><div class="menus_item"><a class="site-page" href="/link/"><i class="fa-fw fas fa-link"></i><span> Link</span></a></div></div><span class="toggle-menu close"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">Ansible</div></div><div id="post-meta"><div class="meta-firstline"><time class="post-meta__date"><span class="post-meta__date-created" title="发表于 2020-02-24 14:00:36"><i class="far fa-calendar-alt fa-fw"></i> 发表于 2020-02-24</span><span class="post-meta__separator">|</span><span class="post-meta__date-updated" title="更新于 2020-07-04 10:16:08"><i class="fas fa-history fa-fw"></i> 更新于 2020-07-04</span></time><span class="post-meta__categories"><span class="post-meta__separator">|</span><i class="fas fa-inbox fa-fw post-meta__icon"></i><a class="post-meta__categories" href="/categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a></span></div><div class="meta-secondline"> </div><div class="meta-thirdline"><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta__icon"></i><span>阅读量:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><blockquote>
<p>念两句诗<br>三过平山堂下，半生弹指声中。十年不见老仙翁。壁上龙蛇飞动。<br>欲吊文章太守，仍歌杨柳春风。休言万事转头空。未转头时皆梦。</p>
</blockquote>
<a id="more"></a>

<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p>运维自动化发展历程：</p>
<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2020/03/22/hcW185nwFNRlPGg.png" alt="ansible_1.png"></p>
<p>内容</p>
<ul>
<li>运维自动化发展历程及技术</li>
<li>Ansible命令使用</li>
<li>Ansible常用模块详解</li>
<li>YAML语法简介</li>
<li>Ansible playbook基础</li>
<li>Playbook变量、tags、handlers使用</li>
<li>Playbook模板templates</li>
<li>Playbook条件判断when</li>
<li>Playbook字段with_items</li>
<li>Ansible Roles</li>
</ul>
<p>自动化运维应用场景：</p>
<ul>
<li>文件传输</li>
<li>命令执行：<ul>
<li>应用部署</li>
<li>配置管理</li>
<li>任务流编排</li>
</ul>
</li>
</ul>
<p>ansible特性：</p>
<ul>
<li>模块化，有Paramiko、PyYAML、Jinja2(模板语言)三个关键模块</li>
<li>支持自定义模块</li>
<li>基于Python语言实现</li>
<li>部署简单，基于python和SSH，agentless</li>
<li>安全，基于OpenSSH</li>
<li>支持playbook编排任务</li>
<li>幂等性：一个任务执行1遍和执行n遍的效果是一样的</li>
<li>无需代理，不依赖PKI(无需SSL)</li>
<li>支持其他语言写模块</li>
<li>YMAL格式，编排任务，支持丰富的数据结构</li>
<li>较强大的多层解决方案</li>
</ul>
<p>常用的自动化运维工具：</p>
<ul>
<li>Ansible：python，Agentless，中小型应用环境</li>
<li>Saltstack：python，一般需要部署agent，执行效率更高</li>
<li>Puppent：ruby，功能强大，配置复杂，重型适合大型环境</li>
<li>Fabric：python，agentless</li>
<li>Chef：ruby，国内少</li>
</ul>
<p>ansible架构</p>
<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2020/03/22/TGimzcIVUPE9KsN.png" alt="ansible_2.png"></p>
<ul>
<li>Ansible Playbooks：任务剧本，编排定义Ansible任务集的配置文件，由ANSI不了顺序依次执行，通常是JSON格式的YML文件</li>
<li>Inventory：ANSI不了u案例主机清单/etc/anaible/hosts</li>
<li>Modules：Ansible执行命令的功能模块，多数为内置核心模块，可以自定义</li>
<li>Plugins：模块功能的补充，如连接类型插件、循环插件、变量插件、过滤插件等，该功能不常用</li>
<li>API：供第三方程序调用的应用程序编程接口</li>
<li>Ansible：组合Inventory、API、Modules</li>
<li>Plugins的绿框，可以理解为是ansible命令工具</li>
</ul>
<h1 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h1><ol>
<li><p>yum安装</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install ansible</span><br></pre></td></tr></table></figure>
</li>
<li><p>git安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/ansible/ansible.git</span><br><span class="line"><span class="built_in">cd</span> ./ansible</span><br><span class="line"><span class="built_in">source</span> ./hacking/env-setup</span><br></pre></td></tr></table></figure>
</li>
<li><p>pip安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">yum -y install python-pip python-devel</span><br><span class="line">yum -y install gcc glibc-devel zibl-devel rpm-bulid openssl-devel</span><br><span class="line">pip install --upgrade pip</span><br><span class="line">pip install ansible --upgrade</span><br></pre></td></tr></table></figure>
</li>
<li><p>确认安装</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ansible --version</span><br></pre></td></tr></table></figure>




</li>
</ol>
<h1 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h1><p><strong>相关文件</strong></p>
<p>配置文件</p>
<ul>
<li>/etc/ansible/ansible.cfg：主配置文件，配置ansible工作特性</li>
<li>/etc/ansible/hosts：主机清单</li>
<li>/etc/ansible/roles：存放角色目录</li>
</ul>
<p>程序</p>
<ul>
<li>/usr/bin/ansible： 主程序，临时命令执行工具</li>
<li>/usr/bin/ansible-doc：查看配置文档，模块功能查看工具</li>
<li>/usr/bin/ansible-galaxy：下载/上传优秀代码或Role模块的官网平台</li>
<li>/usr/bin/ansible-playbook：定制自动化任务，编排剧本工具/usr/bin/ansible-pull：远程执行命令工具</li>
<li>/usr/bin/ansible-value：文件加密工具</li>
<li>/usr/bin/ansible-console：基于Console界面于用户交互的执行工具</li>
</ul>
<p>ansible命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ansible </span><br><span class="line">ansible-doc</span><br><span class="line">ansible-playbook</span><br><span class="line">ansible-valut</span><br><span class="line">ansible-console</span><br><span class="line">ansible-galaxy</span><br><span class="line">ansile-pull</span><br></pre></td></tr></table></figure>





<p>配置文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># vim /etc/ansible/ansible.cfg</span></span><br><span class="line">[defaults]</span><br><span class="line"><span class="comment">#inventory      = /etc/ansible/hosts	#主机列表配置文件</span></span><br><span class="line"><span class="comment">#library        = /usr/share/my_modules/	#库文件存放目录</span></span><br><span class="line"><span class="comment">#remote_tmp     = ~/.ansible/tmp	#临时py命令文件存放在远程主机目录</span></span><br><span class="line"><span class="comment">#local_tmp      = ~/.ansible/tmp	#本机的临时命令执行目录</span></span><br><span class="line"><span class="comment">#forks          = 5		#默认并发数</span></span><br><span class="line"><span class="comment">#poll_interval  = 15	</span></span><br><span class="line"><span class="comment">#sudo_user      = root	#默认sudo用户</span></span><br><span class="line"><span class="comment">#ask_sudo_pass = True	#每次执行ansible命令是否询问ssh密码</span></span><br><span class="line"><span class="comment">#ask_pass      = True	</span></span><br><span class="line"><span class="comment">#remote_port    = 22</span></span><br><span class="line"><span class="comment">#log_path = /var/log/ansible.log	#日志文件，默认不记录。如果想打开日志记录，可以取消注释</span></span><br><span class="line"><span class="comment">#host_key_checking = False	#检查对应服务器的host_key，建议取消注释，取消完ssh可以不敲yes</span></span><br></pre></td></tr></table></figure>

<p>其中<code>remote_tmp</code>和<code>local_tmp</code>用于执行ansible脚本，当用户在ansible主机上发送命令时，ansible会把命令记录在本地的<code>~/.ansible/tmp/</code>目录，然后发送到受控主机的<code>~/.ansible/tmp</code>目录进行执行，并把执行结果返回给ansible主机。</p>
<p>ansible配置文件改动不需要用systemctl重启，因为ansible不是以服务的形式长驻内存的，它是用的时候临时调出。</p>
<h1 id="Ad-Hoc"><a href="#Ad-Hoc" class="headerlink" title="Ad-Hoc"></a>Ad-Hoc</h1><p>ansible命令执行过程</p>
<ol>
<li>加载自己的配置文件，默认/etc/ansible/ansible.cfg</li>
<li>加载自己对应的模块文件，如command</li>
<li>通过ansible将模块或命令生成对应的临时py文件，并将该文件传输至远程服务器的对应执行用户$HOME/.ansible/tmp/ansible-tmp-Nbr/XXX.py文件</li>
<li>给文件+x执行</li>
<li>执行并返回结果</li>
<li>删除py文件，sleep 0 退出</li>
</ol>
<p>可以使用<code>ansible all -m ping -vvv</code>来展示详细过程</p>
<p>颜色说明</p>
<ul>
<li>红色：执行失败</li>
<li>绿色：成功，对目标系统没有做任何修改</li>
<li>黄色：成功，对目标系统做出变更</li>
<li>在/etc/ansible/ansible.cfg中的[colors]有说明</li>
</ul>
<p>ansible用法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># ansible --help</span></span><br><span class="line">usage: ansible &lt;host-pattern&gt; [-m module_name] [-a args]</span><br><span class="line"></span><br><span class="line">optional arguments:</span><br><span class="line">  --ask-vault-pass      ask <span class="keyword">for</span> vault password</span><br><span class="line">  --list-hosts          列出主机列表，如：ansible webserver --list-all</span><br><span class="line">  -a MODULE_ARGS, --args 追加模块参数</span><br><span class="line">  -f FORKS				连接并发数，默认是5</span><br><span class="line">  -t TREE, --tree TREE  <span class="built_in">log</span> output to this directory</span><br><span class="line">  -v, --verbose         显示详细过程，-vv，-vvv更详细</span><br><span class="line">  -K, --ask-become-pass 提示输入sudo密码</span><br><span class="line">  -b, --become          代替sudo切换</span><br><span class="line">  -T TIMEOUT, --timeout 执行命令的超时时间，默认10s</span><br><span class="line">  -k, --ask-pass        提示输入ssh连接密码，默认key验证</span><br><span class="line">  -u REMOTE_USER, --user 指定连接用户</span><br></pre></td></tr></table></figure>



<p>测试能否ping通另一台主机，这里的Ping不是用ICMP协议，而是用SSH协议</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 首先在主机列表里加入我们的主机</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192.168.70.20"</span> &gt;&gt; /etc/ansible/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192.168.70.30"</span> &gt;&gt; /etc/ansible/hosts</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"192.168.70.40"</span> &gt;&gt; /etc/ansible/hosts</span><br><span class="line"></span><br><span class="line"><span class="comment"># 然后再使用ping命令，如果能通，对方主机会回复一个pong</span></span><br></pre></td></tr></table></figure>



<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2020/03/22/AhLUw9Q7nbEaCZ6.png" alt="ansible_3.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里因为我在`192.168.70.30`上配置了key，所以立刻就能通。下面通过加参数k，来输入密码：</span></span><br><span class="line">ansible 121.36.70.55 -m ping -k</span><br><span class="line"></span><br><span class="line"><span class="comment">#多台主机，用逗号隔开</span></span><br><span class="line">ansible 192.168.70.20,192.168.70.30 -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment">#执行所有主机</span></span><br><span class="line">ansible all -m ping</span><br><span class="line"></span><br><span class="line"><span class="comment"># 通过清单分类ping，清单分类见下文</span></span><br><span class="line">ansible dbserver -m ping</span><br></pre></td></tr></table></figure>

<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2020/03/22/XYG6nQNSrlCcJ5m.png" alt="ansible_4.png"></p>
<p>主机清单分组</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[dbserver]</span><br><span class="line">192.168.70.30</span><br><span class="line">192.168.70.20</span><br><span class="line"></span><br><span class="line">[webserver]</span><br><span class="line">192.168.70.10</span><br><span class="line">192.168.70.40</span><br><span class="line"></span><br><span class="line">[appserver]</span><br><span class="line">192.168.70.[1:3]</span><br><span class="line"><span class="comment">#等价于192.168.70.1, 192.168.70.2, 192.168.70.3</span></span><br></pre></td></tr></table></figure>



<h1 id="doc"><a href="#doc" class="headerlink" title="doc"></a>doc</h1><p>ansible-doc用法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment"># ansible-doc：显示模块帮助</span></span><br><span class="line">ansible-doc [option] [module...]</span><br><span class="line">	-a				显示所有模块的文档</span><br><span class="line">	-l,--list		列出可用模块</span><br><span class="line">	-s,--<span class="variable">$nippet</span>	显示指定模块的playbook片段</span><br><span class="line"></span><br><span class="line"><span class="comment"># 示例：</span></span><br><span class="line"> </span><br><span class="line">ansible-doc -l 			<span class="comment">#列出所有模块</span></span><br><span class="line">ansible-doc ping		<span class="comment">#查看ping模块的帮助文档</span></span><br><span class="line">ansible-doc -s ping		<span class="comment">#查看ping模块的简略信息</span></span><br></pre></td></tr></table></figure>



<p>用ansible执行命</p>
<ul>
<li>ansible通过ssh实现配置管理、应用部署、任务执行等功能，建议配置ansible端能基于密钥认证的方式联系各被管理的节点</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看dbserver组里的用户家目录</span></span><br><span class="line">[root@node01 ~]<span class="comment"># ansible dbserver -u root -m command -a 'ls /root'</span></span><br><span class="line">192.168.70.30 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line">192.168.70.20 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br></pre></td></tr></table></figure>



<p>普通用户在ansible执行自己主机root权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先在node02上添加普通用户dzq，密码000000，然后追加扩展组到wheel便于执行sudo权限</span></span><br><span class="line">[root@node02 ~]<span class="comment"># useradd dzq</span></span><br><span class="line">[root@node02 ~]<span class="comment"># passwd dzq</span></span><br><span class="line">更改用户 dzq 的密码 </span><br><span class="line">新的 密码：000000</span><br><span class="line">无效的密码： 密码是一个回文</span><br><span class="line">重新输入新的 密码：000000</span><br><span class="line">passwd：所有的身份验证令牌已经成功更新。</span><br><span class="line">[root@node02 ~]<span class="comment"># visudo</span></span><br><span class="line">[root@node02 ~]<span class="comment"># usermod -aG wheel dzq</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#然后到node01上执行</span></span><br><span class="line">[root@node01 ~]<span class="comment"># ansible 192.168.70.20 -u dzq -m command -a 'ls /root' -k -K -b</span></span><br><span class="line">SSH password: 000000</span><br><span class="line">BECOME password[defaults to SSH password]: 000000</span><br><span class="line">192.168.70.20 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">anaconda-ks.cfg</span><br><span class="line"></span><br><span class="line"><span class="comment"># visudo带颜色</span></span><br><span class="line">[root@node02 ~]<span class="comment"># echo export EDITOR=vim &gt;&gt; /etc/profile.d/env.sh</span></span><br><span class="line">[root@node02 ~]<span class="comment"># source /etc/profile.d/env.sh</span></span><br></pre></td></tr></table></figure>



<h1 id="hosts"><a href="#hosts" class="headerlink" title="hosts"></a>hosts</h1><p>主机清单</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 匹配主机的列表</span></span><br><span class="line">1、All：表示有Inventory中的所有主机</span><br><span class="line">2、通配符 *</span><br><span class="line">3、或关系 :</span><br><span class="line">4、与关系</span><br><span class="line">5、逻辑非</span><br><span class="line">6、综合逻辑</span><br><span class="line">7、正则表达式</span><br><span class="line"></span><br><span class="line">演示：</span><br><span class="line">1、ansible all -m ping</span><br><span class="line">2、ansible 192.168.70.* -m ping</span><br><span class="line">3、ansible <span class="string">"webserver:appserver"</span> -m ping</span><br><span class="line">4、ansible <span class="string">'webserver:&amp;appserver'</span> -m ping</span><br><span class="line">5、ansible <span class="string">'webserver:!appserver'</span> -m ping</span><br><span class="line">6、ansible <span class="string">'webserver:appserver:&amp;dbserver:!ftpserver'</span> -m ping</span><br><span class="line">7、ansible <span class="string">'~(web|db).*\.server'</span> -m ping</span><br></pre></td></tr></table></figure>





<h1 id="ansible常用模块"><a href="#ansible常用模块" class="headerlink" title="ansible常用模块"></a>ansible常用模块</h1><ul>
<li><p>Command：在远程主机上执行命令，默认模块，可忽略-m选项</p>
<blockquote>
<p>ansible node24 -m command -a ‘systemctl restart sshd’</p>
<p>ansible node24 -m command -a ‘echo 000 | passwd –stdin dzq’  【不成功】</p>
<p>此模块不支持 $VARNAME &lt;  &gt; | ; $ $ 等，应该用shell模块实现</p>
</blockquote>
</li>
<li><p>Shell：和command相似，用shell执行命令</p>
<blockquote>
<p>ansible node24 -m shell -a ‘echo 000 | passwd –stdin dzq’</p>
<p>调用bash执行命令，类似`cat /etc/passwd | awk -F ‘:’ ‘{print $1,$2}’ &amp;&gt; /tmp/example.txt这些复杂的命令，即使使用shell也可能会失败，解决办法：写到脚本里，copy到远程执行，再把所需要的结果拉回执行命令的机器</p>
</blockquote>
</li>
<li><p>Script：运行脚本呢</p>
<blockquote>
<p>-a “/PATH/TO/SCRIPT_FILE”</p>
<p>ansible node24 -m script -a f1.sh</p>
</blockquote>
</li>
<li><p>Copy：把服务器上的文件复制到受控端</p>
<blockquote>
<p>如果目标存在，默认覆盖，此处指定先备份</p>
<p>ansible all -m copy -a ‘src=/etc/selinux/config dest=/etc/selinux/config backup=yes owner=dzq mode=000’</p>
<p>利用内容直接生成目标文件</p>
<p>ansible all -m copy -a ‘content=’hello world’ dest/tmp/1.txt’</p>
</blockquote>
</li>
<li><p>Fetch：从客户端取文件至服务器端</p>
<blockquote>
<p>ansible node23 -m file -a ‘src=/root/a.sh dest=/tmp/‘</p>
</blockquote>
</li>
<li><p>File：设置文件属性</p>
<blockquote>
<p>ansible node23 -m file -a ‘path=/root/a.sh owner=dzq mode=755’</p>
<p>ansible node23 -m file -a ‘src=/app/testfile dest=/app/testfile-link state=link’</p>
<p>创建文件</p>
<p>ansible node23 -m file -a ‘path=’/root/f1.txt’ state=touch’</p>
<p>删除文件</p>
<p>ansible node23 -m file -a ‘path=’/root/f1.txt’ state=absent’</p>
<p>创建软连接</p>
<p>ansible node23 -m file -a ‘src=/etc/ssh/sshd_config dest=/root/ssh_link state=link’</p>
</blockquote>
</li>
<li><p>Hostname：管理主机名</p>
<blockquote>
<p>更改主机名</p>
<p>ansible 192.168.70.20 -m hostname -a ‘name=node02’</p>
</blockquote>
</li>
<li><p>Cron：计划任务</p>
<blockquote>
<p>支持时间：minute、hour、day、month、weekday</p>
<p>创建任务：</p>
<p>ansible node24 -m cron -a ‘minute=* weekday=1,3,5 job=”/usr/bin/wall FBI warning” name=warnning’</p>
<p>禁用任务：</p>
<p>ansible node24 -m cron -a ‘disabled=trued job=”/usr/bin/wall FBI warning” name=warnning’</p>
<p>删除任务：</p>
<p>ansible node24 -m cron -a ‘job=”/usr/bin/wall FBI warning” name=warnning state=absent’</p>
</blockquote>
</li>
<li><p>Yum：管理包</p>
<blockquote>
<p>安装</p>
<p>ansible node24 -m yum -a ‘name=httpd state=latest’</p>
<p>删除</p>
<p>ansible node24 -m yum -a ‘name=httpd state=absent’</p>
</blockquote>
</li>
<li><p>Service：管理服务</p>
<blockquote>
<p>安装FTP服务启动，并设置开启自启</p>
<p>ansible node24 -m service -a ‘name=vsftpd state=started enabled=yes’</p>
<p>ansible srv -m service -a ‘name=httpd state=stoped’</p>
<p>ansible srv -m service -a ‘name=httpd state=started’</p>
<p>ansible srv -m service -a ‘name=httpd state=reloaded’</p>
<p>ansible srv -m service -a ‘name=httpd state=restart’</p>
</blockquote>
</li>
<li><p>User：管理用户</p>
<blockquote>
<ol>
<li>ansible srv -m user -a ‘name=user1 commment=”test user” uid=2048 home=/app/user1” group=root’</li>
<li>ansible srv -m user -a ‘name=sysuser1 system=yes home=/app/sysuser1’</li>
<li>ansible srv -m user -a ‘name=user1 state=absent remove=yes’    #删除用户家目录</li>
</ol>
</blockquote>
</li>
<li><p>Group：管理组</p>
<blockquote>
<p>ansible srv -m group -a ‘name=testgroup system=yes’</p>
<p>ansible srv -m group -a ‘name=testgroup state=absent’</p>
</blockquote>
</li>
</ul>
<h1 id="ansible-galaxy"><a href="#ansible-galaxy" class="headerlink" title="ansible-galaxy"></a>ansible-galaxy</h1><ul>
<li>连接<a href="https://galaxy.ansible.com下载相应的roles" target="_blank" rel="noopener">https://galaxy.ansible.com下载相应的roles</a></li>
<li>列出已安装的galaxy：ansible-galaxy list</li>
<li>安装galaxy：ansible-galaxy install username.rolename</li>
<li>删除galaxy：ansible-galaxy remove username.rolename</li>
</ul>
<h1 id="ansible-vault"><a href="#ansible-vault" class="headerlink" title="ansible-vault"></a>ansible-vault</h1><p>加密解密playbook</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#解密</span></span><br><span class="line">ansible-vault encrypt hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密</span></span><br><span class="line">ansible-vault decrypt hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密后查看文件</span></span><br><span class="line">ansible-vault view hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#加密后编辑文件</span></span><br><span class="line">ansible-vault eidtor hello.yml</span><br><span class="line"></span><br><span class="line"><span class="comment">#重新设置口令</span></span><br><span class="line">ansible-vault rekey hello.yml</span><br></pre></td></tr></table></figure>



<h1 id="ansible-console"><a href="#ansible-console" class="headerlink" title="ansible-console"></a>ansible-console</h1><p>ansible交互式控制台</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">ansible-console</span><br><span class="line">root@node24 (2)[f:5]$ forks 3</span><br><span class="line">root@node24 (2)[f:3]$ <span class="built_in">cd</span> node23</span><br><span class="line">root@node23 (2)[f:3]$ ?		<span class="comment">#查看有哪些命令</span></span><br><span class="line">root@node23 (2)[f:3]$ <span class="built_in">command</span> hostname	<span class="comment">#执行命令：模块名/命令</span></span><br><span class="line">192.168.70.20 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">node02</span><br><span class="line"></span><br><span class="line">192.168.70.30 | CHANGED | rc=0 &gt;&gt;</span><br><span class="line">node03</span><br><span class="line"></span><br><span class="line">root@node23 (2)[f:3]$ service name=httpd state=start</span><br></pre></td></tr></table></figure>






<h1 id="ansible-playbook"><a href="#ansible-playbook" class="headerlink" title="ansible-playbook"></a>ansible-playbook</h1><ul>
<li>playbook是由多个play组成的列表</li>
<li>play的主要功能在于将事先归并为一组的主机装扮成事先通过ansible中的task定义好的角色。从根本上讲，所谓task无非是调用ansible的一个module。将多个play组织在一个playbook中，即可以让他们联通起来按实现编排的机制同唱一台大戏</li>
<li>playbook采用yaml语言编写</li>
</ul>
<p><img src= "/img/loading.gif" data-src="https://i.loli.net/2020/03/22/xUsH46CJcwtF9MI.png" alt="ansible_5.png"></p>
<h2 id="Playbook核心元素"><a href="#Playbook核心元素" class="headerlink" title="Playbook核心元素"></a>Playbook核心元素</h2><ul>
<li>Hosts：执行的远程主机列表</li>
<li>Tasks：任务集</li>
<li>Varniables：内置变量或自定义变量在playbook中调用</li>
<li>Templates：模板，可替换模板文件的变量并实现一些简单逻辑文件</li>
<li>Handlers和Notity结合使用，由特定条件出发的操作，满足条件方才执行，否则不执行</li>
<li>tags：标签，指定某条任务执行，用于选择运行playbook中的部分代码，ansible具有幂等性，因此会自动跳过没有变化的部分，即便如此，有些代码为测试其确实没有变化的时间依然会非常长，此时如果确信没有其他变化，可以就通过tags跳过此代码片段</li>
</ul>
<p>playbook常见选项</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">ansible-playbook file.yml --list-hosts	<span class="comment">#列出playbook中的主机</span></span><br><span class="line">ansible-playbook file.yml --list-tasks	<span class="comment">#列出playbook中的任务</span></span><br><span class="line">ansible-playbook file.yml --<span class="built_in">limit</span> node23<span class="comment">#限制任务执行的主机</span></span><br><span class="line">ansible-playbook -C file.yml			<span class="comment">#检查yaml语法</span></span><br></pre></td></tr></table></figure>





<h2 id="hosts-1"><a href="#hosts-1" class="headerlink" title="hosts"></a>hosts</h2><p>playbook中每个play的目的都是为了让某个或某些主机以某个指定的用户身份执行任务，hosts用于指定要执行任务的主机，须事先定义在主机清单中。</p>
<p>可以是如下形式</p>
<blockquote>
<p>one.example.com</p>
<p>one.example.com:two.example.com</p>
<p>192.168.1.2</p>
<p>192.168.1.*</p>
<p>webserver:dbserver:&amp;appserver</p>
<p>示例：</p>
<ul>
<li>host: webserver</li>
</ul>
</blockquote>
<p>检查playbook语法：ansbile-playbook -C file.yml</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">websrvs</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span> </span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">new</span> <span class="string">file</span></span><br><span class="line">  	  <span class="attr">file:</span> <span class="string">name=/data/newfile</span> <span class="string">state=touch</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">new</span> <span class="string">user</span></span><br><span class="line">  	  <span class="attr">user:</span> <span class="string">name=test3</span> <span class="string">state=present</span> <span class="string">system=yes</span> </span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=httpd</span> <span class="string">state=installed</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">html</span></span><br><span class="line">      <span class="attr">copy:</span> <span class="string">src=/var/www/html/index.html</span> <span class="string">dest=/var/www/html/</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>





<h2 id="tasks"><a href="#tasks" class="headerlink" title="tasks"></a>tasks</h2><p>task列表和action</p>
<ul>
<li>play的主体部分是task list。task list中的各任务按次序逐个在hosts中指定的所有主机上执行，即在所有主机上完成第一个任务后再开始第二个。在运行自上而下某playbook，如果中途发生错误，所有已执行任务都将回滚，因此，在更正playbook后重新执行一次即可</li>
<li>task的目的是使用指定参数执行模块，而在模块参数中可以使用变量，模块执行是幂等的，这意味着多次执行是安全的，因为其结果均一致</li>
<li>每个task都应该有其name，用于playbook的执行结果输出，建议其内容尽可能清晰地描述任务执行步骤，如果未提供name，则action的结果将用于输出</li>
</ul>
<p>action格式：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">(1) action: module arguments</span><br><span class="line">(2) module: arguments</span><br></pre></td></tr></table></figure>



<p>脚本错误继续执行</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">(1)</span><br><span class="line">task:</span><br><span class="line">	-name: run this <span class="built_in">command</span> and ignore the result</span><br><span class="line">	 shell: /usr/bin/comnands || /bin/<span class="literal">true</span></span><br><span class="line">	 </span><br><span class="line">(2)</span><br><span class="line">tasks</span><br><span class="line">	-name: run this <span class="built_in">command</span> and ignore the result</span><br><span class="line">	 shell: /usr/bin/commands</span><br><span class="line">	 ignore_errors: True</span><br></pre></td></tr></table></figure>







<h2 id="handlers-amp-notify"><a href="#handlers-amp-notify" class="headerlink" title="handlers &amp; notify"></a>handlers &amp; notify</h2><ul>
<li>Handlers：是task列表，这些task与前述的task没有本质上的不同，用于当关注资源发生变化时，才会采取一定的操作</li>
<li>Notify此Action可用于在每个play的最后被触发，这样可以避免多次有改变发生时，每次都执行指定操作，仅在所有的变化发生完后一次性地执行指定操作。在notify中列出的操作称为handler，也即notify中调用handler中定义的操作。</li>
</ul>
<p>一旦配置文件发生变化，服务重启</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="comment">#httpd服务</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">  	  <span class="attr">copy:</span> <span class="string">src=/etc/httpd/conf/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span> <span class="string">backup=yes</span></span><br><span class="line">  	  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  	  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">  	  </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">  	  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 如果copy config file改动，则触发handlers中的restart httpd service</span></span><br></pre></td></tr></table></figure>



<p>notify &amp; handler 多个的写法,用列表的形式呈现</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">name:</span> <span class="string">config</span></span><br><span class="line">  <span class="attr">copy:</span> <span class="string">src=file/nginx.conf</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">  <span class="attr">notify:</span> </span><br><span class="line">  	<span class="bullet">-</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">  	</span><br><span class="line"><span class="attr">handlers:</span> </span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">nginx</span></span><br><span class="line">	  <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=restarted</span> <span class="string">enable=yes</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">check</span> <span class="string">nginx</span> <span class="string">process</span></span><br><span class="line">	  <span class="attr">shell:</span> <span class="string">killall</span> <span class="number">-0</span> <span class="string">nginx</span> <span class="string">&gt;</span> <span class="string">/tmp/nginx.log</span></span><br></pre></td></tr></table></figure>





<h2 id="tags"><a href="#tags" class="headerlink" title="tags"></a>tags</h2><p>只执行标签内容，或者不执行标签内容</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#以下是不同的动作不同的标签，也可以多个动作公用一个标签</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=httpd</span></span><br><span class="line">  	  <span class="attr">tags:</span> <span class="string">install_httpd</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">config</span> <span class="string">file</span></span><br><span class="line">  	  <span class="attr">copy:</span> <span class="string">src=/etc/httpd/conf/httpd.conf</span> <span class="string">dest=/etc/httpd/conf/</span> <span class="string">backup=yes</span></span><br><span class="line">  	  <span class="attr">notify:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  	  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line">  	  <span class="attr">tags:</span> <span class="string">restart_httpd</span></span><br><span class="line">  	  </span><br><span class="line">  <span class="attr">handlers:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">restart</span> <span class="string">httpd</span> <span class="string">service</span></span><br><span class="line">  	  <span class="attr">service:</span> <span class="string">name=httpd</span> <span class="string">state=restarted</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># ansible-playbook调用</span></span><br><span class="line"><span class="comment"># ansible-playbook -t install_httpd,restart_httpd httpd.yml</span></span><br></pre></td></tr></table></figure>



<h2 id="Varniables"><a href="#Varniables" class="headerlink" title="Varniables"></a>Varniables</h2><p>变量名：仅能由字母、下划线、数字组成，且只能以字母开头</p>
<p>变量来源：</p>
<ol>
<li><p>ansible setup facts    远程主机的所有变量都可以直接调用</p>
</li>
<li><p>在/etc/ansible/hosts中定义</p>
<blockquote>
<p>普通变量：主机组中主机单独定义，优先级高于公共变量</p>
<p>公共变量：针对主机中所有主机定义的统一变量</p>
</blockquote>
</li>
<li><p>通过命令行指定变量，优先级最高</p>
<blockquote>
<p>ansible-playbook -e ‘varname=value’ file.yml</p>
</blockquote>
</li>
<li><p>在playbook中定义</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">vars:</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">var1:</span> <span class="string">value1</span></span><br><span class="line">	<span class="bullet">-</span> <span class="attr">var2:</span> <span class="string">value2</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>在role中定义</p>
</li>
</ol>
<p>优先级：命令行&gt;Playbook&gt;主机清单</p>
<p>命令行的变量赋值</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  	  <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行</span></span><br><span class="line"><span class="comment"># ansible-playbook -e 'pkgname=vsftpd' app.yml</span></span><br></pre></td></tr></table></figure>

<p>定义playbook中的变量</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">host:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">pkgname1:</span> <span class="string">httpd</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">pkgname2:</span> <span class="string">vsftpd</span></span><br><span class="line">  	</span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">httpd</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname1</span> <span class="string">&#125;&#125;</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">  	  <span class="attr">service:</span> <span class="string">name=&#123;&#123;</span> <span class="string">pkgname2</span> <span class="string">&#125;&#125;</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>

<p>在主机清单中定义变量</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 定义主机清单中的变量</span></span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">[node23]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.30</span> <span class="string">Nbr=300</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.20</span> <span class="string">Nbr=200</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 在playbook中调用</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node23</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">hostanem</span></span><br><span class="line">  	  <span class="attr">hostname:</span> <span class="string">name=www.&#123;&#123;</span> <span class="string">Nbr</span> <span class="string">&#125;&#125;ymlog.cn</span></span><br></pre></td></tr></table></figure>

<p>清单统一变量</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">/etc/ansible/hosts</span></span><br><span class="line"><span class="string">[node23]</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.30</span> <span class="string">Nbr=300</span></span><br><span class="line"><span class="number">192.168</span><span class="number">.70</span><span class="number">.20</span> <span class="string">Nbr=200</span></span><br><span class="line"></span><br><span class="line"><span class="string">[node23:vars]</span></span><br><span class="line"><span class="string">nodename=www</span></span><br><span class="line"><span class="string">domainname=ymlog.cn</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">node23</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">set</span> <span class="string">hostanem</span></span><br><span class="line">  	  <span class="attr">hostname:</span> <span class="string">name=&#123;&#123;</span> <span class="string">nodename</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">Nbr</span> <span class="string">&#125;&#125;&#123;&#123;</span> <span class="string">domainname</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>



<h2 id="templates"><a href="#templates" class="headerlink" title="templates"></a>templates</h2><p>模板</p>
<ul>
<li><p>文本文件，嵌套有脚本</p>
</li>
<li><p>Jinja2语言，使用字面量，有下面形式：</p>
<blockquote>
<p>字符串：使用单引号或双引号</p>
<p>数字：整数、浮点数</p>
<p>列表：[item1,item2,…]</p>
<p>元组：{item1,item2,…}</p>
<p>字典：{key1:value1,key2:value2,….}</p>
<p>布尔型：true/false</p>
</blockquote>
</li>
<li><p>算术运算：+ ,- , * ,/ ,// , % ,**</p>
</li>
<li><p>比较操作：==, != ,&lt; , &lt;= ,&gt; ,&gt;=</p>
</li>
<li><p>逻辑运算：and、or、not</p>
</li>
<li><p>流表达式：For  If  When</p>
</li>
</ul>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span> </span><br><span class="line">  	<span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=/root/.ansible/templates/nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>



<p>1、将Nginx的工作进程改为CPU核心数的二次方倍：修改templates的文件，原来templates/nginx.conf.j2的文件就是nginx.conf的配置文件。</p>
<p>先查看setup中的cpu变量用什么标识：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 ~]<span class="comment"># ansible node24 -m setup | grep cpu</span></span><br><span class="line">        <span class="string">"ansible_processor_vcpus"</span>: 1, </span><br><span class="line">        <span class="string">"ansible_processor_vcpus"</span>: 1,</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">user  nginx;</span><br><span class="line">worker_processes  &#123;&#123; ansible_processor_vcpus**2 &#125;&#125;;</span><br></pre></td></tr></table></figure>



<p>2、将node2的端口改为200，node3的端口改为300</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">192.168.70.30 Nbr=300</span><br><span class="line">192.168.70.20 Nbr=200</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">    listen       &#123;&#123; Nbr &#125;&#125; default_server;</span><br><span class="line">    listen       [::]:&#123;&#123; Nbr &#125;&#125; default_server;</span><br></pre></td></tr></table></figure>



<p>3、 when</p>
<ul>
<li><p>条件测试：如果需要根据变量、facts或此前任务执行结果来作为某task执行与否的前提时要用到条件测试，通过when语句实现，在task中使用，jinja2的语法格式</p>
</li>
<li><p>when语句</p>
</li>
<li><p>在task后添加when子句即可使用条件测试；when语句支持jinja2表达语法</p>
</li>
<li><p>示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">tasks:</span><br><span class="line">- name: &quot;shutdown RedHat Flavored Systems&quot;</span><br><span class="line">  command: &#x2F;sbin&#x2F;shutdown -h now</span><br><span class="line">  when: ansible_os_family &#x3D;&#x3D; &quot;Redhat&quot;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>  当为7版的时候才复制文件</p>
  <figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=nginx</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">template</span></span><br><span class="line">      <span class="attr">template:</span> <span class="string">src=/root/.ansible/templates/nginx.conf.j2</span> <span class="string">dest=/etc/nginx/nginx.conf</span></span><br><span class="line">      <span class="attr">when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span></span><br><span class="line">    <span class="bullet">-</span> <span class="attr">name:</span> <span class="string">start</span> <span class="string">service</span></span><br><span class="line">      <span class="attr">service:</span> <span class="string">name=nginx</span> <span class="string">state=started</span> <span class="string">enabled=yes</span></span><br></pre></td></tr></table></figure>







<h2 id="with-item"><a href="#with-item" class="headerlink" title="with_item"></a>with_item</h2><p>迭代</p>
<p>1、新建多个文件</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">create</span> <span class="string">some</span> <span class="string">files</span></span><br><span class="line">  	  <span class="attr">file:</span> <span class="string">name=/data/&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=touch</span></span><br><span class="line">  	  <span class="attr">with_items:</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">file1</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">file2</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">file3</span></span><br></pre></td></tr></table></figure>



<p>2、迭代嵌套子变量</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">groups</span></span><br><span class="line">  	  <span class="attr">group:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">  	  <span class="attr">with_items:</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">group1</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">group2</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">group3</span></span><br><span class="line">  	  </span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">add</span> <span class="string">some</span> <span class="string">users</span></span><br><span class="line">  	  <span class="attr">user:</span> <span class="string">name=&#123;&#123;</span> <span class="string">item.name</span> <span class="string">&#125;&#125;</span> <span class="string">group=&#123;&#123;</span> <span class="string">item.group</span> <span class="string">&#125;&#125;</span> <span class="string">state=present</span></span><br><span class="line">  	  <span class="attr">with_items:</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">&#123;</span> <span class="string">name:'user1',group:</span> <span class="string">'group1'</span><span class="string">&#125;</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">&#123;</span> <span class="string">name:'user2',group:</span> <span class="string">'group2'</span><span class="string">&#125;</span></span><br><span class="line">  	  	<span class="bullet">-</span> <span class="string">&#123;</span> <span class="string">name:'user',group:</span> <span class="string">'group3'</span><span class="string">&#125;</span></span><br></pre></td></tr></table></figure>



<p>for循环</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">templates.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  	<span class="attr">ports:</span></span><br><span class="line">  		<span class="bullet">-</span> <span class="number">81</span></span><br><span class="line">  		<span class="bullet">-</span> <span class="number">82</span></span><br><span class="line">  		<span class="bullet">-</span> <span class="number">83</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">conf</span></span><br><span class="line">  	  <span class="attr">template:</span> <span class="string">src=for1.conf.j2</span> <span class="string">dest/data/for1.conf</span></span><br><span class="line">  	  </span><br><span class="line">  	  </span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">for1.conf.j2</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">port</span> <span class="string">in</span> <span class="string">ports</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">server&#123;</span></span><br><span class="line">	<span class="string">listen</span> <span class="string">&#123;&#123;</span> <span class="string">port</span> <span class="string">&#125;&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endfor</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">执行</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">all</span> <span class="string">templates.yml</span></span><br></pre></td></tr></table></figure>



<p>把列表换成字典</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">templates.yml</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars:</span></span><br><span class="line">  	<span class="attr">ports:</span></span><br><span class="line">  		<span class="bullet">-</span> <span class="attr">web1:</span> </span><br><span class="line">  			<span class="attr">port:</span> <span class="number">81</span></span><br><span class="line">  			<span class="attr">name:</span> <span class="string">www.web1.com</span></span><br><span class="line">  			<span class="attr">rootdir:</span> <span class="string">/root/website1</span></span><br><span class="line">  		<span class="bullet">-</span> <span class="attr">web2:</span></span><br><span class="line">  			<span class="attr">port:</span> <span class="number">82</span></span><br><span class="line">  			<span class="attr">name:</span> <span class="string">www.web2.com</span></span><br><span class="line">  			<span class="attr">rootdir:</span> <span class="string">/root/website2</span></span><br><span class="line">  		<span class="bullet">-</span> <span class="attr">web3:</span>	</span><br><span class="line">  			<span class="attr">port:</span> <span class="number">83</span></span><br><span class="line">  			<span class="attr">name:</span> <span class="string">www.web3.com</span></span><br><span class="line">  			<span class="attr">rootdir:</span> <span class="string">/root/website3</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">copy</span> <span class="string">conf</span></span><br><span class="line">  	  <span class="attr">template:</span> <span class="string">src=for1.conf.j2</span> <span class="string">dest/data/for1.conf</span></span><br><span class="line">  	  </span><br><span class="line">  	  </span><br><span class="line"><span class="string">$</span> <span class="string">vim</span> <span class="string">for1.conf.j2</span></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">for</span> <span class="string">p</span> <span class="string">in</span> <span class="string">ports</span> <span class="string">%&#125;</span></span><br><span class="line"><span class="string">server&#123;</span></span><br><span class="line">	<span class="string">listen</span> <span class="string">&#123;&#123;</span> <span class="string">p.port</span> <span class="string">&#125;&#125;</span></span><br><span class="line">	<span class="string">servername</span> <span class="string">&#123;&#123;</span> <span class="string">p.name</span> <span class="string">&#125;&#125;</span></span><br><span class="line">	<span class="string">documentroot</span> <span class="string">&#123;&#123;</span> <span class="string">p.rootdir&#125;&#125;</span></span><br><span class="line"><span class="string">&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">&#123;%</span> <span class="string">endfor</span> <span class="string">%&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="string">$</span> <span class="string">执行</span></span><br><span class="line"><span class="string">ansible-playbook</span> <span class="string">all</span> <span class="string">templates.yml</span></span><br></pre></td></tr></table></figure>



<p>if条件判断</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 如果p.name被定义了</span><br><span class="line">&#123;% if p.name is defined %&#125;</span><br><span class="line">do...</span><br><span class="line">&#123;% endif %&#125;</span><br><span class="line">do...</span><br></pre></td></tr></table></figure>









<h1 id="YAML介绍"><a href="#YAML介绍" class="headerlink" title="YAML介绍"></a>YAML介绍</h1><ul>
<li><p>YAML是一个可读性高的用来表达资料序列的格式，YAML参考了其他多种语言，包括XML、C、Python、Perl以及电子邮件格式RFC2822等，Clark Evans在2001年首次发表了这种语言。</p>
</li>
<li><p>YAML特性</p>
<ul>
<li>可读性好</li>
<li>和脚本语言的交互性好</li>
<li>使用实现语言的数据类型</li>
<li>有一个一致的信息模型</li>
<li>易于实现</li>
<li>可以基于流来处理</li>
<li>表达能力强，扩展性好</li>
</ul>
<p><a href="http://www.yaml.org" target="_blank" rel="noopener">http://www.yaml.org</a></p>
</li>
</ul>
<p>YAML语法简介</p>
<ol>
<li>在单一文件中，可以连续用三个连字号<code>-</code>区分多个档案，另外，还有选择性的连续三个点号(…)用来表示档案结尾</li>
<li>次行开始正常写playbook的内容，一般建议写明该Playbook的功能</li>
<li>使用#注释代码</li>
<li>缩进必须是统一的，不能空格和tab混用</li>
<li>缩进的级别也必须是一致的，同样的缩进代表同样的级别，程序判别配置的级别就是通过缩进 结合换行来实现的</li>
<li>YAML文件内容和Linux系统大小写判断方式保持一致，区分大小写，key/value值均需大小写敏感</li>
<li>key/value值可同行写也可以换行写，同行使用<code>:</code>分隔</li>
<li>value可以是字符串，也可以是另一个列表</li>
<li>一个完整的代码块功能需要最少元素包括name:task</li>
<li>一个name只能包含一个task</li>
<li>YAML文件扩展名通常为yml或yaml</li>
</ol>
<ul>
<li><p>LIST：列表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A List</span></span><br><span class="line">- blue</span><br><span class="line">- grenn</span><br><span class="line">- black</span><br><span class="line">- white</span><br><span class="line">- yellow</span><br></pre></td></tr></table></figure>
</li>
<li><p>DICTIONARY：字典</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># A Dictionay</span></span><br><span class="line">name: A</span><br><span class="line"><span class="built_in">jobs</span>: B</span><br><span class="line">skil: C</span><br><span class="line"></span><br><span class="line">&#123;name: A,Job: B,Skil: C&#125;</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>基础写法：在node24上创建文件</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">---</span><br><span class="line">- hosts: node24			<span class="comment">#指定受控端</span></span><br><span class="line">  remote_user: root		<span class="comment">#以什么身份登录受控端</span></span><br><span class="line"></span><br><span class="line">  tasks:</span><br><span class="line">    - name: hello		<span class="comment">#任务名，没什么意思</span></span><br><span class="line">      <span class="built_in">command</span>: touch /root/pl.test	<span class="comment">#使用command模块执行命令</span></span><br></pre></td></tr></table></figure>



<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 把变量定义到一个文件中</span></span><br><span class="line"><span class="string">$</span> <span class="string">cat</span> <span class="string">vars.yml</span></span><br><span class="line"><span class="attr">var1:</span> <span class="string">vsftpd</span></span><br><span class="line"><span class="attr">var2:</span> <span class="string">httpd</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 调用变量</span></span><br><span class="line"></span><br><span class="line"><span class="meta">---</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">webserver</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">vars_files:</span> </span><br><span class="line">  	<span class="bullet">-</span> <span class="string">vars.yml</span></span><br><span class="line">  </span><br><span class="line">  <span class="attr">tasks:</span></span><br><span class="line">  	<span class="bullet">-</span> <span class="attr">name:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line">  	  <span class="attr">yum:</span> <span class="string">name=&#123;&#123;</span> <span class="string">var1</span> <span class="string">&#125;&#125;</span></span><br></pre></td></tr></table></figure>





<h1 id="roles"><a href="#roles" class="headerlink" title="roles"></a>roles</h1><ul>
<li><p>roles</p>
<blockquote>
<p>ansible自1.2版本引入的新特性，用于层次性、结构化组织playbook。roles能够根据层次型结构自动装载变量、tasks以及handlers等。要使用roles只需要在playbook中使用include指令即可，简单来讲，roles就是通过分别将变量、文件、任务、模板及处理器放置于单独的目录中，并且可以便捷的inlcude它们的一种机制。角色一般用于基于主机构建服务的场景中，但也可以用于构建 守护进程等场景中。</p>
</blockquote>
</li>
<li><p>复杂场景建议使用roles，代码复用性高</p>
<blockquote>
<p>某些功能需要多个playbook，通过includes即可实现</p>
</blockquote>
</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">roles目录结构</span><br><span class="line">----------------------------------------------</span><br><span class="line"><span class="comment"># 每个角色，以特定的层级目录结构进行组织</span></span><br><span class="line">playbook.yml</span><br><span class="line">roles/</span><br><span class="line">	project/</span><br><span class="line">		tasks/</span><br><span class="line">		files/</span><br><span class="line">		vars/</span><br><span class="line">		default/</span><br><span class="line">		templates/</span><br><span class="line">		handlers/</span><br><span class="line">		meta/</span><br></pre></td></tr></table></figure>

<p>各目录的作用：</p>
<ul>
<li>files/ ：存放由copy或script模块等调用的文件</li>
<li>templates/：template模块查找所需模板文件目录</li>
<li>tasks/：定义task，role的基本元素，至少应该包含一个名为main.yml的文件，其他的文件需要在此文件中通过include进行包含</li>
<li>handlers/：至少应该包含一个main.yml的文件；其他文件需要再次文件中通过include进行包含</li>
<li>vars/：定义变量，至少应该包含一个main.yml的文件；其他文件需要再次文件中通过include进行包含</li>
<li>meta/：定义当前角色的特殊设定及其依赖关系，至少应该包含一个名为main.yml的文件，其他文件需再此文件中通过include进行包含</li>
<li>default/：设定默认变量时，使用此目录中的mian.yml文件</li>
</ul>
<h1 id="Ansible搭建httpd"><a href="#Ansible搭建httpd" class="headerlink" title="Ansible搭建httpd"></a>Ansible搭建httpd</h1><p>安装httpd</p>
<p>1、目录结构</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">├── httpd_role.yml</span><br><span class="line">├──*roles</span><br><span class="line">│   └──*httpd</span><br><span class="line">│       ├──*tasks</span><br><span class="line">│       │   ├── group.yml</span><br><span class="line">│       │   ├── install.yml</span><br><span class="line">│       │   ├── main.yml</span><br><span class="line">│       │   ├── restart.yml</span><br><span class="line">│       │   ├── start.yml</span><br><span class="line">│       │   ├── templ.yml</span><br><span class="line">│       │   └── user.yml</span><br><span class="line">│       └──*templates</span><br><span class="line">│           └── httpd.conf.j2</span><br><span class="line"></span><br><span class="line">dir:roles,httpd,task,templates</span><br></pre></td></tr></table></figure>



<p>2、文件内容</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">[root@node01 .ansible]<span class="comment"># cat httpd_role.yml </span></span><br><span class="line">- hosts: all</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">        - role: httpd</span><br><span class="line">        </span><br><span class="line">        </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat group.yml </span></span><br><span class="line">- name: add group</span><br><span class="line">  group: name=httpd gid=110 system=yes</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat user.yml </span></span><br><span class="line">- name: add user</span><br><span class="line">  user: name=httpd uid=110 system=yes</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat install.yml </span></span><br><span class="line">- name: install httpd</span><br><span class="line">  yum: name=httpd</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat templ.yml </span></span><br><span class="line">- name: copy config</span><br><span class="line">  template: src=httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</span><br><span class="line">  </span><br><span class="line">[root@node01 tasks]<span class="comment"># cat start.yml </span></span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started  </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">templates下的文件就是复制的/etc/httpd/conf/httpd.conf，并改名为httpd.conf.j2</span><br></pre></td></tr></table></figure>

<p>调用别的角色的任务</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">main.yml</span></span><br><span class="line"></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">install</span> <span class="string">package</span></span><br><span class="line"><span class="bullet">-</span> <span class="attr">include:</span> <span class="string">roles/httpd/tasks/copyfile.yml</span></span><br></pre></td></tr></table></figure>



<p>调用多个角色、启用标签、判断语句</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">[root@node01</span> <span class="string">.ansible]#</span> <span class="string">cat</span> <span class="string">some.yml</span> </span><br><span class="line"><span class="bullet">-</span> <span class="attr">hosts:</span> <span class="string">all</span></span><br><span class="line">  <span class="attr">remote_user:</span> <span class="string">root</span></span><br><span class="line">  <span class="attr">roles:</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">httpd,tags:['web','httpd'],when:</span> <span class="string">ansible_distribution_major_version</span> <span class="string">==</span> <span class="string">"7"</span>	<span class="string">&#125;</span>	<span class="comment">#加判断</span></span><br><span class="line">        <span class="bullet">-</span> <span class="attr">role:</span> <span class="string">nginx</span>	<span class="comment">#这里可以调用多个角色</span></span><br><span class="line">        <span class="bullet">-</span> <span class="string">&#123;</span> <span class="attr">role:</span> <span class="string">vsftpd,tags:</span> <span class="string">['web','vsftpd'</span> <span class="string">]&#125;</span>	<span class="comment">#加标签</span></span><br></pre></td></tr></table></figure>



<p>标签执行</p>
<figure class="highlight yml"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">ansible-play</span> <span class="string">-t</span> <span class="string">vsftpd</span> <span class="string">some.yml</span></span><br></pre></td></tr></table></figure>





<h1 id="Ansible搭建Haproxy"><a href="#Ansible搭建Haproxy" class="headerlink" title="Ansible搭建Haproxy"></a>Ansible搭建Haproxy</h1><table>
<thead>
<tr>
<th>主机</th>
<th>IP</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>node01</td>
<td>192.168.70.10</td>
<td>ansible</td>
</tr>
<tr>
<td>node02</td>
<td>192.168.70.20</td>
<td>haproxy</td>
</tr>
<tr>
<td>node03</td>
<td>192.168.70.30</td>
<td>httpd</td>
</tr>
<tr>
<td>node04</td>
<td>192.168.70.40</td>
<td>httpd</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">!/bin/bash</span></span><br><span class="line">yum -y install ansible</span><br><span class="line">IP2="192.168.70.20"</span><br><span class="line">IP3="192.168.70.30"</span><br><span class="line">IP4="192.168.70.40"</span><br><span class="line"></span><br><span class="line">rm -rf /etc/ansible/hosts </span><br><span class="line">echo "[webs]" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "$IP3 SITE=web1" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "$IP4 SITE=web2" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "[lb]" &gt;&gt; /etc/ansible/hosts </span><br><span class="line">echo "$IP2" &gt;&gt; /etc/ansible/hosts </span><br><span class="line"></span><br><span class="line">rm -rf /root/.ansible/*</span><br><span class="line">mkdir -p /root/.ansible/roles/&#123;httpd,haproxy&#125;/&#123;tasks,templates&#125;</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/install.yml</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/templa.yml</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/start.yml</span><br><span class="line">touch /root/.ansible/roles/&#123;httpd,haproxy&#125;/tasks/main.yml</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/install.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: install httpd</span><br><span class="line">  yum: name=httpd</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">echo "this is &#123;&#123; SITE &#125;&#125;" &gt;&gt; /root/.ansible/roles/httpd/templates/index.html.j2 </span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/templa.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: copy index.html</span><br><span class="line">  template: src=/root/.ansible/roles/httpd/templates/index.html.j2 dest=/var/www/html/index.html</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/start.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: start service</span><br><span class="line">  service: name=httpd state=started</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/httpd/tasks/main.yml &lt;&lt; 'EOF'</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: templa.yml</span><br><span class="line">- include: start.yml</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/install.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: install haproxy</span><br><span class="line">  yum: name=haproxy</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/templates/haproxy.cfg.j2 &lt;&lt; 'EOF'</span><br><span class="line">global</span><br><span class="line">    log         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">defaults</span><br><span class="line">    mode                    http</span><br><span class="line">    log                     global</span><br><span class="line">    option                  httplog</span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s</span><br><span class="line">    timeout queue           1m</span><br><span class="line">    timeout connect         10s</span><br><span class="line">    timeout client          1m</span><br><span class="line">    timeout server          1m</span><br><span class="line">    timeout http-keep-alive 10s</span><br><span class="line">    timeout check           10s</span><br><span class="line">    maxconn                 3000</span><br><span class="line">frontend  main *:8080</span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          if url_static</span><br><span class="line">    default_backend             app</span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">EOF</span><br><span class="line">echo -e "    server web1 $IP3:80 check" &gt;&gt; /root/.ansible/roles/haproxy/templates/haproxy.cfg.j2</span><br><span class="line">echo -e "    server web2 $IP4:80 check" &gt;&gt; /root/.ansible/roles/haproxy/templates/haproxy.cfg.j2   </span><br><span class="line">  </span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/templa.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: copy index.html</span><br><span class="line">  template: src=/root/.ansible/roles/haproxy/templates/haproxy.cfg.j2 dest=/var/www/html/index.html dest=/etc/haproxy/haproxy.cfg</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/start.yml &lt;&lt; 'EOF'</span><br><span class="line">- name: start service</span><br><span class="line">  service: name=haproxy state=started</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/roles/haproxy/tasks/main.yml &lt;&lt; 'EOF'</span><br><span class="line">- include: install.yml</span><br><span class="line">- include: templa.yml</span><br><span class="line">- include: start.yml</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /root/.ansible/lb_role.yml &lt;&lt; 'EOF'</span><br><span class="line">---</span><br><span class="line">- hosts: webs</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: httpd</span><br><span class="line"></span><br><span class="line">- hosts: lb</span><br><span class="line">  remote_user: root</span><br><span class="line">  roles:</span><br><span class="line">    - role: haproxy</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cd /root/.ansible/</span><br><span class="line">ansible-playbook -$1 lb_role.yml</span><br><span class="line">echo "Please Curl $IP2:8080"</span><br></pre></td></tr></table></figure>

</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="mailto:undefined">杜振铨</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="http://archks.github.io/2020/02/24/Ansible/">http://archks.github.io/2020/02/24/Ansible/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="http://archks.github.io" target="_blank">zen's blog</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/Ansible/">Ansible</a></div><div class="post_share"><div class="social-share" data-image="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"/><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js"></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2020/02/27/Switch/"><img class="prev-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">Switch交换机</div></div></a></div><div class="next-post pull-right"><a href="/2020/02/23/OSPF/"><img class="next-cover" data-src="https://i.loli.net/2020/05/01/gkihqEjXxJ5UZ1C.jpg" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">下一篇</div><div class="next_info">OSPF协议</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2018 - 2020 By 杜振铨</div><div class="framework-info"><span>驱动 </span><a href="https://hexo.io" target="_blank" rel="noopener"><span>Hexo</span></a><span class="footer-separator">|</span><span>主题 </span><a href="https://github.com/jerryc127/hexo-theme-butterfly" target="_blank" rel="noopener"><span>Butterfly</span></a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="font_plus" type="button" title="放大字体"><i class="fas fa-plus"></i></button><button id="font_minus" type="button" title="缩小字体"><i class="fas fa-minus"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="回到顶部"><i class="fas fa-arrow-up"></i></button></div></section><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="/js/tw_cn.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script src="https://cdn.jsdelivr.net/npm/instant.page/instantpage.min.js" type="module" defer></script><script src="https://cdn.jsdelivr.net/npm/vanilla-lazyload/dist/lazyload.iife.min.js" async></script></body></html>