<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>文章归档: 2020/2 | zen&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="Jelon, 前端, Web, 张德龙, 前端开发" >
    <meta name="description" content="Jelon个人前端小站" >

    
    <link rel="alternative" href="/atom.xml" title="zen&#39;s blog" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="../../../favicon.ico" >
    
    
<link rel="stylesheet" href="../../../css/style.css">

    <!--[if lt IE 9]>
    
<script src="../../../js/html5.js"></script>

    <![endif]-->
    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d5ebf515ab530cfbdda5f5c85093fb41";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 4.2.0"></head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/" target="_blank" rel="noopener">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="../../../index.html">
                <div class="cover">
                    <span class="name">zen&#39;s blog</span>
                    <span class="description"></span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="" class="item ">
                <a href="../../../index.html" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../lab/" title="实验室" class="icon-lab">&nbsp;实验室</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="https://github.com/jangdelong" target="_blank">Github</a>
                        |
                    
                        <a href="https://pages.coding.me" target="_blank">Hosted by Coding Pages</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com/jangdelong" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="../../../img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章归档 -->

    <h3 class="widget-hd">
        <strong>
            
                文章归档
                <!-- 文章归档，可以根据日期分类 -->
            
        </strong>
    </h3>
    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/27/Switch%E4%BA%A4%E6%8D%A2%E6%9C%BA/">
    		Switch交换机
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-27T12:34:14.000Z">2020-02-27</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <div style="color:red">淦，实在不知道用什么封面了，网上关于Lay2 Lay3 Switch都巨丑，用自己正在打字的电脑做封面吧^_^??</div>
<br>

<p>交换技术主要用于构建局域网，主要实现的局域网内的通信和隔离。交换机即插即用，因为所有的接口默认分配在vlan 1 中，且vlan 1为native vlan，不需要进行封装。为了实现局域网的隔离，可以将不同的接口或者MAC地址划分到不同的vlan，同一个vlan下的地址可以相互通信。</p>
<p>交换机主要存在的问题和解决方法：</p>
<ol>
<li>广播风暴，链路防环：使用Spanning-Tree或者快速生成树(MSTP、RSTP等)以及一系列生成树补丁来解决</li>
<li>Vlan同步：交换机不能转发自己没有的vlan信息，比如一个只有vlan 10,20,30的交换机不能转发和接受vlan40的报文，有两种解决方式：（1）手动配置使之相同   （2）VTP vlan同步协议</li>
<li>带宽受限：因为spanning-tree的缘故，两个交换机之间只能存在一条链路，因此带宽受限。可以使用二层或三层链路捆绑，提高网络带宽</li>
<li>网关单点故障：因为只有一个默认网关，所以当down了之后，终端就无法与外界通信。可以使用网关冗余协议，如(FHRP,VRRP,GLBP)做高可用。</li>
</ol>
<p>讲到交换机不得不讲MAC地址，MAC地址和交换机同属于OSI七层的第二层——数据链路层。MAC地址一共有48位，前24位厂家分配，类似于手机的前几位网络识别号。MAC地址有如下字段：</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/switch_1.png"></p>
<p>其中：</p>
<ul>
<li>类型：用于标识上一层使用的协议</li>
<li>IP数据报长度：46 = 64 - 6 - 6 - 2 - 4</li>
<li>FCS：帧检验序列，使用CRC循环冗余校验</li>
</ul>
<h1 id="配置VLAN"><a href="#配置VLAN" class="headerlink" title="配置VLAN"></a>配置VLAN</h1><p>ps：vlan的隔离包括广播，即使是发ARP，也只会发在自己的vlan。</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/switch_2.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># SW7 创建vlan</span></span><br><span class="line">vlan 10,20</span><br><span class="line"></span><br><span class="line"><span class="comment"># SW7 将接口加入到vlan，e0/1,2 e1/0,1 都是这样配</span></span><br><span class="line">int e0/1</span><br><span class="line">switchport mode access							<span class="comment"># 将接口模式改为access</span></span><br><span class="line">switchport access vlan 10						<span class="comment"># 将接口加入到vlan 10 中</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># SW7 串口配置，即和SW8连接的e0/3接口</span></span><br><span class="line">int e0/3</span><br><span class="line">switchport trunk encapsulation dot1q			<span class="comment"># 一律使用802.1Q封装</span></span><br><span class="line">switchport mode trunk							<span class="comment"># 改变接口的模式为trunk</span></span><br></pre></td></tr></table></figure>



<p>交换机接口的三种模式：Vlan的链路类型可以分为接入链路和干道链路。</p>
<p>Access：只能属于1个VLAN，且该端口不打tag，一般用于连接计算机端口；　</p>
<p>Trunk：可以允许多个VLAN通过，且该端口都是打tag的，一般用于交换机之间的连接；　　</p>
<p>Hybrid：可以允许多个VLAN通过，至于该端口在vlan中是否打tag由用户根据具体情况而定，可以用于交换机之间的连接也可以用于交换机和用户计算机之间的连接。　　</p>
<p>Trunk和Hybrid的区别主要是，hybrid端口可以允许多个vlan的报文不打标签，而 trunk端口只允许缺省vlan的报文不打标签，同一个交换机上不能hybrid和trunk并存。</p>
<p>Trunk也可以由交换机自行协商，但一般都是网络管理员手动配置。</p>
<h1 id="VTP"><a href="#VTP" class="headerlink" title="VTP"></a>VTP</h1><p>VTP用于Vlan同步，分为三种模式：服务端(server)、客户端(client)、透传端(transparent)，客户端只可以查看不可以修改，服务端和透传端既可以查看又可以修改。</p>
<p>VTP只会同步vlan和vlan的名字，vlan的接口信息不会被同步走。</p>
<p>配置VTP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置服务端</span></span><br><span class="line">vlan 10-20					<span class="comment"># 创建vlan</span></span><br><span class="line">vtp domain cisco			<span class="comment"># 更改域名， 可以改可以不改，用于让一个局域网有许多vtp</span></span><br><span class="line">vtp mode server 			<span class="comment"># 将本机vtp的模式改为server</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置透传端</span></span><br><span class="line">vtp domain cisco</span><br><span class="line">vtp mode transparent</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置客户端</span></span><br><span class="line">vtp domain cisco</span><br><span class="line">vtp mode client</span><br></pre></td></tr></table></figure>



<p>其他命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Switch<span class="comment">#sh vlan brief 			# 查看本机vlan摘要</span></span><br><span class="line">Switch<span class="comment">#sh vtp ? 				# 查看vtp相关</span></span><br></pre></td></tr></table></figure>



<p>VTP修剪：一种优化vlan的方法</p>
<center style="font-weight:bold;">A ----> B -----> C -----D(I'm a PC)</center>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">vtp pruning			<span class="comment"># 开启vtp修剪</span></span><br></pre></td></tr></table></figure>

<p>比如：A、B、C是交换机，D是PC。</p>
<p>A的vlan：10，20，30，40</p>
<p>B的vlan：10，20</p>
<p>C的vlan：10，20</p>
<p>一旦开启vtp修剪，则C会告诉B：”我这没有vlan30，40，以后不要给我发vlan30，40的广播或者其他消息了”，B收到后会告诉A：”我这没有vlan30 ，40，以后不要发这个vlan的消息了”。A就会把这接口上的这两个vlan剪掉。</p>
<h1 id="生成树"><a href="#生成树" class="headerlink" title="生成树"></a>生成树</h1><p>生成树（Spanning-tree）是一种工作在OSI网络模型中的第二层（数据链路层）的通信协议，基本应用是防止交换机冗余链路产生的环路.用于确保以太网中无环路的逻辑拓扑结构.从而避免了广播风暴,大量占用交换机的资源。</p>
<p>生成树使用封锁接口的方式避免环路，被封锁的接口有如下判定方式：</p>
<ol>
<li>每个广播域选择一个根桥（注意是广播域，不是局域网）Root Bridge</li>
<li>每个非根桥选择一个根端口  Root Port</li>
<li>每个段选择一个指定端口 Designated Port</li>
<li>选择一个非指定端口，以上所有选择策略，都是以越小越优为准则</li>
</ol>
<p>根桥的制定：谁的MAC地址最小，谁就是根桥</p>
<p>根端口的指定：谁离根桥进，谁就是根端口</p>
<p>指定端口的指定：</p>
<ol>
<li>离根桥近</li>
<li>COST值小</li>
<li>发送者的端口ID小，端口ID即交换机的接口</li>
</ol>
<p>非指定端口将被封锁。</p>
<p>全网一开始是如何知道谁是根桥？</p>
<p>全网交换机开机，一开始，每台交换机都认为自己是根桥ID向外发送BPDU报文，如果在收到的BPDU报文中，发现了比自己还小的MAC地址，就把根桥ID改为那一台交换机的ID。经过一段时间，就可以确定全网的唯一的根桥ID。（可以抢占）</p>
<p>BPDU报文格式：</p>
<table>
<thead>
<tr>
<th>字节</th>
<th>字段</th>
<th>描述</th>
</tr>
</thead>
<tbody><tr>
<td>2</td>
<td>协议</td>
<td>代表上层协议(BPDU)，该值总为0</td>
</tr>
<tr>
<td>1</td>
<td>版本</td>
<td>（802.1D的总为0）</td>
</tr>
<tr>
<td>1</td>
<td>TYPE</td>
<td>“配置BPDU” 为0，“TCN BPDU”为80，TCN，topology change notification，拓扑改变时发送的报文，自下而上。</td>
</tr>
<tr>
<td>1</td>
<td>标志</td>
<td>LSB最低有效位表示TC标志，MSB最高的有效位表示TCA标志</td>
</tr>
<tr>
<td>8</td>
<td>根桥ID</td>
<td>根网桥的桥ID</td>
</tr>
<tr>
<td>4</td>
<td>路径开销</td>
<td>到达根桥的STP cost，如果是根桥则写0，带宽越大，开销越低</td>
</tr>
<tr>
<td>8</td>
<td>网桥ID</td>
<td>BPDU发送桥的ID</td>
</tr>
<tr>
<td>2</td>
<td>端口ID</td>
<td>BPDU发送网桥的端口ID（优先级+端口号），优先级默认128</td>
</tr>
<tr>
<td>2</td>
<td>消息寿命Message age</td>
<td>从根网桥发出BPDU之后的秒数，每经过一个网桥都减1，本质上是到达根桥的跳数</td>
</tr>
<tr>
<td>2</td>
<td>最大寿命Max age</td>
<td>当一段时间未收到任何BPDU，生存期达到MAX age，网桥认为该端口连接链路发生故障，默认20S</td>
</tr>
<tr>
<td>2</td>
<td>HELLO时间</td>
<td>根网桥连续发送BPDU之间的时间间隔，默认2S</td>
</tr>
<tr>
<td>2</td>
<td>转发延迟</td>
<td>在监听和学习状态停留的时间间隔，默认15S</td>
</tr>
</tbody></table>
<p>关于生成树，要配置的内容很少，都是现象，因为一切默认都已经配置好了，除非是改变生成树的种类。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">show spanning-tree		<span class="comment">#查看生成树的状态</span></span><br><span class="line">spanning-tree vlan 1 priority 4096			<span class="comment">#修改VLAN中spanning-tree的优先级。必须是4096的倍数</span></span><br><span class="line">VLAN0001											<span class="comment">#VLAN 1</span></span><br><span class="line">  Spanning tree enabled protocol ieee</span><br><span class="line">  Root ID    Priority    32769						<span class="comment">#32769=32768+VLAN.Nbr</span></span><br><span class="line">             Address     aabb.cc00.0100				<span class="comment">#MAC地址</span></span><br><span class="line">             Cost        100						<span class="comment">#这个VLAN的COST值</span></span><br><span class="line">             Port        2 (Ethernet0/1)			<span class="comment">#RootID所用的端口</span></span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             <span class="comment">#Hello报文2s，最大寿命20s，转发延迟15s</span></span><br><span class="line"></span><br><span class="line">  Bridge ID  Priority    32769  (priority 32768 sys-id-ext 1)	<span class="comment">#系统扩展ID就是VLAN 的序号</span></span><br><span class="line">             Address     aabb.cc00.0300							</span><br><span class="line">             Hello Time   2 sec  Max Age 20 sec  Forward Delay 15 sec</span><br><span class="line">             Aging Time  300 sec								<span class="comment">#网络拓扑变化时，会变成15s，快速刷新mac表</span></span><br><span class="line"></span><br><span class="line">Interface           Role  Sts     Cost      Prio.Nbr Type</span><br><span class="line">------------------- ---- --- --------- -------- --------------------------------</span><br><span class="line">Et0/0               Desg  FWD     100       128.1    Shr</span><br><span class="line">Et0/1               Root  FWD     100       128.2    Shr</span><br><span class="line">Et0/2               Altn  BLK     2         128.3    Shr</span><br><span class="line">Et0/3               Desg  FWD     100       128.4    Shr</span><br><span class="line">接口				   角色 端口状态  Cost值   优先级.序号 类型</span><br></pre></td></tr></table></figure>





<p>生成树中的端口状态</p>
<table>
<thead>
<tr>
<th>状态</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Disabled</td>
<td>不收发任何报文</td>
</tr>
<tr>
<td>Blocking</td>
<td>不接受也不转发帧，接受但不发送BPDU，不学习MAC地址</td>
</tr>
<tr>
<td>Listening</td>
<td>不接受也不转发帧，接受并且发送BPDU，不学习MAC地址</td>
</tr>
<tr>
<td>Learning</td>
<td>不接受也不转发帧，接受并且发送BPDU，学习MAC地址</td>
</tr>
<tr>
<td>Forwarding</td>
<td>接收并转发帧，接受并且发送BPDU，学习MAC地址</td>
</tr>
</tbody></table>
<p>状态转换：</p>
<img src="http://q5q3e2ctx.bkt.clouddn.com/switch_3.png" alt="image-20200227161444047" style="zoom:50%;" />


<h2 id="实验现象"><a href="#实验现象" class="headerlink" title="实验现象"></a>实验现象</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_4.png" alt="image-20200209154918120"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R6 ping R7</span><br><span class="line"></span><br><span class="line">原本sw4的e0/3没有连接sw1的e0/3，现在将他们连接起来。此时，链路会有30s的不通，这是spanning-tree协议工作：</span><br><span class="line">原本的路由是R6 -- SW4 -- SW3 -- SW2 --SW1 --R7</span><br><span class="line">现在SW4和SW1连通，造成了SW3的e0/2接口发生了阻断BLK。</span><br><span class="line">路由路线变为：R6 -- SW4 -- SW1 -- R7</span><br><span class="line">SW4的e0/3接口从LIS -- LRN -- FWD需要30s的时间，所以30sping不通。</span><br><span class="line"></span><br><span class="line">然后将sw4的e0/3 shutdown ,SW3发现没有BPDU出现了，进入Lost BPDU Max age=20s，20sBPDU不出现，然后进入Listening（15s）和Learning（15s），一共恢复需要30s。</span><br></pre></td></tr></table></figure>







<h2 id="生成树拓扑变化"><a href="#生成树拓扑变化" class="headerlink" title="生成树拓扑变化"></a>生成树拓扑变化</h2><p>也叫STP 拓扑变化。</p>
<img src="http://q5q3e2ctx.bkt.clouddn.com/switch_5.png" alt="image-20200209091346870" style="zoom:50%;" />

<p>Topology Change Notification Bridge Protocol Data Unit = TCN BPDU</p>
<p>网络拓扑变更报文  网桥协议单元，即当下层交换机拓扑发生变化时，次级交换机向Root Bridge传递TCN BPDU报文，即BPDU字段中的Type改为80。沿着根端口就可以最终把报文传送给Root，Root接收到后，发送TC标志设置，内容为空，目的是为了泛洪。</p>
<img src="http://q5q3e2ctx.bkt.clouddn.com/switch_6.png" alt="image-20200209091358909" style="zoom:50%;" />

<p>35s = age老化时间（20s） +  Learning（15s）[生成树的计算时间]</p>
<h2 id="Portfast：快速端口"><a href="#Portfast：快速端口" class="headerlink" title="Portfast：快速端口"></a>Portfast：快速端口</h2><p>一个接口从开启到能正常运行会经历三个阶段，需要一定的时间。这是为了防止环路。如果不需要防环，可以使用Portfast来快速启动，这样已启动就变成FWD。</p>
<p>配置命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree portfast</span><br></pre></td></tr></table></figure>





<h2 id="PVST-：Peer-Vlan-Spanning-Tree-Plus"><a href="#PVST-：Peer-Vlan-Spanning-Tree-Plus" class="headerlink" title="PVST+：Peer Vlan Spanning-Tree Plus"></a>PVST+：Peer Vlan Spanning-Tree Plus</h2><p>每个VLAN都有一个生成树，Cisco私有。</p>
<p>Cisco Catalyst交换机的MAC地址池最多可以容纳1024个地址，交换机的型号决定了可用MAC的数目，并不是所有catalyst交换机都能支持到这么多个MAC</p>
<p>这些MAC地址作为VLAN生成树中的网桥ID的MAC地址部分，不同交换机型号支持不同的可用MAC地址数目，交换机依照次序分配MAC地址</p>
<p><code>show run int | include bia</code>可以看到所有的MAC，其中第一个MAC将被生成树使用，也就是CPU的MAC，接下去就是每个以太网接口的MAC</p>
<p>我们知道交换机能够支持的VLAN数据是很庞大的，如果开启PVST+，每个VLAN一棵生成树，而每棵生成树都要有一个独立的标识，都需要耗费MAC的话，那么MAC地址池肯定是无法承受的</p>
<p>因此需要用到MAC地址缩减方案，这也是为什么优先级必须是4096倍数的原因。</p>
<img src="http://q5q3e2ctx.bkt.clouddn.com/switch_7.png" alt="image-20200227162938052" style="zoom:33%;" />

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">show spanning-tree</span><br><span class="line"></span><br><span class="line">Priority 4097 (priority 4096 sys-id-ext 1)</span><br><span class="line"><span class="comment">#因为系统扩展ID是1，所以优先级要+1</span></span><br><span class="line"><span class="comment">#系统扩展ID=1是因为VLAN是1</span></span><br></pre></td></tr></table></figure>

<p>实验：</p>
<ul>
<li>VLAN 10,20 SW1为Root</li>
<li>VLAN 30,40 SW2为Root</li>
</ul>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_8.png" alt="image-20200209092821283"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">show spanning-tree										<span class="comment">#查看生成树的状态</span></span><br><span class="line">spanning-tree vlan 1 priority 4096						<span class="comment">#修改PVST+的优先级</span></span><br><span class="line">spanning-tree vlan 10,20 root primary 					<span class="comment">#将vlan10,20的优先级比当前环境下最小的优先级低两个档次</span></span><br><span class="line">spanning-tree vlan 10,20 root primary 					<span class="comment">#将vlan10,20的优先级比当前环境下最小的优先级低一个档次</span></span><br></pre></td></tr></table></figure>





<h1 id="快速生成树"><a href="#快速生成树" class="headerlink" title="快速生成树"></a>快速生成树</h1><p>由于生成树的速度过慢，一般会采用快速生成树。数据中心不会使用生成树，而是大二层的结构，但园区网还是会用到生成树。下面介绍两种快速生成树，一种是Cisco私有的RSTP，一种是公开的MSTP。</p>
<h2 id="RSTP：Rapid-Spanning-Tree-Protocol"><a href="#RSTP：Rapid-Spanning-Tree-Protocol" class="headerlink" title="RSTP：Rapid Spanning Tree Protocol"></a>RSTP：Rapid Spanning Tree Protocol</h2><p>特点：</p>
<ul>
<li>802.1W</li>
<li>端口角色：根端口、指定端口、替代端口、备份端口</li>
<li>端口状态：转发、丢弃、学习</li>
<li>在Cisco Catalyst交换机上，PVST+是基于RSTP实现的perVLAN版本</li>
</ul>
<p>配置：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree mode rapid-pvst			<span class="comment">#BPDU的速度又多了快这个生成树就有多快</span></span><br></pre></td></tr></table></figure>



<img src="http://q5q3e2ctx.bkt.clouddn.com/switch_9.png" alt="image-20200209162727580"  />



<h2 id="MSTP：Multiple-Spanning-Tree-Protocol"><a href="#MSTP：Multiple-Spanning-Tree-Protocol" class="headerlink" title="MSTP：Multiple Spanning Tree Protocol"></a>MSTP：Multiple Spanning Tree Protocol</h2><p>集成了RSTP的优点，每实例一个生成树，PVSTP是每个vlan一颗生成树。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree mst configuration</span><br><span class="line">instance 1 vlan 10,20		<span class="comment"># 创建实例，并把vlan10，20归入实例1</span></span><br><span class="line">instance 2 vlan 30,40</span><br><span class="line">show pending</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置优先级，系统扩展id变为实力号Instance.Nbr</span></span><br><span class="line">SW1</span><br><span class="line">spanning-tree mst 1 root primary		</span><br><span class="line">spanning-tree mst 2 root secondary</span><br><span class="line"></span><br><span class="line">SW2</span><br><span class="line">spanning-tree mst 1 root secondary</span><br><span class="line">spanning-tree mst 2 root primary</span><br></pre></td></tr></table></figure>





<h1 id="生成树补丁"><a href="#生成树补丁" class="headerlink" title="生成树补丁"></a>生成树补丁</h1><p>Spanning-tree Patch，主要有六种生成树补丁，针对解决生成树反应慢、出差错、及故障检测。</p>
<h2 id="1、BPDUGuard"><a href="#1、BPDUGuard" class="headerlink" title="1、BPDUGuard"></a>1、BPDUGuard</h2><p>该接口在手都BPDU报文后，会立即切换到err-disable状态,把接口down了，常搭配portfast特性在接口上一起使用，用于连接主机，可在接口模式上激活，也可在全局模式上配置，两者有所不同。</p>
 <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree bpduguard <span class="built_in">enable</span> 							<span class="comment"># 接口</span></span><br><span class="line">spanning-tree portfast bpduguard default				<span class="comment"># 全局</span></span><br><span class="line">show err recov											<span class="comment"># 查看状态</span></span><br></pre></td></tr></table></figure>



<h2 id="2、BPDUFilter"><a href="#2、BPDUFilter" class="headerlink" title="2、BPDUFilter"></a>2、BPDUFilter</h2><p>一旦收到BPDU，就把接口上的Portfast删除。相当于可以智能判断是PC还是Switch。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree portfast bpdufilter default 				<span class="comment"># 全局</span></span><br><span class="line">spanning-tree bpdufilter <span class="built_in">enable</span>							<span class="comment"># 接口</span></span><br></pre></td></tr></table></figure>



<h2 id="3、UplinkFast"><a href="#3、UplinkFast" class="headerlink" title="3、UplinkFast"></a>3、UplinkFast</h2><p>当唯一的根端口Down，立刻切换到转发状态 ，跳过了LIS和LER的30s延时,但还有20s的max age 。所有配置了Uplink的交换机，都会把自己的优先级升高、COST值增加3000，防止自己成为ROOT。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree  uplinkfast</span><br></pre></td></tr></table></figure>





<h2 id="4、BackboneFast"><a href="#4、BackboneFast" class="headerlink" title="4、BackboneFast"></a>4、BackboneFast</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_10.png" alt="image-20200209185752441"></p>
<p>在部署了Backbone Fast后，SW3一旦收到SW2发送来的次优BPDU，会立即进行一系列的步骤以重新计算根端口，SW3会从跟端向根桥发送RLQ请求</p>
<p>Root SW1收到RLQ请求，立刻以RLQ响应进行恢复，以告知自己仍然存活</p>
<p>SW3立刻老化掉存储在Fae0/3上的BPDU，端口Fa0/3进入Listening状态开始发送BPDU</p>
<p>SW2从SW3收到BPDU，经过计算得出自己的Fa0/2为根端口</p>
<p>相当于去掉了20s BLK状态</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree backbonefast</span><br></pre></td></tr></table></figure>



<h2 id="5、RootGuard"><a href="#5、RootGuard" class="headerlink" title="5、RootGuard"></a>5、RootGuard</h2><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_11.png" alt="image-20200209185915776" style="zoom:67%;" />

<p>只要Service-Provider Network端收到其他地方发来的更优质的BPDU，就将那个区域置为inconsistent。注意inconsistent跟err-disable的区别是，err-disable会disable整个接口，而inconsistentport是针对特定的vlan的。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">只会屏蔽当前VLAN(发给我更优的BPDU)</span><br><span class="line">spanning-tree guard root			<span class="comment"># 接口上配置root防护，这个端口就不可以成为根段偶</span></span><br><span class="line">show span inconsistentport 			<span class="comment"># 查看接口</span></span><br></pre></td></tr></table></figure>





<h2 id="6、LoopGuard"><a href="#6、LoopGuard" class="headerlink" title="6、LoopGuard"></a>6、LoopGuard</h2><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_12.png" alt="image-20200209191229933" style="zoom: 67%;" />

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">spanning-tree guard loop 	<span class="comment">#接口上配置loop防护，这个端口就可以检测单向通行故障</span></span><br></pre></td></tr></table></figure>





<h1 id="单臂路由"><a href="#单臂路由" class="headerlink" title="单臂路由"></a>单臂路由</h1><p>单臂路由，路由器只有一条线连接，是三层交换机的替代品。其主要缺点就是三层交换机的优点：</p>
<ol>
<li>故障多，路由器的故障， 交换机的故障，路由器到交换机只有一条链路，单点故障</li>
<li>带宽有限，如果是三层交换机，则三层交换机中的路由器和交换机传输速率几乎无限</li>
</ol>
<p>`</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_13.png" alt="image-20200209192447894"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">R1</span><br><span class="line">int e0/0</span><br><span class="line">no sh</span><br><span class="line">int e0/0.10</span><br><span class="line">encapsulation dot1Q 10</span><br><span class="line">ip add 192.168.10.254 255.255.255.0</span><br><span class="line">int e0/0.20</span><br><span class="line">encapsulation dot1Q 20</span><br><span class="line">ip add 192.168.20.254 255.255.255.0</span><br><span class="line">end</span><br><span class="line">sh int e0/0.10</span><br><span class="line"></span><br><span class="line"><span class="comment">#sw</span></span><br><span class="line">int e0/1</span><br><span class="line">sw tr en <span class="keyword">do</span> </span><br><span class="line">sw mo tr</span><br><span class="line">end</span><br><span class="line"><span class="comment">#交换机还要反应一会，从LIS-LRN-FWD</span></span><br><span class="line"></span><br><span class="line">此时，R2 Ping R3</span><br></pre></td></tr></table></figure>





<h1 id="三层交换"><a href="#三层交换" class="headerlink" title="三层交换"></a>三层交换</h1><p>三层交换就相当于二层交换加了一台路由器在上面，可以实现更加灵活的网络流量路由管控。</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_14.png" alt="image-20200209194011387"></p>
<p>现在R2处于vlan10，R3处于vlan20，想要R2 ping通R3 ，在SW上进行配置：</p>
<p>1、 配置接口 vlan 10，添加属于R2网段额IP地址</p>
<p>2、配置接口 vlan 20， 添加属于R3网段的IP地址</p>
<p>3、在R2和R3上配置默认路由</p>
<p>4、 然后就会发现，R2可以直接ping通R3了</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#SW</span></span><br><span class="line">int vlan 10						<span class="comment">#启用SVI接口，Lay3SW的交换机接口是虚拟的</span></span><br><span class="line">ip add 192.168.10.254 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">end</span><br><span class="line">sh ip int bri</span><br><span class="line"></span><br><span class="line">int vlan 20</span><br><span class="line">ip add 192.168.20.254 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">end</span><br><span class="line">sh ip int bri</span><br><span class="line"></span><br><span class="line"><span class="comment">#R，一定要记得配默认路由</span></span><br><span class="line">ip route 0.0.0.0 255.255.255.255 Ethernet0/0</span><br></pre></td></tr></table></figure>



<p>SVI(switch virtual interface) 交换虚拟接口的Line-State在以下条件满足的情况下，才会是UP</p>
<ul>
<li>SVI对应的VLAN必须在<code>vlan database</code>中存在并且是激活的——vlan存在且激活</li>
<li><code>vlan interface</code>存在并且不能是<code>down</code>状态——路由器接口up</li>
<li>必须至少有一个二层接口是UP的，而且必须是Spanning-tree的FWD状态——二层交换机接口up</li>
</ul>
<h1 id="DHCP"><a href="#DHCP" class="headerlink" title="DHCP"></a>DHCP</h1><ul>
<li>Dynamic Host Configuration Protocal</li>
<li>基于UDP协议端口67及68</li>
<li>bootPC：67（客户端端口号）；bootPS：68（服务端端口号）</li>
</ul>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_15.png" alt="image-20200210154539047"></p>
<p>这四条消息全部都是广播。</p>
<p>配置DHCP</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">(config-if)<span class="comment"># ip dhcp pool cisico</span></span><br><span class="line">(dhcp-config)<span class="comment"># network 192.168.1.0/24</span></span><br><span class="line">(dhcp-config)<span class="comment"># default-router 192.168.1.1		# 默认路由器</span></span><br><span class="line">(dhcp-config)<span class="comment"># dns-server 114.114.114.114 114.114.115.115	# DNS</span></span><br><span class="line">(dhcp-config)<span class="comment"># lease 1		-租约时间1天</span></span><br><span class="line">(config)<span class="comment"># ip dhcp excluded-address 192.168.1.1    # 排除掉我们用的地址</span></span><br><span class="line"></span><br><span class="line">还有一种写法：1~99不分配</span><br><span class="line">ip dhcp excluded-address 192.168.1.1 192.168.1.99</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#局域网的其他设备</span></span><br><span class="line">(config)<span class="comment"># ip add dhcp</span></span><br><span class="line">  </span><br><span class="line">sh ip dhcp bingding		<span class="comment">#查看DHCP的IP地址的绑定</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#绑定IP地址</span></span><br><span class="line">ip dhcp pool R1</span><br><span class="line">host 192.168.1.10</span><br><span class="line">client-identifier [client-id]</span><br><span class="line"><span class="comment">#如果client_id已被使用，则清楚</span></span><br><span class="line">clear ip dhcp <span class="built_in">bind</span> *</span><br></pre></td></tr></table></figure>



<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_16.png" alt="image-20200210160941108"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#跨越路由器的广播DHCP请求</span></span><br><span class="line">R4是DHCP服务器，R1想要请求DHCP的广播不能跨越R3，这是可以在R3上进行配置，如果收到请求DHCP的报文，则用单播的形式将消息发送给R4</span><br><span class="line">R3</span><br><span class="line">int e0/1</span><br><span class="line">ip helper-address 192.168.34.4</span><br></pre></td></tr></table></figure>



<h1 id="链路捆绑"><a href="#链路捆绑" class="headerlink" title="链路捆绑"></a>链路捆绑</h1><p>如果直接连接两个交换机，则会因为有spanning-tree，造成无论链接多少线，都只会有一根通，从而带宽得不到提高。链路捆绑最大支持8根线绑在一起，这里只介绍二层捆绑，三层捆绑要在接口上<code>no switchport</code>，然后再配置IP地址</p>
<p>EC：需要对端交换机都配</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int range e0/1 -2</span><br><span class="line">channel-group 1 mode on</span><br><span class="line"></span><br><span class="line">此时再看生成树，就会发现e0/1和e0/2都消失了，只留下了Po1，查看带宽，也变大了。</span><br><span class="line"></span><br><span class="line">配置Trunk</span><br><span class="line">int port-channel 1 </span><br><span class="line">sw tr en <span class="keyword">do</span> </span><br><span class="line">sw mo tr</span><br><span class="line"></span><br><span class="line">查看channel</span><br><span class="line">sh etherchannel [summary]</span><br></pre></td></tr></table></figure>



<p>修改负载均衡的方式</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">port-channel load-balance [] <span class="comment"># src-dst-mac</span></span><br><span class="line"><span class="comment">#二层不能用IP地址</span></span><br><span class="line">show etherchannel loadbalance</span><br></pre></td></tr></table></figure>





<h1 id="首跳冗余协议"><a href="#首跳冗余协议" class="headerlink" title="首跳冗余协议"></a>首跳冗余协议</h1><p>FHRP：first hop redundancy protocal，用于配置多个网关，配在多个朝内的接口上。常用的FHRP协议有：</p>
<ol>
<li>HSRP</li>
<li>VRRP</li>
<li>GLBP</li>
</ol>
<h2 id="HSRP"><a href="#HSRP" class="headerlink" title="HSRP"></a>HSRP</h2><p>其中以VRRP最常见，HSRP是Cisco私有的，GLBP有Bug。</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_17.png" alt="image-20200210170625634"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@不让R2和R3建立邻居</span><br><span class="line">R2<span class="comment"># passive-interface e0/1</span></span><br><span class="line">R3<span class="comment"># passive-interface e0/1 </span></span><br><span class="line"></span><br><span class="line">@配置网关,R4网关指向的地址不存在</span><br><span class="line">R4<span class="comment"># ip route 0.0.0.0 0.0.0.0 192.168.1.254</span></span><br><span class="line"></span><br><span class="line">@在R2,R3上配置standby ip 监听一个虚拟的IP</span><br><span class="line">int e0/1</span><br><span class="line">standby 1 ip 192.168.1.254</span><br><span class="line"></span><br><span class="line">sh standby brief 	<span class="comment">#查看standby的缩略信息</span></span><br><span class="line"></span><br><span class="line">- standby 会向组播地址发送信息</span><br><span class="line">- R2、R3会发现彼此，通过IP地址选出一个人来做网关</span><br><span class="line"></span><br><span class="line"><span class="comment">#上图是交换机，实际上交换机不行，需要换成集线器</span></span><br></pre></td></tr></table></figure>



<p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_18.png" alt="image-20200210171831381"></p>
<p>这个IP地址是规定死的，最后一位表示standby 1 </p>
<p>HSRP状态机</p>
<table>
<thead>
<tr>
<th>State</th>
<th>说明</th>
</tr>
</thead>
<tbody><tr>
<td>Initial</td>
<td>初始化接口状态，当接口UP时，或者某些配置变更时会有的状态</td>
</tr>
<tr>
<td>Learn</td>
<td>接口未设定虚拟IP（但激活了HSRP，用standby ip），等待从Active路由器学习到该组的虚拟IP</td>
</tr>
<tr>
<td>Listen</td>
<td>路由器已经获知虚拟IP，开始侦听其他同组HSRP路由器的HELLO消息</td>
</tr>
<tr>
<td>Speak</td>
<td>发送周期性的Hello消息同时参与Active/Standby选举</td>
</tr>
<tr>
<td>Standby</td>
<td>成为Standby路由器，同时周期性的发送Hello，持续侦听Active路由器的Hello消息，以便在其失效后接替位置</td>
</tr>
<tr>
<td>Active</td>
<td>成为Active路由器，响应PC对于虚拟IP的ARP请求，同时周期性发送Hello消息，宣告自己的存货状态。</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">(config-if)<span class="comment"># standby 1 preempt		#打开抢占</span></span><br><span class="line">(config-if)<span class="comment"># standby 1 priority 110	#调高优先级</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">@有一种情形</span><br><span class="line">@R2的上游支路shutdown了，但是因为R2的优先级比R3大，R4发包还是选择R2，但是却不能ping通R4</span><br><span class="line">---</span><br><span class="line">@如果R2上面的接口shutdown，则把R2的优先级降低20，这样Standby就被R3抢走</span><br><span class="line">(config)<span class="comment"># track 1 interface e0/0 line-protocol		#在接口的协议上设置一个追踪 </span></span><br><span class="line">(config)<span class="comment"># int e0/1							</span></span><br><span class="line">(config-if)<span class="comment"># standby 1 track 1 decrement 20			#如果接口shutdown，则将优先级-20，会在show standby上显示详细条目</span></span><br></pre></td></tr></table></figure>







<h2 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h2><p>VRRP和HSRP不一样的地方</p>
<ul>
<li>在Cisco上抢占模式不一样，VRRP默认开启</li>
<li>MAC地址不一样，就是开头的固定格式不一样</li>
<li>Hello包发送的周期不一样，HSRP是3s-10s，而VRRP 1s一个Hello包，3s收不到就挂了</li>
<li>激活的状态不一样，一个是backup，一个是active，其他地方一样</li>
</ul>
<h2 id="GLBP"><a href="#GLBP" class="headerlink" title="GLBP"></a>GLBP</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/switch_19.png" alt="image-20200210175204079"></p>
<p>AVG生成一堆虚拟的mac地址分发给局域网里面的路由器（假设有路由器A、B、C），此时有PC1来请求mac地址上网(这个mac地址是默认网关的mac，不是pc自己的mac)，AVG会挑选一台路由器B给它，又有PC2来请求上网，AVG挑选路由器C给它，又有PC3，路由器把A给它。如果路由器B坏了，则重新分配给其他路由器，如果AVG坏了，则路由器重新选举新的AVG。IP地址大则为AVG</p>
<p>所以GLBP抢占的是AVG，而其他的则是抢占干活的机会。</p>
<p>GLBP、VRRP、HSRP配置命令都差不多。</p>

            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/27/Switch%E4%BA%A4%E6%8D%A2%E6%9C%BA/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/27/Switch%E4%BA%A4%E6%8D%A2%E6%9C%BA/" title="Switch交换机">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/24/Ansible/">
    		Ansible
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-24T06:00:36.000Z">2020-02-24</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>休言万事转头空。未转头时皆梦。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/24/Ansible/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/24/Ansible/" title="Ansible">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/4.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/23/OSPF%E5%8D%8F%E8%AE%AE/">
    		OSPF协议
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-23T07:00:39.000Z">2020-02-23</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="OSPF"><a href="#OSPF" class="headerlink" title="OSPF"></a>OSPF</h1><p><strong>距离矢量路由协议</strong></p>
<p>​    路由器相互之间只更新路由表信息，并且逐条更新，依照传闻的更新，任何一台路由器对路由表的更改，都将直接影响到下游。</p>
<p><strong>链路状态路由协议</strong></p>
<p>​    每台路由器都选择一个IP地址作为自己的名字，（Router-ID）</p>
<p>​    将自己的每个接口的网络信息，带宽信息进行描述，做成链路状态信息</p>
<p>​    将Router-ID和链路状态一起发送给自己的邻居，并且也帮助其他设备转发</p>
<p>​    最终会得到全网所有路由器的链路状态信息，通过分析可以得到全网拓扑图</p>
<p>​    使用最短路径算法（SPF），得到去往每个目的地的最短路线，得到路由表</p>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><ul>
<li>ospf在Cisco设备中的管理距离为120</li>
<li>不使用传输层的TCP/UDP进行数据封装，更新消息直接放在网络层后，协议号为89</li>
<li>OSPF使用触发更新的机制，和邻居共享链路状态信息，而不是共享路由信息</li>
<li>OSPF有邻居的概念，使用Hello消息来建立和维护邻居，在以太网中，10s更新一次，40s没收到就判定邻居失效。</li>
<li>OSPF建立邻居有7个状态</li>
<li>OSPF使用<code>224.0.0.5</code>和<code>224.0.0.6</code>来更新LSA(链路状态通告)</li>
<li>ospf宣告的环回口不管子网掩码是多少，传播的时候都时32位</li>
</ul>
<p>名词介绍</p>
<ol>
<li><p>Router-ID：相当于路由器的名字，因为需要靠Router-ID去辨识每个节点，所以在一个网络中不允许出现Router-ID一样。Router-ID会以稳定性作为第一要素。</p>
<blockquote>
<p>1、Router-ID会优先选择路由器LoopBack接口的IP地址，如果有多个选择数值，选择最大的。</p>
<p>2、Router-ID在没有LoopBack的情况下，会选择物理接口IP数值最大的，注意：这个接口必须要是UP状态</p>
<p>3、Router-ID允许手动指定，但往往不能即使生效，除非重启，不然还是稳定保持不变</p>
</blockquote>
</li>
<li><p>区域：Area，由于每台路由器都有全网的拓扑，如果这个网络比较庞大，那么任何一个网段的变化，都会导致OSPF路由器中链路状态数据库的数据发生变化，从而触发路由器对所有的目的地最佳路线进行重算。为了节约资源和加快路由器运行速度，所以OSPF可以进行区域划分，每台路由器只需要计算本区域的拓扑。对于其他区域的网段，只需要知道怎么离开本区域就行了。</p>
</li>
<li><p>OSPF有两种区域，一种是骨干区域，区域号为0，这个是固定的，只要是骨干区域，区域号必须是0，还有一种是非骨干区域，非骨干区域的区域号除了0都可以。非骨干区域必须和骨干区域相连，在正常情况下，所有的区域都可以学习到全网所有的路由条目，在人为优化的情况下，可以让非骨干区域只学习到本区域的路由，去其他区域从默认路由走，从而精简路由表。</p>
</li>
</ol>
<h1 id="邻居建立过程"><a href="#邻居建立过程" class="headerlink" title="邻居建立过程"></a>邻居建立过程</h1><ol>
<li>down</li>
</ol>
<blockquote>
<p>表示OSPF启动了，由于某些原因，还没开始发送Hello</p>
</blockquote>
<ol start="2">
<li>init</li>
</ol>
<blockquote>
<p>表示收到了对方发给我的Hello消息，但是没有在对方的Hello消息中，看的自己的Router-ID</p>
</blockquote>
<ol start="3">
<li>2-way</li>
</ol>
<blockquote>
<p>在收到对方发给我的Router-ID中发现了自己的Router-ID</p>
<p>开始选举谁做指定路由器DR</p>
</blockquote>
<ol start="4">
<li>exstart（预开始）</li>
</ol>
<blockquote>
<p>开始选举谁来主导这个链路状态信息交换的过程，选举（Slave，Master） </p>
<p>注意，此阶段互相传递的消息格式是链路状态数据库摘要（但是内容为空）。 </p>
</blockquote>
<ol start="5">
<li>exchange（预交换）</li>
</ol>
<blockquote>
<p>由Slave发送自己的链路状态数据的摘要给Master，由Master确认之后再将Slave需要的链路状态信息发回去</p>
</blockquote>
<ol start="6">
<li>loading</li>
</ol>
<blockquote>
<p>开始发送链路状态请求，然后接收对方发送的完整链路状态信息</p>
</blockquote>
<ol start="7">
<li>Full</li>
</ol>
<blockquote>
<p>完成当前阶段的链路状态数据库同步，之后只需要维持邻居关系和触发更新 </p>
</blockquote>
<p><img src="https://i.loli.net/2020/03/22/heNsJbzAd9TFCSZ.png" alt="1.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Neighbor ID     Pri   State           Dead Time   Address         Interface</span><br><span class="line">3.3.3.3           1   FULL/DR         00:00:37    192.168.23.3    Ethernet0/0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Neighbor_ID:  	邻居表里记录了邻居的Router-ID</span><br><span class="line">Pri: 			选举DR和BDR的用的优先级，默认是1</span><br><span class="line">State:			邻居建立过程中的状态和角色 [down,init,2-way,exstart,exchange,loading,full | DR,BDR,DRother]</span><br><span class="line">Dead_Time: 		邻居的死亡计时40s，每当收到邻居hello包的时候，就重置，计时到0，就删除邻居</span><br><span class="line">Address:  		建立邻居的IP</span><br><span class="line">Interface: 		建立邻居的接口</span><br></pre></td></tr></table></figure>







<h1 id="DR和BDR"><a href="#DR和BDR" class="headerlink" title="DR和BDR"></a>DR和BDR</h1><p><code>show ip ospf interface e0/0</code></p>
<p>查看OSPF接口信息，这个信息是和OSPF有关的</p>
<ol>
<li>在多路访问的网络（交换机所在网络）里，OSPF建立邻居关系，导致最终邻居关系较复杂，更新消息重复而多于，所以在MA网络中，选举一个路由器作为指定路由器（DR），在非DR中，再选一个BDR作为备份。当任何的更新来临时，会先发送给DB和BDR，再由DR发送给所有的DRother路由器</li>
<li>选取DR和BDR的时候，先看优先级，越大越优，如果是0，就不参与DR和BDR选举。如果优先级一样，就看Router-ID谁大，谁大谁就是DR，不过必须在第一台设备启动后的40s内选举，超出这个时间，就不可以抢占DR和BDR。</li>
<li>DR和BDR在监听224.0.0.5和224.0.0.6这个地址，DRother只监听224.0.0.5这个地址，当需要更新的时候，DRother会向224.0.0.6去更新，DR会向224.0.0.5去更新消息</li>
<li>为了让ospf网络快速收敛，可以考虑在合适的接口上配置p2p网络类型，让ospf邻居不进行40s等待</li>
</ol>
<h1 id="信息查看"><a href="#信息查看" class="headerlink" title="信息查看"></a>信息查看</h1><p><img src="https://i.loli.net/2020/03/22/iYBgL917R6kHUzy.png" alt="2.png"></p>
<h2 id="路由器配置"><a href="#路由器配置" class="headerlink" title="路由器配置"></a>路由器配置</h2><ul>
<li>R1</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R1</span><br><span class="line">int lo0</span><br><span class="line">ip add 1.1.1.1 255.255.255.255</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.13.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<ul>
<li>R2</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R2</span><br><span class="line">int lo0</span><br><span class="line">ip add 2.2.2.2 255.255.255.255</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.23.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<ul>
<li>R3</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R3</span><br><span class="line">int lo0</span><br><span class="line">ip add 3.3.3.3 255.255.255.255</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.13.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.23.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.34.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/1 -2</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<ul>
<li>R4</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R4</span><br><span class="line">int lo0</span><br><span class="line">ip add 4.4.4.4 255.255.255.255</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.34.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.45.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 -1 , lo0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<ul>
<li>R5</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R5</span><br><span class="line">int lo0</span><br><span class="line">ip add 5.5.5.5 255.255.255.255</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.45.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.56.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/1 , lo0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int range e0/0 </span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">end</span><br></pre></td></tr></table></figure>



<ul>
<li>R6</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo </span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br><span class="line">ho R6</span><br><span class="line">int lo0 </span><br><span class="line">ip add 6.6.6.6 255.255.255.255 </span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.56.6 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">int range e0/0 , lo0</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">end</span><br></pre></td></tr></table></figure>





<h2 id="当前路由器角色"><a href="#当前路由器角色" class="headerlink" title="当前路由器角色"></a>当前路由器角色</h2><ul>
<li>查看当前路由器的角色，此时R3是ABR(Area Border Router)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ show ip protocals</span><br><span class="line">Routing Protocol is <span class="string">"ospf 1"</span></span><br><span class="line">  Router ID 3.3.3.3							<span class="comment">#Router_ID</span></span><br><span class="line">  It is an area border router				<span class="comment">#ABR</span></span><br><span class="line">  Number of areas <span class="keyword">in</span> this router is 2. 2 normal 0 stub 0 nssa	</span><br><span class="line">  Maximum path: 4							<span class="comment">#最大负载均衡路径</span></span><br></pre></td></tr></table></figure>



<h2 id="DR-BDR"><a href="#DR-BDR" class="headerlink" title="DR/BDR"></a>DR/BDR</h2><ul>
<li>查看当前网络信息，包括DR，BDR，R1的e0/0接口信息</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip ospf int e0/0</span></span><br><span class="line">Ethernet0/0 is up, line protocol is up </span><br><span class="line">  Internet Address 192.168.13.1/24, Area 1, Attached via Interface Enable</span><br><span class="line">  									[区域为aera 1]</span><br><span class="line">  Process ID 1, Router ID 1.1.1.1, Network Type BROADCAST, Cost: 10</span><br><span class="line">  									[网络类型：Broadcast]</span><br><span class="line">  [传输延迟1s]                [状态BDR]   [优先级1]</span><br><span class="line">  $ Transmit Delay is 1 sec, State BDR, Priority 1</span><br><span class="line">  [DR路由器的RouterID]                [接口地址]</span><br><span class="line">  $ Designated Router (ID) 3.3.3.3, Interface address 192.168.13.3</span><br><span class="line">  [BDR路由器的RouterID]			            [接口地址]</span><br><span class="line">  $ Backup Designated router (ID) 1.1.1.1, Interface address 192.168.13.1</span><br><span class="line">  [时间间隔]                     $			$		$			$</span><br><span class="line">  Timer intervals configured, Hello 10, Dead 40, Wait 40, Retransmit 5</span><br><span class="line">    oob-resync timeout 40</span><br><span class="line">    Hello due <span class="keyword">in</span> 00:00:05	<span class="comment">#下一次发送Hello包是什么时候</span></span><br><span class="line">  Neighbor Count is 1, Adjacent neighbor count is 1 </span><br><span class="line">    Adjacent with neighbor 3.3.3.3  (Designated Router)</span><br></pre></td></tr></table></figure>



<h2 id="P2P网络"><a href="#P2P网络" class="headerlink" title="P2P网络"></a>P2P网络</h2><ul>
<li>使用point-to-point网络连接R5和R6，在P2P网络内，不选DR和BDR。默认网络为Broadcast。P2P网络可以不用发组播，就能建立邻居。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R5(R6同理):</span><br><span class="line">int e0/0</span><br><span class="line">ip ospf network point-to-point</span><br></pre></td></tr></table></figure>



<p>但是，只有没有多路访问的网络(网络不存在交换机)方便使用p2p连接，不然就会出现三个路由器两两交替抢占邻居的现象，即一会收到A的Hello包，和A建立邻居，一会收到B的Hello包，和B建立邻居，等到A的Hello包再来，因为P2P网络只能点对点，所以又只好断掉B的邻居和A建立邻居，循环往复。</p>
<h1 id="链路数据"><a href="#链路数据" class="headerlink" title="链路数据"></a>链路数据</h1><h2 id="数据库字段"><a href="#数据库字段" class="headerlink" title="数据库字段"></a>数据库字段</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看</span></span><br><span class="line">show ip ospf database</span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2020/03/22/2qpPs4ZbSCwVu59.png" alt="3.png"></p>
<p>字段解释：</p>
<ul>
<li>Link ID：(link state id),链路ID </li>
<li>ADV Router：(advertising router)发送LSA的路由器</li>
<li>Age ：正计时，寿命1h，OSPF有周期性更新的行为，周期为30min，每到30min，数据库进行泛洪，将所有数据全部发出，刷新Age</li>
<li>Seq：序列号 ，十六进制，序列号有新的就用新的，OSPF认为0x80000000是错误的，会先更新，然后删除。类似RIP中的16跳。</li>
<li>Checksum ：校验，MTU分组发送的时候需要校验</li>
<li>Link count：链路条数</li>
</ul>
<h2 id="LSA和多区域"><a href="#LSA和多区域" class="headerlink" title="LSA和多区域"></a>LSA和多区域</h2><ul>
<li>LSA（Link-State Advertisement ） ，链路状态通告：链路状态通告，里面包含了路由器的ID和链路状态相关的IP地址，带宽等信息。目前在OSPF内，一共有11中LSA</li>
<li>LSU（Link-State Advertisement）， 链路状态更新：链路状态更新，更新里面含有LSA</li>
<li>LSDB（Link-State Database）， 链路状态数据库：数据库中会记录每个LSA更新的路由器ID，会记录序列号，序列号用16进制表示。数据库每个LSA一个计时器，这个计时器是LSA老化时间，正常情况下1h就会然这条LSA失效，但OSPF每隔30min泛洪会更新一次LSA。</li>
</ul>
<h3 id="stub"><a href="#stub" class="headerlink" title="stub"></a>stub</h3><ul>
<li>Stub（末梢区域）：OSPF如果不想让非骨干区域学习到OSPF_AS外的条目，达到精简路由表的目的，可以在ABR上对末梢区域进行 <em>area 1  stub</em> 配置，这样ABR就不会向那个区域发送AS外的条目，还会产生一条 <em>0.0.0.0/0</em> 的路由，保障没有路由的情况下，这个区域也可以访问外界。本区域的所有路由器你都别忘了配置Stub，不然邻居关系无法建立。该区域不存在4、5类LSA。</li>
</ul>
<h3 id="stub-no-summary"><a href="#stub-no-summary" class="headerlink" title="stub no-summary"></a>stub no-summary</h3><ul>
<li>Stub no-summary：如果做到极致精简，可以让末梢区域连OSPF其他区域路由也不学习，可以在ABR上对末梢区域进行 <em>area 1 stub no-summary<em>。</em>no-summary</em> 只需要在ABR上加。<em>Stub no-summary</em> 也被称为完全末梢区域。该区域不存在4、5类LSA，以及除了ABR默认路由三类LSA以外的3类</li>
</ul>
<h3 id="nssa"><a href="#nssa" class="headerlink" title="nssa"></a>nssa</h3><ul>
<li>NSSA<em>（not so stub area）<em>：次末梢区域。由于Stub区域无法存在4、5类LSA，所以stub区域无法引入外部路由，如果使用NSSA区域来做末梢，就看可以引入外部路由条目，不过是以7类LSA的方式进入，并且会在NSSA区域边界路由器上被转为5类。</em>area 1 nssa</em>  默认情况下，NSSA不会像非骨干区域注入一条默认路由，不过可以手动注入一条默认路由的7类LSA：<em>area 1 nssa default-infor orig</em></li>
</ul>
<h3 id="T-nssa"><a href="#T-nssa" class="headerlink" title="T-nssa"></a>T-nssa</h3><ul>
<li>T-NSSA <em>（total-not so stub area）<em>完全次末梢区域，除了可以存在7类LSA引入外部路由以外，其他功能和stub no-summary一致。</em>area 1 nssa no-summary</em></li>
</ul>
<p>总结：·</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">`area 1 stub`  area1是末梢区域</span><br><span class="line"></span><br><span class="line">`area 1 stub no-summary` area1是完全末梢区域</span><br><span class="line"></span><br><span class="line">`area 1 nssa` area1是次末梢区域</span><br><span class="line"></span><br><span class="line">`area 1 nssa default-infor-origin` area1是次末梢区域，并且通告默认路由</span><br><span class="line"></span><br><span class="line">`area 1 nssa no-summary` area1完全次末梢区域</span><br></pre></td></tr></table></figure>









<h2 id="OSPF-Codes"><a href="#OSPF-Codes" class="headerlink" title="OSPF Codes"></a>OSPF Codes</h2><table>
<thead>
<tr>
<th>标识</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>O</td>
<td>区域内的路由</td>
</tr>
<tr>
<td>O IA</td>
<td>不同区域之间的路由</td>
</tr>
<tr>
<td>OE1</td>
<td>区域外的路由(不是OSPF协议的路由)，会累加METRIC值（默认20）</td>
</tr>
<tr>
<td>OE2</td>
<td>区域外的路由(不是OSPF协议的路由)，不累加METRIC值（默认20），由外部重分布进来默认使用OE2。</td>
</tr>
<tr>
<td>ON1</td>
<td>区域外的路由，由NSSA的ASBR重发布进来的，会累加Metric值</td>
</tr>
<tr>
<td>ON2</td>
<td>区域外路由，由NSSA的ASBR重发布进来的。NSSA区域中的路由器没有LSA-5，用LSA7算出的external路由，就标记为ON1/2</td>
</tr>
</tbody></table>
<h2 id="十一种LSA"><a href="#十一种LSA" class="headerlink" title="十一种LSA"></a>十一种LSA</h2><p>OSPF路由器会发送LSA通告，如果路由器太多，收到的通告就会很多，在进行SPF算法的时候，网络拓扑图太大，计算复杂，而且每当网络状态更新，都需要重复这样一次计算，计算量庞大。</p>
<ul>
<li>收到的LSA通告太多了，OSPF路由器的负担很</li>
<li>内部动荡会引起全网路由器的完全SPF计算</li>
<li>资源消耗过多，LSDB庞大，设备性能下降，影响数据转发</li>
<li>每台路由器都需要维护的路由表越来越大，单区域内路由无法汇总</li>
</ul>
<table>
<thead>
<tr>
<th>LSA类型代码</th>
<th><strong>描述</strong></th>
</tr>
</thead>
<tbody><tr>
<td><strong>1</strong></td>
<td>路由器LSA，本地路由器产生，用于描述自身的链路信息，如接口、带宽、ip地址</td>
</tr>
<tr>
<td><strong>2</strong></td>
<td>网络LSA，由DR产生，用于向全网告知自己所在的局域网信息 。</td>
</tr>
<tr>
<td><strong>3</strong></td>
<td>网络汇总LSA，ABR产生，将其他区域的路由条目转发到本区域，会丢失拓扑信息</td>
</tr>
<tr>
<td><strong>4</strong></td>
<td>ASBR汇总LSA，ASBR产生，告知本区域路由如何离开自治系统</td>
</tr>
<tr>
<td><strong>5</strong></td>
<td>AS外部LSA，ASBR产生，告知本区域路由器外面的路由条目</td>
</tr>
<tr>
<td>6</td>
<td>组成员LSA</td>
</tr>
<tr>
<td><strong>7</strong></td>
<td>NSSA外部LSA，nssa区域路由器重发布外界路由产生，导入其他区域会被ABR修改为5类LSA</td>
</tr>
<tr>
<td>8</td>
<td>外部属性LSA</td>
</tr>
<tr>
<td>9</td>
<td>Opaque LSA （链路本地范围）</td>
</tr>
<tr>
<td>10</td>
<td>Opaque LSA （本地区域范围）</td>
</tr>
<tr>
<td>11</td>
<td>Opaque LSA （AS范围）</td>
</tr>
</tbody></table>
<h2 id="1"><a href="#1" class="headerlink" title="1"></a>1</h2><p>1类LSA — 路由器LSA，每台路由器都会产生，用于描述自身的接口状态。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">$ sh ip ospf database</span><br><span class="line"></span><br><span class="line">			Router Link States (Area 1)</span><br><span class="line">Link ID         ADV Router      Age         Seq<span class="comment">#       Checksum Link count</span></span><br><span class="line">1.1.1.1         1.1.1.1         1678        0x80000006 0x00997D 2</span><br><span class="line">2.2.2.2         2.2.2.2         1621        0x80000007 0x00559F 2</span><br><span class="line">3.3.3.3         3.3.3.3         1724        0x80000009 0x009362 2</span><br><span class="line"></span><br><span class="line">			路由链路状态表（区域1）</span><br><span class="line">连接的ID，从哪个路由器学到的，寿命，序列号，校验位，链路数</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看详细信息</span></span><br><span class="line">$ sh ip ospf database router 1.1.1.1</span><br></pre></td></tr></table></figure>





<h2 id="2"><a href="#2" class="headerlink" title="2"></a>2</h2><p>2类LSA  ：网络LSA，由DR产生，用于向全网告知自己所在的局域网信息 。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip ospf database network 192.168.13.3</span></span><br><span class="line">            OSPF Router with ID (1.1.1.1) (Process ID 1)</span><br><span class="line">		Net Link States (Area 1)</span><br><span class="line"><span class="comment">#头部信息</span></span><br><span class="line">  Routing Bit Set on this LSA <span class="keyword">in</span> topology Base with MTID 0</span><br><span class="line">  LS age: 56</span><br><span class="line">  Options: (No TOS-capability, DC)</span><br><span class="line">  LS Type: Network Links</span><br><span class="line">  Link State ID: 192.168.13.3 (address of Designated Router)</span><br><span class="line">  Advertising Router: 3.3.3.3</span><br><span class="line">  LS Seq Number: 80000001</span><br><span class="line">  Checksum: 0x7E26</span><br><span class="line">  Length: 32</span><br><span class="line">  Network Mask: /24</span><br><span class="line"><span class="comment">#当前区域内的路由器  </span></span><br><span class="line">	Attached Router: 3.3.3.3</span><br><span class="line">	Attached Router: 1.1.1.1</span><br></pre></td></tr></table></figure>



<h2 id="3"><a href="#3" class="headerlink" title="3"></a>3</h2><p>3类LSA  —路由器汇总LSA，由ABR（区域边界路由器）产生，用来将其他区域的路由进行汇总，然后转发到本区域。ARB传递的是路由表类似的LSA，会丢失掉拓扑信息，所以区域之间是无法得知拓扑。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">R6<span class="comment">#sh ip ospf database summary 3.3.3.3</span></span><br></pre></td></tr></table></figure>



<h2 id="4"><a href="#4" class="headerlink" title="4"></a>4</h2><p>4类LSA，ASBR汇总LSA，Link state ASBR，由ABR产生，用来告知本区域的路由器如何离开本OSPF自治系统</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#注入外部路由，并形成一条默认路由</span></span><br><span class="line">int e0/2</span><br><span class="line">ip add dhcp</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">router ospf 1</span><br><span class="line">default-information originate always</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">四类LSA：				Summary ASB Link States (Area 1)</span><br><span class="line">R1<span class="comment">#sh ip ospf database asbr-summary 4.4.4.4</span></span><br></pre></td></tr></table></figure>



<h2 id="5"><a href="#5" class="headerlink" title="5"></a>5</h2><p>5类LSA，由ASBR产生，用来告知本区域的路由器外面的条目</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">5类LSA：					Type-5 AS External Link States</span><br><span class="line"></span><br><span class="line">R1<span class="comment">#sh ip ospf database external </span></span><br><span class="line">            OSPF Router with ID (1.1.1.1) (Process ID 1)</span><br><span class="line">				Type-5 AS External Link States</span><br><span class="line">  Routing Bit Set on this LSA <span class="keyword">in</span> topology Base with MTID 0</span><br><span class="line">  LS age: 212</span><br><span class="line">  Options: (No TOS-capability, DC, Upward)</span><br><span class="line">  LS Type: AS External Link</span><br><span class="line">  Link State ID: 0.0.0.0 (External Network Number )</span><br><span class="line">  Advertising Router: 4.4.4.4</span><br><span class="line">  LS Seq Number: 80000001</span><br><span class="line">  Checksum: 0xFAEC</span><br><span class="line">  Length: 36</span><br><span class="line">  Network Mask: /0</span><br><span class="line">	Metric Type: 2 (Larger than any link state path)</span><br><span class="line">	MTID: 0 </span><br><span class="line">	Metric: 10 </span><br><span class="line">	Forward Address: 192.168.70.2</span><br><span class="line">	External Route Tag: 1</span><br></pre></td></tr></table></figure>





<h2 id="7"><a href="#7" class="headerlink" title="7"></a>7</h2><p>用于在NSSA区域表示外界路由，由NSSA区域的边界路由产生，发布到其他区域时，会被ABR转换为5类的LSA。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 需要在路由器上都配好	</span></span><br><span class="line">router ospf 1</span><br><span class="line">area 1 nssa </span><br><span class="line"></span><br><span class="line"><span class="comment">#在R1上引入外部路由，也就是NSSA区域的路由器上引入外部路由</span></span><br><span class="line">ip route 11.11.11.11 255.255.255.255 null0</span><br><span class="line">router ospf 1 </span><br><span class="line">re st su</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">R2的链路状态数据库中，11.11.11.11是7类LSA</span><br><span class="line">			Type-7 AS External Link States (Area 1)</span><br><span class="line"></span><br><span class="line">Link ID         ADV Router      Age         Seq<span class="comment">#       Checksum Tag</span></span><br><span class="line">11.11.11.11     1.1.1.1         123         0x80000001 0x006BF6 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在NSSA边界路由器，11.11.11.11被转换为了5类LSA</span><br><span class="line">R5的链路状态数据库</span><br><span class="line">			Type-5 AS External Link States</span><br><span class="line">Link ID         ADV Router      Age         Seq<span class="comment">#       Checksum Tag</span></span><br><span class="line">0.0.0.0         4.4.4.4         343         0x80000002 0x00F8ED 1</span><br><span class="line">11.11.11.11     3.3.3.3         323         0x80000001 0x00C3A0 0</span><br></pre></td></tr></table></figure>



<p>有五类LSA但没有四类的LSA一定是因为存在NSSA区域导致的。</p>
<h1 id="路由汇总"><a href="#路由汇总" class="headerlink" title="路由汇总"></a>路由汇总</h1><p>由于OSPF不传递路由表信息，而是直接发送LSA信息，所以在一个区域内，所有路由器都有本区域的拓扑，所以在单个区域内无法完成路由汇总。</p>
<p>在OSPF中，汇总只能发生在ABR和ASBR上，这两种路由器转发的路由表的LSA信息。而其他路由器是转发拓扑信息</p>
<p><img src="https://i.loli.net/2020/03/22/iYBgL917R6kHUzy.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">在R4添加</span><br><span class="line">int lo10</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo20</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo30</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">router ospf 1</span><br><span class="line">redistribute connected subnets </span><br><span class="line"><span class="comment"># 可以观察到R1、R3、R4等路由器都受到了路由条目明细，现在在ASBR上对路由做汇总</span></span><br><span class="line"><span class="comment"># 这里要注意，不能再ABR(R3)上对OSPF_as以外的路由进行汇总</span></span><br><span class="line">summary-address 172.16.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>



<h1 id="注入默认路由"><a href="#注入默认路由" class="headerlink" title="注入默认路由"></a>注入默认路由</h1><p>在Stub网络里，注入默认路由无效，但是可以在NSSA网络注入。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">router ospf 1</span><br><span class="line">default-information originate</span><br><span class="line"><span class="comment">#这条命令用来产生一条五类的LSA，包含的是缺省路由信息。其它路由器收到这条LSA后，会计算出缺省路由0.0.0.0/0。</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#命令生效的条件是该路由器上存在缺省路由。如果没有，而且仍然想发布这种LSA，要在命令后面加always，即</span></span><br><span class="line">default-information originate always</span><br></pre></td></tr></table></figure>






<p><img src="https://i.loli.net/2020/03/22/cZGTFBflSUjxnzp.png" alt="5.png"></p>
<h1 id="构造虚链路"><a href="#构造虚链路" class="headerlink" title="构造虚链路"></a>构造虚链路</h1><p>OSPF路由器要成为ABR的条件，除了要同时连接多个区域，必须满足有一个接口连接area 0。</p>
<p>虚链路会导致故障变得复杂，线路变得不稳定，所以一般是个临时解决方案，一个全新设计的网络架构里面虚链路是不合理的。</p>
<p><code>virtual-link</code>是ospf自带的虚链路解决方式，这种方式存在诸多问题，比如通过虚链路学习的LSA是DNA，含有DNA（do not age）的时间不会改变，这样会导致错误的LSA信息得不到更新，甚至虚链路邻居关系都不需要Hello包来维持。</p>
<p>R2：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">router ospf 1</span><br><span class="line">area 1 virtual-link 3.3.3.3</span><br><span class="line">area 1 virtual-link 4.4.4.4</span><br></pre></td></tr></table></figure>

<p>R3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">router ospf 1</span><br><span class="line">area 1 virtual-link 2.2.2.2</span><br></pre></td></tr></table></figure>

<p>这时候，R3和R2建立了两个邻居关系，其中一个接口用的是<code>OSPF_VL0</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看虚链路</span></span><br><span class="line">show ip ospf virtual-links</span><br></pre></td></tr></table></figure>







<h1 id="HAMC"><a href="#HAMC" class="headerlink" title="HAMC"></a>HAMC</h1><p>只提供完整性和可用性，不提供机密性。OSPF分为接口和区域认证，但都是明文加密的</p>
<p>认证和RIP&amp;EIGRP类似。</p>
<h1 id="OSPF小练习"><a href="#OSPF小练习" class="headerlink" title="OSPF小练习"></a>OSPF小练习</h1><p><img src="https://i.loli.net/2020/03/22/pI9mKMXFxb8fqyg.png" alt="6.png"></p>
<p><img src="https://i.loli.net/2020/03/22/w4eh1xZJrXyEDTU.png" alt="7.png"></p>
<h2 id="区域配置"><a href="#区域配置" class="headerlink" title="区域配置"></a>区域配置</h2><p>R{1~4} ： <code>area 0</code></p>
<p>R{3-5} , R{4-6} ：<code>area 1</code></p>
<p>R{3,4}的环回口：<code>area 0</code></p>
<p>R{5,6}的环回口：<code>area 1</code></p>
<p>R{5,6,7}：<code>area 2</code></p>
<p>优化命令</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">en</span><br><span class="line">conf t</span><br><span class="line">no ip <span class="keyword">do</span> lo</span><br><span class="line">line con 0</span><br><span class="line">no <span class="built_in">exec</span>-t</span><br><span class="line">logg syn</span><br></pre></td></tr></table></figure>

<p>R1</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R1</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.12.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.23.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.1 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0 </span><br><span class="line">ip add 1.1.1.1 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>



<p>R2</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R2</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.12.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.24.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.2 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0 </span><br><span class="line">ip add 2.2.2.2 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>



<p>R3</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R3</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.13.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.35.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.3 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0 </span><br><span class="line">ip add 3.3.3.3 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>





<p>R4</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">ho R4</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.24.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0 </span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.46.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/2</span><br><span class="line">ip add 192.168.184.4 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line">int lo0</span><br><span class="line">ip add 4.4.4.4 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>





<p>R5</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ho R5</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.35.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.57.5 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int lo0</span><br><span class="line">ip add 5.5.5.5 255.255.255.0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>





<p>R6</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ho R6</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.46.6 255.255.255.0</span><br><span class="line">no sh </span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">int e0/1 </span><br><span class="line">ip add 192.168.67.6 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int lo0</span><br><span class="line">ip add 6.6.6.6 255.255.255.0</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>



<p>R7</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ho R7</span><br><span class="line">int e0/0</span><br><span class="line">ip add 192.168.57.7 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int e0/1</span><br><span class="line">ip add 192.168.67.7 255.255.255.0</span><br><span class="line">no sh</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line">int lo0</span><br><span class="line">ip add 7.7.7.7 255.255.255.0</span><br><span class="line">ip ospf 1 area 2</span><br><span class="line"><span class="keyword">do</span> sh ip int bri</span><br></pre></td></tr></table></figure>

<p><img src="https://i.loli.net/2020/03/22/cI5aEsBDy9lOWHF.png" alt="8.png"></p>
<p>目前来说，R1的<code>1.1.1.1</code>是<code>ping</code>不通R7的<code>7.7.7.7</code>的，因为R5和R6构不成边界路由器ABR。所以需要在R3-R5，R4-R6之间构建VPN隧道。</p>
<h2 id="配置隧道"><a href="#配置隧道" class="headerlink" title="配置隧道"></a>配置隧道</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">R3</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.35.3 </span><br><span class="line">tu de 192.168.35.5</span><br><span class="line">ip add 172.16.35.3 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R5:</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.35.5 </span><br><span class="line">tu de 192.168.35.3</span><br><span class="line">ip add 172.16.35.5 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"></span><br><span class="line">R4</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.46.4 </span><br><span class="line">tu de 192.168.46.6</span><br><span class="line">ip add 172.16.46.4 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br><span class="line"></span><br><span class="line">R6</span><br><span class="line">int tun 0</span><br><span class="line">tu so 192.168.46.6 </span><br><span class="line">tu de 192.168.46.4</span><br><span class="line">ip add 172.16.46.6 255.255.255.0</span><br><span class="line">ip ospf 1 area 0</span><br></pre></td></tr></table></figure>



<p>当虚通道建立好的时候，就可以用R1<code>ping</code>通R7了。</p>
<p><strong>R1、R2在R{1~4}的区域中分别为DR和BDR</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R1:</span><br><span class="line">int e0/2</span><br><span class="line">ip ospf priority 100</span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">int e0/2</span><br><span class="line">ip ospf priority 90</span><br><span class="line"></span><br><span class="line">之后使用<span class="keyword">do</span> clear ip ospf process 重置ospf 的进程</span><br></pre></td></tr></table></figure>





<p><strong>其余的链路使用P2P网络</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">R1:</span><br><span class="line">int range e0/0 -2</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R3:</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line">R4:</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line">R5</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R6</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br><span class="line"></span><br><span class="line">R7</span><br><span class="line">int range e0/0 -1</span><br><span class="line">ip ospf net point-to-point</span><br></pre></td></tr></table></figure>

<h2 id="默认路由注入"><a href="#默认路由注入" class="headerlink" title="默认路由注入"></a>默认路由注入</h2><p><strong>4、R1,R2缺省路由</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">R1:</span><br><span class="line">interface Loopback1</span><br><span class="line"> ip address 100.1.1.1 255.255.255.0</span><br><span class="line"> ip ospf 1 area 0</span><br><span class="line">router ospf 1</span><br><span class="line"> default-information originate always</span><br><span class="line"> </span><br><span class="line"> </span><br><span class="line">R2:</span><br><span class="line">interface Loopback1</span><br><span class="line"> ip address 100.1.1.1 255.255.255.0</span><br><span class="line"> ip ospf 1 area 0</span><br><span class="line">router ospf 1 </span><br><span class="line">default-information originate always metric 10</span><br></pre></td></tr></table></figure>

<p>metrci - 度量值，越小越优</p>
<h2 id="特殊区域"><a href="#特殊区域" class="headerlink" title="特殊区域"></a>特殊区域</h2><p><strong>5、area 2为特殊区域</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">R5:</span><br><span class="line">router ospf 1</span><br><span class="line">area 2 nssa no-summary</span><br><span class="line"></span><br><span class="line">R6:</span><br><span class="line">router ospf 1</span><br><span class="line">area 2 nssa no-summary</span><br><span class="line"></span><br><span class="line">R7</span><br><span class="line">router ospf 1</span><br><span class="line">redistribute connected subnets</span><br><span class="line">area 2 nssa</span><br></pre></td></tr></table></figure>



<div style="text-align:center;color:red"> ! ! ! OSPF 5类LSA比7类LSA更优先</div>
没有开启nssa之前的路由表：

<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">O*E2  0.0.0.0/0 [110/10] via 172.16.46.4, 00:08:22, Tunnel0</span><br><span class="line">      1.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        1.1.1.1 [110/1011] via 172.16.46.4, 00:01:58, Tunnel0</span><br><span class="line">      2.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        2.2.2.2 [110/1011] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">      3.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        3.3.3.3 [110/1011] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">      4.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        4.4.4.4 [110/1001] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">      5.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O IA     5.5.5.5 [110/1021] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">      6.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        6.6.6.0/24 is directly connected, Loopback0</span><br><span class="line">L        6.6.6.6/32 is directly connected, Loopback0</span><br><span class="line">      7.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        7.7.7.7 [110/11] via 192.168.67.7, 00:42:06, Ethernet0/1</span><br><span class="line">      100.0.0.0/32 is subnetted, 1 subnets</span><br><span class="line">O        100.1.1.1 [110/1011] via 172.16.46.4, 00:01:58, Tunnel0</span><br><span class="line">      172.16.0.0/16 is variably subnetted, 3 subnets, 2 masks</span><br><span class="line">O        172.16.35.0/24 [110/2010] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">C        172.16.46.0/24 is directly connected, Tunnel0</span><br><span class="line">L        172.16.46.6/32 is directly connected, Tunnel0</span><br><span class="line">O     192.168.12.0/24 [110/1020] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">O     192.168.13.0/24 [110/1020] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">O     192.168.23.0/24 [110/1020] via 172.16.46.4, 00:01:58, Tunnel0</span><br><span class="line">O     192.168.24.0/24 [110/1010] via 172.16.46.4, 00:23:01, Tunnel0</span><br><span class="line">O IA  192.168.35.0/24 [110/1020] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">      192.168.46.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.46.0/24 is directly connected, Ethernet0/0</span><br><span class="line">L        192.168.46.6/32 is directly connected, Ethernet0/0</span><br><span class="line">O     192.168.57.0/24 [110/20] via 192.168.67.7, 00:42:06, Ethernet0/1</span><br><span class="line">      192.168.67.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.67.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.67.6/32 is directly connected, Ethernet0/1</span><br><span class="line">O     192.168.184.0/24 [110/1010] via 172.16.46.4, 00:02:22, Tunnel0</span><br><span class="line">O     192.168.197.0/24 [110/1020] via 172.16.46.4, 00:01:58, Tunnel0</span><br></pre></td></tr></table></figure>





<p>装完NSSA</p>
<blockquote>
<p>屏蔽外部路由，形成一条默认路由0.0.0.0/0，指向R5和R6</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">O*IA  0.0.0.0/0 [110/11] via 192.168.67.6, 00:00:05, Ethernet0/1</span><br><span class="line">                [110/11] via 192.168.57.5, 00:00:05, Ethernet0/0</span><br><span class="line">      7.0.0.0/8 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        7.7.7.0/24 is directly connected, Loopback0</span><br><span class="line">L        7.7.7.7/32 is directly connected, Loopback0</span><br><span class="line">      192.168.57.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.57.0/24 is directly connected, Ethernet0/0</span><br><span class="line">L        192.168.57.7/32 is directly connected, Ethernet0/0</span><br><span class="line">      192.168.67.0/24 is variably subnetted, 2 subnets, 2 masks</span><br><span class="line">C        192.168.67.0/24 is directly connected, Ethernet0/1</span><br><span class="line">L        192.168.67.7/32 is directly connected, Ethernet0/1</span><br></pre></td></tr></table></figure>



<h2 id="路由汇总-1"><a href="#路由汇总-1" class="headerlink" title="路由汇总"></a>路由汇总</h2><p><strong>6、R3的路由汇总</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">R3:</span><br><span class="line">======</span><br><span class="line">$这些回环接口配置的ip地址宣告进了area 1，所以在area 1中汇总</span><br><span class="line">int lo1</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo2</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo3</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line"></span><br><span class="line">int range lo1,lo2,lo3</span><br><span class="line">ip ospf 1 area 1</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 172.16.0.0 255.255.0.0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">R5:</span><br><span class="line">======</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 172.16.0.0 255.255.0.0</span><br><span class="line"></span><br><span class="line">R2:</span><br><span class="line">======</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 172.16.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>



<p> <font color="red" style="center">Question？：为什么R1读取不到R3的172.16.0.0/16的条目，而R5可以读到，因为R3和R5有一个Tunnel 吗？</font></p>
<p>在汇总之前，R1的路由表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">      172.16.0.0/16 is variably subnetted, 5 subnets, 2 masks</span><br><span class="line">O IA     172.16.1.1/32 [110/11] via 192.168.184.3, 00:00:05, Ethernet0/2</span><br><span class="line">O IA     172.16.2.1/32 [110/11] via 192.168.184.3, 00:00:05, Ethernet0/2</span><br><span class="line">O IA     172.16.3.1/32 [110/11] via 192.168.184.3, 00:00:05, Ethernet0/2</span><br><span class="line">O        172.16.35.0/24 [110/1010] via 192.168.184.3, 00:37:33, Ethernet0/2</span><br><span class="line">O        172.16.46.0/24 [110/1010] via 192.168.184.4, 00:37:33, Ethernet0/2</span><br></pre></td></tr></table></figure>



<h2 id="OSPF认证"><a href="#OSPF认证" class="headerlink" title="OSPF认证"></a>OSPF认证</h2><p><strong>7、area 0的明文认证</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">R1-R3,先不开启R4的明文认证</span><br><span class="line">router ospf 1</span><br><span class="line">area 0 authentication</span><br><span class="line"></span><br><span class="line"><span class="comment">#注意，下面的所有代码都是R5和R6没有添加明文认证的，这里添加上明文认证</span></span><br><span class="line"><span class="comment">#难关area 0学习不到7.7.7.0的路由</span></span><br><span class="line">router ospf 1</span><br><span class="line">area 0 authentication</span><br></pre></td></tr></table></figure>

<p>等到40s死亡计时过了之后，就会发现R4失效：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">*Jan  1 03:13:17.836: %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on Ethernet0/0 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br><span class="line">R4(config)<span class="comment">#router</span></span><br><span class="line">*Jan  1 03:13:19.671: %OSPF-5-ADJCHG: Process 1, Nbr 2.2.2.2 on Ethernet0/2 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br><span class="line">R4(config)<span class="comment">#router ospf 1</span></span><br><span class="line">R4(config-router)<span class="comment">#</span></span><br><span class="line">*Jan  1 03:13:21.215: %OSPF-5-ADJCHG: Process 1, Nbr 3.3.3.3 on Ethernet0/2 from FULL to DOWN, Neighbor Down: Dead timer expired</span><br></pre></td></tr></table></figure>

<p>一旦在R4上开启认证，R4又会重新从<code>Down</code>变成<code>Full</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R4:</span><br><span class="line">router ospf 1</span><br><span class="line">area 0 authentication</span><br></pre></td></tr></table></figure>



<p><strong>R3-5，R4-6密文认证</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R3:</span><br><span class="line">int e0/1</span><br><span class="line">ip ospf message-digest-key 1 md5 cis_pad</span><br><span class="line">ip ospf authentication message-digest</span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置完之后，R3路由表中，R5的Dead Time会跌出30，然后直到消失，这是在R5的相应接口上也配置认证,彼此又会建立相应的连接。</span></span><br><span class="line">int e0/0</span><br><span class="line">ip ospf message-digest-key 1 md5 cis_pad</span><br><span class="line">ip ospf authentication message-digest</span><br></pre></td></tr></table></figure>



<h2 id="抑制路由"><a href="#抑制路由" class="headerlink" title="抑制路由"></a>抑制路由</h2><p><strong>8、禁止area 2内的路由被其他区域学到</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">R5:</span><br><span class="line">=====</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 192.168.57.0 255.255.255.0 not-advertise</span><br><span class="line">area 1 range 192.168.67.0 255.255.255.0 not-advertise</span><br><span class="line">area 2 nssa translate type7 suppress-fa</span><br><span class="line"></span><br><span class="line">R6:</span><br><span class="line">=====</span><br><span class="line">router ospf 1</span><br><span class="line">area 1 range 192.168.57.0 255.255.255.0 not-advertise</span><br><span class="line">area 1 range 192.168.67.0 255.255.255.0 not-advertise</span><br><span class="line">area 2 nssa translate type7 suppress-fa</span><br></pre></td></tr></table></figure>









<h1 id="OSPF命令"><a href="#OSPF命令" class="headerlink" title="OSPF命令"></a>OSPF命令</h1><p>配置OSPF协议</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">router ospf [Process_ID]			<span class="comment">#进程ID本地有效</span></span><br><span class="line">network 1.1.1.0 0.0.0.255 area 0 	<span class="comment">#将1.1.1.0网段(包含子网掩码)宣告进OSPF网络</span></span><br><span class="line">router-id 1.1.1.1					<span class="comment">#设置Router-ID，注意需要重启生效</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#基于链路的配置</span></span><br><span class="line">int range e0/0 -1 					<span class="comment">#行入e/0、e0/1接口</span></span><br><span class="line">ip ospf 1 area 0 					<span class="comment">#将该接口加入OSPF，并且按照配置的子网掩码宣告其接口上</span></span><br></pre></td></tr></table></figure>



<p>配置OSPF优先级</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">int e0/0</span><br><span class="line">ip ospf priority 10		<span class="comment"># 默认为1</span></span><br><span class="line"><span class="comment"># 重置OSPF进程，重新选举</span></span><br><span class="line"><span class="keyword">do</span> clear ip ospf process</span><br></pre></td></tr></table></figure>



<p>LSA</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 查看1类LSA</span></span><br><span class="line">show ip ospf database router x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看2类LSA</span></span><br><span class="line">show ip ospf database network x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看3类LSA</span></span><br><span class="line">show ip ospf database summary x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看4类LSA</span></span><br><span class="line">show ip ospf database asbr-summary x.x.x.x</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看5类LSA</span></span><br><span class="line">show ip ospf database external x.x.x.x</span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看7类LSA</span></span><br><span class="line">show ip ospf database router x.x.x.x</span><br></pre></td></tr></table></figure>


            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/23/OSPF%E5%8D%8F%E8%AE%AE/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/23/OSPF%E5%8D%8F%E8%AE%AE/" title="OSPF协议">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/3.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/19/LVS/">
    		Linux Virtual Server
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-19T13:33:30.000Z">2020-02-19</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="LVS简介"><a href="#LVS简介" class="headerlink" title="LVS简介"></a>LVS简介</h1><p>在已有的负载均衡技术中，IP负载均衡是效率最高的。它将一组服务器构建成一个高性能、高可用的虚拟服务器。如图，LVS一共有以下两部分组成：</p>
<p><img src="https://i.loli.net/2020/03/22/4AzfxepYXlTDRGV.jpg" alt="LVS_1.jpg"></p>
<blockquote>
<ol>
<li>Load Balance Machine，提供调度的机器，负责接收用户请求后转发给后端Server集群</li>
<li>Real Server ，真实的服务器集群，负责提供各种服务</li>
</ol>
</blockquote>
<p>其中，LB机器上运行LVS，LVS有用户空间和内核空间两部分组成：</p>
<blockquote>
<ol>
<li>IPVS（IP Virtual Server）：工作在内核空间中，是真正生效实现调度的代码。</li>
<li>ipvsadm：工作在用户空间，负责为ipvs内核框架编写规则，定义谁是集群，谁是后端真实服务器。</li>
</ol>
</blockquote>
<p>LB集群原理：当用户的请求过来时，会直接分发到Director Server上，然后它把用户请求根据设置好的调度算法，智能均衡的分配到后端真正的服务器上（Real Server）</p>
<p>LVS一共有三种模式，分别是：</p>
<ol>
<li>Virtual Server via Network Address Translation（VS/NAT）</li>
<li>Virtual Server via IP Tunneling（VS/TUN）</li>
<li>Virtual Server via Direct Routing（VS/DR）</li>
</ol>
<p>LVS一共有8中调度算法</p>
<ol>
<li>轮询（Round Robin）调度器通过”轮叫”调度算法将外部请求按顺序轮流分配到集群中的真实服务器上，它均等地对待每一台服务器，而不管服务器上实际的连接数和系统负载。</li>
<li>加权轮询（Weighted Round Robin）调度器通过”加权轮叫”调度算法根据真实服务器的不同处理能力来调度访问请求。这样可以保证处理能力强的服务器处理更多的访问流量。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</li>
<li>最少链接（Least Connections）调度器通过”最少连接”调度算法动态地将网络请求调度到已建立的链接数最少的服务器上。如果集群系统的真实服务器具有相近的系统性能，采用”最小连接”调度算法可以较好地均衡负载。</li>
<li>加权最少链接（Weighted Least Connections）在集群系统中的服务器性能差异较大的情况下，调度器采用”加权最少链接”调度算法优化负载均衡性能，具有较高权值的服务器将承受较大比例的活动连接负载。调度器可以自动问询真实服务器的负载情况，并动态地调整其权值。</li>
<li>基于局部性的最少链接（Locality-Based Least Connections）”基于局部性的最少链接” 调度算法是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。该算法根据请求的目标IP地址找出该目标IP地址最近使用的服务器，若该服务器 是可用的且没有超载，将请求发送到该服务器；若服务器不存在，或者该服务器超载且有服务器处于一半的工作负载，则用”最少链接”的原则选出一个可用的服务 器，将请求发送到该服务器。</li>
<li>带复制的基于局部性最少链接（Locality-Based Least Connections with Replication）”带复制的基于局部性最少链接”调度算法也是针对目标IP地址的负载均衡，目前主要用于Cache集群系统。它与LBLC算法的不同之处是它要维护从一个 目标IP地址到一组服务器的映射，而LBLC算法维护从一个目标IP地址到一台服务器的映射。该算法根据请求的目标IP地址找出该目标IP地址对应的服务 器组，按”最小连接”原则从服务器组中选出一台服务器，若服务器没有超载，将请求发送到该服务器，若服务器超载；则按”最小连接”原则从这个集群中选出一 台服务器，将该服务器加入到服务器组中，将请求发送到该服务器。同时，当该服务器组有一段时间没有被修改，将最忙的服务器从服务器组中删除，以降低复制的 程度。</li>
<li>目标地址散列（Destination Hashing）”目标地址散列”调度算法根据请求的目标IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</li>
<li>源地址散列（Source Hashing）”源地址散列”调度算法根据请求的源IP地址，作为散列键（Hash Key）从静态分配的散列表找出对应的服务器，若该服务器是可用的且未超载，将请求发送到该服务器，否则返回空。</li>
<li>最短的期望的延迟？</li>
<li>最少队列调度？</li>
</ol>
<h2 id="相关术语"><a href="#相关术语" class="headerlink" title="相关术语"></a>相关术语</h2><ol>
<li>DS：Director Server。指的是前端负载均衡器节点。</li>
<li>RS：Real Server。后端真实的工作服务器。</li>
<li>VIP：向外部直接面向用户请求，作为用户请求的目标的IP地址。</li>
<li>DIP：Director Server IP，主要用于和内部主机通讯的IP地址。</li>
<li>RIP：Real Server IP，后端服务器的IP地址。</li>
<li>CIP：Client IP，访问客户端的IP地址。</li>
</ol>
<h2 id="VS-NAT工作模型"><a href="#VS-NAT工作模型" class="headerlink" title="VS/NAT工作模型"></a>VS/NAT工作模型</h2><p><img src="https://i.loli.net/2020/03/22/yMxz4afX2OuWYgc.png" alt="LVS_2.png"></p>
<p>流程：</p>
<ol>
<li>当用户访问服务器提供服务时，发往VIP地址的请求包到达LB机器</li>
<li>LB机器检查数据包的目标IP和目标Port，去匹配LVS中的规则，然后根据负载均衡算法从集群中选择RS响应请求，并将连接添加到记录已连接的Hash表中</li>
<li>将数据包的目的地址和端口重写–&gt; 选中的RS的IP:Port，然后转发RS。</li>
<li>RS返回数据报时，SrcIP：RIP.Rport DstIP DIP.Dport。</li>
<li>LB机器将数据报中的源IP地址和源Port重写为DS的源地址和源Port</li>
<li>连接终止或超时后，连接记录就会在已连接的Hash表中删除</li>
</ol>
<p>特性：</p>
<ol>
<li>RS应该使用私有IP地址，RS的网关是DIP地址</li>
<li>DIP要和RIP属于同一个网段</li>
<li>请求和响应报文都需要经过DS（性能瓶颈）</li>
<li>支持端口映射</li>
<li>RS可以使用任意操作系统</li>
</ol>
<h2 id="VS-DR工作模型"><a href="#VS-DR工作模型" class="headerlink" title="VS/DR工作模型"></a>VS/DR工作模型</h2><p><img src="https://i.loli.net/2020/03/22/3eHvpJs9Utkyib6.png" alt="LVS_3.png"></p>
<p>流程：</p>
<ol>
<li>当用户访问服务器提供服务时，发往VIP地址的请求包到达LB机器。</li>
<li>LB机器根据负载均衡算法，选出合适的RS，将目的Mac修改为RS的Mac，其余不变，并将连接记录添加到Hash表。</li>
<li>RS处理完报文后，将响应报文直接发送给客户端</li>
<li>连接终止或超时后，连接记录就会在已连接的Hash表中删除</li>
</ol>
<p>数据报流动：</p>
<p><img src="https://i.loli.net/2020/03/22/unXjMckrdQICYTf.png" alt="LVS_4 DR数据流动.png"></p>
<p>非ARP接口：</p>
<blockquote>
<p>因为DR需要所有设备在同一个局域网内，而arp广播，会发送LAN的所有机器（LB机器和RS机器），我们现在只需要LB机器去响应VIP请求，要求只能是DR进行响应VIP的arp请求，而RS不能够响应。我们需要设置arp参数（RS)，限制其不能响应VIP的arp请求。</p>
<p>arp_ignore：arp响应</p>
<p>arp_announce：arp通告</p>
</blockquote>
<p>特性：</p>
<ol>
<li>保证前端路由将目标地址为VIP报文通通发给DS</li>
<li>RS可以使用私有IP地址，也可以使用公网IP地址，如果使用公网地址，此时通过Internet对RIP进行直接访问</li>
<li>RS和DS必须在同一个物理网络当中</li>
<li>请求报文经过DS到RS，但是响应报文不经过DS（消除nat模式下的性能瓶颈）</li>
<li>不支持地址转化，也不支持端口映射</li>
<li>RS的网关决不能指向DS（因为我们允许RS通过DS）</li>
<li>RS上的lo接口配置VIP地址</li>
</ol>
<h2 id="VS-TUN工作模型"><a href="#VS-TUN工作模型" class="headerlink" title="VS/TUN工作模型"></a>VS/TUN工作模型</h2><p><img src="https://i.loli.net/2020/03/22/CgUyVIajr4KkXtd.png" alt="LVS_5_Tun.png"></p>
<p>流程：</p>
<ol>
<li>当用户访问服务器提供服务时，发往VIP地址的请求包到达LB机器。</li>
<li>调度器根据各个服务器的负载情况，动态地选择一台服务器， 将请求报文封装在另一个IP报文中，再将封装后的IP报文转发给选出的服务器</li>
<li>服务器收到报文后，先将报文解封获得原来目标地址为VIP的报文，服务器发 现VIP地址被配置在本地的IP隧道设备上，所以就处理这个请求，然后根据路由表将响应报文直接返回给客户。</li>
</ol>
<p>数据报流动：</p>
<p><img src="https://i.loli.net/2020/03/22/bhvVoSX3da8KH4P.png" alt="LVS_6.png"><br>特点：</p>
<ol>
<li>TUN的建立需要时动态的，类似DMVPN</li>
<li>因为又添加了IP报头，所以IP隧道会消耗一定的资源</li>
<li>不需要DS返回响应，和DR类似</li>
<li>Tun可以做加密，IPSec等</li>
</ol>
<h2 id="三种模型的比较"><a href="#三种模型的比较" class="headerlink" title="三种模型的比较"></a>三种模型的比较</h2><p><strong>1. Virtual Server via NAT</strong>：VS/NAT 的优点是服务器可以运行任何支持TCP/IP的操作系统，它只需要一个IP地址配置在调度器上，服务器组可以用私有的IP地址。缺点是它的伸缩能力有限，因为在VS/NAT中请求和响应报文都需要通过负载调度器。可以有三种方法解决这个问题：混合方法、VS/TUN和 VS/DR。在DNS混合集群系统中，有若干个VS/NAT负载调度器，每个负载调度器带自己的服务器集群，同时这些负载调度器又通过RR-DNS组成简 单的域名。但VS/TUN和VS/DR是提高系统吞吐量的更好方法。对于那些将IP地址或者端口号在报文数据中传送的网络服务，需要编写相应的应用模块来转换报文数据中的IP地址或者端口号。这会带来实现的工作量，同时应用模块检查报文的开销会降低系统的吞吐率。</p>
<p><strong>2. Virtual Server via IP Tunneling：</strong>在VS/TUN 的集群系统中，负载调度器只将请求调度到不同的后端服务器，后端服务器将应答的数据直接返回给用户。这样，负载调度器就可以处理大量的请求，它甚至可以调 度百台以上的服务器（同等规模的服务器），而它不会成为系统的瓶颈。VS/TUN技术对服务器有要求，即所有的服务器必须支持“IP Tunneling”或者“IP Encapsulation”协议。目前，VS/TUN的后端服务器主要运行Linux操作系统，我们没对其他操作系统进行测试。因为“IP Tunneling”正成为各个操作系统的标准协议，所以VS/TUN应该会适用运行其他操作系统的后端服务器。</p>
<p><strong>3. Virtual Server via Direct Routing</strong>：跟VS/TUN方法一样，VS/DR调度器只处理客户到服务器端的连接，响应数据可以直接从独立的网络路由返回给客户。这可以极大地提高LVS集群系统的伸缩性。跟VS/TUN相比，这种方法没有IP隧道的开销，但是要求负载调度器与实际服务器都有一块网卡连在同一物理网段上，服务器网络设备（或者设备别名）不作ARP响应，或者能将报文重定向（Redirect）到本地的Socket端口上。</p>
<h1 id="LVS实验"><a href="#LVS实验" class="headerlink" title="LVS实验"></a>LVS实验</h1><h2 id="1、LVS-NAT"><a href="#1、LVS-NAT" class="headerlink" title="1、LVS/NAT"></a>1、LVS/NAT</h2><p>实验配置：</p>
<p>DS / LB机器</p>
<table>
<thead>
<tr>
<th>地址类型</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>VIP</td>
<td>192.168.1.105</td>
</tr>
<tr>
<td>DIP</td>
<td>192.168.70.10</td>
</tr>
</tbody></table>
<p>RS / WEB服务器</p>
<table>
<thead>
<tr>
<th>站点</th>
<th>IP地址</th>
<th>默认网关</th>
</tr>
</thead>
<tbody><tr>
<td>RS1</td>
<td>RIP：172.10.10.20/16</td>
<td>GATEWAY： 172.10.10.2</td>
</tr>
<tr>
<td>RS2</td>
<td>RIP：172.10.10.30/16</td>
<td>GATEWAY：172.10.10.2</td>
</tr>
</tbody></table>
<p>DS / LB机器的网卡，添加了一块桥接的网卡，之后访问就直接访问那块桥接网卡的IP地址。这样真实的IP地址就不会暴露在公网了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">eth0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 172.10.10.1  netmask 255.255.0.0  broadcast 172.10.255.255</span><br><span class="line"></span><br><span class="line">eth1: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">        inet 192.168.1.2  netmask 255.255.255.0  broadcast 192.168.1.255</span><br></pre></td></tr></table></figure>



<p><strong>RS站点部署</strong></p>
<ol>
<li>使用httpd服务，这里介绍以下httpd服务，主配置文件：<code>/etc/httpd/conf/httpd.conf</code>，默认站点目录：<code>/var/www/html</code>。</li>
<li>需要把RS机器的默认网关修改为DS机器的IP地址</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node02 node03</span></span><br><span class="line">yum -y install httpd</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS NODE02"</span> &gt; /var/www/html/index.html</span><br><span class="line">sed  -i <span class="string">'/GATEWAY/d'</span> /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"GATEWAY=192.168.70.10"</span> &gt;&gt;  /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line">systemctl restart network</span><br></pre></td></tr></table></figure>



<p><strong>DS站点部署</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 安装ipvsadm，lvs的管理工具</span></span><br><span class="line">yum -y install ipvsadm</span><br><span class="line"><span class="comment"># 打开转发配置NAT，0是关闭</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt;   /proc/sys/net/ipv4/ip_forward</span><br><span class="line"><span class="comment"># 清除Ptables NAT表的规则</span></span><br><span class="line">iptables -t nat -F</span><br><span class="line"><span class="comment"># 添加iptables规则，让去往ens35的流量转发给192.168.70.10  公网--&gt;私网</span></span><br><span class="line">iptables -t nat -A POSTROUTING -s 192.168.70.10/24 -o ens35 -j MASQUERADE</span><br><span class="line"></span><br><span class="line"><span class="comment">#清除ipvsadm的所有规则</span></span><br><span class="line">ipvsadm --clear</span><br><span class="line"></span><br><span class="line"><span class="comment">#设置wrr加权轮询策略并添加主机</span></span><br><span class="line">ipvsadm -A -t 192.168.1.105:80 -s wrr</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加主机，将到达192.168.1.105的流量转到192.168.70.20</span></span><br><span class="line">ipvsadm -a -t 192.168.1.105:80 -r 192.168.70.20:80 -m -w 2</span><br><span class="line"><span class="comment">#添加主机，将到达192.168.1.105的流量转到192.168.70.30</span></span><br><span class="line">ipvsadm -a -t 192.168.1.105:80 -r 192.168.70.30:80 -m -w 1</span><br><span class="line"></span><br><span class="line"><span class="comment">#	ipvsadm常用选项</span></span><br><span class="line"><span class="comment">#	-A : 添加Virtual Server Address（VIP+Port）</span></span><br><span class="line"><span class="comment">#	-s : 定义负载均衡策略</span></span><br><span class="line"><span class="comment">#	-e : 修改匹配规则</span></span><br><span class="line"><span class="comment">#	-r : 指定RS的地址和端口</span></span><br><span class="line"><span class="comment">#	-m : 指定为NAT</span></span><br><span class="line"><span class="comment">#	-w : 指定权重</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#查看策略信息</span></span><br><span class="line">ipvsadm -ln</span><br></pre></td></tr></table></figure>



<p>之前在docker上做了一遍，到添加虚拟服务地址VSA的时候报错了，大概是LVS是要通过LINUX内核来实现，docker下完成不了对内核的改动，所以用不了。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@00564133da53 /]<span class="comment"># sudo ipvsadm -A  -t 192.168.1.2:80 -s wrr</span></span><br><span class="line">Can<span class="string">'t initialize ipvs: Protocol not available</span></span><br><span class="line"><span class="string">Are you sure that IP Virtual Server is built in the kernel or as module?</span></span><br></pre></td></tr></table></figure>





<h2 id="2、LVS-DR"><a href="#2、LVS-DR" class="headerlink" title="2、LVS/DR"></a>2、LVS/DR</h2><p>环境准备：</p>
<p>DS / LB机器</p>
<table>
<thead>
<tr>
<th>地址类型</th>
<th>IP地址</th>
</tr>
</thead>
<tbody><tr>
<td>VIP</td>
<td>192.168.70.100</td>
</tr>
<tr>
<td>DIP</td>
<td>192.168.70.10</td>
</tr>
</tbody></table>
<p>RS / WEB服务器</p>
<table>
<thead>
<tr>
<th>站点</th>
<th>IP地址</th>
<th>VIP地址</th>
</tr>
</thead>
<tbody><tr>
<td>RS1</td>
<td>RIP：192.168.70.20</td>
<td>192.168.70.100 lo</td>
</tr>
<tr>
<td>RS2</td>
<td>RIP：192.168.70.30</td>
<td>192.168.70.100 lo</td>
</tr>
</tbody></table>
<p>RS部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#不能让Gateway指向node1</span></span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/GATEWAY/d'</span> /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line">sed -i <span class="string">'/^$/d'</span> /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"GATEWAY=192.168.70.2"</span> &gt;&gt; /etc/sysconfig/network-scripts/ifcfg-ens32</span><br><span class="line">systemctl restart network</span><br><span class="line">systemctl restart httpd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">yum -y install net-tools</span><br><span class="line">vip=192.168.70.100</span><br><span class="line">ifconfig lo:0 <span class="variable">$vip</span> broadcast <span class="variable">$vip</span> netmask 255.255.255.255 up</span><br><span class="line">route add -host <span class="variable">$vip</span> lo:0</span><br><span class="line"><span class="comment">#1是关闭</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br><span class="line"><span class="comment">#在所有RS上部署</span></span><br></pre></td></tr></table></figure>



<p>RS脚本：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">yum -y install httpd net-tools</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS NODE03"</span> &gt; /var/www/html/index.html</span><br><span class="line">vip=192.168.70.100</span><br><span class="line">ifconfig lo:0 <span class="variable">$vip</span> broadcast <span class="variable">$vip</span> netmask 255.255.255.255 up</span><br><span class="line">route add -host <span class="variable">$vip</span> lo:0</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/lo/arp_announce</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"1"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_ignore</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"2"</span> &gt; /proc/sys/net/ipv4/conf/all/arp_announce</span><br></pre></td></tr></table></figure>







<p>DS部署</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">ifconfig ens32:0 192.168.70.100 broadcast 192.168.70.255 netmask 255.255.255.0 up</span><br><span class="line"><span class="comment">#本地重定向,去往192.168.70.100的流量从本地ens32:0走</span></span><br><span class="line">route add -host 192.168.70.100 dev ens32:0	</span><br><span class="line"></span><br><span class="line">ipvsadm -A -t 192.168.70.100:80 -s wrr</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.20:80 -m -w 1</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.30:80 -m -w 2</span><br><span class="line">ipvsadm -ln</span><br></pre></td></tr></table></figure>

<p>DS脚本</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">yum -y install net-tools ipvsadm </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"0"</span> &gt;  /proc/sys/net/ipv4/ip_forward</span><br><span class="line"></span><br><span class="line"><span class="comment">#ifconfig ens32:0 192.168.70.100 broadcast 192.168.70.255 netmask 255.255.255.0 up</span></span><br><span class="line"><span class="comment">#route add -host 192.168.70.100 dev ens32:0	</span></span><br><span class="line">ipvsadm -A -t 192.168.70.100:80 -s wrr</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.20:80 -g -w 9</span><br><span class="line">ipvsadm -a -t 192.168.70.100:80 -r 192.168.70.30:80 -g -w 1</span><br><span class="line">ipvsadm -ln</span><br><span class="line">ipvsadm -C</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> &#123;1..10&#125;;<span class="keyword">do</span> curl 192.168.70.100:80; <span class="keyword">done</span></span><br></pre></td></tr></table></figure>


            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/19/LVS/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/19/LVS/" title="Linux Virtual Server">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/9.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/">
    		Keepalived高可用
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-19T11:34:05.000Z">2020-02-19</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="Keepalived简介"><a href="#Keepalived简介" class="headerlink" title="Keepalived简介"></a>Keepalived简介</h1><ul>
<li><p>是Linux一个轻量级的高可用解决方案，Keepalive起初是为了LVS设计的，专门用来监控集群系统中各个服务节点状态，如果某个服务器节点出现故障，keepalive将检测到后自动将节点剔除</p>
</li>
<li><p>keepalived后来加入VRRP协议，（虚拟路由冗余协议），目的是解决静态路由出现的单点故障问题，通过VRRP协议可以实现网络不间断稳定运行，因此Keepalived也具有Ha功能</p>
</li>
<li><p>两大功能：健康检查和失败切换</p>
<blockquote>
<p>健康检查：采用TCP三次握手，ICMP请求，HTTP请求，UDP echo请求等方式对负载均衡后端真实服务器进行保活。</p>
<p>失败切换：主要应用于配置主备模式负载均衡器，利用VRRP协议维持主备的心跳，当主负载均衡出现问题的时候，由备负载均衡器承载对应的业务，从而在最大限度上减少流量的损失</p>
</blockquote>
</li>
<li><p>IPVS疯转，Keepalived里面所有对LVS的相关操作并不直接使用ipvsadm客户端程序，而是直接使用ipvs提供的函数进程操作。</p>
</li>
</ul>
<h2 id="VRRP协议"><a href="#VRRP协议" class="headerlink" title="VRRP协议"></a>VRRP协议</h2><p>VRRP协议：</p>
<ol>
<li>VRRP协议是一种容错的主备协议，保证当主机的下一跳路由出现故障的时候，由另外一台路由来替代出现故障的路由器进行工作，通过VRRP可以在网络发生故障时，透明的进行设备切换而不影响主机之间数据通信</li>
<li>VRRP虚拟路由器：VRRP虚拟路由器是由多台物理路由器组成，对外共享一个或多个IP地址，这个IP地址是虚拟出来的，不属于任何一台路由器，称之为VIP。</li>
<li>VRRP路由器：VRRP路由器就是一台路由器，只是上面运行了VRRP协议</li>
<li>主路由器：虚拟路由内部有多台物理路由器，但通常只有一台物理路由器对外提供服务，主路由器是选举算法选出对外提供各种网络功能</li>
<li>备份路由器：VRRP组中除了主路由器之外的所有路由器，不对外提供任何服务，只接受主路由器的通告，当主路由器挂掉时，重新进行选举算法，接替master路由器</li>
</ol>
<p>三种状态：Initialize、Master、Backup</p>
<p>选举机制：优先级</p>
<blockquote>
<p>抢占模式下，一旦有优先级高的路由器加入，即成为Master；</p>
<p>非抢占模式下只要Master不挂，优先级高的路由器只能等待。</p>
<p>只有作为Master的VRRP路由器会一直发送VRRP广播报文。</p>
</blockquote>
<h2 id="Keepalived架构"><a href="#Keepalived架构" class="headerlink" title="Keepalived架构"></a>Keepalived架构</h2><p>KeepAlived源码模块：        <strong>check</strong>     <strong>core</strong>     <strong>libipfwc</strong>     <strong>libipvs*</strong>    <strong>vrrp</strong></p>
<blockquote>
<p>core：keepalived核心程序，比如全局配置解析，进程启动等</p>
<p>vrrp：实现vrrp协议的功能</p>
<p>check：keepalived的healthchecker子进程的目录，包括了所有健康检查方式以及对应的配置解析信息，LVS配置解析也在这里</p>
<p>libipfwc：iptables(ipchains库)，主要用来配置LVS中的firewall-mark</p>
<p>libipvs*：LVS用到的文件</p>
</blockquote>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_%E6%9E%B6%E6%9E%84.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_架构.png"></p>
<ul>
<li><p>Schedulerl/OMultiplexer是一个I/O复用分发调度器，它负载安排Keepalived所有内部的任务请求</p>
</li>
<li><p>Memory Mngt是一个内存管理机制，这个框架提供了访问内存的一些通用方法</p>
</li>
<li><p>Control Plane时keepalived的控制版面，可以实现对配置文件编译和解析</p>
</li>
<li><p>Core Componets</p>
<blockquote>
<ul>
<li>Watchdog：是计算机可靠领域简单而又非常有效的检测工具，Keepalived正式通过它监控Checkers和VRRP进程的</li>
<li>Checkers：这时Keepalived最基础的功能，也是最主要的功能，可以实现对服务器运行状态检测和故障隔离</li>
<li>VRRP Stack：这时Keepalived后来引用VRRP功能，可以实现HA集群中失败切换功能，负责负载均衡器之间的实拍切换FailOver</li>
<li>IPVS Wrapper：这个是IPVS功能的一个实现，IPVSwrapper模块可以设置好IPVS规则发送至内核空间并且提供给IPVS模块，最终实现IPVS模块的负载功能</li>
<li>Netlink Reflector：用来实现高可用集群Failover是虚拟IP（VIP）的设置和切换</li>
</ul>
</blockquote>
</li>
</ul>
<p>keepalived进程：</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png"></p>
<h1 id="keepalived配置文件"><a href="#keepalived配置文件" class="headerlink" title="keepalived配置文件"></a>keepalived配置文件</h1><p>keepalived配置文件分为三类：</p>
<ol>
<li>global：全局配置文件</li>
<li>vrrpd配置</li>
<li>lvs配置，如果仅使用keepalived做HA，lvs可以不用配</li>
</ol>
<h3 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy /]<span class="comment"># cat /etc/keepalived/keepalived.conf | grep -Ev '^#|^$'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;							<span class="comment">#全局定义</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc				<span class="comment">#通知email</span></span><br><span class="line">     failover@firewall.loc 	</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc	<span class="comment">#Email发送者</span></span><br><span class="line">   smtp_server 192.168.200.1  	<span class="comment">#SMTP服务器</span></span><br><span class="line">   smtp_connect_timeout 30 		<span class="comment">#连接超时</span></span><br><span class="line">   router_id LVS_DEVEL			<span class="comment">#Router-id,是路由标识，通常是主机名</span></span><br><span class="line">   vrrp_skip_check_adv_addr		<span class="comment">#VRRP协议跳过健康检查通告</span></span><br><span class="line">   vrrp_strict					<span class="comment">#VRRP自定义脚本</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;			<span class="comment">#VRRP组</span></span><br><span class="line">    state MASTER				<span class="comment">#master状态</span></span><br><span class="line">    interface eth0				<span class="comment">#接口</span></span><br><span class="line">    virtual_router_id 51		<span class="comment">#虚拟路由器ID，同一个局域网内</span></span><br><span class="line">    priority 100				<span class="comment">#优先级</span></span><br><span class="line">    advert_int 1				</span><br><span class="line">    authentication &#123;			<span class="comment">#认证</span></span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;			<span class="comment">#VIP地址，之后用户访问只需要用vip地址即可</span></span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#后面是LVS相关，这里先不写</span></span><br></pre></td></tr></table></figure>



<h3 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h3><p>Keepalived的详细配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">全局配置</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">#静态IP</span></span><br><span class="line">	static_ipaddress</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">#等价于ip命令：ip addr add 192.168.1.1/24 brd + dev eth0 scope global</span></span><br><span class="line">		192.168.1.1/24 brd + dev eth0 scope global</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#静态路由</span></span><br><span class="line">	static_routes &#123;</span><br><span class="line">		src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> dev <span class="variable">$SRC_DEVICE</span> ... </span><br><span class="line">		src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> via <span class="variable">$GW</span> dev <span class="variable">$SRC_DEVICE</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h3><p>VRRPD：vrrp同步组和vrrp实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">VRRP Sync Groups</span><br><span class="line">同步组里的任何一个成员产生问题，则进行master和backup切换。比如内网和外网的实例不在一个同步组，其中一个网段异常，则VIP不会漂移。</span><br><span class="line">vrrp_sync_group VG_1 &#123; </span><br><span class="line">	group &#123;</span><br><span class="line">	inside_network	<span class="comment">#这里是实例名，比如VI_1</span></span><br><span class="line">	outside_network</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	notify_master /path/to/to_master.sh 	<span class="comment">#当切换到master时，执行脚本...</span></span><br><span class="line">	notify_backup /path_to/to_backup.sh </span><br><span class="line">	notify_fault <span class="string">"/path/fault.sh VG_1"</span></span><br><span class="line">	notify /path/to/notify.sh 			 	<span class="comment">#切换后发送邮件通知</span></span><br><span class="line">	smtp_alert</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp实例</span><br><span class="line">主要定义漂移组的ip地址</span><br><span class="line"></span><br><span class="line">vrrp_instance inside_network &#123; </span><br><span class="line">	state MASTER 	<span class="comment">#定义初始Initial状态，启动后根据优先级马上竞选，state不代表这台一直是master</span></span><br><span class="line">	interface eth0  <span class="comment">#实例绑定的网卡</span></span><br><span class="line">	track_interface &#123; eth0 eth1&#125;	<span class="comment">#设置额外的监控，里面任何一个网卡出现问题，都会进入fault状态</span></span><br><span class="line">	virtual_router_id 51 <span class="comment">#VRID 虚拟路由器ID</span></span><br><span class="line">	priority 100 </span><br><span class="line">	advert_int 1	<span class="comment">#检查隔离，默认1s</span></span><br><span class="line">	authentication &#123; auth_type PASS autp_pass 1234 &#125; <span class="comment">#认证设置，authe_type可以是pass和ah</span></span><br><span class="line">	virtual_ipaddress &#123;192.168.200.17/24 dev eth1 192.168.200.18/24 dev eth2 label eth2:1&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">#发生切换时添加/删除路由</span></span><br><span class="line">	virtual_routes &#123;src 192.168.100.1 to 192.168.109.0/24 via 192.168.200.254 dev eth1&#125; </span><br><span class="line">	nopreempt	<span class="comment">#设置为不抢占，只能设置为state=BACKUP，且优先级最高的机器上</span></span><br><span class="line">	preemtp_delay 300 </span><br><span class="line">	debug			<span class="comment">#Debug级别</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 192.168.200.100 443 &#123;		<span class="comment">#设置一个Virtual Server：VIP+Port</span></span><br><span class="line">    delay_loop 6							<span class="comment">#servce polling的delay时间</span></span><br><span class="line">    lb_algo rr								<span class="comment">#LVS调度算法，有rr wrr lc wlc lblc sh dh</span></span><br><span class="line">    lb_kind NAT								<span class="comment">#LVS集群模式，有NAT、DR、TUN</span></span><br><span class="line">    persistence_timeout 50					<span class="comment">#会话保持时间</span></span><br><span class="line">    protocol TCP							<span class="comment">#使用TCP协议，有TCP、UDP</span></span><br><span class="line">    sorry_server 192.168.200.200 1358		<span class="comment">#备用机，所有的real server失效后再用</span></span><br><span class="line"></span><br><span class="line">    real_server 192.168.201.100 443 &#123;		<span class="comment">#真实物理主机</span></span><br><span class="line">        weight 1							<span class="comment">#权重默认为1，0为失效</span></span><br><span class="line">        inhibit_on_failure					<span class="comment">#在健康检查失败后，将weight设置为0，而不是从ipvs中删除</span></span><br><span class="line"><span class="comment">#配置任意一种健康检查方式：HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK        </span></span><br><span class="line">        SSL_GET &#123;</span><br><span class="line">        	url &#123;</span><br><span class="line">            path /</span><br><span class="line">        	digest ff20ad2481f97b1754ef3e12ecd3a9cc	<span class="comment">#SSL检查后的摘要信息(genhash工具算出)</span></span><br><span class="line">        &#125;</span><br><span class="line">            connect_timeout 3				<span class="comment">#连接超时时间</span></span><br><span class="line">            nb_get_retry 3					<span class="comment">#重连次数</span></span><br><span class="line">            delay_before_retry 3			<span class="comment">#重连间隔时间</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         HTTP_GET &#123;</span><br><span class="line">         url &#123; </span><br><span class="line">         path /testurl/test.jsp</span><br><span class="line">         digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">         &#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    	</span><br><span class="line">    	TCP_CHECK &#123;						<span class="comment">#TCP健康检查</span></span><br><span class="line">		connect_port 80 </span><br><span class="line">		bindto 192.168.1.1 </span><br><span class="line">		connect_timeout 4</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		SMTP_CHECK &#123;</span><br><span class="line">			host &#123;</span><br><span class="line">			connect_ip &lt;IP ADDRESS&gt; </span><br><span class="line">			connect_port &lt;PORT&gt;</span><br><span class="line">			bindto &lt;IP ADDRESS&gt;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>lvs实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">lvs配置实例</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.1.1 80 &#123; </span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo wlc</span><br><span class="line">	lb_kind DR</span><br><span class="line">	persistence_timeout 1200 </span><br><span class="line">	protocol TCP ha_suspend</span><br><span class="line">	real_server 192.168.1.11 80</span><br><span class="line">	&#123; </span><br><span class="line">		weight 3 </span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">			connect_timeout 3</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	real_server 192.168.1.12 80 &#123;</span><br><span class="line">		weight 3 </span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">    		connect_timeout 3</span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Keepalived-Nginx"><a href="#Keepalived-Nginx" class="headerlink" title="Keepalived + Nginx"></a>Keepalived + Nginx</h1><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png"></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>VIP：192.168.70.199</strong></p>
<table>
<thead>
<tr>
<th>机器</th>
<th>IP地址</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>Node1</td>
<td>192.168.70.10</td>
<td>nginx  、 keepalived</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.70.20</td>
<td>nginx  、 keepalived</td>
</tr>
<tr>
<td>Web1</td>
<td>192.168.70.30</td>
<td>httpd</td>
</tr>
<tr>
<td>Web2</td>
<td>192.168.70.40</td>
<td>httpd</td>
</tr>
</tbody></table>
<h3 id="Web-1-2"><a href="#Web-1-2" class="headerlink" title="Web/1-2"></a>Web/1-2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS <span class="variable">$HOSTNAME</span>.."</span> &gt; /var/www/html/index.html</span><br></pre></td></tr></table></figure>



<h3 id="Node01"><a href="#Node01" class="headerlink" title="Node01"></a>Node01</h3><p><strong>node01，主节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"><span class="comment">#负载均衡中的后端服务器池</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">	server 192.168.70.30;</span><br><span class="line">	server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将本地的8080端口请求转发到代理服务器池中</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://webserver;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Keepalived高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#注意事项，check_nginx和花括号要有空格，track_script要写在VIP后面</span></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#定义健康检测脚本，执行间隔为1s，如果脚本执行异常，也就是Nginx down了，则优先级-20</span></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">   script <span class="string">"/root/check.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="comment">#node01为Master角色</span></span><br><span class="line">    state MASTER</span><br><span class="line"><span class="comment">#使用的接口为ens32，如果不通系统需要改，Keepalived服务起来时，VIP就挂在ens32接口上</span></span><br><span class="line">    interface ens32</span><br><span class="line"><span class="comment">#VID，同一个局域网需要相同</span></span><br><span class="line">    virtual_router_id 51</span><br><span class="line"><span class="comment">#主节点优先级，定义110，次节点为100    </span></span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line"><span class="comment">#VIP地址，如果时主主备份可以定义多个    </span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#脚本跟踪，记住空格    </span></span><br><span class="line">track_script &#123;</span><br><span class="line">    check_nginx</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment">#这一段不能用cat的形式录入，不然$会丢失</span></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C nginx --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#Num=0意味着Nginx挂了</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">chmod +x /root/check.sh</span><br></pre></td></tr></table></figure>



<h3 id="Node02"><a href="#Node02" class="headerlink" title="Node02"></a>Node02</h3><p><strong>node02，备份节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">	server 192.168.70.30;</span><br><span class="line">	server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	server_name 192.168.20.10;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://webserver;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置Keepalive高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>



<h3 id="实验效果"><a href="#实验效果" class="headerlink" title="实验效果"></a>实验效果</h3><p><strong>测试节点</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png"></p>
<p><strong>Down Keepalive</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png"></p>
<p><strong>Down Nginx</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png"></p>
<h1 id="Keepalived-haproxy"><a href="#Keepalived-haproxy" class="headerlink" title="Keepalived + haproxy"></a>Keepalived + haproxy</h1><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png"></p>
<h3 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a>实验环境准备</h3><p><strong>VIP：192.168.70.199</strong></p>
<table>
<thead>
<tr>
<th>机器</th>
<th>IP地址</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>Node1</td>
<td>192.168.70.10</td>
<td>haproxy 、keepalived</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.70.20</td>
<td>haproxy 、keepalived</td>
</tr>
<tr>
<td>Web1</td>
<td>192.168.70.30</td>
<td>mariadb</td>
</tr>
<tr>
<td>Web2</td>
<td>192.168.70.40</td>
<td>mariadb</td>
</tr>
</tbody></table>
<h3 id="MySQL双主"><a href="#MySQL双主" class="headerlink" title="MySQL双主"></a>MySQL双主</h3><p>node03</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">cat /etc/my.cnf.d/server.cnf | grep -Ev <span class="string">'#|^$'</span></span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.40' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.40',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=407;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#授权用户，便于测试</span></span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure>

<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png"></p>
<p>node04</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment =2 '</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.30' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.30',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=402;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"> </span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure>

<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png"></p>
<p><strong>检查MySQL主主同步是否成功：</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png"></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png"></p>
<h3 id="HaProxy代理"><a href="#HaProxy代理" class="headerlink" title="HaProxy代理"></a>HaProxy代理</h3><p>Node01 / 02 的Haproxy配置相同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/haproxy/haproxy.cfg </span></span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">listen mysql_proxy</span><br><span class="line">    <span class="built_in">bind</span>         	    0.0.0.0:3306</span><br><span class="line">    mode                    tcp</span><br><span class="line">    balance <span class="built_in">source</span></span><br><span class="line">    server  mysqldb1 192.168.70.30:3306 weight 1 check</span><br><span class="line">    server  mysqldb2 192.168.70.40:3306 weight 2 check</span><br><span class="line">listen stats </span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:8080</span><br><span class="line">    stats <span class="built_in">enable</span> </span><br><span class="line">    stats uri /dbs</span><br><span class="line">    stats realm haproxy\  statistics</span><br><span class="line">    stats auth admin:admin</span><br><span class="line"></span><br><span class="line">systemctl restart haproxy</span><br></pre></td></tr></table></figure>



<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png"></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png"></p>
<h3 id="Keepalived高可用"><a href="#Keepalived高可用" class="headerlink" title="Keepalived高可用"></a>Keepalived高可用</h3><p>node01</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node01上写触发脚本</span></span><br><span class="line"></span><br><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line"><span class="comment">#脚本所在位置</span></span><br><span class="line">   script <span class="string">"/root/check_proxy_pid.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">    	chk_http_port</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check_proxy_pid.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C haproxy --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>



<p>node02</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">    	chk_http_port</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>





<p><img src="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png" alt="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png"></p>
<hr>
<center>【完】


            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Keepalived高可用">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/9.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E5%AE%B9%E5%99%A8/">容器</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/">
    		Docker环境下构建HaProxy
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-17T04:27:52.000Z">2020-02-17</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="Haproxy简介说明"><a href="#Haproxy简介说明" class="headerlink" title="Haproxy简介说明"></a>Haproxy简介说明</h1><ul>
<li>一款高性能+代理负载均衡软件，目前使用广泛，支持实现TCP/HTTP的负载均衡</li>
<li>免费开源</li>
<li>最大并发量能达到5w</li>
<li>支持多种负载均衡算法，同时支持session</li>
<li>支持虚拟主机</li>
<li>拥有服务监控页面，可以了解 系统实时运行状态</li>
<li>通常不做正向代理，有更好的选择(Squid)</li>
<li>通常不做缓存代理，有更好的选择（Varnish）</li>
<li>不会改变请求和响应报文</li>
<li>不用于Web服务器</li>
<li>不是基于数据报的负载均衡器，看不到IP数据报</li>
</ul>
<p>haproxy文档：<a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/</a></p>
<h1 id="Haproxy配置文件"><a href="#Haproxy配置文件" class="headerlink" title="Haproxy配置文件"></a>Haproxy配置文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql haproxy</span><br><span class="line">/etc/haproxy/haproxy.cfg	<span class="comment">#主配置文件</span></span><br><span class="line">/usr/lib/systemd/system/haproxy.service	<span class="comment">#守护进程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@16a3b18f2dda /]<span class="comment"># cat /etc/haproxy/haproxy.cfg | grep -Ev '#|^$'</span></span><br><span class="line">global									<span class="comment">#全局配置项</span></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2		<span class="comment">#syslog服务器位置及类型</span></span><br><span class="line">    chroot      /var/lib/haproxy		<span class="comment">#chroot路径：工作目录</span></span><br><span class="line">    pidfile     /var/run/haproxy.pid	<span class="comment">#进程文件</span></span><br><span class="line">    maxconn     4000					<span class="comment">#最大连接数</span></span><br><span class="line">    user        haproxy					<span class="comment">#用户</span></span><br><span class="line">    group       haproxy					<span class="comment">#组</span></span><br><span class="line">    daemon								<span class="comment">#以守护进程运行</span></span><br><span class="line">    stats socket /var/lib/haproxy/stats	<span class="comment">#socket通信状态</span></span><br><span class="line">defaults								<span class="comment">#默认配置项</span></span><br><span class="line">    mode                    http		<span class="comment">#运行模式或协议</span></span><br><span class="line">    <span class="built_in">log</span>                     global		<span class="comment">#定义每个实例启动事件和流量日志</span></span><br><span class="line">    option                  httplog		<span class="comment">#http日志</span></span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s			<span class="comment">#http-request超时时间</span></span><br><span class="line">    timeout queue           1m			<span class="comment">#队列超时时间</span></span><br><span class="line">    timeout connect         10s			<span class="comment">#连接超时时间</span></span><br><span class="line">    timeout client          1m			<span class="comment">#客户端超时时间</span></span><br><span class="line">    timeout server          1m			<span class="comment">#服务端超时时间</span></span><br><span class="line">    timeout http-keep-alive 10s			<span class="comment">#保持长连接超时时间</span></span><br><span class="line">    timeout check           10s			<span class="comment">#check超时时间</span></span><br><span class="line">    maxconn                 3000		<span class="comment">#定义最大并发数</span></span><br><span class="line">frontend  main *:5000					<span class="comment">#前端配置，定义了一系列监听套接字，这些套接字可接受客户端请求并建立连接，监听5000端口，（bind *:80)</span></span><br><span class="line"><span class="comment">#ACL规则：(location url)</span></span><br><span class="line"><span class="comment">#测试请求的URL是以指定模式开头 </span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line"><span class="comment">#测试请求&lt;String&gt;是否以指定模式结尾    </span></span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          <span class="keyword">if</span> url_static</span><br><span class="line"><span class="comment">#如果user_backend没能匹配，指定后端的名称为app    </span></span><br><span class="line">    default_backend             app</span><br><span class="line">    </span><br><span class="line"><span class="comment">#定义后端配置：定义一系列“后端”服务器，代理会将请求转发给这些服务器</span></span><br><span class="line"><span class="comment">#static组后端</span></span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin				<span class="comment">#负载均衡算法为轮询</span></span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line"></span><br><span class="line"><span class="comment">#app组后端</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br></pre></td></tr></table></figure>



<p>配置文件结构</p>
<ul>
<li>全局配置项</li>
<li>默认配置项</li>
<li>前端配置项</li>
<li>后端配置项</li>
</ul>
<p>监听配置：通过关联前端配置想和后端配置项（frontend &amp; backend）定义一个完整代理。通常只对TCP流量有用。</p>
<h1 id="Docker-amp-Harpoxy"><a href="#Docker-amp-Harpoxy" class="headerlink" title="Docker &amp; Harpoxy"></a>Docker &amp; Harpoxy</h1><p>三台机器：  </p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP地址</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>WEB1</td>
<td>172.18.12.10</td>
<td>httpd – THIS IS WEB1…</td>
</tr>
<tr>
<td>WEB2</td>
<td>172.18.12.20</td>
<td>httpd – THIS IS WEB2…</td>
</tr>
<tr>
<td>Proxy</td>
<td>172.18.12.30</td>
<td>CentOS7 / Haproxy</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#安装docker环境</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 </span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo </span><br><span class="line">yum install docker-ce -y</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"registry-mirrors"</span>: [<span class="string">"https://ukdws02a.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建docker桥接网络，用于给容器分配IP地址</span></span><br><span class="line">docker network create --driver bridge --subnet=172.18.12.0/16 --gateway 172.18.1.1 mynet</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建后端站点，分别为web1和web2</span></span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web1.com --name web1 --network=mynet --ip 172.18.12.10 httpd</span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web2.com --name web2 --network=mynet --ip 172.18.12.20 httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB1..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web1:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line">sleep 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB2..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web2:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建代理服务器haproxy，镜像为centos7</span></span><br><span class="line"><span class="comment">#参数说明：--privilege + /usr/bin/init 是为了能够让程序以root运行，Container默认的Root只是相当于普通用户</span></span><br><span class="line"><span class="comment">#TZ		  ： 指定时区</span></span><br><span class="line"><span class="comment">#-h 	  ： 指定域名</span></span><br><span class="line"><span class="comment">#--network： 指定网络类型为我创建的网络</span></span><br><span class="line">docker run -e TZ=<span class="string">'Asia/Shanghai'</span> --privileged -itd -h haproxy.com --name myhaproxy --network=mynet --ip 172.18.12.30 centos:7 /usr/sbin/init</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否连同</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.10'</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.20'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装haproxy，并配置后端节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'yum -y install haproxy -q'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.10:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.20:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"等待服务加载...."</span></span><br><span class="line">sleep 3</span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">"echo '-------------负载均衡演示---------------' &amp;&amp; for i in &#123;1..10&#125;; do curl 172.18.12.30:5000; done"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#净化检测命令</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------开始删除配置------------"</span></span><br><span class="line">docker rm myhaproxy --force</span><br><span class="line">docker rm web1 web2 --force</span><br><span class="line">docker network rm mynet</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------检查是否有残留------------"</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">" "</span></span><br><span class="line">docker ps -a</span><br><span class="line">rm /root/index.html* -rf</span><br></pre></td></tr></table></figure>



<h1 id="负载均衡结果演示"><a href="#负载均衡结果演示" class="headerlink" title="负载均衡结果演示"></a>负载均衡结果演示</h1><p><img src="https://i.loli.net/2020/03/22/nCfvmt7hi8pAEqd.png" alt="docker_haproxy_1.png"></p>

            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/" title="Docker环境下构建HaProxy">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/02/12/RIP%20&amp;%20EIGRP%20&amp;%20ISIS/">
    		RIP &amp; EIGRP &amp; ISIS
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-12T11:44:41.000Z">2020-02-12</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="简介"><a href="#简介" class="headerlink" title="*简介"></a>*简介</h1><p>  路由协议可以分为静态路由协议和动态路由协议，动态路由协议有两类。一类是用于内部网路互联互通的IGP协议，其中代表的有RIP、EIGRP、OSPF、ISIS等，另一类是用于区域与区域之间互通的外部网关协议，目前只有BGP。</p>
<p>  本章主要总结内部网关协议中的RIP、EIGRP和ISIS。其中RIP和EIGRP是距离矢量协议，而ISIS和OSPF同属于链路状态协议。</p>
<blockquote>
<ul>
<li>距离矢量协议：传递路由条目，网络能见度只有一跳 ——基于Bellman算法</li>
<li>链路状态协议：传递链路信息，网络能见度是整个拓扑结构——基于SPF(Short Path First)，最短路径算法</li>
</ul>
</blockquote>
<h1 id="RIP"><a href="#RIP" class="headerlink" title="RIP"></a>RIP</h1><ol>
<li>RIP使用跳数来描述一条路由的好坏，每经过一台路由器，跳数加一，当跳数为16跳的时候，这条路由就会作废。</li>
<li>RIP消息封装的时候，使用UDP，端口号是520，并且源端口和目的端口都是520</li>
<li>RIP迄今为止有三个版本，分别为：RIP1，RIP2，RIPng，目前IPv4使用的是Version2 IPV6使用的是Version RIPing。</li>
<li>RIP在Cisco设备的管理距离为120</li>
</ol>
<table>
<thead>
<tr>
<th>RIPv1</th>
<th>RIPv2</th>
</tr>
</thead>
<tbody><tr>
<td>使用广播更新路由表</td>
<td>使用组播更新路由表</td>
</tr>
<tr>
<td>有类路由协议</td>
<td>无类路由协议</td>
</tr>
<tr>
<td>不支持VLSM</td>
<td>支持VLSM</td>
</tr>
<tr>
<td>不支持手工汇总</td>
<td>支持手工汇总</td>
</tr>
<tr>
<td>不支持路由表及Tag</td>
<td>支持路由标记</td>
</tr>
<tr>
<td>更新消息中的路由条目没有Next-hop信息</td>
<td>有Next-hop信息</td>
</tr>
</tbody></table>
<p>有类路由协议更新不携带子网掩码，所以RIP宣告不能加mask，如果宣告1.1.1.0/24，最后宣告的还是1.0.0.0/8。</p>
<p>RIPv2使用的组播地址为 <strong>224.0.0.9</strong> 。</p>
<p>RIP的消息通知机制：</p>
<blockquote>
<p>RIP默认30s会从所有参与RIP的接口发出路由表信息，当180s没有收到某条路由的时候，就会判断那 条路由可能失效了，但是依旧会放在路由表里面，只是不会再给别人了，当240s都没有收到这条路由的时候，就会彻底删除。</p>
</blockquote>
<h2 id="RIP配置"><a href="#RIP配置" class="headerlink" title="RIP配置"></a>RIP配置</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/RIP%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE.png" alt="http://q5q3e2ctx.bkt.clouddn.com/RIP简单配置.png"></p>
<p>宣告RIP路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router rip                  #启动RIP协议</span><br><span class="line">network 1.0.0.0         #将1.0.0.0加入到更新路由表中，将1.0.0.0所在接口也加入更新接口中</span><br><span class="line">network 192.168.12.0 </span><br><span class="line"></span><br><span class="line">#当宣告完之后，R1就可以Ping通R4了</span><br><span class="line"></span><br><span class="line">#修改RIP时间</span><br><span class="line">router rip</span><br><span class="line">timers basic 30 180 180 240     #分别是Updates、Invalid、Holddown、Flush</span><br></pre></td></tr></table></figure>



<h2 id="RIP机制"><a href="#RIP机制" class="headerlink" title="RIP机制"></a>RIP机制</h2><p>查看R1的路由表,可以发现去往R2~R4逐跳递增：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">R     2.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.12.2, 00:00:27, Ethernet0&#x2F;0</span><br><span class="line">R     3.0.0.0&#x2F;8 [120&#x2F;2] via 192.168.12.2, 00:00:27, Ethernet0&#x2F;0</span><br><span class="line">R     4.0.0.0&#x2F;8 [120&#x2F;3] via 192.168.12.2, 00:00:06, Ethernet0&#x2F;0</span><br><span class="line">#并且这里的时间也是正向计时，一到30s就重置。如果是失效的路由条目，则会经历180s和240s</span><br></pre></td></tr></table></figure>

<p>查看RIP协议相关：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip protocols</span></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Routing Protocol is <span class="string">"rip"</span></span><br><span class="line">  Outgoing update filter list <span class="keyword">for</span> all interfaces is not <span class="built_in">set</span></span><br><span class="line">  Incoming update filter list <span class="keyword">for</span> all interfaces is not <span class="built_in">set</span></span><br><span class="line">  <span class="comment"># 每隔30s发送一次更新消息，下一次预计在14s之后。</span></span><br><span class="line">  Sending updates every 30 seconds, next due <span class="keyword">in</span> 14 seconds</span><br><span class="line">  <span class="comment"># 180s判断为down，240删除无效</span></span><br><span class="line">  Invalid after 180 seconds, hold down 180, flushed after 240 </span><br><span class="line">  Redistributing: rip</span><br><span class="line">  <span class="comment"># 默认版本</span></span><br><span class="line">  Default version control: send version 2, receive version 2</span><br><span class="line">  <span class="comment"># 配置接口</span></span><br><span class="line">    Interface             Send  Recv  Triggered RIP  Key-chain</span><br><span class="line">    Ethernet0/0           2     2                                    </span><br><span class="line">    Loopback0             2     2                                    </span><br><span class="line">    Interface             Send  Recv  Triggered RIP  Key-chain</span><br><span class="line">  <span class="comment"># 自动网络汇总生效，会将所有子网划分的地址汇总为主类，主类就是子网掩码按照ABC类来</span></span><br><span class="line">  Automatic network summarization is <span class="keyword">in</span> effect</span><br><span class="line">  <span class="comment"># 最大负载均衡为4</span></span><br><span class="line">  Maximum path: 4</span><br><span class="line">  <span class="comment"># 已经宣告的路由，这里也可以看出我们宣告的1.1.1.0变成了1.0.0.0，不加子网掩码</span></span><br><span class="line">  Routing <span class="keyword">for</span> Networks:</span><br><span class="line">    1.0.0.0</span><br><span class="line">    192.168.12.0</span><br><span class="line">  <span class="comment"># 路由信息来源 上一次更新时间是累加的，到30s刷新，和上面的预计14s形成呼应</span></span><br><span class="line">  Routing Information Sources:</span><br><span class="line">    Gateway         Distance      Last Update   <span class="comment">#16s之前更新过</span></span><br><span class="line">    192.168.12.2         120      00:00:16</span><br><span class="line">  <span class="comment">#默认管理距离为120</span></span><br><span class="line">  Distance: (default is 120)</span><br></pre></td></tr></table></figure>



<p>关于RIP的30s、180s、240s，这里shutdown了R4的e0/0接口，在R3上观察现象，之后R3删除后，才会反应到R1上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#R3 -- 180的down</span></span><br><span class="line">R     1.0.0.0/8 [120/2] via 192.168.23.2, 00:00:21, Ethernet0/0</span><br><span class="line">R     2.0.0.0/8 [120/1] via 192.168.23.2, 00:00:21, Ethernet0/0</span><br><span class="line">R     4.0.0.0/8 [120/1] via 192.168.34.4, 00:01:32, Ethernet0/1</span><br><span class="line">R     192.168.12.0/24 [120/1] via 192.168.23.2, 00:00:21, Ethernet0/0</span><br><span class="line"><span class="comment">#R3 -- 240s后，R1、R2、R3的4.4.4.0都被删除了</span></span><br><span class="line">R     1.0.0.0/8 [120/2] via 192.168.23.2, 00:00:16, Ethernet0/0</span><br><span class="line">R     2.0.0.0/8 [120/1] via 192.168.23.2, 00:00:16, Ethernet0/0</span><br><span class="line">R     4.0.0.0/8 is possibly down, routing via 192.168.34.4, Ethernet0/1</span><br><span class="line">R     192.168.12.0/24 [120/1] via 192.168.23.2, 00:00:16, Ethernet0/0</span><br></pre></td></tr></table></figure>





<h2 id="RIP汇总"><a href="#RIP汇总" class="headerlink" title="RIP汇总"></a>RIP汇总</h2><p>RIP的自动汇总功能总是打开的，我们可以手动关闭：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">R1(config-router)#no auto-summary</span><br><span class="line">int lo1</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo2</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo3</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">router rip</span><br><span class="line">net 172.16.1.0</span><br><span class="line">net 172.16.2.0</span><br><span class="line">net 172.16.3.0</span><br><span class="line"></span><br><span class="line">#当完成这一切，在R2的路由表上可以看到</span><br><span class="line">R        172.16.1.0 [120&#x2F;1] via 192.168.12.1, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.2.0 [120&#x2F;1] via 192.168.12.1, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.3.0 [120&#x2F;1] via 192.168.12.1, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line"></span><br><span class="line">#现在在R1的出接口对路由进行汇总</span><br><span class="line">R1(config)#int e0&#x2F;0</span><br><span class="line">R1(config-if)#ip summary-address rip 172.16.0.0 255.255.0.0 </span><br><span class="line"></span><br><span class="line">#之后再看R2的路由表，就会发现RIP好慢，明细路由还是要经历180-240的过程C：</span><br><span class="line">      172.16.0.0&#x2F;16 is variably subnetted, 4 subnets, 2 masks</span><br><span class="line">R        172.16.0.0&#x2F;16 [120&#x2F;1] via 192.168.12.1, 00:00:22, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.1.0&#x2F;24 [120&#x2F;1] via 192.168.12.1, 00:00:52, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.2.0&#x2F;24 [120&#x2F;1] via 192.168.12.1, 00:00:52, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.3.0&#x2F;24 [120&#x2F;1] via 192.168.12.1, 00:00:52, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>



<p>不得不介绍一下清理路由表的办法了，RIP实在是太慢了： <code>clear ip route *</code> 。</p>
<h2 id="RIP认证"><a href="#RIP认证" class="headerlink" title="RIP认证"></a>RIP认证</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R1(config)#key chain Cisco                              &#x2F;&#x2F;设置钥匙的名字               </span><br><span class="line">R1(config-keychain)#key 1                                   &#x2F;&#x2F;第一把钥匙</span><br><span class="line">R1(config-keychain-key)#key-string Cisco1 &#x2F;&#x2F;第一把钥匙的内容</span><br><span class="line">R1(config-keychain-key)#key 2</span><br><span class="line">R1(config-keychain-key)#key-string Cisco2           </span><br><span class="line"></span><br><span class="line">R1(config-keychain-key)#int e0&#x2F;0                                                &#x2F;&#x2F;在接口上配置加密</span><br><span class="line">R1(config-if)#ip rip authentication key-chain Cisco         &#x2F;&#x2F;用钥匙Cisco给RIP的加密</span><br><span class="line">R1(config-if)#ip rip authentication mode md5                        &#x2F;&#x2F;加密格式为md5，也可以明文加密</span><br></pre></td></tr></table></figure>

<p>当在R1上配置完认证之后，就会发现R2在R1上学到的条目进入了 <code>180-240</code> 的过程。此时R2已经不能学习到R1的路由条目了，除非在R2上也配置认证。</p>
<p>Key-chain的其他配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R2(config-keychain-key)#?</span><br><span class="line">Key-chain key configuration commands:</span><br><span class="line">  accept-lifetime          Set accept lifetime of key</span><br><span class="line">  cryptographic-algorithm  Set cryptographic authentication algorithm</span><br><span class="line">  default                  Set a command to its defaults</span><br><span class="line">  exit                     Exit from key-chain key configuration mode</span><br><span class="line">  key-string               Set key string</span><br><span class="line">  no                       Negate a command or set its defaults</span><br><span class="line">  send-lifetime            Set send lifetime of key</span><br></pre></td></tr></table></figure>





<h2 id="RIP防环"><a href="#RIP防环" class="headerlink" title="RIP防环"></a>RIP防环</h2><ol>
<li>定义最大跳数，一个路由最远可以到15跳的地方，如果是16跳，就会认为不可达</li>
<li>水平分割，如果从接口上收到某条路由的更新，那么就不会将该路由再发回去</li>
<li>毒性逆转，和水平分隔矛盾，只能二选一，如果从接口上收到某路由的更新，那么就立即从收到的接口将该路由发回去，但是跳数是16，这样就不会从这个方向去学习路由了。</li>
<li>毒性路由，如果某个接口down了，就会立即更新该接口的网段，但是跳数是16，这样邻居收到后就立即删除</li>
<li>抑制计时器，180s没有收到路由更新就会判断可能失效，240s没有收到就会直接删除</li>
<li>触发更新，如果路由发生了变化，立即进行更新而不用等待30s</li>
</ol>
<p>毒性路由实验：shutdownR4的lo0接口，然后在R3上观察现象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#R3</span><br><span class="line">R     1.0.0.0&#x2F;8 [120&#x2F;2] via 192.168.23.2, 00:00:01, Ethernet0&#x2F;0</span><br><span class="line">R     2.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.23.2, 00:00:01, Ethernet0&#x2F;0</span><br><span class="line">R     4.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.34.4, 00:00:18, Ethernet0&#x2F;1</span><br><span class="line"></span><br><span class="line">R4(config-if)#shutdown</span><br><span class="line"></span><br><span class="line">R     1.0.0.0&#x2F;8 [120&#x2F;2] via 192.168.23.2, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line">R     2.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.23.2, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line"></span><br><span class="line">#竟然只用了几秒钟中就反应过来了。</span><br></pre></td></tr></table></figure>



<h2 id="RIP命令"><a href="#RIP命令" class="headerlink" title="RIP命令"></a>RIP命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">router rip                                                  #启动RIP协议</span><br><span class="line">    version 2</span><br><span class="line">    network 1.1.1.0                         #将1.0.0.0加入到更新路由表中，将1.0.0.0所在接口也加入更新接口中</span><br><span class="line">    timers basic 30 180 180 240             #分别是Updates、Invalid、Holddown、Flush</span><br><span class="line">    no auto-summary                                     #关闭自动汇总</span><br><span class="line"></span><br><span class="line"> #手动汇总</span><br><span class="line">(config-if)# ip summary-address rip 172.16.0.0 255.255.0.0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">认证配置：</span><br><span class="line">key chain NAME                              #设置钥匙的名字  </span><br><span class="line">key 1                                               #第一把钥匙</span><br><span class="line">key-string STRING                       #第一把钥匙的内容</span><br><span class="line"></span><br><span class="line">int e0&#x2F;0                                            #在接口上配置</span><br><span class="line">ip rip authentication key-chain NAME        #用钥匙给RIP的加密</span><br><span class="line">ip rip authentication mode md5                  #加密格式为md5，也可以明文加密</span><br></pre></td></tr></table></figure>





<h1 id="EIGRP"><a href="#EIGRP" class="headerlink" title="EIGRP"></a>EIGRP</h1><p>增强型内部网关路由选择协议(Enhanced Interior Gateway Routing protocol,EIGRP)</p>
<p>EIGRP协议的特点：</p>
<ul>
<li><p>EIGRP有自治系统，一个EIGRP网络，必须所有的路由器都属于同一个自治系统才可以传递路由。</p>
</li>
<li><p>EIGRP使用DUAL扩散更新算法来保障无环路最优路径计算</p>
</li>
<li><p>是无类路由协议，每个路由条目都包含子网掩码</p>
</li>
<li><p>传输模块RTP（Reliable Transport Protocol），使用组播224.0.0.10</p>
</li>
<li><p>EIGRP的非周期、有边界、和部分；非周期：只在度量和网络拓扑变化时才更新，部分：只发送变化的路由条目，有边界：更新仅发给受影响的路由</p>
</li>
<li><p>更新消息直接存放于IP包头之后，所有没有传输层。在IP包头协议字段中用88表示。</p>
</li>
<li><p>管理距离在Cisco设备上有三种，分别是5,90,170</p>
</li>
<li><p>EIGRP的更新是可靠传输的，任何一个给邻居的路由信息都必须得到邻居的确认。</p>
</li>
<li><p>EIGRP的度量值(Metric)计算会包含：带宽(Bandwidth)、延迟(delay)、可靠性(reliability)、负载(loading)、最大传输单元(MTU)</p>
</li>
</ul>
<p>EIGRP的数据报：</p>
<ul>
<li>Hello，用于邻居的发现和恢复，Hello数据报使用组播方式发送，而且使用不可靠的发送方式</li>
<li>ACK，是不包含数据的Hello数据报，ACK总是用单播方、不可靠的发送方式</li>
<li>Update，传递路由更新信息，仅传递给有需要的路由，单台路由单播发送，多台路由组播发送</li>
<li>Query &amp; Reply，查询和答复，是DUAL用来管理它的扩散计算的</li>
</ul>
<h2 id="EIGRP三张表"><a href="#EIGRP三张表" class="headerlink" title="EIGRP三张表"></a>EIGRP三张表</h2><p>1、邻居表</p>
<p>​    EIGRP路由器在启动之后，就会每隔5秒钟，发送一个hello消息，且从任何接口的222.0.0.10组播地址收到hello，就会立即将对方加入到自己的邻居表</p>
<p>​    邻居表中的邻居都会有一个死亡事假你，是3倍hello消息间隔，每次收到邻居的hello都会重置死亡计时器，死亡计时器一旦到零，就会直接删除和这个邻居有关的一切路由信息。</p>
<p>查看EIGRP的邻居表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#show ip eigrp neighbors </span></span><br><span class="line">EIGRP-IPv4 Neighbors <span class="keyword">for</span> AS(100)</span><br><span class="line">												    平均往返时间</span><br><span class="line">H   Address                 Interface              Hold Uptime   SRTT   RTO  Q  Seq</span><br><span class="line">                                                   (sec)         (ms)       Cnt Num</span><br><span class="line">1   192.168.15.5            Et0/1                    11 00:01:03 1280  5000  0  8</span><br><span class="line">0   192.168.12.2            Et0/0                    10 00:02:24    9   100  0  15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hold Uptime：</span><br><span class="line">SRTT：平均往返时间</span><br><span class="line">RTO：重传计时，基于SRTT</span><br><span class="line">QCnt：重传队列</span><br><span class="line">SeqNum：</span><br></pre></td></tr></table></figure>



<p>度量值Metric计算</p>
<p>2、拓扑表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip eigrp topology </span></span><br><span class="line">EIGRP-IPv4 Topology Table <span class="keyword">for</span> AS(100)/ID(1.1.1.1)</span><br><span class="line">Codes: P - Passive, A - Active, U - Update, Q - Query, R - Reply,</span><br><span class="line">       r - reply Status, s - sia Status </span><br><span class="line"></span><br><span class="line">P 192.168.23.0/24, 1 successors, FD is 307200</span><br><span class="line">        via 192.168.12.2 (307200/281600), Ethernet0/0</span><br><span class="line">P 192.168.34.0/24, 2 successors, FD is 332800</span><br><span class="line">        via 192.168.12.2 (332800/307200), Ethernet0/0</span><br><span class="line">        via 192.168.15.5 (332800/307200), Ethernet0/1</span><br><span class="line">P 192.168.12.0/24, 1 successors, FD is 281600</span><br><span class="line">        via Connected, Ethernet0/0</span><br><span class="line">P 5.5.5.0/24, 1 successors, FD is 409600</span><br><span class="line">        via 192.168.15.5 (409600/128256), Ethernet0/1</span><br><span class="line">P 192.168.45.0/24, 1 successors, FD is 307200</span><br><span class="line">        via 192.168.15.5 (307200/281600), Ethernet0/1</span><br><span class="line">P 2.2.2.0/24, 1 successors, FD is 409600</span><br><span class="line">        via 192.168.12.2 (409600/128256), Ethernet0/0</span><br><span class="line">P 3.3.3.0/24, 1 successors, FD is 435200</span><br><span class="line">        via 192.168.12.2 (435200/409600), Ethernet0/0</span><br><span class="line">P 192.168.15.0/24, 1 successors, FD is 281600</span><br><span class="line">        via Connected, Ethernet0/1</span><br><span class="line">P 1.1.1.0/24, 1 successors, FD is 128256</span><br><span class="line">        via Connected, Loopback0</span><br><span class="line">P 4.4.4.0/24, 1 successors, FD is 435200</span><br><span class="line">        via 192.168.15.5 (435200/409600), Ethernet0/1</span><br><span class="line"></span><br><span class="line"><span class="comment">#拓扑表中记录了每个目的地的相关信息，比如后继路由器、可行 后继路由器、可行距离、通告距离。</span></span><br><span class="line"><span class="comment">#FD：可行距离(Feasible Distance),到达目的地的最小度量值就是可行距离,类似Metric</span></span><br><span class="line"><span class="comment">#FC：可行性条件(Feasibility Condition)，邻居比自己的FD小</span></span><br><span class="line"><span class="comment">#FS：可行性后继路由器(Feasible Successor)，满足FC后，这个邻居就会变成该网络的可行后继路由器</span></span><br><span class="line"><span class="comment">#通告距离：就是去往这个目的地的下一跳到目的地的度量值，相当于邻居表到这个目的地的度量值</span></span><br></pre></td></tr></table></figure>

<p>当拓扑表中最佳后继路由器失效了，会导致EIGRP向所有的邻居发起查询，并且会将邻居标记为（q）</p>
<p>如果3分钟内，邻居都没有任何形式的回复，那么就会主动断开和这个邻居的关系</p>
<p>3、EIGRP路由表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#show ip route eigrp </span></span><br><span class="line">		 2.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        2.2.2.0 [90/409600] via 192.168.12.2, 00:10:49, Ethernet0/0</span><br><span class="line">      3.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        3.3.3.0 [90/435200] via 192.168.12.2, 00:08:41, Ethernet0/0</span><br><span class="line">      4.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        4.4.4.0 [90/435200] via 192.168.15.5, 00:08:41, Ethernet0/1</span><br><span class="line">      5.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        5.5.5.0 [90/409600] via 192.168.15.5, 00:09:29, Ethernet0/1</span><br><span class="line">D     192.168.23.0/24 [90/307200] via 192.168.12.2, 00:10:29, Ethernet0/0</span><br><span class="line">D     192.168.34.0/24 [90/332800] via 192.168.15.5, 00:08:43, Ethernet0/1</span><br><span class="line">                      [90/332800] via 192.168.12.2, 00:08:43, Ethernet0/0</span><br><span class="line">D     192.168.45.0/24 [90/307200] via 192.168.15.5, 00:09:29, Ethernet0/1</span><br><span class="line">[AD/FD]</span><br><span class="line"><span class="comment">#eigrp的管理距离</span></span><br><span class="line">内部路由：90</span><br><span class="line">外部路由：170</span><br><span class="line">汇总路由：5</span><br></pre></td></tr></table></figure>

<p>metric maximum hops 102 修改最大跳数</p>
<p>路由汇总 – 在路由出口手动汇总</p>
<p>EIGRP的自动汇总默认是关闭着的，无论是手动汇总还是自动汇总都会影响本地路由表，这个条目管理距离为5，并且吓一跳距离为NULL0，NULL0和loopback一样，都是软件模拟出来的接口，不过Loopback在通信过程中会正常响应，而NULL0会将数据直接丢弃不会回复，等于NULL0就是黑洞。</p>
<p>汇总的时候产生的NULL0是为了尽快结束路由查找，因为汇总丢失了明细，所以当出现路由访问的时候，明细路由应该优先形成匹配，如果明细路由没有被匹配上，说明地址不存在，可以直接丢弃。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip summary-address eigrp 100 172.16.0.0 255.255.0.0</span><br><span class="line">no auto-summary</span><br></pre></td></tr></table></figure>



<h2 id="EIGRP的配置"><a href="#EIGRP的配置" class="headerlink" title="EIGRP的配置"></a>EIGRP的配置</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/EIGRP%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE.png" alt="http://q5q3e2ctx.bkt.clouddn.com/EIGRP简单配置.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R1(config-if)<span class="comment">#router eigrp 100						</span></span><br><span class="line">R1(config-router)<span class="comment">#network 192.168.12.0 0.0.0.255</span></span><br><span class="line">R1(config-router)<span class="comment">#network 1.1.1.0 0.0.0.255</span></span><br><span class="line"></span><br><span class="line">EIGRP是无类路由，宣告加上通配符掩码可以保留子网掩码</span><br><span class="line">R1(config-router)<span class="comment">#do sh run | sec eigrp </span></span><br><span class="line">router eigrp 100</span><br><span class="line"> network 1.1.1.0 0.0.0.255</span><br><span class="line"> network 192.168.12.0</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bandwidth 9000 <span class="comment">#设置带宽</span></span><br><span class="line">delay 999      <span class="comment">#设置延迟</span></span><br></pre></td></tr></table></figure>



<h2 id="EIGRP的认证"><a href="#EIGRP的认证" class="headerlink" title="EIGRP的认证"></a>EIGRP的认证</h2><p>key-chain配置和RIP一样，剩下的是套在接口上，这里我们配置R3-R4的EIGRP认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R3(config-keychain)<span class="comment">#int e0/1</span></span><br><span class="line">R3(config-if)<span class="comment">#ip authentication key-chain eigrp 100 Cisco</span></span><br><span class="line">R3(config-if)<span class="comment">#ip authentication mode eigrp 100 md5</span></span><br></pre></td></tr></table></figure>

<p>把R5任意接口down掉，此时发现，R3<code>ping</code> R4的e0/0接口还是能<code>ping</code>通，我一度以为是认证对EIGRP无效，搞了半天，才发现他们是直连，C。接着R1<code>ping</code>R4就<code>ping</code>不通了。</p>
<h2 id="EIGRP的汇总"><a href="#EIGRP的汇总" class="headerlink" title="EIGRP的汇总"></a>EIGRP的汇总</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int lo1</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo2</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo3</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">router eigrp 100</span><br><span class="line">network 172.16.1.0 0.0.0.255</span><br><span class="line">network 172.16.2.0 0.0.0.255</span><br><span class="line">network 172.16.3.0 0.0.0.255</span><br><span class="line">int e0/0</span><br><span class="line">ip summary-address eigrp 100 172.16.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#EIGRP默认开启自动汇总</span></span><br><span class="line">R5<span class="comment">#show ip route eigrp</span></span><br></pre></td></tr></table></figure>



<p><strong>汇总前：</strong></p>
<pre><code>172.16.0.0/24 is subnetted, 3 subnets
    D        172.16.1.0 [90/409600] via 192.168.15.1, 00:01:13, Ethernet0/0
  D        172.16.2.0 [90/409600] via 192.168.15.1, 00:01:13, Ethernet0/0
  D        172.16.3.0 [90/409600] via 192.168.15.1, 00:01:13, Ethernet0/0</code></pre><p><strong>汇总后：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">R2<span class="comment">#show ip route eigrp</span></span><br><span class="line">      172.16.0.0/16 is variably subnetted, 4 subnets, 2 masks</span><br><span class="line">D        172.16.0.0/16 [90/409600] via 192.168.12.1, 00:00:35, Ethernet0/0</span><br><span class="line">D        172.16.1.0/24 [90/486400] via 192.168.23.3, 00:00:35, Ethernet0/1</span><br><span class="line">D        172.16.2.0/24 [90/486400] via 192.168.23.3, 00:00:35, Ethernet0/1</span><br><span class="line">D        172.16.3.0/24 [90/486400] via 192.168.23.3, 00:00:35, Ethernet0/1</span><br></pre></td></tr></table></figure>



<p>会发现，即使是汇总，和R1相邻的路由器上也可以收到明细路由，但是R3等不和R1相邻的路由器上，就只能收到汇总后的路由。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D     172.16.0.0/16 [90/435200] via 192.168.23.2, 00:00:02, Ethernet0/0</span><br></pre></td></tr></table></figure>





<h2 id="EIGRP–FD值"><a href="#EIGRP–FD值" class="headerlink" title="EIGRP–FD值"></a>EIGRP–FD值</h2><p>修改EIGRP的AD值和FD值，可以通过掉接口的带宽和延迟做到。</p>
<p>现在可以看到R1去往34网段负载均衡，我们现在想让R1只从R2走，所以这里调高R1的e0/1接口的带宽和延迟，接口的带宽和延迟可以用<code>show interfaces e0/1</code>查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#R1路由表</span></span><br><span class="line">D     192.168.34.0/24 [90/332800] via 192.168.15.5, 00:00:17, Ethernet0/1</span><br><span class="line">                      [90/332800] via 192.168.12.2, 00:00:17, Ethernet0/0</span><br><span class="line"></span><br><span class="line"><span class="comment">#R1拓扑表</span></span><br><span class="line">P 192.168.34.0/24, 2 successors, FD is 332800</span><br><span class="line">        via 192.168.12.2 (332800/307200), Ethernet0/0</span><br><span class="line">        via 192.168.15.5 (332800/307200), Ethernet0/1</span><br></pre></td></tr></table></figure>



<p>调整带宽，如果是在接口下修改，可能会影响多条路径，建议使用偏移列表offset-set。</p>
<p>offset只能增加从某个接口进入或者出去的路由</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">R1(config-if)<span class="comment">#bandwidth 5000</span></span><br><span class="line"></span><br><span class="line">再看拓扑表：</span><br><span class="line"><span class="comment">#R1</span></span><br><span class="line">P 192.168.34.0/24, 1 successors, FD is 332800</span><br><span class="line">        via 192.168.12.2 (332800/307200), Ethernet0/0</span><br><span class="line">        via 192.168.15.5 (588800/307200), Ethernet0/1</span><br><span class="line"><span class="comment">#R1的路由表中，也只会选择从R2走了</span></span><br><span class="line"></span><br><span class="line">调整时延类似：</span><br><span class="line">R1(config-if)<span class="comment">#delay 10000</span></span><br></pre></td></tr></table></figure>



<p>时延和带宽可以影响FD，影响EIGRP度量值的五个要素：带宽(Bandwidth)、延迟(delay)、可靠性(reliability)、负载(loading)、最大传输单元(MTU)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FD=metric = 256 * &#123; 10^7/bw + delaysum / 10 &#125;</span><br></pre></td></tr></table></figure>





<h1 id="ISIS"><a href="#ISIS" class="headerlink" title="ISIS"></a>ISIS</h1><p>ISIS采用了 面向无连接的CLNS协议，但需要保留IP地址做ISIS的Router-ID。其中CLNP地址的写法为：</p>
<blockquote>
<p>49.0001.0000.0000.0001.00</p>
<p>49：是标志地址的作用，这里是私有地址的意思</p>
<p>0001：区域号</p>
<p>0000.0000.0001：设备ID</p>
<p>00：端口号 —NSEL</p>
</blockquote>
<p>简介</p>
<blockquote>
<p>ISIS最早不是给TCP/IP设计的，是给CLNS无连接网络设计的，但是CLNS被淘汰了。ISIS的开发者给ISIS协议加上了TCP/IP的支持模块，将其变为集成的ISIS，但是依旧不如OSPF流行，所以渐渐被人遗忘。</p>
<p>近年来云计算数据中心崛起，数据中心网络日益复杂，而OSPF的区域划分很不自由，并且OSPF是基于IP来进行信息传递的，而数据中心并不是完全的TCP/IP的网络环境，所以OSPF使用受到很大的限制。FC网络不允许浪费传输效率</p>
</blockquote>
<ul>
<li>ISIS在Cisco设备中的管理距离为115</li>
</ul>
<h2 id="ISIS配置"><a href="#ISIS配置" class="headerlink" title="ISIS配置"></a>ISIS配置</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png" alt="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router isis							<span class="comment">#启动协议</span></span><br><span class="line">net 49.0001.0000.0000.0001.00		<span class="comment">#宣告CLNP地址</span></span><br><span class="line">int e0/0,lo0						<span class="comment">#在接口下配置ISIS</span></span><br><span class="line">ip router isis</span><br></pre></td></tr></table></figure>





<h2 id="ISIS邻居"><a href="#ISIS邻居" class="headerlink" title="ISIS邻居"></a>ISIS邻居</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">R3<span class="comment">#show isis neighbors </span></span><br><span class="line"></span><br><span class="line">System Id      Type Interface   IP Address      State Holdtime Circuit Id</span><br><span class="line">R1             L1   Et0/0       192.168.123.1   UP    22       R3.01              </span><br><span class="line">R1             L2   Et0/0       192.168.123.1   UP    27       R3.01              </span><br><span class="line">R2             L1   Et0/0       192.168.123.2   UP    22       R3.01              </span><br><span class="line">R2             L2   Et0/0       192.168.123.2   UP    26       R3.01              </span><br><span class="line">R4             L2   Et0/1       192.168.34.4    UP    9        R4.01</span><br></pre></td></tr></table></figure>



<p>ISIS的Hello包正常情况下，10s一次，30s没收到就判定死亡。ISIS有指定路由器的概念，但是ISIS的世界中，路由器不叫路由器，而叫中间系统，所以DR就变成了DIS</p>
<p>DIS的Hello包是3.3s一次，10s没收到就判定DIS死亡，剩下的路由器会重新选举一台路由器作为DIS。</p>
<p>DIS没有备份的概念，谁都可以随时抢占。DIS会优先判定优先级，优先级为0的设备，依旧可以做DIS。</p>
<p>DIS在优先级一样的情况下，会通过比较MAC地址数值大小，越打越优。</p>
<h2 id="ISIS角色"><a href="#ISIS角色" class="headerlink" title="ISIS角色"></a>ISIS角色</h2><ol>
<li><p>Level-1 Router：</p>
<blockquote>
<p> 区域内部路由器，用来在区域内部学习和交换LSP（相当于OSPF的LSA）</p>
<p> L1路由器只能和L1或者L12路由器建立邻居</p>
<p> L1路由器可以知道整个区域的拓扑，但是其他区域连路由都学不到，通过默认路由离开这个区域</p>
</blockquote>
</li>
<li><p>Level-2 Router</p>
<blockquote>
<p>区域间路由器，用来在区域间传递LSP信息</p>
<p>L2路由器只能和L2或者L12路由器建立邻居</p>
<p>L2路由器知道整个AS的区域情况，可以学习到每个区域的路由条目</p>
</blockquote>
</li>
<li><p>Level-1-2 Router</p>
<blockquote>
<p>用来将L1和L2路由器相连，一般是区域边界路由器（相当于OSPF的ABR）</p>
<p>L12路由器可以和L1和L2建立邻居</p>
<p>L12路由器拥有L1和L2所有的能力</p>
<p>默认情况下，路由器启动ISIS后，就是L12路由器</p>
<p>L12路由器会给L1路由器下发一个默认路由</p>
</blockquote>
</li>
</ol>
<p>L1邻居关系</p>
<ul>
<li>同一个区域才可以建立L1邻居关系</li>
</ul>
<p>L2邻居关系</p>
<ul>
<li>不管是不是一个区域，都可以建立L2邻居关系</li>
</ul>
<p>由于ISIS路由器默认是L12路由器，相当于同时开启L1和L2，所以会建立两个邻居关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改ISIS当前路由器的角色</span></span><br><span class="line">is-type level-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者在接口上修改邻居类型</span></span><br><span class="line">isis circuit-type level-1</span><br></pre></td></tr></table></figure>



<p>在ISIS数据库中，1200s倒计时，每900s一次泛洪。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh isis database level-1</span></span><br><span class="line">IS-IS Level-1 Link State Database:</span><br><span class="line">LSPID                 LSP Seq Num  LSP Checksum  LSP Holdtime      ATT/P/OL</span><br><span class="line">R1.00-00            * 0x00000008   0x1564        785               1/0/0</span><br><span class="line">R2.00-00              0x00000009   0xC590        1062              1/0/0</span><br><span class="line">R3.00-00              0x00000008   0x50F3        1105              1/0/0</span><br><span class="line">R3.01-00              0x00000003   0x734B        740               0/0/0</span><br><span class="line">R4.00-00              0x00000006   0x83FE        75                1/0/0</span><br><span class="line">R4.01-00              0x00000002   0xBA8F        123               0/0/0</span><br><span class="line">R4.02-00              0x00000002   0x9AAF        64                0/0/0</span><br></pre></td></tr></table></figure>



<p>ATT：如果这个被写为1，说明必须产生一条默认路由指向这个路由器</p>
<p>P：如果L2或者L12路由器链断开，可以使用带P置为的LSP数据进行打通</p>
<p>OL：overload，以前的路由器性能不佳，会超载。但是现在OL被利用来作为故障修复，设备升级的时候的故障路标。</p>
<p>我们会发现R3收到了两个LSP，那个<code>R3.00-00</code>是本体，<code>R3.01-00</code>是PSN（伪节点）发来的。</p>
<p><code>show isis database detail</code></p>
<h2 id="ISIS汇总"><a href="#ISIS汇总" class="headerlink" title="ISIS汇总"></a>ISIS汇总</h2><p>路由器汇总只能做在区域边界的L1/L2或者L2路由器上，并且只能汇总自己这个区域的。</p>
<p>R5：添加环回口<code>lo1~lo3</code>，并且添加到isis进行路由汇总</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Loopback1                  172.16.1.1      YES manual up                    up</span><br><span class="line">Loopback2                  172.16.2.1      YES manual up                    up</span><br><span class="line">Loopback3                  172.16.3.1      YES manual up                    up</span><br><span class="line">R5(config-router)<span class="comment">#int range lo1 -3</span></span><br><span class="line">R5(config-if-range)<span class="comment">#ip router isis</span></span><br><span class="line">R5(config-if-range)<span class="comment">#router isis</span></span><br><span class="line">R5(config-router)<span class="comment"># summary-address 172.16.0.0 255.255.0.0</span></span><br></pre></td></tr></table></figure>



<h2 id="ISIS其他"><a href="#ISIS其他" class="headerlink" title="ISIS其他"></a>ISIS其他</h2><p><strong>ISIS度量值</strong>本来是衡量4个数值，但是目前来说，一个也不支持，所以当前的集成ISIS度量值可以理解为跳数，没经过一个入口，路由metric + 10；</p>
<p><strong>ISIS默认路由注入</strong>，<code>default-information originate</code>，这个命令只有在L1/L2或者L2路由器上有效。ISIS的L1/2路由器默认会给L1路由器下发默认路由，通过数据库ATT位置来通知的。可以在L2或者L1/2路由器上配置默认路由器来影响其他L1/2或者L2路由器。默认路由需要在ISIS下宣告。</p>
<h2 id="ISIS命令"><a href="#ISIS命令" class="headerlink" title="ISIS命令"></a>ISIS命令</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png" alt="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png"></p>
<ol>
<li>R1<code>ping</code>R5</li>
<li>在R5上创建lo1-3：172.16.x.1/24，并且通告金isis，level-2，要求R4学到的是汇总的条目</li>
<li>在R5上下发默认路由，让所有的路由器都可以学习到，并且可以ping同R5没有被宣告的100.1.1.1/24 lo100的地址。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#R1</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.0001.0000.0000.0001.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.123.1 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis  </span><br><span class="line"> </span><br><span class="line"><span class="comment">#R2 </span></span><br><span class="line">router isis</span><br><span class="line">	net 49.0001.0000.0000.0002.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.123.2 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip address 192.168.24.2 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line"> </span><br><span class="line"><span class="comment">#R3</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.0001.0000.0000.0003.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.123.3 255.255.255.0</span><br><span class="line"> no shutdown </span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip address 192.168.34.3 255.255.255.0</span><br><span class="line"> no shutdown </span><br><span class="line"> ip router isis</span><br><span class="line"> </span><br><span class="line"><span class="comment">#R4</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.00020000.0000.0004.00 </span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 4.4.4.4 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.34.4 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip address 192.168.24.4 255.255.255.0</span><br><span class="line"> no shutdown </span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> ip address 192.168.45.4 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis</span><br><span class="line"> </span><br><span class="line"><span class="comment">#R5</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.0003.0000.0000.0005.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 5.5.5.5 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.45.5 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line"></span><br><span class="line"><span class="comment">#配置完这些R1就可以Ping通R5了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------</span><br><span class="line"><span class="comment">#R5  --- 汇总</span></span><br><span class="line">int lo10</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">ip router isis</span><br><span class="line">int lo20</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">ip router isis</span><br><span class="line">int lo30</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">ip router isis</span><br><span class="line"></span><br><span class="line">router isis </span><br><span class="line">summary-address 172.16.0.0 255.255.0.0</span><br><span class="line"><span class="comment">#配置完这些，R4上就可以看到：</span></span><br><span class="line">i L2  172.16.0.0/16 [115/20] via 192.168.45.5, 00:00:04, Ethernet0/2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------</span><br><span class="line"><span class="comment">#R5 --- 默认路由</span></span><br><span class="line">interface Loopback2</span><br><span class="line"> ip address 100.1.1.5 255.255.255.255</span><br><span class="line">router isis</span><br><span class="line">default-information originate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show isis database level-1			<span class="comment">#查看链路状态数据库</span></span><br><span class="line">show isis neighbors					<span class="comment">#查看ISIS邻居</span></span><br></pre></td></tr></table></figure>



            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/02/12/RIP%20&%20EIGRP%20&%20ISIS/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/12/RIP%20&amp;%20EIGRP%20&amp;%20ISIS/" title="RIP &amp; EIGRP &amp; ISIS">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/2.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    

    
    <nav class="page-navigator">
        <span class="page-number current">1</span>
    </nav>
    


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    
    <section class="widget">
        <h3 class="widget-hd"><strong>文章搜索</strong></h3>
        <div class="search-form">
  <form
    id="searchForm"
    method="GET"
    action="https://www.baidu.com/s"
    ectype="application/x-www-form-urlencoded"
    target="_blank"
    autocomplete="false"
    onsubmit="javascript: return false;">
    <input
      id="searchKeyword"
      type="text"
      class="form-control"
      placeholder="输入关键字搜索"
      autocomplete="false"
    />
    <input id="searchKeywordHidden" type="hidden" name="wd" />
    <input id="searchButton" class="btn" type="submit" value="搜索" />
  </form>
</div>
    </section>
    

    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E7%BC%96%E7%A8%8B/">编程</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E5%AE%B9%E5%99%A8/">容器</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="../../../categories/Linux/">Linux</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E6%95%85%E9%9A%9C/">故障</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E8%BF%90%E7%BB%B4/">运维</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键 (6)</a>
  
    <a class="tag-item" href="../../../tags/%E9%9A%8F%E7%AC%94/" title="随笔">随笔 (1)</a>
  
    <a class="tag-item" href="../../../tags/%E6%91%98%E5%BD%95/" title="摘录">摘录 (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://github.com/front-end-pigs/blog" target="_blank" title="Github博客">Github博客</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2020
    

    <a href="../../../index.html">Jelon Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->

<script src="../../../js/main.js?v=1593076679051.js"></script>

</body>
</html>