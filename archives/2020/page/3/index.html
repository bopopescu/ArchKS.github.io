<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>文章归档: 2020 | zen&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="Jelon, 前端, Web, 张德龙, 前端开发" >
    <meta name="description" content="Jelon个人前端小站" >

    
    <link rel="alternative" href="/atom.xml" title="zen&#39;s blog" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="../../../../favicon.ico" >
    
    
<link rel="stylesheet" href="../../../../css/style.css">

    <!--[if lt IE 9]>
    
<script src="../../../../js/html5.js"></script>

    <![endif]-->
    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d5ebf515ab530cfbdda5f5c85093fb41";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 4.2.0"></head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/" target="_blank" rel="noopener">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="../../../../index.html">
                <div class="cover">
                    <span class="name">zen&#39;s blog</span>
                    <span class="description"></span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="" class="item ">
                <a href="../../../../index.html" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../../lab/" title="实验室" class="icon-lab">&nbsp;实验室</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../../about/" title="关于" class="icon-about">&nbsp;关于</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../../comment/" title="留言" class="icon-comment">&nbsp;留言</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="https://github.com/jangdelong" target="_blank">Github</a>
                        |
                    
                        <a href="https://pages.coding.me" target="_blank">Hosted by Coding Pages</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="http://weibo.com/jangdelong" class="sinaweibo" target="_blank"><b>■</b> 新浪微博</a>
                    
                        <a href="https://www.facebook.com/profile.php?id=100011855760219&amp;ref=bookmarks" class="qqweibo" target="_blank"><b>■</b> Facebook</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        公众号
                        <span class="popover">
                            <img src="../../../../img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章归档 -->

    <h3 class="widget-hd">
        <strong>
            
                文章归档
                <!-- 文章归档，可以根据日期分类 -->
            
        </strong>
    </h3>
    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../../http:/ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/">
    		Keepalived高可用
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-19T11:34:05.000Z">2020-02-19</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="Keepalived简介"><a href="#Keepalived简介" class="headerlink" title="Keepalived简介"></a>Keepalived简介</h1><ul>
<li><p>是Linux一个轻量级的高可用解决方案，Keepalive起初是为了LVS设计的，专门用来监控集群系统中各个服务节点状态，如果某个服务器节点出现故障，keepalive将检测到后自动将节点剔除</p>
</li>
<li><p>keepalived后来加入VRRP协议，（虚拟路由冗余协议），目的是解决静态路由出现的单点故障问题，通过VRRP协议可以实现网络不间断稳定运行，因此Keepalived也具有Ha功能</p>
</li>
<li><p>两大功能：健康检查和失败切换</p>
<blockquote>
<p>健康检查：采用TCP三次握手，ICMP请求，HTTP请求，UDP echo请求等方式对负载均衡后端真实服务器进行保活。</p>
<p>失败切换：主要应用于配置主备模式负载均衡器，利用VRRP协议维持主备的心跳，当主负载均衡出现问题的时候，由备负载均衡器承载对应的业务，从而在最大限度上减少流量的损失</p>
</blockquote>
</li>
<li><p>IPVS疯转，Keepalived里面所有对LVS的相关操作并不直接使用ipvsadm客户端程序，而是直接使用ipvs提供的函数进程操作。</p>
</li>
</ul>
<h2 id="VRRP协议"><a href="#VRRP协议" class="headerlink" title="VRRP协议"></a>VRRP协议</h2><p>VRRP协议：</p>
<ol>
<li>VRRP协议是一种容错的主备协议，保证当主机的下一跳路由出现故障的时候，由另外一台路由来替代出现故障的路由器进行工作，通过VRRP可以在网络发生故障时，透明的进行设备切换而不影响主机之间数据通信</li>
<li>VRRP虚拟路由器：VRRP虚拟路由器是由多台物理路由器组成，对外共享一个或多个IP地址，这个IP地址是虚拟出来的，不属于任何一台路由器，称之为VIP。</li>
<li>VRRP路由器：VRRP路由器就是一台路由器，只是上面运行了VRRP协议</li>
<li>主路由器：虚拟路由内部有多台物理路由器，但通常只有一台物理路由器对外提供服务，主路由器是选举算法选出对外提供各种网络功能</li>
<li>备份路由器：VRRP组中除了主路由器之外的所有路由器，不对外提供任何服务，只接受主路由器的通告，当主路由器挂掉时，重新进行选举算法，接替master路由器</li>
</ol>
<p>三种状态：Initialize、Master、Backup</p>
<p>选举机制：优先级</p>
<blockquote>
<p>抢占模式下，一旦有优先级高的路由器加入，即成为Master；</p>
<p>非抢占模式下只要Master不挂，优先级高的路由器只能等待。</p>
<p>只有作为Master的VRRP路由器会一直发送VRRP广播报文。</p>
</blockquote>
<h2 id="Keepalived架构"><a href="#Keepalived架构" class="headerlink" title="Keepalived架构"></a>Keepalived架构</h2><p>KeepAlived源码模块：        <strong>check</strong>     <strong>core</strong>     <strong>libipfwc</strong>     <strong>libipvs*</strong>    <strong>vrrp</strong></p>
<blockquote>
<p>core：keepalived核心程序，比如全局配置解析，进程启动等</p>
<p>vrrp：实现vrrp协议的功能</p>
<p>check：keepalived的healthchecker子进程的目录，包括了所有健康检查方式以及对应的配置解析信息，LVS配置解析也在这里</p>
<p>libipfwc：iptables(ipchains库)，主要用来配置LVS中的firewall-mark</p>
<p>libipvs*：LVS用到的文件</p>
</blockquote>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_%E6%9E%B6%E6%9E%84.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_架构.png"></p>
<ul>
<li><p>Schedulerl/OMultiplexer是一个I/O复用分发调度器，它负载安排Keepalived所有内部的任务请求</p>
</li>
<li><p>Memory Mngt是一个内存管理机制，这个框架提供了访问内存的一些通用方法</p>
</li>
<li><p>Control Plane时keepalived的控制版面，可以实现对配置文件编译和解析</p>
</li>
<li><p>Core Componets</p>
<blockquote>
<ul>
<li>Watchdog：是计算机可靠领域简单而又非常有效的检测工具，Keepalived正式通过它监控Checkers和VRRP进程的</li>
<li>Checkers：这时Keepalived最基础的功能，也是最主要的功能，可以实现对服务器运行状态检测和故障隔离</li>
<li>VRRP Stack：这时Keepalived后来引用VRRP功能，可以实现HA集群中失败切换功能，负责负载均衡器之间的实拍切换FailOver</li>
<li>IPVS Wrapper：这个是IPVS功能的一个实现，IPVSwrapper模块可以设置好IPVS规则发送至内核空间并且提供给IPVS模块，最终实现IPVS模块的负载功能</li>
<li>Netlink Reflector：用来实现高可用集群Failover是虚拟IP（VIP）的设置和切换</li>
</ul>
</blockquote>
</li>
</ul>
<p>keepalived进程：</p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_process.png"></p>
<h1 id="keepalived配置文件"><a href="#keepalived配置文件" class="headerlink" title="keepalived配置文件"></a>keepalived配置文件</h1><p>keepalived配置文件分为三类：</p>
<ol>
<li>global：全局配置文件</li>
<li>vrrpd配置</li>
<li>lvs配置，如果仅使用keepalived做HA，lvs可以不用配</li>
</ol>
<h3 id="总体"><a href="#总体" class="headerlink" title="总体"></a>总体</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@haproxy /]<span class="comment"># cat /etc/keepalived/keepalived.conf | grep -Ev '^#|^$'</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line">global_defs &#123;							<span class="comment">#全局定义</span></span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc				<span class="comment">#通知email</span></span><br><span class="line">     failover@firewall.loc 	</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc	<span class="comment">#Email发送者</span></span><br><span class="line">   smtp_server 192.168.200.1  	<span class="comment">#SMTP服务器</span></span><br><span class="line">   smtp_connect_timeout 30 		<span class="comment">#连接超时</span></span><br><span class="line">   router_id LVS_DEVEL			<span class="comment">#Router-id,是路由标识，通常是主机名</span></span><br><span class="line">   vrrp_skip_check_adv_addr		<span class="comment">#VRRP协议跳过健康检查通告</span></span><br><span class="line">   vrrp_strict					<span class="comment">#VRRP自定义脚本</span></span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;			<span class="comment">#VRRP组</span></span><br><span class="line">    state MASTER				<span class="comment">#master状态</span></span><br><span class="line">    interface eth0				<span class="comment">#接口</span></span><br><span class="line">    virtual_router_id 51		<span class="comment">#虚拟路由器ID，同一个局域网内</span></span><br><span class="line">    priority 100				<span class="comment">#优先级</span></span><br><span class="line">    advert_int 1				</span><br><span class="line">    authentication &#123;			<span class="comment">#认证</span></span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;			<span class="comment">#VIP地址，之后用户访问只需要用vip地址即可</span></span><br><span class="line">        192.168.200.16</span><br><span class="line">        192.168.200.17</span><br><span class="line">        192.168.200.18</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#后面是LVS相关，这里先不写</span></span><br></pre></td></tr></table></figure>



<h3 id="全局"><a href="#全局" class="headerlink" title="全局"></a>全局</h3><p>Keepalived的详细配置</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">全局配置</span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">#静态IP</span></span><br><span class="line">	static_ipaddress</span><br><span class="line">	&#123;</span><br><span class="line">	<span class="comment">#等价于ip命令：ip addr add 192.168.1.1/24 brd + dev eth0 scope global</span></span><br><span class="line">		192.168.1.1/24 brd + dev eth0 scope global</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	<span class="comment">#静态路由</span></span><br><span class="line">	static_routes &#123;</span><br><span class="line">		src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> dev <span class="variable">$SRC_DEVICE</span> ... </span><br><span class="line">		src <span class="variable">$SRC_IP</span> to <span class="variable">$DST_IP</span> via <span class="variable">$GW</span> dev <span class="variable">$SRC_DEVICE</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="VRRP"><a href="#VRRP" class="headerlink" title="VRRP"></a>VRRP</h3><p>VRRPD：vrrp同步组和vrrp实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">VRRP Sync Groups</span><br><span class="line">同步组里的任何一个成员产生问题，则进行master和backup切换。比如内网和外网的实例不在一个同步组，其中一个网段异常，则VIP不会漂移。</span><br><span class="line">vrrp_sync_group VG_1 &#123; </span><br><span class="line">	group &#123;</span><br><span class="line">	inside_network	<span class="comment">#这里是实例名，比如VI_1</span></span><br><span class="line">	outside_network</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	notify_master /path/to/to_master.sh 	<span class="comment">#当切换到master时，执行脚本...</span></span><br><span class="line">	notify_backup /path_to/to_backup.sh </span><br><span class="line">	notify_fault <span class="string">"/path/fault.sh VG_1"</span></span><br><span class="line">	notify /path/to/notify.sh 			 	<span class="comment">#切换后发送邮件通知</span></span><br><span class="line">	smtp_alert</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp实例</span><br><span class="line">主要定义漂移组的ip地址</span><br><span class="line"></span><br><span class="line">vrrp_instance inside_network &#123; </span><br><span class="line">	state MASTER 	<span class="comment">#定义初始Initial状态，启动后根据优先级马上竞选，state不代表这台一直是master</span></span><br><span class="line">	interface eth0  <span class="comment">#实例绑定的网卡</span></span><br><span class="line">	track_interface &#123; eth0 eth1&#125;	<span class="comment">#设置额外的监控，里面任何一个网卡出现问题，都会进入fault状态</span></span><br><span class="line">	virtual_router_id 51 <span class="comment">#VRID 虚拟路由器ID</span></span><br><span class="line">	priority 100 </span><br><span class="line">	advert_int 1	<span class="comment">#检查隔离，默认1s</span></span><br><span class="line">	authentication &#123; auth_type PASS autp_pass 1234 &#125; <span class="comment">#认证设置，authe_type可以是pass和ah</span></span><br><span class="line">	virtual_ipaddress &#123;192.168.200.17/24 dev eth1 192.168.200.18/24 dev eth2 label eth2:1&#125; </span><br><span class="line">	</span><br><span class="line">	<span class="comment">#发生切换时添加/删除路由</span></span><br><span class="line">	virtual_routes &#123;src 192.168.100.1 to 192.168.109.0/24 via 192.168.200.254 dev eth1&#125; </span><br><span class="line">	nopreempt	<span class="comment">#设置为不抢占，只能设置为state=BACKUP，且优先级最高的机器上</span></span><br><span class="line">	preemtp_delay 300 </span><br><span class="line">	debug			<span class="comment">#Debug级别</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="LVS"><a href="#LVS" class="headerlink" title="LVS"></a>LVS</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">virtual_server 192.168.200.100 443 &#123;		<span class="comment">#设置一个Virtual Server：VIP+Port</span></span><br><span class="line">    delay_loop 6							<span class="comment">#servce polling的delay时间</span></span><br><span class="line">    lb_algo rr								<span class="comment">#LVS调度算法，有rr wrr lc wlc lblc sh dh</span></span><br><span class="line">    lb_kind NAT								<span class="comment">#LVS集群模式，有NAT、DR、TUN</span></span><br><span class="line">    persistence_timeout 50					<span class="comment">#会话保持时间</span></span><br><span class="line">    protocol TCP							<span class="comment">#使用TCP协议，有TCP、UDP</span></span><br><span class="line">    sorry_server 192.168.200.200 1358		<span class="comment">#备用机，所有的real server失效后再用</span></span><br><span class="line"></span><br><span class="line">    real_server 192.168.201.100 443 &#123;		<span class="comment">#真实物理主机</span></span><br><span class="line">        weight 1							<span class="comment">#权重默认为1，0为失效</span></span><br><span class="line">        inhibit_on_failure					<span class="comment">#在健康检查失败后，将weight设置为0，而不是从ipvs中删除</span></span><br><span class="line"><span class="comment">#配置任意一种健康检查方式：HTTP_GET|SSL_GET|TCP_CHECK|SMTP_CHECK|MISC_CHECK        </span></span><br><span class="line">        SSL_GET &#123;</span><br><span class="line">        	url &#123;</span><br><span class="line">            path /</span><br><span class="line">        	digest ff20ad2481f97b1754ef3e12ecd3a9cc	<span class="comment">#SSL检查后的摘要信息(genhash工具算出)</span></span><br><span class="line">        &#125;</span><br><span class="line">            connect_timeout 3				<span class="comment">#连接超时时间</span></span><br><span class="line">            nb_get_retry 3					<span class="comment">#重连次数</span></span><br><span class="line">            delay_before_retry 3			<span class="comment">#重连间隔时间</span></span><br><span class="line">        &#125;</span><br><span class="line">        </span><br><span class="line">         HTTP_GET &#123;</span><br><span class="line">         url &#123; </span><br><span class="line">         path /testurl/test.jsp</span><br><span class="line">         digest 640205b7b0fc66c1ea91c463fac6334d</span><br><span class="line">         &#125;</span><br><span class="line">    	&#125;</span><br><span class="line">    	</span><br><span class="line">    	TCP_CHECK &#123;						<span class="comment">#TCP健康检查</span></span><br><span class="line">		connect_port 80 </span><br><span class="line">		bindto 192.168.1.1 </span><br><span class="line">		connect_timeout 4</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		SMTP_CHECK &#123;</span><br><span class="line">			host &#123;</span><br><span class="line">			connect_ip &lt;IP ADDRESS&gt; </span><br><span class="line">			connect_port &lt;PORT&gt;</span><br><span class="line">			bindto &lt;IP ADDRESS&gt;</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;	</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>lvs实例</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">lvs配置实例</span><br><span class="line"></span><br><span class="line">virtual_server 192.168.1.1 80 &#123; </span><br><span class="line">	delay_loop 3</span><br><span class="line">	lb_algo wlc</span><br><span class="line">	lb_kind DR</span><br><span class="line">	persistence_timeout 1200 </span><br><span class="line">	protocol TCP ha_suspend</span><br><span class="line">	real_server 192.168.1.11 80</span><br><span class="line">	&#123; </span><br><span class="line">		weight 3 </span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">			connect_timeout 3</span><br><span class="line">		&#125; </span><br><span class="line">	&#125;</span><br><span class="line">	real_server 192.168.1.12 80 &#123;</span><br><span class="line">		weight 3 </span><br><span class="line">		TCP_CHECK &#123;</span><br><span class="line">    		connect_timeout 3</span><br><span class="line">		&#125; </span><br><span class="line">	&#125; </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h1 id="Keepalived-Nginx"><a href="#Keepalived-Nginx" class="headerlink" title="Keepalived + Nginx"></a>Keepalived + Nginx</h1><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_nginx_httpd.png"></p>
<h3 id="环境准备"><a href="#环境准备" class="headerlink" title="环境准备"></a>环境准备</h3><p><strong>VIP：192.168.70.199</strong></p>
<table>
<thead>
<tr>
<th>机器</th>
<th>IP地址</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>Node1</td>
<td>192.168.70.10</td>
<td>nginx  、 keepalived</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.70.20</td>
<td>nginx  、 keepalived</td>
</tr>
<tr>
<td>Web1</td>
<td>192.168.70.30</td>
<td>httpd</td>
</tr>
<tr>
<td>Web2</td>
<td>192.168.70.40</td>
<td>httpd</td>
</tr>
</tbody></table>
<h3 id="Web-1-2"><a href="#Web-1-2" class="headerlink" title="Web/1-2"></a>Web/1-2</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum -y install httpd</span><br><span class="line">systemctl restart httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS <span class="variable">$HOSTNAME</span>.."</span> &gt; /var/www/html/index.html</span><br></pre></td></tr></table></figure>



<h3 id="Node01"><a href="#Node01" class="headerlink" title="Node01"></a>Node01</h3><p><strong>node01，主节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line"><span class="comment">#负载均衡中的后端服务器池</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">	server 192.168.70.30;</span><br><span class="line">	server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将本地的8080端口请求转发到代理服务器池中</span></span><br><span class="line">server &#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://webserver;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># 配置Keepalived高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line"><span class="comment">#注意事项，check_nginx和花括号要有空格，track_script要写在VIP后面</span></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">#定义健康检测脚本，执行间隔为1s，如果脚本执行异常，也就是Nginx down了，则优先级-20</span></span><br><span class="line">vrrp_script check_nginx &#123;</span><br><span class="line">   script <span class="string">"/root/check.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line"><span class="comment">#node01为Master角色</span></span><br><span class="line">    state MASTER</span><br><span class="line"><span class="comment">#使用的接口为ens32，如果不通系统需要改，Keepalived服务起来时，VIP就挂在ens32接口上</span></span><br><span class="line">    interface ens32</span><br><span class="line"><span class="comment">#VID，同一个局域网需要相同</span></span><br><span class="line">    virtual_router_id 51</span><br><span class="line"><span class="comment">#主节点优先级，定义110，次节点为100    </span></span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line"><span class="comment">#VIP地址，如果时主主备份可以定义多个    </span></span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line"><span class="comment">#脚本跟踪，记住空格    </span></span><br><span class="line">track_script &#123;</span><br><span class="line">    check_nginx</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br><span class="line"></span><br><span class="line"><span class="comment">#这一段不能用cat的形式录入，不然$会丢失</span></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C nginx --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line"><span class="comment">#Num=0意味着Nginx挂了</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">chmod +x /root/check.sh</span><br></pre></td></tr></table></figure>



<h3 id="Node02"><a href="#Node02" class="headerlink" title="Node02"></a>Node02</h3><p><strong>node02，备份节点</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置Nginx反向代理</span></span><br><span class="line">yum -y install epel-release</span><br><span class="line">yum -y install nginx</span><br><span class="line">cat &gt;&gt; /etc/nginx/conf.d/lb.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">upstream webserver &#123;</span><br><span class="line">	server 192.168.70.30;</span><br><span class="line">	server 192.168.70.40;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">server &#123;</span><br><span class="line">	listen 8080;</span><br><span class="line">	server_name 192.168.20.10;</span><br><span class="line">	location / &#123;</span><br><span class="line">		proxy_pass http://webserver;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">systemctl restart nginx</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置Keepalive高可用</span></span><br><span class="line">yum -y install keepalived</span><br><span class="line">mv /etc/keepalived/keepalived.conf&#123;,.bak&#125; </span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/keepalived/keepalived.conf &lt;&lt; <span class="string">'EOF'</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node02</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>



<h3 id="实验效果"><a href="#实验效果" class="headerlink" title="实验效果"></a>实验效果</h3><p><strong>测试节点</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepavlied+nginx_1.png"></p>
<p><strong>Down Keepalive</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_donw.png"></p>
<p><strong>Down Nginx</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+nginx_down2.png"></p>
<h1 id="Keepalived-haproxy"><a href="#Keepalived-haproxy" class="headerlink" title="Keepalived + haproxy"></a>Keepalived + haproxy</h1><p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_haproxy_mysql.png"></p>
<h3 id="实验环境准备"><a href="#实验环境准备" class="headerlink" title="实验环境准备"></a>实验环境准备</h3><p><strong>VIP：192.168.70.199</strong></p>
<table>
<thead>
<tr>
<th>机器</th>
<th>IP地址</th>
<th>服务</th>
</tr>
</thead>
<tbody><tr>
<td>Node1</td>
<td>192.168.70.10</td>
<td>haproxy 、keepalived</td>
</tr>
<tr>
<td>Node2</td>
<td>192.168.70.20</td>
<td>haproxy 、keepalived</td>
</tr>
<tr>
<td>Web1</td>
<td>192.168.70.30</td>
<td>mariadb</td>
</tr>
<tr>
<td>Web2</td>
<td>192.168.70.40</td>
<td>mariadb</td>
</tr>
</tbody></table>
<h3 id="MySQL双主"><a href="#MySQL双主" class="headerlink" title="MySQL双主"></a>MySQL双主</h3><p>node03</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 1'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">cat /etc/my.cnf.d/server.cnf | grep -Ev <span class="string">'#|^$'</span></span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.40' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.40',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=407;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#授权用户，便于测试</span></span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure>

<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalive_mysql_back1.png"></p>
<p>node04</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum -y install mariadb-server </span><br><span class="line"></span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = information_schema'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\binlog-ignore = mysql'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\skip-name-resolve'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto-increment-increment =2 '</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\log-bin = mysql-bin'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\auto_increment_offset = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line">sed -i <span class="string">'/^\[mysqld\]$/a\server-id = 2'</span> /etc/my.cnf.d/server.cnf</span><br><span class="line"></span><br><span class="line">mysql -uroot -e <span class="string">"grant replication slave on *.* to 'repuser'@'192.168.70.30' identified by '123456';"</span> </span><br><span class="line">mysql -uroot -e <span class="string">"show master status;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"change master to master_host='192.168.70.30',master_port=3306,master_user='repuser',master_password='123456',master_log_file='mysql-bin.000003',master_log_pos=402;"</span></span><br><span class="line">mysql -uroot -e <span class="string">"start slave;"</span></span><br><span class="line"> </span><br><span class="line">mysql -uroot -e <span class="string">"grant all privileges on *.* to 'zhoujing'@'%' IDENTIFIED BY '000000'; "</span></span><br></pre></td></tr></table></figure>

<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back2.png"></p>
<p><strong>检查MySQL主主同步是否成功：</strong></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back3.png"></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back4.png"></p>
<h3 id="HaProxy代理"><a href="#HaProxy代理" class="headerlink" title="HaProxy代理"></a>HaProxy代理</h3><p>Node01 / 02 的Haproxy配置相同</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">yum -y install haproxy</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/haproxy/haproxy.cfg </span></span><br><span class="line">global</span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br><span class="line">    chroot      /var/lib/haproxy</span><br><span class="line">    pidfile     /var/run/haproxy.pid</span><br><span class="line">    maxconn     4000</span><br><span class="line">    user        haproxy</span><br><span class="line">    group       haproxy</span><br><span class="line">    daemon</span><br><span class="line">    stats socket /var/lib/haproxy/stats</span><br><span class="line">listen mysql_proxy</span><br><span class="line">    <span class="built_in">bind</span>         	    0.0.0.0:3306</span><br><span class="line">    mode                    tcp</span><br><span class="line">    balance <span class="built_in">source</span></span><br><span class="line">    server  mysqldb1 192.168.70.30:3306 weight 1 check</span><br><span class="line">    server  mysqldb2 192.168.70.40:3306 weight 2 check</span><br><span class="line">listen stats </span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:8080</span><br><span class="line">    stats <span class="built_in">enable</span> </span><br><span class="line">    stats uri /dbs</span><br><span class="line">    stats realm haproxy\  statistics</span><br><span class="line">    stats auth admin:admin</span><br><span class="line"></span><br><span class="line">systemctl restart haproxy</span><br></pre></td></tr></table></figure>



<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived+mysql_back5.png"></p>
<p><img src="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png" alt="http://q5q3e2ctx.bkt.clouddn.com/keepalived_harpxoy_web_page.png"></p>
<h3 id="Keepalived高可用"><a href="#Keepalived高可用" class="headerlink" title="Keepalived高可用"></a>Keepalived高可用</h3><p>node01</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#node01上写触发脚本</span></span><br><span class="line"></span><br><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_script chk_http_port &#123;</span><br><span class="line"><span class="comment">#脚本所在位置</span></span><br><span class="line">   script <span class="string">"/root/check_proxy_pid.sh"</span></span><br><span class="line">   interval 1</span><br><span class="line">   weight -20</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">    	chk_http_port</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">[root@node01 ~]<span class="comment"># cat check_proxy_pid.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS SCRIPT IS RAN！！！"</span></span><br><span class="line">Num=$(ps -C haproxy --no-header | wc -l)</span><br><span class="line"><span class="keyword">if</span> [ <span class="variable">$Num</span> -eq 0 ];<span class="keyword">then</span></span><br><span class="line">   <span class="built_in">exit</span> 1</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">   <span class="built_in">exit</span> 0</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>



<p>node02</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">yum -y install keepalived</span><br><span class="line">[root@node01 ~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">global_defs &#123;</span><br><span class="line">   router_id node01</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens32</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 110</span><br><span class="line">    advert_int 1</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.70.199</span><br><span class="line">    &#125;</span><br><span class="line">	track_script &#123;</span><br><span class="line">    	chk_http_port</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">systemctl restart keepalived</span><br></pre></td></tr></table></figure>





<p><img src="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png" alt="http://q5q3e2ctx.bkt.clouddn.com/last_connect.png"></p>
<hr>
<center>【完】


            
            <p class="more">
                <a href="../../../../http:/ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/19/Keepalived%E9%AB%98%E5%8F%AF%E7%94%A8/" title="Keepalived高可用">
                
                    <img class="thumbnail" src="../../../../img/default.png" data-echo="../../../../img/thumbnail/9.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../../categories/%E5%AE%B9%E5%99%A8/">容器</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../../http:/ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/">
    		Docker环境下构建HaProxy
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-17T04:27:52.000Z">2020-02-17</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="Haproxy简介说明"><a href="#Haproxy简介说明" class="headerlink" title="Haproxy简介说明"></a>Haproxy简介说明</h1><ul>
<li>一款高性能+代理负载均衡软件，目前使用广泛，支持实现TCP/HTTP的负载均衡</li>
<li>免费开源</li>
<li>最大并发量能达到5w</li>
<li>支持多种负载均衡算法，同时支持session</li>
<li>支持虚拟主机</li>
<li>拥有服务监控页面，可以了解 系统实时运行状态</li>
<li>通常不做正向代理，有更好的选择(Squid)</li>
<li>通常不做缓存代理，有更好的选择（Varnish）</li>
<li>不会改变请求和响应报文</li>
<li>不用于Web服务器</li>
<li>不是基于数据报的负载均衡器，看不到IP数据报</li>
</ul>
<p>haproxy文档：<a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/</a></p>
<h1 id="Haproxy配置文件"><a href="#Haproxy配置文件" class="headerlink" title="Haproxy配置文件"></a>Haproxy配置文件</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">rpm -ql haproxy</span><br><span class="line">/etc/haproxy/haproxy.cfg	<span class="comment">#主配置文件</span></span><br><span class="line">/usr/lib/systemd/system/haproxy.service	<span class="comment">#守护进程</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@16a3b18f2dda /]<span class="comment"># cat /etc/haproxy/haproxy.cfg | grep -Ev '#|^$'</span></span><br><span class="line">global									<span class="comment">#全局配置项</span></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2		<span class="comment">#syslog服务器位置及类型</span></span><br><span class="line">    chroot      /var/lib/haproxy		<span class="comment">#chroot路径：工作目录</span></span><br><span class="line">    pidfile     /var/run/haproxy.pid	<span class="comment">#进程文件</span></span><br><span class="line">    maxconn     4000					<span class="comment">#最大连接数</span></span><br><span class="line">    user        haproxy					<span class="comment">#用户</span></span><br><span class="line">    group       haproxy					<span class="comment">#组</span></span><br><span class="line">    daemon								<span class="comment">#以守护进程运行</span></span><br><span class="line">    stats socket /var/lib/haproxy/stats	<span class="comment">#socket通信状态</span></span><br><span class="line">defaults								<span class="comment">#默认配置项</span></span><br><span class="line">    mode                    http		<span class="comment">#运行模式或协议</span></span><br><span class="line">    <span class="built_in">log</span>                     global		<span class="comment">#定义每个实例启动事件和流量日志</span></span><br><span class="line">    option                  httplog		<span class="comment">#http日志</span></span><br><span class="line">    option                  dontlognull</span><br><span class="line">    option http-server-close</span><br><span class="line">    option forwardfor       except 127.0.0.0/8</span><br><span class="line">    option                  redispatch</span><br><span class="line">    retries                 3</span><br><span class="line">    timeout http-request    10s			<span class="comment">#http-request超时时间</span></span><br><span class="line">    timeout queue           1m			<span class="comment">#队列超时时间</span></span><br><span class="line">    timeout connect         10s			<span class="comment">#连接超时时间</span></span><br><span class="line">    timeout client          1m			<span class="comment">#客户端超时时间</span></span><br><span class="line">    timeout server          1m			<span class="comment">#服务端超时时间</span></span><br><span class="line">    timeout http-keep-alive 10s			<span class="comment">#保持长连接超时时间</span></span><br><span class="line">    timeout check           10s			<span class="comment">#check超时时间</span></span><br><span class="line">    maxconn                 3000		<span class="comment">#定义最大并发数</span></span><br><span class="line">frontend  main *:5000					<span class="comment">#前端配置，定义了一系列监听套接字，这些套接字可接受客户端请求并建立连接，监听5000端口，（bind *:80)</span></span><br><span class="line"><span class="comment">#ACL规则：(location url)</span></span><br><span class="line"><span class="comment">#测试请求的URL是以指定模式开头 </span></span><br><span class="line">    acl url_static       path_beg       -i /static /images /javascript /stylesheets</span><br><span class="line"><span class="comment">#测试请求&lt;String&gt;是否以指定模式结尾    </span></span><br><span class="line">    acl url_static       path_end       -i .jpg .gif .png .css .js</span><br><span class="line">    use_backend static          <span class="keyword">if</span> url_static</span><br><span class="line"><span class="comment">#如果user_backend没能匹配，指定后端的名称为app    </span></span><br><span class="line">    default_backend             app</span><br><span class="line">    </span><br><span class="line"><span class="comment">#定义后端配置：定义一系列“后端”服务器，代理会将请求转发给这些服务器</span></span><br><span class="line"><span class="comment">#static组后端</span></span><br><span class="line">backend static</span><br><span class="line">    balance     roundrobin				<span class="comment">#负载均衡算法为轮询</span></span><br><span class="line">    server      static 127.0.0.1:4331 check</span><br><span class="line"></span><br><span class="line"><span class="comment">#app组后端</span></span><br><span class="line">backend app</span><br><span class="line">    balance     roundrobin</span><br><span class="line">    server  app1 127.0.0.1:5001 check</span><br><span class="line">    server  app2 127.0.0.1:5002 check</span><br><span class="line">    server  app3 127.0.0.1:5003 check</span><br><span class="line">    server  app4 127.0.0.1:5004 check</span><br></pre></td></tr></table></figure>



<p>配置文件结构</p>
<ul>
<li>全局配置项</li>
<li>默认配置项</li>
<li>前端配置项</li>
<li>后端配置项</li>
</ul>
<p>监听配置：通过关联前端配置想和后端配置项（frontend &amp; backend）定义一个完整代理。通常只对TCP流量有用。</p>
<h1 id="Docker-amp-Harpoxy"><a href="#Docker-amp-Harpoxy" class="headerlink" title="Docker &amp; Harpoxy"></a>Docker &amp; Harpoxy</h1><p>三台机器：  </p>
<table>
<thead>
<tr>
<th>角色</th>
<th>IP地址</th>
<th>功能</th>
</tr>
</thead>
<tbody><tr>
<td>WEB1</td>
<td>172.18.12.10</td>
<td>httpd – THIS IS WEB1…</td>
</tr>
<tr>
<td>WEB2</td>
<td>172.18.12.20</td>
<td>httpd – THIS IS WEB2…</td>
</tr>
<tr>
<td>Proxy</td>
<td>172.18.12.30</td>
<td>CentOS7 / Haproxy</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#安装docker环境</span></span><br><span class="line">yum install -y yum-utils device-mapper-persistent-data lvm2 </span><br><span class="line">yum-config-manager --add-repo https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo </span><br><span class="line">yum install docker-ce -y</span><br><span class="line">systemctl start docker</span><br><span class="line">systemctl <span class="built_in">enable</span> docker</span><br><span class="line">sudo mkdir -p /etc/docker</span><br><span class="line">sudo tee /etc/docker/daemon.json &lt;&lt;-<span class="string">'EOF'</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="string">"registry-mirrors"</span>: [<span class="string">"https://ukdws02a.mirror.aliyuncs.com"</span>]</span><br><span class="line">&#125;</span><br><span class="line">EOF</span><br><span class="line">sudo systemctl daemon-reload</span><br><span class="line">sudo systemctl restart docker</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建docker桥接网络，用于给容器分配IP地址</span></span><br><span class="line">docker network create --driver bridge --subnet=172.18.12.0/16 --gateway 172.18.1.1 mynet</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建后端站点，分别为web1和web2</span></span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web1.com --name web1 --network=mynet --ip 172.18.12.10 httpd</span><br><span class="line">docker run -e TZ=<span class="string">"Asia/Shanghai"</span> -itd -h web2.com --name web2 --network=mynet --ip 172.18.12.20 httpd</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB1..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web1:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line">sleep 1</span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"THIS IS WEB2..."</span> &gt; /root/index.html</span><br><span class="line">docker cp /root/index.html web2:/usr/<span class="built_in">local</span>/apache2/htdocs/</span><br><span class="line"></span><br><span class="line"><span class="comment">#创建代理服务器haproxy，镜像为centos7</span></span><br><span class="line"><span class="comment">#参数说明：--privilege + /usr/bin/init 是为了能够让程序以root运行，Container默认的Root只是相当于普通用户</span></span><br><span class="line"><span class="comment">#TZ		  ： 指定时区</span></span><br><span class="line"><span class="comment">#-h 	  ： 指定域名</span></span><br><span class="line"><span class="comment">#--network： 指定网络类型为我创建的网络</span></span><br><span class="line">docker run -e TZ=<span class="string">'Asia/Shanghai'</span> --privileged -itd -h haproxy.com --name myhaproxy --network=mynet --ip 172.18.12.30 centos:7 /usr/sbin/init</span><br><span class="line"></span><br><span class="line"><span class="comment">#查看是否连同</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.10'</span></span><br><span class="line"><span class="comment">#docker exec -it myhaproxy bash -c 'curl 172.18.12.20'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#安装haproxy，并配置后端节点</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'yum -y install haproxy -q'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.10:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c  <span class="string">"echo 'server web1 172.18.12.20:80 check' &gt;&gt; /etc/haproxy/haproxy.cfg"</span></span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">'systemctl restart haproxy'</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#测试</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"等待服务加载...."</span></span><br><span class="line">sleep 3</span><br><span class="line">docker <span class="built_in">exec</span> -it myhaproxy bash -c <span class="string">"echo '-------------负载均衡演示---------------' &amp;&amp; for i in &#123;1..10&#125;; do curl 172.18.12.30:5000; done"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#净化检测命令</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------开始删除配置------------"</span></span><br><span class="line">docker rm myhaproxy --force</span><br><span class="line">docker rm web1 web2 --force</span><br><span class="line">docker network rm mynet</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"------------检查是否有残留------------"</span></span><br><span class="line">docker network ls</span><br><span class="line"><span class="built_in">echo</span> -e <span class="string">" "</span></span><br><span class="line">docker ps -a</span><br><span class="line">rm /root/index.html* -rf</span><br></pre></td></tr></table></figure>



<h1 id="负载均衡结果演示"><a href="#负载均衡结果演示" class="headerlink" title="负载均衡结果演示"></a>负载均衡结果演示</h1><p><img src="https://i.loli.net/2020/03/22/nCfvmt7hi8pAEqd.png" alt="docker_haproxy_1.png"></p>

            
            <p class="more">
                <a href="../../../../http:/ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/17/Docker%E7%8E%AF%E5%A2%83%E4%B8%8B%E6%9E%84%E5%BB%BAHaProxy/" title="Docker环境下构建HaProxy">
                
                    <img class="thumbnail" src="../../../../img/default.png" data-echo="../../../../img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../../http:/ymlog.cn/2020/02/12/RIP%20&amp;%20EIGRP%20&amp;%20ISIS/">
    		RIP &amp; EIGRP &amp; ISIS
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-02-12T11:44:41.000Z">2020-02-12</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="简介"><a href="#简介" class="headerlink" title="*简介"></a>*简介</h1><p>  路由协议可以分为静态路由协议和动态路由协议，动态路由协议有两类。一类是用于内部网路互联互通的IGP协议，其中代表的有RIP、EIGRP、OSPF、ISIS等，另一类是用于区域与区域之间互通的外部网关协议，目前只有BGP。</p>
<p>  本章主要总结内部网关协议中的RIP、EIGRP和ISIS。其中RIP和EIGRP是距离矢量协议，而ISIS和OSPF同属于链路状态协议。</p>
<blockquote>
<ul>
<li>距离矢量协议：传递路由条目，网络能见度只有一跳 ——基于Bellman算法</li>
<li>链路状态协议：传递链路信息，网络能见度是整个拓扑结构——基于SPF(Short Path First)，最短路径算法</li>
</ul>
</blockquote>
<h1 id="RIP"><a href="#RIP" class="headerlink" title="RIP"></a>RIP</h1><ol>
<li>RIP使用跳数来描述一条路由的好坏，每经过一台路由器，跳数加一，当跳数为16跳的时候，这条路由就会作废。</li>
<li>RIP消息封装的时候，使用UDP，端口号是520，并且源端口和目的端口都是520</li>
<li>RIP迄今为止有三个版本，分别为：RIP1，RIP2，RIPng，目前IPv4使用的是Version2 IPV6使用的是Version RIPing。</li>
<li>RIP在Cisco设备的管理距离为120</li>
</ol>
<table>
<thead>
<tr>
<th>RIPv1</th>
<th>RIPv2</th>
</tr>
</thead>
<tbody><tr>
<td>使用广播更新路由表</td>
<td>使用组播更新路由表</td>
</tr>
<tr>
<td>有类路由协议</td>
<td>无类路由协议</td>
</tr>
<tr>
<td>不支持VLSM</td>
<td>支持VLSM</td>
</tr>
<tr>
<td>不支持手工汇总</td>
<td>支持手工汇总</td>
</tr>
<tr>
<td>不支持路由表及Tag</td>
<td>支持路由标记</td>
</tr>
<tr>
<td>更新消息中的路由条目没有Next-hop信息</td>
<td>有Next-hop信息</td>
</tr>
</tbody></table>
<p>有类路由协议更新不携带子网掩码，所以RIP宣告不能加mask，如果宣告1.1.1.0/24，最后宣告的还是1.0.0.0/8。</p>
<p>RIPv2使用的组播地址为 <strong>224.0.0.9</strong> 。</p>
<p>RIP的消息通知机制：</p>
<blockquote>
<p>RIP默认30s会从所有参与RIP的接口发出路由表信息，当180s没有收到某条路由的时候，就会判断那 条路由可能失效了，但是依旧会放在路由表里面，只是不会再给别人了，当240s都没有收到这条路由的时候，就会彻底删除。</p>
</blockquote>
<h2 id="RIP配置"><a href="#RIP配置" class="headerlink" title="RIP配置"></a>RIP配置</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/RIP%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE.png" alt="http://q5q3e2ctx.bkt.clouddn.com/RIP简单配置.png"></p>
<p>宣告RIP路由：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">router rip                  #启动RIP协议</span><br><span class="line">network 1.0.0.0         #将1.0.0.0加入到更新路由表中，将1.0.0.0所在接口也加入更新接口中</span><br><span class="line">network 192.168.12.0 </span><br><span class="line"></span><br><span class="line">#当宣告完之后，R1就可以Ping通R4了</span><br><span class="line"></span><br><span class="line">#修改RIP时间</span><br><span class="line">router rip</span><br><span class="line">timers basic 30 180 180 240     #分别是Updates、Invalid、Holddown、Flush</span><br></pre></td></tr></table></figure>



<h2 id="RIP机制"><a href="#RIP机制" class="headerlink" title="RIP机制"></a>RIP机制</h2><p>查看R1的路由表,可以发现去往R2~R4逐跳递增：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">R     2.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.12.2, 00:00:27, Ethernet0&#x2F;0</span><br><span class="line">R     3.0.0.0&#x2F;8 [120&#x2F;2] via 192.168.12.2, 00:00:27, Ethernet0&#x2F;0</span><br><span class="line">R     4.0.0.0&#x2F;8 [120&#x2F;3] via 192.168.12.2, 00:00:06, Ethernet0&#x2F;0</span><br><span class="line">#并且这里的时间也是正向计时，一到30s就重置。如果是失效的路由条目，则会经历180s和240s</span><br></pre></td></tr></table></figure>

<p>查看RIP协议相关：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip protocols</span></span><br><span class="line">--------------------------------------------------------------</span><br><span class="line">Routing Protocol is <span class="string">"rip"</span></span><br><span class="line">  Outgoing update filter list <span class="keyword">for</span> all interfaces is not <span class="built_in">set</span></span><br><span class="line">  Incoming update filter list <span class="keyword">for</span> all interfaces is not <span class="built_in">set</span></span><br><span class="line">  <span class="comment"># 每隔30s发送一次更新消息，下一次预计在14s之后。</span></span><br><span class="line">  Sending updates every 30 seconds, next due <span class="keyword">in</span> 14 seconds</span><br><span class="line">  <span class="comment"># 180s判断为down，240删除无效</span></span><br><span class="line">  Invalid after 180 seconds, hold down 180, flushed after 240 </span><br><span class="line">  Redistributing: rip</span><br><span class="line">  <span class="comment"># 默认版本</span></span><br><span class="line">  Default version control: send version 2, receive version 2</span><br><span class="line">  <span class="comment"># 配置接口</span></span><br><span class="line">    Interface             Send  Recv  Triggered RIP  Key-chain</span><br><span class="line">    Ethernet0/0           2     2                                    </span><br><span class="line">    Loopback0             2     2                                    </span><br><span class="line">    Interface             Send  Recv  Triggered RIP  Key-chain</span><br><span class="line">  <span class="comment"># 自动网络汇总生效，会将所有子网划分的地址汇总为主类，主类就是子网掩码按照ABC类来</span></span><br><span class="line">  Automatic network summarization is <span class="keyword">in</span> effect</span><br><span class="line">  <span class="comment"># 最大负载均衡为4</span></span><br><span class="line">  Maximum path: 4</span><br><span class="line">  <span class="comment"># 已经宣告的路由，这里也可以看出我们宣告的1.1.1.0变成了1.0.0.0，不加子网掩码</span></span><br><span class="line">  Routing <span class="keyword">for</span> Networks:</span><br><span class="line">    1.0.0.0</span><br><span class="line">    192.168.12.0</span><br><span class="line">  <span class="comment"># 路由信息来源 上一次更新时间是累加的，到30s刷新，和上面的预计14s形成呼应</span></span><br><span class="line">  Routing Information Sources:</span><br><span class="line">    Gateway         Distance      Last Update   <span class="comment">#16s之前更新过</span></span><br><span class="line">    192.168.12.2         120      00:00:16</span><br><span class="line">  <span class="comment">#默认管理距离为120</span></span><br><span class="line">  Distance: (default is 120)</span><br></pre></td></tr></table></figure>



<p>关于RIP的30s、180s、240s，这里shutdown了R4的e0/0接口，在R3上观察现象，之后R3删除后，才会反应到R1上：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#R3 -- 180的down</span></span><br><span class="line">R     1.0.0.0/8 [120/2] via 192.168.23.2, 00:00:21, Ethernet0/0</span><br><span class="line">R     2.0.0.0/8 [120/1] via 192.168.23.2, 00:00:21, Ethernet0/0</span><br><span class="line">R     4.0.0.0/8 [120/1] via 192.168.34.4, 00:01:32, Ethernet0/1</span><br><span class="line">R     192.168.12.0/24 [120/1] via 192.168.23.2, 00:00:21, Ethernet0/0</span><br><span class="line"><span class="comment">#R3 -- 240s后，R1、R2、R3的4.4.4.0都被删除了</span></span><br><span class="line">R     1.0.0.0/8 [120/2] via 192.168.23.2, 00:00:16, Ethernet0/0</span><br><span class="line">R     2.0.0.0/8 [120/1] via 192.168.23.2, 00:00:16, Ethernet0/0</span><br><span class="line">R     4.0.0.0/8 is possibly down, routing via 192.168.34.4, Ethernet0/1</span><br><span class="line">R     192.168.12.0/24 [120/1] via 192.168.23.2, 00:00:16, Ethernet0/0</span><br></pre></td></tr></table></figure>





<h2 id="RIP汇总"><a href="#RIP汇总" class="headerlink" title="RIP汇总"></a>RIP汇总</h2><p>RIP的自动汇总功能总是打开的，我们可以手动关闭：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">R1(config-router)#no auto-summary</span><br><span class="line">int lo1</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo2</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo3</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">router rip</span><br><span class="line">net 172.16.1.0</span><br><span class="line">net 172.16.2.0</span><br><span class="line">net 172.16.3.0</span><br><span class="line"></span><br><span class="line">#当完成这一切，在R2的路由表上可以看到</span><br><span class="line">R        172.16.1.0 [120&#x2F;1] via 192.168.12.1, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.2.0 [120&#x2F;1] via 192.168.12.1, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.3.0 [120&#x2F;1] via 192.168.12.1, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line"></span><br><span class="line">#现在在R1的出接口对路由进行汇总</span><br><span class="line">R1(config)#int e0&#x2F;0</span><br><span class="line">R1(config-if)#ip summary-address rip 172.16.0.0 255.255.0.0 </span><br><span class="line"></span><br><span class="line">#之后再看R2的路由表，就会发现RIP好慢，明细路由还是要经历180-240的过程C：</span><br><span class="line">      172.16.0.0&#x2F;16 is variably subnetted, 4 subnets, 2 masks</span><br><span class="line">R        172.16.0.0&#x2F;16 [120&#x2F;1] via 192.168.12.1, 00:00:22, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.1.0&#x2F;24 [120&#x2F;1] via 192.168.12.1, 00:00:52, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.2.0&#x2F;24 [120&#x2F;1] via 192.168.12.1, 00:00:52, Ethernet0&#x2F;0</span><br><span class="line">R        172.16.3.0&#x2F;24 [120&#x2F;1] via 192.168.12.1, 00:00:52, Ethernet0&#x2F;0</span><br></pre></td></tr></table></figure>



<p>不得不介绍一下清理路由表的办法了，RIP实在是太慢了： <code>clear ip route *</code> 。</p>
<h2 id="RIP认证"><a href="#RIP认证" class="headerlink" title="RIP认证"></a>RIP认证</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R1(config)#key chain Cisco                              &#x2F;&#x2F;设置钥匙的名字               </span><br><span class="line">R1(config-keychain)#key 1                                   &#x2F;&#x2F;第一把钥匙</span><br><span class="line">R1(config-keychain-key)#key-string Cisco1 &#x2F;&#x2F;第一把钥匙的内容</span><br><span class="line">R1(config-keychain-key)#key 2</span><br><span class="line">R1(config-keychain-key)#key-string Cisco2           </span><br><span class="line"></span><br><span class="line">R1(config-keychain-key)#int e0&#x2F;0                                                &#x2F;&#x2F;在接口上配置加密</span><br><span class="line">R1(config-if)#ip rip authentication key-chain Cisco         &#x2F;&#x2F;用钥匙Cisco给RIP的加密</span><br><span class="line">R1(config-if)#ip rip authentication mode md5                        &#x2F;&#x2F;加密格式为md5，也可以明文加密</span><br></pre></td></tr></table></figure>

<p>当在R1上配置完认证之后，就会发现R2在R1上学到的条目进入了 <code>180-240</code> 的过程。此时R2已经不能学习到R1的路由条目了，除非在R2上也配置认证。</p>
<p>Key-chain的其他配置</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R2(config-keychain-key)#?</span><br><span class="line">Key-chain key configuration commands:</span><br><span class="line">  accept-lifetime          Set accept lifetime of key</span><br><span class="line">  cryptographic-algorithm  Set cryptographic authentication algorithm</span><br><span class="line">  default                  Set a command to its defaults</span><br><span class="line">  exit                     Exit from key-chain key configuration mode</span><br><span class="line">  key-string               Set key string</span><br><span class="line">  no                       Negate a command or set its defaults</span><br><span class="line">  send-lifetime            Set send lifetime of key</span><br></pre></td></tr></table></figure>





<h2 id="RIP防环"><a href="#RIP防环" class="headerlink" title="RIP防环"></a>RIP防环</h2><ol>
<li>定义最大跳数，一个路由最远可以到15跳的地方，如果是16跳，就会认为不可达</li>
<li>水平分割，如果从接口上收到某条路由的更新，那么就不会将该路由再发回去</li>
<li>毒性逆转，和水平分隔矛盾，只能二选一，如果从接口上收到某路由的更新，那么就立即从收到的接口将该路由发回去，但是跳数是16，这样就不会从这个方向去学习路由了。</li>
<li>毒性路由，如果某个接口down了，就会立即更新该接口的网段，但是跳数是16，这样邻居收到后就立即删除</li>
<li>抑制计时器，180s没有收到路由更新就会判断可能失效，240s没有收到就会直接删除</li>
<li>触发更新，如果路由发生了变化，立即进行更新而不用等待30s</li>
</ol>
<p>毒性路由实验：shutdownR4的lo0接口，然后在R3上观察现象</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">#R3</span><br><span class="line">R     1.0.0.0&#x2F;8 [120&#x2F;2] via 192.168.23.2, 00:00:01, Ethernet0&#x2F;0</span><br><span class="line">R     2.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.23.2, 00:00:01, Ethernet0&#x2F;0</span><br><span class="line">R     4.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.34.4, 00:00:18, Ethernet0&#x2F;1</span><br><span class="line"></span><br><span class="line">R4(config-if)#shutdown</span><br><span class="line"></span><br><span class="line">R     1.0.0.0&#x2F;8 [120&#x2F;2] via 192.168.23.2, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line">R     2.0.0.0&#x2F;8 [120&#x2F;1] via 192.168.23.2, 00:00:02, Ethernet0&#x2F;0</span><br><span class="line"></span><br><span class="line">#竟然只用了几秒钟中就反应过来了。</span><br></pre></td></tr></table></figure>



<h2 id="RIP命令"><a href="#RIP命令" class="headerlink" title="RIP命令"></a>RIP命令</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">router rip                                                  #启动RIP协议</span><br><span class="line">    version 2</span><br><span class="line">    network 1.1.1.0                         #将1.0.0.0加入到更新路由表中，将1.0.0.0所在接口也加入更新接口中</span><br><span class="line">    timers basic 30 180 180 240             #分别是Updates、Invalid、Holddown、Flush</span><br><span class="line">    no auto-summary                                     #关闭自动汇总</span><br><span class="line"></span><br><span class="line"> #手动汇总</span><br><span class="line">(config-if)# ip summary-address rip 172.16.0.0 255.255.0.0 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">认证配置：</span><br><span class="line">key chain NAME                              #设置钥匙的名字  </span><br><span class="line">key 1                                               #第一把钥匙</span><br><span class="line">key-string STRING                       #第一把钥匙的内容</span><br><span class="line"></span><br><span class="line">int e0&#x2F;0                                            #在接口上配置</span><br><span class="line">ip rip authentication key-chain NAME        #用钥匙给RIP的加密</span><br><span class="line">ip rip authentication mode md5                  #加密格式为md5，也可以明文加密</span><br></pre></td></tr></table></figure>





<h1 id="EIGRP"><a href="#EIGRP" class="headerlink" title="EIGRP"></a>EIGRP</h1><p>增强型内部网关路由选择协议(Enhanced Interior Gateway Routing protocol,EIGRP)</p>
<p>EIGRP协议的特点：</p>
<ul>
<li><p>EIGRP有自治系统，一个EIGRP网络，必须所有的路由器都属于同一个自治系统才可以传递路由。</p>
</li>
<li><p>EIGRP使用DUAL扩散更新算法来保障无环路最优路径计算</p>
</li>
<li><p>是无类路由协议，每个路由条目都包含子网掩码</p>
</li>
<li><p>传输模块RTP（Reliable Transport Protocol），使用组播224.0.0.10</p>
</li>
<li><p>EIGRP的非周期、有边界、和部分；非周期：只在度量和网络拓扑变化时才更新，部分：只发送变化的路由条目，有边界：更新仅发给受影响的路由</p>
</li>
<li><p>更新消息直接存放于IP包头之后，所有没有传输层。在IP包头协议字段中用88表示。</p>
</li>
<li><p>管理距离在Cisco设备上有三种，分别是5,90,170</p>
</li>
<li><p>EIGRP的更新是可靠传输的，任何一个给邻居的路由信息都必须得到邻居的确认。</p>
</li>
<li><p>EIGRP的度量值(Metric)计算会包含：带宽(Bandwidth)、延迟(delay)、可靠性(reliability)、负载(loading)、最大传输单元(MTU)</p>
</li>
</ul>
<p>EIGRP的数据报：</p>
<ul>
<li>Hello，用于邻居的发现和恢复，Hello数据报使用组播方式发送，而且使用不可靠的发送方式</li>
<li>ACK，是不包含数据的Hello数据报，ACK总是用单播方、不可靠的发送方式</li>
<li>Update，传递路由更新信息，仅传递给有需要的路由，单台路由单播发送，多台路由组播发送</li>
<li>Query &amp; Reply，查询和答复，是DUAL用来管理它的扩散计算的</li>
</ul>
<h2 id="EIGRP三张表"><a href="#EIGRP三张表" class="headerlink" title="EIGRP三张表"></a>EIGRP三张表</h2><p>1、邻居表</p>
<p>​    EIGRP路由器在启动之后，就会每隔5秒钟，发送一个hello消息，且从任何接口的222.0.0.10组播地址收到hello，就会立即将对方加入到自己的邻居表</p>
<p>​    邻居表中的邻居都会有一个死亡事假你，是3倍hello消息间隔，每次收到邻居的hello都会重置死亡计时器，死亡计时器一旦到零，就会直接删除和这个邻居有关的一切路由信息。</p>
<p>查看EIGRP的邻居表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#show ip eigrp neighbors </span></span><br><span class="line">EIGRP-IPv4 Neighbors <span class="keyword">for</span> AS(100)</span><br><span class="line">												    平均往返时间</span><br><span class="line">H   Address                 Interface              Hold Uptime   SRTT   RTO  Q  Seq</span><br><span class="line">                                                   (sec)         (ms)       Cnt Num</span><br><span class="line">1   192.168.15.5            Et0/1                    11 00:01:03 1280  5000  0  8</span><br><span class="line">0   192.168.12.2            Et0/0                    10 00:02:24    9   100  0  15</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">Hold Uptime：</span><br><span class="line">SRTT：平均往返时间</span><br><span class="line">RTO：重传计时，基于SRTT</span><br><span class="line">QCnt：重传队列</span><br><span class="line">SeqNum：</span><br></pre></td></tr></table></figure>



<p>度量值Metric计算</p>
<p>2、拓扑表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh ip eigrp topology </span></span><br><span class="line">EIGRP-IPv4 Topology Table <span class="keyword">for</span> AS(100)/ID(1.1.1.1)</span><br><span class="line">Codes: P - Passive, A - Active, U - Update, Q - Query, R - Reply,</span><br><span class="line">       r - reply Status, s - sia Status </span><br><span class="line"></span><br><span class="line">P 192.168.23.0/24, 1 successors, FD is 307200</span><br><span class="line">        via 192.168.12.2 (307200/281600), Ethernet0/0</span><br><span class="line">P 192.168.34.0/24, 2 successors, FD is 332800</span><br><span class="line">        via 192.168.12.2 (332800/307200), Ethernet0/0</span><br><span class="line">        via 192.168.15.5 (332800/307200), Ethernet0/1</span><br><span class="line">P 192.168.12.0/24, 1 successors, FD is 281600</span><br><span class="line">        via Connected, Ethernet0/0</span><br><span class="line">P 5.5.5.0/24, 1 successors, FD is 409600</span><br><span class="line">        via 192.168.15.5 (409600/128256), Ethernet0/1</span><br><span class="line">P 192.168.45.0/24, 1 successors, FD is 307200</span><br><span class="line">        via 192.168.15.5 (307200/281600), Ethernet0/1</span><br><span class="line">P 2.2.2.0/24, 1 successors, FD is 409600</span><br><span class="line">        via 192.168.12.2 (409600/128256), Ethernet0/0</span><br><span class="line">P 3.3.3.0/24, 1 successors, FD is 435200</span><br><span class="line">        via 192.168.12.2 (435200/409600), Ethernet0/0</span><br><span class="line">P 192.168.15.0/24, 1 successors, FD is 281600</span><br><span class="line">        via Connected, Ethernet0/1</span><br><span class="line">P 1.1.1.0/24, 1 successors, FD is 128256</span><br><span class="line">        via Connected, Loopback0</span><br><span class="line">P 4.4.4.0/24, 1 successors, FD is 435200</span><br><span class="line">        via 192.168.15.5 (435200/409600), Ethernet0/1</span><br><span class="line"></span><br><span class="line"><span class="comment">#拓扑表中记录了每个目的地的相关信息，比如后继路由器、可行 后继路由器、可行距离、通告距离。</span></span><br><span class="line"><span class="comment">#FD：可行距离(Feasible Distance),到达目的地的最小度量值就是可行距离,类似Metric</span></span><br><span class="line"><span class="comment">#FC：可行性条件(Feasibility Condition)，邻居比自己的FD小</span></span><br><span class="line"><span class="comment">#FS：可行性后继路由器(Feasible Successor)，满足FC后，这个邻居就会变成该网络的可行后继路由器</span></span><br><span class="line"><span class="comment">#通告距离：就是去往这个目的地的下一跳到目的地的度量值，相当于邻居表到这个目的地的度量值</span></span><br></pre></td></tr></table></figure>

<p>当拓扑表中最佳后继路由器失效了，会导致EIGRP向所有的邻居发起查询，并且会将邻居标记为（q）</p>
<p>如果3分钟内，邻居都没有任何形式的回复，那么就会主动断开和这个邻居的关系</p>
<p>3、EIGRP路由表</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#show ip route eigrp </span></span><br><span class="line">		 2.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        2.2.2.0 [90/409600] via 192.168.12.2, 00:10:49, Ethernet0/0</span><br><span class="line">      3.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        3.3.3.0 [90/435200] via 192.168.12.2, 00:08:41, Ethernet0/0</span><br><span class="line">      4.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        4.4.4.0 [90/435200] via 192.168.15.5, 00:08:41, Ethernet0/1</span><br><span class="line">      5.0.0.0/24 is subnetted, 1 subnets</span><br><span class="line">D        5.5.5.0 [90/409600] via 192.168.15.5, 00:09:29, Ethernet0/1</span><br><span class="line">D     192.168.23.0/24 [90/307200] via 192.168.12.2, 00:10:29, Ethernet0/0</span><br><span class="line">D     192.168.34.0/24 [90/332800] via 192.168.15.5, 00:08:43, Ethernet0/1</span><br><span class="line">                      [90/332800] via 192.168.12.2, 00:08:43, Ethernet0/0</span><br><span class="line">D     192.168.45.0/24 [90/307200] via 192.168.15.5, 00:09:29, Ethernet0/1</span><br><span class="line">[AD/FD]</span><br><span class="line"><span class="comment">#eigrp的管理距离</span></span><br><span class="line">内部路由：90</span><br><span class="line">外部路由：170</span><br><span class="line">汇总路由：5</span><br></pre></td></tr></table></figure>

<p>metric maximum hops 102 修改最大跳数</p>
<p>路由汇总 – 在路由出口手动汇总</p>
<p>EIGRP的自动汇总默认是关闭着的，无论是手动汇总还是自动汇总都会影响本地路由表，这个条目管理距离为5，并且吓一跳距离为NULL0，NULL0和loopback一样，都是软件模拟出来的接口，不过Loopback在通信过程中会正常响应，而NULL0会将数据直接丢弃不会回复，等于NULL0就是黑洞。</p>
<p>汇总的时候产生的NULL0是为了尽快结束路由查找，因为汇总丢失了明细，所以当出现路由访问的时候，明细路由应该优先形成匹配，如果明细路由没有被匹配上，说明地址不存在，可以直接丢弃。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">ip summary-address eigrp 100 172.16.0.0 255.255.0.0</span><br><span class="line">no auto-summary</span><br></pre></td></tr></table></figure>



<h2 id="EIGRP的配置"><a href="#EIGRP的配置" class="headerlink" title="EIGRP的配置"></a>EIGRP的配置</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/EIGRP%E7%AE%80%E5%8D%95%E9%85%8D%E7%BD%AE.png" alt="http://q5q3e2ctx.bkt.clouddn.com/EIGRP简单配置.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">R1(config-if)<span class="comment">#router eigrp 100						</span></span><br><span class="line">R1(config-router)<span class="comment">#network 192.168.12.0 0.0.0.255</span></span><br><span class="line">R1(config-router)<span class="comment">#network 1.1.1.0 0.0.0.255</span></span><br><span class="line"></span><br><span class="line">EIGRP是无类路由，宣告加上通配符掩码可以保留子网掩码</span><br><span class="line">R1(config-router)<span class="comment">#do sh run | sec eigrp </span></span><br><span class="line">router eigrp 100</span><br><span class="line"> network 1.1.1.0 0.0.0.255</span><br><span class="line"> network 192.168.12.0</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bandwidth 9000 <span class="comment">#设置带宽</span></span><br><span class="line">delay 999      <span class="comment">#设置延迟</span></span><br></pre></td></tr></table></figure>



<h2 id="EIGRP的认证"><a href="#EIGRP的认证" class="headerlink" title="EIGRP的认证"></a>EIGRP的认证</h2><p>key-chain配置和RIP一样，剩下的是套在接口上，这里我们配置R3-R4的EIGRP认证</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">R3(config-keychain)<span class="comment">#int e0/1</span></span><br><span class="line">R3(config-if)<span class="comment">#ip authentication key-chain eigrp 100 Cisco</span></span><br><span class="line">R3(config-if)<span class="comment">#ip authentication mode eigrp 100 md5</span></span><br></pre></td></tr></table></figure>

<p>把R5任意接口down掉，此时发现，R3<code>ping</code> R4的e0/0接口还是能<code>ping</code>通，我一度以为是认证对EIGRP无效，搞了半天，才发现他们是直连，C。接着R1<code>ping</code>R4就<code>ping</code>不通了。</p>
<h2 id="EIGRP的汇总"><a href="#EIGRP的汇总" class="headerlink" title="EIGRP的汇总"></a>EIGRP的汇总</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">int lo1</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">int lo2</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">int lo3</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">router eigrp 100</span><br><span class="line">network 172.16.1.0 0.0.0.255</span><br><span class="line">network 172.16.2.0 0.0.0.255</span><br><span class="line">network 172.16.3.0 0.0.0.255</span><br><span class="line">int e0/0</span><br><span class="line">ip summary-address eigrp 100 172.16.0.0 255.255.0.0</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#EIGRP默认开启自动汇总</span></span><br><span class="line">R5<span class="comment">#show ip route eigrp</span></span><br></pre></td></tr></table></figure>



<p><strong>汇总前：</strong></p>
<pre><code>172.16.0.0/24 is subnetted, 3 subnets
    D        172.16.1.0 [90/409600] via 192.168.15.1, 00:01:13, Ethernet0/0
  D        172.16.2.0 [90/409600] via 192.168.15.1, 00:01:13, Ethernet0/0
  D        172.16.3.0 [90/409600] via 192.168.15.1, 00:01:13, Ethernet0/0</code></pre><p><strong>汇总后：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">R2<span class="comment">#show ip route eigrp</span></span><br><span class="line">      172.16.0.0/16 is variably subnetted, 4 subnets, 2 masks</span><br><span class="line">D        172.16.0.0/16 [90/409600] via 192.168.12.1, 00:00:35, Ethernet0/0</span><br><span class="line">D        172.16.1.0/24 [90/486400] via 192.168.23.3, 00:00:35, Ethernet0/1</span><br><span class="line">D        172.16.2.0/24 [90/486400] via 192.168.23.3, 00:00:35, Ethernet0/1</span><br><span class="line">D        172.16.3.0/24 [90/486400] via 192.168.23.3, 00:00:35, Ethernet0/1</span><br></pre></td></tr></table></figure>



<p>会发现，即使是汇总，和R1相邻的路由器上也可以收到明细路由，但是R3等不和R1相邻的路由器上，就只能收到汇总后的路由。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">D     172.16.0.0/16 [90/435200] via 192.168.23.2, 00:00:02, Ethernet0/0</span><br></pre></td></tr></table></figure>





<h2 id="EIGRP–FD值"><a href="#EIGRP–FD值" class="headerlink" title="EIGRP–FD值"></a>EIGRP–FD值</h2><p>修改EIGRP的AD值和FD值，可以通过掉接口的带宽和延迟做到。</p>
<p>现在可以看到R1去往34网段负载均衡，我们现在想让R1只从R2走，所以这里调高R1的e0/1接口的带宽和延迟，接口的带宽和延迟可以用<code>show interfaces e0/1</code>查看。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#R1路由表</span></span><br><span class="line">D     192.168.34.0/24 [90/332800] via 192.168.15.5, 00:00:17, Ethernet0/1</span><br><span class="line">                      [90/332800] via 192.168.12.2, 00:00:17, Ethernet0/0</span><br><span class="line"></span><br><span class="line"><span class="comment">#R1拓扑表</span></span><br><span class="line">P 192.168.34.0/24, 2 successors, FD is 332800</span><br><span class="line">        via 192.168.12.2 (332800/307200), Ethernet0/0</span><br><span class="line">        via 192.168.15.5 (332800/307200), Ethernet0/1</span><br></pre></td></tr></table></figure>



<p>调整带宽，如果是在接口下修改，可能会影响多条路径，建议使用偏移列表offset-set。</p>
<p>offset只能增加从某个接口进入或者出去的路由</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">R1(config-if)<span class="comment">#bandwidth 5000</span></span><br><span class="line"></span><br><span class="line">再看拓扑表：</span><br><span class="line"><span class="comment">#R1</span></span><br><span class="line">P 192.168.34.0/24, 1 successors, FD is 332800</span><br><span class="line">        via 192.168.12.2 (332800/307200), Ethernet0/0</span><br><span class="line">        via 192.168.15.5 (588800/307200), Ethernet0/1</span><br><span class="line"><span class="comment">#R1的路由表中，也只会选择从R2走了</span></span><br><span class="line"></span><br><span class="line">调整时延类似：</span><br><span class="line">R1(config-if)<span class="comment">#delay 10000</span></span><br></pre></td></tr></table></figure>



<p>时延和带宽可以影响FD，影响EIGRP度量值的五个要素：带宽(Bandwidth)、延迟(delay)、可靠性(reliability)、负载(loading)、最大传输单元(MTU)。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">FD=metric = 256 * &#123; 10^7/bw + delaysum / 10 &#125;</span><br></pre></td></tr></table></figure>





<h1 id="ISIS"><a href="#ISIS" class="headerlink" title="ISIS"></a>ISIS</h1><p>ISIS采用了 面向无连接的CLNS协议，但需要保留IP地址做ISIS的Router-ID。其中CLNP地址的写法为：</p>
<blockquote>
<p>49.0001.0000.0000.0001.00</p>
<p>49：是标志地址的作用，这里是私有地址的意思</p>
<p>0001：区域号</p>
<p>0000.0000.0001：设备ID</p>
<p>00：端口号 —NSEL</p>
</blockquote>
<p>简介</p>
<blockquote>
<p>ISIS最早不是给TCP/IP设计的，是给CLNS无连接网络设计的，但是CLNS被淘汰了。ISIS的开发者给ISIS协议加上了TCP/IP的支持模块，将其变为集成的ISIS，但是依旧不如OSPF流行，所以渐渐被人遗忘。</p>
<p>近年来云计算数据中心崛起，数据中心网络日益复杂，而OSPF的区域划分很不自由，并且OSPF是基于IP来进行信息传递的，而数据中心并不是完全的TCP/IP的网络环境，所以OSPF使用受到很大的限制。FC网络不允许浪费传输效率</p>
</blockquote>
<ul>
<li>ISIS在Cisco设备中的管理距离为115</li>
</ul>
<h2 id="ISIS配置"><a href="#ISIS配置" class="headerlink" title="ISIS配置"></a>ISIS配置</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png" alt="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png"></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">router isis							<span class="comment">#启动协议</span></span><br><span class="line">net 49.0001.0000.0000.0001.00		<span class="comment">#宣告CLNP地址</span></span><br><span class="line">int e0/0,lo0						<span class="comment">#在接口下配置ISIS</span></span><br><span class="line">ip router isis</span><br></pre></td></tr></table></figure>





<h2 id="ISIS邻居"><a href="#ISIS邻居" class="headerlink" title="ISIS邻居"></a>ISIS邻居</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">R3<span class="comment">#show isis neighbors </span></span><br><span class="line"></span><br><span class="line">System Id      Type Interface   IP Address      State Holdtime Circuit Id</span><br><span class="line">R1             L1   Et0/0       192.168.123.1   UP    22       R3.01              </span><br><span class="line">R1             L2   Et0/0       192.168.123.1   UP    27       R3.01              </span><br><span class="line">R2             L1   Et0/0       192.168.123.2   UP    22       R3.01              </span><br><span class="line">R2             L2   Et0/0       192.168.123.2   UP    26       R3.01              </span><br><span class="line">R4             L2   Et0/1       192.168.34.4    UP    9        R4.01</span><br></pre></td></tr></table></figure>



<p>ISIS的Hello包正常情况下，10s一次，30s没收到就判定死亡。ISIS有指定路由器的概念，但是ISIS的世界中，路由器不叫路由器，而叫中间系统，所以DR就变成了DIS</p>
<p>DIS的Hello包是3.3s一次，10s没收到就判定DIS死亡，剩下的路由器会重新选举一台路由器作为DIS。</p>
<p>DIS没有备份的概念，谁都可以随时抢占。DIS会优先判定优先级，优先级为0的设备，依旧可以做DIS。</p>
<p>DIS在优先级一样的情况下，会通过比较MAC地址数值大小，越打越优。</p>
<h2 id="ISIS角色"><a href="#ISIS角色" class="headerlink" title="ISIS角色"></a>ISIS角色</h2><ol>
<li><p>Level-1 Router：</p>
<blockquote>
<p> 区域内部路由器，用来在区域内部学习和交换LSP（相当于OSPF的LSA）</p>
<p> L1路由器只能和L1或者L12路由器建立邻居</p>
<p> L1路由器可以知道整个区域的拓扑，但是其他区域连路由都学不到，通过默认路由离开这个区域</p>
</blockquote>
</li>
<li><p>Level-2 Router</p>
<blockquote>
<p>区域间路由器，用来在区域间传递LSP信息</p>
<p>L2路由器只能和L2或者L12路由器建立邻居</p>
<p>L2路由器知道整个AS的区域情况，可以学习到每个区域的路由条目</p>
</blockquote>
</li>
<li><p>Level-1-2 Router</p>
<blockquote>
<p>用来将L1和L2路由器相连，一般是区域边界路由器（相当于OSPF的ABR）</p>
<p>L12路由器可以和L1和L2建立邻居</p>
<p>L12路由器拥有L1和L2所有的能力</p>
<p>默认情况下，路由器启动ISIS后，就是L12路由器</p>
<p>L12路由器会给L1路由器下发一个默认路由</p>
</blockquote>
</li>
</ol>
<p>L1邻居关系</p>
<ul>
<li>同一个区域才可以建立L1邻居关系</li>
</ul>
<p>L2邻居关系</p>
<ul>
<li>不管是不是一个区域，都可以建立L2邻居关系</li>
</ul>
<p>由于ISIS路由器默认是L12路由器，相当于同时开启L1和L2，所以会建立两个邻居关系。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改ISIS当前路由器的角色</span></span><br><span class="line">is-type level-1</span><br><span class="line"></span><br><span class="line"><span class="comment">#或者在接口上修改邻居类型</span></span><br><span class="line">isis circuit-type level-1</span><br></pre></td></tr></table></figure>



<p>在ISIS数据库中，1200s倒计时，每900s一次泛洪。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">R1<span class="comment">#sh isis database level-1</span></span><br><span class="line">IS-IS Level-1 Link State Database:</span><br><span class="line">LSPID                 LSP Seq Num  LSP Checksum  LSP Holdtime      ATT/P/OL</span><br><span class="line">R1.00-00            * 0x00000008   0x1564        785               1/0/0</span><br><span class="line">R2.00-00              0x00000009   0xC590        1062              1/0/0</span><br><span class="line">R3.00-00              0x00000008   0x50F3        1105              1/0/0</span><br><span class="line">R3.01-00              0x00000003   0x734B        740               0/0/0</span><br><span class="line">R4.00-00              0x00000006   0x83FE        75                1/0/0</span><br><span class="line">R4.01-00              0x00000002   0xBA8F        123               0/0/0</span><br><span class="line">R4.02-00              0x00000002   0x9AAF        64                0/0/0</span><br></pre></td></tr></table></figure>



<p>ATT：如果这个被写为1，说明必须产生一条默认路由指向这个路由器</p>
<p>P：如果L2或者L12路由器链断开，可以使用带P置为的LSP数据进行打通</p>
<p>OL：overload，以前的路由器性能不佳，会超载。但是现在OL被利用来作为故障修复，设备升级的时候的故障路标。</p>
<p>我们会发现R3收到了两个LSP，那个<code>R3.00-00</code>是本体，<code>R3.01-00</code>是PSN（伪节点）发来的。</p>
<p><code>show isis database detail</code></p>
<h2 id="ISIS汇总"><a href="#ISIS汇总" class="headerlink" title="ISIS汇总"></a>ISIS汇总</h2><p>路由器汇总只能做在区域边界的L1/L2或者L2路由器上，并且只能汇总自己这个区域的。</p>
<p>R5：添加环回口<code>lo1~lo3</code>，并且添加到isis进行路由汇总</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">Loopback1                  172.16.1.1      YES manual up                    up</span><br><span class="line">Loopback2                  172.16.2.1      YES manual up                    up</span><br><span class="line">Loopback3                  172.16.3.1      YES manual up                    up</span><br><span class="line">R5(config-router)<span class="comment">#int range lo1 -3</span></span><br><span class="line">R5(config-if-range)<span class="comment">#ip router isis</span></span><br><span class="line">R5(config-if-range)<span class="comment">#router isis</span></span><br><span class="line">R5(config-router)<span class="comment"># summary-address 172.16.0.0 255.255.0.0</span></span><br></pre></td></tr></table></figure>



<h2 id="ISIS其他"><a href="#ISIS其他" class="headerlink" title="ISIS其他"></a>ISIS其他</h2><p><strong>ISIS度量值</strong>本来是衡量4个数值，但是目前来说，一个也不支持，所以当前的集成ISIS度量值可以理解为跳数，没经过一个入口，路由metric + 10；</p>
<p><strong>ISIS默认路由注入</strong>，<code>default-information originate</code>，这个命令只有在L1/L2或者L2路由器上有效。ISIS的L1/2路由器默认会给L1路由器下发默认路由，通过数据库ATT位置来通知的。可以在L2或者L1/2路由器上配置默认路由器来影响其他L1/2或者L2路由器。默认路由需要在ISIS下宣告。</p>
<h2 id="ISIS命令"><a href="#ISIS命令" class="headerlink" title="ISIS命令"></a>ISIS命令</h2><p><img src="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png" alt="http://q5q3e2ctx.bkt.clouddn.com/image-20200215102028992.png"></p>
<ol>
<li>R1<code>ping</code>R5</li>
<li>在R5上创建lo1-3：172.16.x.1/24，并且通告金isis，level-2，要求R4学到的是汇总的条目</li>
<li>在R5上下发默认路由，让所有的路由器都可以学习到，并且可以ping同R5没有被宣告的100.1.1.1/24 lo100的地址。</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#R1</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.0001.0000.0000.0001.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 1.1.1.1 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.123.1 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis  </span><br><span class="line"> </span><br><span class="line"><span class="comment">#R2 </span></span><br><span class="line">router isis</span><br><span class="line">	net 49.0001.0000.0000.0002.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 2.2.2.2 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.123.2 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip address 192.168.24.2 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line"> </span><br><span class="line"><span class="comment">#R3</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.0001.0000.0000.0003.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 3.3.3.3 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.123.3 255.255.255.0</span><br><span class="line"> no shutdown </span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip address 192.168.34.3 255.255.255.0</span><br><span class="line"> no shutdown </span><br><span class="line"> ip router isis</span><br><span class="line"> </span><br><span class="line"><span class="comment">#R4</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.00020000.0000.0004.00 </span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 4.4.4.4 255.255.255.0</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.34.4 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/1</span><br><span class="line"> ip address 192.168.24.4 255.255.255.0</span><br><span class="line"> no shutdown </span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/2</span><br><span class="line"> ip address 192.168.45.4 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis</span><br><span class="line"> </span><br><span class="line"><span class="comment">#R5</span></span><br><span class="line">router isis</span><br><span class="line"> net 49.0003.0000.0000.0005.00</span><br><span class="line">interface Loopback0</span><br><span class="line"> ip address 5.5.5.5 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line">interface Ethernet0/0</span><br><span class="line"> ip address 192.168.45.5 255.255.255.0</span><br><span class="line"> no shutdown</span><br><span class="line"> ip router isis </span><br><span class="line"></span><br><span class="line"><span class="comment">#配置完这些R1就可以Ping通R5了</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------</span><br><span class="line"><span class="comment">#R5  --- 汇总</span></span><br><span class="line">int lo10</span><br><span class="line">ip add 172.16.1.1 255.255.255.0</span><br><span class="line">ip router isis</span><br><span class="line">int lo20</span><br><span class="line">ip add 172.16.2.1 255.255.255.0</span><br><span class="line">ip router isis</span><br><span class="line">int lo30</span><br><span class="line">ip add 172.16.3.1 255.255.255.0</span><br><span class="line">ip router isis</span><br><span class="line"></span><br><span class="line">router isis </span><br><span class="line">summary-address 172.16.0.0 255.255.0.0</span><br><span class="line"><span class="comment">#配置完这些，R4上就可以看到：</span></span><br><span class="line">i L2  172.16.0.0/16 [115/20] via 192.168.45.5, 00:00:04, Ethernet0/2</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">----------------------</span><br><span class="line"><span class="comment">#R5 --- 默认路由</span></span><br><span class="line">interface Loopback2</span><br><span class="line"> ip address 100.1.1.5 255.255.255.255</span><br><span class="line">router isis</span><br><span class="line">default-information originate</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">show isis database level-1			<span class="comment">#查看链路状态数据库</span></span><br><span class="line">show isis neighbors					<span class="comment">#查看ISIS邻居</span></span><br></pre></td></tr></table></figure>



            
            <p class="more">
                <a href="../../../../http:/ymlog.cn/2020/02/12/RIP%20&%20EIGRP%20&%20ISIS/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/02/12/RIP%20&amp;%20EIGRP%20&amp;%20ISIS/" title="RIP &amp; EIGRP &amp; ISIS">
                
                    <img class="thumbnail" src="../../../../img/default.png" data-echo="../../../../img/thumbnail/2.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../../categories/Linux/">Linux</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../../http:/ymlog.cn/2020/01/17/Linux%E6%9D%83%E9%99%90/">
    		Linux权限
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-01-17T04:42:03.000Z">2020-01-17</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <table>
<thead>
<tr>
<th>常用命令类型</th>
<th>举例</th>
</tr>
</thead>
<tbody><tr>
<td>用户</td>
<td>who, whoami, su, useradd, userdel, passwd, usermod, /etc/passwd</td>
</tr>
<tr>
<td>组</td>
<td>groupadd, groupdel, groupmod, /etc/group</td>
</tr>
<tr>
<td>文件</td>
<td>chmod, chown, chgrp</td>
</tr>
<tr>
<td>其他</td>
<td>sudo、exit</td>
</tr>
</tbody></table>
<h1 id="用户和组"><a href="#用户和组" class="headerlink" title="用户和组"></a>用户和组</h1><h2 id="用户和组的概念"><a href="#用户和组的概念" class="headerlink" title="用户和组的概念"></a>用户和组的概念</h2><p>在Linux中，用户分为管理员用户和普通用户，普通用户又分为系统用户和登录用户，每一个用户都有用户名和独一无二的用户id。管理员的用户id为0，普通用户中，系统用户的用户id为1~499，登录用户的用户id为500+。组也分为管理员组和普通用户组，不过又可以分为基本组（主组）和附加组（额外组）。基本组的组名与用户名相同，附加组是为了方便管理用户，一个用户可以有多个附加组。</p>
<p>Linux安全上下文：</p>
<blockquote>
<p>运行中的程序我们称之为进程（process），进程能够访问其所有资源的权限，取决于进程发起者身份。</p>
</blockquote>
<h2 id="相关配置文件"><a href="#相关配置文件" class="headerlink" title="相关配置文件"></a>相关配置文件</h2><p>Linux中与用户和组相关的配置文件</p>
<table>
<thead>
<tr>
<th>目录</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>/etc/passwd</td>
<td>用户及其属性信息（名称、UID、基本组ID等）</td>
</tr>
<tr>
<td>/etc/group</td>
<td>组及其属性信息</td>
</tr>
<tr>
<td>/etc/shadow</td>
<td>用户密码及其相关属性</td>
</tr>
<tr>
<td>/etc/gshadow</td>
<td>组密码及其相关属性</td>
</tr>
</tbody></table>
<p>为了方便管理属于同一组的用户，Linux 系统中还引入了用户组的概念。通过使用用户组号码（GID，Group IDentification），我们可以把多个用户加入到同一个组中，从而方便为组中的用户统一规划权限或指定任务。另外，在 Linux 系统中创建每个用户时，将自动创建一个与其同名的基本用户组，而且这个基本用户组只有该用户一个人。如果该用户以后被归纳入其他用户组，则这个其他用户组称之为扩展用户组。一个用户只有一个基本用户组，但是可以有多个扩展用户组，从而满足日常的工作需要。</p>
<h3 id="1、-etc-passwd"><a href="#1、-etc-passwd" class="headerlink" title="1、/etc/passwd"></a>1、/etc/passwd</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;passwd存放用户信息，由6个冒号组成7个信息</span><br><span class="line">1.用户名</span><br><span class="line">2.密码（x表示加密密码）</span><br><span class="line">3.UID（用户标识）</span><br><span class="line">4.GID（组标识）</span><br><span class="line">5.用户全名或本地账号</span><br><span class="line">6.家目录</span><br><span class="line">7.登录之后使用的终端命令</span><br><span class="line"></span><br><span class="line">For example:</span><br><span class="line">nginx:x:997:993:Nginx web server:&#x2F;var&#x2F;lib&#x2F;nginx:&#x2F;sbin&#x2F;nologin</span><br><span class="line">  1   2  3   4         5               6             7</span><br></pre></td></tr></table></figure>

<h3 id="2、-etc-group"><a href="#2、-etc-group" class="headerlink" title="2、/etc/group"></a>2、/etc/group</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">用户组的所有信息都存放在&#x2F;etc&#x2F;group文件中。此文件的格式是由冒号(:)隔开若干个字段，具体如下：</span><br><span class="line"></span><br><span class="line">【组名】:【口令】:【组标识号】:【组内用户列表】</span><br><span class="line">组名：是用户组的名称，由字母或数字构成，不应重复。</span><br><span class="line">口令：存放的是用户组加密后的口令字。一般Linux系统的用户组都没有口令，即这个字段一般为空或者*。</span><br><span class="line">组标识号：与用户标识号类似，也是一个整数，被系统内部用来标识组。别称GID.</span><br><span class="line">组内用户列表：是属于这个组的所有用户的列表，不同用户之间用逗号(,)分隔。</span><br><span class="line"></span><br><span class="line">如：root:x:0:</span><br></pre></td></tr></table></figure>

<h3 id="3、-etc-shadow"><a href="#3、-etc-shadow" class="headerlink" title="3、/etc/shadow"></a>3、/etc/shadow</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">root:$6$iDHbyICea.JiS60r.c0::0:99999:7:::</span><br><span class="line"></span><br><span class="line">参数一： 用户名称</span><br><span class="line">参数二： 用户加密后的密码</span><br><span class="line">参数三： 用户密码最近一次修改时间，算法是今天的时间减去jan，1，1970得到的时间间隔</span><br><span class="line">参数四： 用户最少多少天后才能改密码的天数（默认为0，表示可以在任何时间修改）</span><br><span class="line">参数五： 用户最多多少天后一定要修改密码的天数，系统会强制用户修改密码（默认为99999，改为1 也能让密码改不了）</span><br><span class="line">参数六： 过期前多少天时间会被警告（改为-1 则永远不会提示）</span><br><span class="line">参数七： 过期后多少天内账号变为inactive状态，可登陆，但不能操作</span><br><span class="line">参数八： 多少天后账号会过期，无法登陆</span><br><span class="line">参数九： 保留参数</span><br></pre></td></tr></table></figure>

<h3 id="4、-etc-gshadow"><a href="#4、-etc-gshadow" class="headerlink" title="4、/etc/gshadow"></a>4、/etc/gshadow</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&#x2F;etc&#x2F;gshadow 格式如下，每个用户组独占一行；</span><br><span class="line">groupname:password:admin,admin,…:member,member,…</span><br><span class="line">第一字段：用户组</span><br><span class="line">第二字段：用户组密码，这个段可以是空的或!，如果是空的或有!，表示没有密码；</span><br><span class="line">第三字段：用户组管理者，这个字段也可为空，如果有多个用户组管理者，用,号分割；</span><br><span class="line">第四字段：组成员，如果有多个成员，用,号分割；</span><br><span class="line"></span><br><span class="line">For example:</span><br><span class="line">						house1:!::</span><br></pre></td></tr></table></figure>



<h2 id="查看当前用户"><a href="#查看当前用户" class="headerlink" title="查看当前用户"></a>查看当前用户</h2><p>一般使用<code>who</code>命令可以查看当前用户：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 显示当前所有已登录的用户信息（包括 闲置时间, 用户状态, 各列标题）</span></span><br><span class="line">[root@experience ~]<span class="comment"># who -uTH</span></span><br><span class="line">NAME       LINE         TIME             IDLE          PID COMMENT</span><br><span class="line">root     + pts/0        2020-01-17 08:49   .          6883 (192.168.19.1)</span><br><span class="line">root     + pts/1        2020-01-17 10:36   .          7377 (192.168.19.1)</span><br></pre></td></tr></table></figure>



<h1 id="用户操作命令"><a href="#用户操作命令" class="headerlink" title="用户操作命令"></a>用户操作命令</h1><h2 id="用户"><a href="#用户" class="headerlink" title="用户"></a>用户</h2><h3 id="1、useradd-增"><a href="#1、useradd-增" class="headerlink" title="1、useradd 增"></a>1、useradd 增</h3><p>可以使用 useradd 命令创建用户账户。使用该命令创建用户账户时，默认的用户家目录会被存放在/home 目录中，默认的 Shell 解释器为/bin/bash，而且默认会创建一个与该用户同名的基本用户组</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-d</td>
<td>指定用户的家目录（默认为/home/username）</td>
</tr>
<tr>
<td>-e</td>
<td>账户的到期时间，格式为 YYYY-MM-DD</td>
</tr>
<tr>
<td>-u</td>
<td>指定该用户的默认 UID</td>
</tr>
<tr>
<td>-g</td>
<td>指定一个初始的用户基本组（必须已存在）</td>
</tr>
<tr>
<td>-G</td>
<td>指定一个或多个扩展用户组</td>
</tr>
<tr>
<td>-N</td>
<td>不创建与用户同名的基本用户组</td>
</tr>
<tr>
<td>-s</td>
<td>指定该用户的默认 Shell 解释器</td>
</tr>
</tbody></table>
<p>一旦用户的解释器被设置为-s nologin，则代表该用户不能登录到系统中,有哪些解释器可以再/etc/passwd中查看，详情请参见Linux的目录结构。</p>
<p>查看当前用户的属组和属主</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@DZQ etc]# id root</span><br><span class="line">uid&#x3D;0(root) gid&#x3D;0(root) groups&#x3D;0(root)</span><br></pre></td></tr></table></figure>


<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">For example:</span><br><span class="line">useradd -d /home/userx -g nginx user02</span><br><span class="line"><span class="meta">#</span><span class="bash">创建一个名为user02的用户，但是家文件的文件名为userx，且属主是user02，属组是nginx</span></span><br><span class="line">[root@nginxs ~]# ll -d /home/userx</span><br><span class="line">drwx------ 2 user02 nginx 62 Dec 20 00:11 /home/userx</span><br></pre></td></tr></table></figure>

<h3 id="2、userdel-删"><a href="#2、userdel-删" class="headerlink" title="2、userdel 删"></a>2、userdel 删</h3><p>删除用户时, 如果用户所属组是创建用户时自动创建的和用户名称同名的组, 并且该组内没有其他用户, 则该组也会被删掉。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">参数:</span><br><span class="line">    -f    强制删除用户, 即使用户当前已登录</span><br><span class="line">    -r    删除用户, 同时删除用户主目录。如果不加r，则在/home目录下，还会有用户目录</span><br></pre></td></tr></table></figure>



<h3 id="3、usermod-改"><a href="#3、usermod-改" class="headerlink" title="3、usermod 改"></a>3、usermod 改</h3><p>用户的信息保存在/etc/passwd 文件中，可以直接用文本编辑器来修改其中的用户参数项目，也可以用 usermod 命令修改已经创建的用户信息</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-c</td>
<td>填写用户账户的备注信息</td>
</tr>
<tr>
<td>-d  -m</td>
<td>参数-m 与参数-d 连用，可重新指定用户的家目录并自动把旧的数据转移过去</td>
</tr>
<tr>
<td>-e</td>
<td>账户的到期时间，格式为 YYYY-MM-DD</td>
</tr>
<tr>
<td>-g</td>
<td>变更所属用户组</td>
</tr>
<tr>
<td>-G</td>
<td>变更扩展用户组</td>
</tr>
<tr>
<td>-L</td>
<td>锁定用户禁止其登录系统</td>
</tr>
<tr>
<td>-U</td>
<td>解锁用户，允许其登录系统</td>
</tr>
<tr>
<td>-s</td>
<td>变更默认终端</td>
</tr>
<tr>
<td>-u</td>
<td>修改用户的 UID</td>
</tr>
</tbody></table>
<h3 id="4、passwd"><a href="#4、passwd" class="headerlink" title="4、passwd"></a>4、passwd</h3><p>当创建完用户，需要给用户添加密码，比如：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">useradd dzq </span><br><span class="line">passwd dzq</span><br><span class="line">---输入你想要的密码---</span><br><span class="line">---之后以用户dzq的身份登录---</span><br><span class="line">su - dzq</span><br><span class="line">passwd</span><br><span class="line">---输入你刚刚用root身份创建的密码，就可以修改密码了---</span><br><span class="line">---之后再次登录到系统中，就可以使用：---</span><br><span class="line">---ssh dzq@192.168.255.10---</span><br><span class="line">---密码：passwd---</span><br></pre></td></tr></table></figure>

<hr>
<h2 id="组"><a href="#组" class="headerlink" title="组"></a>组</h2><h3 id="1、groupadd"><a href="#1、groupadd" class="headerlink" title="1、groupadd"></a>1、groupadd</h3><p><strong>语法：</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupadd [-g gid [-o]] [-r] [-f] group</span><br></pre></td></tr></table></figure>

<p><strong>参数说明：</strong></p>
<ul>
<li>-g：指定新建工作组的 id；</li>
<li>-r：创建系统工作组，系统工作组的组ID小于 500；</li>
<li>-K：覆盖配置文件 “/ect/login.defs”；</li>
<li>-o：允许添加组 ID 号不唯一的工作组。</li>
<li>-f,–force: 如果指定的组已经存在，此选项将失明了仅以成功状态退出。当与 -g 一起使用，并且指定的GID_MIN已经存在时，选择另一个唯一的GID（即-g关闭）。</li>
</ul>
<p><strong>实例：</strong></p>
<p>创建一个新的组，并添加组 ID。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">＃groupadd －g 344 runoob</span><br></pre></td></tr></table></figure>



<hr>
<h3 id="2、groupmod"><a href="#2、groupmod" class="headerlink" title="2、groupmod"></a>2、groupmod</h3><p><strong>语法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupmod [-g &lt;群组识别码&gt; &lt;-o&gt;][-n &lt;新群组名称&gt;][群组名称]</span><br></pre></td></tr></table></figure>

<p><strong>参数</strong>：</p>
<ul>
<li>-g &lt;群组识别码&gt; 　设置欲使用的群组识别码。</li>
<li>-o 　重复使用群组识别码。</li>
<li>-n &lt;新群组名称&gt; 　设置欲使用的群组名称。</li>
</ul>
<p><strong>实例</strong></p>
<p>修改组名</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@runoob.com ~]<span class="comment"># groupadd linuxso </span></span><br><span class="line">[root@runoob.com ~]<span class="comment"># tail -1 /etc/group </span></span><br><span class="line">linuxso:x:500: </span><br><span class="line">[root@runoob.com ~]<span class="comment"># tail -1 /etc/group </span></span><br><span class="line">linuxso:x:500: </span><br><span class="line">[root@runoob.com ~]<span class="comment"># groupmod -n linux linuxso </span></span><br><span class="line">[root@runoob.com ~]<span class="comment"># tail -1 /etc/group </span></span><br><span class="line">linux:x:500:</span><br></pre></td></tr></table></figure>

<hr>
<h3 id="3、groupdel"><a href="#3、groupdel" class="headerlink" title="3、groupdel"></a>3、groupdel</h3><p><strong>语法：</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">groupdel [群组名称]</span><br></pre></td></tr></table></figure>



<p><strong>实例：</strong></p>
<p>删除一个群组</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"># groupdel hnuser</span><br></pre></td></tr></table></figure>



<h3 id="4、gpasswd"><a href="#4、gpasswd" class="headerlink" title="4、gpasswd"></a>4、gpasswd</h3><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>–add USER                 添加用户到组</td>
</tr>
<tr>
<td>-d</td>
<td>–delete USER             移除组中用户</td>
</tr>
<tr>
<td>-Q</td>
<td>–root CHROOT_DIR     更改组的chroot目录</td>
</tr>
<tr>
<td>-r</td>
<td>–delete-password         删除组密码</td>
</tr>
<tr>
<td>-M</td>
<td>–members USER,…        批量添加用户到组</td>
</tr>
<tr>
<td>-A</td>
<td>–administrators ADMIN,…设置组管理员</td>
</tr>
</tbody></table>
<h1 id="执行管理员权限"><a href="#执行管理员权限" class="headerlink" title="执行管理员权限"></a>执行管理员权限</h1><p>这里把执行管理员权限分为三种方式，分别是：直接切换管理员账户、临时使用管理员权限、将管理员权限写入到配置文件。</p>
<h2 id="1、su-切换用户"><a href="#1、su-切换用户" class="headerlink" title="1、su - 切换用户"></a>1、su - 切换用户</h2><p>使用<code>su</code>命令可以切换用户，在没有参数的情况下调用时，su默认以root的身份运行一个交互式的shell。对于向后兼容性，su默认不改变当前目录，只设置环境变量HOME和SHELL(如果目标不是root，则加上USER和LOGNAME)。</p>
<p>这个版本的su使用PAM作为认证、账户和会话管理。在其他su实验中发现一些配置选项（例如：对轮组的支持）必须通过PAM进行配置</p>
<p><code>su</code> 后面加上 “-” 表示完全切换到新用户，即把环境变量信息也变更为新用户相应信息。如果没有指明用户名，则切换到root，如：su</p>
<h2 id="2、sudo-临时权限"><a href="#2、sudo-临时权限" class="headerlink" title="2、sudo - 临时权限"></a>2、sudo - 临时权限</h2><p>sudo 命令用于给普通用户提供额外的权限来完成原本 root 管理员才能完成的任务，格式为“sudo [参数] 命令名称”</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-h</td>
<td>列出帮助信息</td>
</tr>
<tr>
<td>-l</td>
<td>列出当前用户可执行的命令</td>
</tr>
<tr>
<td>-u</td>
<td>用户名或 UID 值 以指定的用户身份执行命令</td>
</tr>
<tr>
<td>-k</td>
<td>清空密码的有效时间，下次执行 sudo 时需要再次进行密码验证</td>
</tr>
<tr>
<td>-b</td>
<td>在后台执行指定的命令</td>
</tr>
<tr>
<td>-p</td>
<td>更改询问密码的提</td>
</tr>
</tbody></table>
<h2 id="3、修改配置文件"><a href="#3、修改配置文件" class="headerlink" title="3、修改配置文件"></a>3、修改配置文件</h2><p>配置文件  /etc/sudoers ,只有root管理员才可以使用visudo命令编辑sudo服务配置文件。visudo禁止多个用户同时修改配置sudoers文件。进入普通用户时，还是需要sudo才可以执行相关权限。</p>
<p>第一步：vim /etc/sudoers，将第99行左右的位置，添加想要赋予权限的用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># sed '99,102p' -n /etc/sudoers</span></span><br><span class="line"><span class="comment">## Allow root to run any commands anywhere </span></span><br><span class="line">root	ALL=(ALL) 	ALL</span><br><span class="line">NIKI    ALL=(ALL)   ALL</span><br><span class="line"><span class="comment">## Allows members of the 'sys' group to run networking, software,</span></span><br></pre></td></tr></table></figure>

<p>第二步：登录普通用户</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># su - NIKI</span></span><br><span class="line">Last login: Mon Aug 12 01:26:04 EDT 2019 on pts/0</span><br></pre></td></tr></table></figure>

<p>第三部：sudo -l，这里填的密码是NIKI用户自己的密码</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[NIKI@localhost ~]$ sudo -l</span><br><span class="line">[sudo] password <span class="keyword">for</span> NIKI: </span><br><span class="line">Sorry, try again.</span><br><span class="line">[sudo] password <span class="keyword">for</span> NIKI: </span><br><span class="line">----------------------</span><br><span class="line">User NIKI may run the following commands on localhost:</span><br><span class="line">    (ALL) ALL</span><br></pre></td></tr></table></figure>

<p>第四步：显示</p>
<ul>
<li><p>不用sudo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[NIKI@localhost ~]$ ls /root/</span><br><span class="line">ls: cannot open directory /root/: Permission denied</span><br></pre></td></tr></table></figure>
</li>
<li><p>用sudo</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[NIKI@localhost ~]$ sudo ls /root</span><br><span class="line">1.txt  de  dem	demo  mou  nin.sh  rubbish  script.sh  test.py	w.sh  w.sh~</span><br></pre></td></tr></table></figure>



</li>
</ul>
<p>但是考虑到生产环境中不允许某个普通用户拥有整个系统中所有命令的最高执行权（这也不符合前文提到的权限赋予原则，即尽可能少地赋予权限），因此 ALL 参数(第99行）就有些不合适了。因此只能赋予普通用户具体的命令以满足工作需求，这也受到了必要的权限约束。如果需要让某个用户只能使用 root 管理员的身份执行指定的命令，切记一定要给出该命令的绝对路径，否则系统会识别不出来。我们可以先使用 whereis 命令找出命令所对应的保存路径，然后把配置文件第 99 行的用户权限参数修改成对应的路径即可</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[linuxprobe@linuxprobe ~]$ <span class="built_in">exit</span></span><br><span class="line"><span class="built_in">logout</span></span><br><span class="line">[root@linuxprobe ~]<span class="comment"># whereis cat</span></span><br><span class="line">cat: /usr/bin/cat /usr/share/man/man1/cat.1.gz /usr/share/man/man1p/cat.1p.gz</span><br><span class="line">[root@linuxprobe ~]<span class="comment"># visudo</span></span><br><span class="line">96 <span class="comment">##</span></span><br><span class="line">97 <span class="comment">## Allow root to run any commands anywhere</span></span><br><span class="line">98 root ALL=(ALL) ALL</span><br><span class="line">99 linuxprobe ALL=(ALL) /usr/bin/cat</span><br></pre></td></tr></table></figure>
<p>此时，用户只能用sudo执行cat命令。</p>
<p>这样虽然赋予了普通用户执行管理员命令的权限，但每次执行之前都要输入密码，可以通过以下配置，使得用户执行sudo时，不用密码验证。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@linuxprobe ~]<span class="comment"># visudo</span></span><br><span class="line">………………省略部分文件内容………………</span><br><span class="line">96 <span class="comment">##</span></span><br><span class="line">97 <span class="comment">## Allow root to run any commands anywhere</span></span><br><span class="line">98 root ALL=(ALL) ALL</span><br><span class="line">99 linuxprobe ALL=NOPASSWD: /usr/sbin/poweroff</span><br></pre></td></tr></table></figure>





<h1 id="文件"><a href="#文件" class="headerlink" title="文件"></a>文件</h1><p>linux一切皆文件，但文件类型和权限有所不同，用字符来区分。</p>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="文件类型"><a href="#文件类型" class="headerlink" title="文件类型"></a>文件类型</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">-：普通文件</span><br><span class="line">d：目录文件</span><br><span class="line">l：链接文件</span><br><span class="line">b：块设备文件</span><br><span class="line">c：字符设备文件</span><br><span class="line">p：管道文件</span><br></pre></td></tr></table></figure>



<h3 id="文件权限"><a href="#文件权限" class="headerlink" title="文件权限"></a>文件权限</h3><table>
<thead>
<tr>
<th>r</th>
<th>w</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>读</td>
<td>写</td>
<td>执行</td>
</tr>
<tr>
<td>4</td>
<td>2</td>
<td>1</td>
</tr>
</tbody></table>
<p><em>对于文件而言</em></p>
<table>
<thead>
<tr>
<th>r</th>
<th>w</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>可以读文件的内容</td>
<td>可以编辑文件的内容</td>
<td>可以执行这个文件</td>
</tr>
</tbody></table>
<p><em>对于目录而言</em></p>
<table>
<thead>
<tr>
<th>r</th>
<th>w</th>
<th>x</th>
</tr>
</thead>
<tbody><tr>
<td>读目录中的文件属性信息</td>
<td>可以在目录中添加或删除文件数据信息</td>
<td>是否可以进入到目录</td>
</tr>
</tbody></table>
<h3 id="权限详解"><a href="#权限详解" class="headerlink" title="权限详解"></a>权限详解</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">[root@nginxs qiandao]# ll </span><br><span class="line">total 8 </span><br><span class="line">-rw-r--r-- 1 root root 1424 Aug 15 06:05 Dockerfile </span><br><span class="line">-rw-r--r-- 1 root root 1413 Aug 15 06:05 README.md </span><br><span class="line">drwxr-xr-x 4 root root 28 Aug 15 06:05 root </span><br><span class="line"></span><br><span class="line"><span class="meta">#</span><span class="bash">权限数字对应权限组说明： 总共分为4部分 </span></span><br><span class="line">【文件或文件夹】【owner权限】【group权限】【others权限】 </span><br><span class="line">【文件是-，文件夹是d】【r/w/x相加】【r/w/x相加】【r/w/x相加】</span><br><span class="line">Linux档案的基本权限就有九个，分别是owner/group/others三种身份各有自己的read/write/execute权限</span><br></pre></td></tr></table></figure>



<h2 id="特殊权限"><a href="#特殊权限" class="headerlink" title="特殊权限"></a>特殊权限</h2><p>可读可写可执行不能够满足我们对安全和灵活性的需求，因此便有了 SUID、SGID 与 SBIT 的特殊权限位</p>
<h3 id="SUID"><a href="#SUID" class="headerlink" title="SUID"></a>SUID</h3><p>SUID 是一种对二进制程序进行设置的特殊权限，可以让二进制程序的执行者临时拥有属主的权限（仅对拥有执行权限的二进制程序有效）。</p>
<blockquote>
<p>例如，所有用户都可以执行 passwd 命令来修改自己的用户密码，而用户密码保存在/etc/shadow 文件中。仔细查看这个文件就会发现它的默认权限是 000，也就是说除了 root 管理员以外，所有用户都没有查看或编辑该文件的权限。但是，在使用 passwd 命令时如果加上 SUID 特殊权限位，就可让普通用户临时获得程序所有者的身份，把变更的密码信息写入到 shadow 文件中。这很像我们在古装剧中见到的手持尚方宝剑的钦差大臣，他手持的尚方宝剑代表的是皇上的权威，因此可以惩戒贪官，但这并不意味着他永久成为了皇上。因此这只是一种有条件的、临时的特殊权限授权方法。</p>
</blockquote>
<p>查看 passwd 命令属性时发现所有者的权限由 rwx 变成了 rws，其中 x 改变成 s 就意味着该文件被赋予了 SUID 权限。另外有读者会好奇，那么如果原本的权限是 rw-呢？如果原先权限位上没有 x 执行权限，那么被赋予特殊权限后将变成大写的 S。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]# ll /usr/bin/passwd </span><br><span class="line">-rwsr-xr-x. 1 root root 27856 Aug  8 21:39 /usr/bin/passwd</span><br></pre></td></tr></table></figure>

<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">chmod 4700 test.txt #添加suid权限</span><br><span class="line">-rws------ 1 root root 0 Dec 20 01:48 test.txt</span><br><span class="line"></span><br><span class="line">chmod 700 test.txt  #取消suid权限</span><br><span class="line">-rwx------ 1 root root 0 Dec 20 01:48 test.txt</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">对于当前位没有x执行权限，那么则显示大写的S</span><br><span class="line">chmod 4600 test.txt </span><br><span class="line">-rwS------ 1 root root 0 Dec 20 01:48 test.txt</span><br></pre></td></tr></table></figure>





<h3 id="SGID"><a href="#SGID" class="headerlink" title="SGID"></a>SGID</h3><p>SGID 主要实现如下两种功能：</p>
<p>1、让执行者临时拥有属组的权限（对拥有执行权限的二进制程序进行设置）；</p>
<p>2、在某个目录中创建的文件自动继承该目录的用户组（只可以对目录进行设置）。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@DZQ dev]<span class="comment"># ll mem </span></span><br><span class="line">crw-r----- 1 root kmem 1, 1 Aug  6 08:50 mem</span><br></pre></td></tr></table></figure>
<p>1、在某个目录中创建的文件自动继承该目录的用户组<br />2、由于 ps 命令被增加了 SGID 特殊权限位，所以当用户执行该命令时，也就临时获取到了 system 用户组的权限，从而可以顺利地读取设备文件了</p>
<h3 id="SBIT"><a href="#SBIT" class="headerlink" title="SBIT"></a>SBIT</h3><p>Sticky Bit ,SBIT 特殊权限位可确保用户只能删除自己的文件，而不能删除其他用户的文件。换句话说，当对某个目录设置了 SBIT 粘滞位权限后，那么该目录中的文件就只能被其所有者执行删除操作了与前面所讲的     SUID 和 SGID 权限显示方法不同，当目录被设置 SBIT 特殊权限位后，文件的其他人权限部分的 x 执行权限就会被替换成 t 或者 T，原本有 x 执行权限则会写成 t，原本没有 x 执行权限则会被写成 T。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[linuxprobe@linuxprobe tmp]$ ls -ald /tmp</span><br><span class="line">drwxrwxrwt. 17 root root 4096 Feb 11 13:03 /tmp</span><br></pre></td></tr></table></figure>

<p>要是也想对其他目录来设置 SBIT 特殊权限位，用 chmod 命令就可以了。对应的参数 o+t 代表设置 SBIT 粘滞位权限</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@linuxprobe ~]<span class="comment"># chmod -R o+t linux/</span></span><br><span class="line">[root@linuxprobe ~]<span class="comment"># ls -ld linux/</span></span><br><span class="line">drwxr-xr-t. 2 root root 6 Feb 11 19:34 linux/</span><br></pre></td></tr></table></figure>


<h2 id="隐藏权限"><a href="#隐藏权限" class="headerlink" title="隐藏权限"></a>隐藏权限</h2><h3 id="chattr"><a href="#chattr" class="headerlink" title="chattr"></a>chattr</h3><p>chattr 命令用于设置文件的隐藏权限，格式为“chattr [参数] 文件”。如果想要把某个隐藏功能添加到文件上，则需要在命令后面追加“+参数”，如果想要把某个隐藏功能移出文件，则需要追加“-参数”。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>i</td>
<td>无法对文件进行修改；若对目录设置了该参数，则仅能修改其中的而不能新建或删除文件</td>
</tr>
<tr>
<td>a</td>
<td>仅允许补充（追加）内容，无法覆盖/删除内容（Append Only）</td>
</tr>
<tr>
<td>S</td>
<td>文件内容在变更后立即同步到硬盘（sync）</td>
</tr>
<tr>
<td>s</td>
<td>彻底从硬盘中删除，不可恢复（用 0 填充原文件所在硬盘区域）</td>
</tr>
<tr>
<td>A</td>
<td>不再修改这个文件或目录的最后访问时间（atime）</td>
</tr>
<tr>
<td>b</td>
<td>不再修改文件或目录的存取时间</td>
</tr>
<tr>
<td>D</td>
<td>检查压缩文件中的错误</td>
</tr>
<tr>
<td>d</td>
<td>使用 dump 命令备份时忽略本文件/目录</td>
</tr>
<tr>
<td>c</td>
<td>默认将文件或目录进行压缩</td>
</tr>
<tr>
<td>u</td>
<td>当删除该文件后依然保留其在硬盘中的数据，方便日后恢复</td>
</tr>
<tr>
<td>t</td>
<td>让文件系统支持尾部合并（tail-merging）</td>
</tr>
<tr>
<td>X</td>
<td>可以直接访问压缩文件中的内容</td>
</tr>
</tbody></table>
<h3 id="lsattr"><a href="#lsattr" class="headerlink" title="lsattr"></a>lsattr</h3><p>用chattr执行改变文件或目录的属性，可执行lsattr指令查询其属性。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-a</td>
<td>显示所有文件和目录，包括以”.”为名称开头字符的额外内建，现行目录”.”与上层目录”..”</td>
</tr>
<tr>
<td>-d</td>
<td>显示，目录名称，而非其内容。</td>
</tr>
<tr>
<td>-R</td>
<td>递归处理，将指定目录下的所有文件及子目录一并处理</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span> example</span><br><span class="line">使用隐藏权限，防止某个文件被串改。</span><br><span class="line"></span><br><span class="line">[root@nginx myhouse]<span class="comment"># chattr +i hello.md </span></span><br><span class="line">[root@nginx myhouse]<span class="comment"># lsattr </span></span><br><span class="line">----i----------- ./hello.md</span><br></pre></td></tr></table></figure>



<h1 id="文件操作命令"><a href="#文件操作命令" class="headerlink" title="文件操作命令"></a>文件操作命令</h1><h2 id="chmod"><a href="#chmod" class="headerlink" title="chmod"></a>chmod</h2><p>chmod 可以藉以控制文件如何被他人所调用。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">for example:</span><br><span class="line">  chmod 700 test.md</span><br><span class="line">  chmod wxr-rx-rx test.md</span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-c</td>
<td>显示更改的部分的信息</td>
</tr>
<tr>
<td>-f</td>
<td>忽略错误信息</td>
</tr>
<tr>
<td>-h</td>
<td>修复符号链接</td>
</tr>
<tr>
<td>-v</td>
<td>显示详细的处理信息</td>
</tr>
<tr>
<td>-R</td>
<td>处理指定目录以及其子目录下的所有文件</td>
</tr>
</tbody></table>
<h2 id="chown"><a href="#chown" class="headerlink" title="chown"></a>chown</h2><p>chown 将指定文件的拥有者改为指定的用户或组</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>user</td>
<td>新的文件拥有者的使用者 ID</td>
</tr>
<tr>
<td>group</td>
<td>新的文件拥有者的使用者组(group)</td>
</tr>
<tr>
<td>-c</td>
<td>显示更改的部分的信息</td>
</tr>
<tr>
<td>-f</td>
<td>忽略错误信息</td>
</tr>
<tr>
<td>-h</td>
<td>修复符号链接</td>
</tr>
<tr>
<td>-v</td>
<td>显示详细的处理信息</td>
</tr>
<tr>
<td>-R</td>
<td>处理指定目录以及其子目录下的所有文件</td>
</tr>
</tbody></table>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">For example:</span><br><span class="line">更改一个目录文件以及其下子文件或者子目录的属主和属组。</span><br><span class="line"></span><br><span class="line">mkdir myhouse</span><br><span class="line">cd myhouse/</span><br><span class="line">touch hello.md</span><br><span class="line"><span class="meta">#</span><span class="bash"> ll</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-rw-r--r-- 1 root root 0 Dec 20 08:36 hello.md</span></span><br><span class="line">cd ..</span><br><span class="line"><span class="meta">#</span><span class="bash"> ll </span></span><br><span class="line"><span class="meta">#</span><span class="bash"> drwxr-xr-x 2 root root 22 Dec 20 08:36 myhouse</span></span><br><span class="line">chown -Rc dzq:nginx myhouse/</span><br><span class="line"><span class="meta">#</span><span class="bash">changed ownership of ‘myhouse/hello.md’ from root:root to dzq:nginx</span></span><br><span class="line"><span class="meta">#</span><span class="bash">changed ownership of ‘myhouse/’ from root:root to dzq:nginx</span></span><br><span class="line">ll</span><br><span class="line"><span class="meta">#</span><span class="bash">total 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">drwxr-xr-x 2 dzq nginx 22 Dec 20 08:36 myhouse</span></span><br><span class="line">cd myhouse/</span><br><span class="line">ll</span><br><span class="line"><span class="meta">#</span><span class="bash">total 0</span></span><br><span class="line"><span class="meta">#</span><span class="bash">-rw-r--r-- 1 dzq nginx 0 Dec 20 08:38 hello.md</span></span><br><span class="line"></span><br><span class="line">----由此可见，myhouse所属的用户和组都已经被更改，且其子目录里的hello.md也被更改了。</span><br></pre></td></tr></table></figure>



<h2 id="chgrp"><a href="#chgrp" class="headerlink" title="chgrp"></a>chgrp</h2><p>变更文件或目录的所属群组。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">chgrp -v bin myhouse/</span><br><span class="line"><span class="meta">#</span><span class="bash">将myhouse属组更改为bin</span></span><br><span class="line"></span><br><span class="line">与chown的区别,chown是将文件或者目录的属主更改，而chgrp是更改属组</span><br><span class="line">chown root myhouse/</span><br><span class="line"></span><br><span class="line">当chown以chown root:nginx world2.md的形式更改时，即更改了属主又更改了属组</span><br></pre></td></tr></table></figure>



<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">[root@node ~]<span class="comment"># ll</span></span><br><span class="line">-rwxrwxrwx 1 root root 9 Jan 17 12:26 demo</span><br><span class="line"><span class="comment">#改变属主</span></span><br><span class="line">[root@node ~]<span class="comment"># chown NIKI demo</span></span><br><span class="line">[root@node ~]<span class="comment"># ll</span></span><br><span class="line">-rwxrwxrwx 1 NIKI root 9 Jan 17 12:26 demo</span><br><span class="line"></span><br><span class="line"><span class="comment">#改变属组</span></span><br><span class="line">[root@node ~]<span class="comment"># chgrp NIKI demo</span></span><br><span class="line">[root@node ~]<span class="comment"># ll</span></span><br><span class="line">-rwxrwxrwx 1 NIKI NIKI 9 Jan 17 12:26 demo</span><br></pre></td></tr></table></figure>



<h1 id="文件访问控制列表"><a href="#文件访问控制列表" class="headerlink" title="文件访问控制列表"></a>文件访问控制列表</h1><p>对指定的用户进行单独的权限控制，就需要用到文件访问控制列表（ACL，Access Control List）</p>
<h2 id="setfacl"><a href="#setfacl" class="headerlink" title="setfacl"></a>setfacl</h2><p>Set File Acess Control List</p>
<p>chmod命令可以把文件权限分为u,g,o三个组，而setfacl可以对每一个文件或目录设置更精确的文件权限。换句话说，setfacl可以更精确的控制权限的分配。比如：让某一个用户对某一个文件具有某种权限。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-m</td>
<td>更改当前文件的ACL</td>
</tr>
<tr>
<td>-M, –modify-file=file</td>
<td>从文件中读取访问列表条目ACL进行修改</td>
</tr>
<tr>
<td>-x</td>
<td>根据访问控制列表移除条目</td>
</tr>
<tr>
<td>-b</td>
<td>删除所有扩展访问控制列表条目</td>
</tr>
<tr>
<td>-k</td>
<td>移除默认访问控制列表</td>
</tr>
<tr>
<td>-n  –no-mask</td>
<td>不重新计算有效权限掩码</td>
</tr>
<tr>
<td>-d  –default</td>
<td>应用到默认访问控制列表的操作</td>
</tr>
<tr>
<td>-R</td>
<td>递归操作子目录</td>
</tr>
<tr>
<td>-L</td>
<td>依照系统逻辑，跟随符号链接</td>
</tr>
<tr>
<td>-P</td>
<td>依照自然逻辑，不跟随符号链接</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># setfacl -Rm u:root:rwx /root/dem</span></span><br></pre></td></tr></table></figure>

<h2 id="getfacl"><a href="#getfacl" class="headerlink" title="getfacl"></a>getfacl</h2><p>显示文件上的ACL信息</p>
<p>常见用法</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@nginx ~]<span class="comment"># getfacl hello2.md </span></span><br><span class="line"><span class="comment"># file: hello2.md</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rw-</span><br><span class="line">group::r--</span><br><span class="line">other::r--</span><br><span class="line"></span><br><span class="line">[root@nginx ~]<span class="comment"># setfacl -m u:dzq:rwx hello2.md </span></span><br><span class="line"></span><br><span class="line">[root@nginx ~]<span class="comment"># getfacl hello2.md </span></span><br><span class="line"><span class="comment"># file: hello2.md</span></span><br><span class="line"><span class="comment"># owner: root</span></span><br><span class="line"><span class="comment"># group: root</span></span><br><span class="line">user::rw-</span><br><span class="line">user:dzq:rwx</span><br><span class="line">group::r--</span><br><span class="line">mask::rwx</span><br><span class="line">other::r--</span><br></pre></td></tr></table></figure>

            
            <p class="more">
                <a href="../../../../http:/ymlog.cn/2020/01/17/Linux%E6%9D%83%E9%99%90/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/01/17/Linux%E6%9D%83%E9%99%90/" title="Linux权限">
                
                    <img class="thumbnail" src="../../../../img/default.png" data-echo="../../../../img/thumbnail/7.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../../categories/Linux/">Linux</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../../http:/ymlog.cn/2020/01/16/Linux%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/">
    		Linux网络存储
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-01-16T11:36:23.000Z">2020-01-16</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <h1 id="1、FTP服务"><a href="#1、FTP服务" class="headerlink" title="1、FTP服务"></a>1、FTP服务</h1><p>FTP（File Transfer Protocol）文件传输协议，主要功能是在服务器与客户端之间进行文件的传输。FTP协议使用明码传输，为了使用更安全的FTP协议，可以采用vsftpd（Very Secure Ftp Daemon）。</p>
<p><img src="https://i.loli.net/2020/01/16/THwJ6F12Ld95lkP.png" alt="image-20200115190549585.png"></p>
<h2 id="协议摘要"><a href="#协议摘要" class="headerlink" title="协议摘要"></a>协议摘要</h2><h3 id="两种工作模式"><a href="#两种工作模式" class="headerlink" title="两种工作模式"></a>两种工作模式</h3><blockquote>
<ol>
<li>主动模式：FTP服务器主动向客户端发起请求</li>
<li>被动模式：FTP服务器等待客户端发起连接请求（FTP默认工作模式）</li>
</ol>
</blockquote>
<h3 id="三种用户等级"><a href="#三种用户等级" class="headerlink" title="三种用户等级"></a>三种用户等级</h3><ol>
<li>匿名用户。是一种最不安全的认证模式，任何人都可以无需密码验证而直接登录到FTP服务器。匿名用户默认访问目录是：<code>var/ftp</code></li>
<li>本地用户：使用Linux本地的账户密码进行认证，默认访问目录是<code>/home/person</code></li>
<li>虚拟用户：是这三种模式中最安全的一种认证模式，它需要为FTP服务单独建立用户数据库文件，虚拟出用来进行口令验证的账户信息，而这些账户信息在服务器系统中实际上是不存在的，仅供FTP服务程序进行认证使用。这样，即使黑客破解了账户信息也无法登录服务器，从而有效降低了破坏范围和影响。</li>
</ol>
<p>限制用户活动目录（change root，简称chroot）：将使用者的工作范围限定在用户的家目录。</p>
<h3 id="两个指定端口"><a href="#两个指定端口" class="headerlink" title="两个指定端口"></a>两个指定端口</h3><p>​    21端口用来<strong>建立连接</strong>，20端口用于<strong>传输数据</strong>。</p>
<h2 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h2><p>​    FTP使用系统的syslogd来进行数据记录，记录了包括用户曾经下达过的命令与用户传输数据（传输时间，文件大小等）记录，记录文件在<code>/var/log</code>下。</p>
<h3 id="主配置文件"><a href="#主配置文件" class="headerlink" title="主配置文件"></a>主配置文件</h3><p>​    VSftpd服务程序的主配置文件在<code>/etc/vsftpd/vsftpd.conf</code>下</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">[root@localhost ~]<span class="comment"># grep -Ev '^#' /etc/vsftpd/vsftpd.conf</span></span><br><span class="line">anonymous_enable=YES</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">listen=NO</span><br><span class="line">listen_ipv6=YES</span><br><span class="line"></span><br><span class="line">pam_service_name=vsftpd</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br></pre></td></tr></table></figure>



<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>listen=[YES|NO]</td>
<td>是否以独立运行的方式监听服务</td>
</tr>
<tr>
<td>listen_address=IP地址</td>
<td>设置要监听的IP地址</td>
</tr>
<tr>
<td>listen_port=21</td>
<td>设置FTP服务的监听端口</td>
</tr>
<tr>
<td>download_enable＝[YES|NO]</td>
<td>是否允许下载文件</td>
</tr>
<tr>
<td>userlist_enable=[YES|NO]userlist_deny=[YESNO]</td>
<td>设置用户列表为“允许”还是“禁止”操作</td>
</tr>
<tr>
<td>max_clients=0</td>
<td>最大客户端连接数，0为不限制</td>
</tr>
<tr>
<td>max_per_ip=0</td>
<td>同一IP地址的最大连接数，0为不限制</td>
</tr>
<tr>
<td>anonymous_enable=[YES|NO]</td>
<td>是否允许匿名用户访问</td>
</tr>
<tr>
<td>anon_upload_enable=[YES|NO]</td>
<td>是否允许匿名用户上传文件</td>
</tr>
<tr>
<td>anon_umask=022</td>
<td>匿名用户上传文件的umask值</td>
</tr>
<tr>
<td>anon_root=/var/ftp</td>
<td>匿名用户的FTP根目录</td>
</tr>
<tr>
<td>anon_mkdir_write_enable=[YES|NO]</td>
<td>是否允许匿名用户创建目录</td>
</tr>
<tr>
<td>anon_other_write_enable=[YES|NO]</td>
<td>是否开放匿名用户的其他写入权限（包括重命名、删除等操作权限）</td>
</tr>
<tr>
<td>anon_max_rate=0</td>
<td>匿名用户的最大传输速率（字节/秒），0为不限制</td>
</tr>
<tr>
<td>local_enable=[YES|NO]</td>
<td>是否允许本地用户登录FTP</td>
</tr>
<tr>
<td>local_umask=022</td>
<td>本地用户上传文件的umask值</td>
</tr>
<tr>
<td>local_root=/var/ftp</td>
<td>本地用户的FTP根目录</td>
</tr>
<tr>
<td>chroot_local_user=[YES|NO]</td>
<td>是否将用户权限禁锢在FTP目录，以确保安全</td>
</tr>
<tr>
<td>local_max_rate=0</td>
<td>本地用户最大传输速率（字节/秒），0为不限制</td>
</tr>
</tbody></table>
<h3 id="PAM配置"><a href="#PAM配置" class="headerlink" title="PAM配置"></a>PAM配置</h3><p>以下配置是PAM在FTP文件中的配置，写入<code>/etc/vsftpd/vsftpd.conf</code></p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>anonymous_enable=NO</td>
<td>禁止匿名开放模式</td>
</tr>
<tr>
<td>local_enable=YES</td>
<td>允许本地用户模式</td>
</tr>
<tr>
<td>guest_enable=YES</td>
<td>开启虚拟用户模式</td>
</tr>
<tr>
<td>guest_username=virtual</td>
<td>指定虚拟用户账户</td>
</tr>
<tr>
<td>pam_service_name=vsftpd.vu</td>
<td>指定 PAM 文件</td>
</tr>
<tr>
<td>allow_writeable_chroot=YES</td>
<td>允许对禁锢的FTP 根目录执行写入操作，而且不拒绝用户的登录请求</td>
</tr>
</tbody></table>
<h3 id="FTP用户禁止登录表"><a href="#FTP用户禁止登录表" class="headerlink" title="FTP用户禁止登录表"></a>FTP用户禁止登录表</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">[root@centos niki]<span class="comment"># cat /etc/vsftpd/user_list</span></span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line">adm</span><br><span class="line">lp</span><br><span class="line">sync</span><br><span class="line">shutdown</span><br><span class="line">halt</span><br><span class="line">mail</span><br><span class="line">news</span><br><span class="line">uucp</span><br><span class="line">operator</span><br><span class="line">games</span><br><span class="line">nobody</span><br><span class="line"></span><br><span class="line">[root@centos niki]<span class="comment"># cat /etc/vsftpd/ftpusers</span></span><br><span class="line"><span class="comment"># Users that are not allowed to login via ftp</span></span><br><span class="line">root</span><br><span class="line">bin</span><br><span class="line">daemon</span><br><span class="line">adm</span><br><span class="line">lp</span><br><span class="line">sync</span><br><span class="line">shutdown</span><br><span class="line">halt</span><br><span class="line">mail</span><br><span class="line">news</span><br><span class="line">uucp</span><br><span class="line">operator</span><br><span class="line">games</span><br><span class="line">nobody</span><br></pre></td></tr></table></figure>

<h3 id="FTP-SElinux"><a href="#FTP-SElinux" class="headerlink" title="FTP-SElinux"></a>FTP-SElinux</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@linuxprobe ~]<span class="comment"># getsebool -a | grep ftp</span></span><br><span class="line">ftp_home_dir --&gt; off</span><br><span class="line">ftpd_anon_write --&gt; off</span><br><span class="line">ftpd_connect_all_unreserved --&gt; off</span><br><span class="line">ftpd_connect_db --&gt; off</span><br><span class="line">ftpd_full_access --&gt; off</span><br><span class="line">ftpd_use_cifs --&gt; off</span><br><span class="line">ftpd_use_fusefs --&gt; off</span><br><span class="line">ftpd_use_nfs --&gt; off</span><br><span class="line">ftpd_use_passive_mode --&gt; off</span><br><span class="line">httpd_can_connect_ftp --&gt; off</span><br><span class="line">httpd_enable_ftp_server --&gt; off</span><br><span class="line">sftpd_anon_write --&gt; off</span><br><span class="line">sftpd_enable_homedirs --&gt; off</span><br><span class="line">sftpd_full_access --&gt; off</span><br><span class="line">sftpd_write_ssh_home --&gt; off</span><br><span class="line">tftp_anon_write --&gt; off</span><br><span class="line">tftp_home_dir --&gt; off</span><br><span class="line">[root@linuxprobe ~]<span class="comment"># setsebool -P ftpd_full_access=on</span></span><br></pre></td></tr></table></figure>









<h2 id="安装FTP服务"><a href="#安装FTP服务" class="headerlink" title="安装FTP服务"></a>安装FTP服务</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install vsftpd</span><br><span class="line"></span><br><span class="line"><span class="comment">#清空Iptables，因为Iptables防火墙管理工具默认禁止FTP传输协议的端口号</span></span><br><span class="line">iptables -F</span><br><span class="line"><span class="comment">#下一步是使用service iptables save保存防火墙规则，但这里没有，我们需要安装iptables-services</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">yum install iptables-services -y</span><br><span class="line">systemctl <span class="built_in">enable</span> iptables</span><br><span class="line">systemctl start iptables</span><br><span class="line">service iptables save</span><br><span class="line"><span class="comment">#安装客户端工具</span></span><br><span class="line">yum -y install ftp</span><br></pre></td></tr></table></figure>



<h2 id="1-匿名登录模式"><a href="#1-匿名登录模式" class="headerlink" title="1. 匿名登录模式"></a>1. 匿名登录模式</h2><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>anonymous_enable=YES</td>
<td>允许匿名访问模式</td>
</tr>
<tr>
<td>anon_umask=022</td>
<td>匿名用户上传文件的umask值</td>
</tr>
<tr>
<td>anon_upload_enable=YES</td>
<td>允许匿名用户上传文件</td>
</tr>
<tr>
<td>anon_mkdir_write_enable=YES</td>
<td>允许匿名用户创建目录</td>
</tr>
<tr>
<td>anon_other_write_enable=YES</td>
<td>允许匿名用户修改目录名称或删除目录</td>
</tr>
</tbody></table>
<p>什么是umask值？</p>
<blockquote>
<pre><code>umask值用于设置用户在创建文件时的默认权限，当我们在系统中创建目录或文件时，目录或文件所具有的默认权限就是由umask值决定的。</code></pre></blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#首先清空文件</span></span><br><span class="line">cat /dev/null &gt; /etc/vsftpd/vsftpd.conf</span><br><span class="line"><span class="comment">#然后写入</span></span><br><span class="line">cat &gt;&gt; /etc/vsftpd/vsftpd.conf &lt;&lt; EOF</span><br><span class="line"><span class="comment">#匿名用户上传文件的umask值</span></span><br><span class="line">anon_umask=022</span><br><span class="line"><span class="comment">#允许匿名用户上传文件</span></span><br><span class="line">anon_upload_enable=YES</span><br><span class="line"><span class="comment">#允许匿名用户创建目录</span></span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line"><span class="comment">#允许匿名用户修改目录名称或者删除目录</span></span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line"><span class="comment">#允许匿名访问</span></span><br><span class="line">anonymous_enable=YES</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#防止干扰</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#重启VSftpd服务</span></span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"><span class="comment">#开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> vsftpd</span><br></pre></td></tr></table></figure>


<p><img src="https://i.loli.net/2020/01/16/vmo7U4ni5pchCu8.png" alt="image-20200116102732989.png"></p>
<h2 id="2-本地用户登录"><a href="#2-本地用户登录" class="headerlink" title="2. 本地用户登录"></a>2. 本地用户登录</h2><table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>anonymous_enable=NO</td>
<td>禁止匿名访问模式</td>
</tr>
<tr>
<td>local_enable=YES</td>
<td>允许本地用户模式</td>
</tr>
<tr>
<td>write_enable=YES</td>
<td>设置可写权限</td>
</tr>
<tr>
<td>local_umask=022</td>
<td>本地用户模式创建文件的 umask 值</td>
</tr>
<tr>
<td>userlist_enable=YES</td>
<td>启用“禁止用户名单”，名单文件为 ftpusers 和 user_list</td>
</tr>
<tr>
<td>userlist_deny=YES</td>
<td>开启用户作用名单文件功能</td>
</tr>
</tbody></table>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">&gt; /etc/vsftpd/vsftpd.conf</span><br><span class="line">cat &gt;&gt; /etc/vsftpd/vsftpd.conf &lt;&lt; EOF</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">pam_service_name=vsftpd <span class="comment">#不加这一句登录就会报530的错</span></span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"><span class="comment">#防止干扰</span></span><br><span class="line">systemctl stop firewalld</span><br><span class="line">setenforce 0</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#本地用户需要使用本地Linux的账号登录，这里创建一个账户并添加用户名和密码</span></span><br><span class="line">useradd niki</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"monian"</span> | passwd --stdin niki</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"This is <span class="variable">$PWD</span>"</span> &gt; /home/niki/tool.txt</span><br><span class="line"></span><br><span class="line"><span class="comment">#重启VSftpd服务</span></span><br><span class="line">systemctl restart vsftpd</span><br><span class="line"><span class="comment">#开机自启</span></span><br><span class="line">systemctl <span class="built_in">enable</span> vsftpd</span><br></pre></td></tr></table></figure>

<p>如果是530登录异常：</p>
<blockquote>
<p><a href="https://blog.csdn.net/wlchn/article/details/50855447" target="_blank" rel="noopener">https://blog.csdn.net/wlchn/article/details/50855447</a></p>
</blockquote>
<p><img src="https://i.loli.net/2020/01/16/UedIJkmQTijoF2N.png" alt="image-20200116110254836.png"></p>
<h2 id="3-虚拟用户登录"><a href="#3-虚拟用户登录" class="headerlink" title="3. 虚拟用户登录"></a>3. 虚拟用户登录</h2><p>虚拟用户登录配置文件关系图：</p>
<ul>
<li>pam_serivice_name：用户认证文件</li>
<li>guest_username：指定虚拟用户账户</li>
<li>user_config_dir：用户配置目录</li>
</ul>
<p><img src="https://i.loli.net/2020/01/16/lmLiP9rdJhBERsA.png" alt="image-20200116130851132.png"></p>
<p>虚拟用户认证即使知道了登录FTP服务器的账号密码，也不会对Linux主机造成破坏，因为虚拟认证的账号密码在Linux服务器内并不存在。正如同这里的<code>dzq --- 123</code> 以及<code>gz --- 456</code> ，在Linux系统中并没有相关的用户。而这些虚拟的用户会统一映射到<code>Virtual</code>这个用户下。</p>
<p>关于FTP服务器使用虚拟用户登录的时候为什么还要再建立一个本地账户的解释：</p>
<blockquote>
<p>由于Linux系统中的每一个文件都有所有者、所属组属性，例如使用虚拟账户“张三”新建了一个文件，但是系统中找不到账户“张三”，就会导致这个文件的权限出现错误。为此，需要再创建一个可以映射到虚拟用户的系统本地用户。简单来说，就是让虚拟用户默认登录到与之有映射关系的这个系统本地用户的家目录中，虚拟用户创建的文件的属性也都归属于这个系统本地用户，从而避免Linux系统无法处理虚拟用户所创建文件的属性权限。</p>
</blockquote>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#创建用户名和密码并Hash，奇数行是用户名，偶数行是密码</span></span><br><span class="line">rm -rf /etc/vsftpd/vuser*</span><br><span class="line">cat &gt;&gt; /etc/vsftpd/vuser.list &lt;&lt; EOF</span><br><span class="line">dzq</span><br><span class="line">123</span><br><span class="line">gz</span><br><span class="line">456</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#将用户信息文件转换为数据库并使用Hash加密</span></span><br><span class="line">db_load -T -t <span class="built_in">hash</span> -f vuser.list vuser.db</span><br><span class="line">chmod 600 vuser.db</span><br><span class="line">rm -f vuser.list</span><br><span class="line"></span><br><span class="line"><span class="comment">#添加用户，指定解释器nologin,使用户无法登录系统</span></span><br><span class="line">useradd -s /sbin/nologin virtual</span><br><span class="line">chmod -Rf 755 /home/virtual</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/pam.d/vsftpd.vu &lt;&lt; EOF</span><br><span class="line">auth       required     pam_userdb.so db=/etc/vsftpd/vuser</span><br><span class="line">account    required     pam_userdb.so db=/etc/vsftpd/vuser</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mkdir /etc/vsftpd/vusers_dir/</span><br><span class="line">touch /etc/vsftpd/vusers_dir/dzq</span><br><span class="line">cat &gt;&gt; /etc/vsftpd/vusers_dir/gz &lt;&lt; EOF</span><br><span class="line">anon_upload_enable=YES</span><br><span class="line">anon_mkdir_write_enable=YES</span><br><span class="line">anon_other_write_enable=YES</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/vsftpd/vsftpd.conf &lt;&lt; EOF</span><br><span class="line">anonymous_enable=NO</span><br><span class="line">local_enable=YES</span><br><span class="line">guest_enable=YES</span><br><span class="line">guest_username=virtual</span><br><span class="line">allow_writeable_chroot=YES</span><br><span class="line">write_enable=YES</span><br><span class="line">local_umask=022</span><br><span class="line">dirmessage_enable=YES</span><br><span class="line">xferlog_enable=YES</span><br><span class="line">connect_from_port_20=YES</span><br><span class="line">xferlog_std_format=YES</span><br><span class="line">listen=NO</span><br><span class="line">listen_ipv6=YES</span><br><span class="line"><span class="comment">#修改ftp默认配置中的pam认证文件,表示服务器是根据/etc/pam.d/vsftpd.vu进行认证的</span></span><br><span class="line">pam_service_name=vsftpd.vu</span><br><span class="line">userlist_enable=YES</span><br><span class="line">tcp_wrappers=YES</span><br><span class="line"><span class="comment">#该目录下定义了用户的配置，如权限之类</span></span><br><span class="line">user_config_dir=/etc/vsftpd/vusers_dir</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">systemctl restart vsftpd</span><br></pre></td></tr></table></figure>



<p><code>db_load</code>介绍：将用户信息文件转换为数据库并使用Hash加密</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-T</td>
<td>选项-T允许应用程序能够将文本文件转译载入进数据库。由于我们之后是将虚拟用户的信息以文件方式存储在文件里的，为了让Vsftpd这个应用程序能够通过文本来载入用户数据，必须要使用这个选项。如果指定了选项-T，那么一定要追跟子选项-t</td>
</tr>
<tr>
<td>-t</td>
<td>子选项-t，追加在在-T选项后，用来指定转译载入的数据库类型。扩展介绍下，-t可以指定的数据类型有Btree、Hash、Queue和Recon数据库。</td>
</tr>
<tr>
<td>-f</td>
<td>参数后面接包含用户名和密码的文本文件，文件的内容是：奇数行用户名、偶数行密码</td>
</tr>
</tbody></table>
<p>默认登录目录是<code>/home/virtual/</code></p>
<p><img src="https://i.loli.net/2020/01/16/uCkSc3XxmsVzPaJ.png" alt="image-20200116120617812.png"></p>
<h1 id="PAM认证"><a href="#PAM认证" class="headerlink" title="PAM认证"></a>PAM认证</h1><p>原文链接：<a href="https://blog.csdn.net/zhangym199312/article/details/78021998" target="_blank" rel="noopener">https://blog.csdn.net/zhangym199312/article/details/78021998</a></p>
<p>PAM简介</p>
<ol>
<li>Sun公司于1995 年开发的一种与认证相关的通用框架机制</li>
<li>PAM 是关注如何为服务验证用户的API，通过提供一些动态链接库和一套统一的API，将系统提供的服务和该服务的认证方式分，使得系统管理员可以灵活地根据需要给不同的服务配置不同的认证方式而无需更改服务程序，同时，PAM是一种认证框架，自身不做认证</li>
<li>PAM(Pluggable Authentication Modules)即可插拔式认证模块，它是一种高效而且灵活便利的用户级别的认证方式，它也是当前Linux服务器普遍使用的认证方式。当然，在不同版本的Linux统中部署PAM认证是有所不同的。它提供了对所有服务进行认证的中央机制，适用于login，远程登录（telnet,rlogin,fsh,ftp,点对点协议（PPP）），su等应用程序中。系统管理员通过PAM配置文件来制定不同应用程序的不同认证策略；应用程序开发者通过在服务程序中使用PAM API(pam_xxxx( ))来实现对认证方法的调用；而PAM服务模块的开发者则利用PAM SPI来编写模块（主要是引出一些函数pam_sm_xxxx( )供PAM接口库调用），将不同的认证机制加入到系统中；PAM接口库（libpam）则读取配置文件，将应用程序和相应的PAM服务模块联系起来。</li>
</ol>
<p>PAM架构如下图所示：</p>
<p><img src="https://i.loli.net/2020/01/16/8femMGkcR5VPYJw.png" alt="const_pam.png"></p>
<p>认证顺序：</p>
<p>Service（服务）—-&gt;PAM配置文件—–&gt;pam_*.so</p>
<p>首先查看服务，查看服务上是否定义的有pam验证的信息，根据这些验证信息，去读取pam配置文件，之后，pam配置文件里面定义各种规则（我们管理员需要定义的），生效，调用pam_*.so模块。</p>
<p><img src="https://i.loli.net/2020/01/16/i6NFTwgJknRSbuE.png" alt="pam.png"></p>
<hr>
<h1 id="2、Samba服务"><a href="#2、Samba服务" class="headerlink" title="2、Samba服务"></a>2、Samba服务</h1><h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>SMB简介：</p>
<p>​    Samba（Server Message Block，服务消息块）是在Linux和Unix系统上实现SMB协议的一个免费软件，提供CIFS(Common Internet File System)协议，由服务器及客户端程序构成，SMB(Server Messages Block,信息服务块)是一种在局域网上共享文件和打印机的一种通信协议，它为局域网内的不同计算机之间提供文件及打印机等资源的共享服务。</p>
<p>CIFS简介：</p>
<p>CIFS(Common Internet File System)文件系统也称通用Internet文件系统,它使程序可以访问远程Internet计算机上的文件并要求此计算机的服务。CIFS使用客户/服务器模式。客户程序请求远在服务器上的服务程序为它提供服务，服务器获得请求并返回响应。CIFS是公开的开放的SMB协议版本。SMB协议现在是在局域网上用于服务器文件访问和打印的协议。像SMB协议一样，CIFS在高层运行。可以看做是应用程序协议如文件传输协议和超文本传输协议的一个实现。</p>
<p>CIFS功能：</p>
<ol>
<li>访问服务器本地文件并读写这些文件</li>
<li>与其它用户一起共享一些文件块</li>
<li>在断线时自动恢复与网络的连接</li>
<li>使用统一码文件名</li>
</ol>
<p>CIFS 是 SMB 协议的衍生品，即 CIFS 是 SMB 协议的一种特殊实现，由美国微软公司开发。</p>
<p><img src="https://i.loli.net/2020/01/16/3kGX1PfFbRL6Y97.png" alt="image-20200116154820838.png"></p>
<h2 id="配置文件-1"><a href="#配置文件-1" class="headerlink" title="配置文件"></a>配置文件</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Samba功能</span><br><span class="line">  使Linux主机称为window网络中的一份子，与window系统相互分享资源</span><br><span class="line">  让linux主机能使用window共享的文件和打印机</span><br><span class="line">  使Linux主机称为Wins名称服务器，提供NetBIOS名字解析服务器</span><br><span class="line">  提供用户身份验证功能</span><br><span class="line">  支持SSL安全套接层协议</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Samba提供服务</span><br><span class="line">  文件和打印机共享</span><br><span class="line">  用户验证和授权</span><br><span class="line">  名字解析</span><br><span class="line">  浏览（服务通告）</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Samba守护进程</span><br><span class="line">  Smbd： 实现共享和验证授权功能</span><br><span class="line">  Nmbd： 实现名字解析和浏览服务</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Samba的RPM包：</span><br><span class="line">  samba-common: 服务端和客户端所需要的文件</span><br><span class="line">  samba： 服务端软件</span><br><span class="line">  samba&#x3D;winbind： 可选的winbind服务</span><br><span class="line">  samba-client： 客户端软件</span><br><span class="line">  samba-swat： Web配置工具</span><br></pre></td></tr></table></figure>



<p>Samba服务的配置文件在<code>/etc/samba/smb.conf</code>下，其主要的参数和作用如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">[global]									 <span class="comment">#全局参数。</span></span><br><span class="line">    workgroup = MYGROUP	 					 <span class="comment">#工作组名称</span></span><br><span class="line">    server string = Samba Server Version %v	 <span class="comment">#服务器介绍信息，参数%v为显示SMB版本号</span></span><br><span class="line">    <span class="built_in">log</span> file = /var/<span class="built_in">log</span>/samba/<span class="built_in">log</span>.%m	 	 <span class="comment">#定义日志文件的存放位置与名称，参数%m为来访的主机名</span></span><br><span class="line">    max <span class="built_in">log</span> size = 50	                	 <span class="comment">#定义日志文件的最大容量为50KB</span></span><br><span class="line"></span><br><span class="line">    security = user							 </span><br><span class="line">    <span class="comment">#安全验证的方式，总共有4种</span></span><br><span class="line">    <span class="comment">#1. share：来访主机无需验证口令；比较方便，但安全性很差</span></span><br><span class="line">    <span class="comment">#2. user：需验证来访主机提供的口令后才可以访问；提升了安全性</span></span><br><span class="line">    <span class="comment">#3. server：使用独立的远程主机验证来访主机提供的口令（集中管理账户）</span></span><br><span class="line">    <span class="comment">#4. domain：使用域控制器进行身份验证</span></span><br><span class="line"></span><br><span class="line">    passdb backend = tdbsam					</span><br><span class="line">    <span class="comment">#定义用户后台的类型，共有3种</span></span><br><span class="line">    <span class="comment">#1. smbpasswd：使用smbpasswd命令为系统用户设置Samba服务程序的密码</span></span><br><span class="line">    <span class="comment">#2. tdbsam：创建数据库文件并使用pdbedit命令建立Samba服务程序的用户</span></span><br><span class="line">    <span class="comment">#3. ldapsam：基于LDAP服务进行账户验证</span></span><br><span class="line">    load printers = yes	</span><br><span class="line"></span><br><span class="line">    load printers = yes						 <span class="comment">#设置在Samba服务启动时是否共享打印机设备</span></span><br><span class="line">    cups options = raw					     <span class="comment">#打印机的选项</span></span><br><span class="line">    </span><br><span class="line">[homes]										 <span class="comment">#共享参数</span></span><br><span class="line">    comment = Home Directories			     <span class="comment">#描述信息</span></span><br><span class="line">    browseable = no							 <span class="comment">#指定共享信息是否在“网上邻居”中可见</span></span><br><span class="line">    writable = yes							 <span class="comment">#定义是否可以执行写入操作，与“read only”相反</span></span><br><span class="line">    </span><br><span class="line">[printers]								 	<span class="comment">#打印机共享参数</span></span><br><span class="line">    comment = All Printers	</span><br><span class="line">    path = /var/spool/samba					 <span class="comment">#共享文件的实际路径(重要)。</span></span><br><span class="line">    browseable = no	</span><br><span class="line">    guest ok = no							 <span class="comment">#是否所有人可见，等同于"public"参数。</span></span><br><span class="line">    writable = no	</span><br><span class="line">    printable = yes	</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line">[database]								 				<span class="comment">#共享名称为database</span></span><br><span class="line">comment = Do not arbitrarily modify the database file	<span class="comment">#警告用户不要随意修改数据库</span></span><br><span class="line">path = /home/database									<span class="comment">#共享目录为/home/database</span></span><br><span class="line">public = no												<span class="comment">#关闭“所有人可见”</span></span><br><span class="line">writable = yes											<span class="comment">#允许写入操作</span></span><br></pre></td></tr></table></figure>



<h2 id="配置命令"><a href="#配置命令" class="headerlink" title="配置命令"></a>配置命令</h2><h3 id="Pdbedit"><a href="#Pdbedit" class="headerlink" title="Pdbedit"></a>Pdbedit</h3><p>Samba服务程序默认使用的是用户口令认证模式（user）。这种认证模式可以确保仅让有密码且受信任的用户访问共享资源，而且验证过程也十分简单。不过，只有建立账户信息数据库之后，才能使用用户口令认证模式。另外，Samba服务程序的数据库要求账户必须在当前系统中已经存在，否则日后创建文件时将导致文件的权限属性混乱不堪，由此引发错误。pdbedit命令用于管理SMB服务程序的账户信息数据库。</p>
<table>
<thead>
<tr>
<th>常用参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>pdbedit -a username</td>
<td>新建Samba账户。</td>
</tr>
<tr>
<td>pdbedit -r username</td>
<td>修改Samba账户。</td>
</tr>
<tr>
<td>pdbedit -x username</td>
<td>删除Samba账户</td>
</tr>
<tr>
<td>pdbedit -L</td>
<td>列出Samba用户列表，读取passdb.tdb数据库文件。</td>
</tr>
</tbody></table>
<p>报错：Failed to add entry for user qwer，是因为没有添加本地账户。</p>
<h3 id="Semanage"><a href="#Semanage" class="headerlink" title="Semanage"></a>Semanage</h3><p>semanage命令 是用来查询与修改SELinux默认目录的安全上下文。</p>
<blockquote>
<p>详情：<a href="https://ipcmen.com/semanage" target="_blank" rel="noopener">https://ipcmen.com/semanage</a></p>
</blockquote>
<table>
<thead>
<tr>
<th>semanage</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>semanage -l</td>
<td>查询</td>
</tr>
<tr>
<td>semanage fcontext</td>
<td>主要用在安全上下文方面</td>
</tr>
<tr>
<td>semanage -a</td>
<td>增加，你可以增加一些目录的默认安全上下文类型设置</td>
</tr>
<tr>
<td>semanage -m</td>
<td>修改</td>
</tr>
<tr>
<td>semanage -d</td>
<td>删除</td>
</tr>
</tbody></table>
<h3 id="SELinux安全上下文"><a href="#SELinux安全上下文" class="headerlink" title="SELinux安全上下文"></a>SELinux安全上下文</h3><blockquote>
<p>详情：<a href="http://c.biancheng.net/view/1151.html" target="_blank" rel="noopener">http://c.biancheng.net/view/1151.html</a></p>
</blockquote>
<p>chcon和restorecon命令，如果一个文件的安全上下文和它默认的不匹配的话，一般情况会导致没有权限访问这个文件，这是Selinux的一种功能。</p>
<p>restorecon：把文件的安全上下文恢复成默认的安全上下文。</p>
<p><code>restorecon [选项】 文件或目录</code></p>
<ul>
<li>-R：递归.当前目录和目录下所有的子文件同时恢复；</li>
<li>-V：把恢复过程显示到屏幕上；</li>
</ul>
<h2 id="Samba配置"><a href="#Samba配置" class="headerlink" title="Samba配置"></a>Samba配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">yum -y install samba</span><br><span class="line"><span class="comment">#添加用户</span></span><br><span class="line">useradd niki</span><br><span class="line"></span><br><span class="line"><span class="comment">#pdbedit是samba的用户管理命令，这里需要手动输入密码</span></span><br><span class="line">pdbedit -a -u niki</span><br><span class="line"><span class="comment">#new password:monian</span></span><br><span class="line"><span class="comment">#retype new password:monian</span></span><br><span class="line"></span><br><span class="line">mkdir /home/database</span><br><span class="line">chown -Rf niki:niki /home/database</span><br><span class="line"></span><br><span class="line"><span class="comment">#这里如果SELINUX关闭的话，下面几行关于安全上下文的命令可以不用敲</span></span><br><span class="line"><span class="comment">#安装semanage</span></span><br><span class="line">yum -y install policycoreutils-python.x86_64</span><br><span class="line"><span class="comment">#增加一条关于samba的安全上下文</span></span><br><span class="line">semanage fcontext -a -t samba_share_t /home/database</span><br><span class="line"></span><br><span class="line"><span class="comment">#将/home/database的安全上下文回复</span></span><br><span class="line">restorecon -Rv /home/database/</span><br><span class="line">restorecon reset /home/database context unconfined_u:object_r:home_root_t:s0-&gt;unconfined_u:object_r:samba_share_t:s0</span><br><span class="line"></span><br><span class="line">&gt;/etc/samba/smb.conf</span><br><span class="line">cat &gt;&gt; /etc/samba/smb.conf &lt;&lt; EOF</span><br><span class="line">[global]</span><br><span class="line">workgroup = MYGROUP</span><br><span class="line">server string = Samba Server Version %v</span><br><span class="line"><span class="built_in">log</span> file = /var/<span class="built_in">log</span>/samba/<span class="built_in">log</span>.%m</span><br><span class="line">max <span class="built_in">log</span> size = 50</span><br><span class="line">security = user</span><br><span class="line">passdb backend = tdbsam</span><br><span class="line">load printers = yes</span><br><span class="line">cups options = raw</span><br><span class="line">[database]</span><br><span class="line">comment = Do not arbitrarily modify the database file</span><br><span class="line">path = /home/database</span><br><span class="line">public = no</span><br><span class="line">writable = yes</span><br><span class="line">EOF </span><br><span class="line"> </span><br><span class="line"></span><br><span class="line">systemctl restart smb</span><br><span class="line">systemctl <span class="built_in">enable</span> smb</span><br></pre></td></tr></table></figure>

<h2 id="挂载Samba"><a href="#挂载Samba" class="headerlink" title="挂载Samba"></a>挂载Samba</h2><p><strong>Windows</strong></p>
<p><img src="https://i.loli.net/2020/01/16/dVE7SRKFUiL8n9h.png" alt="image-20200116150510791.png"></p>
<p>需要进行登录，登录用户名为<code>niki</code>，密码为<code>monian</code> </p>
<p><img src="https://i.loli.net/2020/01/16/BK8oXD4wPZzci2S.png" alt="image-20200116150535133.png"></p>
<p><strong>Linux</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">yum install cifs-utils</span><br><span class="line">mkdir /database</span><br><span class="line">cat &gt;&gt; /root/auth.smb &lt;&lt; EOF</span><br><span class="line">username=niki</span><br><span class="line">password=monian</span><br><span class="line">domain=MYGROUP</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">cat &gt;&gt;  /etc/fstab &lt;&lt; EOF</span><br><span class="line">//192.168.10.10/database /database cifs credentials=/root/auth.smb 0 0</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line">mount -a</span><br></pre></td></tr></table></figure>



<hr>
<h1 id="3、NFS服务"><a href="#3、NFS服务" class="headerlink" title="3、NFS服务"></a>3、NFS服务</h1><h2 id="配置文件参数"><a href="#配置文件参数" class="headerlink" title="配置文件参数"></a>配置文件参数</h2><p>NFS的配置文件在<code>/etc/exports</code>中，其基本格式为：<code>/挂在文件目录  允许访问的IP地址(权限相关)</code></p>
<p>注意NFS客户端地址与权限之间没有空格。</p>
<table>
<thead>
<tr>
<th>参数</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>ro</td>
<td>只读</td>
</tr>
<tr>
<td>rw</td>
<td>读写</td>
</tr>
<tr>
<td>root_squash</td>
<td>当NFS客户端以root管理员访问时，映射为NFS服务器的匿名用户</td>
</tr>
<tr>
<td>no_root_squash</td>
<td>当NFS客户端以root管理员访问时，映射为NFS服务器的root管理员</td>
</tr>
<tr>
<td>all_squash</td>
<td>无论NFS客户端使用什么账户访问，均映射为NFS服务器的匿名用户</td>
</tr>
<tr>
<td>sync</td>
<td>同时将数据写入到内存与硬盘中，保证不丢失数据</td>
</tr>
<tr>
<td>async</td>
<td>优先将数据保存到内存，然后再写入硬盘；这样效率更高，但可能会丢失数据</td>
</tr>
</tbody></table>
<p>​    </p>
<h2 id="NFS相关包"><a href="#NFS相关包" class="headerlink" title="NFS相关包"></a>NFS相关包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">nfs-utils:NFS主要组件，包含rpc、nfsd、和rpc.mountd这两个守护进程</span><br><span class="line">nfsbind：提供rpc端口映射的守护进程</span><br><span class="line">exportfs：在NFS服务器，维护nfs共享资源的命令</span><br><span class="line">showmount：用来查看nfs客户端的资源共享目录</span><br><span class="line">nfsstat：显示nfs状态信息</span><br><span class="line">rpcinfo：显示由rpc</span><br><span class="line">启动服务 systemctl start rpcbind &amp;&amp; systemctl start nfs-server</span><br><span class="line">软件包：nfs-utils</span><br><span class="line">服务类型：由systemd启动的守护进程</span><br><span class="line">配置单元： /usr/lib/systemd/system/nfs.service</span><br><span class="line">守护进程：rpc .nfsd rpc.mountd  </span><br><span class="line">端口号：2049 nfsd 111 rpcbind 20048 mountd</span><br><span class="line">服务端配置：/etc/exports</span><br><span class="line">相关软件包： rpcbind</span><br></pre></td></tr></table></figure>



<h2 id="服务端配置"><a href="#服务端配置" class="headerlink" title="服务端配置"></a>服务端配置</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nfs-utils</span><br><span class="line">mkdir /nfs</span><br><span class="line">chmod -Rf 777 /nfs/</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"This is NFS"</span> &gt; /nfs/nfs.txt</span><br><span class="line"></span><br><span class="line">cat &gt;&gt; /etc/exports &lt;&lt; EOF</span><br><span class="line">/nfs *(rw,sync,no_root_squash)</span><br><span class="line">EOF</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">systemctl restart rpcbind</span><br><span class="line">systemctl restart nfs-server.service</span><br></pre></td></tr></table></figure>



<p>如果windows下连接报网络错误53的话，可能是以下情况：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">NFS服务器有一个”在非安全模式工作（允许更高的端口号）“的选项。Windows NFS客户端经常使用的是大的端口号。你可以在你的共享项设置中开启这个选项</span><br><span class="line"></span><br><span class="line">例如：/share *(insecure,rw)</span><br></pre></td></tr></table></figure>







<h2 id="客户端配置"><a href="#客户端配置" class="headerlink" title="客户端配置"></a>客户端配置</h2><p><strong>Windows</strong></p>
<p><code>控制面板 ---- 程序 ---- 程序和功能：</code></p>
<p><img src="https://i.loli.net/2020/01/16/g4MqucSACR2Edhf.png" alt="image-20200116165524286.png"></p>
<p><code>win+r --- cmd --- 挂在</code> </p>
<p><img src="https://i.loli.net/2020/01/16/EC28VrINduUAFBo.png" alt="image-20200116165505217.png"></p>
<p><code>文件管理器</code></p>
<p><img src="https://i.loli.net/2020/01/16/b7J6pfN4okO9IZ8.png" alt="image-20200116165607503.png"></p>
<p><strong>Linux</strong></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">[root@linuxprobe ~]<span class="comment"># showmount -e 192.168.10.10</span></span><br><span class="line">Export list <span class="keyword">for</span> 192.168.10.10:</span><br><span class="line">/nfsfile 192.168.10.*</span><br><span class="line"></span><br><span class="line">[root@linuxprobe ~]<span class="comment"># mkdir /nfsfile</span></span><br><span class="line">[root@linuxprobe ~]<span class="comment"># mount -t nfs 192.168.10.10:/nfsfile /nfsfile</span></span><br><span class="line"><span class="comment">#想要长期挂在，可以编辑/etc/fstab文件</span></span><br></pre></td></tr></table></figure>

<table>
<thead>
<tr>
<th>showmount参数</th>
<th>作用</th>
</tr>
</thead>
<tbody><tr>
<td>-e</td>
<td>显示NFS服务器的共享列表</td>
</tr>
<tr>
<td>-a</td>
<td>显示本机挂载的文件资源的情况NFS资源的情况</td>
</tr>
</tbody></table>
<p>​    </p>
<h1 id="自动挂载"><a href="#自动挂载" class="headerlink" title="自动挂载"></a>自动挂载</h1><p>​    与mount命令不同，autofs服务程序是一种Linux系统守护进程，当检测到用户试图访问一个尚未挂载的文件系统时，将自动挂载该文件系统。换句话说，我们将挂载信息填入/etc/fstab文件后，系统在每次开机时都自动将其挂载，而autofs服务程序则是在用户需要使用该文件系统时才去动态挂载，从而节约了网络资源和服务器的硬件资源。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">yum -y install nfs-utils</span><br><span class="line">yum -y install autofs</span><br><span class="line">showmount -e 192.168.19.132</span><br><span class="line">mkdir /mynfs</span><br><span class="line"></span><br><span class="line"><span class="comment">#配置文件格式：【挂载目录】 【子配置文件】</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"/mynfs  /etc/nfs.misc"</span> &gt;&gt; /etc/auto.master</span><br><span class="line"></span><br><span class="line"><span class="comment">#子配置文件格式：【挂载目录】 【挂载文件类型及权限】:【设备名称】</span></span><br><span class="line"><span class="comment">#比如：iso  -fstype=iso9660,ro,nosuid,nodev :/dev/cdrom</span></span><br><span class="line"><span class="comment">#权限详情参见挂载时文件权限</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"name1  -fstype=nfs 192.168.19.132:/nfs"</span> &gt;&gt; /etc/nfs.misc</span><br><span class="line">systemctl restart autofs</span><br><span class="line"><span class="built_in">cd</span> /mynfs/name1/</span><br></pre></td></tr></table></figure>



<h1 id="备份百度云"><a href="#备份百度云" class="headerlink" title="备份百度云"></a>备份百度云</h1><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#自动备份百度云文件</span></span><br><span class="line"><span class="comment">#2020/4/16 Python2.7</span></span><br><span class="line"><span class="comment"># </span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------------------------</span></span><br><span class="line"><span class="comment"># 安装依赖 </span></span><br><span class="line"><span class="comment"># pip install requests</span></span><br><span class="line"><span class="comment"># pip install bypy</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># [root@localhost ~]# bypy info</span></span><br><span class="line"><span class="comment"># Please visit:   # 访问下边这个连接，复制授权码</span></span><br><span class="line"><span class="comment"># https://openapi.baidu.com/oauth/2.0/authorize?scope=basic+netdisk&amp;redirect_uri=oob&amp;response_type=code&amp;client_id=q8WE4EpCsau1oS0MplgMKNBn</span></span><br><span class="line"><span class="comment"># And authorize this app</span></span><br><span class="line"><span class="comment"># Paste the Authorization Code here within 10 minutes.</span></span><br><span class="line"><span class="comment"># Press [Enter] when you are done    # 提示在下边粘贴授权码</span></span><br><span class="line"><span class="comment"># a288f3d775fa905a6911692a0808f6a8</span></span><br><span class="line"><span class="comment"># Authorizing, please be patient, it may take upto None seconds...</span></span><br><span class="line"><span class="comment"># Authorizing/refreshing with the OpenShift server ...</span></span><br><span class="line"><span class="comment"># OpenShift server failed, authorizing/refreshing with the Heroku server ...</span></span><br><span class="line"><span class="comment"># Successfully authorized</span></span><br><span class="line"><span class="comment"># Quota: 2.015TB</span></span><br><span class="line"><span class="comment"># Used: 740.493GB</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 由于百度PCS API权限限制，程序只能存取百度云端/apps/bypy目录下面的文件和目录。我们可以通过：</span></span><br><span class="line"><span class="comment"># [root@localhost ~]# bypy list</span></span><br><span class="line"><span class="comment"># /apps/bypy ($t $f $s $m $d):</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 把本地当前目录下的文件同步到百度云盘：</span></span><br><span class="line"><span class="comment"># bypy upload</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 把云盘上的内容同步到本地:</span></span><br><span class="line"><span class="comment"># bypy downdir</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 比较本地当前目录和云盘根目录，看是否一致，来判断是否同步成功：</span></span><br><span class="line"><span class="comment"># bypy compare</span></span><br><span class="line"><span class="comment"># ----------------------------------------------------------------------------------------</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment"># /BaiDuDS 就是我们备份百度云的本地目录</span></span><br><span class="line"><span class="comment"># 创建一个文件，用于存放上一次测量的Baiduyun备份大小。如果这次测量后大小相同，说明没有上传文件，不需要备份</span></span><br><span class="line">touch /tmp/size</span><br><span class="line">size_now=`du -sh /BaiDuDS | awk -F <span class="string">' '</span> <span class="string">'&#123;print $1&#125;'</span>`</span><br><span class="line">size_before=`cat /tmp/size`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">"<span class="variable">$size_now</span>"</span> = <span class="string">"<span class="variable">$size_before</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"File Hasn't Changed"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">	<span class="built_in">echo</span> <span class="string">"File Has Changed , Update /tmp/size.."</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"<span class="variable">$size_now</span>"</span> &gt; /tmp/size</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"BackUp to BaiduDuYun"</span></span><br><span class="line">    <span class="comment"># 同步文件夹到远端</span></span><br><span class="line">    bypy downdir</span><br><span class="line"><span class="keyword">fi</span></span><br></pre></td></tr></table></figure>


            
            <p class="more">
                <a href="../../../../http:/ymlog.cn/2020/01/16/Linux%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/01/16/Linux%E7%BD%91%E7%BB%9C%E5%AD%98%E5%82%A8/" title="Linux网络存储">
                
                    <img class="thumbnail" src="../../../../img/default.png" data-echo="../../../../img/thumbnail/6.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    

    
    <nav class="page-navigator">
        <a class="extend prev" rel="prev" href="../2/">前一页</a><a class="page-number" href="../../">1</a><a class="page-number" href="../2/">2</a><span class="page-number current">3</span>
    </nav>
    


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    
    <section class="widget">
        <h3 class="widget-hd"><strong>文章搜索</strong></h3>
        <div class="search-form">
  <form
    id="searchForm"
    method="GET"
    action="https://www.baidu.com/s"
    ectype="application/x-www-form-urlencoded"
    target="_blank"
    autocomplete="false"
    onsubmit="javascript: return false;">
    <input
      id="searchKeyword"
      type="text"
      class="form-control"
      placeholder="输入关键字搜索"
      autocomplete="false"
    />
    <input id="searchKeywordHidden" type="hidden" name="wd" />
    <input id="searchButton" class="btn" type="submit" value="搜索" />
  </form>
</div>
    </section>
    

    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="../../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="../../../../categories/%E7%BC%96%E7%A8%8B/">编程</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="../../../../categories/%E5%AE%B9%E5%99%A8/">容器</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="../../../../categories/Linux/">Linux</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="../../../../categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="../../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="../../../../categories/%E6%95%85%E9%9A%9C/">故障</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="../../../../categories/%E8%BF%90%E7%BB%B4/">运维</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="../../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键 (6)</a>
  
    <a class="tag-item" href="../../../../tags/%E9%9A%8F%E7%AC%94/" title="随笔">随笔 (1)</a>
  
    <a class="tag-item" href="../../../../tags/%E6%91%98%E5%BD%95/" title="摘录">摘录 (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://github.com/front-end-pigs/blog" target="_blank" title="Github博客">Github博客</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2020
    

    <a href="../../../../index.html">Jelon Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->

<script src="../../../../js/main.js?v=1593076679046.js"></script>

</body>
</html>