<!doctype html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8" >
    <meta http-equiv="X-UA-Compatible" content="IE=11,IE=10,IE=9,IE=8" >
    <meta name="baidu-site-verification" content="dIcXMeY8Ya" />
    
    <title>文章归档: 2020/6 | zen&#39;s blog</title>
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=0" >
    <meta name="keywords" content="zen, 运维, 云计算" >
    <meta name="description" content="杜振铨的博客小岛" >

    
    <link rel="alternative" href="/atom.xml" title="zen&#39;s blog" type="application/atom+xml" >
    
    
    <link rel="shortcut icon" href="../../../favicon.ico" >
    
    
<link rel="stylesheet" href="../../../css/style.css">

    <!--[if lt IE 9]>
    
<script src="../../../js/html5.js"></script>

    <![endif]-->
    
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?d5ebf515ab530cfbdda5f5c85093fb41";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


<meta name="generator" content="Hexo 4.2.0"></head>

<body class="home">
    <!--[if lt IE 9]>
    <div class="browsehappy">
        当前网页 <strong>不支持</strong>
        你正在使用的浏览器. 为了正常的访问, 请 <a href="http://browsehappy.com/" target="_blank" rel="noopener">升级你的浏览器</a>.
    </div>
    <![endif]-->

    <!-- 博客头部 -->
    <header class="header">
    <section class="container header-main">
        <div class="logo">
            <a href="../../../index.html">
                <div class="cover">
                    <span class="name">zen&#39;s blog</span>
                    <span class="description"></span>
                </div>
            </a>
        </div>
        <div class="dropnav icon-paragraph-justify" id="JELON__btnDropNav"></div>
        <ul class="menu hidden" id="JELON__menu">
            
            <li rel="" class="item ">
                <a href="../../../index.html" title="首页" class="icon-home">&nbsp;首页</a>
            </li>
            
            <li rel="" class="item ">
                <a href="../../../lab/" title="这是个BUG" class="icon-lab">&nbsp;这是个BUG</a>
            </li>
            
        </ul>
        <div class="profile clearfix">
            <div class="feeds fl">
                
                
                <p class="links">
                    
                        <a href="https://github.com/archks" target="_blank">Github</a>
                        |
                    
                        <a href="https://pages.coding.me" target="_blank">Hosted by Coding Pages</a>
                        
                    
                </p>
                <p class="sns">
                    
                        <a href="https://www.yuque.com/u174775" class="sinaweibo" target="_blank"><b>■</b> 语雀</a>
                    
                    <a href="javascript: void(0);" class="wechat">
                        <b>■</b>
                        博客
                        <span class="popover">
                            <img src="../../../img/wechat_mp.jpg" width="120" height="120" alt="我的微信订阅号">
                            <i class="arrow"></i>
                        </span>
                    </a>
                </p>
                
            </div>
            <div class="avatar fr">
                <img src="/img/jelon.jpg" alt="avatar" title="Jelon" >
            </div>
        </div>
    </section>
</header>


    <!-- 博客正文 -->
    <div class="container body clearfix">
        <section class="content">
            <div class="content-main widget">
                <!-- 文章归档 -->

    <h3 class="widget-hd">
        <strong>
            
                文章归档
                <!-- 文章归档，可以根据日期分类 -->
            
        </strong>
    </h3>
    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E8%BF%90%E7%BB%B4/">运维</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/18/VsCode%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91/">
    		VsCode远程开发
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-18T02:50:36.000Z">2020-06-18</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>草铺横野六七里，笛弄晚风三四声。<br>归来饱饭黄昏后，不脱蓑衣卧月明。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/18/VsCode%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/18/VsCode%E8%BF%9C%E7%A8%8B%E5%BC%80%E5%8F%91/" title="VsCode远程开发">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/19/NuEK0O.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/19/NuEK0O.png" alt="VsCode远程开发" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
            <a href="javascript: void(0);" class="cat">未分类</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/18/Win%E5%BF%AB%E6%8D%B7%E9%94%AE/">
    		Win快捷键
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-18T00:37:32.000Z">2020-06-18</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>十年生死两茫茫，不思量，自难忘。<br>千里孤坟，无处话凄凉。<br>纵使相逢应不识，尘满面，鬓如霜。<br>夜来幽梦忽还乡，小轩窗，正梳妆。<br>相顾无言，惟有泪千行。<br>料得年年肠断处，明月夜，短松冈。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/18/Win%E5%BF%AB%E6%8D%B7%E9%94%AE/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/18/Win%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="Win快捷键">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/16/NkExXj.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/16/NkExXj.png" alt="Win快捷键" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/%E6%95%85%E9%9A%9C/">故障</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/17/NFS%E6%9C%8D%E5%8A%A1%E6%8C%82%E6%8E%89%E4%B9%8B%E5%90%8E%EF%BC%8Cls%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%8D%A1%E6%AD%BB/">
    		ls根目录卡死
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-17T14:46:04.000Z">2020-06-17</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>无善无恶心之体，有善有恶意之动<br>知善知恶是良知，为善去恶是格物</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/17/NFS%E6%9C%8D%E5%8A%A1%E6%8C%82%E6%8E%89%E4%B9%8B%E5%90%8E%EF%BC%8Cls%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%8D%A1%E6%AD%BB/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/17/NFS%E6%9C%8D%E5%8A%A1%E6%8C%82%E6%8E%89%E4%B9%8B%E5%90%8E%EF%BC%8Cls%E6%A0%B9%E7%9B%AE%E5%BD%95%E5%8D%A1%E6%AD%BB/" title="ls根目录卡死">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/17/NZ3TUK.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/17/NZ3TUK.png" alt="ls根目录卡死" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
            <a href="javascript: void(0);" class="cat">未分类</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/16/Vimium%E5%BF%AB%E6%8D%B7%E9%94%AE/">
    		Vimium快捷键
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-16T10:02:13.000Z">2020-06-16</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>世味年來薄似紗，誰令騎馬客京華。<br>小樓一夜聽春雨，深巷明朝賣杏花。<br>矮紙斜行閒作草，晴窗細乳戲分茶。<br>素衣莫起風塵嘆，猶及清明可到家。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/16/Vimium%E5%BF%AB%E6%8D%B7%E9%94%AE/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/16/Vimium%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="Vimium快捷键">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/16/NkExXj.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/16/NkExXj.png" alt="Vimium快捷键" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
            <a href="javascript: void(0);" class="cat">未分类</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/16/Jetbrains%E5%BF%AB%E6%8D%B7%E9%94%AE/">
    		Jetbrains快捷键
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-16T03:23:57.000Z">2020-06-16</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>高城鼓动兰釭灺。睡也还醒，醉也还醒：忽听孤鸿三两声。<br>人生只似风前絮。欢也零星，悲也零星，都作连江点点萍。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/16/Jetbrains%E5%BF%AB%E6%8D%B7%E9%94%AE/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/16/Jetbrains%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="Jetbrains快捷键">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/16/NkExXj.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/16/NkExXj.png" alt="Jetbrains快捷键" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
            <a href="javascript: void(0);" class="cat">未分类</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/16/Chrome%E5%BF%AB%E6%8D%B7%E9%94%AE/">
    		Chrome快捷键
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-16T03:23:27.000Z">2020-06-16</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>春未老，风细柳斜斜。试上超然台上望，半壕春水一城花。烟雨暗千家。<br>寒食后，酒醒却咨嗟。休对故人思故国，且将新火试新茶。诗酒趁年华。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/16/Chrome%E5%BF%AB%E6%8D%B7%E9%94%AE/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/16/Chrome%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="Chrome快捷键">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/16/NkExXj.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/16/NkExXj.png" alt="Chrome快捷键" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
            <a href="javascript: void(0);" class="cat">未分类</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/16/VsCode%E5%BF%AB%E6%8D%B7%E9%94%AE/">
    		VSCode快捷键
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-16T02:51:59.000Z">2020-06-16</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
    
        <a href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键</a>
    

        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>醉漾轻舟，信bai流引到花深处。<br>尘缘du相误，无计花间住。<br>烟水茫茫，千里斜阳暮。<br>山无数，乱红如雨，不记来时路。</p>
            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/16/VsCode%E5%BF%AB%E6%8D%B7%E9%94%AE/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/16/VsCode%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="VSCode快捷键">
                
                    <!--
                    <img src="../../../https:/s1.ax1x.com/2020/06/16/NkExXj.png" class="thumbnail">
                    -->
                    <img class="thumbnail" src="../../../img/default.png" data-echo="https://s1.ax1x.com/2020/06/16/NkExXj.png" alt="VSCode快捷键" >
                
            </a>
        </div>
    </div>
</article>

    
        <!-- 文章列表 item -->
<article class="post">
    <header>
        <!-- 标签这有且只能显示一个 -->
        
        <a class="cat-link" href="../../../categories/Linux/">Linux</a>
        
        <!-- 文章标题 -->
        
    <h3 class="post-title">
    	<a href="../../../http:/ymlog.cn/2020/06/04/KVM%E5%AE%9E%E4%BE%8B/">
    		KVM实例总结
    	</a>
    </h3>

    </header>
    <p class="post-meta">
        Jelon 发表于
        <time datetime="2020-06-04T09:19:51.000Z">2020-06-04</time>
        &nbsp;&nbsp;
        <span class="post-tags">
            标签：
            
        </span>
    </p>

    <div class="post-content">
        <div class="post-excerpt">
            
                <p>大雨落幽燕，白浪滔天，秦皇岛外打鱼船，一片汪洋都不见。知向谁边？<br>往事越千年，魏武挥鞭，东临碣石有遗篇。萧瑟秋风今又是，换了人间。</p>
<h1 id="大纲"><a href="#大纲" class="headerlink" title="大纲"></a>大纲</h1><p>kvm创建虚拟机的根本在于这样一条命令，<code>virsh define vm-template.xml</code>，这条命令的核心就是创建一个虚拟机，之后或者之前的内容都是围绕着这条命令和这个虚拟机的。</p>
<p>- 更新vm-templatem模板是为了进行子机资源配置</p>
<p>- 在更新模板之前检查时主机是为了防止给子机过量的资源导致母机不稳定</p>
<p>- 桥接网卡是为了让子机连接局域网</p>
<p>所以，virsh define vm-template.xml 其本质是在安全可靠的前提下，将母机的资源通过kvm虚拟化的形式分配给子机。</p>
<p>所以主要考虑方向有两个</p>
<p>1、保障母机和子机的安全可靠，包括系统安全和网络安全</p>
<p>2、进行资源分配，包括网络资源、存储资源、计算资源等</p>
<p>该脚本考虑了母机分配资源不会超过母机承受范围的资源安全，其他系统层面和网络层面的安全问题还需考虑</p>
<h1 id="命令"><a href="#命令" class="headerlink" title="命令"></a>命令</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">- 1、sed   </span><br><span class="line">- 替换注释 sed -i <span class="string">"s/^IPADDR/#&amp;/"</span> file</span><br><span class="line">- 字段追加 sed -i <span class="string">"/DEVICE/a\BRIDGE='br0'"</span> file</span><br><span class="line">- 指定行插入 sed -i <span class="string">"4iContent"</span> file</span><br><span class="line">- 注意<span class="string">""</span> 和<span class="string">''</span>的区别，在使用变量时可以加\转义字符</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 2、cat </span><br><span class="line">- cat &lt;&lt; EOF &gt; file ，这里的变量需要转义字符\,且EOF不能使用双引号<span class="string">"EOF"</span>,否则变量会消失</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 3、expect</span><br><span class="line">- expect执行顺序容易错乱</span><br><span class="line">- expect <span class="string">"~"</span> &#123; send <span class="string">"umount /share \r"</span> &#125; ：常用expect方法</span><br><span class="line">- 如果执行expect需要等待很长时间，可以把timeout设置为-1</span><br><span class="line">- expect脚本执行时，不能使用sh script.sh 这样相当于用shell的解释器执行，可以采用./script <span class="variable">$args</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 4、<span class="keyword">while</span></span><br><span class="line">- <span class="keyword">while</span> <span class="built_in">read</span> a b c d e;<span class="keyword">do</span> ....; <span class="keyword">done</span> &lt; file，用于读取类似格式为 192.168.1.1 255.255.255.0 C 之类的文本，读取之后 a b c d e 均为file中对应的变量</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 5、<span class="built_in">echo</span></span><br><span class="line">- 注意<span class="built_in">echo</span>颜色的使用，红色闪烁和绿色健康：-e <span class="string">"\033[31m\033[01m\033[05m[ err ]\033[0m"</span>  <span class="string">"\033[32m [ OK ] \033[0m"</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">- 6、bc</span><br><span class="line">- shell中浮点数和整数、浮点数和浮点数不能直接比较大小，可以使用bc工具</span><br><span class="line">- <span class="built_in">echo</span> <span class="string">"1.1 &gt; 1"</span> | bc  正确为1 错误为0</span><br></pre></td></tr></table></figure>



<h1 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h1><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">完成过程</span><br><span class="line">   - 1|主机检查-（磁盘、CPU、内存） 写了自动检查&amp;手动检查[0]</span><br><span class="line">   - 2|网卡桥接，创建一个br0作为网桥，连接eth1和kvm虚拟机</span><br><span class="line">   - 3|安装软件，执行tlinux*.run</span><br><span class="line">   - 4|重启母机</span><br><span class="line">   - 5|主机通信[1]</span><br><span class="line">   - 6|创建子机磁盘，包括系统盘、数据盘、共享盘</span><br><span class="line">   - 6|配置模板，包括调整CPU个数、内存大小、vlanid、网卡、uuid、mac地址、子机名称</span><br><span class="line">   - 7|使用6中的模板创建子机[2]</span><br><span class="line">   - 8|登录子机[3]</span><br><span class="line">   - 9|执行脚本，只要expect程序不错，这里基本不会错[4]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[0]</span><br><span class="line">刚开始考虑当母机资源超过一定比例则程序退出，比如磁盘使用超过2/3，后来觉得这样不够灵活，改用百分比，默认50%</span><br><span class="line">在设置百分比的时候有几点小问题</span><br><span class="line">1、浮点数运算保留小数</span><br><span class="line">    使用scale可以准确保留小数，<span class="built_in">echo</span> <span class="string">"scale=2;62/3"</span> | bc 结果 20.66</span><br><span class="line">    使用<span class="built_in">printf</span>可以保留小数位，补零填充  <span class="built_in">printf</span> %.2f 结果20.00</span><br><span class="line">2、浮点数运算不保留小数</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"123.123"</span>|sed <span class="string">"s/\..*//g"</span></span><br><span class="line">    *代表0到多个，所以第一个命令中\.*只能替换掉小数点变成空</span><br><span class="line">    \..*代表了小数点之后的1到多个</span><br><span class="line">3、除法</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"2 / 3"</span> | bc                          这个结果会显示为0</span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"scale=2 ;2 / 3"</span> | bc                 这个结果会显示为.66</span><br><span class="line">   <span class="built_in">printf</span> <span class="string">"%.2f"</span> `<span class="built_in">echo</span> <span class="string">"scale=2;2/3"</span> | bc`    这个结果会显示为0.66</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[1]</span><br><span class="line">刚开始的时候选择将subvm_configuration.sh这个脚本cat进内存，然后用expect登录到子机的时候<span class="built_in">echo</span>到文件，然后执行。后来发现expect输出的时候会把subvm_configuration.sh脚本里的内容先执行一遍，而且还存在其他一些问题，比如说<span class="built_in">echo</span>到文件的时候残缺不全、不换行、文件为空等。</span><br><span class="line">后来采用磁盘共享的方式，在宿主机上创建一块磁盘，然后挂载到/tmp/share/这个目录，再将subvm_configuration.sh脚本和ipinfo配置文件复制到该目录，之后在子机的XML文件中添加一块disk(vdc)，登录进子机后，挂载vdc，此时就可以看到母机上/tmp/share/下的内容了。直接执行脚本即可。</span><br><span class="line">磁盘共享也有一个缺点，就是文件内容不能实时刷新，比如在母机上改了ipinfo，只有子机重启后，子机上的ipinfo才可以刷新，鉴于/tmp/share/这个目录每个子机一生只有一次用到，所以这个问题暂时不需要解决。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[2]</span><br><span class="line">创建子机</span><br><span class="line">1、<span class="keyword">if</span> ( vlanid != 0  &amp;&amp; xenbrx not <span class="keyword">in</span> `brctl show` ) 会报错网卡未找到导致虚拟机启动失败</span><br><span class="line">2、vm-template模板不正确，包括&lt;emulator&gt;/usr/<span class="built_in">local</span>/bin/qemu-system-x86_64&lt;/emulator&gt;路径不正确，会导致虚拟机无法启动</span><br><span class="line">3、disk的slot卡槽相同会导致虚拟机无法启动</span><br><span class="line">4、需要注意的是，virsh define vm-template 这条命令的执行路径是/usr/<span class="built_in">local</span>/etc/libvirt/qemu/vm-template，最后会在/usr/<span class="built_in">local</span>/etc/libvirt/qemu/下生成vm<span class="variable">$ipfmt</span>.xml的配置文件。</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[3]</span><br><span class="line">expect会有很多问题</span><br><span class="line">1、命令不按顺序执行</span><br><span class="line">2、传入的变量为空，且传入的变量下标是从0开始的；shell传入变量下标从1开始，0代表自身文件</span><br><span class="line">3、<span class="built_in">set</span> timeout <span class="variable">$time</span> 设置的时间不一定准确，设置了300秒延时，但未到300s，程序还是退出了，可以考虑直接设置 timeout 为-1</span><br><span class="line">4、expect有多种写法，有expect &lt;&lt; EOF ; expect eof ; 最正常的是上面用的</span><br><span class="line">5、expect文件用的解释器是/usr/bin/expect，这里将login.sh使用cat写在了单独的文件中</span><br><span class="line"></span><br><span class="line">[4]</span><br><span class="line">1、subvm_configuration.sh配置了两张网卡，格式化vdb数据盘，配置ssh</span><br><span class="line">2、eth0为连接外网的网卡，使用tunnel，eth1为内网网卡，使用vlan</span><br><span class="line"></span><br><span class="line">xenbrX为隧道入口，母机收到从xenbr361口收到的报文，就发给另一端隧道，从而实现连接外网</span><br><span class="line">tunnel network ---- host(default router: subhost -&gt; netowrk , throught interface &amp; sh vlan.sh ) ---- subhost</span><br><span class="line"></span><br><span class="line">母机收到vlan的报文，就在指定vlan的广播域内进行路由（不一定是母机进行路由）</span><br><span class="line">vlan network ---- host(broadcast router: subhost ---&gt; broadcast/vlanid throught 802.1Q )  ---- subhost</span><br></pre></td></tr></table></figure>



<h1 id=""><a href="#" class="headerlink" title="[*]"></a>[*]</h1><p>expect合理用法</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">cat  &lt;&lt; EOF &gt;  <span class="variable">$&#123;workdir&#125;</span>/login.sh</span><br><span class="line"><span class="comment">#!/usr/bin/expect</span></span><br><span class="line"><span class="keyword">if</span> &#123; \<span class="variable">$argc</span> &lt; 1&#125; &#123;</span><br><span class="line">puts <span class="string">"Usage:cmd &lt;host&gt;"</span></span><br><span class="line"><span class="built_in">exit</span> 1</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">set</span> timeout -1</span><br><span class="line"><span class="built_in">set</span> host [lindex \<span class="variable">$argv</span> 0]</span><br><span class="line">spawn virsh console \<span class="variable">$host</span></span><br><span class="line">expect <span class="string">"*Escape*"</span> &#123; send <span class="string">"\r"</span> &#125;</span><br><span class="line">expect <span class="string">"*login*"</span> &#123; send <span class="string">"root\r"</span> &#125;</span><br><span class="line">expect <span class="string">"*Password*"</span> &#123; send <span class="string">"xxxx\r"</span> &#125;</span><br><span class="line">interact</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>



<p>高效的while</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> <span class="built_in">read</span> equipmentName ip netmask;</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"=====================<span class="variable">$&#123;equipmentName&#125;</span>=================="</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"inner_ip:<span class="variable">$&#123;ip&#125;</span>"</span></span><br><span class="line">      <span class="built_in">echo</span> <span class="string">"inner_netmask:<span class="variable">$&#123;netmask&#125;</span>"</span></span><br><span class="line"><span class="keyword">done</span> &lt; file</span><br></pre></td></tr></table></figure>


            
            <p class="more">
                <a href="../../../http:/ymlog.cn/2020/06/04/KVM%E5%AE%9E%E4%BE%8B/">阅读剩下更多</a>
            </p>
        </div>
        <div class="post-thumbnail" data-img="">
            <a href="http://ymlog.cn/2020/06/04/KVM%E5%AE%9E%E4%BE%8B/" title="KVM实例总结">
                
                    <img class="thumbnail" src="../../../img/default.png" data-echo="../../../img/thumbnail/4.jpg" alt="默认配图" >
                
            </a>
        </div>
    </div>
</article>

    

    
    <nav class="page-navigator">
        <span class="page-number current">1</span>
    </nav>
    


            </div>

        </section>
        <!-- 侧栏部分 -->
<aside class="sidebar">
    
    <section class="widget">
        <h3 class="widget-hd"><strong>文章搜索</strong></h3>
        <div class="search-form">
  <form
    id="searchForm"
    method="GET"
    action="https://www.baidu.com/s"
    ectype="application/x-www-form-urlencoded"
    target="_blank"
    autocomplete="false"
    onsubmit="javascript: return false;">
    <input
      id="searchKeyword"
      type="text"
      class="form-control"
      placeholder="输入关键字搜索"
      autocomplete="false"
    />
    <input id="searchKeywordHidden" type="hidden" name="wd" />
    <input id="searchButton" class="btn" type="submit" value="搜索" />
  </form>
</div>
    </section>
    

    <section class="widget">
        <h3 class="widget-hd"><strong>文章分类</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
    <li>
        <a href="../../../categories/%E4%B8%AD%E9%97%B4%E4%BB%B6/">中间件</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E7%BC%96%E7%A8%8B/">编程</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E5%AE%B9%E5%99%A8/">容器</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="../../../categories/Linux/">Linux</a>
        <span class="badge">(7)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E6%95%B0%E6%8D%AE%E5%BA%93/">数据库</a>
        <span class="badge">(2)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E8%B7%AF%E7%94%B1%E6%8A%80%E6%9C%AF/">路由技术</a>
        <span class="badge">(3)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E6%95%85%E9%9A%9C/">故障</a>
        <span class="badge">(1)</span>
    </li>
    
    <li>
        <a href="../../../categories/%E8%BF%90%E7%BB%B4/">运维</a>
        <span class="badge">(1)</span>
    </li>
    
</ul>
    </section>

    
    <section class="widget">
        <h3 class="widget-hd"><strong>热门标签</strong></h3>
        <!-- 文章标签 -->
<div class="widget-bd tag-wrap">
  
    <a class="tag-item" href="../../../tags/%E5%BF%AB%E6%8D%B7%E9%94%AE/" title="快捷键">快捷键 (6)</a>
  
    <a class="tag-item" href="../../../tags/%E9%9A%8F%E7%AC%94/" title="随笔">随笔 (1)</a>
  
    <a class="tag-item" href="../../../tags/%E6%91%98%E5%BD%95/" title="摘录">摘录 (1)</a>
  
</div>
    </section>
    

    

    
    <!-- 友情链接 -->
    <section class="widget">
        <h3 class="widget-hd"><strong>友情链接</strong></h3>
        <!-- 文章分类 -->
<ul class="widget-bd">
    
        <li>
            <a href="https://www.ujslxw.com/" target="_blank" title="老刘的博客">老刘的博客</a>
        </li>
    
</ul>
    </section>
    
</aside>
<!-- / 侧栏部分 -->
    </div>

    <!-- 博客底部 -->
    <footer class="footer">
    &copy;
    
        2016-2020
    

    <a href="../../../index.html">Jelon Loves You</a>
</footer>
<div class="back-to-top" id="JELON__backToTop" title="返回顶部">返回顶部</div>

    <!--博客js脚本 -->
    <!-- 这里放网站js脚本 -->

<script src="../../../js/main.js?v=1593079902271.js"></script>

</body>
</html>